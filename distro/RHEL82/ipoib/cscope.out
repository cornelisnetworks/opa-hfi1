cscope 15 /local_home/mmarciniszyn/repos/ifs-all/components/Drivers/distro/RHEL82/ipoib               0000203799
	@ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{ 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

845 
uöt
 
ùoib_ac˚l
;

	@ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

359 (*
rx
->
rx_rög
)));

360 i‡(!
rx
->
rx_rög
)

361  -
ENOMEM
;

363 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

364 i‡(!
t
) {

365 
ªt
 = -
ENOMEM
;

366 
îr_‰ì_1
;

369 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

371 
	`•ö_lock_úq
(&
¥iv
->
lock
);

373 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

374 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

375 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

376 
ªt
 = -
EINVAL
;

377 
îr_‰ì
;

379 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

381 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

383 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

384 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

385 
rx
->
rx_rög
[
i
].
m≠pög
,

386 
GFP_KERNEL
)) {

387 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

388 
ªt
 = -
ENOMEM
;

389 
îr_cou¡
;

391 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

392 i‡(
ªt
) {

393 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

394 "Áûed f‹ bu‡%d\n", 
i
);

395 
ªt
 = -
EIO
;

396 
îr_cou¡
;

400 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

402 
	`k‰ì
(
t
);

406 
îr_cou¡
:

407 
	`•ö_lock_úq
(&
¥iv
->
lock
);

408 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

409 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

411 
îr_‰ì
:

412 
	`k‰ì
(
t
);

414 
îr_‰ì_1
:

415 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

417  
ªt
;

418 
	}
}

420 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

421 
ib_qp
 *
qp
,

422 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

443 c⁄° 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 c⁄° 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
,

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

644 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

645 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

984 c⁄° 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1073 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 c⁄° 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1440 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1441 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1443 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1444 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1445 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1446 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1449 
	`dev_k‰ì_skb_™y
(
skb
);

1451 
	`√tif_tx_lock_bh
(
dev
);

1452 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1455 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1456 
	`√tif_tx_u∆ock_bh
(
dev
);

1457 
	}
}

1459 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1460 
mtu
)

1462 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1463 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1465 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1574 (*
¥iv
->
cm
.
§q_rög
)));

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

144 
	}
}

145 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

146 
s£t
)

148 
s£t
) {

149 
ETH_SS_STATS
:

150  
IPOIB_GLOBAL_STATS_LEN
;

154  -
EOPNOTSUPP
;

155 
	}
}

158 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

160 
•ìd
) {

161 
IB_SPEED_SDR
:

162  
SPEED_2500
;

163 
IB_SPEED_DDR
:

164  
SPEED_5000
;

165 
IB_SPEED_QDR
:

166 
IB_SPEED_FDR10
:

167  
SPEED_10000
;

168 
IB_SPEED_FDR
:

169  
SPEED_14000
;

170 
IB_SPEED_EDR
:

171  
SPEED_25000
;

174  
SPEED_UNKNOWN
;

175 
	}
}

177 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

178 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

180 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

181 
ib_p‹t_©å
 
©å
;

182 
ªt
, 
•ìd
, 
width
;

184 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

185 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

186 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

190 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

191 i‡(
ªt
 < 0)

192  -
EINVAL
;

194 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

195 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

197 i‡(
•ìd
 < 0 || 
width
 < 0)

198  -
EINVAL
;

204 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

205 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

207 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

209 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

210 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

213 
	}
}

215 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

216 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

217 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

218 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

219 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

220 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

221 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

222 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

223 .
	ggë_lök
 = 
ëhtoﬁ_›_gë_lök
,

226 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

228 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

229 
	}
}

	@ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

271 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

272 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

273 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

274 
	}
}

276 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

281 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

282 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

283 
	}
}

285 
	$ùoib_ªgi°î_debugfs
()

287 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

288 
	}
}

290 
	$ùoib_uƒegi°î_debugfs
()

292 
	`debugfs_ªmove
(
ùoib_roŸ
);

293 
	}
}

	@ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
Êags
;

674 
	`√tif_tx_lock_bh
(
dev
);

675 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

677 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

678 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

679 
	`li°_dñ
(&
ah
->
li°
);

680 
	`rdma_de°roy_ah
(
ah
->ah, 0);

681 
	`k‰ì
(
ah
);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	`√tif_tx_u∆ock_bh
(
dev
);

686 
	}
}

688 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

690 
ùoib_dev_¥iv
 *
¥iv
 =

691 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

692 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

694 
	`__ùoib_ª≠_ah
(
dev
);

696 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

697 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

698 
	`round_jiffõs_ªœtive
(
HZ
));

699 
	}
}

701 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

705 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

706 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

707 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

708 
	}
}

710 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

712 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

714 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

715 
	`ùoib_Êush_ah
(
dev
);

716 
	}
}

718 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

720 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

721 
≥ndög
 = 0;

722 
i
;

724 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

725 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

726 ++
≥ndög
;

728  
≥ndög
;

729 
	}
}

731 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

732 
ib_qp
 *
qp
,

733 
ib_qp_°©e
 
√w_°©e
)

735 
ib_qp_©å
 
qp_©å
;

736 
ib_qp_öô_©å
 
quîy_öô_©å
;

737 
ªt
;

739 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

740 i‡(
ªt
) {

741 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

745 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

746 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

748 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

749 
√w_°©e
, 
qp_©å
.
qp_°©e
);

750 
	}
}

752 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

754 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

757 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

758 
	}
}

760 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

764 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

765 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

766 
	}
}

768 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
ib_qp_©å
 
qp_©å
;

772 
begö
;

773 
ùoib_tx_buf
 *
tx_ªq
;

774 
i
;

776 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

777 
	`ùoib_«pi_dißbÀ
(
dev
);

779 
	`ùoib_cm_dev_°›
(
dev
);

785 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

786 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

787 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

790 
begö
 = 
jiffõs
;

792 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

793 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

794 
	`ùoib_w¨n
(
¥iv
,

796 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

797 
	`ªcvs_≥ndög
(
dev
));

803 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

804 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

805 (
ùoib_£ndq_size
 - 1)];

806 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

807 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

808 ++
¥iv
->
tx_èû
;

811 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

812 
ùoib_rx_buf
 *
rx_ªq
;

814 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

815 i‡(!
rx_ªq
->
skb
)

817 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

818 
¥iv
->
rx_rög
[
i
].
m≠pög
);

819 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

820 
rx_ªq
->
skb
 = 
NULL
;

823 
timeout
;

826 
	`ùoib_døö_cq
(
dev
);

828 
	`u¶ìp_ønge
(1000, 2000);

831 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

833 
timeout
:

834 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

835 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

836 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

838 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

841 
	}
}

843 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

847 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

849 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

850 
	`ùoib_Êush_ah
(
dev
);

853 
	}
}

855 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

858 
ªt
;

860 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

861 i‡(
ªt
) {

862 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

866 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

867 i‡(
ªt
) {

868 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

869 
out
;

872 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

873 i‡(
ªt
) {

874 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

875 
out
;

878 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

879 
	`ùoib_«pi_íabÀ
(
dev
);

882 
out
:

884 
	}
}

886 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

888 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

890 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

892 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

893 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

894 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

898 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

899 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

900 
	`round_jiffõs_ªœtive
(
HZ
));

902 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

903 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

904 
dev_°›
;

907 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

911 
dev_°›
:

912 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

913 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

914 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

915 
	`ùoib_ib_dev_°›
(
dev
);

917 
	}
}

919 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

921 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

922 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

924 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

925 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

926 &
¥iv
->
pkey_ödex
)) {

927 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

929 i‡(
∫
->
£t_id
)

930 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

931 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

933 
	}
}

935 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

939 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

941 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

942 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

946 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

948 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

949 
	}
}

951 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

953 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

955 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

957 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

958 
	`√tif_ˇºõr_off
(
dev
);

960 
	`ùoib_mˇ°_°›_thªad
(
dev
);

961 
	`ùoib_mˇ°_dev_Êush
(
dev
);

963 
	`ùoib_Êush_∑ths
(
dev
);

964 
	}
}

966 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

968 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

969 
i
, 
n
;

976 
	`loˇl_bh_dißbÀ
();

979 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

980 
i
 = 0; i < 
n
; ++i) {

986 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

987 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

989 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

991 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

993 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

998 } 
n
 =
IPOIB_NUM_WC
);

1000 
	`pﬁl_tx
(
¥iv
))

1003 
	`loˇl_bh_íabÀ
();

1004 
	}
}

1010 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1012 
ªsu…
;

1013 
u16
 
¥ev_pkey
;

1015 
¥ev_pkey
 = 
¥iv
->
pkey
;

1016 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1017 i‡(
ªsu…
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1019 
¥iv
->
p‹t
, 
ªsu…
);

1020  
ªsu…
;

1023 
¥iv
->
pkey
 |= 0x8000;

1025 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1026 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1027 
¥ev_pkey
, 
¥iv
->
pkey
);

1032 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1033 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1038 
	}
}

1042 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1044 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1046 
¥iv
->
pkey_ödex
 = 0;

1047 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1049 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1050 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1053 
	}
}

1059 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1061 
ib_gid
 
£¨ch_gid
;

1062 
ib_gid
 
gid0
;

1063 
ib_gid
 *
√tdev_gid
;

1064 
îr
;

1065 
u16
 
ödex
;

1066 
u8
 
p‹t
;

1067 
boﬁ
 
ªt
 = 
Ál£
;

1069 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1070 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1071  
Ál£
;

1073 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1078 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1079 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1084 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1086 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1088 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1090 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1091 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1095 
out
;

1122 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1123 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1124 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1125 i‡(
ödex
 == 0)

1126 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1127 &
¥iv
->
Êags
);

1129 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1130 
ªt
 = 
åue
;

1132 
ªt
 = 
Ál£
;

1135 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1136 
ªt
 = 
åue
;

1138 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1139 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1140 (
¥iv
->
loˇl_gid
));

1141 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1142 (
¥iv
->
loˇl_gid
));

1143 
ªt
 = 
åue
;

1148 
out
:

1149 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1151  
ªt
;

1152 
	}
}

1154 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1155 
ùoib_Êush_Àvñ
 
Àvñ
,

1156 
√°ög
)

1158 
ùoib_dev_¥iv
 *
˝riv
;

1159 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1160 
ªsu…
;

1162 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1168 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1169 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1171 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1173 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1174 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1176 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1177 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1178 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1182 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1184 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1185 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1186 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1188 
	`upd©e_chûd_pkey
(
¥iv
);

1189 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1190 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1191 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1195 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1199 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1200 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1201 i‡(
ªsu…
) {

1203 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1208 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1210 i‡(
ªsu…
) {

1211 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1217 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1218 
›î_up
;

1219 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1225 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1226 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1227 i‡(
›î_up
)

1228 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1229 
	`ùoib_Êush_ah
(
dev
);

1232 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1233 
	`ùoib_ib_dev_down
(
dev
);

1235 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1236 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1237 
	`ùoib_ib_dev_°›
(
dev
);

1239 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1242 i‡(
	`√tif_queue_°›≥d
(
dev
))

1243 
	`√tif_°¨t_queue
(
dev
);

1250 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1251 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1252 
	`ùoib_ib_dev_up
(
dev
);

1253 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1254 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1256 
	}
}

1258 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1260 
ùoib_dev_¥iv
 *
¥iv
 =

1261 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1263 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1264 
	}
}

1266 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1268 
ùoib_dev_¥iv
 *
¥iv
 =

1269 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1271 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1272 
	}
}

1274 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1276 
ùoib_dev_¥iv
 *
¥iv
 =

1277 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1279 
	`π∆_lock
();

1280 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1281 
	`π∆_u∆ock
();

1282 
	}
}

1284 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1286 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1288 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1293 
	`ùoib_Êush_∑ths
(
dev
);

1295 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1296 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1304 
	`ùoib_°›_ah
(
dev
);

1306 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1308 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1310 i‡(
¥iv
->
pd
) {

1311 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1312 
¥iv
->
pd
 = 
NULL
;

1314 
	}
}

	@ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
, 
NULL
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
, 
NULL
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

247 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

248  -
EINVAL
;

250 
¥iv
->
admö_mtu
 = 
√w_mtu
;

252 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

253 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

254 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

256 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

258 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

259 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

261 
	`√tif_ˇºõr_off
(
dev
);

264 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

266 i‡(
ˇºõr_°©us
)

267 
	`√tif_ˇºõr_⁄
(
dev
);

269 
dev
->
mtu
 = 
√w_mtu
;

272  
ªt
;

273 
	}
}

275 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

276 
π∆_lök_°©s64
 *
°©s
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

281 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

283 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

284 
	}
}

287 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

288 
√t_devi˚
 *
dev
)

290 
√t
 *√à
	`dev_√t
(
dev
);

291 
ö_devi˚
 *
ö_dev
;

292 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

293 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

294 
__be32
 
ªt_addr
;

296 
addr
->
ß_Ámûy
) {

297 
AF_INET
:

298 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

299 i‡(!
ö_dev
)

300  
Ál£
;

302 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

303 
addr_ö
->
sö_addr
.
s_addr
,

304 
RT_SCOPE_HOST
);

305 
	`ö_dev_put
(
ö_dev
);

306 i‡(
ªt_addr
)

307  
åue
;

310 
AF_INET6
:

311 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

312 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

313  
åue
;

317  
Ál£
;

318 
	}
}

327 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

329 
√t_devi˚
 *
ma°î
;

331 
	`rcu_ªad_lock
();

332 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

333 i‡(
ma°î
)

334 
	`dev_hﬁd
(
ma°î
);

335 
	`rcu_ªad_u∆ock
();

337 i‡(
ma°î
)

338  
ma°î
;

340 
	`dev_hﬁd
(
dev
);

341  
dev
;

342 
	}
}

344 
	sùoib_wÆk_d©a
 {

345 c⁄° 
sockaddr
 *
	maddr
;

346 
√t_devi˚
 *
	mªsu…
;

349 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

351 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

352 
ªt
 = 0;

354 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

355 
	`dev_hﬁd
(
uµî
);

356 
d©a
->
ªsu…
 = 
uµî
;

357 
ªt
 = 1;

360  
ªt
;

361 
	}
}

372 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

373 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

375 
ùoib_wÆk_d©a
 
d©a
 = {

376 .
addr
 =áddr,

379 
	`rcu_ªad_lock
();

380 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

381 
	`dev_hﬁd
(
dev
);

382 
d©a
.
ªsu…
 = 
dev
;

383 
out
;

386 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

387 
out
:

388 
	`rcu_ªad_u∆ock
();

389  
d©a
.
ªsu…
;

390 
	}
}

397 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

398 c⁄° 
ib_gid
 *
gid
,

399 
u16
 
pkey_ödex
,

400 c⁄° 
sockaddr
 *
addr
,

401 
√°ög
,

402 
√t_devi˚
 **
found_√t_dev
)

404 
ùoib_dev_¥iv
 *
chûd_¥iv
;

405 
√t_devi˚
 *
√t_dev
 = 
NULL
;

406 
m©ches
 = 0;

408 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

409 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

410 i‡(!
addr
) {

411 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

415 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

417 i‡(
√t_dev
) {

418 i‡(!*
found_√t_dev
)

419 *
found_√t_dev
 = 
√t_dev
;

421 
	`dev_put
(
√t_dev
);

422 ++
m©ches
;

427 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

428 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

429 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

430 
pkey_ödex
, 
addr
,

431 
√°ög
 + 1,

432 
found_√t_dev
);

433 i‡(
m©ches
 > 1)

436 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

438  
m©ches
;

439 
	}
}

444 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

445 
u16
 
pkey_ödex
,

446 c⁄° 
ib_gid
 *
gid
,

447 c⁄° 
sockaddr
 *
addr
,

448 
√t_devi˚
 **
√t_dev
)

450 
ùoib_dev_¥iv
 *
¥iv
;

451 
m©ches
 = 0;

453 *
√t_dev
 = 
NULL
;

455 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

456 i‡(
¥iv
->
p‹t
 !=Öort)

459 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

460 
addr
, 0, 
√t_dev
);

461 i‡(
m©ches
 > 1)

465  
m©ches
;

466 
	}
}

468 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

469 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

470 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

471 *
˛õ¡_d©a
)

473 
√t_devi˚
 *
√t_dev
;

474 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

475 
u16
 
pkey_ödex
;

476 
m©ches
;

477 
ªt
;

479 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

480  
NULL
;

482 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

483 i‡(
ªt
)

484  
NULL
;

486 i‡(!
dev_li°
)

487  
NULL
;

490 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

491 
gid
, 
NULL
, &
√t_dev
);

493 
m©ches
) {

495  
NULL
;

497  
√t_dev
;

500 
	`dev_put
(
√t_dev
);

504 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

505 
gid
, 
addr
, &
√t_dev
);

506 
m©ches
) {

508  
NULL
;

510 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

514  
√t_dev
;

516 
	}
}

518 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

522 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

523 !
	`°rcmp
(
buf
, "connected\n")) ||

524 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "datagram\n"))) {

530 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

531 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

532 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

534 
	`√tdev_upd©e_„©uªs
(
dev
);

535 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

536 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

537 
	`π∆_u∆ock
();

538 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

540 
	`ùoib_Êush_∑ths
(
dev
);

541  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

544 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

545 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

546 
	`√tdev_upd©e_„©uªs
(
dev
);

547 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

548 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

549 
	`π∆_u∆ock
();

550 
	`ùoib_Êush_∑ths
(
dev
);

551  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

554  -
EINVAL
;

555 
	}
}

557 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

560 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

561 
ùoib_∑th
 *
∑th
;

562 
ªt
;

564 
n
) {

565 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

567 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

568  (
ib_gid
));

570 i‡(
ªt
 < 0)

571 
n
 =Ç->
rb_À·
;

572 i‡(
ªt
 > 0)

573 
n
 =Ç->
rb_right
;

575  
∑th
;

578  
NULL
;

579 
	}
}

581 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

584 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

585 
rb_node
 *
≤
 = 
NULL
;

586 
ùoib_∑th
 *
ç©h
;

587 
ªt
;

589 *
n
) {

590 
≤
 = *
n
;

591 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

593 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

594  (
ib_gid
));

595 i‡(
ªt
 < 0)

596 
n
 = &
≤
->
rb_À·
;

597 i‡(
ªt
 > 0)

598 
n
 = &
≤
->
rb_right
;

600  -
EEXIST
;

603 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

604 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

606 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

609 
	}
}

611 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

613 
sk_buff
 *
skb
;

615 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

616 
	`dev_k‰ì_skb_úq
(
skb
);

618 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "%s\n", 
__func__
);

621 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

623 i‡(
∑th
->
ah
)

624 
	`ùoib_put_ah
(
∑th
->
ah
);

626 
	`k‰ì
(
∑th
);

627 
	}
}

629 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


631 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

633 
ùoib_∑th_ôî
 *
ôî
;

635 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

636 i‡(!
ôî
)

637  
NULL
;

639 
ôî
->
dev
 = dev;

640 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

642 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

643 
	`k‰ì
(
ôî
);

644  
NULL
;

647  
ôî
;

648 
	}
}

650 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

653 
rb_node
 *
n
;

654 
ùoib_∑th
 *
∑th
;

655 
ªt
 = 1;

657 
	`•ö_lock_úq
(&
¥iv
->
lock
);

659 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

661 
n
) {

662 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

664 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

665  (
ib_gid
)) < 0) {

666 
ôî
->
∑th
 = *path;

667 
ªt
 = 0;

671 
n
 = 
	`rb_√xt
(n);

674 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676  
ªt
;

677 
	}
}

679 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

680 
ùoib_∑th
 *
∑th
)

682 *
∑th
 = 
ôî
->path;

683 
	}
}

687 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

690 
ùoib_∑th
 *
∑th
, *
ç
;

692 
	`•ö_lock_úq
(&
¥iv
->
lock
);

694 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

695 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

696 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

697 
∑th
->
∑thªc
.
dgid
.
øw
);

698 i‡(
∑th
->
ah
)

699 
∑th
->
ah
->
vÆid
 = 0;

702 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

703 
	}
}

705 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

707 
ùoib_p£udo_hódî
 *
phdr
;

709 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

710 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

711 
	}
}

713 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

715 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
ùoib_∑th
 *
∑th
, *
ç
;

717 
	`LIST_HEAD
(
ªmove_li°
);

718 
Êags
;

720 
	`√tif_tx_lock_bh
(
dev
);

721 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

723 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

725 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

726 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

728 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

729 i‡(
∑th
->
quîy
)

730 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

731 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

732 
	`√tif_tx_u∆ock_bh
(
dev
);

733 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

734 
	`∑th_‰ì
(
dev
, 
∑th
);

735 
	`√tif_tx_lock_bh
(
dev
);

736 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	}
}

743 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

744 
ß_∑th_ªc
 *
∑thªc
,

745 *
∑th_±r
)

747 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

748 
√t_devi˚
 *
dev
 = 
∑th
->dev;

749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

750 
ùoib_ah
 *
ah
 = 
NULL
;

751 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

752 
ùoib_√igh
 *
√igh
, *
ä
;

753 
sk_buff_hód
 
skqueue
;

754 
sk_buff
 *
skb
;

755 
Êags
;

757 i‡(!
°©us
)

758 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

759 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

760 
∑thªc
->
dgid
.
øw
);

762 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

763 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

765 
	`skb_queue_hód_öô
(&
skqueue
);

767 i‡(!
°©us
) {

768 
rdma_ah_©å
 
av
;

770 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

771 
∑thªc
, &
av
, 
NULL
)) {

772 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

773 
	`rdma_de°roy_ah_©å
(&
av
);

777 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

779 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

785 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

786 (
ib_gid
))) {

787 
	`ùoib_dbg
(

788 
¥iv
,

790 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

791 
∑th
->
∑thªc
.
dgid
.
øw
);

792 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

793 (
ib_gid
));

796 
∑th
->
∑thªc
 = *pathrec;

798 
ﬁd_ah
 = 
∑th
->
ah
;

799 
∑th
->
ah
 =áh;

801 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

802 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

803 
∑thªc
->
¶
);

805 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

806 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

808 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

809 i‡(
√igh
->
ah
) {

810 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

818 
	`ùoib_put_ah
(
√igh
->
ah
);

820 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

821 
√igh
->
ah
 = 
∑th
->ah;

823 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

824 i‡(!
	`ùoib_cm_gë
(
√igh
))

825 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

826 
∑th
,

827 
√igh
));

828 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

829 
	`ùoib_√igh_‰ì
(
√igh
);

834 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

835 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

837 
∑th
->
ah
->
vÆid
 = 1;

840 
∑th
->
quîy
 = 
NULL
;

841 
	`com∂ëe
(&
∑th
->
d⁄e
);

843 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 i‡(
	`IS_ERR_OR_NULL
(
ah
))

846 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

848 i‡(
ﬁd_ah
)

849 
	`ùoib_put_ah
(
ﬁd_ah
);

851 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

852 
ªt
;

853 
skb
->
dev
 = dev;

854 
ªt
 = 
	`dev_queue_xmô
(
skb
);

855 i‡(
ªt
)

856 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

857 
__func__
, 
ªt
);

859 
	}
}

861 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

862 *
gid
)

864 
∑th
->
dev
 = 
¥iv
->dev;

866 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

867 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

871 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

872 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

873 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

874 
∑th
->
∑thªc
.
numb_∑th
 = 1;

875 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

876 
	}
}

878 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

880 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

881 
ùoib_∑th
 *
∑th
;

883 i‡(!
¥iv
->
brﬂdˇ°
)

884  
NULL
;

886 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

887 i‡(!
∑th
)

888  
NULL
;

890 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

892 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

894 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

896  
∑th
;

897 
	}
}

899 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

900 
ùoib_∑th
 *
∑th
)

902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

905 
∑th
->
∑thªc
.
dgid
.
øw
);

907 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

909 
∑th
->
quîy_id
 =

910 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

911 &
∑th
->
∑thªc
,

912 
IB_SA_PATH_REC_DGID
 |

913 
IB_SA_PATH_REC_SGID
 |

914 
IB_SA_PATH_REC_NUMB_PATH
 |

915 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

916 
IB_SA_PATH_REC_PKEY
,

917 1000, 
GFP_ATOMIC
,

918 
∑th_ªc_com∂ëi⁄
,

919 
∑th
, &∑th->
quîy
);

920 i‡(
∑th
->
quîy_id
 < 0) {

921 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

922 
∑th
->
quîy
 = 
NULL
;

923 
	`com∂ëe
(&
∑th
->
d⁄e
);

924  
∑th
->
quîy_id
;

928 
	}
}

930 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

931 
√t_devi˚
 *
dev
)

933 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

934 
ùoib_∑th
 *
∑th
;

935 
Êags
;

937 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

939 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

940 i‡(!
∑th
)

941 
out
;

942 i‡(!
∑th
->
quîy
)

943 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

944 
out
:

945 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

946 
	}
}

948 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

949 
√t_devi˚
 *
dev
)

951 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

952 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

953 
ùoib_∑th
 *
∑th
;

954 
ùoib_√igh
 *
√igh
;

955 
Êags
;

957 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

958 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

959 i‡(!
√igh
) {

960 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

961 ++
dev
->
°©s
.
tx_dr›≥d
;

962 
	`dev_k‰ì_skb_™y
(
skb
);

963  
NULL
;

969 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

970 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

971  
√igh
;

974 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

975 i‡(!
∑th
) {

976 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
)

978 
îr_∑th
;

980 
	`__∑th_add
(
dev
, 
∑th
);

983 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

985 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

986 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

987 
√igh
->
ah
 = 
∑th
->ah;

989 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

990 i‡(!
	`ùoib_cm_gë
(
√igh
))

991 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

992 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

993 
	`ùoib_√igh_‰ì
(
√igh
);

994 
îr_dr›
;

996 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

997 
IPOIB_MAX_PATH_REC_QUEUE
) {

998 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

999 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1001 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1002 
	`skb_queue_Àn
(&
√igh
->
queue
));

1003 
îr_dr›
;

1006 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1007 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1008 
	`IPOIB_QPN
(
daddr
));

1009 
	`ùoib_√igh_put
(
√igh
);

1010  
NULL
;

1013 
√igh
->
ah
 = 
NULL
;

1015 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1016 
îr_∑th
;

1017 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1018 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1019 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1021 
îr_dr›
;

1025 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1026 
	`ùoib_√igh_put
(
√igh
);

1027  
NULL
;

1029 
îr_∑th
:

1030 
	`ùoib_√igh_‰ì
(
√igh
);

1031 
îr_dr›
:

1032 ++
dev
->
°©s
.
tx_dr›≥d
;

1033 
	`dev_k‰ì_skb_™y
(
skb
);

1035 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1036 
	`ùoib_√igh_put
(
√igh
);

1038  
NULL
;

1039 
	}
}

1041 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1042 
ùoib_p£udo_hódî
 *
phdr
)

1044 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1045 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1046 
ùoib_∑th
 *
∑th
;

1047 
Êags
;

1049 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1052 i‡(!
¥iv
->
brﬂdˇ°
)

1053 
dr›_™d_u∆ock
;

1055 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1056 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1057 i‡(!
∑th
) {

1058 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1059 i‡(!
∑th
)

1060 
dr›_™d_u∆ock
;

1061 
	`__∑th_add
(
dev
, 
∑th
);

1067 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
dr›_™d_u∆ock
;

1073 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1074 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1075 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1076 
u∆ock
;

1078 
dr›_™d_u∆ock
;

1082 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1083 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1084 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1089 
dr›_™d_u∆ock
:

1090 ++
dev
->
°©s
.
tx_dr›≥d
;

1091 
	`dev_k‰ì_skb_™y
(
skb
);

1092 
u∆ock
:

1093 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1094 
	}
}

1096 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1098 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1099 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1100 
ùoib_√igh
 *
√igh
;

1101 
ùoib_p£udo_hódî
 *
phdr
;

1102 
ùoib_hódî
 *
hódî
;

1103 
Êags
;

1105 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1106 
	`skb_puŒ
(
skb
, (*
phdr
));

1107 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1109 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1111 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1117 ++
dev
->
°©s
.
tx_dr›≥d
;

1118 
	`dev_k‰ì_skb_™y
(
skb
);

1119  
NETDEV_TX_OK
;

1122 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1123 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1125 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1126 i‡(
	`likñy
(
√igh
))

1127 
£nd_usög_√igh
;

1128 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1129  
NETDEV_TX_OK
;

1133 
hódî
->
¥Ÿo
) {

1134 
	`ht⁄s
(
ETH_P_IP
):

1135 
	`ht⁄s
(
ETH_P_IPV6
):

1136 
	`ht⁄s
(
ETH_P_TIPC
):

1137 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1138 i‡(
	`u∆ikñy
(!
√igh
)) {

1139 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1140 i‡(
	`likñy
(!
√igh
))

1141  
NETDEV_TX_OK
;

1144 
	`ht⁄s
(
ETH_P_ARP
):

1145 
	`ht⁄s
(
ETH_P_RARP
):

1147 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1148  
NETDEV_TX_OK
;

1151 ++
dev
->
°©s
.
tx_dr›≥d
;

1152 
	`dev_k‰ì_skb_™y
(
skb
);

1153  
NETDEV_TX_OK
;

1156 
£nd_usög_√igh
:

1158 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1159 i‡(
	`ùoib_cm_up
(
√igh
)) {

1160 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1161 
uƒef
;

1163 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1164 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1165 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1166 
uƒef
;

1167 } i‡(
√igh
->
ah
) {

1168 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1171 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1172 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1173 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1174 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1175 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1177 ++
dev
->
°©s
.
tx_dr›≥d
;

1178 
	`dev_k‰ì_skb_™y
(
skb
);

1181 
uƒef
:

1182 
	`ùoib_√igh_put
(
√igh
);

1184  
NETDEV_TX_OK
;

1185 
	}
}

1187 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1191 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1192 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1193 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1194 
	`√tif_queue_°›≥d
(
dev
),

1195 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1197 
	}
}

1199 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1200 
√t_devi˚
 *
dev
,

1201 
ty≥
,

1202 c⁄° *
daddr
,

1203 c⁄° *
ßddr
,

1204 
Àn
)

1206 
ùoib_hódî
 *
hódî
;

1208 
hódî
 = 
	`skb_push
(
skb
, (*header));

1210 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1211 
hódî
->
ª£rved
 = 0;

1218 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1220  
IPOIB_HARD_LEN
;

1221 
	}
}

1223 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1225 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1227 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1228 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1232 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1233 
	}
}

1235 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1240 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1241  
dev
->
ifödex
;

1244  
¥iv
->
∑ª¡
->
ifödex
;

1245 
	}
}

1247 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1256 
u32
 *
d32
 = (u32 *Ë
daddr
;

1257 
u32
 
hv
;

1259 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1260  
hv
 & 
htbl
->
mask
;

1261 
	}
}

1263 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1265 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1266 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1267 
ùoib_√igh_hash
 *
htbl
;

1268 
ùoib_√igh
 *
√igh
 = 
NULL
;

1269 
u32
 
hash_vÆ
;

1271 
	`rcu_ªad_lock_bh
();

1273 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1275 i‡(!
htbl
)

1276 
out_u∆ock
;

1278 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1279 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1280 
√igh
 !
NULL
;

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1282 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1284 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1286 
√igh
 = 
NULL
;

1287 
out_u∆ock
;

1290 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1291 
√igh
->
Æive
 = 
jiffõs
;

1292 
out_u∆ock
;

1296 
out_u∆ock
:

1297 
	`rcu_ªad_u∆ock_bh
();

1298  
√igh
;

1299 
	}
}

1301 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1303 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1304 
ùoib_√igh_hash
 *
htbl
;

1305 
√igh_obsﬁëe
;

1306 
dt
;

1307 
Êags
;

1308 
i
;

1309 
	`LIST_HEAD
(
ªmove_li°
);

1311 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1313 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1314 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1316 i‡(!
htbl
)

1317 
out_u∆ock
;

1320 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1321 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1323 
i
 = 0; i < 
htbl
->
size
; i++) {

1324 
ùoib_√igh
 *
√igh
;

1325 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1327 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1328 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1330 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1332 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1334 
	`rcu_assign_poöãr
(*
≈
,

1335 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1338 
	`li°_dñ_öô
(&
√igh
->
li°
);

1339 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1341 
≈
 = &
√igh
->
h√xt
;

1347 
out_u∆ock
:

1348 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1349 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1350 
	}
}

1352 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1354 
ùoib_dev_¥iv
 *
¥iv
 =

1355 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1357 
	`__ùoib_ª≠_√igh
(
¥iv
);

1359 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1360 
¨p_tbl
.
gc_öãrvÆ
);

1361 
	}
}

1364 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1365 
√t_devi˚
 *
dev
)

1367 
ùoib_√igh
 *
√igh
;

1369 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1370 i‡(!
√igh
)

1371  
NULL
;

1373 
√igh
->
dev
 = dev;

1374 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1375 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1376 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1377 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1379 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1381  
√igh
;

1382 
	}
}

1384 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1385 
√t_devi˚
 *
dev
)

1387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1388 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1389 
ùoib_√igh_hash
 *
htbl
;

1390 
ùoib_√igh
 *
√igh
;

1391 
u32
 
hash_vÆ
;

1393 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1394 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1395 i‡(!
htbl
) {

1396 
√igh
 = 
NULL
;

1397 
out_u∆ock
;

1403 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1406 
√igh
 !
NULL
;

1407 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1408 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1409 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1411 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1413 
√igh
 = 
NULL
;

1416 
√igh
->
Æive
 = 
jiffõs
;

1417 
out_u∆ock
;

1421 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1422 i‡(!
√igh
)

1423 
out_u∆ock
;

1426 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1427 
√igh
->
Æive
 = 
jiffõs
;

1429 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1430 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1431 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1432 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1433 
	`©omic_öc
(&
¡bl
->
íåõs
);

1435 
out_u∆ock
:

1437  
√igh
;

1438 
	}
}

1440 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1443 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1444 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1445 
sk_buff
 *
skb
;

1446 i‡(
√igh
->
ah
)

1447 
	`ùoib_put_ah
(
√igh
->
ah
);

1448 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1449 ++
dev
->
°©s
.
tx_dr›≥d
;

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 i‡(
	`ùoib_cm_gë
(
√igh
))

1453 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1454 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1456 
	`IPOIB_QPN
(
√igh
->
daddr
),

1457 
√igh
->
daddr
 + 4);

1458 
	`k‰ì
(
√igh
);

1459 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1460 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1461 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1463 
	}
}

1465 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1468 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1470 
	`ùoib_√igh_put
(
√igh
);

1471 
	}
}

1473 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1475 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1477 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1478 
ùoib_√igh_hash
 *
htbl
;

1479 
ùoib_√igh
 
__rcu
 **
≈
;

1480 
ùoib_√igh
 *
n
;

1481 
u32
 
hash_vÆ
;

1483 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1484 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1485 i‡(!
htbl
)

1488 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1489 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1492 
n
 !
NULL
;

1493 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1494 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1495 i‡(
n
 =
√igh
) {

1497 
	`rcu_assign_poöãr
(*
≈
,

1498 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1499 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1501 
	`li°_dñ_öô
(&
√igh
->
li°
);

1502 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1505 
≈
 = &
n
->
h√xt
;

1508 
	}
}

1510 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1512 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1513 
ùoib_√igh_hash
 *
htbl
;

1514 
ùoib_√igh
 
__rcu
 **
buckës
;

1515 
u32
 
size
;

1517 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1518 
¡bl
->
htbl
 = 
NULL
;

1519 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1520 i‡(!
htbl
)

1521  -
ENOMEM
;

1522 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1523 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1524 i‡(!
buckës
) {

1525 
	`k‰ì
(
htbl
);

1526  -
ENOMEM
;

1528 
htbl
->
size
 = size;

1529 
htbl
->
mask
 = (
size
 - 1);

1530 
htbl
->
buckës
 = buckets;

1531 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1532 
htbl
->
¡bl
 =Çtbl;

1533 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1536 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1537 
¨p_tbl
.
gc_öãrvÆ
);

1540 
	}
}

1542 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1544 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1545 
ùoib_√igh_hash
,

1546 
rcu
);

1547 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1548 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1550 
	`kv‰ì
(
buckës
);

1551 
	`k‰ì
(
htbl
);

1552 
	`com∂ëe
(&
¡bl
->
dñëed
);

1553 
	}
}

1555 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1557 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1558 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1559 
ùoib_√igh_hash
 *
htbl
;

1560 
Êags
;

1561 
i
;

1564 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1566 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1567 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1569 i‡(!
htbl
)

1570 
out_u∆ock
;

1572 
i
 = 0; i < 
htbl
->
size
; i++) {

1573 
ùoib_√igh
 *
√igh
;

1574 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1576 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1577 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1579 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1580 
	`rcu_assign_poöãr
(*
≈
,

1581 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1582 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1584 
	`li°_dñ_öô
(&
√igh
->
li°
);

1585 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1587 
≈
 = &
√igh
->
h√xt
;

1592 
out_u∆ock
:

1593 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1594 
	}
}

1596 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1598 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1599 
ùoib_√igh_hash
 *
htbl
;

1600 
Êags
;

1601 
i
, 
waô_Êushed
 = 0;

1603 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1604 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1608 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1609 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1610 i‡(!
htbl
)

1611 
out_u∆ock
;

1613 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1614 i‡(!
waô_Êushed
)

1615 
‰ì_htbl
;

1617 
i
 = 0; i < 
htbl
->
size
; i++) {

1618 
ùoib_√igh
 *
√igh
;

1619 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1621 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1623 
	`rcu_assign_poöãr
(*
≈
,

1624 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1625 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1627 
	`li°_dñ_öô
(&
√igh
->
li°
);

1628 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1632 
‰ì_htbl
:

1633 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1634 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1636 
out_u∆ock
:

1637 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1638 i‡(
waô_Êushed
)

1639 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1640 
	}
}

1642 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
	`ùoib_dbg
(
¥iv
, "%s\n", 
__func__
);

1647 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1649 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1651 
	`ùoib_Êush_√ighs
(
¥iv
);

1653 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1654 
	}
}

1656 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1660 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1661 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1662 
	}
}

1664 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1666 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1668 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1669 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1670 
	}
}

1672 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1674 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1676 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1678 
	`ùoib_«pi_dñ
(
dev
);

1680 
	`ùoib_cm_dev_˛ónup
(
dev
);

1682 
	`k‰ì
(
¥iv
->
rx_rög
);

1683 
	`v‰ì
(
¥iv
->
tx_rög
);

1685 
¥iv
->
rx_rög
 = 
NULL
;

1686 
¥iv
->
tx_rög
 = 
NULL
;

1687 
	}
}

1689 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1693 
	`ùoib_«pi_add
(
dev
);

1696 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1697 (*
¥iv
->
rx_rög
),

1698 
GFP_KERNEL
);

1699 i‡(!
¥iv
->
rx_rög
)

1700 
out
;

1702 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1703 (*
¥iv
->
tx_rög
)));

1704 i‡(!
¥iv
->
tx_rög
) {

1705 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1706 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1707 
out_rx_rög_˛ónup
;

1712 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1713 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1714 
¥iv
->
ˇ
->
«me
);

1715 
out_tx_rög_˛ónup
;

1719 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1720 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1721 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1725 
out_tx_rög_˛ónup
:

1726 
	`v‰ì
(
¥iv
->
tx_rög
);

1728 
out_rx_rög_˛ónup
:

1729 
	`k‰ì
(
¥iv
->
rx_rög
);

1731 
out
:

1732 
	`ùoib_«pi_dñ
(
dev
);

1733  -
ENOMEM
;

1734 
	}
}

1736 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1737 
cmd
)

1739 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1741 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1742  -
EOPNOTSUPP
;

1744  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1745 
	}
}

1747 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1750 
ªt
 = -
ENOMEM
;

1752 
¥iv
->
qp
 = 
NULL
;

1758 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1759 i‡(!
¥iv
->
wq
) {

1760 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1761 
out
;

1765 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1766 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1767 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1768 
˛ón_wq
;

1771 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1772 i‡(
ªt
) {

1773 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1774 
out_‰ì_pd
;

1777 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1778 i‡(
ªt
) {

1779 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1780 
out_dev_unöô
;

1783 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1784 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1785 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1786 
ªt
 = -
ENODEV
;

1787 
out_hash_unöô
;

1793 
out_hash_unöô
:

1794 
	`ùoib_√igh_hash_unöô
(
dev
);

1796 
out_dev_unöô
:

1797 
	`ùoib_ib_dev_˛ónup
(
dev
);

1799 
out_‰ì_pd
:

1800 i‡(
¥iv
->
pd
) {

1801 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1802 
¥iv
->
pd
 = 
NULL
;

1805 
˛ón_wq
:

1806 i‡(
¥iv
->
wq
) {

1807 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1808 
¥iv
->
wq
 = 
NULL
;

1811 
out
:

1812  
ªt
;

1813 
	}
}

1819 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1821 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1827 
	`π∆_lock
();

1828 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
, 
NULL
);

1829 
	`π∆_u∆ock
();

1832 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1838 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1839 
	}
}

1841 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1843 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1845 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1846 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1848 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1849 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1851 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1853 
	}
}

1855 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1858 
ib_p‹t_©å
 
©å
;

1859 
ªsu…
;

1861 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1862 i‡(
ªsu…
) {

1863 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1864 
¥iv
->
p‹t
);

1865  
ªsu…
;

1867 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1868 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1870 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1872 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1873 i‡(
ªsu…
) {

1874 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1875 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1876  
ªsu…
;

1879 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1880 i‡(
ªsu…
) {

1881 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1882 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1883  
ªsu…
;

1885 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1886 (
ib_gid
));

1888 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1889 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1891 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1894 
	}
}

1896 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1898 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1899 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1901 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1902 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1903 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1904 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1905 
	}
}

1907 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1909 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1910 
rdma_√tdev
 *
∫
;

1911 
rc
;

1913 i‡(
¥iv
->
∑ª¡
) {

1914 
	`ùoib_chûd_öô
(
ndev
);

1916 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1917 i‡(
rc
)

1918  
rc
;

1922 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1923 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1924 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1925 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1926 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1928 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1934 
¥iv
->
pkey
 |= 0x8000;

1936 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1937 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1938 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1940 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1942 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1943 i‡(
rc
) {

1944 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1945 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1946  
rc
;

1949 i‡(
¥iv
->
∑ª¡
) {

1950 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1952 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1954 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1955 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1956 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1960 
	}
}

1962 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1964 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1966 
	`ASSERT_RTNL
();

1972 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1974 i‡(
¥iv
->
∑ª¡
) {

1975 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1977 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1978 
	`li°_dñ
(&
¥iv
->
li°
);

1979 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`ùoib_√igh_hash_unöô
(
dev
);

1984 
	`ùoib_ib_dev_˛ónup
(
dev
);

1987 i‡(
¥iv
->
wq
) {

1988 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1989 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1990 
¥iv
->
wq
 = 
NULL
;

1993 i‡(
¥iv
->
∑ª¡
)

1994 
	`dev_put
(
¥iv
->
∑ª¡
);

1995 
	}
}

1997 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1999 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2001  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2002 
	}
}

2004 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2005 
iÊa_vf_öfo
 *
ivf
)

2007 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2008 
îr
;

2010 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2011 i‡(
îr
)

2012  
îr
;

2014 
ivf
->
vf
 = vf;

2015 
	`mem˝y
(
ivf
->
mac
, 
dev
->
dev_addr
, dev->
addr_Àn
);

2018 
	}
}

2020 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2022 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2024 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2025  -
EINVAL
;

2027  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2028 
	}
}

2030 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2031 
iÊa_vf_°©s
 *
vf_°©s
)

2033 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2035  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2036 
	}
}

2038 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2039 .
¸óã
 = 
ùoib_h¨d_hódî
,

2042 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2043 .
ndo_öô
 = 
ùoib_ndo_öô
,

2044 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2045 .
	gndo_›í
 = 
ùoib_›í
,

2046 .
	gndo_°›
 = 
ùoib_°›
,

2047 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2048 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2049 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2050 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2051 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2052 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2053 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2054 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2055 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2056 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2057 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2058 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2059 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2062 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2063 .
ndo_öô
 = 
ùoib_ndo_öô
,

2064 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2065 .
	gndo_›í
 = 
ùoib_›í
,

2066 .
	gndo_°›
 = 
ùoib_°›
,

2067 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2068 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2069 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2070 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2071 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2072 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2073 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2074 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2077 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2078 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2079 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2080 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2081 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2084 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2086 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2087 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2089 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2091 
dev
->
w©chdog_timeo
 = 
HZ
;

2093 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2095 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2096 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2097 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2098 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2099 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2100 
NETIF_F_HIGHDMA
);

2101 
	`√tif_kìp_d°
(
dev
);

2103 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2110 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2111 
	}
}

2113 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2115 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2117 
¥iv
->
dev
 = dev;

2118 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2119 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2120 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2122 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2123 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2124 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2125 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2127 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2128 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2129 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2130 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2131 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2132 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2133 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2134 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2135 
	}
}

2137 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2138 c⁄° *
«me
)

2140 
√t_devi˚
 *
dev
;

2142 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2143 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2144 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2145  
dev
;

2147 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2148 
ùoib_£tup_comm⁄
);

2149 i‡(!
dev
)

2150  
	`ERR_PTR
(-
ENOMEM
);

2151  
dev
;

2152 
	}
}

2154 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2155 
√t_devi˚
 *
dev
)

2157 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2158 
ùoib_dev_¥iv
 *
¥iv
;

2159 
rc
;

2161 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2162 i‡(!
¥iv
)

2163  -
ENOMEM
;

2165 
¥iv
->
ˇ
 = 
hˇ
;

2166 
¥iv
->
p‹t
 =Öort;

2168 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2169 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2170 i‡(
rc
) {

2171 i‡(
rc
 !-
EOPNOTSUPP
)

2172 
out
;

2174 
∫
->
£nd
 = 
ùoib_£nd
;

2175 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2176 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2177 
∫
->
hˇ
 = hca;

2180 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2182 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2183 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2185 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2187 
∫
->
˛¡_¥iv
 = 
¥iv
;

2193 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2194 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2196 
	`ùoib_buûd_¥iv
(
dev
);

2200 
out
:

2201 
	`k‰ì
(
¥iv
);

2202  
rc
;

2203 
	}
}

2205 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2206 c⁄° *
«me
)

2208 
√t_devi˚
 *
dev
;

2209 
rc
;

2211 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2212 i‡(
	`IS_ERR
(
dev
))

2213  
dev
;

2215 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2216 i‡(
rc
) {

2217 
	`‰ì_√tdev
(
dev
);

2218  
	`ERR_PTR
(
rc
);

2226  
dev
;

2227 
	}
}

2229 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2232 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2234 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2235 i‡(
dev
->
¥iv_de°ru˘‹
)

2236 
dev
->
	`¥iv_de°ru˘‹
(dev);

2242 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2245 
∫
->
˛¡_¥iv
 = 
NULL
;

2247 
	`k‰ì
(
¥iv
);

2248 
	}
}

2250 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2251 
devi˚_©åibuã
 *
©å
, *
buf
)

2253 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2256  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2257 
	}
}

2258 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2260 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2261 
devi˚_©åibuã
 *
©å
, *
buf
)

2263 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2266  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2267 
	}
}

2269 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2271 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2273 i‡(
umˇ°_vÆ
 > 0) {

2274 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2275 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2278 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2279 
	}
}

2281 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2282 
devi˚_©åibuã
 *
©å
,

2283 c⁄° *
buf
, 
size_t
 
cou¡
)

2285 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2287 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2289  
cou¡
;

2290 
	}
}

2291 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2293 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2295  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2296 
	}
}

2298 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2300 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2301 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2303 
	`√tif_addr_lock_bh
(
√tdev
);

2305 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2306 &
gid
->
globÆ
.
öãrÁ˚_id
,

2307 (
gid
->
globÆ
.
öãrÁ˚_id
));

2308 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2309 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2311 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2313 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2314 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2315 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2316 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2317 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2319 
	}
}

2321 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2322 
sockaddr_°‹age
 *
ss
)

2324 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2325 
ªt
 = 0;

2327 
	`√tif_addr_lock_bh
(
dev
);

2332 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2333 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2334 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2335 
ªt
 = -
EINVAL
;

2337 
	`√tif_addr_u∆ock_bh
(
dev
);

2339  
ªt
;

2340 
	}
}

2342 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2344 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2345 
sockaddr_°‹age
 *
ss
 = 
addr
;

2346 
ªt
;

2348 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2349  -
EBUSY
;

2351 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2352 i‡(
ªt
)

2353  
ªt
;

2355 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2357 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2360 
	}
}

2362 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2363 
devi˚_©åibuã
 *
©å
,

2364 c⁄° *
buf
, 
size_t
 
cou¡
)

2366 
pkey
;

2367 
ªt
;

2369 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2370  -
EINVAL
;

2372 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2373  -
EINVAL
;

2375 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2377  
ªt
 ?Ñë : 
cou¡
;

2378 
	}
}

2379 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2381 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2382 
devi˚_©åibuã
 *
©å
,

2383 c⁄° *
buf
, 
size_t
 
cou¡
)

2385 
pkey
;

2386 
ªt
;

2388 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2389  -
EINVAL
;

2391 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2392  -
EINVAL
;

2394 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2396  
ªt
 ?Ñë : 
cou¡
;

2398 
	}
}

2399 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2401 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2403  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2404 
	}
}

2415 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2416 
devi˚_©åibuã
 *
©å
, *
buf
)

2418 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2431 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2432 
	`√tdev_öfo_⁄˚
(
ndev
,

2434 
cuºít
->
comm
);

2436  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2437 
	}
}

2438 
DEVICE_ATTR_RO
(
dev_id
);

2440 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2442 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2443  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2444 
	}
}

2446 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2447 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2449 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2450 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2451 
ùoib_dev_¥iv
 *
¥iv
;

2452 
√t_devi˚
 *
ndev
;

2453 
ªsu…
;

2455 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2456 i‡(
	`IS_ERR
(
ndev
)) {

2457 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2458 
	`PTR_ERR
(
ndev
));

2459  
ndev
;

2461 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2463 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2464 
¥iv
->
ˇ
, 
ùoib_evít
);

2465 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2468 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2470 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2471 i‡(
ªsu…
) {

2472 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2473 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2475 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2476 
	`ùoib_ötf_‰ì
(
ndev
);

2477 
	`‰ì_√tdev
(
ndev
);

2479  
	`ERR_PTR
(
ªsu…
);

2482 i‡(
hˇ
->
›s
.
rdma_√tdev_gë_∑øms
) {

2483 
rc
 = 
hˇ
->
›s
.
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2484 
RDMA_NETDEV_IPOIB
,

2485 &
∑øms
);

2487 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2488 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2496 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2498 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2499 
sysfs_Áûed
;

2500 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2501 
sysfs_Áûed
;

2502 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2503 
sysfs_Áûed
;

2504 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2505 
sysfs_Áûed
;

2506 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2507 
sysfs_Áûed
;

2508 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2509 
sysfs_Áûed
;

2511  
ndev
;

2513 
sysfs_Áûed
:

2514 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2515 
	`uƒegi°î_√tdev
(
ndev
);

2516  
	`ERR_PTR
(-
ENOMEM
);

2517 
	}
}

2519 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2521 
li°_hód
 *
dev_li°
;

2522 
√t_devi˚
 *
dev
;

2523 
ùoib_dev_¥iv
 *
¥iv
;

2524 
p
;

2525 
cou¡
 = 0;

2527 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2528 i‡(!
dev_li°
)

2531 
	`INIT_LIST_HEAD
(
dev_li°
);

2533 
	`rdma_f‹_óch_p‹t
 (
devi˚
, 
p
) {

2534 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2536 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2537 i‡(!
	`IS_ERR
(
dev
)) {

2538 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2539 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2540 
cou¡
++;

2544 i‡(!
cou¡
) {

2545 
	`k‰ì
(
dev_li°
);

2549 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2550 
	}
}

2552 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2554 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2555 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2557 i‡(!
dev_li°
)

2560 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2561 
	`LIST_HEAD
(
hód
);

2562 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2564 
	`π∆_lock
();

2566 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2567 
li°
)

2568 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2569 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2570 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2572 
	`π∆_u∆ock
();

2575 
	`k‰ì
(
dev_li°
);

2576 
	}
}

2578 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2579 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2580 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2584 
__öô
 
	$ùoib_öô_moduÀ
()

2586 
ªt
;

2588 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2589 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2590 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2592 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2593 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2594 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2595 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2596 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2597 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2604 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2606 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2608 
	`ùoib_ªgi°î_debugfs
();

2620 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2621 i‡(!
ùoib_w‹kqueue
) {

2622 
ªt
 = -
ENOMEM
;

2623 
îr_fs
;

2626 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2628 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2629 i‡(
ªt
)

2630 
îr_ß
;

2632 
ªt
 = 
	`ùoib_√éök_öô
();

2633 i‡(
ªt
)

2634 
îr_˛õ¡
;

2636 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2637 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2641 
îr_˛õ¡
:

2642 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2644 
îr_ß
:

2645 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2646 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2648 
îr_fs
:

2649 
	`ùoib_uƒegi°î_debugfs
();

2651  
ªt
;

2652 
	}
}

2654 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2656 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2657 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2659 
	`ùoib_√éök_föi
();

2660 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2661 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2662 
	`ùoib_uƒegi°î_debugfs
();

2663 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2664 
	}
}

2666 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2667 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

267 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

268 
	}
}

270 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

271 
ib_evít
 *
ªc‹d
)

273 
ùoib_dev_¥iv
 *
¥iv
 =

274 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

276 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

279 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

280 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

282 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

283 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

284 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

285 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

286 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

287 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

288 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

289 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

290 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

291 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

294 
	}
}

	@ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@
1
.
0
10
131
ipoib.h
ipoib_cm.c
ipoib_ethtool.c
ipoib_fs.c
ipoib_ib.c
ipoib_main.c
ipoib_multicast.c
ipoib_netlink.c
ipoib_verbs.c
ipoib_vlan.c
