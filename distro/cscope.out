cscope 15 /local_home/mmarciniszyn/repos/ifs-all/components/Drivers/distro               0002040445
	@RHEL76/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

56 #unde‡
Æloc_√tdev_mqs


60 
	eùoib_Êush_Àvñ
 {

61 
	mIPOIB_FLUSH_LIGHT
,

62 
	mIPOIB_FLUSH_NORMAL
,

63 
	mIPOIB_FLUSH_HEAVY


67 
	mIPOIB_ENCAP_LEN
 = 4,

68 
	mIPOIB_PSEUDO_LEN
 = 20,

69 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

71 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

72 
	mIPOIB_UD_RX_SG
 = 2,

74 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

75 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

76 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

77 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

78 
	mIPOIB_RX_RING_SIZE
 = 256,

79 
	mIPOIB_TX_RING_SIZE
 = 128,

80 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

81 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

82 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

84 
	mIPOIB_NUM_WC
 = 4,

86 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

87 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

89 
	mIPOIB_FLAG_OPER_UP
 = 0,

90 
	mIPOIB_FLAG_INITIALIZED
 = 1,

91 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

92 
	mIPOIB_PKEY_ASSIGNED
 = 3,

93 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

94 
	mIPOIB_STOP_REAPER
 = 7,

95 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

96 
	mIPOIB_FLAG_UMCAST
 = 10,

97 
	mIPOIB_STOP_NEIGH_GC
 = 11,

98 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

99 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

100 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

101 
	mIPOIB_FLAG_GOING_DOWN
 = 15,

103 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

105 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

106 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

114 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

115 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

117 
	mMAX_SEND_CQE
 = 64,

118 
	mIPOIB_CM_COPYBREAK
 = 256,

120 
	mIPOIB_NON_CHILD
 = 0,

121 
	mIPOIB_LEGACY_CHILD
 = 1,

122 
	mIPOIB_RTNL_CHILD
 = 2,

125 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

126 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


127 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

129 
	#IPOIB_OP_CM
 (0)

	)

132 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

136 
	sùoib_hódî
 {

137 
__be16
 
	m¥Ÿo
;

138 
u16
 
	mª£rved
;

141 
	sùoib_p£udo_hódî
 {

142 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

145 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

147 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

153 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

154 
	`skb_ª£t_mac_hódî
(
skb
);

155 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

156 
	}
}

158 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

160 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

162  
∫
->
˛¡_¥iv
;

163 
	}
}

166 
	sùoib_mˇ°
 {

167 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

168 
ib_ß_mu…iˇ°
 *
	mmc
;

169 
ùoib_ah
 *
	mah
;

171 
rb_node
 
	mrb_node
;

172 
li°_hód
 
	mli°
;

174 
	m¸óãd
;

175 
	mbackoff
;

176 
	mdñay_u¡û
;

178 
	mÊags
;

179 
	mlogcou¡
;

181 
li°_hód
 
	m√igh_li°
;

183 
sk_buff_hód
 
	mpkt_queue
;

185 
√t_devi˚
 *
	mdev
;

186 
com∂ëi⁄
 
	md⁄e
;

189 
	sùoib_rx_buf
 {

190 
sk_buff
 *
	mskb
;

191 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

194 
	sùoib_tx_buf
 {

195 
sk_buff
 *
	mskb
;

196 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

199 
	sùoib_cm_tx_buf
 {

200 
sk_buff
 *
	mskb
;

201 
u64
 
	mm≠pög
;

204 
	gib_cm_id
;

206 
	sùoib_cm_d©a
 {

207 
__be32
 
	mq≤
;

208 
__be32
 
	mmtu
;

238 
	eùoib_cm_°©e
 {

239 
	mIPOIB_CM_RX_LIVE
,

240 
	mIPOIB_CM_RX_ERROR
,

241 
	mIPOIB_CM_RX_FLUSH


244 
	sùoib_cm_rx
 {

245 
ib_cm_id
 *
	mid
;

246 
ib_qp
 *
	mqp
;

247 
ùoib_cm_rx_buf
 *
	mrx_rög
;

248 
li°_hód
 
	mli°
;

249 
√t_devi˚
 *
	mdev
;

250 
	mjiffõs
;

251 
ùoib_cm_°©e
 
	m°©e
;

252 
	mªcv_cou¡
;

255 
	sùoib_cm_tx
 {

256 
ib_cm_id
 *
	mid
;

257 
ib_qp
 *
	mqp
;

258 
li°_hód
 
	mli°
;

259 
√t_devi˚
 *
	mdev
;

260 
ùoib_√igh
 *
	m√igh
;

261 
ùoib_tx_buf
 *
	mtx_rög
;

262 
	mtx_hód
;

263 
	mtx_èû
;

264 
	mÊags
;

265 
u32
 
	mmtu
;

266 
	mmax_£nd_sge
;

269 
	sùoib_cm_rx_buf
 {

270 
sk_buff
 *
	mskb
;

271 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

274 
	sùoib_cm_dev_¥iv
 {

275 
ib_§q
 *
	m§q
;

276 
ùoib_cm_rx_buf
 *
	m§q_rög
;

277 
ib_cm_id
 *
	mid
;

278 
li°_hód
 
	m∑ssive_ids
;

279 
li°_hód
 
	mrx_îr‹_li°
;

280 
li°_hód
 
	mrx_Êush_li°
;

281 
li°_hód
 
	mrx_døö_li°
;

282 
li°_hód
 
	mrx_ª≠_li°
;

283 
w‹k_°ru˘
 
	m°¨t_èsk
;

284 
w‹k_°ru˘
 
	mª≠_èsk
;

285 
w‹k_°ru˘
 
	mskb_èsk
;

286 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

287 
dñayed_w‹k
 
	m°Æe_èsk
;

288 
sk_buff_hód
 
	mskb_queue
;

289 
li°_hód
 
	m°¨t_li°
;

290 
li°_hód
 
	mª≠_li°
;

291 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

292 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

293 
ib_ªcv_wr
 
	mrx_wr
;

294 
	mn⁄§q_c⁄n_qp
;

295 
	mmax_cm_mtu
;

296 
	mnum_‰ags
;

299 
	sùoib_ëhtoﬁ_°
 {

300 
u16
 
	mcﬂÀs˚_u£cs
;

301 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

304 
	gùoib_√igh_èbÀ
;

306 
	sùoib_√igh_hash
 {

307 
ùoib_√igh_èbÀ
 *
	m¡bl
;

308 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

309 
rcu_hód
 
	mrcu
;

310 
u32
 
	mmask
;

311 
u32
 
	msize
;

314 
	sùoib_√igh_èbÀ
 {

315 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

316 
©omic_t
 
	míåõs
;

317 
com∂ëi⁄
 
	mÊushed
;

318 
com∂ëi⁄
 
	mdñëed
;

321 
	sùoib_qp_°©e_vÆid©e
 {

322 
w‹k_°ru˘
 
	mw‹k
;

323 
ùoib_dev_¥iv
 *
	m¥iv
;

331 
	sùoib_dev_¥iv
 {

332 
•ölock_t
 
	mlock
;

334 
√t_devi˚
 *
	mdev
;

336 
«pi_°ru˘
 
	m£nd_«pi
;

337 
«pi_°ru˘
 
	mªcv_«pi
;

339 
	mÊags
;

341 
rw_£m≠h‹e
 
	mvœn_rw£m
;

342 
muãx
 
	mmˇ°_muãx
;

343 
muãx
 
	msysfs_muãx
;

345 
rb_roŸ
 
	m∑th_åì
;

346 
li°_hód
 
	m∑th_li°
;

348 
ùoib_√igh_èbÀ
 
	m¡bl
;

350 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

351 
li°_hód
 
	mmu…iˇ°_li°
;

352 
rb_roŸ
 
	mmu…iˇ°_åì
;

354 
w‹kqueue_°ru˘
 *
	mwq
;

355 
dñayed_w‹k
 
	mmˇ°_èsk
;

356 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

357 
w‹k_°ru˘
 
	mÊush_light
;

358 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

359 
w‹k_°ru˘
 
	mÊush_hóvy
;

360 
w‹k_°ru˘
 
	mª°¨t_èsk
;

361 
dñayed_w‹k
 
	mah_ª≠_èsk
;

362 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

363 
ib_devi˚
 *
	mˇ
;

364 
u8
 
	mp‹t
;

365 
u16
 
	mpkey
;

366 
u16
 
	mpkey_ödex
;

367 
ib_pd
 *
	mpd
;

368 
ib_cq
 *
	mªcv_cq
;

369 
ib_cq
 *
	m£nd_cq
;

370 
ib_qp
 *
	mqp
;

371 
u32
 
	mqkey
;

373 
ib_gid
 
	mloˇl_gid
;

374 
u32
 
	mloˇl_lid
;

376 
	madmö_mtu
;

377 
	mmˇ°_mtu
;

378 
	mmax_ib_mtu
;

380 
ùoib_rx_buf
 *
	mrx_rög
;

382 
ùoib_tx_buf
 *
	mtx_rög
;

383 
	mtx_hód
;

384 
	mtx_èû
;

385 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

386 
ib_ud_wr
 
	mtx_wr
;

387 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

389 
ib_ªcv_wr
 
	mrx_wr
;

390 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

392 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

394 
li°_hód
 
	mdód_ahs
;

396 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

398 
√t_devi˚
 *
	m∑ª¡
;

399 
li°_hód
 
	mchûd_ötfs
;

400 
li°_hód
 
	mli°
;

401 
	mchûd_ty≥
;

403 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


404 
ùoib_cm_dev_¥iv
 
	mcm
;

407 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


408 
li°_hód
 
	mfs_li°
;

409 
díåy
 *
	mmcg_díåy
;

410 
díåy
 *
	m∑th_díåy
;

412 
u64
 
	mhˇ_ˇps
;

413 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

414 
	mmax_£nd_sge
;

415 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

416 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

419 
	sùoib_ah
 {

420 
√t_devi˚
 *
	mdev
;

421 
ib_ah
 *
	mah
;

422 
li°_hód
 
	mli°
;

423 
kªf
 
	mªf
;

424 
	mœ°_£nd
;

427 
	sùoib_∑th
 {

428 
√t_devi˚
 *
	mdev
;

429 
ß_∑th_ªc
 
	m∑thªc
;

430 
ùoib_ah
 *
	mah
;

431 
sk_buff_hód
 
	mqueue
;

433 
li°_hód
 
	m√igh_li°
;

435 
	mquîy_id
;

436 
ib_ß_quîy
 *
	mquîy
;

437 
com∂ëi⁄
 
	md⁄e
;

439 
rb_node
 
	mrb_node
;

440 
li°_hód
 
	mli°
;

441 
	mvÆid
;

444 
	sùoib_√igh
 {

445 
ùoib_ah
 *
	mah
;

446 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


447 
ùoib_cm_tx
 *
	mcm
;

449 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

450 
sk_buff_hód
 
	mqueue
;

452 
√t_devi˚
 *
	mdev
;

454 
li°_hód
 
	mli°
;

455 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

456 
rcu_hód
 
	mrcu
;

457 
©omic_t
 
	mªf˙t
;

458 
	mÆive
;

461 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

462 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

464 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

465 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

467 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

468 
	`ùoib_√igh_dt‹
(
√igh
);

469 
	}
}

470 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

471 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

472 
√t_devi˚
 *
dev
);

473 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

474 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

476 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

480 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

481 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

482 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

485 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

486 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

487 
ùoib_‰ì_ah
(
kªf
 *kref);

488 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

490 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

491 
	}
}

492 
ùoib_›í
(
√t_devi˚
 *
dev
);

493 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

494 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

496 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

497 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

498 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

500 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

501 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

502 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

503 
ùoib_dev_¥iv
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

504 c⁄° *
f‹m©
);

505 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

506 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

507 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

512 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

518 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

520 
ùoib_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
, 
p‹t
);

521 
ùoib_dev_˛ónup
(
√t_devi˚
 *
dev
);

523 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

524 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

525 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

527 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

528 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

531 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

532 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

534 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

535 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

536 
ùoib_tx_buf
 *
tx_ªq
);

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

610 
ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_devi˚
 *
hˇ
);

612 
	#IPOIB_FLAGS_RC
 0x80

	)

613 
	#IPOIB_FLAGS_UC
 0x40

	)

616 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

618 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


620 
ùoib_max_c⁄n_qp
;

622 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

624 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

625  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

626 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

627 
	}
}

629 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

631 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

632  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

633 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

634 
	}
}

636 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

639  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

640 
	}
}

642 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

644  
√igh
->
cm
;

645 
	}
}

647 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

649 
√igh
->
cm
 = 
tx
;

650 
	}
}

652 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

654 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

655  !!
¥iv
->
cm
.
§q
;

656 
	}
}

658 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

660 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

661  
¥iv
->
cm
.
max_cm_mtu
;

662 
	}
}

664 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

665 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

670 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

671 
ùoib_√igh
 *
√igh
);

672 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

673 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

674 
mtu
);

675 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

676 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

679 
	gùoib_cm_tx
;

681 
	#ùoib_max_c⁄n_qp
 0

	)

683 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

686 
	}
}

687 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

691 
	}
}

693 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

697 
	}
}

699 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

701  
NULL
;

702 
	}
}

704 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

706 
	}
}

708 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

711 
	}
}

713 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

716 
	}
}

718 
ölöe


719 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

722 
	}
}

724 
ölöe


725 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

728 
	}
}

730 
ölöe


731 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

734 
	}
}

736 
ölöe


737 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

739  -
ENOSYS
;

740 
	}
}

742 
ölöe


743 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

746 
	}
}

748 
ölöe


749 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

750 
ùoib_√igh
 *
√igh
)

752  
NULL
;

753 
	}
}

755 
ölöe


756 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

759 
	}
}

761 
ölöe


762 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

765 
	}
}

767 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

768 
mtu
)

770 
	`dev_k‰ì_skb_™y
(
skb
);

771 
	}
}

773 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

775 
	}
}

777 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

779 
	}
}

782 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


783 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

785 
ùoib_ªgi°î_debugfs
();

786 
ùoib_uƒegi°î_debugfs
();

788 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

790 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

791 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

794 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

795 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

796 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

798 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

799 10 * 
HZ
 , \

801 i‡(
	`__øãlimô
(&
_rs
)) \

802 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

803 } 0)

	)

805 
ùoib_£ndq_size
;

806 
ùoib_ªcvq_size
;

808 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

810 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


811 
ùoib_debug_Àvñ
;

813 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

815 i‡(
ùoib_debug_Àvñ
 > 0) \

816 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

817 } 0)

	)

818 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

820 i‡(
mˇ°_debug_Àvñ
 > 0) \

821 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

822 } 0)

	)

824 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

825 dÿ{ (Ë(
¥iv
); } 0)

	)

826 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

827 dÿ{ (Ë(
¥iv
); } 0)

	)

830 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


831 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

833 i‡(
d©a_debug_Àvñ
 > 0) \

834 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

835 } 0)

	)

837 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

838 dÿ{ (Ë(
¥iv
); } 0)

	)

841 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

843 c⁄° 
ùoib_drivî_vîsi⁄
[];

845 
hfi1_max_mtu
;

	@RHEL76/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched.h
>

43 
	~"ùoib.h
"

45 
	gùoib_max_c⁄n_qp
 = 128;

47 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

48 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

52 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


53 
	gd©a_debug_Àvñ
;

55 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

56 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

60 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

62 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

63 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

67 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

69 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

70 .
qp_°©e
 = 
IB_QPS_ERR


73 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

75 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

76 .
›code
 = 
IB_WR_SEND
,

79 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

80 
ib_cm_evít
 *
evít
);

82 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

83 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

85 
i
;

87 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

89 
i
 = 0; i < 
‰ags
; ++i)

90 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

91 
	}
}

93 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

95 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

96 
ib_ªcv_wr
 *
bad_wr
;

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, &
bad_wr
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
ib_ªcv_wr
 *
bad_wr
;

123 
i
, 
ªt
;

125 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

127 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

128 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

130 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, &
bad_wr
);

131 i‡(
	`u∆ikñy
(
ªt
)) {

132 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

133 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

134 
rx
->
rx_rög
[
id
].
m≠pög
);

135 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

136 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

139  
ªt
;

140 
	}
}

142 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

143 
ùoib_cm_rx_buf
 *
rx_rög
,

144 
id
, 
‰ags
,

145 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

146 
gÂ_t
 
gÂ
)

148 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

149 
sk_buff
 *
skb
;

150 
i
;

152 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

153 i‡(
	`u∆ikñy
(!
skb
))

154  
NULL
;

160 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

162 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

163 
DMA_FROM_DEVICE
);

164 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

165 
	`dev_k‰ì_skb_™y
(
skb
);

166  
NULL
;

169 
i
 = 0; i < 
‰ags
; i++) {

170 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

172 i‡(!
∑ge
)

173 
∑πül_îr‹
;

174 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

176 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

177 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

178 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

179 
∑πül_îr‹
;

182 
rx_rög
[
id
].
skb
 = skb;

183  
skb
;

185 
∑πül_îr‹
:

187 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

189 ; 
i
 > 0; --i)

190 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

192 
	`dev_k‰ì_skb_™y
(
skb
);

193  
NULL
;

194 
	}
}

196 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

197 
ùoib_cm_rx_buf
 *
rx_rög
)

199 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

200 
i
;

202 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

203 i‡(
rx_rög
[
i
].
skb
) {

204 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

205 
rx_rög
[
i
].
m≠pög
);

206 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

209 
	`v‰ì
(
rx_rög
);

210 
	}
}

212 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

214 
ib_£nd_wr
 *
bad_wr
;

215 
ùoib_cm_rx
 *
p
;

219 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

220 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

227 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

228 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

229 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, &
bad_wr
))

230 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

232 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

233 
	}
}

235 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

237 
ùoib_cm_rx
 *
p
 = 
˘x
;

238 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

239 
Êags
;

241 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

244 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

245 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

246 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

247 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

248 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

249 
	}
}

251 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

252 
ùoib_cm_rx
 *
p
)

254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

255 
ib_qp_öô_©å
 
©å
 = {

256 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

257 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

258 .
ªcv_cq
 = 
¥iv
->recv_cq,

259 .
§q
 = 
¥iv
->
cm
.srq,

260 .
ˇp
.
max_£nd_wr
 = 1,

261 .
ˇp
.
max_£nd_sge
 = 1,

262 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

263 .
qp_ty≥
 = 
IB_QPT_RC
,

264 .
qp_c⁄ãxt
 = 
p
,

267 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

268 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

269 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

272  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

273 
	}
}

275 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

276 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

277 
p¢
)

279 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 
ib_qp_©å
 
qp_©å
;

281 
qp_©å_mask
, 
ªt
;

283 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

284 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

285 i‡(
ªt
) {

286 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

287  
ªt
;

289 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

290 i‡(
ªt
) {

291 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

292  
ªt
;

294 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

295 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

296 i‡(
ªt
) {

297 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

298  
ªt
;

300 
qp_©å
.
rq_p¢
 = 
p¢
;

301 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

302 i‡(
ªt
) {

303 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

304  
ªt
;

315 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

316 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

317 i‡(
ªt
) {

318 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

321 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

322 i‡(
ªt
) {

323 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

328 
	}
}

330 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

331 
ib_ªcv_wr
 *
wr
,

332 
ib_sge
 *
sge
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

335 
i
;

337 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

338 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

340 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

341 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

342 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

344 
wr
->
√xt
 = 
NULL
;

345 
wr
->
sg_li°
 = 
sge
;

346 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

347 
	}
}

349 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

350 
ùoib_cm_rx
 *
rx
)

352 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

354 
ib_ªcv_wr
 
wr
;

355 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

356 } *
t
;

357 
ªt
;

358 
i
;

360 
rx
->
rx_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *rx->rx_ring);

361 i‡(!
rx
->
rx_rög
)

362  -
ENOMEM
;

364 
t
 = 
	`kmÆloc
( *t, 
GFP_KERNEL
);

365 i‡(!
t
) {

366 
ªt
 = -
ENOMEM
;

367 
îr_‰ì_1
;

370 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

372 
	`•ö_lock_úq
(&
¥iv
->
lock
);

374 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

375 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

376 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

377 
ªt
 = -
EINVAL
;

378 
îr_‰ì
;

380 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

382 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

384 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

385 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

386 
rx
->
rx_rög
[
i
].
m≠pög
,

387 
GFP_KERNEL
)) {

388 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

389 
ªt
 = -
ENOMEM
;

390 
îr_cou¡
;

392 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

393 i‡(
ªt
) {

394 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

395 "Áûed f‹ bu‡%d\n", 
i
);

396 
ªt
 = -
EIO
;

397 
îr_cou¡
;

401 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

403 
	`k‰ì
(
t
);

407 
îr_cou¡
:

408 
	`•ö_lock_úq
(&
¥iv
->
lock
);

409 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

410 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

412 
îr_‰ì
:

413 
	`k‰ì
(
t
);

415 
îr_‰ì_1
:

416 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

418  
ªt
;

419 
	}
}

421 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

422 
ib_qp
 *
qp
, 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 =  
d©a
;

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

444 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

445 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

446 
ùoib_cm_rx
 *
p
;

447 
p¢
;

448 
ªt
;

450 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

451 
p
 = 
	`kzÆloc
( *p, 
GFP_KERNEL
);

452 i‡(!
p
)

453  -
ENOMEM
;

454 
p
->
dev
 = dev;

455 
p
->
id
 = 
cm_id
;

456 
cm_id
->
c⁄ãxt
 = 
p
;

457 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

458 
p
->
jiffõs
 = jiffies;

459 
	`INIT_LIST_HEAD
(&
p
->
li°
);

461 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

462 i‡(
	`IS_ERR
(
p
->
qp
)) {

463 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

464 
îr_qp
;

467 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

468 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

469 i‡(
ªt
)

470 
îr_modify
;

472 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

473 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

474 i‡(
ªt
)

475 
îr_modify
;

478 
	`•ö_lock_úq
(&
¥iv
->
lock
);

479 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

480 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

483 
p
->
jiffõs
 = jiffies;

484 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

485 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

486 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

488 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

489 i‡(
ªt
) {

490 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

491 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

492 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

496 
îr_modify
:

497 
	`ib_de°roy_qp
(
p
->
qp
);

498 
îr_qp
:

499 
	`k‰ì
(
p
);

500  
ªt
;

501 
	}
}

503 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

504 
ib_cm_evít
 *
evít
)

506 
ùoib_cm_rx
 *
p
;

507 
ùoib_dev_¥iv
 *
¥iv
;

509 
evít
->event) {

510 
IB_CM_REQ_RECEIVED
:

511  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

512 
IB_CM_DREQ_RECEIVED
:

513 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

515 
IB_CM_REJ_RECEIVED
:

516 
p
 = 
cm_id
->
c⁄ãxt
;

517 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

518 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

519 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

524 
	}
}

526 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

527 
Àngth
, 
sk_buff
 *
toskb
)

529 
i
, 
num_‰ags
;

530 
size
;

533 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

534 
skb
->
èû
 +
size
;

535 
skb
->
Àn
 +
size
;

536 
Àngth
 -
size
;

538 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

539 
i
 = 0; i < 
num_‰ags
; i++) {

540 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

542 i‡(
Àngth
 == 0) {

544 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

545 0, 
PAGE_SIZE
);

546 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

548 
size
 = 
	`mö
(
Àngth
, (Ë
PAGE_SIZE
);

550 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

551 
skb
->
d©a_Àn
 +
size
;

552 
skb
->
åuesize
 +
size
;

553 
skb
->
Àn
 +
size
;

554 
Àngth
 -
size
;

557 
	}
}

559 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

562 
ùoib_cm_rx_buf
 *
rx_rög
;

563 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

564 
sk_buff
 *
skb
, *
√wskb
;

565 
ùoib_cm_rx
 *
p
;

566 
Êags
;

567 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

568 
‰ags
;

569 
has_§q
;

570 
sk_buff
 *
smÆl_skb
;

572 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

573 
wr_id
, 
wc
->
°©us
);

575 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

576 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

577 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

578 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

579 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

580 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

581 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

583 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

584 
wr_id
, 
ùoib_ªcvq_size
);

588 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

590 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

591 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

593 
skb
 = 
rx_rög
[
wr_id
].skb;

595 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

596 
	`ùoib_dbg
(
¥iv
,

598 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

599 ++
dev
->
°©s
.
rx_dr›≥d
;

600 i‡(
has_§q
)

601 
ªpo°
;

603 i‡(!--
p
->
ªcv_cou¡
) {

604 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

605 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

606 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

607 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

613 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

614 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

615 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

616 
p
->
jiffõs
 = jiffies;

619 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

620 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

621 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

625 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

626 
dÀn
 = 
wc
->
byã_Àn
;

628 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

629 i‡(
smÆl_skb
) {

630 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

631 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

632 
dÀn
, 
DMA_FROM_DEVICE
);

633 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

634 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

635 
dÀn
, 
DMA_FROM_DEVICE
);

636 
	`skb_put
(
smÆl_skb
, 
dÀn
);

637 
skb
 = 
smÆl_skb
;

638 
c›õd
;

642 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 - 
	`mö
(wc->byte_len,

643 ()
IPOIB_CM_HEAD_SIZE
)Ë/ 
PAGE_SIZE
;

645 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

646 
m≠pög
, 
GFP_ATOMIC
);

647 i‡(
	`u∆ikñy
(!
√wskb
)) {

652 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

653 ++
dev
->
°©s
.
rx_dr›≥d
;

654 
ªpo°
;

657 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

658 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) *  *mapping);

660 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

661 
wc
->
byã_Àn
, wc->
¶id
);

663 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

665 
c›õd
:

666 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

667 
	`skb_add_p£udo_hdr
(
skb
);

669 ++
dev
->
°©s
.
rx_∑ckës
;

670 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

672 
skb
->
dev
 = dev;

674 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

675 
	`√tif_ª˚ive_skb
(
skb
);

677 
ªpo°
:

678 i‡(
has_§q
) {

679 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

680 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

681 "f‹ bu‡%d\n", 
wr_id
);

683 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

684 &
¥iv
->
cm
.
rx_wr
,

685 
¥iv
->
cm
.
rx_sge
,

686 
wr_id
))) {

687 --
p
->
ªcv_cou¡
;

688 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

689 "f‹ bu‡%d\n", 
wr_id
);

692 
	}
}

694 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

695 
ùoib_cm_tx
 *
tx
,

696 
wr_id
,

697 
ùoib_tx_buf
 *
tx_ªq
)

699 
ib_£nd_wr
 *
bad_wr
;

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, &
bad_wr
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

985 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

986 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

987 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

988 
sk_buff_hód
 
skqueue
;

989 
ib_qp_©å
 
qp_©å
;

990 
qp_©å_mask
, 
ªt
;

991 
sk_buff
 *
skb
;

993 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

995 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

996 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

997 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

998  -
EINVAL
;

1001 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1002 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1003 i‡(
ªt
) {

1004 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1005  
ªt
;

1008 
qp_©å
.
rq_p¢
 = 0 ;

1009 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1010 i‡(
ªt
) {

1011 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1012  
ªt
;

1015 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1016 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1017 i‡(
ªt
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1019  
ªt
;

1021 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1022 i‡(
ªt
) {

1023 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1024  
ªt
;

1027 
	`skb_queue_hód_öô
(&
skqueue
);

1029 
	`√tif_tx_lock_bh
(
p
->
dev
);

1030 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1032 i‡(
p
->
√igh
)

1033 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1034 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1035 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1036 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1038 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1039 
skb
->
dev
 = 
p
->dev;

1040 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1041 i‡(
ªt
)

1042 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1043 
__func__
, 
ªt
);

1046 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1047 i‡(
ªt
) {

1048 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1049  
ªt
;

1052 
	}
}

1054 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1056 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1057 
ib_qp_öô_©å
 
©å
 = {

1058 .
£nd_cq
 = 
¥iv
->send_cq,

1059 .
ªcv_cq
 = 
¥iv
->recv_cq,

1060 .
§q
 = 
¥iv
->
cm
.srq,

1061 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1062 .
ˇp
.
max_£nd_sge
 = 1,

1063 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1064 .
qp_ty≥
 = 
IB_QPT_RC
,

1065 .
qp_c⁄ãxt
 = 
tx
,

1066 .
¸óã_Êags
 = 0

1068 
ib_qp
 *
tx_qp
;

1070 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1071 
©å
.
ˇp
.
max_£nd_sge
 =

1072 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.
max_sge
, 
MAX_SKB_FRAGS
 + 1);

1074 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1075 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1076  
tx_qp
;

1077 
	}
}

1079 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1080 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1081 
u32
 
q≤
,

1082 
ß_∑th_ªc
 *
∑thªc
)

1084 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1085 
ùoib_cm_d©a
 
d©a
 = {};

1086 
ib_cm_ªq_∑øm
 
ªq
 = {};

1088 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1089 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1091 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1092 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1093 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1094 
ªq
.
qp_num
 = 
qp
->qp_num;

1095 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1096 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1097 
ªq
.
¥iv©e_d©a_Àn
 =  
d©a
;

1098 
ªq
.
Êow_c⁄åﬁ
 = 0;

1100 
ªq
.
°¨tög_p¢
 = 0;

1106 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1107 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1108 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
ªåy_cou¡
 = 0;

1110 
ªq
.
∫r_ªåy_cou¡
 = 0;

1111 
ªq
.
max_cm_ªåõs
 = 15;

1112 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1113  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1114 
	}
}

1116 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1117 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1119 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1120 
ib_qp_©å
 
qp_©å
;

1121 
qp_©å_mask
, 
ªt
;

1122 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1123 i‡(
ªt
) {

1124 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1125  
ªt
;

1128 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1129 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1130 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1131 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1133 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1134 i‡(
ªt
) {

1135 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1136  
ªt
;

1139 
	}
}

1141 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1142 
ß_∑th_ªc
 *
∑thªc
)

1144 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1145 
noio_Êag
;

1146 
ªt
;

1148 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1149 
p
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 * (*p->tx_ring));

1150 i‡(!
p
->
tx_rög
) {

1151 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1152 
ªt
 = -
ENOMEM
;

1153 
îr_tx
;

1156 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1157 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1158 i‡(
	`IS_ERR
(
p
->
qp
)) {

1159 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1160 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1161 
îr_qp
;

1164 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1165 i‡(
	`IS_ERR
(
p
->
id
)) {

1166 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1167 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1168 
îr_id
;

1171 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1172 i‡(
ªt
) {

1173 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1174 
îr_modify_£nd
;

1177 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1178 i‡(
ªt
) {

1179 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1180 
îr_modify_£nd
;

1183 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1184 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1188 
îr_modify_£nd
:

1189 
	`ib_de°roy_cm_id
(
p
->
id
);

1190 
îr_id
:

1191 
p
->
id
 = 
NULL
;

1192 
	`ib_de°roy_qp
(
p
->
qp
);

1193 
îr_qp
:

1194 
p
->
qp
 = 
NULL
;

1195 
	`v‰ì
(
p
->
tx_rög
);

1196 
îr_tx
:

1197  
ªt
;

1198 
	}
}

1200 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1202 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1203 
ùoib_tx_buf
 *
tx_ªq
;

1204 
begö
;

1206 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1207 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1209 i‡(
p
->
id
)

1210 
	`ib_de°roy_cm_id
(
p
->
id
);

1212 i‡(
p
->
tx_rög
) {

1214 
begö
 = 
jiffõs
;

1215 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1216 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1217 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1218 
p
->
tx_hód
 -Ö->
tx_èû
);

1219 
timeout
;

1222 
	`u¶ìp_ønge
(1000, 2000);

1226 
timeout
:

1228 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1229 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1230 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1231 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1232 
	`√tif_tx_lock_bh
(
p
->
dev
);

1233 ++
p
->
tx_èû
;

1234 ++
¥iv
->
tx_èû
;

1235 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1236 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1237 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1238 
	`√tif_wake_queue
(
p
->
dev
);

1239 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1242 i‡(
p
->
qp
)

1243 
	`ib_de°roy_qp
(
p
->
qp
);

1245 
	`v‰ì
(
p
->
tx_rög
);

1246 
	`k‰ì
(
p
);

1247 
	}
}

1249 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1250 
ib_cm_evít
 *
evít
)

1252 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1254 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1255 
ùoib_√igh
 *
√igh
;

1256 
Êags
;

1257 
ªt
;

1259 
evít
->event) {

1260 
IB_CM_DREQ_RECEIVED
:

1261 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1262 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1264 
IB_CM_REP_RECEIVED
:

1265 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1266 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1267 i‡(
ªt
)

1268 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1269 
NULL
, 0, NULL, 0);

1271 
IB_CM_REQ_ERROR
:

1272 
IB_CM_REJ_RECEIVED
:

1273 
IB_CM_TIMEWAIT_EXIT
:

1274 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1275 
	`√tif_tx_lock_bh
(
dev
);

1276 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1277 
√igh
 = 
tx
->neigh;

1279 i‡(
√igh
) {

1280 
√igh
->
cm
 = 
NULL
;

1281 
	`ùoib_√igh_‰ì
(
√igh
);

1283 
tx
->
√igh
 = 
NULL
;

1286 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1287 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1288 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1291 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1292 
	`√tif_tx_u∆ock_bh
(
dev
);

1299 
	}
}

1301 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1302 
ùoib_√igh
 *
√igh
)

1304 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1305 
ùoib_cm_tx
 *
tx
;

1307 
tx
 = 
	`kzÆloc
( *tx, 
GFP_ATOMIC
);

1308 i‡(!
tx
)

1309  
NULL
;

1311 
√igh
->
cm
 = 
tx
;

1312 
tx
->
√igh
 =Çeigh;

1313 
tx
->
dev
 = dev;

1314 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1315 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1316 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1317  
tx
;

1318 
	}
}

1320 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1322 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1323 
Êags
;

1324 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1325 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1326 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1327 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1328 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1329 
tx
->
√igh
->
daddr
 + 4);

1330 
tx
->
√igh
 = 
NULL
;

1331 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1333 
	}
}

1335 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1337 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1339 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1340 
cm
.
°¨t_èsk
);

1341 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1342 
ùoib_√igh
 *
√igh
;

1343 
ùoib_cm_tx
 *
p
;

1344 
Êags
;

1345 
ùoib_∑th
 *
∑th
;

1346 
ªt
;

1348 
ß_∑th_ªc
 
∑thªc
;

1349 
u32
 
q≤
;

1351 
	`√tif_tx_lock_bh
(
dev
);

1352 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1354 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1355 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1356 
	`li°_dñ_öô
(&
p
->
li°
);

1357 
√igh
 = 
p
->neigh;

1359 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1364 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1365 i‡(!
∑th
) {

1366 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1367 
__func__
,

1368 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1369 
‰ì_√igh
;

1371 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, Öathrec);

1373 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1374 
	`√tif_tx_u∆ock_bh
(
dev
);

1376 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1378 
	`√tif_tx_lock_bh
(
dev
);

1379 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1381 i‡(
ªt
) {

1382 
‰ì_√igh
:

1383 
√igh
 = 
p
->neigh;

1384 i‡(
√igh
) {

1385 
√igh
->
cm
 = 
NULL
;

1386 
	`ùoib_√igh_‰ì
(
√igh
);

1388 
	`li°_dñ
(&
p
->
li°
);

1389 
	`k‰ì
(
p
);

1393 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1394 
	`√tif_tx_u∆ock_bh
(
dev
);

1395 
	}
}

1397 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1399 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1400 
cm
.
ª≠_èsk
);

1401 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1402 
ùoib_cm_tx
 *
p
;

1403 
Êags
;

1405 
	`√tif_tx_lock_bh
(
dev
);

1406 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1408 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1409 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1410 
	`li°_dñ_öô
(&
p
->
li°
);

1411 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1412 
	`√tif_tx_u∆ock_bh
(
dev
);

1413 
	`ùoib_cm_tx_de°roy
(
p
);

1414 
	`√tif_tx_lock_bh
(
dev
);

1415 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1418 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1419 
	`√tif_tx_u∆ock_bh
(
dev
);

1420 
	}
}

1422 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1425 
cm
.
skb_èsk
);

1426 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1427 
sk_buff
 *
skb
;

1428 
Êags
;

1429 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1431 
	`√tif_tx_lock_bh
(
dev
);

1432 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1434 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1435 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1436 
	`√tif_tx_u∆ock_bh
(
dev
);

1438 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
))

1439 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1440 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1441 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
))

1442 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1444 
	`dev_k‰ì_skb_™y
(
skb
);

1446 
	`√tif_tx_lock_bh
(
dev
);

1447 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1450 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1451 
	`√tif_tx_u∆ock_bh
(
dev
);

1452 
	}
}

1454 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1455 
mtu
)

1457 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1458 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1460 i‡(
	`skb_d°
(
skb
))

1461 
	`skb_d°
(
skb
)->
›s
->
	`upd©e_pmtu
(skb_d°(skb), 
NULL
, skb, 
mtu
);

1463 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1464 i‡(
e
)

1465 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1466 
	}
}

1468 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1470 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1471 
cm
.
rx_ª≠_èsk
)->
dev
);

1472 
	}
}

1474 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1477 
cm
.
°Æe_èsk
.
w‹k
);

1478 
ùoib_cm_rx
 *
p
;

1479 
ªt
;

1481 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1482 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1485 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1486 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1488 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1489 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1490 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1491 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1492 i‡(
ªt
)

1493 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1494 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1497 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1498 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1499 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1500 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1501 
	}
}

1503 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1504 *
buf
)

1506 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1507 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1509 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1510  
	`•rötf
(
buf
, "connected\n");

1512  
	`•rötf
(
buf
, "datagram\n");

1513 
	}
}

1515 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1516 c⁄° *
buf
, 
size_t
 
cou¡
)

1518 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1519 
ªt
;

1520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1522 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
¥iv
->
Êags
))

1523  -
EPERM
;

1525 i‡(!
	`muãx_åylock
(&
¥iv
->
sysfs_muãx
))

1526  
	`ª°¨t_sysˇŒ
();

1528 i‡(!
	`π∆_åylock
()) {

1529 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

1530  
	`ª°¨t_sysˇŒ
();

1533 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1539 i‡(
ªt
 !-
EBUSY
)

1540 
	`π∆_u∆ock
();

1541 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
ENOSYS
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *priv->cm.srq_ring);

1574 i‡(!
¥iv
->
cm
.
§q_rög
) {

1575 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1576 
¥iv
->
cm
.
§q
 = 
NULL
;

1580 
	}
}

1582 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1584 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1585 
max_§q_sge
, 
i
;

1587 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1594 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1598 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1600 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1602 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1604 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1605 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1606 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1607 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1608 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1609 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1610 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1612 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1613 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1616 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1618 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1619 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1620 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1621 
¥iv
->
cm
.
num_‰ags
 - 1,

1622 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1623 
GFP_KERNEL
)) {

1624 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1625 "ª˚ivêbuf„∏%d\n", 
i
);

1626 
	`ùoib_cm_dev_˛ónup
(
dev
);

1627  -
ENOMEM
;

1630 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1631 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1632 "Áûed f‹ bu‡%d\n", 
i
);

1633 
	`ùoib_cm_dev_˛ónup
(
dev
);

1634  -
EIO
;

1639 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1641 
	}
}

1643 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1645 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
ªt
;

1648 i‡(!
¥iv
->
cm
.
§q
)

1651 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1653 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1654 i‡(
ªt
)

1655 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1657 
¥iv
->
cm
.
§q
 = 
NULL
;

1658 i‡(!
¥iv
->
cm
.
§q_rög
)

1661 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1662 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1663 
	}
}

	@RHEL76/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 #ifde‡
IFS_RH75


103 
ªt
 = 
	`ib_modify_cq
(
¥iv
->
ªcv_cq
, 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

106 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

107 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

108 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

110 i‡(
ªt
 &&Ñë !-
ENOSYS
) {

111 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

112  
ªt
;

115 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

116 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

119 
	}
}

120 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

121 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

122 
u64
 *
d©a
)

124 
i
;

125 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

126 
u8
 *
p
 = (u8 *)
√t_°©s
;

128 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

129 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

131 
	}
}

132 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

133 
u32
 
°rög£t
, 
u8
 *
d©a
)

135 
u8
 *
p
 = 
d©a
;

136 
i
;

138 
°rög£t
) {

139 
ETH_SS_STATS
:

140 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

141 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

142 
ETH_GSTRING_LEN
);

143 
p
 +
ETH_GSTRING_LEN
;

146 
ETH_SS_TEST
:

150 
	}
}

151 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

152 
s£t
)

154 
s£t
) {

155 
ETH_SS_STATS
:

156  
IPOIB_GLOBAL_STATS_LEN
;

157 
ETH_SS_TEST
:

161  -
EOPNOTSUPP
;

162 
	}
}

165 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

167 
•ìd
) {

168 
IB_SPEED_SDR
:

169  
SPEED_2500
;

170 
IB_SPEED_DDR
:

171  
SPEED_5000
;

172 
IB_SPEED_QDR
:

173 
IB_SPEED_FDR10
:

174  
SPEED_10000
;

175 
IB_SPEED_FDR
:

176  
SPEED_14000
;

177 
IB_SPEED_EDR
:

178  
SPEED_25000
;

181  
SPEED_UNKNOWN
;

182 
	}
}

184 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

185 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

188 
ib_p‹t_©å
 
©å
;

189 
ªt
, 
•ìd
, 
width
;

191 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

192 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

193 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

197 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

198 i‡(
ªt
 < 0)

199  -
EINVAL
;

201 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

202 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

204 i‡(
•ìd
 < 0 || 
width
 < 0)

205  -
EINVAL
;

211 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

212 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

214 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

216 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

217 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

220 
	}
}

222 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

223 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

224 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

225 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

226 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

227 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

228 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

229 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

232 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

234 
	`SET_ETHTOOL_OPS
(
dev
, &
ùoib_ëhtoﬁ_›s
);

235 
	}
}

	@RHEL76/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 +  "_path"];

267 
	`¢¥ötf
(
«me
, Çame, "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, Çame, "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@RHEL76/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

44 
	~"ùoib.h
"

46 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


47 
	gd©a_debug_Àvñ
;

49 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

50 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

54 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

55 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

57 
ùoib_ah
 *
ah
;

58 
ib_ah
 *
vah
;

60 
ah
 = 
	`kmÆloc
( *ah, 
GFP_KERNEL
);

61 i‡(!
ah
)

62  
	`ERR_PTR
(-
ENOMEM
);

64 
ah
->
dev
 = dev;

65 
ah
->
œ°_£nd
 = 0;

66 
	`kªf_öô
(&
ah
->
ªf
);

68 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

69 i‡(
	`IS_ERR
(
vah
)) {

70 
	`k‰ì
(
ah
);

71 
ah
 = (
ùoib_ah
 *)
vah
;

73 
ah
->ah = 
vah
;

74 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

77  
ah
;

78 
	}
}

80 
	$ùoib_‰ì_ah
(
kªf
 *kref)

82 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

83 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

85 
Êags
;

87 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

88 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

89 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

90 
	}
}

92 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

93 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

95 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

96 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

97 
DMA_FROM_DEVICE
);

98 
	}
}

100 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

103 
ib_ªcv_wr
 *
bad_wr
;

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, &
bad_wr
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 *  *
m≠pög
);

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
ib_£nd_wr
 *
bad_wr
;

545 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

547 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

549 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

550 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

551 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

553 i‡(
hód
) {

554 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

555 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

556 
¥iv
->
tx_wr
.
hÀn
 = hlen;

557 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

559 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

561  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, &
bad_wr
);

562 
	}
}

564 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

565 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

567 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

568 
ùoib_tx_buf
 *
tx_ªq
;

569 
hÀn
, 
rc
;

570 *
phód
;

571 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

573 i‡(
	`skb_is_gso
(
skb
)) {

574 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

575 
phód
 = 
skb
->
d©a
;

576 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

577 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

578 ++
dev
->
°©s
.
tx_dr›≥d
;

579 ++
dev
->
°©s
.
tx_îr‹s
;

580 
	`dev_k‰ì_skb_™y
(
skb
);

584 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

585 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

586 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

587 ++
dev
->
°©s
.
tx_dr›≥d
;

588 ++
dev
->
°©s
.
tx_îr‹s
;

589 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

592 
phód
 = 
NULL
;

593 
hÀn
 = 0;

595 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

596 i‡(
	`skb_löórize
(
skb
) < 0) {

597 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

598 ++
dev
->
°©s
.
tx_dr›≥d
;

599 ++
dev
->
°©s
.
tx_îr‹s
;

600 
	`dev_k‰ì_skb_™y
(
skb
);

604 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

605 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

606 ++
dev
->
°©s
.
tx_dr›≥d
;

607 ++
dev
->
°©s
.
tx_îr‹s
;

608 
	`dev_k‰ì_skb_™y
(
skb
);

613 
	`ùoib_dbg_d©a
(
¥iv
,

615 
skb
->
Àn
, 
addªss
, 
dq≤
);

624 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

625 
tx_ªq
->
skb
 = skb;

626 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

627 ++
dev
->
°©s
.
tx_îr‹s
;

628 
	`dev_k‰ì_skb_™y
(
skb
);

632 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

633 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

635 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

637 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

638 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

639 
	`√tif_°›_queue
(
dev
);

642 
	`skb_‹ph™
(
skb
);

643 
	`skb_d°_dr›
(
skb
);

645 i‡(
	`√tif_queue_°›≥d
(
dev
))

646 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

647 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

648 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

650 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

651 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

652 i‡(
	`u∆ikñy
(
rc
)) {

653 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

654 ++
dev
->
°©s
.
tx_îr‹s
;

655 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

656 
	`dev_k‰ì_skb_™y
(
skb
);

657 i‡(
	`√tif_queue_°›≥d
(
dev
))

658 
	`√tif_wake_queue
(
dev
);

659 
rc
 = 0;

661 
	`√tif_å™s_upd©e
(
dev
);

663 
rc
 = 
¥iv
->
tx_hód
;

664 ++
¥iv
->
tx_hód
;

666  
rc
;

667 
	}
}

669 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

671 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

672 
ùoib_ah
 *
ah
, *
èh
;

673 
	`LIST_HEAD
(
ªmove_li°
);

674 
Êags
;

676 
	`√tif_tx_lock_bh
(
dev
);

677 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

679 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

680 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

681 
	`li°_dñ
(&
ah
->
li°
);

682 
	`rdma_de°roy_ah
(
ah
->ah, 0);

683 
	`k‰ì
(
ah
);

686 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

687 
	`√tif_tx_u∆ock_bh
(
dev
);

688 
	}
}

690 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

692 
ùoib_dev_¥iv
 *
¥iv
 =

693 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

694 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

696 
	`__ùoib_ª≠_ah
(
dev
);

698 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

699 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

700 
	`round_jiffõs_ªœtive
(
HZ
));

701 
	}
}

703 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

705 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

707 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

708 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

709 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

710 
	}
}

712 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

714 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

717 
	`ùoib_Êush_ah
(
dev
);

718 
	}
}

720 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

722 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

723 
≥ndög
 = 0;

724 
i
;

726 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

727 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

728 ++
≥ndög
;

730  
≥ndög
;

731 
	}
}

733 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

734 
ib_qp
 *
qp
,

735 
ib_qp_°©e
 
√w_°©e
)

737 
ib_qp_©å
 
qp_©å
;

738 
ib_qp_öô_©å
 
quîy_öô_©å
;

739 
ªt
;

741 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

742 i‡(
ªt
) {

743 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

747 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

748 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

750 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

751 
√w_°©e
, 
qp_©å
.
qp_°©e
);

752 
	}
}

754 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

756 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

758 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

759 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

760 
	}
}

762 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

764 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

766 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

767 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

768 
	}
}

770 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

772 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

773 
ib_qp_©å
 
qp_©å
;

774 
begö
;

775 
ùoib_tx_buf
 *
tx_ªq
;

776 
i
;

778 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

779 
	`ùoib_«pi_dißbÀ
(
dev
);

781 
	`ùoib_cm_dev_°›
(
dev
);

787 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

788 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

789 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

792 
begö
 = 
jiffõs
;

794 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

795 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

796 
	`ùoib_w¨n
(
¥iv
,

798 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

799 
	`ªcvs_≥ndög
(
dev
));

805 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

806 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

807 (
ùoib_£ndq_size
 - 1)];

808 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

809 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

810 ++
¥iv
->
tx_èû
;

813 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

814 
ùoib_rx_buf
 *
rx_ªq
;

816 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

817 i‡(!
rx_ªq
->
skb
)

819 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

820 
¥iv
->
rx_rög
[
i
].
m≠pög
);

821 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

822 
rx_ªq
->
skb
 = 
NULL
;

825 
timeout
;

828 
	`ùoib_døö_cq
(
dev
);

830 
	`u¶ìp_ønge
(1000, 2000);

833 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

835 
timeout
:

836 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

837 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

838 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

840 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

843 
	}
}

845 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

847 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

849 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

851 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

852 
	`ùoib_Êush_ah
(
dev
);

855 
	}
}

857 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

859 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

860 
ªt
;

862 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

863 i‡(
ªt
) {

864 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

868 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

869 i‡(
ªt
) {

870 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

871 
out
;

874 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

875 i‡(
ªt
) {

876 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

877 
out
;

880 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

881 
	`ùoib_«pi_íabÀ
(
dev
);

884 
out
:

886 
	}
}

888 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

890 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

892 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

894 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

895 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

896 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

900 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

901 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

902 
	`round_jiffõs_ªœtive
(
HZ
));

904 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

905 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

906 
dev_°›
;

909 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

913 
dev_°›
:

914 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

915 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

916 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

917 
	`ùoib_ib_dev_°›
(
dev
);

919 
	}
}

921 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

923 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

924 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

926 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

927 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

928 &
¥iv
->
pkey_ödex
)) {

929 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

931 i‡(
∫
->
£t_id
)

932 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

933 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

935 
	}
}

937 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

939 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

941 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

943 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

944 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

948 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

950 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

951 
	}
}

953 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

955 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

957 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

959 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

960 
	`√tif_ˇºõr_off
(
dev
);

962 
	`ùoib_mˇ°_°›_thªad
(
dev
);

963 
	`ùoib_mˇ°_dev_Êush
(
dev
);

965 
	`ùoib_Êush_∑ths
(
dev
);

966 
	}
}

968 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

970 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

971 
i
, 
n
;

978 
	`loˇl_bh_dißbÀ
();

981 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

982 
i
 = 0; i < 
n
; ++i) {

988 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

989 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

992 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

993 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

997 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

1000 } 
n
 =
IPOIB_NUM_WC
);

1002 
	`pﬁl_tx
(
¥iv
))

1005 
	`loˇl_bh_íabÀ
();

1006 
	}
}

1012 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1014 
ªsu…
;

1015 
u16
 
¥ev_pkey
;

1017 
¥ev_pkey
 = 
¥iv
->
pkey
;

1018 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1019 i‡(
ªsu…
) {

1020 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1021 
¥iv
->
p‹t
, 
ªsu…
);

1022  
ªsu…
;

1025 
¥iv
->
pkey
 |= 0x8000;

1027 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1028 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1029 
¥ev_pkey
, 
¥iv
->
pkey
);

1034 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1035 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1040 
	}
}

1044 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1046 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1048 
¥iv
->
pkey_ödex
 = 0;

1049 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1051 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1052 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1055 
	}
}

1061 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1063 
ib_gid
 
£¨ch_gid
;

1064 
ib_gid
 
gid0
;

1065 
ib_gid
 *
√tdev_gid
;

1066 
îr
;

1067 
u16
 
ödex
;

1068 
u8
 
p‹t
;

1069 
boﬁ
 
ªt
 = 
Ál£
;

1071 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1072 i‡(
	`ib_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
, 
NULL
))

1073  
Ál£
;

1075 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1080 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1084 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1086 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1088 #ifde‡
IFS_RH75


1089 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, 
IB_GID_TYPE_IB
,

1090 
¥iv
->
dev
, &
p‹t
, &
ödex
);

1092 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
,Öriv->
dev
, &
p‹t
, &
ödex
);

1094 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1096 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1097 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1101 
out
;

1128 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1129 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1130 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1131 i‡(
ödex
 == 0)

1132 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1133 &
¥iv
->
Êags
);

1135 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1136 
ªt
 = 
åue
;

1138 
ªt
 = 
Ál£
;

1141 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1142 
ªt
 = 
åue
;

1144 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1145 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1146 (
¥iv
->
loˇl_gid
));

1147 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1148 (
¥iv
->
loˇl_gid
));

1149 
ªt
 = 
åue
;

1154 
out
:

1155 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1157  
ªt
;

1158 
	}
}

1160 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1161 
ùoib_Êush_Àvñ
 
Àvñ
,

1162 
√°ög
)

1164 
ùoib_dev_¥iv
 *
˝riv
;

1165 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1166 
ªsu…
;

1168 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1174 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1175 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1177 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1179 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1180 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1182 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1183 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1184 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1188 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1190 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1191 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1192 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1194 
	`upd©e_chûd_pkey
(
¥iv
);

1195 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1196 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1197 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1201 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1205 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1206 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1207 i‡(
ªsu…
) {

1209 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1214 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1216 i‡(
ªsu…
) {

1217 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1223 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1224 
›î_up
;

1225 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1231 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1232 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1233 i‡(
›î_up
)

1234 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1235 
	`ùoib_Êush_ah
(
dev
);

1238 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1239 
	`ùoib_ib_dev_down
(
dev
);

1241 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1242 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1243 
	`ùoib_ib_dev_°›
(
dev
);

1245 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1248 i‡(
	`√tif_queue_°›≥d
(
dev
))

1249 
	`√tif_°¨t_queue
(
dev
);

1256 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1257 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1258 
	`ùoib_ib_dev_up
(
dev
);

1259 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1260 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1262 
	}
}

1264 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1266 
ùoib_dev_¥iv
 *
¥iv
 =

1267 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1269 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1270 
	}
}

1272 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1274 
ùoib_dev_¥iv
 *
¥iv
 =

1275 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1277 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1278 
	}
}

1280 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1282 
ùoib_dev_¥iv
 *
¥iv
 =

1283 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1285 
	`π∆_lock
();

1286 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1287 
	`π∆_u∆ock
();

1288 
	}
}

1290 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1292 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1294 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1299 
	`ùoib_Êush_∑ths
(
dev
);

1301 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1302 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1310 
	`ùoib_°›_ah
(
dev
);

1312 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1314 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1316 i‡(
¥iv
->
pd
) {

1317 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1318 
¥iv
->
pd
 = 
NULL
;

1320 
	}
}

	@RHEL76/ipoib/ipoib_main.c

34 
	~"ùoib.h
"

36 
	~<löux/moduÀ.h
>

38 
	~<löux/öô.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/kî√l.h
>

41 
	~<löux/vmÆloc.h
>

43 
	~<löux/if_¨p.h
>

45 
	~<löux/ù.h
>

46 
	~<löux/ö.h
>

48 
	~<löux/jhash.h
>

49 
	~<√t/¨p.h
>

50 
	~<√t/addrc⁄f.h
>

51 
	~<löux/öëdevi˚.h
>

52 
	~<rdma/ib_ˇche.h
>

54 
	#DRV_VERSION
 "1.0.0"

	)

56 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

58 
MODULE_AUTHOR
("Roland Dreier");

59 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

60 
MODULE_LICENSE
("Dual BSD/GPL");

62 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

63 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

64 
	gùoib_íh™˚d_íabÀd
 = 1;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

70 
moduÀ_∑øm_«med
(
ùoib_íh™˚d
, 
ùoib_íh™˚d_íabÀd
, , 0444);

71 
MODULE_PARM_DESC
(
ùoib_íh™˚d
, "Enable IPoIBÉnhanced for capable devices (default = 1) (0-1)");

74 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


75 
	gùoib_debug_Àvñ
;

77 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

78 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

81 
uöt
 
ùoib_ac˚l
;

83 
	sùoib_∑th_ôî
 {

84 
√t_devi˚
 *
	mdev
;

85 
ùoib_∑th
 
	m∑th
;

88 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

94 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

96 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

98 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

99 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

100 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

101 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

102 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

103 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

104 *
˛õ¡_d©a
);

105 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

106 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

107 
cmd
);

109 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

110 .
«me
 = "ipoib",

111 .
	gadd
 = 
ùoib_add_⁄e
,

112 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

113 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

116 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


117 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

118 
evít
, *
±r
)

120 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

121 
√t_devi˚
 *
dev
 = 
ni
->dev;

123 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

124  
NOTIFY_DONE
;

126 
evít
) {

127 
NETDEV_REGISTER
:

128 
	`ùoib_¸óã_debug_fûes
(
dev
);

130 
NETDEV_CHANGENAME
:

131 
	`ùoib_dñëe_debug_fûes
(
dev
);

132 
	`ùoib_¸óã_debug_fûes
(
dev
);

134 
NETDEV_UNREGISTER
:

135 
	`ùoib_dñëe_debug_fûes
(
dev
);

139  
NOTIFY_DONE
;

140 
	}
}

143 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

147 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

149 
	`√tif_ˇºõr_off
(
dev
);

151 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

153 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

155 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

156 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

158 
îr_dißbÀ
;

161 
	`ùoib_ib_dev_up
(
dev
);

163 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

164 
ùoib_dev_¥iv
 *
˝riv
;

167 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

168 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

169 
Êags
;

171 
Êags
 = 
˝riv
->
dev
->flags;

172 i‡(
Êags
 & 
IFF_UP
)

175 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

177 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

180 
	`√tif_°¨t_queue
(
dev
);

184 
îr_dißbÀ
:

185 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

187  -
EINVAL
;

188 
	}
}

190 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

192 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

194 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

196 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

198 
	`√tif_°›_queue
(
dev
);

200 
	`ùoib_ib_dev_down
(
dev
);

201 
	`ùoib_ib_dev_°›
(
dev
);

203 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

204 
ùoib_dev_¥iv
 *
˝riv
;

207 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

208 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

209 
Êags
;

211 
Êags
 = 
˝riv
->
dev
->flags;

212 i‡(!(
Êags
 & 
IFF_UP
))

215 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

217 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

221 
	}
}

223 
	$ùoib_unöô
(
√t_devi˚
 *
dev
)

225 
	`ùoib_dev_˛ónup
(
dev
);

226 
	}
}

228 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

233 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

235  
„©uªs
;

236 
	}
}

238 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

240 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

241 
ªt
 = 0;

244 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

245 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

246  -
EINVAL
;

248 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

249 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

250 
¥iv
->
mˇ°_mtu
);

252 
dev
->
mtu
 = 
√w_mtu
;

256 i‡(
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

257  -
EINVAL
;

259 
¥iv
->
admö_mtu
 = 
√w_mtu
;

261 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

262 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

263 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

265 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

267 i‡(
	`gë_ndo_ext
(
¥iv
->
∫_›s
, 
ndo_ch™ge_mtu
)) {

268 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

270 
	`√tif_ˇºõr_off
(
dev
);

273 
ªt
 = 
	`gë_ndo_ext
(
¥iv
->
∫_›s
, 
ndo_ch™ge_mtu
)(
dev
, 
√w_mtu
);

275 i‡(
ˇºõr_°©us
)

276 
	`√tif_ˇºõr_⁄
(
dev
);

278 
dev
->
mtu
 = 
√w_mtu
;

281  
ªt
;

282 
	}
}

284 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

285 
π∆_lök_°©s64
 *
°©s
)

287 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

289 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

290 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

292 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

293 
	}
}

296 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

297 
√t_devi˚
 *
dev
)

299 
√t
 *√à
	`dev_√t
(
dev
);

300 
ö_devi˚
 *
ö_dev
;

301 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

302 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

303 
__be32
 
ªt_addr
;

305 
addr
->
ß_Ámûy
) {

306 
AF_INET
:

307 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

308 i‡(!
ö_dev
)

309  
Ál£
;

311 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
ö_dev
, 0,

312 
addr_ö
->
sö_addr
.
s_addr
,

313 
RT_SCOPE_HOST
);

314 
	`ö_dev_put
(
ö_dev
);

315 i‡(
ªt_addr
)

316  
åue
;

319 
AF_INET6
:

320 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

321 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

322  
åue
;

326  
Ál£
;

327 
	}
}

336 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

338 
√t_devi˚
 *
ma°î
;

340 
	`rcu_ªad_lock
();

341 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

342 i‡(
ma°î
)

343 
	`dev_hﬁd
(
ma°î
);

344 
	`rcu_ªad_u∆ock
();

346 i‡(
ma°î
)

347  
ma°î
;

349 
	`dev_hﬁd
(
dev
);

350  
dev
;

351 
	}
}

353 
	sùoib_wÆk_d©a
 {

354 c⁄° 
sockaddr
 *
	maddr
;

355 
√t_devi˚
 *
	mªsu…
;

358 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

360 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

361 
ªt
 = 0;

363 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

364 
	`dev_hﬁd
(
uµî
);

365 
d©a
->
ªsu…
 = 
uµî
;

366 
ªt
 = 1;

369  
ªt
;

370 
	}
}

381 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

382 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

384 
ùoib_wÆk_d©a
 
d©a
 = {

385 .
addr
 =áddr,

388 
	`rcu_ªad_lock
();

389 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

390 
	`dev_hﬁd
(
dev
);

391 
d©a
.
ªsu…
 = 
dev
;

392 
out
;

395 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

396 
out
:

397 
	`rcu_ªad_u∆ock
();

398  
d©a
.
ªsu…
;

399 
	}
}

406 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

407 c⁄° 
ib_gid
 *
gid
,

408 
u16
 
pkey_ödex
,

409 c⁄° 
sockaddr
 *
addr
,

410 
√°ög
,

411 
√t_devi˚
 **
found_√t_dev
)

413 
ùoib_dev_¥iv
 *
chûd_¥iv
;

414 
√t_devi˚
 *
√t_dev
 = 
NULL
;

415 
m©ches
 = 0;

417 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

418 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

419 i‡(!
addr
) {

420 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

424 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

426 i‡(
√t_dev
) {

427 i‡(!*
found_√t_dev
)

428 *
found_√t_dev
 = 
√t_dev
;

430 
	`dev_put
(
√t_dev
);

431 ++
m©ches
;

436 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

437 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

438 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

439 
pkey_ödex
, 
addr
,

440 
√°ög
 + 1,

441 
found_√t_dev
);

442 i‡(
m©ches
 > 1)

445 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

447  
m©ches
;

448 
	}
}

453 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

454 
u16
 
pkey_ödex
,

455 c⁄° 
ib_gid
 *
gid
,

456 c⁄° 
sockaddr
 *
addr
,

457 
√t_devi˚
 **
√t_dev
)

459 
ùoib_dev_¥iv
 *
¥iv
;

460 
m©ches
 = 0;

462 *
√t_dev
 = 
NULL
;

464 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

465 i‡(
¥iv
->
p‹t
 !=Öort)

468 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

469 
addr
, 0, 
√t_dev
);

470 i‡(
m©ches
 > 1)

474  
m©ches
;

475 
	}
}

477 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

478 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

479 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

480 *
˛õ¡_d©a
)

482 
√t_devi˚
 *
√t_dev
;

483 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

484 
u16
 
pkey_ödex
;

485 
m©ches
;

486 
ªt
;

488 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

489  
NULL
;

491 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

492 i‡(
ªt
)

493  
NULL
;

495 i‡(!
dev_li°
)

496  
NULL
;

499 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

500 
gid
, 
NULL
, &
√t_dev
);

502 
m©ches
) {

504  
NULL
;

506  
√t_dev
;

509 
	`dev_put
(
√t_dev
);

513 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

514 
gid
, 
addr
, &
√t_dev
);

515 
m©ches
) {

517  
NULL
;

519 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

523  
√t_dev
;

525 
	}
}

527 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

529 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

531 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

532 !
	`°rcmp
(
buf
, "connected\n")) ||

533 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

534 !
	`°rcmp
(
buf
, "datagram\n"))) {

539 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

540 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

541 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

543 
	`√tdev_upd©e_„©uªs
(
dev
);

544 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

545 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

546 
	`π∆_u∆ock
();

547 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

549 
	`ùoib_Êush_∑ths
(
dev
);

550  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

553 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

554 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

555 
	`√tdev_upd©e_„©uªs
(
dev
);

556 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

557 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

558 
	`π∆_u∆ock
();

559 
	`ùoib_Êush_∑ths
(
dev
);

560  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

563  -
EINVAL
;

564 
	}
}

566 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

568 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

569 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

570 
ùoib_∑th
 *
∑th
;

571 
ªt
;

573 
n
) {

574 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

576 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

577  (
ib_gid
));

579 i‡(
ªt
 < 0)

580 
n
 =Ç->
rb_À·
;

581 i‡(
ªt
 > 0)

582 
n
 =Ç->
rb_right
;

584  
∑th
;

587  
NULL
;

588 
	}
}

590 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

592 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

593 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

594 
rb_node
 *
≤
 = 
NULL
;

595 
ùoib_∑th
 *
ç©h
;

596 
ªt
;

598 *
n
) {

599 
≤
 = *
n
;

600 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

602 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

603  (
ib_gid
));

604 i‡(
ªt
 < 0)

605 
n
 = &
≤
->
rb_À·
;

606 i‡(
ªt
 > 0)

607 
n
 = &
≤
->
rb_right
;

609  -
EEXIST
;

612 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

613 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

615 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

618 
	}
}

620 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

622 
sk_buff
 *
skb
;

624 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

625 
	`dev_k‰ì_skb_úq
(
skb
);

627 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

630 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

632 i‡(
∑th
->
ah
)

633 
	`ùoib_put_ah
(
∑th
->
ah
);

635 
	`k‰ì
(
∑th
);

636 
	}
}

638 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


640 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

642 
ùoib_∑th_ôî
 *
ôî
;

644 
ôî
 = 
	`kmÆloc
( *ôî, 
GFP_KERNEL
);

645 i‡(!
ôî
)

646  
NULL
;

648 
ôî
->
dev
 = dev;

649 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

651 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

652 
	`k‰ì
(
ôî
);

653  
NULL
;

656  
ôî
;

657 
	}
}

659 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

661 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

662 
rb_node
 *
n
;

663 
ùoib_∑th
 *
∑th
;

664 
ªt
 = 1;

666 
	`•ö_lock_úq
(&
¥iv
->
lock
);

668 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

670 
n
) {

671 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

673 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

674  (
ib_gid
)) < 0) {

675 
ôî
->
∑th
 = *path;

676 
ªt
 = 0;

680 
n
 = 
	`rb_√xt
(n);

683 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

685  
ªt
;

686 
	}
}

688 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

689 
ùoib_∑th
 *
∑th
)

691 *
∑th
 = 
ôî
->path;

692 
	}
}

696 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

698 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

699 
ùoib_∑th
 *
∑th
, *
ç
;

701 
	`•ö_lock_úq
(&
¥iv
->
lock
);

703 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

704 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

705 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

706 
∑th
->
∑thªc
.
dgid
.
øw
);

707 
∑th
->
vÆid
 = 0;

710 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

711 
	}
}

713 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

715 
ùoib_p£udo_hódî
 *
phdr
;

717 
phdr
 = (
ùoib_p£udo_hódî
 *)
	`skb_push
(
skb
, (*phdr));

718 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

719 
	}
}

721 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

723 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

724 
ùoib_∑th
 *
∑th
, *
ç
;

725 
	`LIST_HEAD
(
ªmove_li°
);

726 
Êags
;

728 
	`√tif_tx_lock_bh
(
dev
);

729 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

731 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

733 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

734 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

736 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

737 i‡(
∑th
->
quîy
)

738 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

742 
	`∑th_‰ì
(
dev
, 
∑th
);

743 
	`√tif_tx_lock_bh
(
dev
);

744 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

747 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

748 
	`√tif_tx_u∆ock_bh
(
dev
);

749 
	}
}

751 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

752 
ß_∑th_ªc
 *
∑thªc
,

753 *
∑th_±r
)

755 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

756 
√t_devi˚
 *
dev
 = 
∑th
->dev;

757 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

758 
ùoib_ah
 *
ah
 = 
NULL
;

759 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

760 
ùoib_√igh
 *
√igh
, *
ä
;

761 
sk_buff_hód
 
skqueue
;

762 
sk_buff
 *
skb
;

763 
Êags
;

765 i‡(!
°©us
)

766 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

767 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

768 
∑thªc
->
dgid
.
øw
);

770 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

771 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

773 
	`skb_queue_hód_öô
(&
skqueue
);

775 i‡(!
°©us
) {

776 
rdma_ah_©å
 
av
;

777 #ifde‡
IFS_RH75


778 i‡(!
	`ib_öô_ah_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

779 
∑thªc
, &
av
))

782 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

783 
∑thªc
, &
av
))

785 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

788 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

790 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

796 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

797 (
ib_gid
))) {

798 
	`ùoib_dbg
(

799 
¥iv
,

801 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

802 
∑th
->
∑thªc
.
dgid
.
øw
);

803 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

804 (
ib_gid
));

807 
∑th
->
∑thªc
 = *pathrec;

809 
ﬁd_ah
 = 
∑th
->
ah
;

810 
∑th
->
ah
 =áh;

812 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

813 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

814 
∑thªc
->
¶
);

816 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

817 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

819 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

820 i‡(
√igh
->
ah
) {

821 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

829 
	`ùoib_put_ah
(
√igh
->
ah
);

831 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

832 
√igh
->
ah
 = 
∑th
->ah;

834 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

835 i‡(!
	`ùoib_cm_gë
(
√igh
))

836 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

837 
∑th
,

838 
√igh
));

839 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

840 
	`ùoib_√igh_‰ì
(
√igh
);

845 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

846 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

848 
∑th
->
vÆid
 = 1;

851 
∑th
->
quîy
 = 
NULL
;

852 
	`com∂ëe
(&
∑th
->
d⁄e
);

854 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

856 i‡(
	`IS_ERR_OR_NULL
(
ah
))

857 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

859 i‡(
ﬁd_ah
)

860 
	`ùoib_put_ah
(
ﬁd_ah
);

862 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

863 
ªt
;

864 
skb
->
dev
 = dev;

865 
ªt
 = 
	`dev_queue_xmô
(
skb
);

866 i‡(
ªt
)

867 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

868 
__func__
, 
ªt
);

870 
	}
}

872 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

873 *
gid
)

875 
∑th
->
dev
 = 
¥iv
->dev;

877 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

878 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

880 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

882 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

883 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

884 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

885 
∑th
->
∑thªc
.
numb_∑th
 = 1;

886 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

887 
	}
}

889 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

891 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

892 
ùoib_∑th
 *
∑th
;

894 i‡(!
¥iv
->
brﬂdˇ°
)

895  
NULL
;

897 
∑th
 = 
	`kzÆloc
( *∑th, 
GFP_ATOMIC
);

898 i‡(!
∑th
)

899  
NULL
;

901 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

903 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

905 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

907  
∑th
;

908 
	}
}

910 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

911 
ùoib_∑th
 *
∑th
)

913 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

915 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

916 
∑th
->
∑thªc
.
dgid
.
øw
);

918 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

920 
∑th
->
quîy_id
 =

921 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

922 &
∑th
->
∑thªc
,

923 
IB_SA_PATH_REC_DGID
 |

924 
IB_SA_PATH_REC_SGID
 |

925 
IB_SA_PATH_REC_NUMB_PATH
 |

926 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

927 
IB_SA_PATH_REC_PKEY
,

928 1000, 
GFP_ATOMIC
,

929 
∑th_ªc_com∂ëi⁄
,

930 
∑th
, &∑th->
quîy
);

931 i‡(
∑th
->
quîy_id
 < 0) {

932 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

933 
∑th
->
quîy
 = 
NULL
;

934 
	`com∂ëe
(&
∑th
->
d⁄e
);

935  
∑th
->
quîy_id
;

939 
	}
}

941 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

942 
√t_devi˚
 *
dev
)

944 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

945 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

946 
ùoib_∑th
 *
∑th
;

947 
ùoib_√igh
 *
√igh
;

948 
Êags
;

950 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

951 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

952 i‡(!
√igh
) {

953 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

954 ++
dev
->
°©s
.
tx_dr›≥d
;

955 
	`dev_k‰ì_skb_™y
(
skb
);

956  
NULL
;

962 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

963 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

964  
√igh
;

967 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

968 i‡(!
∑th
) {

969 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

970 i‡(!
∑th
)

971 
îr_∑th
;

973 
	`__∑th_add
(
dev
, 
∑th
);

976 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

978 i‡(
∑th
->
ah
) {

979 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

980 
√igh
->
ah
 = 
∑th
->ah;

982 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

983 i‡(!
	`ùoib_cm_gë
(
√igh
))

984 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

985 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

986 
	`ùoib_√igh_‰ì
(
√igh
);

987 
îr_dr›
;

989 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

990 
IPOIB_MAX_PATH_REC_QUEUE
) {

991 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

992 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

994 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

995 
	`skb_queue_Àn
(&
√igh
->
queue
));

996 
îr_dr›
;

999 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1000 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1001 
	`IPOIB_QPN
(
daddr
));

1002 
	`ùoib_√igh_put
(
√igh
);

1003  
NULL
;

1006 
√igh
->
ah
 = 
NULL
;

1008 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1009 
îr_∑th
;

1010 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1011 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1012 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1014 
îr_dr›
;

1018 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1019 
	`ùoib_√igh_put
(
√igh
);

1020  
NULL
;

1022 
îr_∑th
:

1023 
	`ùoib_√igh_‰ì
(
√igh
);

1024 
îr_dr›
:

1025 ++
dev
->
°©s
.
tx_dr›≥d
;

1026 
	`dev_k‰ì_skb_™y
(
skb
);

1028 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1029 
	`ùoib_√igh_put
(
√igh
);

1031  
NULL
;

1032 
	}
}

1034 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1035 
ùoib_p£udo_hódî
 *
phdr
)

1037 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1038 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1039 
ùoib_∑th
 *
∑th
;

1040 
Êags
;

1042 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1045 i‡(!
¥iv
->
brﬂdˇ°
)

1046 
dr›_™d_u∆ock
;

1048 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1049 i‡(!
∑th
 || !∑th->
vÆid
) {

1050 
√w_∑th
 = 0;

1052 i‡(!
∑th
) {

1053 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1054 
√w_∑th
 = 1;

1056 i‡(
∑th
) {

1057 i‡(!
√w_∑th
)

1059 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1061 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1062 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1063 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1065 ++
dev
->
°©s
.
tx_dr›≥d
;

1066 
	`dev_k‰ì_skb_™y
(
skb
);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1071 i‡(
√w_∑th
)

1072 
	`∑th_‰ì
(
dev
, 
∑th
);

1075 
	`__∑th_add
(
dev
, 
∑th
);

1077 
dr›_™d_u∆ock
;

1080 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1084 i‡(
∑th
->
ah
) {

1085 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1086 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1088 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1089 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1090 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1092 } i‡((
∑th
->
quîy
 || !
	`∑th_ªc_°¨t
(
dev
,Öath)) &&

1093 
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1094 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1095 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1097 
dr›_™d_u∆ock
;

1100 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1103 
dr›_™d_u∆ock
:

1104 ++
dev
->
°©s
.
tx_dr›≥d
;

1105 
	`dev_k‰ì_skb_™y
(
skb
);

1106 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1107 
	}
}

1109 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1111 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1112 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1113 
ùoib_√igh
 *
√igh
;

1114 
ùoib_p£udo_hódî
 *
phdr
;

1115 
ùoib_hódî
 *
hódî
;

1116 
Êags
;

1118 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1119 
	`skb_puŒ
(
skb
, (*
phdr
));

1120 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1122 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1124 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1125 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1126 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1127 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1128 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1130 ++
dev
->
°©s
.
tx_dr›≥d
;

1131 
	`dev_k‰ì_skb_™y
(
skb
);

1132  
NETDEV_TX_OK
;

1135 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1136 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1138 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1139 i‡(
	`likñy
(
√igh
))

1140 
£nd_usög_√igh
;

1141 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1142  
NETDEV_TX_OK
;

1146 
hódî
->
¥Ÿo
) {

1147 
	`ht⁄s
(
ETH_P_IP
):

1148 
	`ht⁄s
(
ETH_P_IPV6
):

1149 
	`ht⁄s
(
ETH_P_TIPC
):

1150 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1151 i‡(
	`u∆ikñy
(!
√igh
)) {

1152 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1153 i‡(
	`likñy
(!
√igh
))

1154  
NETDEV_TX_OK
;

1157 
	`ht⁄s
(
ETH_P_ARP
):

1158 
	`ht⁄s
(
ETH_P_RARP
):

1160 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1161  
NETDEV_TX_OK
;

1164 ++
dev
->
°©s
.
tx_dr›≥d
;

1165 
	`dev_k‰ì_skb_™y
(
skb
);

1166  
NETDEV_TX_OK
;

1169 
£nd_usög_√igh
:

1171 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1172 i‡(
	`ùoib_cm_up
(
√igh
)) {

1173 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1174 
uƒef
;

1176 } i‡(
√igh
->
ah
) {

1177 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1178 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1179 
uƒef
;

1182 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1183 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1184 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1185 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1186 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1188 ++
dev
->
°©s
.
tx_dr›≥d
;

1189 
	`dev_k‰ì_skb_™y
(
skb
);

1192 
uƒef
:

1193 
	`ùoib_√igh_put
(
√igh
);

1195  
NETDEV_TX_OK
;

1196 
	}
}

1198 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1200 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1202 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1203 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1204 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1205 
	`√tif_queue_°›≥d
(
dev
),

1206 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1208 
	}
}

1210 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1211 
√t_devi˚
 *
dev
,

1212 
ty≥
,

1213 c⁄° *
daddr
, c⁄° *
ßddr
, 
Àn
)

1215 
ùoib_hódî
 *
hódî
;

1217 
hódî
 = (
ùoib_hódî
 *Ë
	`skb_push
(
skb
,  *header);

1219 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1220 
hódî
->
ª£rved
 = 0;

1227 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1229  
IPOIB_HARD_LEN
;

1230 
	}
}

1232 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1234 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1236 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1237 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1241 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1242 
	}
}

1244 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1246 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1249 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1250  
dev
->
ifödex
;

1253  
¥iv
->
∑ª¡
->
ifödex
;

1254 
	}
}

1256 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1265 
u32
 *
d32
 = (u32 *Ë
daddr
;

1266 
u32
 
hv
;

1268 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1269  
hv
 & 
htbl
->
mask
;

1270 
	}
}

1272 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1274 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1275 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1276 
ùoib_√igh_hash
 *
htbl
;

1277 
ùoib_√igh
 *
√igh
 = 
NULL
;

1278 
u32
 
hash_vÆ
;

1280 
	`rcu_ªad_lock_bh
();

1282 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1284 i‡(!
htbl
)

1285 
out_u∆ock
;

1287 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1288 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1289 
√igh
 !
NULL
;

1290 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1291 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1293 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1295 
√igh
 = 
NULL
;

1296 
out_u∆ock
;

1299 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1300 
√igh
->
Æive
 = 
jiffõs
;

1301 
out_u∆ock
;

1305 
out_u∆ock
:

1306 
	`rcu_ªad_u∆ock_bh
();

1307  
√igh
;

1308 
	}
}

1310 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1312 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1313 
ùoib_√igh_hash
 *
htbl
;

1314 
√igh_obsﬁëe
;

1315 
dt
;

1316 
Êags
;

1317 
i
;

1318 
	`LIST_HEAD
(
ªmove_li°
);

1320 i‡(
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1323 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1325 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1326 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1328 i‡(!
htbl
)

1329 
out_u∆ock
;

1332 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1333 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1335 i‡(
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1336 
out_u∆ock
;

1338 
i
 = 0; i < 
htbl
->
size
; i++) {

1339 
ùoib_√igh
 *
√igh
;

1340 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1342 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1343 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1345 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1347 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1349 
	`rcu_assign_poöãr
(*
≈
,

1350 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1351 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1353 
	`li°_dñ_öô
(&
√igh
->
li°
);

1354 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1356 
≈
 = &
√igh
->
h√xt
;

1362 
out_u∆ock
:

1363 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1364 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1365 
	}
}

1367 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1369 
ùoib_dev_¥iv
 *
¥iv
 =

1370 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1372 
	`__ùoib_ª≠_√igh
(
¥iv
);

1374 i‡(!
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1375 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1376 
¨p_tbl
.
gc_öãrvÆ
);

1377 
	}
}

1380 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1381 
√t_devi˚
 *
dev
)

1383 
ùoib_√igh
 *
√igh
;

1385 
√igh
 = 
	`kzÆloc
( *√igh, 
GFP_ATOMIC
);

1386 i‡(!
√igh
)

1387  
NULL
;

1389 
√igh
->
dev
 = dev;

1390 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1391 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1392 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1393 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1395 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1397  
√igh
;

1398 
	}
}

1400 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1401 
√t_devi˚
 *
dev
)

1403 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1404 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1405 
ùoib_√igh_hash
 *
htbl
;

1406 
ùoib_√igh
 *
√igh
;

1407 
u32
 
hash_vÆ
;

1409 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1410 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1411 i‡(!
htbl
) {

1412 
√igh
 = 
NULL
;

1413 
out_u∆ock
;

1419 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1420 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1421 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1422 
√igh
 !
NULL
;

1423 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1424 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1425 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1427 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1429 
√igh
 = 
NULL
;

1432 
√igh
->
Æive
 = 
jiffõs
;

1433 
out_u∆ock
;

1437 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1438 i‡(!
√igh
)

1439 
out_u∆ock
;

1442 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1443 
√igh
->
Æive
 = 
jiffõs
;

1445 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1446 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1447 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1448 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1449 
	`©omic_öc
(&
¡bl
->
íåõs
);

1451 
out_u∆ock
:

1453  
√igh
;

1454 
	}
}

1456 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1459 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1460 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1461 
sk_buff
 *
skb
;

1462 i‡(
√igh
->
ah
)

1463 
	`ùoib_put_ah
(
√igh
->
ah
);

1464 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1465 ++
dev
->
°©s
.
tx_dr›≥d
;

1466 
	`dev_k‰ì_skb_™y
(
skb
);

1468 i‡(
	`ùoib_cm_gë
(
√igh
))

1469 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1470 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1472 
	`IPOIB_QPN
(
√igh
->
daddr
),

1473 
√igh
->
daddr
 + 4);

1474 
	`k‰ì
(
√igh
);

1475 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1476 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1477 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1479 
	}
}

1481 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1484 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1486 
	`ùoib_√igh_put
(
√igh
);

1487 
	}
}

1489 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1491 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1492 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1493 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1494 
ùoib_√igh_hash
 *
htbl
;

1495 
ùoib_√igh
 
__rcu
 **
≈
;

1496 
ùoib_√igh
 *
n
;

1497 
u32
 
hash_vÆ
;

1499 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1500 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1501 i‡(!
htbl
)

1504 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1505 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1506 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1507 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1508 
n
 !
NULL
;

1509 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1510 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1511 i‡(
n
 =
√igh
) {

1513 
	`rcu_assign_poöãr
(*
≈
,

1514 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1515 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1517 
	`li°_dñ_öô
(&
√igh
->
li°
);

1518 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1521 
≈
 = &
n
->
h√xt
;

1524 
	}
}

1526 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1528 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1529 
ùoib_√igh_hash
 *
htbl
;

1530 
ùoib_√igh
 
__rcu
 **
buckës
;

1531 
u32
 
size
;

1533 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1534 
¡bl
->
htbl
 = 
NULL
;

1535 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1536 i‡(!
htbl
)

1537  -
ENOMEM
;

1538 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1539 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1540 
buckës
 = 
	`kzÆloc
(
size
 * (*buckës), 
GFP_KERNEL
);

1541 i‡(!
buckës
) {

1542 
	`k‰ì
(
htbl
);

1543  -
ENOMEM
;

1545 
htbl
->
size
 = size;

1546 
htbl
->
mask
 = (
size
 - 1);

1547 
htbl
->
buckës
 = buckets;

1548 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1549 
htbl
->
¡bl
 =Çtbl;

1550 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1553 
	`˛ór_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1554 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1555 
¨p_tbl
.
gc_öãrvÆ
);

1558 
	}
}

1560 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1562 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1563 
ùoib_√igh_hash
,

1564 
rcu
);

1565 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1566 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1568 
	`k‰ì
(
buckës
);

1569 
	`k‰ì
(
htbl
);

1570 
	`com∂ëe
(&
¡bl
->
dñëed
);

1571 
	}
}

1573 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1575 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1576 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1577 
ùoib_√igh_hash
 *
htbl
;

1578 
Êags
;

1579 
i
;

1582 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1584 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1585 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1587 i‡(!
htbl
)

1588 
out_u∆ock
;

1590 
i
 = 0; i < 
htbl
->
size
; i++) {

1591 
ùoib_√igh
 *
√igh
;

1592 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1594 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1595 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1597 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1598 
	`rcu_assign_poöãr
(*
≈
,

1599 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1600 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1602 
	`li°_dñ_öô
(&
√igh
->
li°
);

1603 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1605 
≈
 = &
√igh
->
h√xt
;

1610 
out_u∆ock
:

1611 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1612 
	}
}

1614 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1616 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1617 
ùoib_√igh_hash
 *
htbl
;

1618 
Êags
;

1619 
i
, 
waô_Êushed
 = 0;

1621 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1622 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1624 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1626 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1627 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1628 i‡(!
htbl
)

1629 
out_u∆ock
;

1631 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1632 i‡(!
waô_Êushed
)

1633 
‰ì_htbl
;

1635 
i
 = 0; i < 
htbl
->
size
; i++) {

1636 
ùoib_√igh
 *
√igh
;

1637 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1639 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1640 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1641 
	`rcu_assign_poöãr
(*
≈
,

1642 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1643 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1645 
	`li°_dñ_öô
(&
√igh
->
li°
);

1646 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1650 
‰ì_htbl
:

1651 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1652 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1654 
out_u∆ock
:

1655 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1656 i‡(
waô_Êushed
)

1657 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1658 
	}
}

1660 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1662 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1663 
°›≥d
;

1665 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1666 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1669 
°›≥d
 = 
	`ã°_™d_£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1670 i‡(!
°›≥d
)

1671 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

1673 
	`ùoib_Êush_√ighs
(
¥iv
);

1675 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1676 
	}
}

1678 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1682 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1683 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1684 
	}
}

1686 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1688 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1690 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1691 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1692 
	}
}

1694 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1696 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1698 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1700 
	`ùoib_«pi_dñ
(
dev
);

1702 
	`ùoib_cm_dev_˛ónup
(
dev
);

1704 
	`k‰ì
(
¥iv
->
rx_rög
);

1705 
	`v‰ì
(
¥iv
->
tx_rög
);

1707 
¥iv
->
rx_rög
 = 
NULL
;

1708 
¥iv
->
tx_rög
 = 
NULL
;

1709 
	}
}

1711 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1713 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1715 
	`ùoib_«pi_add
(
dev
);

1718 
¥iv
->
rx_rög
 = 
	`kzÆloc
(
ùoib_ªcvq_size
 *  *priv->rx_ring,

1719 
GFP_KERNEL
);

1720 i‡(!
¥iv
->
rx_rög
)

1721 
out
;

1723 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 *  *priv->tx_ring);

1724 i‡(!
¥iv
->
tx_rög
) {

1725 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1726 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1727 
out_rx_rög_˛ónup
;

1732 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1733 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1734 
¥iv
->
ˇ
->
«me
);

1735 
out_tx_rög_˛ónup
;

1739 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1740 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1741 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1745 
out_tx_rög_˛ónup
:

1746 
	`v‰ì
(
¥iv
->
tx_rög
);

1748 
out_rx_rög_˛ónup
:

1749 
	`k‰ì
(
¥iv
->
rx_rög
);

1751 
out
:

1752 
	`ùoib_«pi_dñ
(
dev
);

1753  -
ENOMEM
;

1754 
	}
}

1756 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1757 
cmd
)

1759 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1761 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1762  -
EOPNOTSUPP
;

1764  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1765 
	}
}

1767 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
, 
p‹t
)

1769 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1770 
ªt
 = -
ENOMEM
;

1772 
¥iv
->
ˇ
 = ca;

1773 
¥iv
->
p‹t
 =Öort;

1774 
¥iv
->
qp
 = 
NULL
;

1780 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1781 i‡(!
¥iv
->
wq
) {

1782 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1783 
out
;

1787 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1788 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1789 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
ˇ
->
«me
);

1790 
˛ón_wq
;

1793 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1794 i‡(
ªt
) {

1795 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1796 
out_‰ì_pd
;

1799 i‡(
	`ùoib_√igh_hash_öô
(
¥iv
) < 0) {

1800 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1801 
out_dev_unöô
;

1804 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1805 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1806 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1807 
ªt
 = -
ENODEV
;

1808 
out_dev_unöô
;

1814 
out_dev_unöô
:

1815 
	`ùoib_ib_dev_˛ónup
(
dev
);

1817 
out_‰ì_pd
:

1818 i‡(
¥iv
->
pd
) {

1819 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1820 
¥iv
->
pd
 = 
NULL
;

1823 
˛ón_wq
:

1824 i‡(
¥iv
->
wq
) {

1825 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1826 
¥iv
->
wq
 = 
NULL
;

1829 
out
:

1830  
ªt
;

1831 
	}
}

1833 
	$ùoib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1835 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
), *
˝riv
, *
t˝riv
;

1836 
	`LIST_HEAD
(
hód
);

1838 
	`ASSERT_RTNL
();

1841 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

1843 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
˝riv
->
Êags
);

1844 
	`ˇn˚l_dñayed_w‹k
(&
˝riv
->
√igh_ª≠_èsk
);

1845 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

1847 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

1849 
	`ùoib_√igh_hash_unöô
(
dev
);

1851 
	`ùoib_ib_dev_˛ónup
(
dev
);

1854 i‡(
¥iv
->
wq
) {

1855 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1856 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1857 
¥iv
->
wq
 = 
NULL
;

1859 
	}
}

1861 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1863 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1865  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

1866 
	}
}

1868 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

1869 
iÊa_vf_öfo
 *
ivf
)

1871 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1872 
îr
;

1874 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

1875 i‡(
îr
)

1876  
îr
;

1878 
ivf
->
vf
 = vf;

1881 
	}
}

1883 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

1885 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1887 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

1888  -
EINVAL
;

1890  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

1891 
	}
}

1893 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

1894 
iÊa_vf_°©s
 *
vf_°©s
)

1896 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1898  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

1899 
	}
}

1901 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

1902 .
¸óã
 = 
ùoib_h¨d_hódî
,

1905 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

1906 .
ndo_size
 = (
√t_devi˚_›s
),

1907 .
	gndo_unöô
 = 
ùoib_unöô
,

1908 .
	gndo_›í
 = 
ùoib_›í
,

1909 .
	gndo_°›
 = 
ùoib_°›
,

1910 .
	gndo_ch™ge_mtu_rh74
 = 
ùoib_ch™ge_mtu
,

1911 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

1912 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

1913 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

1914 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

1915 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

1916 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

1917 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

1918 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

1919 .
	gexãnded
.
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

1920 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

1921 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

1922 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

1925 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

1926 .
ndo_unöô
 = 
ùoib_unöô
,

1927 .
	gndo_›í
 = 
ùoib_›í
,

1928 .
	gndo_°›
 = 
ùoib_°›
,

1929 .
	gndo_ch™ge_mtu_rh74
 = 
ùoib_ch™ge_mtu
,

1930 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

1931 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

1932 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

1933 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

1934 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

1935 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

1936 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

1939 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

1940 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

1941 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

1942 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

1943 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

1946 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

1948 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

1949 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

1951 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

1953 
dev
->
w©chdog_timeo
 = 
HZ
;

1955 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

1957 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

1958 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

1959 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

1960 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

1961 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

1962 
NETIF_F_HIGHDMA
);

1963 
	`√tif_kìp_d°
(
dev
);

1965 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

1966 
	}
}

1968 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

1970 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1972 
¥iv
->
dev
 = dev;

1973 
	`•ö_lock_öô
(&
¥iv
->
lock
);

1974 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

1975 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

1976 
	`muãx_öô
(&
¥iv
->
sysfs_muãx
);

1978 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

1979 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

1980 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

1981 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

1983 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

1984 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

1985 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

1986 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

1987 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

1988 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

1989 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

1990 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

1991 
	}
}

1993 
√t_devi˚


1994 *
ùoib_¸óã_√tdev_deÁu…
(
ib_devi˚
 *
hˇ
,

1995 c⁄° *
«me
,

1996 
«me_assign_ty≥
,

1997 (*
£tup
)(
√t_devi˚
 *))

1999 
√t_devi˚
 *
dev
;

2000 
rdma_√tdev
 *
∫
;

2002 
dev
 = 
	`Æloc_√tdev
(()(
rdma_√tdev
),

2003 
«me
,

2004 
£tup
);

2005 i‡(!
dev
)

2006  
NULL
;

2008 
∫
 = 
	`√tdev_¥iv
(
dev
);

2010 
∫
->
£nd
 = 
ùoib_£nd
;

2011 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2012 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2013 
∫
->
‰ì_rdma_√tdev
 = 
‰ì_√tdev
;

2014 
∫
->
hˇ
 = hca;

2016  
dev
;

2017 
	}
}

2019 
√t_devi˚
 *
	$ùoib_gë_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2020 c⁄° *
«me
)

2022 
√t_devi˚
 *
dev
 = 
NULL
;

2024 i‡(
hˇ
->
Æloc_rdma_√tdev
 && 
ùoib_íh™˚d_íabÀd
) {

2025 
dev
 = 
hˇ
->
	`Æloc_rdma_√tdev
(hˇ, 
p‹t
,

2026 
RDMA_NETDEV_IPOIB
, 
«me
,

2028 
ùoib_£tup_comm⁄
);

2029 i‡(
	`IS_ERR_OR_NULL
(
dev
Ë&& 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2030  
NULL
;

2033 i‡(!
hˇ
->
Æloc_rdma_√tdev
 || 
	`PTR_ERR
(
dev
Ë=-
EOPNOTSUPP
 ||

2034 !
ùoib_íh™˚d_íabÀd
)

2035 
dev
 = 
	`ùoib_¸óã_√tdev_deÁu…
(
hˇ
, 
«me
, 0,

2036 
ùoib_£tup_comm⁄
);

2038  
dev
;

2039 
	}
}

2041 
ùoib_dev_¥iv
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2042 c⁄° *
«me
)

2044 
√t_devi˚
 *
dev
;

2045 
ùoib_dev_¥iv
 *
¥iv
;

2046 
rdma_√tdev
 *
∫
;

2048 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2049 i‡(!
¥iv
)

2050  
NULL
;

2052 
dev
 = 
	`ùoib_gë_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2053 i‡(!
dev
)

2054 
‰ì_¥iv
;

2056 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2059 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2060 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2062 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2064 
∫
 = 
	`√tdev_¥iv
(
dev
);

2065 
∫
->
˛¡_¥iv
 = 
¥iv
;

2066 
	`ùoib_buûd_¥iv
(
dev
);

2068  
¥iv
;

2069 
‰ì_¥iv
:

2070 
	`k‰ì
(
¥iv
);

2071  
NULL
;

2072 
	}
}

2074 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2075 
devi˚_©åibuã
 *
©å
, *
buf
)

2077 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2078 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2080  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2081 
	}
}

2082 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2084 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2085 
devi˚_©åibuã
 *
©å
, *
buf
)

2087 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2088 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2090  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2091 
	}
}

2093 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2095 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2097 i‡(
umˇ°_vÆ
 > 0) {

2098 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2099 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2102 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2103 
	}
}

2105 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2106 
devi˚_©åibuã
 *
©å
,

2107 c⁄° *
buf
, 
size_t
 
cou¡
)

2109 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2111 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2113  
cou¡
;

2114 
	}
}

2115 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2117 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2119  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2120 
	}
}

2122 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2124 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2125 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2127 
	`√tif_addr_lock_bh
(
√tdev
);

2129 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2130 &
gid
->
globÆ
.
öãrÁ˚_id
,

2131 (
gid
->
globÆ
.
öãrÁ˚_id
));

2132 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2133 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2135 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2137 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2138 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2139 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2140 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2141 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2143 
	}
}

2145 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2146 
sockaddr_°‹age
 *
ss
)

2148 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2149 
ªt
 = 0;

2151 
	`√tif_addr_lock_bh
(
dev
);

2156 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2157 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2158 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2159 
ªt
 = -
EINVAL
;

2161 
	`√tif_addr_u∆ock_bh
(
dev
);

2163  
ªt
;

2164 
	}
}

2166 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2168 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2169 
sockaddr_°‹age
 *
ss
 = 
addr
;

2170 
ªt
;

2172 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2173  -
EBUSY
;

2175 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2176 i‡(
ªt
)

2177  
ªt
;

2179 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2181 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2184 
	}
}

2186 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2187 
devi˚_©åibuã
 *
©å
,

2188 c⁄° *
buf
, 
size_t
 
cou¡
)

2190 
pkey
;

2191 
ªt
;

2193 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2194  -
EINVAL
;

2196 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2197  -
EINVAL
;

2203 
pkey
 |= 0x8000;

2205 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2207  
ªt
 ?Ñë : 
cou¡
;

2208 
	}
}

2209 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2211 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2212 
devi˚_©åibuã
 *
©å
,

2213 c⁄° *
buf
, 
size_t
 
cou¡
)

2215 
pkey
;

2216 
ªt
;

2218 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2219  -
EINVAL
;

2221 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2222  -
EINVAL
;

2224 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2226  
ªt
 ?Ñë : 
cou¡
;

2228 
	}
}

2229 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2231 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2233  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2234 
	}
}

2236 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_devi˚
 *
hˇ
)

2238 
¥iv
->
hˇ_ˇps
 = 
hˇ
->
©ås
.
devi˚_ˇp_Êags
;

2240 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

2241 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

2243 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

2244 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

2246 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

2248 
	}
}

2250 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2251 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2253 
ùoib_dev_¥iv
 *
¥iv
;

2254 
ib_p‹t_©å
 
©å
;

2255 
rdma_√tdev
 *
∫
;

2256 
ªsu…
 = -
ENOMEM
;

2258 
¥iv
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2259 i‡(!
¥iv
) {

2260 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed\n", 
hˇ
->
«me
, 
p‹t
);

2261 
Æloc_mem_Áûed
;

2264 
	`SET_NETDEV_DEV
(
¥iv
->
dev
, 
hˇ
->dev.
∑ª¡
);

2265 
¥iv
->
dev
->
dev_id
 = 
p‹t
 - 1;

2267 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

2269 
ªsu…
 = 
	`ib_quîy_p‹t
(
hˇ
, 
p‹t
, &
©å
);

2270 i‡(
ªsu…
) {

2271 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
hˇ
->
«me
, 
p‹t
);

2272 
devi˚_öô_Áûed
;

2275 i‡(
	`rdma_c‹e_ˇp_›a_p‹t
(
hˇ
, 
p‹t
Ë&& 
ùoib_ac˚l
)

2276 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

2278 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

2281 
¥iv
->
dev
->
mtu
 = 
	`IPOIB_UD_MTU
’riv->
max_ib_mtu
);

2282 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 =Öriv->
dev
->
mtu
;

2283 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

2284 
¥iv
->
dev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

2286 
ªsu…
 = 
	`ib_quîy_pkey
(
hˇ
, 
p‹t
, 0, &
¥iv
->
pkey
);

2287 i‡(
ªsu…
) {

2288 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

2289 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2290 
devi˚_öô_Áûed
;

2293 
	`ùoib_£t_dev_„©uªs
(
¥iv
, 
hˇ
);

2299 
¥iv
->
pkey
 |= 0x8000;

2301 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

2302 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

2304 
ªsu…
 = 
	`ib_quîy_gid
(
hˇ
, 
p‹t
, 0, &
¥iv
->
loˇl_gid
, 
NULL
);

2305 i‡(
ªsu…
) {

2306 
	`¥_w¨n
("%s: ib_query_gidÖort %d failed (ret = %d)\n",

2307 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2308 
devi˚_öô_Áûed
;

2311 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

2312 (
ib_gid
));

2313 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2315 
ªsu…
 = 
	`ùoib_dev_öô
(
¥iv
->
dev
, 
hˇ
, 
p‹t
);

2316 i‡(
ªsu…
) {

2317 
	`¥_w¨n
("%s: failedÅo initializeÖort %d (ret = %d)\n",

2318 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2319 
devi˚_öô_Áûed
;

2322 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2323 
¥iv
->
ˇ
, 
ùoib_evít
);

2324 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2327 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2329 
ªsu…
 = 
	`ªgi°î_√tdev
(
¥iv
->
dev
);

2330 i‡(
ªsu…
) {

2331 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2332 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2333 
ªgi°î_Áûed
;

2336 
ªsu…
 = -
ENOMEM
;

2337 i‡(
	`ùoib_cm_add_mode_©å
(
¥iv
->
dev
))

2338 
sysfs_Áûed
;

2339 i‡(
	`ùoib_add_pkey_©å
(
¥iv
->
dev
))

2340 
sysfs_Áûed
;

2341 i‡(
	`ùoib_add_umˇ°_©å
(
¥iv
->
dev
))

2342 
sysfs_Áûed
;

2343 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_¸óã_chûd
))

2344 
sysfs_Áûed
;

2345 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_dñëe_chûd
))

2346 
sysfs_Áûed
;

2348  
¥iv
->
dev
;

2350 
sysfs_Áûed
:

2351 
	`uƒegi°î_√tdev
(
¥iv
->
dev
);

2353 
ªgi°î_Áûed
:

2354 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2355 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

2357 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

2358 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

2359 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

2360 
	`ùoib_dev_˛ónup
(
¥iv
->
dev
);

2362 
devi˚_öô_Áûed
:

2363 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

2364 
	`k‰ì
(
¥iv
);

2366 
Æloc_mem_Áûed
:

2367  
	`ERR_PTR
(
ªsu…
);

2368 
	}
}

2370 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2372 
li°_hód
 *
dev_li°
;

2373 
√t_devi˚
 *
dev
;

2374 
ùoib_dev_¥iv
 *
¥iv
;

2375 
p
;

2376 
cou¡
 = 0;

2378 
dev_li°
 = 
	`kmÆloc
( *dev_li°, 
GFP_KERNEL
);

2379 i‡(!
dev_li°
)

2382 
	`INIT_LIST_HEAD
(
dev_li°
);

2384 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2385 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2387 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2388 i‡(!
	`IS_ERR
(
dev
)) {

2389 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2390 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2391 
cou¡
++;

2395 i‡(!
cou¡
) {

2396 
	`k‰ì
(
dev_li°
);

2400 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2401 
	}
}

2403 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2405 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2406 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2408 i‡(!
dev_li°
)

2411 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2412 
rdma_√tdev
 *
∑ª¡_∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

2414 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2415 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

2418 
	`£t_bô
(
IPOIB_FLAG_GOING_DOWN
, &
¥iv
->
Êags
);

2420 
	`π∆_lock
();

2421 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

2422 
	`π∆_u∆ock
();

2425 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

2426 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

2427 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

2430 
	`muãx_lock
(&
¥iv
->
sysfs_muãx
);

2431 
	`uƒegi°î_√tdev
(
¥iv
->
dev
);

2432 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

2434 
∑ª¡_∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

2436 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

2437 
rdma_√tdev
 *
chûd_∫
;

2439 
chûd_∫
 = 
	`√tdev_¥iv
(
˝riv
->
dev
);

2440 
chûd_∫
->
	`‰ì_rdma_√tdev
(
˝riv
->
dev
);

2441 
	`k‰ì
(
˝riv
);

2444 
	`k‰ì
(
¥iv
);

2447 
	`k‰ì
(
dev_li°
);

2448 
	}
}

2450 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2451 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2452 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2456 
__öô
 
	$ùoib_öô_moduÀ
()

2458 
ªt
;

2460 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2461 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2462 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2464 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2465 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2466 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2467 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2468 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2469 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2476 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2478 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2480 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2481 i‡(
ªt
)

2482  
ªt
;

2494 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush",

2495 
WQ_MEM_RECLAIM
);

2496 i‡(!
ùoib_w‹kqueue
) {

2497 
ªt
 = -
ENOMEM
;

2498 
îr_fs
;

2501 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2503 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2504 i‡(
ªt
)

2505 
îr_ß
;

2507 
ªt
 = 
	`ùoib_√éök_öô
();

2508 i‡(
ªt
)

2509 
îr_˛õ¡
;

2511 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2512 
	`ªgi°î_√tdevi˚_nŸifõr_rh
(&
ùoib_√tdev_nŸifõr
);

2516 
îr_˛õ¡
:

2517 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2519 
îr_ß
:

2520 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2521 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2523 
îr_fs
:

2524 
	`ùoib_uƒegi°î_debugfs
();

2526  
ªt
;

2527 
	}
}

2529 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2531 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2532 
	`uƒegi°î_√tdevi˚_nŸifõr_rh
(&
ùoib_√tdev_nŸifõr
);

2534 
	`ùoib_√éök_föi
();

2535 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2536 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2537 
	`ùoib_uƒegi°î_debugfs
();

2538 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2539 
	}
}

2541 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2542 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL76/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

70 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

71 
ùoib_mˇ°
 *
mˇ°
,

72 
boﬁ
 
dñay
)

74 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

81 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

82 i‡(
mˇ°
 && 
dñay
) {

86 
mˇ°
->
backoff
 *= 2;

87 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

88 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

89 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

97 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

98 } i‡(
dñay
) {

104 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

106 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

107 
	}
}

109 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

111 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

112 
tx_dr›≥d
 = 0;

114 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

115 
mˇ°
->
mcmembî
.
mgid
.
øw
);

118 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

120 i‡(
mˇ°
->
ah
)

121 
	`ùoib_put_ah
(
mˇ°
->
ah
);

123 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

124 ++
tx_dr›≥d
;

125 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

128 
	`√tif_tx_lock_bh
(
dev
);

129 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

130 
	`√tif_tx_u∆ock_bh
(
dev
);

132 
	`k‰ì
(
mˇ°
);

133 
	}
}

135 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

136 
ˇn_¶ìp
)

138 
ùoib_mˇ°
 *
mˇ°
;

140 
mˇ°
 = 
	`kzÆloc
( *mˇ°, 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

141 i‡(!
mˇ°
)

142  
NULL
;

144 
mˇ°
->
dev
 = dev;

145 
mˇ°
->
¸óãd
 = 
jiffõs
;

146 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

147 
mˇ°
->
backoff
 = 1;

149 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

150 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

151 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

153  
mˇ°
;

154 
	}
}

156 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

158 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

159 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

161 
n
) {

162 
ùoib_mˇ°
 *
mˇ°
;

163 
ªt
;

165 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

167 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

168  (
ib_gid
));

169 i‡(
ªt
 < 0)

170 
n
 =Ç->
rb_À·
;

171 i‡(
ªt
 > 0)

172 
n
 =Ç->
rb_right
;

174  
mˇ°
;

177  
NULL
;

178 
	}
}

180 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

183 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

185 *
n
) {

186 
ùoib_mˇ°
 *
tmˇ°
;

187 
ªt
;

189 
≤
 = *
n
;

190 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

192 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

193  (
ib_gid
));

194 i‡(
ªt
 < 0)

195 
n
 = &
≤
->
rb_À·
;

196 i‡(
ªt
 > 0)

197 
n
 = &
≤
->
rb_right
;

199  -
EEXIST
;

202 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

203 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

206 
	}
}

208 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

209 
ib_ß_mcmembî_ªc
 *
mcmembî
)

211 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

212 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

213 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

214 
ùoib_ah
 *
ah
;

215 
rdma_ah_©å
 
av
;

216 
ªt
;

217 
£t_qkey
 = 0;

219 
mˇ°
->
mcmembî
 = *mcmember;

224 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

225  (
ib_gid
))) {

226 
	`•ö_lock_úq
(&
¥iv
->
lock
);

227 i‡(!
¥iv
->
brﬂdˇ°
) {

228 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

229  -
EAGAIN
;

232 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

233 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

234 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

240 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

241 
∫
->
mtu
 =

242 
¥iv
->
admö_mtu
 =

243 
¥iv
->
mˇ°_mtu
 =

244 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

245 
¥iv
->
p‹t
,

246 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

248 
∫
->
mtu
 =

249 
¥iv
->
mˇ°_mtu
 =

250 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

251 
¥iv
->
p‹t
,

252 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

254 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

255 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

256 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

257 
£t_qkey
 = 1;

260 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

261 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

262 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

263 
mˇ°
->
mcmembî
.
mgid
.
øw
);

268 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

269 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

270 
£t_qkey
, 
¥iv
->
qkey
);

271 i‡(
ªt
 < 0) {

272 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

273 
mˇ°
->
mcmembî
.
mgid
.
øw
);

275 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

276  
ªt
;

280 
	`mem£t
(&
av
, 0, (av));

281 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

282 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

283 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

284 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

285 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

287 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

288 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

289 0, 
mˇ°
->
mcmembî
.
h›_limô
,

290 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

292 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

293 i‡(
	`IS_ERR
(
ah
)) {

294 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

295 -
	`PTR_ERR
(
ah
));

297  
	`PTR_ERR
(
ah
);

299 
	`•ö_lock_úq
(&
¥iv
->
lock
);

300 
mˇ°
->
ah
 =áh;

301 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

303 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

304 
mˇ°
->
mcmembî
.
mgid
.
øw
,

305 
mˇ°
->
ah
->ah,

306 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

307 
mˇ°
->
mcmembî
.
¶
);

310 
	`√tif_tx_lock_bh
(
dev
);

311 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

312 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

314 
	`√tif_tx_u∆ock_bh
(
dev
);

316 
skb
->
dev
 = dev;

318 
ªt
 = 
	`dev_queue_xmô
(
skb
);

319 i‡(
ªt
)

320 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

321 
__func__
, 
ªt
);

322 
	`√tif_tx_lock_bh
(
dev
);

324 
	`√tif_tx_u∆ock_bh
(
dev
);

327 
	}
}

329 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

331 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

332 
ˇºõr_⁄_èsk
);

333 
ib_p‹t_©å
 
©å
;

335 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

336 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

337 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

346 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

347 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

348 
¥iv
->
ˇ
,Öriv->
p‹t
);

358 !
	`π∆_åylock
()) {

359 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

362 
	`m¶ìp
(20);

364 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

365 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

366 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

367 
	`π∆_u∆ock
();

368 
	}
}

370 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

371 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

373 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

374 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

375 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

377 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

378 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

380 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

383 i‡(
°©us
 =-
ENETRESET
) {

384 
°©us
 = 0;

385 
out
;

388 i‡(!
°©us
)

389 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

391 i‡(!
°©us
) {

392 
mˇ°
->
backoff
 = 1;

393 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

402 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

403 
	`•ö_lock_úq
(&
¥iv
->
lock
);

404 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

405 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

406 
out_locked
;

409 
boﬁ
 
sûít_Áû
 =

410 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

411 
°©us
 =-
EINVAL
;

413 i‡(
mˇ°
->
logcou¡
 < 20) {

414 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

415 
sûít_Áû
) {

416 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

417 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

418 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

420 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

421 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

422 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

425 i‡(!
sûít_Áû
)

426 
mˇ°
->
logcou¡
++;

429 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

430 
mˇ°
->
backoff
 >= 2) {

440 
mˇ°
->
backoff
 = 1;

441 
	`√tif_tx_lock_bh
(
dev
);

442 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

443 ++
dev
->
°©s
.
tx_dr›≥d
;

444 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

446 
	`√tif_tx_u∆ock_bh
(
dev
);

448 
	`•ö_lock_úq
(&
¥iv
->
lock
);

450 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

451 
out_locked
;

454 
out
:

455 
	`•ö_lock_úq
(&
¥iv
->
lock
);

456 
out_locked
:

461 i‡(
°©us
)

462 
mˇ°
->
mc
 = 
NULL
;

464 
mˇ°
->
mc
 = 
mu…iˇ°
;

465 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

466 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

467 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

469  
°©us
;

470 
	}
}

475 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

477 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

478 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

479 
ib_ß_mcmembî_ªc
 
ªc
 = {

480 .
joö_°©e
 = 1

482 
ib_ß_comp_mask
 
comp_mask
;

483 
ªt
 = 0;

485 i‡(!
¥iv
->
brﬂdˇ°
 ||

486 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

487  -
EINVAL
;

489 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

490 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

492 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

494 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

495 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

496 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

498 
comp_mask
 =

499 
IB_SA_MCMEMBER_REC_MGID
 |

500 
IB_SA_MCMEMBER_REC_PORT_GID
 |

501 
IB_SA_MCMEMBER_REC_PKEY
 |

502 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

504 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

512 
comp_mask
 |=

513 
IB_SA_MCMEMBER_REC_QKEY
 |

514 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

515 
IB_SA_MCMEMBER_REC_MTU
 |

516 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

517 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_RATE
 |

519 
IB_SA_MCMEMBER_REC_SL
 |

520 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

521 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

523 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

524 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

525 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

526 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

527 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

529 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

530 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

531 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

544 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

545 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

547 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

549 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

551 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

552 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

553 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

554 
	`•ö_lock_úq
(&
¥iv
->
lock
);

555 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

556 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

557 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

559 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

560 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

561 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

562 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

563 
	`•ö_lock_úq
(&
¥iv
->
lock
);

566 
	}
}

568 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

570 
ùoib_dev_¥iv
 *
¥iv
 =

571 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

572 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

573 
ib_p‹t_©å
 
p‹t_©å
;

574 
dñay_u¡û
 = 0;

575 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

577 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

580 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

581 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

584 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

585 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

586 
p‹t_©å
.
°©e
);

589 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

590 
	`√tif_addr_lock_bh
(
dev
);

592 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

593 
	`√tif_addr_u∆ock_bh
(
dev
);

596 
	`√tif_addr_u∆ock_bh
(
dev
);

598 
	`•ö_lock_úq
(&
¥iv
->
lock
);

599 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

600 
out
;

602 i‡(!
¥iv
->
brﬂdˇ°
) {

603 
ùoib_mˇ°
 *
brﬂdˇ°
;

605 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

606 i‡(!
brﬂdˇ°
) {

607 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

614 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

615 
out
;

618 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

619  (
ib_gid
));

620 
¥iv
->
brﬂdˇ°
 = broadcast;

622 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

625 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

626 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

627 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

628 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

629 i‡(
mˇ°
->
backoff
 > 1 &&

630 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

631 
dñay_u¡û
 = 
mˇ°
->delay_until;

632 
mˇ°
 = 
NULL
;

635 
out
;

642 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

643 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

644 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

645 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

646 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

647 i‡(
mˇ°
->
backoff
 == 1 ||

648 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

650 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

651 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

654 } i‡(!
dñay_u¡û
 ||

655 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

656 
dñay_u¡û
 = 
mˇ°
->delay_until;

660 
mˇ°
 = 
NULL
;

661 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

663 
out
:

664 i‡(
dñay_u¡û
) {

665 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

666 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

667 
dñay_u¡û
 - 
jiffõs
);

669 i‡(
mˇ°
)

670 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

672 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

673 
	}
}

675 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

677 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

678 
Êags
;

680 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

682 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

683 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	}
}

687 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

691 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

693 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

696 
	}
}

698 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

700 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

701 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

702 
ªt
 = 0;

704 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

705 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

707 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

708 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

710 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

711 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

712 
mˇ°
->
mcmembî
.
mgid
.
øw
);

715 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

716 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

717 i‡(
ªt
)

718 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

719 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

720 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

724 
	}
}

730 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

731 
li°_hód
 *
ªmove_li°
)

734 i‡(*
mgid
 == 0xff) {

735 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

737 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

738 
	`li°_dñ
(&
mˇ°
->
li°
);

739 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

740 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

743 
	}
}

745 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

747 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

753 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

754 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

755 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

757 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

758 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

759 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

761 
	}
}

763 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

765 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

766 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

767 
ùoib_mˇ°
 *
mˇ°
;

768 
Êags
;

769 *
mgid
 = 
daddr
 + 4;

771 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

773 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

774 !
¥iv
->
brﬂdˇ°
 ||

775 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

776 ++
dev
->
°©s
.
tx_dr›≥d
;

777 
	`dev_k‰ì_skb_™y
(
skb
);

778 
u∆ock
;

781 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

782 i‡(!
mˇ°
 || !mˇ°->
ah
) {

783 i‡(!
mˇ°
) {

785 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

786 
mgid
);

788 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

789 i‡(!
mˇ°
) {

790 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

792 ++
dev
->
°©s
.
tx_dr›≥d
;

793 
	`dev_k‰ì_skb_™y
(
skb
);

794 
u∆ock
;

797 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

798 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

799  (
ib_gid
));

800 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

801 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

803 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

805 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

806 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

808 ++
dev
->
°©s
.
tx_dr›≥d
;

809 
	`dev_k‰ì_skb_™y
(
skb
);

811 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

812 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

815 
ùoib_√igh
 *
√igh
;

817 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

818 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

819 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

820 i‡(!
√igh
) {

821 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

825 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

826 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

827 
√igh
->
ah
 = 
mˇ°
->ah;

828 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

831 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

832 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

833 
IB_MULTICAST_QPN
);

834 i‡(
√igh
)

835 
	`ùoib_√igh_put
(
√igh
);

839 
u∆ock
:

840 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

841 
	}
}

843 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

846 
	`LIST_HEAD
(
ªmove_li°
);

847 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

848 
Êags
;

850 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

851 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

853 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

855 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

856 
	`li°_dñ
(&
mˇ°
->
li°
);

857 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

858 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

861 i‡(
¥iv
->
brﬂdˇ°
) {

862 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

863 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

864 
¥iv
->
brﬂdˇ°
 = 
NULL
;

867 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

869 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

870 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

871 
	}
}

873 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

876 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

879 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

882 
	}
}

884 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

886 
ùoib_dev_¥iv
 *
¥iv
 =

887 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

888 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

889 
√tdev_hw_addr
 *
ha
;

890 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

891 
	`LIST_HEAD
(
ªmove_li°
);

892 
Êags
;

893 
ib_ß_mcmembî_ªc
 
ªc
;

895 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

902 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

904 
	`loˇl_úq_ßve
(
Êags
);

905 
	`√tif_addr_lock
(
dev
);

906 
	`•ö_lock
(&
¥iv
->
lock
);

915 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

916 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

919 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

920 
ib_gid
 
mgid
;

922 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

925 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4,  mgid);

927 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

928 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

929 
ùoib_mˇ°
 *
nmˇ°
;

932 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

933 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

934 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

935 
mgid
.
øw
);

940 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

941 
mgid
.
øw
);

943 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

944 i‡(!
nmˇ°
) {

945 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

949 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

951 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

953 i‡(
mˇ°
) {

955 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

957 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

958 &
nmˇ°
->
rb_node
,

959 &
¥iv
->
mu…iˇ°_åì
);

961 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

963 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

966 i‡(
mˇ°
)

967 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

971 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

972 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

973 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

974 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

975 
mˇ°
->
mcmembî
.
mgid
.
øw
);

977 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

980 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

984 
	`•ö_u∆ock
(&
¥iv
->
lock
);

985 
	`√tif_addr_u∆ock
(
dev
);

986 
	`loˇl_úq_ª°‹e
(
Êags
);

988 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

993 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

994 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

995 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

996 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

998 
	}
}

1000 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1002 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1004 
ùoib_mˇ°_ôî
 *
ôî
;

1006 
ôî
 = 
	`kmÆloc
( *ôî, 
GFP_KERNEL
);

1007 i‡(!
ôî
)

1008  
NULL
;

1010 
ôî
->
dev
 = dev;

1011 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1013 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1014 
	`k‰ì
(
ôî
);

1015  
NULL
;

1018  
ôî
;

1019 
	}
}

1021 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1023 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1024 
rb_node
 *
n
;

1025 
ùoib_mˇ°
 *
mˇ°
;

1026 
ªt
 = 1;

1028 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1030 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1032 
n
) {

1033 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1035 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1036  (
ib_gid
)) < 0) {

1037 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1038 
ôî
->
¸óãd
 = 
mˇ°
->created;

1039 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1040 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1041 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1043 
ªt
 = 0;

1048 
n
 = 
	`rb_√xt
(n);

1051 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1053  
ªt
;

1054 
	}
}

1056 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1057 
ib_gid
 *
mgid
,

1058 *
¸óãd
,

1059 *
queuñí
,

1060 *
com∂ëe
,

1061 *
£nd_⁄ly
)

1063 *
mgid
 = 
ôî
->mgid;

1064 *
¸óãd
 = 
ôî
->created;

1065 *
queuñí
 = 
ôî
->queuelen;

1066 *
com∂ëe
 = 
ôî
->complete;

1067 *
£nd_⁄ly
 = 
ôî
->send_only;

1068 
	}
}

	@RHEL76/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
,

68 
∆©å
 *
tb
[], ∆©å *
d©a
[])

70 
u16
 
mode
, 
umˇ°
;

71 
ªt
 = 0;

73 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

74 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

75 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

76 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

77 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

78 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

80 
ªt
 = -
EINVAL
;

82 i‡(
ªt
 < 0)

83 
out_îr
;

86 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

87 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

88 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

91 
out_îr
:

92  
ªt
;

93 
	}
}

95 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

96 
∆©å
 *
tb
[], ∆©å *
d©a
[])

98 
√t_devi˚
 *
pdev
;

99 
ùoib_dev_¥iv
 *
µriv
;

100 
u16
 
chûd_pkey
;

101 
îr
;

103 i‡(!
tb
[
IFLA_LINK
])

104  -
EINVAL
;

106 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

107 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

108  -
ENODEV
;

110 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

112 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

113 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

114  -
EINVAL
;

117 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

118 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

119 
chûd_pkey
 = 
µriv
->
pkey
;

121 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

123 i‡(
chûd_pkey
 == 0 || child_pkey == 0x8000)

124  -
EINVAL
;

130 
chûd_pkey
 |= 0x8000;

132 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

133 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

135 i‡(!
îr
 && 
d©a
)

136 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
);

137  
îr
;

138 
	}
}

140 
	$ùoib_uƒegi°î_chûd_dev
(
√t_devi˚
 *
dev
, 
li°_hód
 *
hód
)

142 
ùoib_dev_¥iv
 *
¥iv
, *
µriv
;

144 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

145 
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

147 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

148 
	`uƒegi°î_√tdevi˚_queue
(
dev
, 
hód
);

149 
	`li°_dñ
(&
¥iv
->
li°
);

150 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

151 
	}
}

153 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

155  
	`∆a_tŸÆ_size
(2) +

156 
	`∆a_tŸÆ_size
(2) +

157 
	`∆a_tŸÆ_size
(2);

158 
	}
}

160 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

161 .
köd
 = "ipoib",

162 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

163 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

164 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

165 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

166 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

167 .
	gch™gñök
 = 
ùoib_ch™gñök
,

168 .
	gdñlök
 = 
ùoib_uƒegi°î_chûd_dev
,

169 .
	ggë_size
 = 
ùoib_gë_size
,

170 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

173 
__öô
 
	$ùoib_√éök_öô
()

175  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

176 
	}
}

178 
__exô
 
	$ùoib_√éök_föi
()

180 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

181 
	}
}

183 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL76/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
( *qp_©å, 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.
max_sge
,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
ENOSYS
)

172  -
ENODEV
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
ªc‹d
->
devi˚
->
«me
,Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@RHEL76/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

35 
	~<löux/öô.h
>

36 
	~<löux/£q_fûe.h
>

38 
	~<asm/uac˚ss.h
>

40 
	~"ùoib.h
"

42 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

43 *
buf
)

45 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

46 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

49 
	}
}

50 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

52 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

53 
u16
 
pkey
, 
ty≥
)

55 
ªsu…
;

56 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

58 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

60 
¥iv
->
dev
->
mtu
 = 
	`IPOIB_UD_MTU
’riv->
max_ib_mtu
);

61 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 =Öriv->
dev
->
mtu
;

62 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

63 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

64 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

66 
	`ùoib_£t_dev_„©uªs
(
¥iv
, 
µriv
->
ˇ
);

68 
¥iv
->
pkey
 =Ökey;

70 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

71 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

72 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

73 
¥iv
->
dev
->
brﬂdˇ°
[8] = 
pkey
 >> 8;

74 
¥iv
->
dev
->
brﬂdˇ°
[9] = 
pkey
 & 0xff;

76 
ªsu…
 = 
	`ùoib_dev_öô
(
¥iv
->
dev
, 
µriv
->
ˇ
,Ö¥iv->
p‹t
);

77 i‡(
ªsu…
 < 0) {

78 
	`ùoib_w¨n
(
µriv
, "failedÅo initialize subinterface: "

80 
µriv
->
ˇ
->
«me
,Ö¥iv->
p‹t
);

81 
îr
;

84 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
¥iv
->
dev
);

85 i‡(
ªsu…
) {

86 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

87 
ªgi°î_Áûed
;

91 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

92 i‡(
	`ùoib_cm_add_mode_©å
(
¥iv
->
dev
))

93 
sysfs_Áûed
;

94 i‡(
	`ùoib_add_pkey_©å
(
¥iv
->
dev
))

95 
sysfs_Áûed
;

96 i‡(
	`ùoib_add_umˇ°_©å
(
¥iv
->
dev
))

97 
sysfs_Áûed
;

99 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_∑ª¡
))

100 
sysfs_Áûed
;

103 
¥iv
->
chûd_ty≥
 = 
ty≥
;

104 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

108 
sysfs_Áûed
:

109 
ªsu…
 = -
ENOMEM
;

110 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

112 
ªgi°î_Áûed
:

113 
	`ùoib_dev_˛ónup
(
¥iv
->
dev
);

115 
îr
:

116  
ªsu…
;

117 
	}
}

119 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

121 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

122 
ötf_«me
[
IFNAMSIZ
];

123 
ùoib_dev_¥iv
 *
çriv
;

124 
ªsu…
;

126 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

127  -
EPERM
;

129 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

131 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
µriv
->
Êags
))

132  -
EPERM
;

134 
	`¢¥ötf
(
ötf_«me
,  intf_name, "%s.%04x",

135 
µriv
->
dev
->
«me
, 
pkey
);

137 i‡(!
	`muãx_åylock
(&
µriv
->
sysfs_muãx
))

138  
	`ª°¨t_sysˇŒ
();

140 i‡(!
	`π∆_åylock
()) {

141 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

142  
	`ª°¨t_sysˇŒ
();

145 i‡(!
	`down_wrôe_åylock
(&
µriv
->
vœn_rw£m
)) {

146 
	`π∆_u∆ock
();

147 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

148  
	`ª°¨t_sysˇŒ
();

151 
¥iv
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

152 i‡(!
¥iv
) {

153 
ªsu…
 = -
ENOMEM
;

154 
out
;

162 i‡(
µriv
->
pkey
 ==Ökey) {

163 
ªsu…
 = -
ENOTUNIQ
;

164 
out
;

167 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

168 i‡(
çriv
->
pkey
 ==Ökey &&

169 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

170 
ªsu…
 = -
ENOTUNIQ
;

171 
out
;

175 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

177 
out
:

178 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

179 
	`π∆_u∆ock
();

180 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

182 i‡(
ªsu…
 && 
¥iv
) {

183 
rdma_√tdev
 *
∫
;

185 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

186 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

187 
	`k‰ì
(
¥iv
);

190  
ªsu…
;

191 
	}
}

193 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

195 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

196 
√t_devi˚
 *
dev
 = 
NULL
;

198 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

199  -
EPERM
;

201 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

203 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
µriv
->
Êags
))

204  -
EPERM
;

206 i‡(!
	`muãx_åylock
(&
µriv
->
sysfs_muãx
))

207  
	`ª°¨t_sysˇŒ
();

209 i‡(!
	`π∆_åylock
()) {

210 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

211  
	`ª°¨t_sysˇŒ
();

214 i‡(!
	`down_wrôe_åylock
(&
µriv
->
vœn_rw£m
)) {

215 
	`π∆_u∆ock
();

216 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

217  
	`ª°¨t_sysˇŒ
();

220 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

221 i‡(
¥iv
->
pkey
 ==Ökey &&

222 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

223 
	`li°_dñ
(&
¥iv
->
li°
);

224 
dev
 = 
¥iv
->dev;

228 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

230 i‡(
dev
) {

231 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

232 
	`uƒegi°î_√tdevi˚
(
dev
);

235 
	`π∆_u∆ock
();

236 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

238 i‡(
dev
) {

239 
rdma_√tdev
 *
∫
;

241 
∫
 = 
	`√tdev_¥iv
(
dev
);

242 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

243 
	`k‰ì
(
¥iv
);

247  -
ENODEV
;

248 
	}
}

	@RHEL77/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

56 #unde‡
Æloc_√tdev_mqs


60 
	eùoib_Êush_Àvñ
 {

61 
	mIPOIB_FLUSH_LIGHT
,

62 
	mIPOIB_FLUSH_NORMAL
,

63 
	mIPOIB_FLUSH_HEAVY


67 
	mIPOIB_ENCAP_LEN
 = 4,

68 
	mIPOIB_PSEUDO_LEN
 = 20,

69 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

71 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

72 
	mIPOIB_UD_RX_SG
 = 2,

74 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

75 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

76 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

77 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

78 
	mIPOIB_RX_RING_SIZE
 = 256,

79 
	mIPOIB_TX_RING_SIZE
 = 128,

80 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

81 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

82 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

84 
	mIPOIB_NUM_WC
 = 4,

86 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

87 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

89 
	mIPOIB_FLAG_OPER_UP
 = 0,

90 
	mIPOIB_FLAG_INITIALIZED
 = 1,

91 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

92 
	mIPOIB_PKEY_ASSIGNED
 = 3,

93 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

94 
	mIPOIB_STOP_REAPER
 = 7,

95 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

96 
	mIPOIB_FLAG_UMCAST
 = 10,

97 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

98 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

99 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

101 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

103 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

104 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

112 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

113 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

115 
	mMAX_SEND_CQE
 = 64,

116 
	mIPOIB_CM_COPYBREAK
 = 256,

118 
	mIPOIB_NON_CHILD
 = 0,

119 
	mIPOIB_LEGACY_CHILD
 = 1,

120 
	mIPOIB_RTNL_CHILD
 = 2,

123 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

124 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


125 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

127 
	#IPOIB_OP_CM
 (0)

	)

130 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

134 
	sùoib_hódî
 {

135 
__be16
 
	m¥Ÿo
;

136 
u16
 
	mª£rved
;

139 
	sùoib_p£udo_hódî
 {

140 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

143 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

145 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

151 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

152 
	`skb_ª£t_mac_hódî
(
skb
);

153 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

154 
	}
}

156 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

158 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

160  
∫
->
˛¡_¥iv
;

161 
	}
}

164 
	sùoib_mˇ°
 {

165 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

166 
ib_ß_mu…iˇ°
 *
	mmc
;

167 
ùoib_ah
 *
	mah
;

169 
rb_node
 
	mrb_node
;

170 
li°_hód
 
	mli°
;

172 
	m¸óãd
;

173 
	mbackoff
;

174 
	mdñay_u¡û
;

176 
	mÊags
;

177 
	mlogcou¡
;

179 
li°_hód
 
	m√igh_li°
;

181 
sk_buff_hód
 
	mpkt_queue
;

183 
√t_devi˚
 *
	mdev
;

184 
com∂ëi⁄
 
	md⁄e
;

187 
	sùoib_rx_buf
 {

188 
sk_buff
 *
	mskb
;

189 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

192 
	sùoib_tx_buf
 {

193 
sk_buff
 *
	mskb
;

194 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

197 
	gib_cm_id
;

199 
	sùoib_cm_d©a
 {

200 
__be32
 
	mq≤
;

201 
__be32
 
	mmtu
;

231 
	eùoib_cm_°©e
 {

232 
	mIPOIB_CM_RX_LIVE
,

233 
	mIPOIB_CM_RX_ERROR
,

234 
	mIPOIB_CM_RX_FLUSH


237 
	sùoib_cm_rx
 {

238 
ib_cm_id
 *
	mid
;

239 
ib_qp
 *
	mqp
;

240 
ùoib_cm_rx_buf
 *
	mrx_rög
;

241 
li°_hód
 
	mli°
;

242 
√t_devi˚
 *
	mdev
;

243 
	mjiffõs
;

244 
ùoib_cm_°©e
 
	m°©e
;

245 
	mªcv_cou¡
;

248 
	sùoib_cm_tx
 {

249 
ib_cm_id
 *
	mid
;

250 
ib_qp
 *
	mqp
;

251 
li°_hód
 
	mli°
;

252 
√t_devi˚
 *
	mdev
;

253 
ùoib_√igh
 *
	m√igh
;

254 
ùoib_tx_buf
 *
	mtx_rög
;

255 
	mtx_hód
;

256 
	mtx_èû
;

257 
	mÊags
;

258 
u32
 
	mmtu
;

259 
	mmax_£nd_sge
;

262 
	sùoib_cm_rx_buf
 {

263 
sk_buff
 *
	mskb
;

264 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

267 
	sùoib_cm_dev_¥iv
 {

268 
ib_§q
 *
	m§q
;

269 
ùoib_cm_rx_buf
 *
	m§q_rög
;

270 
ib_cm_id
 *
	mid
;

271 
li°_hód
 
	m∑ssive_ids
;

272 
li°_hód
 
	mrx_îr‹_li°
;

273 
li°_hód
 
	mrx_Êush_li°
;

274 
li°_hód
 
	mrx_døö_li°
;

275 
li°_hód
 
	mrx_ª≠_li°
;

276 
w‹k_°ru˘
 
	m°¨t_èsk
;

277 
w‹k_°ru˘
 
	mª≠_èsk
;

278 
w‹k_°ru˘
 
	mskb_èsk
;

279 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

280 
dñayed_w‹k
 
	m°Æe_èsk
;

281 
sk_buff_hód
 
	mskb_queue
;

282 
li°_hód
 
	m°¨t_li°
;

283 
li°_hód
 
	mª≠_li°
;

284 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

285 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

286 
ib_ªcv_wr
 
	mrx_wr
;

287 
	mn⁄§q_c⁄n_qp
;

288 
	mmax_cm_mtu
;

289 
	mnum_‰ags
;

292 
	sùoib_ëhtoﬁ_°
 {

293 
u16
 
	mcﬂÀs˚_u£cs
;

294 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

297 
	gùoib_√igh_èbÀ
;

299 
	sùoib_√igh_hash
 {

300 
ùoib_√igh_èbÀ
 *
	m¡bl
;

301 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

302 
rcu_hód
 
	mrcu
;

303 
u32
 
	mmask
;

304 
u32
 
	msize
;

307 
	sùoib_√igh_èbÀ
 {

308 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

309 
©omic_t
 
	míåõs
;

310 
com∂ëi⁄
 
	mÊushed
;

311 
com∂ëi⁄
 
	mdñëed
;

314 
	sùoib_qp_°©e_vÆid©e
 {

315 
w‹k_°ru˘
 
	mw‹k
;

316 
ùoib_dev_¥iv
 *
	m¥iv
;

324 
	sùoib_dev_¥iv
 {

325 
•ölock_t
 
	mlock
;

327 
√t_devi˚
 *
	mdev
;

328 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

330 
«pi_°ru˘
 
	m£nd_«pi
;

331 
«pi_°ru˘
 
	mªcv_«pi
;

333 
	mÊags
;

342 
rw_£m≠h‹e
 
	mvœn_rw£m
;

343 
muãx
 
	mmˇ°_muãx
;

345 
rb_roŸ
 
	m∑th_åì
;

346 
li°_hód
 
	m∑th_li°
;

348 
ùoib_√igh_èbÀ
 
	m¡bl
;

350 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

351 
li°_hód
 
	mmu…iˇ°_li°
;

352 
rb_roŸ
 
	mmu…iˇ°_åì
;

354 
w‹kqueue_°ru˘
 *
	mwq
;

355 
dñayed_w‹k
 
	mmˇ°_èsk
;

356 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

357 
w‹k_°ru˘
 
	mÊush_light
;

358 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

359 
w‹k_°ru˘
 
	mÊush_hóvy
;

360 
w‹k_°ru˘
 
	mª°¨t_èsk
;

361 
dñayed_w‹k
 
	mah_ª≠_èsk
;

362 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

363 
ib_devi˚
 *
	mˇ
;

364 
u8
 
	mp‹t
;

365 
u16
 
	mpkey
;

366 
u16
 
	mpkey_ödex
;

367 
ib_pd
 *
	mpd
;

368 
ib_cq
 *
	mªcv_cq
;

369 
ib_cq
 *
	m£nd_cq
;

370 
ib_qp
 *
	mqp
;

371 
u32
 
	mqkey
;

373 
ib_gid
 
	mloˇl_gid
;

374 
u32
 
	mloˇl_lid
;

376 
	madmö_mtu
;

377 
	mmˇ°_mtu
;

378 
	mmax_ib_mtu
;

380 
ùoib_rx_buf
 *
	mrx_rög
;

382 
ùoib_tx_buf
 *
	mtx_rög
;

383 
	mtx_hód
;

384 
	mtx_èû
;

385 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

386 
ib_ud_wr
 
	mtx_wr
;

387 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

389 
ib_ªcv_wr
 
	mrx_wr
;

390 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

392 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

394 
li°_hód
 
	mdód_ahs
;

396 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

398 
√t_devi˚
 *
	m∑ª¡
;

399 
li°_hód
 
	mchûd_ötfs
;

400 
li°_hód
 
	mli°
;

401 
	mchûd_ty≥
;

403 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


404 
ùoib_cm_dev_¥iv
 
	mcm
;

407 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


408 
li°_hód
 
	mfs_li°
;

409 
díåy
 *
	mmcg_díåy
;

410 
díåy
 *
	m∑th_díåy
;

412 
u64
 
	mhˇ_ˇps
;

413 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

414 
	mmax_£nd_sge
;

415 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

416 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

419 
	sùoib_ah
 {

420 
√t_devi˚
 *
	mdev
;

421 
ib_ah
 *
	mah
;

422 
li°_hód
 
	mli°
;

423 
kªf
 
	mªf
;

424 
	mœ°_£nd
;

425 
	mvÆid
;

428 
	sùoib_∑th
 {

429 
√t_devi˚
 *
	mdev
;

430 
ß_∑th_ªc
 
	m∑thªc
;

431 
ùoib_ah
 *
	mah
;

432 
sk_buff_hód
 
	mqueue
;

434 
li°_hód
 
	m√igh_li°
;

436 
	mquîy_id
;

437 
ib_ß_quîy
 *
	mquîy
;

438 
com∂ëi⁄
 
	md⁄e
;

440 
rb_node
 
	mrb_node
;

441 
li°_hód
 
	mli°
;

444 
	sùoib_√igh
 {

445 
ùoib_ah
 *
	mah
;

446 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


447 
ùoib_cm_tx
 *
	mcm
;

449 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

450 
sk_buff_hód
 
	mqueue
;

452 
√t_devi˚
 *
	mdev
;

454 
li°_hód
 
	mli°
;

455 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

456 
rcu_hód
 
	mrcu
;

457 
©omic_t
 
	mªf˙t
;

458 
	mÆive
;

461 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

462 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

464 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

465 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

467 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

468 
	`ùoib_√igh_dt‹
(
√igh
);

469 
	}
}

470 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

471 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

472 
√t_devi˚
 *
dev
);

473 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

474 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

476 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

480 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

481 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

482 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

485 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

486 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

487 
ùoib_‰ì_ah
(
kªf
 *kref);

488 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

490 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

491 
	}
}

492 
ùoib_›í
(
√t_devi˚
 *
dev
);

493 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

494 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

497 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

498 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

499 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

501 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

502 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

503 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

504 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

505 c⁄° *
f‹m©
);

506 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

507 
√t_devi˚
 *
dev
);

508 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

509 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

512 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

513 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

519 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

520 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

521 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

523 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

524 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

525 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

527 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

528 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

531 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

532 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

534 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

535 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

536 
ùoib_tx_buf
 *
tx_ªq
);

538 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

540 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

541 
ùoib_tx_buf
 *
tx_ªq
)

543 
i
, 
off
;

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

545 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

546 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

547 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

549 i‡(
	`skb_hódÀn
(
skb
)) {

550 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

551 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

552 
off
 = 1;

554 
off
 = 0;

556 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

557 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

558 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

560 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

561 
	}
}

563 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


564 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

565 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

566 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

567 
ib_gid
 *
gid
,

568 *
¸óãd
,

569 *
queuñí
,

570 *
com∂ëe
,

571 *
£nd_⁄ly
);

573 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

574 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

575 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

576 
ùoib_∑th
 *
∑th
);

579 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

581 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

582 
ib_gid
 *
mgid
, 
u16
 
mlid
);

583 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

584 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

585 
li°_hód
 *
ªmove_li°
);

587 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

588 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

589 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

591 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

592 
ib_evít
 *
ªc‹d
);

594 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

597 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

598 
u16
 
pkey
, 
chûd_ty≥
);

600 
__öô
 
ùoib_√éök_öô
();

601 
__exô
 
ùoib_√éök_föi
();

603 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

604 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

606 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

608 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

609 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

611 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

613 
	#IPOIB_FLAGS_RC
 0x80

	)

614 
	#IPOIB_FLAGS_UC
 0x40

	)

617 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

619 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


621 
ùoib_max_c⁄n_qp
;

623 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

625 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

626  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

627 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

628 
	}
}

630 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

632 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

633  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

634 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

635 
	}
}

637 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

640  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

641 
	}
}

643 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

645  
√igh
->
cm
;

646 
	}
}

648 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

650 
√igh
->
cm
 = 
tx
;

651 
	}
}

653 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

655 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

656  !!
¥iv
->
cm
.
§q
;

657 
	}
}

659 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

661 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

662  
¥iv
->
cm
.
max_cm_mtu
;

663 
	}
}

665 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

666 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

670 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

671 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

672 
ùoib_√igh
 *
√igh
);

673 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

674 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

675 
mtu
);

676 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

677 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

680 
	gùoib_cm_tx
;

682 
	#ùoib_max_c⁄n_qp
 0

	)

684 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

687 
	}
}

688 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

692 
	}
}

694 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

698 
	}
}

700 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

702  
NULL
;

703 
	}
}

705 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

707 
	}
}

709 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

712 
	}
}

714 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

717 
	}
}

719 
ölöe


720 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

723 
	}
}

725 
ölöe


726 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

729 
	}
}

731 
ölöe


732 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

735 
	}
}

737 
ölöe


738 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

740  -
EOPNOTSUPP
;

741 
	}
}

743 
ölöe


744 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

747 
	}
}

749 
ölöe


750 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

751 
ùoib_√igh
 *
√igh
)

753  
NULL
;

754 
	}
}

756 
ölöe


757 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

760 
	}
}

762 
ölöe


763 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

766 
	}
}

768 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

769 
mtu
)

771 
	`dev_k‰ì_skb_™y
(
skb
);

772 
	}
}

774 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

776 
	}
}

778 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

780 
	}
}

783 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


784 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

785 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

786 
ùoib_ªgi°î_debugfs
();

787 
ùoib_uƒegi°î_debugfs
();

789 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

790 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

791 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

792 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

795 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

796 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

797 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

799 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

800 10 * 
HZ
 , \

802 i‡(
	`__øãlimô
(&
_rs
)) \

803 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

804 } 0)

	)

806 
ùoib_£ndq_size
;

807 
ùoib_ªcvq_size
;

809 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

811 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


812 
ùoib_debug_Àvñ
;

814 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

816 i‡(
ùoib_debug_Àvñ
 > 0) \

817 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

818 } 0)

	)

819 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

821 i‡(
mˇ°_debug_Àvñ
 > 0) \

822 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

823 } 0)

	)

825 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

827 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

828 dÿ{ (Ë(
¥iv
); } 0)

	)

831 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


832 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

834 i‡(
d©a_debug_Àvñ
 > 0) \

835 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

836 } 0)

	)

838 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

839 dÿ{ (Ë(
¥iv
); } 0)

	)

842 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

844 c⁄° 
ùoib_drivî_vîsi⁄
[];

846 
hfi1_max_mtu
;

847 
uöt
 
ùoib_ac˚l
;

	@RHEL77/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched.h
>

43 
	~"ùoib.h
"

45 
	gùoib_max_c⁄n_qp
 = 128;

47 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

48 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

52 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


53 
	gd©a_debug_Àvñ
;

55 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

56 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

60 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

62 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

63 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

67 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

69 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

70 .
qp_°©e
 = 
IB_QPS_ERR


73 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

75 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

76 .
›code
 = 
IB_WR_SEND
,

79 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

80 c⁄° 
ib_cm_evít
 *
evít
);

82 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

83 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

85 
i
;

87 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

89 
i
 = 0; i < 
‰ags
; ++i)

90 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

91 
	}
}

93 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

95 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

96 
i
, 
ªt
;

98 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

100 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

101 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

103 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

104 i‡(
	`u∆ikñy
(
ªt
)) {

105 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

106 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

107 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

108 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

109 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

112  
ªt
;

113 
	}
}

115 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

116 
ùoib_cm_rx
 *
rx
,

117 
ib_ªcv_wr
 *
wr
,

118 
ib_sge
 *
sge
, 
id
)

120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

121 
i
, 
ªt
;

123 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

125 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

126 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

128 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

129 i‡(
	`u∆ikñy
(
ªt
)) {

130 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

131 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

132 
rx
->
rx_rög
[
id
].
m≠pög
);

133 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

134 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

137  
ªt
;

138 
	}
}

140 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

141 
ùoib_cm_rx_buf
 *
rx_rög
,

142 
id
, 
‰ags
,

143 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

144 
gÂ_t
 
gÂ
)

146 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

147 
sk_buff
 *
skb
;

148 
i
;

150 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

151 i‡(
	`u∆ikñy
(!
skb
))

152  
NULL
;

158 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

160 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

161 
DMA_FROM_DEVICE
);

162 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

163 
	`dev_k‰ì_skb_™y
(
skb
);

164  
NULL
;

167 
i
 = 0; i < 
‰ags
; i++) {

168 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

170 i‡(!
∑ge
)

171 
∑πül_îr‹
;

172 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

174 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

175 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

176 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

177 
∑πül_îr‹
;

180 
rx_rög
[
id
].
skb
 = skb;

181  
skb
;

183 
∑πül_îr‹
:

185 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

187 ; 
i
 > 0; --i)

188 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

190 
	`dev_k‰ì_skb_™y
(
skb
);

191  
NULL
;

192 
	}
}

194 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

195 
ùoib_cm_rx_buf
 *
rx_rög
)

197 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

198 
i
;

200 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

201 i‡(
rx_rög
[
i
].
skb
) {

202 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

203 
rx_rög
[
i
].
m≠pög
);

204 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

207 
	`v‰ì
(
rx_rög
);

208 
	}
}

210 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

212 
ùoib_cm_rx
 *
p
;

216 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

217 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

224 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

225 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

226 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

227 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

229 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

230 
	}
}

232 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

234 
ùoib_cm_rx
 *
p
 = 
˘x
;

235 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

236 
Êags
;

238 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

241 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

242 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

243 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

244 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

245 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

246 
	}
}

248 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

249 
ùoib_cm_rx
 *
p
)

251 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

252 
ib_qp_öô_©å
 
©å
 = {

253 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

254 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

255 .
ªcv_cq
 = 
¥iv
->recv_cq,

256 .
§q
 = 
¥iv
->
cm
.srq,

257 .
ˇp
.
max_£nd_wr
 = 1,

258 .
ˇp
.
max_£nd_sge
 = 1,

259 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

260 .
qp_ty≥
 = 
IB_QPT_RC
,

261 .
qp_c⁄ãxt
 = 
p
,

264 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

265 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

266 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

269  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

270 
	}
}

272 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

273 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

274 
p¢
)

276 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

277 
ib_qp_©å
 
qp_©å
;

278 
qp_©å_mask
, 
ªt
;

280 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

281 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

282 i‡(
ªt
) {

283 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

284  
ªt
;

286 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

287 i‡(
ªt
) {

288 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

289  
ªt
;

291 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

292 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

293 i‡(
ªt
) {

294 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

295  
ªt
;

297 
qp_©å
.
rq_p¢
 = 
p¢
;

298 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

299 i‡(
ªt
) {

300 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

301  
ªt
;

312 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

313 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

314 i‡(
ªt
) {

315 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

318 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

319 i‡(
ªt
) {

320 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

325 
	}
}

327 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

328 
ib_ªcv_wr
 *
wr
,

329 
ib_sge
 *
sge
)

331 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

332 
i
;

334 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

335 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

337 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

338 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

339 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

341 
wr
->
√xt
 = 
NULL
;

342 
wr
->
sg_li°
 = 
sge
;

343 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

344 
	}
}

346 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

347 
ùoib_cm_rx
 *
rx
)

349 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

351 
ib_ªcv_wr
 
wr
;

352 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

353 } *
t
;

354 
ªt
;

355 
i
;

357 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

358 (*
rx
->
rx_rög
)));

359 i‡(!
rx
->
rx_rög
)

360  -
ENOMEM
;

362 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

363 i‡(!
t
) {

364 
ªt
 = -
ENOMEM
;

365 
îr_‰ì_1
;

368 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

370 
	`•ö_lock_úq
(&
¥iv
->
lock
);

372 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

373 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

374 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

375 
ªt
 = -
EINVAL
;

376 
îr_‰ì
;

378 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

380 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

382 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

383 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

384 
rx
->
rx_rög
[
i
].
m≠pög
,

385 
GFP_KERNEL
)) {

386 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

387 
ªt
 = -
ENOMEM
;

388 
îr_cou¡
;

390 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

391 i‡(
ªt
) {

392 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

393 "Áûed f‹ bu‡%d\n", 
i
);

394 
ªt
 = -
EIO
;

395 
îr_cou¡
;

399 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

401 
	`k‰ì
(
t
);

405 
îr_cou¡
:

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

408 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

410 
îr_‰ì
:

411 
	`k‰ì
(
t
);

413 
îr_‰ì_1
:

414 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

416  
ªt
;

417 
	}
}

419 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

420 
ib_qp
 *
qp
,

421 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

422 
p¢
)

424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

425 
ùoib_cm_d©a
 
d©a
 = {};

426 
ib_cm_ªp_∑øm
 
ªp
 = {};

428 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

429 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

431 
ªp
.
¥iv©e_d©a
 = &
d©a
;

432 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

433 
ªp
.
Êow_c⁄åﬁ
 = 0;

434 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

435 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

436 
ªp
.
qp_num
 = 
qp
->qp_num;

437 
ªp
.
°¨tög_p¢
 = 
p¢
;

438  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

439 
	}
}

441 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

442 c⁄° 
ib_cm_evít
 *
evít
)

444 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

445 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

446 
ùoib_cm_rx
 *
p
;

447 
p¢
;

448 
ªt
;

450 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

451 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

452 i‡(!
p
)

453  -
ENOMEM
;

454 
p
->
dev
 = dev;

455 
p
->
id
 = 
cm_id
;

456 
cm_id
->
c⁄ãxt
 = 
p
;

457 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

458 
p
->
jiffõs
 = jiffies;

459 
	`INIT_LIST_HEAD
(&
p
->
li°
);

461 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

462 i‡(
	`IS_ERR
(
p
->
qp
)) {

463 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

464 
îr_qp
;

467 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

468 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

469 i‡(
ªt
)

470 
îr_modify
;

472 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

473 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

474 i‡(
ªt
)

475 
îr_modify
;

478 
	`•ö_lock_úq
(&
¥iv
->
lock
);

479 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

480 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

483 
p
->
jiffõs
 = jiffies;

484 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

485 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

486 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

488 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

489 i‡(
ªt
) {

490 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

491 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

492 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

496 
îr_modify
:

497 
	`ib_de°roy_qp
(
p
->
qp
);

498 
îr_qp
:

499 
	`k‰ì
(
p
);

500  
ªt
;

501 
	}
}

503 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

504 c⁄° 
ib_cm_evít
 *
evít
)

506 
ùoib_cm_rx
 *
p
;

507 
ùoib_dev_¥iv
 *
¥iv
;

509 
evít
->event) {

510 
IB_CM_REQ_RECEIVED
:

511  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

512 
IB_CM_DREQ_RECEIVED
:

513 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

515 
IB_CM_REJ_RECEIVED
:

516 
p
 = 
cm_id
->
c⁄ãxt
;

517 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

518 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

519 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

524 
	}
}

526 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

527 
Àngth
, 
sk_buff
 *
toskb
)

529 
i
, 
num_‰ags
;

530 
size
;

533 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

534 
skb
->
èû
 +
size
;

535 
skb
->
Àn
 +
size
;

536 
Àngth
 -
size
;

538 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

539 
i
 = 0; i < 
num_‰ags
; i++) {

540 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

542 i‡(
Àngth
 == 0) {

544 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

545 0, 
PAGE_SIZE
);

546 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

548 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

550 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

551 
skb
->
d©a_Àn
 +
size
;

552 
skb
->
åuesize
 +
size
;

553 
skb
->
Àn
 +
size
;

554 
Àngth
 -
size
;

557 
	}
}

559 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

562 
ùoib_cm_rx_buf
 *
rx_rög
;

563 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

564 
sk_buff
 *
skb
, *
√wskb
;

565 
ùoib_cm_rx
 *
p
;

566 
Êags
;

567 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

568 
‰ags
;

569 
has_§q
;

570 
sk_buff
 *
smÆl_skb
;

572 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

573 
wr_id
, 
wc
->
°©us
);

575 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

576 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

577 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

578 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

579 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

580 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

581 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

583 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

584 
wr_id
, 
ùoib_ªcvq_size
);

588 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

590 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

591 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

593 
skb
 = 
rx_rög
[
wr_id
].skb;

595 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

596 
	`ùoib_dbg
(
¥iv
,

598 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

599 ++
dev
->
°©s
.
rx_dr›≥d
;

600 i‡(
has_§q
)

601 
ªpo°
;

603 i‡(!--
p
->
ªcv_cou¡
) {

604 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

605 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

606 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

607 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

613 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

614 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

615 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

616 
p
->
jiffõs
 = jiffies;

619 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

620 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

621 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

625 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

626 
dÀn
 = 
wc
->
byã_Àn
;

628 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

629 i‡(
smÆl_skb
) {

630 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

631 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

632 
dÀn
, 
DMA_FROM_DEVICE
);

633 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

634 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

635 
dÀn
, 
DMA_FROM_DEVICE
);

636 
	`skb_put
(
smÆl_skb
, 
dÀn
);

637 
skb
 = 
smÆl_skb
;

638 
c›õd
;

642 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

643 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

644 
PAGE_SIZE
;

646 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

647 
m≠pög
, 
GFP_ATOMIC
);

648 i‡(
	`u∆ikñy
(!
√wskb
)) {

653 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

654 ++
dev
->
°©s
.
rx_dr›≥d
;

655 
ªpo°
;

658 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

659 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

661 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

662 
wc
->
byã_Àn
, wc->
¶id
);

664 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

666 
c›õd
:

667 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

668 
	`skb_add_p£udo_hdr
(
skb
);

670 ++
dev
->
°©s
.
rx_∑ckës
;

671 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

673 
skb
->
dev
 = dev;

675 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

676 
	`√tif_ª˚ive_skb
(
skb
);

678 
ªpo°
:

679 i‡(
has_§q
) {

680 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

681 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

682 "f‹ bu‡%d\n", 
wr_id
);

684 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

685 &
¥iv
->
cm
.
rx_wr
,

686 
¥iv
->
cm
.
rx_sge
,

687 
wr_id
))) {

688 --
p
->
ªcv_cou¡
;

689 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

690 "f‹ bu‡%d\n", 
wr_id
);

693 
	}
}

695 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

696 
ùoib_cm_tx
 *
tx
,

697 
wr_id
,

698 
ùoib_tx_buf
 *
tx_ªq
)

700 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

702 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

704  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

705 
	}
}

707 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

709 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

710 
ùoib_tx_buf
 *
tx_ªq
;

711 
rc
;

712 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

714 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

715 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

716 
skb
->
Àn
, 
tx
->
mtu
);

717 ++
dev
->
°©s
.
tx_dr›≥d
;

718 ++
dev
->
°©s
.
tx_îr‹s
;

719 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

722 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

723 i‡(
	`skb_löórize
(
skb
) < 0) {

724 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

725 ++
dev
->
°©s
.
tx_dr›≥d
;

726 ++
dev
->
°©s
.
tx_îr‹s
;

727 
	`dev_k‰ì_skb_™y
(
skb
);

731 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

732 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

733 ++
dev
->
°©s
.
tx_dr›≥d
;

734 ++
dev
->
°©s
.
tx_îr‹s
;

735 
	`dev_k‰ì_skb_™y
(
skb
);

739 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

740 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

749 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

750 
tx_ªq
->
skb
 = skb;

752 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

753 ++
dev
->
°©s
.
tx_îr‹s
;

754 
	`dev_k‰ì_skb_™y
(
skb
);

758 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

759 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

760 
tx
->
qp
->
qp_num
);

761 
	`√tif_°›_queue
(
dev
);

764 
	`skb_‹ph™
(
skb
);

765 
	`skb_d°_dr›
(
skb
);

767 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

768 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

769 
IB_CQ_REPORT_MISSED_EVENTS
);

770 i‡(
	`u∆ikñy
(
rc
 < 0))

771 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

772 i‡(
rc
)

773 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

776 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

777 i‡(
	`u∆ikñy
(
rc
)) {

778 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

779 ++
dev
->
°©s
.
tx_îr‹s
;

780 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

781 
	`dev_k‰ì_skb_™y
(
skb
);

783 i‡(
	`√tif_queue_°›≥d
(
dev
))

784 
	`√tif_wake_queue
(
dev
);

786 
	`√tif_å™s_upd©e
(
dev
);

787 ++
tx
->
tx_hód
;

788 ++
¥iv
->
tx_hód
;

790 
	}
}

792 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

794 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

795 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

796 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

797 
ùoib_tx_buf
 *
tx_ªq
;

798 
Êags
;

800 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

801 
wr_id
, 
wc
->
°©us
);

803 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

804 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

805 
wr_id
, 
ùoib_£ndq_size
);

809 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

811 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

814 ++
dev
->
°©s
.
tx_∑ckës
;

815 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

817 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

819 
	`√tif_tx_lock
(
dev
);

821 ++
tx
->
tx_èû
;

822 ++
¥iv
->
tx_èû
;

824 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

825 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

826 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

827 
	`√tif_wake_queue
(
dev
);

829 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

830 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

831 
ùoib_√igh
 *
√igh
;

836 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

837 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

838 
	`ùoib_dbg
(
¥iv
,

840 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

842 
	`ùoib_w¨n
(
¥iv
,

844 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

846 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

847 
√igh
 = 
tx
->neigh;

849 i‡(
√igh
) {

850 
√igh
->
cm
 = 
NULL
;

851 
	`ùoib_√igh_‰ì
(
√igh
);

853 
tx
->
√igh
 = 
NULL
;

856 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

857 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

858 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

861 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

863 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

866 
	`√tif_tx_u∆ock
(
dev
);

867 
	}
}

869 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

871 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

872 
ªt
;

874 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

877 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

878 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

879 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

880 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

881 
îr_cm
;

884 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

886 i‡(
ªt
) {

887 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

888 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

889 
îr_li°í
;

894 
îr_li°í
:

895 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

896 
îr_cm
:

897 
¥iv
->
cm
.
id
 = 
NULL
;

898  
ªt
;

899 
	}
}

901 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

903 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
ùoib_cm_rx
 *
rx
, *
n
;

905 
	`LIST_HEAD
(
li°
);

907 
	`•ö_lock_úq
(&
¥iv
->
lock
);

908 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

909 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

911 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

912 
	`ib_de°roy_cm_id
(
rx
->
id
);

913 
	`ib_de°roy_qp
(
rx
->
qp
);

914 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

915 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

916 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

918 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

920 
	`k‰ì
(
rx
);

922 
	}
}

924 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

926 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

927 
ùoib_cm_rx
 *
p
;

928 
begö
;

929 
ªt
;

931 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

934 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

935 
¥iv
->
cm
.
id
 = 
NULL
;

937 
	`•ö_lock_úq
(&
¥iv
->
lock
);

938 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

939 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

940 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

941 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

942 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

943 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

944 i‡(
ªt
)

945 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

946 
	`•ö_lock_úq
(&
¥iv
->
lock
);

950 
begö
 = 
jiffõs
;

952 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

955 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

956 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

961 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

962 &
¥iv
->
cm
.
rx_ª≠_li°
);

963 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

964 &
¥iv
->
cm
.
rx_ª≠_li°
);

965 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

966 &
¥iv
->
cm
.
rx_ª≠_li°
);

969 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

970 
	`u¶ìp_ønge
(1000, 2000);

971 
	`ùoib_døö_cq
(
dev
);

972 
	`•ö_lock_úq
(&
¥iv
->
lock
);

975 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

977 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

979 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

980 
	}
}

982 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

983 c⁄° 
ib_cm_evít
 *
evít
)

985 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

986 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

987 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

988 
sk_buff_hód
 
skqueue
;

989 
ib_qp_©å
 
qp_©å
;

990 
qp_©å_mask
, 
ªt
;

991 
sk_buff
 *
skb
;

993 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

995 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

996 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

997 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

998  -
EINVAL
;

1001 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1002 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1003 i‡(
ªt
) {

1004 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1005  
ªt
;

1008 
qp_©å
.
rq_p¢
 = 0 ;

1009 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1010 i‡(
ªt
) {

1011 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1012  
ªt
;

1015 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1016 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1017 i‡(
ªt
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1019  
ªt
;

1021 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1022 i‡(
ªt
) {

1023 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1024  
ªt
;

1027 
	`skb_queue_hód_öô
(&
skqueue
);

1029 
	`√tif_tx_lock_bh
(
p
->
dev
);

1030 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1032 i‡(
p
->
√igh
)

1033 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1034 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1035 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1036 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1038 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1039 
skb
->
dev
 = 
p
->dev;

1040 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1041 i‡(
ªt
)

1042 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1043 
__func__
, 
ªt
);

1046 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1047 i‡(
ªt
) {

1048 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1049  
ªt
;

1052 
	}
}

1054 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1056 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1057 
ib_qp_öô_©å
 
©å
 = {

1058 .
£nd_cq
 = 
¥iv
->send_cq,

1059 .
ªcv_cq
 = 
¥iv
->recv_cq,

1060 .
§q
 = 
¥iv
->
cm
.srq,

1061 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1062 .
ˇp
.
max_£nd_sge
 = 1,

1063 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1064 .
qp_ty≥
 = 
IB_QPT_RC
,

1065 .
qp_c⁄ãxt
 = 
tx
,

1066 .
¸óã_Êags
 = 0

1068 
ib_qp
 *
tx_qp
;

1070 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1071 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1072 
MAX_SKB_FRAGS
 + 1);

1074 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1075 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1076  
tx_qp
;

1077 
	}
}

1079 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1080 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1081 
u32
 
q≤
,

1082 
ß_∑th_ªc
 *
∑thªc
)

1084 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1085 
ùoib_cm_d©a
 
d©a
 = {};

1086 
ib_cm_ªq_∑øm
 
ªq
 = {};

1088 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1089 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1091 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1092 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1093 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1094 
ªq
.
qp_num
 = 
qp
->qp_num;

1095 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1096 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1097 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1098 
ªq
.
Êow_c⁄åﬁ
 = 0;

1100 
ªq
.
°¨tög_p¢
 = 0;

1106 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1107 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1108 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
ªåy_cou¡
 = 0;

1110 
ªq
.
∫r_ªåy_cou¡
 = 0;

1111 
ªq
.
max_cm_ªåõs
 = 15;

1112 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1113  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1114 
	}
}

1116 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1117 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1119 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1120 
ib_qp_©å
 
qp_©å
;

1121 
qp_©å_mask
, 
ªt
;

1122 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1123 i‡(
ªt
) {

1124 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1125  
ªt
;

1128 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1129 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1130 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1131 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1133 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1134 i‡(
ªt
) {

1135 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1136  
ªt
;

1139 
	}
}

1141 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1142 
ß_∑th_ªc
 *
∑thªc
)

1144 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1145 
noio_Êag
;

1146 
ªt
;

1148 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1149 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1150 i‡(!
p
->
tx_rög
) {

1151 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1152 
ªt
 = -
ENOMEM
;

1153 
îr_tx
;

1156 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1157 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1158 i‡(
	`IS_ERR
(
p
->
qp
)) {

1159 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1160 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1161 
îr_qp
;

1164 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1165 i‡(
	`IS_ERR
(
p
->
id
)) {

1166 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1167 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1168 
îr_id
;

1171 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1172 i‡(
ªt
) {

1173 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1174 
îr_modify_£nd
;

1177 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1178 i‡(
ªt
) {

1179 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1180 
îr_modify_£nd
;

1183 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1184 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1188 
îr_modify_£nd
:

1189 
	`ib_de°roy_cm_id
(
p
->
id
);

1190 
îr_id
:

1191 
p
->
id
 = 
NULL
;

1192 
	`ib_de°roy_qp
(
p
->
qp
);

1193 
îr_qp
:

1194 
p
->
qp
 = 
NULL
;

1195 
	`v‰ì
(
p
->
tx_rög
);

1196 
îr_tx
:

1197  
ªt
;

1198 
	}
}

1200 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1202 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1203 
ùoib_tx_buf
 *
tx_ªq
;

1204 
begö
;

1206 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1207 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1209 i‡(
p
->
id
)

1210 
	`ib_de°roy_cm_id
(
p
->
id
);

1212 i‡(
p
->
tx_rög
) {

1214 
begö
 = 
jiffõs
;

1215 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1216 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1217 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1218 
p
->
tx_hód
 -Ö->
tx_èû
);

1219 
timeout
;

1222 
	`u¶ìp_ønge
(1000, 2000);

1226 
timeout
:

1228 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1229 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1230 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1231 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1232 
	`√tif_tx_lock_bh
(
p
->
dev
);

1233 ++
p
->
tx_èû
;

1234 ++
¥iv
->
tx_èû
;

1235 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1236 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1237 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1238 
	`√tif_wake_queue
(
p
->
dev
);

1239 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1242 i‡(
p
->
qp
)

1243 
	`ib_de°roy_qp
(
p
->
qp
);

1245 
	`v‰ì
(
p
->
tx_rög
);

1246 
	`k‰ì
(
p
);

1247 
	}
}

1249 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1250 c⁄° 
ib_cm_evít
 *
evít
)

1252 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1254 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1255 
ùoib_√igh
 *
√igh
;

1256 
Êags
;

1257 
ªt
;

1259 
evít
->event) {

1260 
IB_CM_DREQ_RECEIVED
:

1261 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1262 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1264 
IB_CM_REP_RECEIVED
:

1265 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1266 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1267 i‡(
ªt
)

1268 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1269 
NULL
, 0, NULL, 0);

1271 
IB_CM_REQ_ERROR
:

1272 
IB_CM_REJ_RECEIVED
:

1273 
IB_CM_TIMEWAIT_EXIT
:

1274 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1275 
	`√tif_tx_lock_bh
(
dev
);

1276 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1277 
√igh
 = 
tx
->neigh;

1279 i‡(
√igh
) {

1280 
√igh
->
cm
 = 
NULL
;

1281 
	`ùoib_√igh_‰ì
(
√igh
);

1283 
tx
->
√igh
 = 
NULL
;

1286 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1287 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1288 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1291 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1292 
	`√tif_tx_u∆ock_bh
(
dev
);

1299 
	}
}

1301 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1302 
ùoib_√igh
 *
√igh
)

1304 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1305 
ùoib_cm_tx
 *
tx
;

1307 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1308 i‡(!
tx
)

1309  
NULL
;

1311 
√igh
->
cm
 = 
tx
;

1312 
tx
->
√igh
 =Çeigh;

1313 
tx
->
dev
 = dev;

1314 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1315 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1316 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1317  
tx
;

1318 
	}
}

1320 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1322 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1323 
Êags
;

1324 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1325 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1326 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1327 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1328 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1329 
tx
->
√igh
->
daddr
 + 4);

1330 
tx
->
√igh
 = 
NULL
;

1331 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1333 
	}
}

1335 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1337 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1339 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1340 
cm
.
°¨t_èsk
);

1341 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1342 
ùoib_√igh
 *
√igh
;

1343 
ùoib_cm_tx
 *
p
;

1344 
Êags
;

1345 
ùoib_∑th
 *
∑th
;

1346 
ªt
;

1348 
ß_∑th_ªc
 
∑thªc
;

1349 
u32
 
q≤
;

1351 
	`√tif_tx_lock_bh
(
dev
);

1352 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1354 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1355 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1356 
	`li°_dñ_öô
(&
p
->
li°
);

1357 
√igh
 = 
p
->neigh;

1359 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1364 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1365 i‡(!
∑th
) {

1366 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1367 
__func__
,

1368 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1369 
‰ì_√igh
;

1371 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1373 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1374 
	`√tif_tx_u∆ock_bh
(
dev
);

1376 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1378 
	`√tif_tx_lock_bh
(
dev
);

1379 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1381 i‡(
ªt
) {

1382 
‰ì_√igh
:

1383 
√igh
 = 
p
->neigh;

1384 i‡(
√igh
) {

1385 
√igh
->
cm
 = 
NULL
;

1386 
	`ùoib_√igh_‰ì
(
√igh
);

1388 
	`li°_dñ
(&
p
->
li°
);

1389 
	`k‰ì
(
p
);

1393 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1394 
	`√tif_tx_u∆ock_bh
(
dev
);

1395 
	}
}

1397 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1399 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1400 
cm
.
ª≠_èsk
);

1401 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1402 
ùoib_cm_tx
 *
p
;

1403 
Êags
;

1405 
	`√tif_tx_lock_bh
(
dev
);

1406 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1408 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1409 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1410 
	`li°_dñ_öô
(&
p
->
li°
);

1411 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1412 
	`√tif_tx_u∆ock_bh
(
dev
);

1413 
	`ùoib_cm_tx_de°roy
(
p
);

1414 
	`√tif_tx_lock_bh
(
dev
);

1415 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1418 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1419 
	`√tif_tx_u∆ock_bh
(
dev
);

1420 
	}
}

1422 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1425 
cm
.
skb_èsk
);

1426 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1427 
sk_buff
 *
skb
;

1428 
Êags
;

1429 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1431 
	`√tif_tx_lock_bh
(
dev
);

1432 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1434 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1435 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1436 
	`√tif_tx_u∆ock_bh
(
dev
);

1438 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1439 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1440 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1442 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1443 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1444 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1445 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1448 
	`dev_k‰ì_skb_™y
(
skb
);

1450 
	`√tif_tx_lock_bh
(
dev
);

1451 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1454 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1455 
	`√tif_tx_u∆ock_bh
(
dev
);

1456 
	}
}

1458 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1459 
mtu
)

1461 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1462 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1464 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1466 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1467 i‡(
e
)

1468 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1469 
	}
}

1471 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1473 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1474 
cm
.
rx_ª≠_èsk
)->
dev
);

1475 
	}
}

1477 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1479 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1480 
cm
.
°Æe_èsk
.
w‹k
);

1481 
ùoib_cm_rx
 *
p
;

1482 
ªt
;

1484 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1485 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1488 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1489 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1491 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1492 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1493 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1494 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1495 i‡(
ªt
)

1496 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1497 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1500 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1501 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1502 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1503 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1504 
	}
}

1506 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1507 *
buf
)

1509 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1510 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1512 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1513  
	`•rötf
(
buf
, "connected\n");

1515  
	`•rötf
(
buf
, "datagram\n");

1516 
	}
}

1518 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1519 c⁄° *
buf
, 
size_t
 
cou¡
)

1521 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1522 
ªt
;

1524 i‡(!
	`π∆_åylock
()) {

1525  
	`ª°¨t_sysˇŒ
();

1528 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1529 
	`π∆_u∆ock
();

1530  -
EPERM
;

1533 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1539 i‡(
ªt
 !-
EBUSY
)

1540 
	`π∆_u∆ock
();

1542  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1543 
	}
}

1545 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1547 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1549  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1550 
	}
}

1552 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1554 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1555 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1556 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1557 .
©å
 = {

1558 .
max_wr
 = 
ùoib_ªcvq_size
,

1559 .
max_sge
 = max_sge

1563 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1564 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1565 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1566 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1567 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1568 
¥iv
->
cm
.
§q
 = 
NULL
;

1572 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1573 (*
¥iv
->
cm
.
§q_rög
)));

1574 i‡(!
¥iv
->
cm
.
§q_rög
) {

1575 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1576 
¥iv
->
cm
.
§q
 = 
NULL
;

1580 
	}
}

1582 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1584 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1585 
max_§q_sge
, 
i
;

1587 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1594 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1598 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1600 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1602 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1604 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1605 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1606 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1607 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1608 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1609 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1610 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1612 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1613 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1616 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1618 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1619 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1620 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1621 
¥iv
->
cm
.
num_‰ags
 - 1,

1622 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1623 
GFP_KERNEL
)) {

1624 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1625 "ª˚ivêbuf„∏%d\n", 
i
);

1626 
	`ùoib_cm_dev_˛ónup
(
dev
);

1627  -
ENOMEM
;

1630 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1631 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1632 "Áûed f‹ bu‡%d\n", 
i
);

1633 
	`ùoib_cm_dev_˛ónup
(
dev
);

1634  -
EIO
;

1639 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1641 
	}
}

1643 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1645 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
ªt
;

1648 i‡(!
¥iv
->
cm
.
§q
)

1651 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1653 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1654 i‡(
ªt
)

1655 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1657 
¥iv
->
cm
.
§q
 = 
NULL
;

1658 i‡(!
¥iv
->
cm
.
§q_rög
)

1661 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1662 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1663 
	}
}

	@RHEL77/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

141 
ETH_SS_TEST
:

145 
	}
}

146 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

147 
s£t
)

149 
s£t
) {

150 
ETH_SS_STATS
:

151  
IPOIB_GLOBAL_STATS_LEN
;

152 
ETH_SS_TEST
:

156  -
EOPNOTSUPP
;

157 
	}
}

160 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

162 
•ìd
) {

163 
IB_SPEED_SDR
:

164  
SPEED_2500
;

165 
IB_SPEED_DDR
:

166  
SPEED_5000
;

167 
IB_SPEED_QDR
:

168 
IB_SPEED_FDR10
:

169  
SPEED_10000
;

170 
IB_SPEED_FDR
:

171  
SPEED_14000
;

172 
IB_SPEED_EDR
:

173  
SPEED_25000
;

176  
SPEED_UNKNOWN
;

177 
	}
}

179 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

180 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

183 
ib_p‹t_©å
 
©å
;

184 
ªt
, 
•ìd
, 
width
;

186 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

187 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

188 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

192 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

193 i‡(
ªt
 < 0)

194  -
EINVAL
;

196 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

197 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

199 i‡(
•ìd
 < 0 || 
width
 < 0)

200  -
EINVAL
;

206 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

207 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

209 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

211 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

212 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

215 
	}
}

217 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

218 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

219 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

220 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

221 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

222 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

223 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

224 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

227 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

229 
	`SET_ETHTOOL_OPS
(
dev
, &
ùoib_ëhtoﬁ_›s
);

230 
	}
}

	@RHEL77/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@RHEL77/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
Êags
;

674 
	`√tif_tx_lock_bh
(
dev
);

675 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

677 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

678 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

679 
	`li°_dñ
(&
ah
->
li°
);

680 
	`rdma_de°roy_ah
(
ah
->ah, 0);

681 
	`k‰ì
(
ah
);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	`√tif_tx_u∆ock_bh
(
dev
);

686 
	}
}

688 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

690 
ùoib_dev_¥iv
 *
¥iv
 =

691 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

692 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

694 
	`__ùoib_ª≠_ah
(
dev
);

696 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

697 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

698 
	`round_jiffõs_ªœtive
(
HZ
));

699 
	}
}

701 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

705 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

706 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

707 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

708 
	}
}

710 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

712 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

714 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

715 
	`ùoib_Êush_ah
(
dev
);

716 
	}
}

718 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

720 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

721 
≥ndög
 = 0;

722 
i
;

724 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

725 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

726 ++
≥ndög
;

728  
≥ndög
;

729 
	}
}

731 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

732 
ib_qp
 *
qp
,

733 
ib_qp_°©e
 
√w_°©e
)

735 
ib_qp_©å
 
qp_©å
;

736 
ib_qp_öô_©å
 
quîy_öô_©å
;

737 
ªt
;

739 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

740 i‡(
ªt
) {

741 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

745 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

746 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

748 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

749 
√w_°©e
, 
qp_©å
.
qp_°©e
);

750 
	}
}

752 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

754 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

757 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

758 
	}
}

760 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

764 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

765 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

766 
	}
}

768 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
ib_qp_©å
 
qp_©å
;

772 
begö
;

773 
ùoib_tx_buf
 *
tx_ªq
;

774 
i
;

776 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

777 
	`ùoib_«pi_dißbÀ
(
dev
);

779 
	`ùoib_cm_dev_°›
(
dev
);

785 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

786 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

787 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

790 
begö
 = 
jiffõs
;

792 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

793 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

794 
	`ùoib_w¨n
(
¥iv
,

796 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

797 
	`ªcvs_≥ndög
(
dev
));

803 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

804 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

805 (
ùoib_£ndq_size
 - 1)];

806 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

807 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

808 ++
¥iv
->
tx_èû
;

811 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

812 
ùoib_rx_buf
 *
rx_ªq
;

814 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

815 i‡(!
rx_ªq
->
skb
)

817 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

818 
¥iv
->
rx_rög
[
i
].
m≠pög
);

819 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

820 
rx_ªq
->
skb
 = 
NULL
;

823 
timeout
;

826 
	`ùoib_døö_cq
(
dev
);

828 
	`u¶ìp_ønge
(1000, 2000);

831 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

833 
timeout
:

834 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

835 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

836 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

838 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

841 
	}
}

843 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

847 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

849 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

850 
	`ùoib_Êush_ah
(
dev
);

853 
	}
}

855 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

858 
ªt
;

860 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

861 i‡(
ªt
) {

862 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

866 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

867 i‡(
ªt
) {

868 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

869 
out
;

872 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

873 i‡(
ªt
) {

874 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

875 
out
;

878 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

879 
	`ùoib_«pi_íabÀ
(
dev
);

882 
out
:

884 
	}
}

886 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

888 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

890 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

892 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

893 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

894 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

898 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

899 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

900 
	`round_jiffõs_ªœtive
(
HZ
));

902 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

903 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

904 
dev_°›
;

907 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

911 
dev_°›
:

912 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

913 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

914 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

915 
	`ùoib_ib_dev_°›
(
dev
);

917 
	}
}

919 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

921 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

922 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

924 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

925 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

926 &
¥iv
->
pkey_ödex
)) {

927 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

929 i‡(
∫
->
£t_id
)

930 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

931 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

933 
	}
}

935 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

939 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

941 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

942 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

946 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

948 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

949 
	}
}

951 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

953 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

955 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

957 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

958 
	`√tif_ˇºõr_off
(
dev
);

960 
	`ùoib_mˇ°_°›_thªad
(
dev
);

961 
	`ùoib_mˇ°_dev_Êush
(
dev
);

963 
	`ùoib_Êush_∑ths
(
dev
);

964 
	}
}

966 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

968 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

969 
i
, 
n
;

976 
	`loˇl_bh_dißbÀ
();

979 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

980 
i
 = 0; i < 
n
; ++i) {

986 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

987 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

989 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

991 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

993 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

998 } 
n
 =
IPOIB_NUM_WC
);

1000 
	`pﬁl_tx
(
¥iv
))

1003 
	`loˇl_bh_íabÀ
();

1004 
	}
}

1010 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1012 
ªsu…
;

1013 
u16
 
¥ev_pkey
;

1015 
¥ev_pkey
 = 
¥iv
->
pkey
;

1016 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1017 i‡(
ªsu…
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1019 
¥iv
->
p‹t
, 
ªsu…
);

1020  
ªsu…
;

1023 
¥iv
->
pkey
 |= 0x8000;

1025 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1026 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1027 
¥ev_pkey
, 
¥iv
->
pkey
);

1032 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1033 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1038 
	}
}

1042 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1044 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1046 
¥iv
->
pkey_ödex
 = 0;

1047 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1049 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1050 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1053 
	}
}

1059 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1061 
ib_gid
 
£¨ch_gid
;

1062 
ib_gid
 
gid0
;

1063 
ib_gid
 *
√tdev_gid
;

1064 
îr
;

1065 
u16
 
ödex
;

1066 
u8
 
p‹t
;

1067 
boﬁ
 
ªt
 = 
Ál£
;

1069 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1070 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1071  
Ál£
;

1073 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1078 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1079 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1084 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1086 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1088 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1090 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1091 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1095 
out
;

1122 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1123 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1124 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1125 i‡(
ödex
 == 0)

1126 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1127 &
¥iv
->
Êags
);

1129 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1130 
ªt
 = 
åue
;

1132 
ªt
 = 
Ál£
;

1135 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1136 
ªt
 = 
åue
;

1138 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1139 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1140 (
¥iv
->
loˇl_gid
));

1141 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1142 (
¥iv
->
loˇl_gid
));

1143 
ªt
 = 
åue
;

1148 
out
:

1149 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1151  
ªt
;

1152 
	}
}

1154 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1155 
ùoib_Êush_Àvñ
 
Àvñ
,

1156 
√°ög
)

1158 
ùoib_dev_¥iv
 *
˝riv
;

1159 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1160 
ªsu…
;

1162 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1168 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1169 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1171 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1173 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1174 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1176 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1177 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1178 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1182 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1184 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1185 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1186 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1188 
	`upd©e_chûd_pkey
(
¥iv
);

1189 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1190 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1191 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1195 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1199 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1200 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1201 i‡(
ªsu…
) {

1203 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1208 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1210 i‡(
ªsu…
) {

1211 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1217 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1218 
›î_up
;

1219 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1225 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1226 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1227 i‡(
›î_up
)

1228 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1229 
	`ùoib_Êush_ah
(
dev
);

1232 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1233 
	`ùoib_ib_dev_down
(
dev
);

1235 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1236 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1237 
	`ùoib_ib_dev_°›
(
dev
);

1239 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1242 i‡(
	`√tif_queue_°›≥d
(
dev
))

1243 
	`√tif_°¨t_queue
(
dev
);

1250 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1251 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1252 
	`ùoib_ib_dev_up
(
dev
);

1253 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1254 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1256 
	}
}

1258 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1260 
ùoib_dev_¥iv
 *
¥iv
 =

1261 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1263 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1264 
	}
}

1266 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1268 
ùoib_dev_¥iv
 *
¥iv
 =

1269 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1271 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1272 
	}
}

1274 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1276 
ùoib_dev_¥iv
 *
¥iv
 =

1277 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1279 
	`π∆_lock
();

1280 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1281 
	`π∆_u∆ock
();

1282 
	}
}

1284 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1286 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1288 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1293 
	`ùoib_Êush_∑ths
(
dev
);

1295 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1296 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1304 
	`ùoib_°›_ah
(
dev
);

1306 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1308 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1310 i‡(
¥iv
->
pd
) {

1311 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1312 
¥iv
->
pd
 = 
NULL
;

1314 
	}
}

	@RHEL77/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

65 
	gùoib_íh™˚d_íabÀd
 = 1;

67 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

68 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

69 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

70 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 
moduÀ_∑øm_«med
(
ùoib_íh™˚d
, 
ùoib_íh™˚d_íabÀd
, , 0444);

72 
MODULE_PARM_DESC
(
ùoib_íh™˚d
, "Enable IPoIBÉnhanced for capable devices (default = 1) (0-1)");

75 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


76 
	gùoib_debug_Àvñ
;

78 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

79 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

82 
	sùoib_∑th_ôî
 {

83 
√t_devi˚
 *
	mdev
;

84 
ùoib_∑th
 
	m∑th
;

87 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

93 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

95 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

97 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

98 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

99 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

100 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

101 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

102 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

103 *
˛õ¡_d©a
);

104 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

105 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

106 
cmd
);

108 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

109 .
«me
 = "ipoib",

110 .
	gadd
 = 
ùoib_add_⁄e
,

111 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

112 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

115 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


116 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

117 
evít
, *
±r
)

119 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

120 
√t_devi˚
 *
dev
 = 
ni
->dev;

122 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

123  
NOTIFY_DONE
;

125 
evít
) {

126 
NETDEV_REGISTER
:

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_CHANGENAME
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

131 
	`ùoib_¸óã_debug_fûes
(
dev
);

133 
NETDEV_UNREGISTER
:

134 
	`ùoib_dñëe_debug_fûes
(
dev
);

138  
NOTIFY_DONE
;

139 
	}
}

142 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

144 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

148 
	`√tif_ˇºõr_off
(
dev
);

150 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

152 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

154 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

155 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

157 
îr_dißbÀ
;

160 
	`ùoib_ib_dev_up
(
dev
);

162 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

163 
ùoib_dev_¥iv
 *
˝riv
;

166 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

167 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

168 
Êags
;

170 
Êags
 = 
˝riv
->
dev
->flags;

171 i‡(
Êags
 & 
IFF_UP
)

174 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

176 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

179 
	`√tif_°¨t_queue
(
dev
);

183 
îr_dißbÀ
:

184 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

186  -
EINVAL
;

187 
	}
}

189 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

191 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

193 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

195 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

197 
	`√tif_°›_queue
(
dev
);

199 
	`ùoib_ib_dev_down
(
dev
);

200 
	`ùoib_ib_dev_°›
(
dev
);

202 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

203 
ùoib_dev_¥iv
 *
˝riv
;

206 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

207 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

208 
Êags
;

210 
Êags
 = 
˝riv
->
dev
->flags;

211 i‡(!(
Êags
 & 
IFF_UP
))

214 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

216 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

220 
	}
}

222 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

224 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

226 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

227 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

229  
„©uªs
;

230 
	}
}

232 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

234 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

235 
ªt
 = 0;

238 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

239 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

240  -
EINVAL
;

242 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

243 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

244 
¥iv
->
mˇ°_mtu
);

246 
dev
->
mtu
 = 
√w_mtu
;

250 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

251 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

252  -
EINVAL
;

254 
¥iv
->
admö_mtu
 = 
√w_mtu
;

256 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

257 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

258 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

260 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

262 i‡(
	`gë_ndo_ext
(
¥iv
->
∫_›s
, 
ndo_ch™ge_mtu
)) {

263 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

265 
	`√tif_ˇºõr_off
(
dev
);

268 
ªt
 = 
	`gë_ndo_ext
(
¥iv
->
∫_›s
, 
ndo_ch™ge_mtu
)(
dev
, 
√w_mtu
);

270 i‡(
ˇºõr_°©us
)

271 
	`√tif_ˇºõr_⁄
(
dev
);

273 
dev
->
mtu
 = 
√w_mtu
;

276  
ªt
;

277 
	}
}

279 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

280 
π∆_lök_°©s64
 *
°©s
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

285 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

287 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

288 
	}
}

291 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

292 
√t_devi˚
 *
dev
)

294 
√t
 *√à
	`dev_√t
(
dev
);

295 
ö_devi˚
 *
ö_dev
;

296 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

297 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

298 
__be32
 
ªt_addr
;

300 
addr
->
ß_Ámûy
) {

301 
AF_INET
:

302 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

303 i‡(!
ö_dev
)

304  
Ál£
;

306 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
ö_dev
, 0,

307 
addr_ö
->
sö_addr
.
s_addr
,

308 
RT_SCOPE_HOST
);

309 
	`ö_dev_put
(
ö_dev
);

310 i‡(
ªt_addr
)

311  
åue
;

314 
AF_INET6
:

315 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

316 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

317  
åue
;

321  
Ál£
;

322 
	}
}

331 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

333 
√t_devi˚
 *
ma°î
;

335 
	`rcu_ªad_lock
();

336 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

337 i‡(
ma°î
)

338 
	`dev_hﬁd
(
ma°î
);

339 
	`rcu_ªad_u∆ock
();

341 i‡(
ma°î
)

342  
ma°î
;

344 
	`dev_hﬁd
(
dev
);

345  
dev
;

346 
	}
}

348 
	sùoib_wÆk_d©a
 {

349 c⁄° 
sockaddr
 *
	maddr
;

350 
√t_devi˚
 *
	mªsu…
;

353 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

355 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

356 
ªt
 = 0;

358 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

359 
	`dev_hﬁd
(
uµî
);

360 
d©a
->
ªsu…
 = 
uµî
;

361 
ªt
 = 1;

364  
ªt
;

365 
	}
}

376 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

377 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

379 
ùoib_wÆk_d©a
 
d©a
 = {

380 .
addr
 =áddr,

383 
	`rcu_ªad_lock
();

384 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

385 
	`dev_hﬁd
(
dev
);

386 
d©a
.
ªsu…
 = 
dev
;

387 
out
;

390 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

391 
out
:

392 
	`rcu_ªad_u∆ock
();

393  
d©a
.
ªsu…
;

394 
	}
}

401 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

402 c⁄° 
ib_gid
 *
gid
,

403 
u16
 
pkey_ödex
,

404 c⁄° 
sockaddr
 *
addr
,

405 
√°ög
,

406 
√t_devi˚
 **
found_√t_dev
)

408 
ùoib_dev_¥iv
 *
chûd_¥iv
;

409 
√t_devi˚
 *
√t_dev
 = 
NULL
;

410 
m©ches
 = 0;

412 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

413 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

414 i‡(!
addr
) {

415 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

419 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

421 i‡(
√t_dev
) {

422 i‡(!*
found_√t_dev
)

423 *
found_√t_dev
 = 
√t_dev
;

425 
	`dev_put
(
√t_dev
);

426 ++
m©ches
;

431 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

432 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

433 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

434 
pkey_ödex
, 
addr
,

435 
√°ög
 + 1,

436 
found_√t_dev
);

437 i‡(
m©ches
 > 1)

440 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

442  
m©ches
;

443 
	}
}

448 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

449 
u16
 
pkey_ödex
,

450 c⁄° 
ib_gid
 *
gid
,

451 c⁄° 
sockaddr
 *
addr
,

452 
√t_devi˚
 **
√t_dev
)

454 
ùoib_dev_¥iv
 *
¥iv
;

455 
m©ches
 = 0;

457 *
√t_dev
 = 
NULL
;

459 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

460 i‡(
¥iv
->
p‹t
 !=Öort)

463 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

464 
addr
, 0, 
√t_dev
);

465 i‡(
m©ches
 > 1)

469  
m©ches
;

470 
	}
}

472 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

473 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

474 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

475 *
˛õ¡_d©a
)

477 
√t_devi˚
 *
√t_dev
;

478 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

479 
u16
 
pkey_ödex
;

480 
m©ches
;

481 
ªt
;

483 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

484  
NULL
;

486 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

487 i‡(
ªt
)

488  
NULL
;

490 i‡(!
dev_li°
)

491  
NULL
;

494 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

495 
gid
, 
NULL
, &
√t_dev
);

497 
m©ches
) {

499  
NULL
;

501  
√t_dev
;

504 
	`dev_put
(
√t_dev
);

508 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

509 
gid
, 
addr
, &
√t_dev
);

510 
m©ches
) {

512  
NULL
;

514 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

518  
√t_dev
;

520 
	}
}

522 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

524 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

526 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

527 !
	`°rcmp
(
buf
, "connected\n")) ||

528 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

529 !
	`°rcmp
(
buf
, "datagram\n"))) {

534 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

535 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

536 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

538 
	`√tdev_upd©e_„©uªs
(
dev
);

539 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

540 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

541 
	`π∆_u∆ock
();

542 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

544 
	`ùoib_Êush_∑ths
(
dev
);

545  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

548 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

549 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

550 
	`√tdev_upd©e_„©uªs
(
dev
);

551 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

552 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

553 
	`π∆_u∆ock
();

554 
	`ùoib_Êush_∑ths
(
dev
);

555  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

558  -
EINVAL
;

559 
	}
}

561 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

563 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

564 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

565 
ùoib_∑th
 *
∑th
;

566 
ªt
;

568 
n
) {

569 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

571 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

572  (
ib_gid
));

574 i‡(
ªt
 < 0)

575 
n
 =Ç->
rb_À·
;

576 i‡(
ªt
 > 0)

577 
n
 =Ç->
rb_right
;

579  
∑th
;

582  
NULL
;

583 
	}
}

585 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

587 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

588 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

589 
rb_node
 *
≤
 = 
NULL
;

590 
ùoib_∑th
 *
ç©h
;

591 
ªt
;

593 *
n
) {

594 
≤
 = *
n
;

595 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

597 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

598  (
ib_gid
));

599 i‡(
ªt
 < 0)

600 
n
 = &
≤
->
rb_À·
;

601 i‡(
ªt
 > 0)

602 
n
 = &
≤
->
rb_right
;

604  -
EEXIST
;

607 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

608 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

610 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

613 
	}
}

615 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

617 
sk_buff
 *
skb
;

619 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

620 
	`dev_k‰ì_skb_úq
(
skb
);

622 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

625 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

627 i‡(
∑th
->
ah
)

628 
	`ùoib_put_ah
(
∑th
->
ah
);

630 
	`k‰ì
(
∑th
);

631 
	}
}

633 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


635 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

637 
ùoib_∑th_ôî
 *
ôî
;

639 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

640 i‡(!
ôî
)

641  
NULL
;

643 
ôî
->
dev
 = dev;

644 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

646 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

647 
	`k‰ì
(
ôî
);

648  
NULL
;

651  
ôî
;

652 
	}
}

654 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

656 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

657 
rb_node
 *
n
;

658 
ùoib_∑th
 *
∑th
;

659 
ªt
 = 1;

661 
	`•ö_lock_úq
(&
¥iv
->
lock
);

663 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

665 
n
) {

666 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

668 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

669  (
ib_gid
)) < 0) {

670 
ôî
->
∑th
 = *path;

671 
ªt
 = 0;

675 
n
 = 
	`rb_√xt
(n);

678 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

680  
ªt
;

681 
	}
}

683 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

684 
ùoib_∑th
 *
∑th
)

686 *
∑th
 = 
ôî
->path;

687 
	}
}

691 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

693 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
ùoib_∑th
 *
∑th
, *
ç
;

696 
	`•ö_lock_úq
(&
¥iv
->
lock
);

698 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

699 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

700 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

701 
∑th
->
∑thªc
.
dgid
.
øw
);

702 i‡(
∑th
->
ah
)

703 
∑th
->
ah
->
vÆid
 = 0;

706 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

707 
	}
}

709 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

711 
ùoib_p£udo_hódî
 *
phdr
;

713 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

714 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

715 
	}
}

717 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

719 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

720 
ùoib_∑th
 *
∑th
, *
ç
;

721 
	`LIST_HEAD
(
ªmove_li°
);

722 
Êags
;

724 
	`√tif_tx_lock_bh
(
dev
);

725 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

727 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

729 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

730 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

732 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

733 i‡(
∑th
->
quîy
)

734 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

735 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

736 
	`√tif_tx_u∆ock_bh
(
dev
);

737 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

738 
	`∑th_‰ì
(
dev
, 
∑th
);

739 
	`√tif_tx_lock_bh
(
dev
);

740 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

743 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

744 
	`√tif_tx_u∆ock_bh
(
dev
);

745 
	}
}

747 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

748 
ß_∑th_ªc
 *
∑thªc
,

749 *
∑th_±r
)

751 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

752 
√t_devi˚
 *
dev
 = 
∑th
->dev;

753 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

754 
ùoib_ah
 *
ah
 = 
NULL
;

755 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

756 
ùoib_√igh
 *
√igh
, *
ä
;

757 
sk_buff_hód
 
skqueue
;

758 
sk_buff
 *
skb
;

759 
Êags
;

761 i‡(!
°©us
)

762 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

763 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

764 
∑thªc
->
dgid
.
øw
);

766 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

767 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

769 
	`skb_queue_hód_öô
(&
skqueue
);

771 i‡(!
°©us
) {

772 
rdma_ah_©å
 
av
;

774 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

775 
∑thªc
, &
av
, 
NULL
)) {

776 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

777 
	`rdma_de°roy_ah_©å
(&
av
);

781 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

783 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

789 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

790 (
ib_gid
))) {

791 
	`ùoib_dbg
(

792 
¥iv
,

794 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

795 
∑th
->
∑thªc
.
dgid
.
øw
);

796 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

797 (
ib_gid
));

800 
∑th
->
∑thªc
 = *pathrec;

802 
ﬁd_ah
 = 
∑th
->
ah
;

803 
∑th
->
ah
 =áh;

805 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

806 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

807 
∑thªc
->
¶
);

809 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

810 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

812 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

813 i‡(
√igh
->
ah
) {

814 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

822 
	`ùoib_put_ah
(
√igh
->
ah
);

824 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

825 
√igh
->
ah
 = 
∑th
->ah;

827 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

828 i‡(!
	`ùoib_cm_gë
(
√igh
))

829 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

830 
∑th
,

831 
√igh
));

832 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

833 
	`ùoib_√igh_‰ì
(
√igh
);

838 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

839 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

841 
∑th
->
ah
->
vÆid
 = 1;

844 
∑th
->
quîy
 = 
NULL
;

845 
	`com∂ëe
(&
∑th
->
d⁄e
);

847 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

849 i‡(
	`IS_ERR_OR_NULL
(
ah
))

850 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

852 i‡(
ﬁd_ah
)

853 
	`ùoib_put_ah
(
ﬁd_ah
);

855 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

856 
ªt
;

857 
skb
->
dev
 = dev;

858 
ªt
 = 
	`dev_queue_xmô
(
skb
);

859 i‡(
ªt
)

860 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

861 
__func__
, 
ªt
);

863 
	}
}

865 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

866 *
gid
)

868 
∑th
->
dev
 = 
¥iv
->dev;

870 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

871 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

873 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

875 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

876 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

877 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

878 
∑th
->
∑thªc
.
numb_∑th
 = 1;

879 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

880 
	}
}

882 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

884 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

885 
ùoib_∑th
 *
∑th
;

887 i‡(!
¥iv
->
brﬂdˇ°
)

888  
NULL
;

890 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

891 i‡(!
∑th
)

892  
NULL
;

894 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

896 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

898 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

900  
∑th
;

901 
	}
}

903 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

904 
ùoib_∑th
 *
∑th
)

906 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

908 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

909 
∑th
->
∑thªc
.
dgid
.
øw
);

911 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

913 
∑th
->
quîy_id
 =

914 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

915 &
∑th
->
∑thªc
,

916 
IB_SA_PATH_REC_DGID
 |

917 
IB_SA_PATH_REC_SGID
 |

918 
IB_SA_PATH_REC_NUMB_PATH
 |

919 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

920 
IB_SA_PATH_REC_PKEY
,

921 1000, 
GFP_ATOMIC
,

922 
∑th_ªc_com∂ëi⁄
,

923 
∑th
, &∑th->
quîy
);

924 i‡(
∑th
->
quîy_id
 < 0) {

925 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

926 
∑th
->
quîy
 = 
NULL
;

927 
	`com∂ëe
(&
∑th
->
d⁄e
);

928  
∑th
->
quîy_id
;

932 
	}
}

934 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

935 
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

938 
ùoib_∑th
 *
∑th
;

939 
Êags
;

941 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

943 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

944 i‡(!
∑th
)

945 
out
;

946 i‡(!
∑th
->
quîy
)

947 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

948 
out
:

949 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

950 
	}
}

952 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

953 
√t_devi˚
 *
dev
)

955 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

956 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

957 
ùoib_∑th
 *
∑th
;

958 
ùoib_√igh
 *
√igh
;

959 
Êags
;

961 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

962 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

963 i‡(!
√igh
) {

964 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

965 ++
dev
->
°©s
.
tx_dr›≥d
;

966 
	`dev_k‰ì_skb_™y
(
skb
);

967  
NULL
;

973 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

974 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

975  
√igh
;

978 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

979 i‡(!
∑th
) {

980 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

981 i‡(!
∑th
)

982 
îr_∑th
;

984 
	`__∑th_add
(
dev
, 
∑th
);

987 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

989 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

990 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

991 
√igh
->
ah
 = 
∑th
->ah;

993 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

994 i‡(!
	`ùoib_cm_gë
(
√igh
))

995 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

996 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

997 
	`ùoib_√igh_‰ì
(
√igh
);

998 
îr_dr›
;

1000 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

1001 
IPOIB_MAX_PATH_REC_QUEUE
) {

1002 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1003 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1005 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1006 
	`skb_queue_Àn
(&
√igh
->
queue
));

1007 
îr_dr›
;

1010 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1011 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1012 
	`IPOIB_QPN
(
daddr
));

1013 
	`ùoib_√igh_put
(
√igh
);

1014  
NULL
;

1017 
√igh
->
ah
 = 
NULL
;

1019 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1020 
îr_∑th
;

1021 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1022 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1023 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1025 
îr_dr›
;

1029 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1030 
	`ùoib_√igh_put
(
√igh
);

1031  
NULL
;

1033 
îr_∑th
:

1034 
	`ùoib_√igh_‰ì
(
√igh
);

1035 
îr_dr›
:

1036 ++
dev
->
°©s
.
tx_dr›≥d
;

1037 
	`dev_k‰ì_skb_™y
(
skb
);

1039 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1040 
	`ùoib_√igh_put
(
√igh
);

1042  
NULL
;

1043 
	}
}

1045 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1046 
ùoib_p£udo_hódî
 *
phdr
)

1048 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1049 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1050 
ùoib_∑th
 *
∑th
;

1051 
Êags
;

1053 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1056 i‡(!
¥iv
->
brﬂdˇ°
)

1057 
dr›_™d_u∆ock
;

1059 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1060 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1061 i‡(!
∑th
) {

1062 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1063 i‡(!
∑th
)

1064 
dr›_™d_u∆ock
;

1065 
	`__∑th_add
(
dev
, 
∑th
);

1071 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1073 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1074 
dr›_™d_u∆ock
;

1077 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1078 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1079 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1080 
u∆ock
;

1082 
dr›_™d_u∆ock
;

1086 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1087 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1088 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1089 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1090 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1093 
dr›_™d_u∆ock
:

1094 ++
dev
->
°©s
.
tx_dr›≥d
;

1095 
	`dev_k‰ì_skb_™y
(
skb
);

1096 
u∆ock
:

1097 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1098 
	}
}

1100 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1103 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1104 
ùoib_√igh
 *
√igh
;

1105 
ùoib_p£udo_hódî
 *
phdr
;

1106 
ùoib_hódî
 *
hódî
;

1107 
Êags
;

1109 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1110 
	`skb_puŒ
(
skb
, (*
phdr
));

1111 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1113 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1115 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1116 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1117 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1118 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1119 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1121 ++
dev
->
°©s
.
tx_dr›≥d
;

1122 
	`dev_k‰ì_skb_™y
(
skb
);

1123  
NETDEV_TX_OK
;

1126 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1127 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1129 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1130 i‡(
	`likñy
(
√igh
))

1131 
£nd_usög_√igh
;

1132 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1133  
NETDEV_TX_OK
;

1137 
hódî
->
¥Ÿo
) {

1138 
	`ht⁄s
(
ETH_P_IP
):

1139 
	`ht⁄s
(
ETH_P_IPV6
):

1140 
	`ht⁄s
(
ETH_P_TIPC
):

1141 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1142 i‡(
	`u∆ikñy
(!
√igh
)) {

1143 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1144 i‡(
	`likñy
(!
√igh
))

1145  
NETDEV_TX_OK
;

1148 
	`ht⁄s
(
ETH_P_ARP
):

1149 
	`ht⁄s
(
ETH_P_RARP
):

1151 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1152  
NETDEV_TX_OK
;

1155 ++
dev
->
°©s
.
tx_dr›≥d
;

1156 
	`dev_k‰ì_skb_™y
(
skb
);

1157  
NETDEV_TX_OK
;

1160 
£nd_usög_√igh
:

1162 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1163 i‡(
	`ùoib_cm_up
(
√igh
)) {

1164 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1165 
uƒef
;

1167 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1168 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1169 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1170 
uƒef
;

1171 } i‡(
√igh
->
ah
) {

1172 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1175 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1176 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1177 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1178 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1179 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1181 ++
dev
->
°©s
.
tx_dr›≥d
;

1182 
	`dev_k‰ì_skb_™y
(
skb
);

1185 
uƒef
:

1186 
	`ùoib_√igh_put
(
√igh
);

1188  
NETDEV_TX_OK
;

1189 
	}
}

1191 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1193 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1195 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1196 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1197 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1198 
	`√tif_queue_°›≥d
(
dev
),

1199 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1201 
	}
}

1203 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1204 
√t_devi˚
 *
dev
,

1205 
ty≥
,

1206 c⁄° *
daddr
,

1207 c⁄° *
ßddr
,

1208 
Àn
)

1210 
ùoib_hódî
 *
hódî
;

1212 
hódî
 = 
	`skb_push
(
skb
, (*header));

1214 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1215 
hódî
->
ª£rved
 = 0;

1222 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1224  
IPOIB_HARD_LEN
;

1225 
	}
}

1227 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1229 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1231 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1232 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1236 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1237 
	}
}

1239 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1241 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1244 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1245  
dev
->
ifödex
;

1248  
¥iv
->
∑ª¡
->
ifödex
;

1249 
	}
}

1251 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1260 
u32
 *
d32
 = (u32 *Ë
daddr
;

1261 
u32
 
hv
;

1263 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1264  
hv
 & 
htbl
->
mask
;

1265 
	}
}

1267 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1269 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1270 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1271 
ùoib_√igh_hash
 *
htbl
;

1272 
ùoib_√igh
 *
√igh
 = 
NULL
;

1273 
u32
 
hash_vÆ
;

1275 
	`rcu_ªad_lock_bh
();

1277 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1279 i‡(!
htbl
)

1280 
out_u∆ock
;

1282 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1283 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1284 
√igh
 !
NULL
;

1285 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1286 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1288 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1290 
√igh
 = 
NULL
;

1291 
out_u∆ock
;

1294 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1295 
√igh
->
Æive
 = 
jiffõs
;

1296 
out_u∆ock
;

1300 
out_u∆ock
:

1301 
	`rcu_ªad_u∆ock_bh
();

1302  
√igh
;

1303 
	}
}

1305 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1307 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1308 
ùoib_√igh_hash
 *
htbl
;

1309 
√igh_obsﬁëe
;

1310 
dt
;

1311 
Êags
;

1312 
i
;

1313 
	`LIST_HEAD
(
ªmove_li°
);

1315 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1317 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1318 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1320 i‡(!
htbl
)

1321 
out_u∆ock
;

1324 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1325 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1327 
i
 = 0; i < 
htbl
->
size
; i++) {

1328 
ùoib_√igh
 *
√igh
;

1329 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1331 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1332 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1334 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1336 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1338 
	`rcu_assign_poöãr
(*
≈
,

1339 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1340 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1342 
	`li°_dñ_öô
(&
√igh
->
li°
);

1343 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1345 
≈
 = &
√igh
->
h√xt
;

1351 
out_u∆ock
:

1352 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1353 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1354 
	}
}

1356 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1358 
ùoib_dev_¥iv
 *
¥iv
 =

1359 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1361 
	`__ùoib_ª≠_√igh
(
¥iv
);

1363 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1364 
¨p_tbl
.
gc_öãrvÆ
);

1365 
	}
}

1368 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1369 
√t_devi˚
 *
dev
)

1371 
ùoib_√igh
 *
√igh
;

1373 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1374 i‡(!
√igh
)

1375  
NULL
;

1377 
√igh
->
dev
 = dev;

1378 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1379 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1380 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1381 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1383 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1385  
√igh
;

1386 
	}
}

1388 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1389 
√t_devi˚
 *
dev
)

1391 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1392 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1393 
ùoib_√igh_hash
 *
htbl
;

1394 
ùoib_√igh
 *
√igh
;

1395 
u32
 
hash_vÆ
;

1397 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1398 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1399 i‡(!
htbl
) {

1400 
√igh
 = 
NULL
;

1401 
out_u∆ock
;

1407 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1408 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1409 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1410 
√igh
 !
NULL
;

1411 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1412 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1413 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1415 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1417 
√igh
 = 
NULL
;

1420 
√igh
->
Æive
 = 
jiffõs
;

1421 
out_u∆ock
;

1425 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1426 i‡(!
√igh
)

1427 
out_u∆ock
;

1430 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1431 
√igh
->
Æive
 = 
jiffõs
;

1433 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1434 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1435 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1436 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1437 
	`©omic_öc
(&
¡bl
->
íåõs
);

1439 
out_u∆ock
:

1441  
√igh
;

1442 
	}
}

1444 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1447 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1448 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1449 
sk_buff
 *
skb
;

1450 i‡(
√igh
->
ah
)

1451 
	`ùoib_put_ah
(
√igh
->
ah
);

1452 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1453 ++
dev
->
°©s
.
tx_dr›≥d
;

1454 
	`dev_k‰ì_skb_™y
(
skb
);

1456 i‡(
	`ùoib_cm_gë
(
√igh
))

1457 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1458 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1460 
	`IPOIB_QPN
(
√igh
->
daddr
),

1461 
√igh
->
daddr
 + 4);

1462 
	`k‰ì
(
√igh
);

1463 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1464 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1465 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1467 
	}
}

1469 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1472 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1474 
	`ùoib_√igh_put
(
√igh
);

1475 
	}
}

1477 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1479 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1481 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1482 
ùoib_√igh_hash
 *
htbl
;

1483 
ùoib_√igh
 
__rcu
 **
≈
;

1484 
ùoib_√igh
 *
n
;

1485 
u32
 
hash_vÆ
;

1487 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1488 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1489 i‡(!
htbl
)

1492 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1493 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1494 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1495 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1496 
n
 !
NULL
;

1497 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1498 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1499 i‡(
n
 =
√igh
) {

1501 
	`rcu_assign_poöãr
(*
≈
,

1502 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1503 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1505 
	`li°_dñ_öô
(&
√igh
->
li°
);

1506 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1509 
≈
 = &
n
->
h√xt
;

1512 
	}
}

1514 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1516 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1517 
ùoib_√igh_hash
 *
htbl
;

1518 
ùoib_√igh
 
__rcu
 **
buckës
;

1519 
u32
 
size
;

1521 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1522 
¡bl
->
htbl
 = 
NULL
;

1523 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1524 i‡(!
htbl
)

1525  -
ENOMEM
;

1526 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1527 
buckës
 = 
	`kˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1528 i‡(!
buckës
) {

1529 
	`k‰ì
(
htbl
);

1530  -
ENOMEM
;

1532 
htbl
->
size
 = size;

1533 
htbl
->
mask
 = (
size
 - 1);

1534 
htbl
->
buckës
 = buckets;

1535 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1536 
htbl
->
¡bl
 =Çtbl;

1537 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1540 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1541 
¨p_tbl
.
gc_öãrvÆ
);

1544 
	}
}

1546 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1548 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1549 
ùoib_√igh_hash
,

1550 
rcu
);

1551 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1552 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1554 
	`k‰ì
(
buckës
);

1555 
	`k‰ì
(
htbl
);

1556 
	`com∂ëe
(&
¡bl
->
dñëed
);

1557 
	}
}

1559 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1562 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1563 
ùoib_√igh_hash
 *
htbl
;

1564 
Êags
;

1565 
i
;

1568 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1570 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1571 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1573 i‡(!
htbl
)

1574 
out_u∆ock
;

1576 
i
 = 0; i < 
htbl
->
size
; i++) {

1577 
ùoib_√igh
 *
√igh
;

1578 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1580 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1581 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1583 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1584 
	`rcu_assign_poöãr
(*
≈
,

1585 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1586 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1588 
	`li°_dñ_öô
(&
√igh
->
li°
);

1589 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1591 
≈
 = &
√igh
->
h√xt
;

1596 
out_u∆ock
:

1597 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1598 
	}
}

1600 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1602 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1603 
ùoib_√igh_hash
 *
htbl
;

1604 
Êags
;

1605 
i
, 
waô_Êushed
 = 0;

1607 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1608 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1610 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1612 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1613 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1614 i‡(!
htbl
)

1615 
out_u∆ock
;

1617 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1618 i‡(!
waô_Êushed
)

1619 
‰ì_htbl
;

1621 
i
 = 0; i < 
htbl
->
size
; i++) {

1622 
ùoib_√igh
 *
√igh
;

1623 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1625 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1626 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1627 
	`rcu_assign_poöãr
(*
≈
,

1628 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1629 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1631 
	`li°_dñ_öô
(&
√igh
->
li°
);

1632 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1636 
‰ì_htbl
:

1637 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1638 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1640 
out_u∆ock
:

1641 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1642 i‡(
waô_Êushed
)

1643 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1644 
	}
}

1646 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1648 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1650 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1651 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1653 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1655 
	`ùoib_Êush_√ighs
(
¥iv
);

1657 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1658 
	}
}

1660 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1662 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1664 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1665 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1666 
	}
}

1668 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1672 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1673 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1674 
	}
}

1676 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1678 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1680 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1682 
	`ùoib_«pi_dñ
(
dev
);

1684 
	`ùoib_cm_dev_˛ónup
(
dev
);

1686 
	`k‰ì
(
¥iv
->
rx_rög
);

1687 
	`v‰ì
(
¥iv
->
tx_rög
);

1689 
¥iv
->
rx_rög
 = 
NULL
;

1690 
¥iv
->
tx_rög
 = 
NULL
;

1691 
	}
}

1693 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1695 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1697 
	`ùoib_«pi_add
(
dev
);

1700 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1701 (*
¥iv
->
rx_rög
),

1702 
GFP_KERNEL
);

1703 i‡(!
¥iv
->
rx_rög
)

1704 
out
;

1706 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1707 (*
¥iv
->
tx_rög
)));

1708 i‡(!
¥iv
->
tx_rög
) {

1709 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1710 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1711 
out_rx_rög_˛ónup
;

1716 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1717 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1718 
¥iv
->
ˇ
->
«me
);

1719 
out_tx_rög_˛ónup
;

1723 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1724 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1725 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1729 
out_tx_rög_˛ónup
:

1730 
	`v‰ì
(
¥iv
->
tx_rög
);

1732 
out_rx_rög_˛ónup
:

1733 
	`k‰ì
(
¥iv
->
rx_rög
);

1735 
out
:

1736 
	`ùoib_«pi_dñ
(
dev
);

1737  -
ENOMEM
;

1738 
	}
}

1740 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1741 
cmd
)

1743 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1745 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1746  -
EOPNOTSUPP
;

1748  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1749 
	}
}

1751 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1753 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1754 
ªt
 = -
ENOMEM
;

1756 
¥iv
->
qp
 = 
NULL
;

1762 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1763 i‡(!
¥iv
->
wq
) {

1764 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1765 
out
;

1769 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1770 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1771 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1772 
˛ón_wq
;

1775 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1776 i‡(
ªt
) {

1777 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1778 
out_‰ì_pd
;

1781 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1782 i‡(
ªt
) {

1783 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1784 
out_dev_unöô
;

1787 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1788 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1789 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1790 
ªt
 = -
ENODEV
;

1791 
out_hash_unöô
;

1797 
out_hash_unöô
:

1798 
	`ùoib_√igh_hash_unöô
(
dev
);

1800 
out_dev_unöô
:

1801 
	`ùoib_ib_dev_˛ónup
(
dev
);

1803 
out_‰ì_pd
:

1804 i‡(
¥iv
->
pd
) {

1805 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1806 
¥iv
->
pd
 = 
NULL
;

1809 
˛ón_wq
:

1810 i‡(
¥iv
->
wq
) {

1811 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1812 
¥iv
->
wq
 = 
NULL
;

1815 
out
:

1816  
ªt
;

1817 
	}
}

1823 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1825 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1831 
	`π∆_lock
();

1832 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

1833 
	`π∆_u∆ock
();

1836 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1842 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1843 
	}
}

1845 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1847 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1849 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1850 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1852 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1853 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1855 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1857 
	}
}

1859 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1861 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1862 
ib_p‹t_©å
 
©å
;

1863 
ªsu…
;

1865 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1866 i‡(
ªsu…
) {

1867 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1868 
¥iv
->
p‹t
);

1869  
ªsu…
;

1871 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1872 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1874 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1876 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1877 i‡(
ªsu…
) {

1878 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1879 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1880  
ªsu…
;

1883 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1884 i‡(
ªsu…
) {

1885 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1886 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1887  
ªsu…
;

1889 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1890 (
ib_gid
));

1892 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1893 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1895 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1898 
	}
}

1900 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1903 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1905 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1906 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1907 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1908 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1909 
	}
}

1911 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1913 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1914 
rdma_√tdev
 *
∫
;

1915 
rc
;

1917 i‡(
¥iv
->
∑ª¡
) {

1918 
	`ùoib_chûd_öô
(
ndev
);

1920 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1921 i‡(
rc
)

1922  
rc
;

1926 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1927 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1928 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1929 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1930 
ndev
->
exãnded
->
max_mtu
 = 
IPOIB_CM_MTU
;

1932 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1938 
¥iv
->
pkey
 |= 0x8000;

1940 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1941 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1942 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1944 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1946 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1947 i‡(
rc
) {

1948 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1949 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1950  
rc
;

1953 i‡(
¥iv
->
∑ª¡
) {

1954 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1956 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1958 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1959 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1960 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1964 
	}
}

1966 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1968 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1970 
	`ASSERT_RTNL
();

1976 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1978 i‡(
¥iv
->
∑ª¡
) {

1979 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1981 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`li°_dñ
(&
¥iv
->
li°
);

1983 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1986 
	`ùoib_√igh_hash_unöô
(
dev
);

1988 
	`ùoib_ib_dev_˛ónup
(
dev
);

1991 i‡(
¥iv
->
wq
) {

1992 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1993 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1994 
¥iv
->
wq
 = 
NULL
;

1997 i‡(
¥iv
->
∑ª¡
)

1998 
	`dev_put
(
¥iv
->
∑ª¡
);

1999 
	}
}

2001 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

2003 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2005  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2006 
	}
}

2008 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2009 
iÊa_vf_öfo
 *
ivf
)

2011 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2012 
îr
;

2014 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2015 i‡(
îr
)

2016  
îr
;

2018 
ivf
->
vf
 = vf;

2021 
	}
}

2023 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2025 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2027 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2028  -
EINVAL
;

2030  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2031 
	}
}

2033 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2034 
iÊa_vf_°©s
 *
vf_°©s
)

2036 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2038  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2039 
	}
}

2041 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2042 .
¸óã
 = 
ùoib_h¨d_hódî
,

2045 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2046 .
ndo_size
 = (
√t_devi˚_›s
),

2047 .
	gndo_öô
 = 
ùoib_ndo_öô
,

2048 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2049 .
	gndo_›í
 = 
ùoib_›í
,

2050 .
	gndo_°›
 = 
ùoib_°›
,

2051 .
	gexãnded
.
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2052 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2053 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2054 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2055 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2056 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2057 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2058 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2059 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2060 .
	gexãnded
.
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2061 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2062 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2063 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2066 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2067 .
ndo_size
 = (
√t_devi˚_›s
),

2068 .
	gndo_öô
 = 
ùoib_ndo_öô
,

2069 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2070 .
	gndo_›í
 = 
ùoib_›í
,

2071 .
	gndo_°›
 = 
ùoib_°›
,

2072 .
	gexãnded
.
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2073 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2074 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2075 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2076 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2077 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2078 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2079 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2082 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2083 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2084 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2085 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2086 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2089 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2091 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2092 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2094 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2096 
dev
->
w©chdog_timeo
 = 
HZ
;

2098 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2100 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2101 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2102 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2103 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2104 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2105 
NETIF_F_HIGHDMA
);

2106 
	`√tif_kìp_d°
(
dev
);

2108 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2115 
dev
->
exãnded
->
√eds_‰ì_√tdev
 = 
åue
;

2116 
	}
}

2118 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2122 
¥iv
->
dev
 = dev;

2123 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2124 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2125 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2127 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2128 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2129 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2130 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2132 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2133 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2134 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2135 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2136 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2137 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2138 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2139 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2140 
	}
}

2142 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2143 c⁄° *
«me
)

2145 
√t_devi˚
 *
dev
 = 
NULL
;

2147 i‡(
ùoib_íh™˚d_íabÀd
) {

2148 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2150 
ùoib_£tup_comm⁄
);

2151 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2152  
dev
;

2155 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
,

2156 
ùoib_£tup_comm⁄
);

2157 i‡(!
dev
)

2158  
	`ERR_PTR
(-
ENOMEM
);

2159  
dev
;

2160 
	}
}

2162 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2163 
√t_devi˚
 *
dev
)

2165 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2166 
ùoib_dev_¥iv
 *
¥iv
;

2167 
rc
 = -
EOPNOTSUPP
;

2169 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2170 i‡(!
¥iv
)

2171  -
ENOMEM
;

2173 
¥iv
->
ˇ
 = 
hˇ
;

2174 
¥iv
->
p‹t
 =Öort;

2176 i‡(
ùoib_íh™˚d_íabÀd
)

2177 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2179 
ùoib_£tup_comm⁄
, 
dev
);

2180 i‡(
rc
) {

2181 i‡(
rc
 !-
EOPNOTSUPP
)

2182 
out
;

2184 
∫
->
£nd
 = 
ùoib_£nd
;

2185 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2186 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2187 
∫
->
hˇ
 = hca;

2190 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2192 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2193 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2195 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2197 
∫
->
˛¡_¥iv
 = 
¥iv
;

2203 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
exãnded
->
¥iv_de°ru˘‹
;

2204 
dev
->
exãnded
->
¥iv_de°ru˘‹
 = 
NULL
;

2206 
	`ùoib_buûd_¥iv
(
dev
);

2210 
out
:

2211 
	`k‰ì
(
¥iv
);

2212  
rc
;

2213 
	}
}

2215 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2216 c⁄° *
«me
)

2218 
√t_devi˚
 *
dev
;

2219 
rc
;

2221 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2222 i‡(
	`IS_ERR
(
dev
))

2223  
dev
;

2225 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2226 i‡(
rc
) {

2227 
	`‰ì_√tdev
(
dev
);

2228  
	`ERR_PTR
(
rc
);

2236  
dev
;

2237 
	}
}

2239 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2241 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2242 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2244 
dev
->
exãnded
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2245 i‡(
dev
->
exãnded
->
¥iv_de°ru˘‹
)

2246 
dev
->
exãnded
->
	`¥iv_de°ru˘‹
(dev);

2252 
dev
->
exãnded
->
¥iv_de°ru˘‹
 = 
NULL
;

2255 
∫
->
˛¡_¥iv
 = 
NULL
;

2257 
	`k‰ì
(
¥iv
);

2258 
	}
}

2260 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2261 
devi˚_©åibuã
 *
©å
, *
buf
)

2263 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2266  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2267 
	}
}

2268 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2270 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2271 
devi˚_©åibuã
 *
©å
, *
buf
)

2273 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2274 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2276  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2277 
	}
}

2279 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2281 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2283 i‡(
umˇ°_vÆ
 > 0) {

2284 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2285 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2288 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2289 
	}
}

2291 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2292 
devi˚_©åibuã
 *
©å
,

2293 c⁄° *
buf
, 
size_t
 
cou¡
)

2295 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2297 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2299  
cou¡
;

2300 
	}
}

2301 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2303 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2305  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2306 
	}
}

2308 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2310 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2311 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2313 
	`√tif_addr_lock_bh
(
√tdev
);

2315 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2316 &
gid
->
globÆ
.
öãrÁ˚_id
,

2317 (
gid
->
globÆ
.
öãrÁ˚_id
));

2318 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2319 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2321 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2323 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2324 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2325 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2326 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2327 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2329 
	}
}

2331 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2332 
sockaddr_°‹age
 *
ss
)

2334 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2335 
ªt
 = 0;

2337 
	`√tif_addr_lock_bh
(
dev
);

2342 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2343 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2344 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2345 
ªt
 = -
EINVAL
;

2347 
	`√tif_addr_u∆ock_bh
(
dev
);

2349  
ªt
;

2350 
	}
}

2352 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2354 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2355 
sockaddr_°‹age
 *
ss
 = 
addr
;

2356 
ªt
;

2358 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2359  -
EBUSY
;

2361 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2362 i‡(
ªt
)

2363  
ªt
;

2365 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2367 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2370 
	}
}

2372 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2373 
devi˚_©åibuã
 *
©å
,

2374 c⁄° *
buf
, 
size_t
 
cou¡
)

2376 
pkey
;

2377 
ªt
;

2379 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2380  -
EINVAL
;

2382 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2383  -
EINVAL
;

2385 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2387  
ªt
 ?Ñë : 
cou¡
;

2388 
	}
}

2389 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2391 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2392 
devi˚_©åibuã
 *
©å
,

2393 c⁄° *
buf
, 
size_t
 
cou¡
)

2395 
pkey
;

2396 
ªt
;

2398 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2399  -
EINVAL
;

2401 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2402  -
EINVAL
;

2404 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2406  
ªt
 ?Ñë : 
cou¡
;

2408 
	}
}

2409 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2411 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2413  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2414 
	}
}

2425 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2426 
devi˚_©åibuã
 *
©å
, *
buf
)

2428 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2441 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2442 
	`√tdev_öfo_⁄˚
(
ndev
,

2444 
cuºít
->
comm
);

2446  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2447 
	}
}

2448 
DEVICE_ATTR_RO
(
dev_id
);

2450 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2452 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2453  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2454 
	}
}

2456 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2457 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2459 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2460 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2461 
ùoib_dev_¥iv
 *
¥iv
;

2462 
√t_devi˚
 *
ndev
;

2463 
ªsu…
;

2465 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2466 i‡(
	`IS_ERR
(
ndev
)) {

2467 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2468 
	`PTR_ERR
(
ndev
));

2469  
ndev
;

2471 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2473 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2474 
¥iv
->
ˇ
, 
ùoib_evít
);

2475 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2478 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2480 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2481 i‡(
ªsu…
) {

2482 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2483 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2485 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2486 
	`ùoib_ötf_‰ì
(
ndev
);

2487 
	`‰ì_√tdev
(
ndev
);

2489  
	`ERR_PTR
(
ªsu…
);

2492 i‡(
hˇ
->
rdma_√tdev_gë_∑øms
 && 
ùoib_íh™˚d_íabÀd
) {

2493 
rc
 = 
hˇ
->
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2494 
RDMA_NETDEV_IPOIB
,

2495 &
∑øms
);

2497 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2498 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2506 
ndev
->
exãnded
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2508 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2509 
sysfs_Áûed
;

2510 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2511 
sysfs_Áûed
;

2512 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2513 
sysfs_Áûed
;

2514 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2515 
sysfs_Áûed
;

2516 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2517 
sysfs_Áûed
;

2518 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2519 
sysfs_Áûed
;

2521  
ndev
;

2523 
sysfs_Áûed
:

2524 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2525 
	`uƒegi°î_√tdev
(
ndev
);

2526  
	`ERR_PTR
(-
ENOMEM
);

2527 
	}
}

2529 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2531 
li°_hód
 *
dev_li°
;

2532 
√t_devi˚
 *
dev
;

2533 
ùoib_dev_¥iv
 *
¥iv
;

2534 
p
;

2535 
cou¡
 = 0;

2537 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2538 i‡(!
dev_li°
)

2541 
	`INIT_LIST_HEAD
(
dev_li°
);

2543 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2544 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2546 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2547 i‡(!
	`IS_ERR
(
dev
)) {

2548 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2549 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2550 
cou¡
++;

2554 i‡(!
cou¡
) {

2555 
	`k‰ì
(
dev_li°
);

2559 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2560 
	}
}

2562 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2564 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2565 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2567 i‡(!
dev_li°
)

2570 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2571 
	`LIST_HEAD
(
hód
);

2572 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2574 
	`π∆_lock
();

2576 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2577 
li°
)

2578 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2579 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2580 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2582 
	`π∆_u∆ock
();

2585 
	`k‰ì
(
dev_li°
);

2586 
	}
}

2588 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2589 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2590 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2594 
__öô
 
	$ùoib_öô_moduÀ
()

2596 
ªt
;

2598 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2599 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2600 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2602 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2603 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2604 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2605 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2606 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2607 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2614 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2616 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2618 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2619 i‡(
ªt
)

2620  
ªt
;

2632 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2633 i‡(!
ùoib_w‹kqueue
) {

2634 
ªt
 = -
ENOMEM
;

2635 
îr_fs
;

2638 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2640 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2641 i‡(
ªt
)

2642 
îr_ß
;

2644 
ªt
 = 
	`ùoib_√éök_öô
();

2645 i‡(
ªt
)

2646 
îr_˛õ¡
;

2648 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2649 
	`ªgi°î_√tdevi˚_nŸifõr_rh
(&
ùoib_√tdev_nŸifõr
);

2653 
îr_˛õ¡
:

2654 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2656 
îr_ß
:

2657 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2658 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2660 
îr_fs
:

2661 
	`ùoib_uƒegi°î_debugfs
();

2663  
ªt
;

2664 
	}
}

2666 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2668 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2669 
	`uƒegi°î_√tdevi˚_nŸifõr_rh
(&
ùoib_√tdev_nŸifõr
);

2671 
	`ùoib_√éök_föi
();

2672 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2673 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2674 
	`ùoib_uƒegi°î_debugfs
();

2675 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2676 
	}
}

2678 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2679 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL77/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

70 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

71 
ùoib_mˇ°
 *
mˇ°
,

72 
boﬁ
 
dñay
)

74 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

81 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

82 i‡(
mˇ°
 && 
dñay
) {

86 
mˇ°
->
backoff
 *= 2;

87 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

88 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

89 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

97 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

98 } i‡(
dñay
) {

104 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

106 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

107 
	}
}

109 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

111 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

112 
tx_dr›≥d
 = 0;

114 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

115 
mˇ°
->
mcmembî
.
mgid
.
øw
);

118 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

120 i‡(
mˇ°
->
ah
)

121 
	`ùoib_put_ah
(
mˇ°
->
ah
);

123 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

124 ++
tx_dr›≥d
;

125 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

128 
	`√tif_tx_lock_bh
(
dev
);

129 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

130 
	`√tif_tx_u∆ock_bh
(
dev
);

132 
	`k‰ì
(
mˇ°
);

133 
	}
}

135 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

136 
ˇn_¶ìp
)

138 
ùoib_mˇ°
 *
mˇ°
;

140 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

141 i‡(!
mˇ°
)

142  
NULL
;

144 
mˇ°
->
dev
 = dev;

145 
mˇ°
->
¸óãd
 = 
jiffõs
;

146 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

147 
mˇ°
->
backoff
 = 1;

149 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

150 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

151 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

153  
mˇ°
;

154 
	}
}

156 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

158 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

159 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

161 
n
) {

162 
ùoib_mˇ°
 *
mˇ°
;

163 
ªt
;

165 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

167 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

168  (
ib_gid
));

169 i‡(
ªt
 < 0)

170 
n
 =Ç->
rb_À·
;

171 i‡(
ªt
 > 0)

172 
n
 =Ç->
rb_right
;

174  
mˇ°
;

177  
NULL
;

178 
	}
}

180 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

183 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

185 *
n
) {

186 
ùoib_mˇ°
 *
tmˇ°
;

187 
ªt
;

189 
≤
 = *
n
;

190 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

192 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

193  (
ib_gid
));

194 i‡(
ªt
 < 0)

195 
n
 = &
≤
->
rb_À·
;

196 i‡(
ªt
 > 0)

197 
n
 = &
≤
->
rb_right
;

199  -
EEXIST
;

202 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

203 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

206 
	}
}

208 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

209 
ib_ß_mcmembî_ªc
 *
mcmembî
)

211 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

212 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

213 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

214 
ùoib_ah
 *
ah
;

215 
rdma_ah_©å
 
av
;

216 
ªt
;

217 
£t_qkey
 = 0;

219 
mˇ°
->
mcmembî
 = *mcmember;

224 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

225  (
ib_gid
))) {

226 
	`•ö_lock_úq
(&
¥iv
->
lock
);

227 i‡(!
¥iv
->
brﬂdˇ°
) {

228 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

229  -
EAGAIN
;

232 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

233 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

234 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

240 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

241 
∫
->
mtu
 =

242 
¥iv
->
admö_mtu
 =

243 
¥iv
->
mˇ°_mtu
 =

244 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

245 
¥iv
->
p‹t
,

246 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

248 
∫
->
mtu
 =

249 
¥iv
->
mˇ°_mtu
 =

250 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

251 
¥iv
->
p‹t
,

252 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

254 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

255 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

256 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

257 
£t_qkey
 = 1;

260 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

261 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

262 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

263 
mˇ°
->
mcmembî
.
mgid
.
øw
);

268 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

269 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

270 
£t_qkey
, 
¥iv
->
qkey
);

271 i‡(
ªt
 < 0) {

272 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

273 
mˇ°
->
mcmembî
.
mgid
.
øw
);

275 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

276  
ªt
;

280 
	`mem£t
(&
av
, 0, (av));

281 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

282 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

283 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

284 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

285 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

287 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

288 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

289 0, 
mˇ°
->
mcmembî
.
h›_limô
,

290 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

292 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

293 i‡(
	`IS_ERR
(
ah
)) {

294 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

295 -
	`PTR_ERR
(
ah
));

297  
	`PTR_ERR
(
ah
);

299 
	`•ö_lock_úq
(&
¥iv
->
lock
);

300 
mˇ°
->
ah
 =áh;

301 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

303 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

304 
mˇ°
->
mcmembî
.
mgid
.
øw
,

305 
mˇ°
->
ah
->ah,

306 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

307 
mˇ°
->
mcmembî
.
¶
);

310 
	`√tif_tx_lock_bh
(
dev
);

311 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

312 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

314 
	`√tif_tx_u∆ock_bh
(
dev
);

316 
skb
->
dev
 = dev;

318 
ªt
 = 
	`dev_queue_xmô
(
skb
);

319 i‡(
ªt
)

320 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

321 
__func__
, 
ªt
);

322 
	`√tif_tx_lock_bh
(
dev
);

324 
	`√tif_tx_u∆ock_bh
(
dev
);

327 
	}
}

329 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

331 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

332 
ˇºõr_⁄_èsk
);

333 
ib_p‹t_©å
 
©å
;

335 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

336 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

337 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

346 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

347 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

348 
¥iv
->
ˇ
,Öriv->
p‹t
);

358 !
	`π∆_åylock
()) {

359 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

362 
	`m¶ìp
(20);

364 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

365 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

366 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

367 
	`π∆_u∆ock
();

368 
	}
}

370 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

371 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

373 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

374 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

375 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

377 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

378 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

380 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

383 i‡(
°©us
 =-
ENETRESET
) {

384 
°©us
 = 0;

385 
out
;

388 i‡(!
°©us
)

389 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

391 i‡(!
°©us
) {

392 
mˇ°
->
backoff
 = 1;

393 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

402 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

403 
	`•ö_lock_úq
(&
¥iv
->
lock
);

404 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

405 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

406 
out_locked
;

409 
boﬁ
 
sûít_Áû
 =

410 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

411 
°©us
 =-
EINVAL
;

413 i‡(
mˇ°
->
logcou¡
 < 20) {

414 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

415 
sûít_Áû
) {

416 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

417 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

418 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

420 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

421 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

422 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

425 i‡(!
sûít_Áû
)

426 
mˇ°
->
logcou¡
++;

429 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

430 
mˇ°
->
backoff
 >= 2) {

440 
mˇ°
->
backoff
 = 1;

441 
	`√tif_tx_lock_bh
(
dev
);

442 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

443 ++
dev
->
°©s
.
tx_dr›≥d
;

444 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

446 
	`√tif_tx_u∆ock_bh
(
dev
);

448 
	`•ö_lock_úq
(&
¥iv
->
lock
);

450 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

451 
out_locked
;

454 
out
:

455 
	`•ö_lock_úq
(&
¥iv
->
lock
);

456 
out_locked
:

461 i‡(
°©us
)

462 
mˇ°
->
mc
 = 
NULL
;

464 
mˇ°
->
mc
 = 
mu…iˇ°
;

465 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

466 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

467 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

469  
°©us
;

470 
	}
}

475 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

477 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

478 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

479 
ib_ß_mcmembî_ªc
 
ªc
 = {

480 .
joö_°©e
 = 1

482 
ib_ß_comp_mask
 
comp_mask
;

483 
ªt
 = 0;

485 i‡(!
¥iv
->
brﬂdˇ°
 ||

486 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

487  -
EINVAL
;

489 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

490 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

492 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

494 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

495 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

496 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

498 
comp_mask
 =

499 
IB_SA_MCMEMBER_REC_MGID
 |

500 
IB_SA_MCMEMBER_REC_PORT_GID
 |

501 
IB_SA_MCMEMBER_REC_PKEY
 |

502 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

504 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

512 
comp_mask
 |=

513 
IB_SA_MCMEMBER_REC_QKEY
 |

514 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

515 
IB_SA_MCMEMBER_REC_MTU
 |

516 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

517 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_RATE
 |

519 
IB_SA_MCMEMBER_REC_SL
 |

520 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

521 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

523 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

524 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

525 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

526 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

527 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

529 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

530 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

531 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

544 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

545 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

547 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

549 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

551 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

552 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

553 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

554 
	`•ö_lock_úq
(&
¥iv
->
lock
);

555 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

556 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

557 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

559 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

560 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

561 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

562 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

563 
	`•ö_lock_úq
(&
¥iv
->
lock
);

566 
	}
}

568 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

570 
ùoib_dev_¥iv
 *
¥iv
 =

571 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

572 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

573 
ib_p‹t_©å
 
p‹t_©å
;

574 
dñay_u¡û
 = 0;

575 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

577 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

580 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

581 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

584 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

585 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

586 
p‹t_©å
.
°©e
);

589 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

590 
	`√tif_addr_lock_bh
(
dev
);

592 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

593 
	`√tif_addr_u∆ock_bh
(
dev
);

596 
	`√tif_addr_u∆ock_bh
(
dev
);

598 
	`•ö_lock_úq
(&
¥iv
->
lock
);

599 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

600 
out
;

602 i‡(!
¥iv
->
brﬂdˇ°
) {

603 
ùoib_mˇ°
 *
brﬂdˇ°
;

605 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

606 i‡(!
brﬂdˇ°
) {

607 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

614 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

615 
out
;

618 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

619  (
ib_gid
));

620 
¥iv
->
brﬂdˇ°
 = broadcast;

622 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

625 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

626 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

627 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

628 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

629 i‡(
mˇ°
->
backoff
 > 1 &&

630 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

631 
dñay_u¡û
 = 
mˇ°
->delay_until;

632 
mˇ°
 = 
NULL
;

635 
out
;

642 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

643 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

644 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

645 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

646 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

647 i‡(
mˇ°
->
backoff
 == 1 ||

648 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

650 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

651 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

654 } i‡(!
dñay_u¡û
 ||

655 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

656 
dñay_u¡û
 = 
mˇ°
->delay_until;

660 
mˇ°
 = 
NULL
;

661 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

663 
out
:

664 i‡(
dñay_u¡û
) {

665 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

666 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

667 
dñay_u¡û
 - 
jiffõs
);

669 i‡(
mˇ°
)

670 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

672 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

673 
	}
}

675 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

677 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

678 
Êags
;

680 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

682 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

683 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	}
}

687 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

691 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

693 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

696 
	}
}

698 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

700 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

701 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

702 
ªt
 = 0;

704 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

705 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

707 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

708 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

710 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

711 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

712 
mˇ°
->
mcmembî
.
mgid
.
øw
);

715 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

716 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

717 i‡(
ªt
)

718 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

719 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

720 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

724 
	}
}

730 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

731 
li°_hód
 *
ªmove_li°
)

734 i‡(*
mgid
 == 0xff) {

735 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

737 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

738 
	`li°_dñ
(&
mˇ°
->
li°
);

739 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

740 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

743 
	}
}

745 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

747 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

753 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

754 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

755 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

757 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

758 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

759 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

761 
	}
}

763 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

765 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

766 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

767 
ùoib_mˇ°
 *
mˇ°
;

768 
Êags
;

769 *
mgid
 = 
daddr
 + 4;

771 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

773 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

774 !
¥iv
->
brﬂdˇ°
 ||

775 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

776 ++
dev
->
°©s
.
tx_dr›≥d
;

777 
	`dev_k‰ì_skb_™y
(
skb
);

778 
u∆ock
;

781 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

782 i‡(!
mˇ°
 || !mˇ°->
ah
) {

783 i‡(!
mˇ°
) {

785 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

786 
mgid
);

788 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

789 i‡(!
mˇ°
) {

790 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

792 ++
dev
->
°©s
.
tx_dr›≥d
;

793 
	`dev_k‰ì_skb_™y
(
skb
);

794 
u∆ock
;

797 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

798 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

799  (
ib_gid
));

800 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

801 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

803 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

805 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

806 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

808 ++
dev
->
°©s
.
tx_dr›≥d
;

809 
	`dev_k‰ì_skb_™y
(
skb
);

811 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

812 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

815 
ùoib_√igh
 *
√igh
;

817 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

818 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

819 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

820 i‡(!
√igh
) {

821 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

825 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

826 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

827 
√igh
->
ah
 = 
mˇ°
->ah;

828 
√igh
->
ah
->
vÆid
 = 1;

829 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

832 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

833 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

834 
IB_MULTICAST_QPN
);

835 i‡(
√igh
)

836 
	`ùoib_√igh_put
(
√igh
);

840 
u∆ock
:

841 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

842 
	}
}

844 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

846 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

847 
	`LIST_HEAD
(
ªmove_li°
);

848 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

849 
Êags
;

851 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

852 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

854 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

856 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

857 
	`li°_dñ
(&
mˇ°
->
li°
);

858 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

859 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

862 i‡(
¥iv
->
brﬂdˇ°
) {

863 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

864 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

865 
¥iv
->
brﬂdˇ°
 = 
NULL
;

868 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

870 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

871 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

872 
	}
}

874 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

877 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

880 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

883 
	}
}

885 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

887 
ùoib_dev_¥iv
 *
¥iv
 =

888 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

889 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

890 
√tdev_hw_addr
 *
ha
;

891 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

892 
	`LIST_HEAD
(
ªmove_li°
);

893 
ib_ß_mcmembî_ªc
 
ªc
;

895 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

902 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

904 
	`√tif_addr_lock_bh
(
dev
);

905 
	`•ö_lock_úq
(&
¥iv
->
lock
);

914 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

915 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

918 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

919 
ib_gid
 
mgid
;

921 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

924 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

926 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

927 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

928 
ùoib_mˇ°
 *
nmˇ°
;

931 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

932 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

933 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

934 
mgid
.
øw
);

939 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

940 
mgid
.
øw
);

942 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

943 i‡(!
nmˇ°
) {

944 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

948 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

950 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

952 i‡(
mˇ°
) {

954 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

956 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

957 &
nmˇ°
->
rb_node
,

958 &
¥iv
->
mu…iˇ°_åì
);

960 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

962 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

965 i‡(
mˇ°
)

966 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

970 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

971 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

972 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

973 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

974 
mˇ°
->
mcmembî
.
mgid
.
øw
);

976 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

979 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

983 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

984 
	`√tif_addr_u∆ock_bh
(
dev
);

986 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

991 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

992 
	`•ö_lock_úq
(&
¥iv
->
lock
);

993 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

994 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

996 
	}
}

998 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1000 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1002 
ùoib_mˇ°_ôî
 *
ôî
;

1004 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1005 i‡(!
ôî
)

1006  
NULL
;

1008 
ôî
->
dev
 = dev;

1009 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1011 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1012 
	`k‰ì
(
ôî
);

1013  
NULL
;

1016  
ôî
;

1017 
	}
}

1019 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1021 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1022 
rb_node
 *
n
;

1023 
ùoib_mˇ°
 *
mˇ°
;

1024 
ªt
 = 1;

1026 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1028 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1030 
n
) {

1031 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1033 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1034  (
ib_gid
)) < 0) {

1035 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1036 
ôî
->
¸óãd
 = 
mˇ°
->created;

1037 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1038 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1039 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1041 
ªt
 = 0;

1046 
n
 = 
	`rb_√xt
(n);

1049 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1051  
ªt
;

1052 
	}
}

1054 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1055 
ib_gid
 *
mgid
,

1056 *
¸óãd
,

1057 *
queuñí
,

1058 *
com∂ëe
,

1059 *
£nd_⁄ly
)

1061 *
mgid
 = 
ôî
->mgid;

1062 *
¸óãd
 = 
ôî
->created;

1063 *
queuñí
 = 
ôî
->queuelen;

1064 *
com∂ëe
 = 
ôî
->complete;

1065 *
£nd_⁄ly
 = 
ôî
->send_only;

1066 
	}
}

	@RHEL77/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
,

68 
∆©å
 *
tb
[], ∆©å *
d©a
[])

70 
u16
 
mode
, 
umˇ°
;

71 
ªt
 = 0;

73 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

74 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

75 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

76 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

77 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

78 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

80 
ªt
 = -
EINVAL
;

82 i‡(
ªt
 < 0)

83 
out_îr
;

86 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

87 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

88 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

91 
out_îr
:

92  
ªt
;

93 
	}
}

95 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

96 
∆©å
 *
tb
[], ∆©å *
d©a
[])

98 
√t_devi˚
 *
pdev
;

99 
ùoib_dev_¥iv
 *
µriv
;

100 
u16
 
chûd_pkey
;

101 
îr
;

103 i‡(!
tb
[
IFLA_LINK
])

104  -
EINVAL
;

106 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

107 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

108  -
ENODEV
;

110 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

112 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

113 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

114  -
EINVAL
;

117 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

118 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

119 
chûd_pkey
 = 
µriv
->
pkey
;

121 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

123 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

124 i‡(
îr
) {

125 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

126  
îr
;

129 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

130 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

131 i‡(
îr
)

132  
îr
;

134 i‡(
d©a
) {

135 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
);

136 i‡(
îr
) {

137 
	`uƒegi°î_√tdevi˚
(
dev
);

138  
îr
;

143 
	}
}

145 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

147  
	`∆a_tŸÆ_size
(2) +

148 
	`∆a_tŸÆ_size
(2) +

149 
	`∆a_tŸÆ_size
(2);

150 
	}
}

152 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

153 .
köd
 = "ipoib",

154 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

155 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

156 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

157 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

158 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

159 .
	gch™gñök
 = 
ùoib_ch™gñök
,

160 .
	ggë_size
 = 
ùoib_gë_size
,

161 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

164 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

166  &
ùoib_lök_›s
;

167 
	}
}

169 
__öô
 
	$ùoib_√éök_öô
()

171  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

172 
	}
}

174 
__exô
 
	$ùoib_√éök_föi
()

176 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

177 
	}
}

179 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL77/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@RHEL77/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

35 
	~<löux/öô.h
>

36 
	~<löux/£q_fûe.h
>

38 
	~<löux/uac˚ss.h
>

40 
	~"ùoib.h
"

42 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

43 *
buf
)

45 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

46 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

49 
	}
}

50 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

52 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

53 
ùoib_dev_¥iv
 *
¥iv
)

55 
ùoib_dev_¥iv
 *
çriv
;

57 
	`ASSERT_RTNL
();

65 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

66  
åue
;

73 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

74  
Ál£
;

76 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

77 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

78 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

79  
Ál£
;

82  
åue
;

83 
	}
}

94 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

95 
u16
 
pkey
, 
ty≥
)

97 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

98 
ªsu…
;

100 
	`ASSERT_RTNL
();

106 
ndev
->
exãnded
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

112 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

114 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

115 
ªsu…
 = -
EINVAL
;

116 
out_óæy
;

119 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

120 
¥iv
->
pkey
 =Ökey;

121 
¥iv
->
chûd_ty≥
 = 
ty≥
;

123 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

124 
ªsu…
 = -
ENOTUNIQ
;

125 
out_óæy
;

128 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

129 i‡(
ªsu…
) {

130 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

136 
out_óæy
;

140 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

141 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

142 
sysfs_Áûed
;

143 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

144 
sysfs_Áûed
;

145 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

146 
sysfs_Áûed
;

148 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

149 
sysfs_Áûed
;

154 
sysfs_Áûed
:

155 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

156  -
ENOMEM
;

158 
out_óæy
:

159 i‡(
ndev
->
exãnded
->
¥iv_de°ru˘‹
)

160 
ndev
->
exãnded
->
	`¥iv_de°ru˘‹
(ndev);

161  
ªsu…
;

162 
	}
}

164 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

166 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

167 
ötf_«me
[
IFNAMSIZ
];

168 
√t_devi˚
 *
ndev
;

169 
ªsu…
;

171 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

172  -
EPERM
;

174 i‡(!
	`π∆_åylock
())

175  
	`ª°¨t_sysˇŒ
();

177 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

178 
	`π∆_u∆ock
();

179  -
EPERM
;

182 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

184 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

185 
µriv
->
dev
->
«me
, 
pkey
);

187 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

188 i‡(
	`IS_ERR
(
ndev
)) {

189 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

190 
out
;

192 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

194 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

196 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

197 
	`‰ì_√tdev
(
ndev
);

199 
out
:

200 
	`π∆_u∆ock
();

202  
ªsu…
;

203 
	}
}

205 
	sùoib_vœn_dñëe_w‹k
 {

206 
w‹k_°ru˘
 
	mw‹k
;

207 
√t_devi˚
 *
	mdev
;

220 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

222 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

223 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

224 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

226 
	`π∆_lock
();

229 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

233 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

234 
	`uƒegi°î_√tdevi˚
(
dev
);

237 
	`π∆_u∆ock
();

239 
	`k‰ì
(
pw‹k
);

240 
	}
}

242 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

244 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

245 
rc
;

247 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

248  -
EPERM
;

250 i‡(!
	`π∆_åylock
())

251  
	`ª°¨t_sysˇŒ
();

253 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

254 
	`π∆_u∆ock
();

255  -
EPERM
;

258 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

260 
rc
 = -
ENODEV
;

261 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

262 i‡(
¥iv
->
pkey
 ==Ökey &&

263 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

264 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

266 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

267 i‡(!
w‹k
) {

268 
rc
 = -
ENOMEM
;

269 
out
;

272 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

273 
	`li°_dñ_öô
(&
¥iv
->
li°
);

274 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

275 
w‹k
->
dev
 = 
¥iv
->dev;

276 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

277 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

279 
rc
 = 0;

284 
out
:

285 
	`π∆_u∆ock
();

287  
rc
;

288 
	}
}

	@RHEL80/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
ENOSYS
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

	@RHEL80/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
ib_ªcv_wr
 *
bad_wr
;

98 
i
, 
ªt
;

100 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

102 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

103 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

105 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, &
bad_wr
);

106 i‡(
	`u∆ikñy
(
ªt
)) {

107 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

108 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

109 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

110 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

111 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

114  
ªt
;

115 
	}
}

117 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

118 
ùoib_cm_rx
 *
rx
,

119 
ib_ªcv_wr
 *
wr
,

120 
ib_sge
 *
sge
, 
id
)

122 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

123 
ib_ªcv_wr
 *
bad_wr
;

124 
i
, 
ªt
;

126 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

128 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

129 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

131 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, &
bad_wr
);

132 i‡(
	`u∆ikñy
(
ªt
)) {

133 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

134 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

135 
rx
->
rx_rög
[
id
].
m≠pög
);

136 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

137 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

140  
ªt
;

141 
	}
}

143 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

144 
ùoib_cm_rx_buf
 *
rx_rög
,

145 
id
, 
‰ags
,

146 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

147 
gÂ_t
 
gÂ
)

149 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

150 
sk_buff
 *
skb
;

151 
i
;

153 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

154 i‡(
	`u∆ikñy
(!
skb
))

155  
NULL
;

161 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

163 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

164 
DMA_FROM_DEVICE
);

165 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

166 
	`dev_k‰ì_skb_™y
(
skb
);

167  
NULL
;

170 
i
 = 0; i < 
‰ags
; i++) {

171 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

173 i‡(!
∑ge
)

174 
∑πül_îr‹
;

175 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

177 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

178 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

179 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

180 
∑πül_îr‹
;

183 
rx_rög
[
id
].
skb
 = skb;

184  
skb
;

186 
∑πül_îr‹
:

188 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

190 ; 
i
 > 0; --i)

191 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

193 
	`dev_k‰ì_skb_™y
(
skb
);

194  
NULL
;

195 
	}
}

197 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

198 
ùoib_cm_rx_buf
 *
rx_rög
)

200 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

201 
i
;

203 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

204 i‡(
rx_rög
[
i
].
skb
) {

205 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

206 
rx_rög
[
i
].
m≠pög
);

207 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

210 
	`v‰ì
(
rx_rög
);

211 
	}
}

213 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

215 
ib_£nd_wr
 *
bad_wr
;

216 
ùoib_cm_rx
 *
p
;

220 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

221 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

228 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

229 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

230 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, &
bad_wr
))

231 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

233 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

234 
	}
}

236 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

238 
ùoib_cm_rx
 *
p
 = 
˘x
;

239 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

240 
Êags
;

242 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

245 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

246 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

247 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

248 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

249 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

250 
	}
}

252 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

253 
ùoib_cm_rx
 *
p
)

255 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

256 
ib_qp_öô_©å
 
©å
 = {

257 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

258 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

259 .
ªcv_cq
 = 
¥iv
->recv_cq,

260 .
§q
 = 
¥iv
->
cm
.srq,

261 .
ˇp
.
max_£nd_wr
 = 1,

262 .
ˇp
.
max_£nd_sge
 = 1,

263 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

264 .
qp_ty≥
 = 
IB_QPT_RC
,

265 .
qp_c⁄ãxt
 = 
p
,

268 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

269 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

270 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

273  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

274 
	}
}

276 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

277 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

278 
p¢
)

280 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

281 
ib_qp_©å
 
qp_©å
;

282 
qp_©å_mask
, 
ªt
;

284 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

285 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

286 i‡(
ªt
) {

287 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

288  
ªt
;

290 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

291 i‡(
ªt
) {

292 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

293  
ªt
;

295 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

296 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

297 i‡(
ªt
) {

298 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

299  
ªt
;

301 
qp_©å
.
rq_p¢
 = 
p¢
;

302 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

303 i‡(
ªt
) {

304 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

305  
ªt
;

316 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

317 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

318 i‡(
ªt
) {

319 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

322 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

323 i‡(
ªt
) {

324 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

329 
	}
}

331 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

332 
ib_ªcv_wr
 *
wr
,

333 
ib_sge
 *
sge
)

335 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

336 
i
;

338 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

339 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

341 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

342 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

343 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

345 
wr
->
√xt
 = 
NULL
;

346 
wr
->
sg_li°
 = 
sge
;

347 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

348 
	}
}

350 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

351 
ùoib_cm_rx
 *
rx
)

353 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

355 
ib_ªcv_wr
 
wr
;

356 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

357 } *
t
;

358 
ªt
;

359 
i
;

361 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

362 (*
rx
->
rx_rög
)));

363 i‡(!
rx
->
rx_rög
)

364  -
ENOMEM
;

366 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

367 i‡(!
t
) {

368 
ªt
 = -
ENOMEM
;

369 
îr_‰ì_1
;

372 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

374 
	`•ö_lock_úq
(&
¥iv
->
lock
);

376 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

377 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

378 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

379 
ªt
 = -
EINVAL
;

380 
îr_‰ì
;

382 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

384 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

386 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

387 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

388 
rx
->
rx_rög
[
i
].
m≠pög
,

389 
GFP_KERNEL
)) {

390 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

391 
ªt
 = -
ENOMEM
;

392 
îr_cou¡
;

394 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

395 i‡(
ªt
) {

396 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

397 "Áûed f‹ bu‡%d\n", 
i
);

398 
ªt
 = -
EIO
;

399 
îr_cou¡
;

403 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

405 
	`k‰ì
(
t
);

409 
îr_cou¡
:

410 
	`•ö_lock_úq
(&
¥iv
->
lock
);

411 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

412 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

414 
îr_‰ì
:

415 
	`k‰ì
(
t
);

417 
îr_‰ì_1
:

418 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

420  
ªt
;

421 
	}
}

423 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

424 
ib_qp
 *
qp
, 
ib_cm_ªq_evít_∑øm
 *
ªq
,

425 
p¢
)

427 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

428 
ùoib_cm_d©a
 
d©a
 = {};

429 
ib_cm_ªp_∑øm
 
ªp
 = {};

431 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

432 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

434 
ªp
.
¥iv©e_d©a
 = &
d©a
;

435 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

436 
ªp
.
Êow_c⁄åﬁ
 = 0;

437 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

438 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

439 
ªp
.
qp_num
 = 
qp
->qp_num;

440 
ªp
.
°¨tög_p¢
 = 
p¢
;

441  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

442 
	}
}

444 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

446 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

447 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

448 
ùoib_cm_rx
 *
p
;

449 
p¢
;

450 
ªt
;

452 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

453 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

454 i‡(!
p
)

455  -
ENOMEM
;

456 
p
->
dev
 = dev;

457 
p
->
id
 = 
cm_id
;

458 
cm_id
->
c⁄ãxt
 = 
p
;

459 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

460 
p
->
jiffõs
 = jiffies;

461 
	`INIT_LIST_HEAD
(&
p
->
li°
);

463 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

464 i‡(
	`IS_ERR
(
p
->
qp
)) {

465 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

466 
îr_qp
;

469 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

470 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

471 i‡(
ªt
)

472 
îr_modify
;

474 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

475 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

476 i‡(
ªt
)

477 
îr_modify
;

480 
	`•ö_lock_úq
(&
¥iv
->
lock
);

481 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

482 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

485 
p
->
jiffõs
 = jiffies;

486 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

487 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

488 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

490 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

491 i‡(
ªt
) {

492 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

493 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

494 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

498 
îr_modify
:

499 
	`ib_de°roy_qp
(
p
->
qp
);

500 
îr_qp
:

501 
	`k‰ì
(
p
);

502  
ªt
;

503 
	}
}

505 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

506 
ib_cm_evít
 *
evít
)

508 
ùoib_cm_rx
 *
p
;

509 
ùoib_dev_¥iv
 *
¥iv
;

511 
evít
->event) {

512 
IB_CM_REQ_RECEIVED
:

513  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

514 
IB_CM_DREQ_RECEIVED
:

515 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

517 
IB_CM_REJ_RECEIVED
:

518 
p
 = 
cm_id
->
c⁄ãxt
;

519 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

520 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

521 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

526 
	}
}

528 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

529 
Àngth
, 
sk_buff
 *
toskb
)

531 
i
, 
num_‰ags
;

532 
size
;

535 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

536 
skb
->
èû
 +
size
;

537 
skb
->
Àn
 +
size
;

538 
Àngth
 -
size
;

540 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

541 
i
 = 0; i < 
num_‰ags
; i++) {

542 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

544 i‡(
Àngth
 == 0) {

546 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

547 0, 
PAGE_SIZE
);

548 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

550 
size
 = 
	`mö
(
Àngth
, (Ë
PAGE_SIZE
);

552 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

553 
skb
->
d©a_Àn
 +
size
;

554 
skb
->
åuesize
 +
size
;

555 
skb
->
Àn
 +
size
;

556 
Àngth
 -
size
;

559 
	}
}

561 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

563 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

564 
ùoib_cm_rx_buf
 *
rx_rög
;

565 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

566 
sk_buff
 *
skb
, *
√wskb
;

567 
ùoib_cm_rx
 *
p
;

568 
Êags
;

569 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

570 
‰ags
;

571 
has_§q
;

572 
sk_buff
 *
smÆl_skb
;

574 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

575 
wr_id
, 
wc
->
°©us
);

577 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

578 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

579 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

580 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

581 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

582 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

583 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

585 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

586 
wr_id
, 
ùoib_ªcvq_size
);

590 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

592 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

593 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

595 
skb
 = 
rx_rög
[
wr_id
].skb;

597 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

598 
	`ùoib_dbg
(
¥iv
,

600 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

601 ++
dev
->
°©s
.
rx_dr›≥d
;

602 i‡(
has_§q
)

603 
ªpo°
;

605 i‡(!--
p
->
ªcv_cou¡
) {

606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

607 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

608 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

609 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

615 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

616 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

617 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

618 
p
->
jiffõs
 = jiffies;

621 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

622 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

623 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

627 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

628 
dÀn
 = 
wc
->
byã_Àn
;

630 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

631 i‡(
smÆl_skb
) {

632 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

633 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

634 
dÀn
, 
DMA_FROM_DEVICE
);

635 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

636 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

637 
dÀn
, 
DMA_FROM_DEVICE
);

638 
	`skb_put
(
smÆl_skb
, 
dÀn
);

639 
skb
 = 
smÆl_skb
;

640 
c›õd
;

644 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 - 
	`mö
(wc->byte_len,

645 ()
IPOIB_CM_HEAD_SIZE
)Ë/ 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
ib_£nd_wr
 *
bad_wr
;

703 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

705 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

707  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, &
bad_wr
);

708 
	}
}

710 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

712 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

713 
ùoib_tx_buf
 *
tx_ªq
;

714 
rc
;

715 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

717 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

718 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

719 
skb
->
Àn
, 
tx
->
mtu
);

720 ++
dev
->
°©s
.
tx_dr›≥d
;

721 ++
dev
->
°©s
.
tx_îr‹s
;

722 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

725 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

726 i‡(
	`skb_löórize
(
skb
) < 0) {

727 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

728 ++
dev
->
°©s
.
tx_dr›≥d
;

729 ++
dev
->
°©s
.
tx_îr‹s
;

730 
	`dev_k‰ì_skb_™y
(
skb
);

734 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

735 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

736 ++
dev
->
°©s
.
tx_dr›≥d
;

737 ++
dev
->
°©s
.
tx_îr‹s
;

738 
	`dev_k‰ì_skb_™y
(
skb
);

742 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

743 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

752 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

753 
tx_ªq
->
skb
 = skb;

755 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

756 ++
dev
->
°©s
.
tx_îr‹s
;

757 
	`dev_k‰ì_skb_™y
(
skb
);

761 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

762 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

763 
tx
->
qp
->
qp_num
);

764 
	`√tif_°›_queue
(
dev
);

767 
	`skb_‹ph™
(
skb
);

768 
	`skb_d°_dr›
(
skb
);

770 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

771 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

772 
IB_CQ_REPORT_MISSED_EVENTS
);

773 i‡(
	`u∆ikñy
(
rc
 < 0))

774 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

775 i‡(
rc
)

776 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

779 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

780 i‡(
	`u∆ikñy
(
rc
)) {

781 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

782 ++
dev
->
°©s
.
tx_îr‹s
;

783 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

784 
	`dev_k‰ì_skb_™y
(
skb
);

786 i‡(
	`√tif_queue_°›≥d
(
dev
))

787 
	`√tif_wake_queue
(
dev
);

789 
	`√tif_å™s_upd©e
(
dev
);

790 ++
tx
->
tx_hód
;

791 ++
¥iv
->
tx_hód
;

793 
	}
}

795 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

797 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

798 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

799 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

800 
ùoib_tx_buf
 *
tx_ªq
;

801 
Êags
;

803 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

804 
wr_id
, 
wc
->
°©us
);

806 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

807 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

808 
wr_id
, 
ùoib_£ndq_size
);

812 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

814 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

817 ++
dev
->
°©s
.
tx_∑ckës
;

818 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

820 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

822 
	`√tif_tx_lock
(
dev
);

824 ++
tx
->
tx_èû
;

825 ++
¥iv
->
tx_èû
;

827 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

828 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

829 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

830 
	`√tif_wake_queue
(
dev
);

832 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

833 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

834 
ùoib_√igh
 *
√igh
;

839 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

840 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

841 
	`ùoib_dbg
(
¥iv
,

843 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

845 
	`ùoib_w¨n
(
¥iv
,

847 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

849 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

850 
√igh
 = 
tx
->neigh;

852 i‡(
√igh
) {

853 
√igh
->
cm
 = 
NULL
;

854 
	`ùoib_√igh_‰ì
(
√igh
);

856 
tx
->
√igh
 = 
NULL
;

859 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

860 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

861 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

864 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

866 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

869 
	`√tif_tx_u∆ock
(
dev
);

870 
	}
}

872 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

874 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

875 
ªt
;

877 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

880 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

881 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

882 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

883 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

884 
îr_cm
;

887 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

889 i‡(
ªt
) {

890 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

891 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

892 
îr_li°í
;

897 
îr_li°í
:

898 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

899 
îr_cm
:

900 
¥iv
->
cm
.
id
 = 
NULL
;

901  
ªt
;

902 
	}
}

904 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

906 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

907 
ùoib_cm_rx
 *
rx
, *
n
;

908 
	`LIST_HEAD
(
li°
);

910 
	`•ö_lock_úq
(&
¥iv
->
lock
);

911 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

912 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

914 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

915 
	`ib_de°roy_cm_id
(
rx
->
id
);

916 
	`ib_de°roy_qp
(
rx
->
qp
);

917 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

918 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

919 
	`•ö_lock_úq
(&
¥iv
->
lock
);

920 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

921 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

923 
	`k‰ì
(
rx
);

925 
	}
}

927 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

929 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

930 
ùoib_cm_rx
 *
p
;

931 
begö
;

932 
ªt
;

934 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

937 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

938 
¥iv
->
cm
.
id
 = 
NULL
;

940 
	`•ö_lock_úq
(&
¥iv
->
lock
);

941 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

942 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

943 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

944 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

945 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

946 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

947 i‡(
ªt
)

948 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

949 
	`•ö_lock_úq
(&
¥iv
->
lock
);

953 
begö
 = 
jiffõs
;

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

956 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

957 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

958 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

959 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

968 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

969 &
¥iv
->
cm
.
rx_ª≠_li°
);

972 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

973 
	`u¶ìp_ønge
(1000, 2000);

974 
	`ùoib_døö_cq
(
dev
);

975 
	`•ö_lock_úq
(&
¥iv
->
lock
);

978 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

980 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

982 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

983 
	}
}

985 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

987 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

988 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

989 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

990 
sk_buff_hód
 
skqueue
;

991 
ib_qp_©å
 
qp_©å
;

992 
qp_©å_mask
, 
ªt
;

993 
sk_buff
 *
skb
;

995 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

997 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

998 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

999 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

1000  -
EINVAL
;

1003 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1004 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1005 i‡(
ªt
) {

1006 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1007  
ªt
;

1010 
qp_©å
.
rq_p¢
 = 0 ;

1011 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1012 i‡(
ªt
) {

1013 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1014  
ªt
;

1017 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1018 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1019 i‡(
ªt
) {

1020 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1021  
ªt
;

1023 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1024 i‡(
ªt
) {

1025 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1026  
ªt
;

1029 
	`skb_queue_hód_öô
(&
skqueue
);

1031 
	`√tif_tx_lock_bh
(
p
->
dev
);

1032 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1033 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1034 i‡(
p
->
√igh
)

1035 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1036 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1037 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1038 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1040 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1041 
skb
->
dev
 = 
p
->dev;

1042 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1043 i‡(
ªt
)

1044 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1045 
__func__
, 
ªt
);

1048 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1049 i‡(
ªt
) {

1050 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1051  
ªt
;

1054 
	}
}

1056 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1058 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1059 
ib_qp_öô_©å
 
©å
 = {

1060 .
£nd_cq
 = 
¥iv
->send_cq,

1061 .
ªcv_cq
 = 
¥iv
->recv_cq,

1062 .
§q
 = 
¥iv
->
cm
.srq,

1063 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1064 .
ˇp
.
max_£nd_sge
 = 1,

1065 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1066 .
qp_ty≥
 = 
IB_QPT_RC
,

1067 .
qp_c⁄ãxt
 = 
tx
,

1068 .
¸óã_Êags
 = 0

1070 
ib_qp
 *
tx_qp
;

1072 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1073 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1074 
MAX_SKB_FRAGS
 + 1);

1076 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1077 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1078  
tx_qp
;

1079 
	}
}

1081 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1082 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1083 
u32
 
q≤
,

1084 
ß_∑th_ªc
 *
∑thªc
)

1086 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1087 
ùoib_cm_d©a
 
d©a
 = {};

1088 
ib_cm_ªq_∑øm
 
ªq
 = {};

1090 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1091 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1093 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1094 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1095 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1096 
ªq
.
qp_num
 = 
qp
->qp_num;

1097 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1098 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1099 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1100 
ªq
.
Êow_c⁄åﬁ
 = 0;

1102 
ªq
.
°¨tög_p¢
 = 0;

1108 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1109 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1111 
ªq
.
ªåy_cou¡
 = 0;

1112 
ªq
.
∫r_ªåy_cou¡
 = 0;

1113 
ªq
.
max_cm_ªåõs
 = 15;

1114 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1115  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1116 
	}
}

1118 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1119 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1122 
ib_qp_©å
 
qp_©å
;

1123 
qp_©å_mask
, 
ªt
;

1124 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1125 i‡(
ªt
) {

1126 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1127  
ªt
;

1130 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1131 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1132 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1133 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1135 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1136 i‡(
ªt
) {

1137 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1138  
ªt
;

1141 
	}
}

1143 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1144 
ß_∑th_ªc
 *
∑thªc
)

1146 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1147 
noio_Êag
;

1148 
ªt
;

1150 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1151 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1152 i‡(!
p
->
tx_rög
) {

1153 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1154 
ªt
 = -
ENOMEM
;

1155 
îr_tx
;

1158 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1159 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1160 i‡(
	`IS_ERR
(
p
->
qp
)) {

1161 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1162 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1163 
îr_qp
;

1166 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1167 i‡(
	`IS_ERR
(
p
->
id
)) {

1168 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1169 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1170 
îr_id
;

1173 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1174 i‡(
ªt
) {

1175 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1176 
îr_modify_£nd
;

1179 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1180 i‡(
ªt
) {

1181 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1182 
îr_modify_£nd
;

1185 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1186 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1190 
îr_modify_£nd
:

1191 
	`ib_de°roy_cm_id
(
p
->
id
);

1192 
îr_id
:

1193 
p
->
id
 = 
NULL
;

1194 
	`ib_de°roy_qp
(
p
->
qp
);

1195 
îr_qp
:

1196 
p
->
qp
 = 
NULL
;

1197 
	`v‰ì
(
p
->
tx_rög
);

1198 
îr_tx
:

1199  
ªt
;

1200 
	}
}

1202 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1204 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1205 
ùoib_tx_buf
 *
tx_ªq
;

1206 
begö
;

1208 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1209 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1211 i‡(
p
->
id
)

1212 
	`ib_de°roy_cm_id
(
p
->
id
);

1214 i‡(
p
->
tx_rög
) {

1216 
begö
 = 
jiffõs
;

1217 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1218 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1219 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1220 
p
->
tx_hód
 -Ö->
tx_èû
);

1221 
timeout
;

1224 
	`u¶ìp_ønge
(1000, 2000);

1228 
timeout
:

1230 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1231 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1232 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1233 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1234 
	`√tif_tx_lock_bh
(
p
->
dev
);

1235 ++
p
->
tx_èû
;

1236 ++
¥iv
->
tx_èû
;

1237 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1238 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1239 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1240 
	`√tif_wake_queue
(
p
->
dev
);

1241 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1244 i‡(
p
->
qp
)

1245 
	`ib_de°roy_qp
(
p
->
qp
);

1247 
	`v‰ì
(
p
->
tx_rög
);

1248 
	`k‰ì
(
p
);

1249 
	}
}

1251 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1252 
ib_cm_evít
 *
evít
)

1254 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1255 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1256 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1257 
ùoib_√igh
 *
√igh
;

1258 
Êags
;

1259 
ªt
;

1261 
evít
->event) {

1262 
IB_CM_DREQ_RECEIVED
:

1263 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1264 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1266 
IB_CM_REP_RECEIVED
:

1267 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1268 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1269 i‡(
ªt
)

1270 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1271 
NULL
, 0, NULL, 0);

1273 
IB_CM_REQ_ERROR
:

1274 
IB_CM_REJ_RECEIVED
:

1275 
IB_CM_TIMEWAIT_EXIT
:

1276 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1277 
	`√tif_tx_lock_bh
(
dev
);

1278 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1279 
√igh
 = 
tx
->neigh;

1281 i‡(
√igh
) {

1282 
√igh
->
cm
 = 
NULL
;

1283 
	`ùoib_√igh_‰ì
(
√igh
);

1285 
tx
->
√igh
 = 
NULL
;

1288 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1289 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1290 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1293 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1294 
	`√tif_tx_u∆ock_bh
(
dev
);

1301 
	}
}

1303 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1304 
ùoib_√igh
 *
√igh
)

1306 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1307 
ùoib_cm_tx
 *
tx
;

1309 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1310 i‡(!
tx
)

1311  
NULL
;

1313 
√igh
->
cm
 = 
tx
;

1314 
tx
->
√igh
 =Çeigh;

1315 
tx
->
dev
 = dev;

1316 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1317 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1318 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1319  
tx
;

1320 
	}
}

1322 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1324 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1325 
Êags
;

1326 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1327 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1328 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1329 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1330 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1331 
tx
->
√igh
->
daddr
 + 4);

1332 
tx
->
√igh
 = 
NULL
;

1333 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1335 
	}
}

1337 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1339 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1341 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1342 
cm
.
°¨t_èsk
);

1343 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1344 
ùoib_√igh
 *
√igh
;

1345 
ùoib_cm_tx
 *
p
;

1346 
Êags
;

1347 
ùoib_∑th
 *
∑th
;

1348 
ªt
;

1350 
ß_∑th_ªc
 
∑thªc
;

1351 
u32
 
q≤
;

1353 
	`√tif_tx_lock_bh
(
dev
);

1354 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1356 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1357 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1358 
	`li°_dñ_öô
(&
p
->
li°
);

1359 
√igh
 = 
p
->neigh;

1361 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1366 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1367 i‡(!
∑th
) {

1368 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1369 
__func__
,

1370 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1371 
‰ì_√igh
;

1373 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1375 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1376 
	`√tif_tx_u∆ock_bh
(
dev
);

1378 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1380 
	`√tif_tx_lock_bh
(
dev
);

1381 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1383 i‡(
ªt
) {

1384 
‰ì_√igh
:

1385 
√igh
 = 
p
->neigh;

1386 i‡(
√igh
) {

1387 
√igh
->
cm
 = 
NULL
;

1388 
	`ùoib_√igh_‰ì
(
√igh
);

1390 
	`li°_dñ
(&
p
->
li°
);

1391 
	`k‰ì
(
p
);

1395 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1396 
	`√tif_tx_u∆ock_bh
(
dev
);

1397 
	}
}

1399 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1401 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1402 
cm
.
ª≠_èsk
);

1403 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1404 
ùoib_cm_tx
 *
p
;

1405 
Êags
;

1407 
	`√tif_tx_lock_bh
(
dev
);

1408 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1410 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1411 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1412 
	`li°_dñ_öô
(&
p
->
li°
);

1413 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1414 
	`√tif_tx_u∆ock_bh
(
dev
);

1415 
	`ùoib_cm_tx_de°roy
(
p
);

1416 
	`√tif_tx_lock_bh
(
dev
);

1417 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1420 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1421 
	`√tif_tx_u∆ock_bh
(
dev
);

1422 
	}
}

1424 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1426 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1427 
cm
.
skb_èsk
);

1428 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1429 
sk_buff
 *
skb
;

1430 
Êags
;

1431 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1433 
	`√tif_tx_lock_bh
(
dev
);

1434 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1436 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1437 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1438 
	`√tif_tx_u∆ock_bh
(
dev
);

1440 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1441 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1442 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1444 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1445 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1446 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1447 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 
	`√tif_tx_lock_bh
(
dev
);

1453 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1456 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1457 
	`√tif_tx_u∆ock_bh
(
dev
);

1458 
	}
}

1460 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1461 
mtu
)

1463 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1464 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1466 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1468 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1469 i‡(
e
)

1470 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1471 
	}
}

1473 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1475 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1476 
cm
.
rx_ª≠_èsk
)->
dev
);

1477 
	}
}

1479 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1481 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1482 
cm
.
°Æe_èsk
.
w‹k
);

1483 
ùoib_cm_rx
 *
p
;

1484 
ªt
;

1486 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1487 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1490 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1491 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1493 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1494 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1495 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1496 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1497 i‡(
ªt
)

1498 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1499 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1502 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1503 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1504 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1505 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1506 
	}
}

1508 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1509 *
buf
)

1511 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1512 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1514 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1515  
	`•rötf
(
buf
, "connected\n");

1517  
	`•rötf
(
buf
, "datagram\n");

1518 
	}
}

1520 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1521 c⁄° *
buf
, 
size_t
 
cou¡
)

1523 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1524 
ªt
;

1526 i‡(!
	`π∆_åylock
()) {

1527  
	`ª°¨t_sysˇŒ
();

1530 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1531 
	`π∆_u∆ock
();

1532  -
EPERM
;

1535 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1541 i‡(
ªt
 !-
EBUSY
)

1542 
	`π∆_u∆ock
();

1544  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1545 
	}
}

1547 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1549 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1551  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1552 
	}
}

1554 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1556 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1557 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1558 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1559 .
©å
 = {

1560 .
max_wr
 = 
ùoib_ªcvq_size
,

1561 .
max_sge
 = max_sge

1565 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1566 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1567 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
ENOSYS
)

1568 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1569 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1570 
¥iv
->
cm
.
§q
 = 
NULL
;

1574 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1575 (*
¥iv
->
cm
.
§q_rög
)));

1576 i‡(!
¥iv
->
cm
.
§q_rög
) {

1577 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1578 
¥iv
->
cm
.
§q
 = 
NULL
;

1582 
	}
}

1584 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1586 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1587 
max_§q_sge
, 
i
;

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1595 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1599 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1600 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1602 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1604 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1606 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1607 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1608 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1609 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1610 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1611 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1612 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1614 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1615 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1618 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1620 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1621 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1622 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1623 
¥iv
->
cm
.
num_‰ags
 - 1,

1624 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1625 
GFP_KERNEL
)) {

1626 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1627 "ª˚ivêbuf„∏%d\n", 
i
);

1628 
	`ùoib_cm_dev_˛ónup
(
dev
);

1629  -
ENOMEM
;

1632 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1633 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1634 "Áûed f‹ bu‡%d\n", 
i
);

1635 
	`ùoib_cm_dev_˛ónup
(
dev
);

1636  -
EIO
;

1641 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1643 
	}
}

1645 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1647 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1648 
ªt
;

1650 i‡(!
¥iv
->
cm
.
§q
)

1653 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1655 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1656 i‡(
ªt
)

1657 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1659 
¥iv
->
cm
.
§q
 = 
NULL
;

1660 i‡(!
¥iv
->
cm
.
§q_rög
)

1663 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1664 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1665 
	}
}

	@RHEL80/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

141 
ETH_SS_TEST
:

145 
	}
}

146 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

147 
s£t
)

149 
s£t
) {

150 
ETH_SS_STATS
:

151  
IPOIB_GLOBAL_STATS_LEN
;

152 
ETH_SS_TEST
:

156  -
EOPNOTSUPP
;

157 
	}
}

160 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

162 
•ìd
) {

163 
IB_SPEED_SDR
:

164  
SPEED_2500
;

165 
IB_SPEED_DDR
:

166  
SPEED_5000
;

167 
IB_SPEED_QDR
:

168 
IB_SPEED_FDR10
:

169  
SPEED_10000
;

170 
IB_SPEED_FDR
:

171  
SPEED_14000
;

172 
IB_SPEED_EDR
:

173  
SPEED_25000
;

176  
SPEED_UNKNOWN
;

177 
	}
}

179 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

180 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

183 
ib_p‹t_©å
 
©å
;

184 
ªt
, 
•ìd
, 
width
;

186 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

187 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

188 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

192 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

193 i‡(
ªt
 < 0)

194  -
EINVAL
;

196 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

197 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

199 i‡(
•ìd
 < 0 || 
width
 < 0)

200  -
EINVAL
;

206 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

207 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

209 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

211 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

212 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

215 
	}
}

217 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

218 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

219 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

220 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

221 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

222 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

223 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

224 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

227 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

229 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

230 
	}
}

	@RHEL80/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@RHEL80/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

44 
	~"ùoib.h
"

46 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


47 
	gd©a_debug_Àvñ
;

49 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

50 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

54 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

55 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

57 
ùoib_ah
 *
ah
;

58 
ib_ah
 *
vah
;

60 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

61 i‡(!
ah
)

62  
	`ERR_PTR
(-
ENOMEM
);

64 
ah
->
dev
 = dev;

65 
ah
->
œ°_£nd
 = 0;

66 
	`kªf_öô
(&
ah
->
ªf
);

68 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

69 i‡(
	`IS_ERR
(
vah
)) {

70 
	`k‰ì
(
ah
);

71 
ah
 = (
ùoib_ah
 *)
vah
;

73 
ah
->ah = 
vah
;

74 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

77  
ah
;

78 
	}
}

80 
	$ùoib_‰ì_ah
(
kªf
 *kref)

82 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

83 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

85 
Êags
;

87 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

88 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

89 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

90 
	}
}

92 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

93 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

95 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

96 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

97 
DMA_FROM_DEVICE
);

98 
	}
}

100 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

103 
ib_ªcv_wr
 *
bad_wr
;

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, &
bad_wr
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
ib_£nd_wr
 *
bad_wr
;

545 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

547 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

549 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

550 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

551 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

553 i‡(
hód
) {

554 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

555 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

556 
¥iv
->
tx_wr
.
hÀn
 = hlen;

557 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

559 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

561  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, &
bad_wr
);

562 
	}
}

564 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

565 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

567 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

568 
ùoib_tx_buf
 *
tx_ªq
;

569 
hÀn
, 
rc
;

570 *
phód
;

571 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

573 i‡(
	`skb_is_gso
(
skb
)) {

574 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

575 
phód
 = 
skb
->
d©a
;

576 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

577 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

578 ++
dev
->
°©s
.
tx_dr›≥d
;

579 ++
dev
->
°©s
.
tx_îr‹s
;

580 
	`dev_k‰ì_skb_™y
(
skb
);

584 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

585 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

586 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

587 ++
dev
->
°©s
.
tx_dr›≥d
;

588 ++
dev
->
°©s
.
tx_îr‹s
;

589 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

592 
phód
 = 
NULL
;

593 
hÀn
 = 0;

595 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

596 i‡(
	`skb_löórize
(
skb
) < 0) {

597 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

598 ++
dev
->
°©s
.
tx_dr›≥d
;

599 ++
dev
->
°©s
.
tx_îr‹s
;

600 
	`dev_k‰ì_skb_™y
(
skb
);

604 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

605 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

606 ++
dev
->
°©s
.
tx_dr›≥d
;

607 ++
dev
->
°©s
.
tx_îr‹s
;

608 
	`dev_k‰ì_skb_™y
(
skb
);

613 
	`ùoib_dbg_d©a
(
¥iv
,

615 
skb
->
Àn
, 
addªss
, 
dq≤
);

624 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

625 
tx_ªq
->
skb
 = skb;

626 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

627 ++
dev
->
°©s
.
tx_îr‹s
;

628 
	`dev_k‰ì_skb_™y
(
skb
);

632 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

633 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

635 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

637 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

638 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

639 
	`√tif_°›_queue
(
dev
);

642 
	`skb_‹ph™
(
skb
);

643 
	`skb_d°_dr›
(
skb
);

645 i‡(
	`√tif_queue_°›≥d
(
dev
))

646 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

647 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

648 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

650 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

651 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

652 i‡(
	`u∆ikñy
(
rc
)) {

653 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

654 ++
dev
->
°©s
.
tx_îr‹s
;

655 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

656 
	`dev_k‰ì_skb_™y
(
skb
);

657 i‡(
	`√tif_queue_°›≥d
(
dev
))

658 
	`√tif_wake_queue
(
dev
);

659 
rc
 = 0;

661 
	`√tif_å™s_upd©e
(
dev
);

663 
rc
 = 
¥iv
->
tx_hód
;

664 ++
¥iv
->
tx_hód
;

666  
rc
;

667 
	}
}

669 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

671 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

672 
ùoib_ah
 *
ah
, *
èh
;

673 
	`LIST_HEAD
(
ªmove_li°
);

674 
Êags
;

676 
	`√tif_tx_lock_bh
(
dev
);

677 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

679 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

680 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

681 
	`li°_dñ
(&
ah
->
li°
);

682 
	`rdma_de°roy_ah
(
ah
->ah, 0);

683 
	`k‰ì
(
ah
);

686 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

687 
	`√tif_tx_u∆ock_bh
(
dev
);

688 
	}
}

690 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

692 
ùoib_dev_¥iv
 *
¥iv
 =

693 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

694 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

696 
	`__ùoib_ª≠_ah
(
dev
);

698 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

699 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

700 
	`round_jiffõs_ªœtive
(
HZ
));

701 
	}
}

703 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

705 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

707 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

708 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

709 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

710 
	}
}

712 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

714 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

717 
	`ùoib_Êush_ah
(
dev
);

718 
	}
}

720 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

722 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

723 
≥ndög
 = 0;

724 
i
;

726 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

727 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

728 ++
≥ndög
;

730  
≥ndög
;

731 
	}
}

733 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

734 
ib_qp
 *
qp
,

735 
ib_qp_°©e
 
√w_°©e
)

737 
ib_qp_©å
 
qp_©å
;

738 
ib_qp_öô_©å
 
quîy_öô_©å
;

739 
ªt
;

741 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

742 i‡(
ªt
) {

743 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

747 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

748 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

750 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

751 
√w_°©e
, 
qp_©å
.
qp_°©e
);

752 
	}
}

754 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

756 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

758 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

759 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

760 
	}
}

762 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

764 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

766 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

767 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

768 
	}
}

770 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

772 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

773 
ib_qp_©å
 
qp_©å
;

774 
begö
;

775 
ùoib_tx_buf
 *
tx_ªq
;

776 
i
;

778 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

779 
	`ùoib_«pi_dißbÀ
(
dev
);

781 
	`ùoib_cm_dev_°›
(
dev
);

787 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

788 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

789 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

792 
begö
 = 
jiffõs
;

794 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

795 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

796 
	`ùoib_w¨n
(
¥iv
,

798 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

799 
	`ªcvs_≥ndög
(
dev
));

805 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

806 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

807 (
ùoib_£ndq_size
 - 1)];

808 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

809 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

810 ++
¥iv
->
tx_èû
;

813 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

814 
ùoib_rx_buf
 *
rx_ªq
;

816 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

817 i‡(!
rx_ªq
->
skb
)

819 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

820 
¥iv
->
rx_rög
[
i
].
m≠pög
);

821 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

822 
rx_ªq
->
skb
 = 
NULL
;

825 
timeout
;

828 
	`ùoib_døö_cq
(
dev
);

830 
	`u¶ìp_ønge
(1000, 2000);

833 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

835 
timeout
:

836 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

837 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

838 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

840 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

843 
	}
}

845 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

847 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

849 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

851 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

852 
	`ùoib_Êush_ah
(
dev
);

855 
	}
}

857 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

859 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

860 
ªt
;

862 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

863 i‡(
ªt
) {

864 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

868 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

869 i‡(
ªt
) {

870 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

871 
out
;

874 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

875 i‡(
ªt
) {

876 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

877 
out
;

880 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

881 
	`ùoib_«pi_íabÀ
(
dev
);

884 
out
:

886 
	}
}

888 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

890 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

892 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

894 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

895 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

896 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

900 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

901 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

902 
	`round_jiffõs_ªœtive
(
HZ
));

904 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

905 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

906 
dev_°›
;

909 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

913 
dev_°›
:

914 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

915 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

916 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

917 
	`ùoib_ib_dev_°›
(
dev
);

919 
	}
}

921 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

923 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

924 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

926 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

927 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

928 &
¥iv
->
pkey_ödex
)) {

929 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

931 i‡(
∫
->
£t_id
)

932 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

933 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

935 
	}
}

937 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

939 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

941 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

943 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

944 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

948 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

950 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

951 
	}
}

953 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

955 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

957 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

959 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

960 
	`√tif_ˇºõr_off
(
dev
);

962 
	`ùoib_mˇ°_°›_thªad
(
dev
);

963 
	`ùoib_mˇ°_dev_Êush
(
dev
);

965 
	`ùoib_Êush_∑ths
(
dev
);

966 
	}
}

968 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

970 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

971 
i
, 
n
;

978 
	`loˇl_bh_dißbÀ
();

981 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

982 
i
 = 0; i < 
n
; ++i) {

988 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

989 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

992 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

993 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

997 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

1000 } 
n
 =
IPOIB_NUM_WC
);

1002 
	`pﬁl_tx
(
¥iv
))

1005 
	`loˇl_bh_íabÀ
();

1006 
	}
}

1012 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1014 
ªsu…
;

1015 
u16
 
¥ev_pkey
;

1017 
¥ev_pkey
 = 
¥iv
->
pkey
;

1018 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1019 i‡(
ªsu…
) {

1020 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1021 
¥iv
->
p‹t
, 
ªsu…
);

1022  
ªsu…
;

1025 
¥iv
->
pkey
 |= 0x8000;

1027 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1028 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1029 
¥ev_pkey
, 
¥iv
->
pkey
);

1034 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1035 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1040 
	}
}

1044 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1046 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1048 
¥iv
->
pkey_ödex
 = 0;

1049 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1051 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1052 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1055 
	}
}

1061 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1063 
ib_gid
 
£¨ch_gid
;

1064 
ib_gid
 
gid0
;

1065 
ib_gid
 *
√tdev_gid
;

1066 
îr
;

1067 
u16
 
ödex
;

1068 
u8
 
p‹t
;

1069 
boﬁ
 
ªt
 = 
Ál£
;

1071 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1072 i‡(
	`ib_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
, 
NULL
))

1073  
Ál£
;

1075 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1080 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1084 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1086 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1088 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1090 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1092 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1093 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1097 
out
;

1124 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1125 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1126 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1127 i‡(
ödex
 == 0)

1128 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1129 &
¥iv
->
Êags
);

1131 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1132 
ªt
 = 
åue
;

1134 
ªt
 = 
Ál£
;

1137 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1138 
ªt
 = 
åue
;

1140 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1141 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1142 (
¥iv
->
loˇl_gid
));

1143 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1144 (
¥iv
->
loˇl_gid
));

1145 
ªt
 = 
åue
;

1150 
out
:

1151 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1153  
ªt
;

1154 
	}
}

1156 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1157 
ùoib_Êush_Àvñ
 
Àvñ
,

1158 
√°ög
)

1160 
ùoib_dev_¥iv
 *
˝riv
;

1161 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1162 
ªsu…
;

1164 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1170 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1171 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1173 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1175 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1176 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1178 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1179 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1180 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1184 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1186 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1187 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1188 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1190 
	`upd©e_chûd_pkey
(
¥iv
);

1191 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1192 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1193 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1197 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1201 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1202 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1203 i‡(
ªsu…
) {

1205 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1210 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1212 i‡(
ªsu…
) {

1213 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1219 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1220 
›î_up
;

1221 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1227 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1228 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1229 i‡(
›î_up
)

1230 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1231 
	`ùoib_Êush_ah
(
dev
);

1234 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1235 
	`ùoib_ib_dev_down
(
dev
);

1237 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1238 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1239 
	`ùoib_ib_dev_°›
(
dev
);

1241 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1244 i‡(
	`√tif_queue_°›≥d
(
dev
))

1245 
	`√tif_°¨t_queue
(
dev
);

1252 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1253 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1254 
	`ùoib_ib_dev_up
(
dev
);

1255 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1256 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1258 
	}
}

1260 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1262 
ùoib_dev_¥iv
 *
¥iv
 =

1263 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1265 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1266 
	}
}

1268 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1270 
ùoib_dev_¥iv
 *
¥iv
 =

1271 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1273 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1274 
	}
}

1276 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1278 
ùoib_dev_¥iv
 *
¥iv
 =

1279 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1281 
	`π∆_lock
();

1282 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1283 
	`π∆_u∆ock
();

1284 
	}
}

1286 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1288 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1290 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1295 
	`ùoib_Êush_∑ths
(
dev
);

1297 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1298 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1306 
	`ùoib_°›_ah
(
dev
);

1308 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1310 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1312 i‡(
¥iv
->
pd
) {

1313 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1314 
¥iv
->
pd
 = 
NULL
;

1316 
	}
}

	@RHEL80/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
uöt
 
ùoib_ac˚l
;

80 
	sùoib_∑th_ôî
 {

81 
√t_devi˚
 *
	mdev
;

82 
ùoib_∑th
 
	m∑th
;

85 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

91 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

93 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

95 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

96 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

97 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

98 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

99 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

100 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

101 *
˛õ¡_d©a
);

102 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

103 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

104 
cmd
);

106 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

107 .
«me
 = "ipoib",

108 .
	gadd
 = 
ùoib_add_⁄e
,

109 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

110 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

113 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


114 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

115 
evít
, *
±r
)

117 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

118 
√t_devi˚
 *
dev
 = 
ni
->dev;

120 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

121  
NOTIFY_DONE
;

123 
evít
) {

124 
NETDEV_REGISTER
:

125 
	`ùoib_¸óã_debug_fûes
(
dev
);

127 
NETDEV_CHANGENAME
:

128 
	`ùoib_dñëe_debug_fûes
(
dev
);

129 
	`ùoib_¸óã_debug_fûes
(
dev
);

131 
NETDEV_UNREGISTER
:

132 
	`ùoib_dñëe_debug_fûes
(
dev
);

136  
NOTIFY_DONE
;

137 
	}
}

140 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

142 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

144 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

146 
	`√tif_ˇºõr_off
(
dev
);

148 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

150 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

152 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

153 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

155 
îr_dißbÀ
;

158 
	`ùoib_ib_dev_up
(
dev
);

160 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

161 
ùoib_dev_¥iv
 *
˝riv
;

164 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

165 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

166 
Êags
;

168 
Êags
 = 
˝riv
->
dev
->flags;

169 i‡(
Êags
 & 
IFF_UP
)

172 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

174 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

177 
	`√tif_°¨t_queue
(
dev
);

181 
îr_dißbÀ
:

182 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

184  -
EINVAL
;

185 
	}
}

187 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

191 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

193 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

195 
	`√tif_°›_queue
(
dev
);

197 
	`ùoib_ib_dev_down
(
dev
);

198 
	`ùoib_ib_dev_°›
(
dev
);

200 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

201 
ùoib_dev_¥iv
 *
˝riv
;

204 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

205 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

206 
Êags
;

208 
Êags
 = 
˝riv
->
dev
->flags;

209 i‡(!(
Êags
 & 
IFF_UP
))

212 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

214 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

218 
	}
}

220 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

222 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

224 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

225 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

227  
„©uªs
;

228 
	}
}

230 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

232 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

233 
ªt
 = 0;

236 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

237 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

238  -
EINVAL
;

240 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

241 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

242 
¥iv
->
mˇ°_mtu
);

244 
dev
->
mtu
 = 
√w_mtu
;

248 i‡(
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

249  -
EINVAL
;

251 
¥iv
->
admö_mtu
 = 
√w_mtu
;

253 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

254 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

255 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

257 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

259 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

260 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

262 
	`√tif_ˇºõr_off
(
dev
);

265 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

267 i‡(
ˇºõr_°©us
)

268 
	`√tif_ˇºõr_⁄
(
dev
);

270 
dev
->
mtu
 = 
√w_mtu
;

273  
ªt
;

274 
	}
}

276 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

277 
π∆_lök_°©s64
 *
°©s
)

279 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

281 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

282 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

284 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

285 
	}
}

288 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

289 
√t_devi˚
 *
dev
)

291 
√t
 *√à
	`dev_√t
(
dev
);

292 
ö_devi˚
 *
ö_dev
;

293 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

294 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

295 
__be32
 
ªt_addr
;

297 
addr
->
ß_Ámûy
) {

298 
AF_INET
:

299 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

300 i‡(!
ö_dev
)

301  
Ál£
;

303 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

304 
addr_ö
->
sö_addr
.
s_addr
,

305 
RT_SCOPE_HOST
);

306 
	`ö_dev_put
(
ö_dev
);

307 i‡(
ªt_addr
)

308  
åue
;

311 
AF_INET6
:

312 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

313 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

314  
åue
;

318  
Ál£
;

319 
	}
}

328 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

330 
√t_devi˚
 *
ma°î
;

332 
	`rcu_ªad_lock
();

333 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

334 i‡(
ma°î
)

335 
	`dev_hﬁd
(
ma°î
);

336 
	`rcu_ªad_u∆ock
();

338 i‡(
ma°î
)

339  
ma°î
;

341 
	`dev_hﬁd
(
dev
);

342  
dev
;

343 
	}
}

345 
	sùoib_wÆk_d©a
 {

346 c⁄° 
sockaddr
 *
	maddr
;

347 
√t_devi˚
 *
	mªsu…
;

350 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

352 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

353 
ªt
 = 0;

355 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

356 
	`dev_hﬁd
(
uµî
);

357 
d©a
->
ªsu…
 = 
uµî
;

358 
ªt
 = 1;

361  
ªt
;

362 
	}
}

373 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

374 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

376 
ùoib_wÆk_d©a
 
d©a
 = {

377 .
addr
 =áddr,

380 
	`rcu_ªad_lock
();

381 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

382 
	`dev_hﬁd
(
dev
);

383 
d©a
.
ªsu…
 = 
dev
;

384 
out
;

387 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

388 
out
:

389 
	`rcu_ªad_u∆ock
();

390  
d©a
.
ªsu…
;

391 
	}
}

398 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

399 c⁄° 
ib_gid
 *
gid
,

400 
u16
 
pkey_ödex
,

401 c⁄° 
sockaddr
 *
addr
,

402 
√°ög
,

403 
√t_devi˚
 **
found_√t_dev
)

405 
ùoib_dev_¥iv
 *
chûd_¥iv
;

406 
√t_devi˚
 *
√t_dev
 = 
NULL
;

407 
m©ches
 = 0;

409 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

410 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

411 i‡(!
addr
) {

412 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

416 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

418 i‡(
√t_dev
) {

419 i‡(!*
found_√t_dev
)

420 *
found_√t_dev
 = 
√t_dev
;

422 
	`dev_put
(
√t_dev
);

423 ++
m©ches
;

428 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

429 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

430 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

431 
pkey_ödex
, 
addr
,

432 
√°ög
 + 1,

433 
found_√t_dev
);

434 i‡(
m©ches
 > 1)

437 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

439  
m©ches
;

440 
	}
}

445 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

446 
u16
 
pkey_ödex
,

447 c⁄° 
ib_gid
 *
gid
,

448 c⁄° 
sockaddr
 *
addr
,

449 
√t_devi˚
 **
√t_dev
)

451 
ùoib_dev_¥iv
 *
¥iv
;

452 
m©ches
 = 0;

454 *
√t_dev
 = 
NULL
;

456 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

457 i‡(
¥iv
->
p‹t
 !=Öort)

460 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

461 
addr
, 0, 
√t_dev
);

462 i‡(
m©ches
 > 1)

466  
m©ches
;

467 
	}
}

469 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

470 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

471 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

472 *
˛õ¡_d©a
)

474 
√t_devi˚
 *
√t_dev
;

475 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

476 
u16
 
pkey_ödex
;

477 
m©ches
;

478 
ªt
;

480 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

481  
NULL
;

483 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

484 i‡(
ªt
)

485  
NULL
;

487 i‡(!
dev_li°
)

488  
NULL
;

491 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

492 
gid
, 
NULL
, &
√t_dev
);

494 
m©ches
) {

496  
NULL
;

498  
√t_dev
;

501 
	`dev_put
(
√t_dev
);

505 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

506 
gid
, 
addr
, &
√t_dev
);

507 
m©ches
) {

509  
NULL
;

511 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

515  
√t_dev
;

517 
	}
}

519 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

521 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

523 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

524 !
	`°rcmp
(
buf
, "connected\n")) ||

525 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

526 !
	`°rcmp
(
buf
, "datagram\n"))) {

531 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

532 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

533 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

535 
	`√tdev_upd©e_„©uªs
(
dev
);

536 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

537 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

538 
	`π∆_u∆ock
();

539 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

541 
	`ùoib_Êush_∑ths
(
dev
);

542  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

545 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

546 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

547 
	`√tdev_upd©e_„©uªs
(
dev
);

548 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

549 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

550 
	`π∆_u∆ock
();

551 
	`ùoib_Êush_∑ths
(
dev
);

552  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

555  -
EINVAL
;

556 
	}
}

558 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

560 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

561 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

562 
ùoib_∑th
 *
∑th
;

563 
ªt
;

565 
n
) {

566 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

568 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

569  (
ib_gid
));

571 i‡(
ªt
 < 0)

572 
n
 =Ç->
rb_À·
;

573 i‡(
ªt
 > 0)

574 
n
 =Ç->
rb_right
;

576  
∑th
;

579  
NULL
;

580 
	}
}

582 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

584 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

585 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

586 
rb_node
 *
≤
 = 
NULL
;

587 
ùoib_∑th
 *
ç©h
;

588 
ªt
;

590 *
n
) {

591 
≤
 = *
n
;

592 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

594 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

595  (
ib_gid
));

596 i‡(
ªt
 < 0)

597 
n
 = &
≤
->
rb_À·
;

598 i‡(
ªt
 > 0)

599 
n
 = &
≤
->
rb_right
;

601  -
EEXIST
;

604 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

605 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

607 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

610 
	}
}

612 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

614 
sk_buff
 *
skb
;

616 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

617 
	`dev_k‰ì_skb_úq
(
skb
);

619 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

622 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

624 i‡(
∑th
->
ah
)

625 
	`ùoib_put_ah
(
∑th
->
ah
);

627 
	`k‰ì
(
∑th
);

628 
	}
}

630 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


632 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

634 
ùoib_∑th_ôî
 *
ôî
;

636 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

637 i‡(!
ôî
)

638  
NULL
;

640 
ôî
->
dev
 = dev;

641 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

643 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

644 
	`k‰ì
(
ôî
);

645  
NULL
;

648  
ôî
;

649 
	}
}

651 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

654 
rb_node
 *
n
;

655 
ùoib_∑th
 *
∑th
;

656 
ªt
 = 1;

658 
	`•ö_lock_úq
(&
¥iv
->
lock
);

660 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

662 
n
) {

663 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

665 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

666  (
ib_gid
)) < 0) {

667 
ôî
->
∑th
 = *path;

668 
ªt
 = 0;

672 
n
 = 
	`rb_√xt
(n);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

677  
ªt
;

678 
	}
}

680 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

681 
ùoib_∑th
 *
∑th
)

683 *
∑th
 = 
ôî
->path;

684 
	}
}

688 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

690 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

691 
ùoib_∑th
 *
∑th
, *
ç
;

693 
	`•ö_lock_úq
(&
¥iv
->
lock
);

695 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

696 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

697 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

698 
∑th
->
∑thªc
.
dgid
.
øw
);

699 i‡(
∑th
->
ah
)

700 
∑th
->
ah
->
vÆid
 = 0;

703 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

704 
	}
}

706 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

708 
ùoib_p£udo_hódî
 *
phdr
;

710 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

711 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

712 
	}
}

714 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

716 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

717 
ùoib_∑th
 *
∑th
, *
ç
;

718 
	`LIST_HEAD
(
ªmove_li°
);

719 
Êags
;

721 
	`√tif_tx_lock_bh
(
dev
);

722 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

724 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

726 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

727 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

729 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

730 i‡(
∑th
->
quîy
)

731 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

732 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

733 
	`√tif_tx_u∆ock_bh
(
dev
);

734 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

735 
	`∑th_‰ì
(
dev
, 
∑th
);

736 
	`√tif_tx_lock_bh
(
dev
);

737 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

740 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

741 
	`√tif_tx_u∆ock_bh
(
dev
);

742 
	}
}

744 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

745 
ß_∑th_ªc
 *
∑thªc
,

746 *
∑th_±r
)

748 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

749 
√t_devi˚
 *
dev
 = 
∑th
->dev;

750 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

751 
ùoib_ah
 *
ah
 = 
NULL
;

752 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

753 
ùoib_√igh
 *
√igh
, *
ä
;

754 
sk_buff_hód
 
skqueue
;

755 
sk_buff
 *
skb
;

756 
Êags
;

758 i‡(!
°©us
)

759 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

760 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

761 
∑thªc
->
dgid
.
øw
);

763 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

764 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

766 
	`skb_queue_hód_öô
(&
skqueue
);

768 i‡(!
°©us
) {

769 
rdma_ah_©å
 
av
;

771 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

772 
∑thªc
, &
av
))

773 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

776 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

778 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

784 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

785 (
ib_gid
))) {

786 
	`ùoib_dbg
(

787 
¥iv
,

789 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

790 
∑th
->
∑thªc
.
dgid
.
øw
);

791 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

792 (
ib_gid
));

795 
∑th
->
∑thªc
 = *pathrec;

797 
ﬁd_ah
 = 
∑th
->
ah
;

798 
∑th
->
ah
 =áh;

800 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

801 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

802 
∑thªc
->
¶
);

804 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

805 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

807 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

808 i‡(
√igh
->
ah
) {

809 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

817 
	`ùoib_put_ah
(
√igh
->
ah
);

819 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

820 
√igh
->
ah
 = 
∑th
->ah;

822 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

823 i‡(!
	`ùoib_cm_gë
(
√igh
))

824 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

825 
∑th
,

826 
√igh
));

827 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

828 
	`ùoib_√igh_‰ì
(
√igh
);

833 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

834 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

836 
∑th
->
ah
->
vÆid
 = 1;

839 
∑th
->
quîy
 = 
NULL
;

840 
	`com∂ëe
(&
∑th
->
d⁄e
);

842 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

844 i‡(
	`IS_ERR_OR_NULL
(
ah
))

845 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

847 i‡(
ﬁd_ah
)

848 
	`ùoib_put_ah
(
ﬁd_ah
);

850 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

851 
ªt
;

852 
skb
->
dev
 = dev;

853 
ªt
 = 
	`dev_queue_xmô
(
skb
);

854 i‡(
ªt
)

855 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

856 
__func__
, 
ªt
);

858 
	}
}

860 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

861 *
gid
)

863 
∑th
->
dev
 = 
¥iv
->dev;

865 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

866 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

868 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

870 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

871 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

872 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

873 
∑th
->
∑thªc
.
numb_∑th
 = 1;

874 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

875 
	}
}

877 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

879 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

880 
ùoib_∑th
 *
∑th
;

882 i‡(!
¥iv
->
brﬂdˇ°
)

883  
NULL
;

885 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

886 i‡(!
∑th
)

887  
NULL
;

889 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

891 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

893 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

895  
∑th
;

896 
	}
}

898 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

899 
ùoib_∑th
 *
∑th
)

901 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

903 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

904 
∑th
->
∑thªc
.
dgid
.
øw
);

906 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

908 
∑th
->
quîy_id
 =

909 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

910 &
∑th
->
∑thªc
,

911 
IB_SA_PATH_REC_DGID
 |

912 
IB_SA_PATH_REC_SGID
 |

913 
IB_SA_PATH_REC_NUMB_PATH
 |

914 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

915 
IB_SA_PATH_REC_PKEY
,

916 1000, 
GFP_ATOMIC
,

917 
∑th_ªc_com∂ëi⁄
,

918 
∑th
, &∑th->
quîy
);

919 i‡(
∑th
->
quîy_id
 < 0) {

920 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

921 
∑th
->
quîy
 = 
NULL
;

922 
	`com∂ëe
(&
∑th
->
d⁄e
);

923  
∑th
->
quîy_id
;

927 
	}
}

929 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

930 
√t_devi˚
 *
dev
)

932 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

933 
ùoib_∑th
 *
∑th
;

934 
Êags
;

936 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

938 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

939 i‡(!
∑th
)

940 
out
;

941 i‡(!
∑th
->
quîy
)

942 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

943 
out
:

944 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

945 
	}
}

947 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

948 
√t_devi˚
 *
dev
)

950 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

951 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

952 
ùoib_∑th
 *
∑th
;

953 
ùoib_√igh
 *
√igh
;

954 
Êags
;

956 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

957 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

958 i‡(!
√igh
) {

959 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

960 ++
dev
->
°©s
.
tx_dr›≥d
;

961 
	`dev_k‰ì_skb_™y
(
skb
);

962  
NULL
;

968 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

969 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

970  
√igh
;

973 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

974 i‡(!
∑th
) {

975 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

976 i‡(!
∑th
)

977 
îr_∑th
;

979 
	`__∑th_add
(
dev
, 
∑th
);

982 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

984 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

985 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

986 
√igh
->
ah
 = 
∑th
->ah;

988 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

989 i‡(!
	`ùoib_cm_gë
(
√igh
))

990 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

991 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

992 
	`ùoib_√igh_‰ì
(
√igh
);

993 
îr_dr›
;

995 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

996 
IPOIB_MAX_PATH_REC_QUEUE
) {

997 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

998 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1000 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1001 
	`skb_queue_Àn
(&
√igh
->
queue
));

1002 
îr_dr›
;

1005 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1006 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1007 
	`IPOIB_QPN
(
daddr
));

1008 
	`ùoib_√igh_put
(
√igh
);

1009  
NULL
;

1012 
√igh
->
ah
 = 
NULL
;

1014 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1015 
îr_∑th
;

1016 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1017 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1018 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1020 
îr_dr›
;

1024 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1025 
	`ùoib_√igh_put
(
√igh
);

1026  
NULL
;

1028 
îr_∑th
:

1029 
	`ùoib_√igh_‰ì
(
√igh
);

1030 
îr_dr›
:

1031 ++
dev
->
°©s
.
tx_dr›≥d
;

1032 
	`dev_k‰ì_skb_™y
(
skb
);

1034 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1035 
	`ùoib_√igh_put
(
√igh
);

1037  
NULL
;

1038 
	}
}

1040 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1041 
ùoib_p£udo_hódî
 *
phdr
)

1043 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1044 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1045 
ùoib_∑th
 *
∑th
;

1046 
Êags
;

1048 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1051 i‡(!
¥iv
->
brﬂdˇ°
)

1052 
dr›_™d_u∆ock
;

1054 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1055 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1056 i‡(!
∑th
) {

1057 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1058 i‡(!
∑th
)

1059 
dr›_™d_u∆ock
;

1060 
	`__∑th_add
(
dev
, 
∑th
);

1066 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1068 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1069 
dr›_™d_u∆ock
;

1072 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1073 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1074 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1075 
u∆ock
;

1077 
dr›_™d_u∆ock
;

1081 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1082 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1083 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1084 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1085 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1088 
dr›_™d_u∆ock
:

1089 ++
dev
->
°©s
.
tx_dr›≥d
;

1090 
	`dev_k‰ì_skb_™y
(
skb
);

1091 
u∆ock
:

1092 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1093 
	}
}

1095 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1097 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1098 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1099 
ùoib_√igh
 *
√igh
;

1100 
ùoib_p£udo_hódî
 *
phdr
;

1101 
ùoib_hódî
 *
hódî
;

1102 
Êags
;

1104 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1105 
	`skb_puŒ
(
skb
, (*
phdr
));

1106 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1108 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1110 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1111 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1116 ++
dev
->
°©s
.
tx_dr›≥d
;

1117 
	`dev_k‰ì_skb_™y
(
skb
);

1118  
NETDEV_TX_OK
;

1121 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1122 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1124 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1125 i‡(
	`likñy
(
√igh
))

1126 
£nd_usög_√igh
;

1127 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1128  
NETDEV_TX_OK
;

1132 
hódî
->
¥Ÿo
) {

1133 
	`ht⁄s
(
ETH_P_IP
):

1134 
	`ht⁄s
(
ETH_P_IPV6
):

1135 
	`ht⁄s
(
ETH_P_TIPC
):

1136 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1137 i‡(
	`u∆ikñy
(!
√igh
)) {

1138 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1139 i‡(
	`likñy
(!
√igh
))

1140  
NETDEV_TX_OK
;

1143 
	`ht⁄s
(
ETH_P_ARP
):

1144 
	`ht⁄s
(
ETH_P_RARP
):

1146 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1147  
NETDEV_TX_OK
;

1150 ++
dev
->
°©s
.
tx_dr›≥d
;

1151 
	`dev_k‰ì_skb_™y
(
skb
);

1152  
NETDEV_TX_OK
;

1155 
£nd_usög_√igh
:

1157 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1158 i‡(
	`ùoib_cm_up
(
√igh
)) {

1159 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1160 
uƒef
;

1162 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1163 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1164 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1165 
uƒef
;

1166 } i‡(
√igh
->
ah
) {

1167 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1170 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1171 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1172 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1173 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1174 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1176 ++
dev
->
°©s
.
tx_dr›≥d
;

1177 
	`dev_k‰ì_skb_™y
(
skb
);

1180 
uƒef
:

1181 
	`ùoib_√igh_put
(
√igh
);

1183  
NETDEV_TX_OK
;

1184 
	}
}

1186 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1188 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1190 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1191 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1192 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1193 
	`√tif_queue_°›≥d
(
dev
),

1194 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1196 
	}
}

1198 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1199 
√t_devi˚
 *
dev
,

1200 
ty≥
,

1201 c⁄° *
daddr
, c⁄° *
ßddr
, 
Àn
)

1203 
ùoib_hódî
 *
hódî
;

1205 
hódî
 = 
	`skb_push
(
skb
, (*header));

1207 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1208 
hódî
->
ª£rved
 = 0;

1215 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1217  
IPOIB_HARD_LEN
;

1218 
	}
}

1220 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1222 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1224 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1225 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1229 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1230 
	}
}

1232 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1234 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1237 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1238  
dev
->
ifödex
;

1241  
¥iv
->
∑ª¡
->
ifödex
;

1242 
	}
}

1244 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1253 
u32
 *
d32
 = (u32 *Ë
daddr
;

1254 
u32
 
hv
;

1256 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1257  
hv
 & 
htbl
->
mask
;

1258 
	}
}

1260 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1262 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1263 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1264 
ùoib_√igh_hash
 *
htbl
;

1265 
ùoib_√igh
 *
√igh
 = 
NULL
;

1266 
u32
 
hash_vÆ
;

1268 
	`rcu_ªad_lock_bh
();

1270 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1272 i‡(!
htbl
)

1273 
out_u∆ock
;

1275 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1276 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1277 
√igh
 !
NULL
;

1278 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1279 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1281 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1283 
√igh
 = 
NULL
;

1284 
out_u∆ock
;

1287 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1288 
√igh
->
Æive
 = 
jiffõs
;

1289 
out_u∆ock
;

1293 
out_u∆ock
:

1294 
	`rcu_ªad_u∆ock_bh
();

1295  
√igh
;

1296 
	}
}

1298 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1300 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1301 
ùoib_√igh_hash
 *
htbl
;

1302 
√igh_obsﬁëe
;

1303 
dt
;

1304 
Êags
;

1305 
i
;

1306 
	`LIST_HEAD
(
ªmove_li°
);

1308 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1310 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1311 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1313 i‡(!
htbl
)

1314 
out_u∆ock
;

1317 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1318 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1320 
i
 = 0; i < 
htbl
->
size
; i++) {

1321 
ùoib_√igh
 *
√igh
;

1322 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1324 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1325 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1327 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1329 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1331 
	`rcu_assign_poöãr
(*
≈
,

1332 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1333 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1335 
	`li°_dñ_öô
(&
√igh
->
li°
);

1336 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1338 
≈
 = &
√igh
->
h√xt
;

1344 
out_u∆ock
:

1345 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1346 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1347 
	}
}

1349 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1351 
ùoib_dev_¥iv
 *
¥iv
 =

1352 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1354 
	`__ùoib_ª≠_√igh
(
¥iv
);

1356 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1357 
¨p_tbl
.
gc_öãrvÆ
);

1358 
	}
}

1361 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1362 
√t_devi˚
 *
dev
)

1364 
ùoib_√igh
 *
√igh
;

1366 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1367 i‡(!
√igh
)

1368  
NULL
;

1370 
√igh
->
dev
 = dev;

1371 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1372 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1373 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1374 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1376 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1378  
√igh
;

1379 
	}
}

1381 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1382 
√t_devi˚
 *
dev
)

1384 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1385 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1386 
ùoib_√igh_hash
 *
htbl
;

1387 
ùoib_√igh
 *
√igh
;

1388 
u32
 
hash_vÆ
;

1390 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1391 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1392 i‡(!
htbl
) {

1393 
√igh
 = 
NULL
;

1394 
out_u∆ock
;

1400 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1401 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1402 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1403 
√igh
 !
NULL
;

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1406 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1408 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1410 
√igh
 = 
NULL
;

1413 
√igh
->
Æive
 = 
jiffõs
;

1414 
out_u∆ock
;

1418 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1419 i‡(!
√igh
)

1420 
out_u∆ock
;

1423 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1424 
√igh
->
Æive
 = 
jiffõs
;

1426 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1427 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1428 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1429 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1430 
	`©omic_öc
(&
¡bl
->
íåõs
);

1432 
out_u∆ock
:

1434  
√igh
;

1435 
	}
}

1437 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1440 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1441 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1442 
sk_buff
 *
skb
;

1443 i‡(
√igh
->
ah
)

1444 
	`ùoib_put_ah
(
√igh
->
ah
);

1445 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1446 ++
dev
->
°©s
.
tx_dr›≥d
;

1447 
	`dev_k‰ì_skb_™y
(
skb
);

1449 i‡(
	`ùoib_cm_gë
(
√igh
))

1450 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1451 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1453 
	`IPOIB_QPN
(
√igh
->
daddr
),

1454 
√igh
->
daddr
 + 4);

1455 
	`k‰ì
(
√igh
);

1456 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1457 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1458 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1460 
	}
}

1462 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1465 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1467 
	`ùoib_√igh_put
(
√igh
);

1468 
	}
}

1470 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1472 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1473 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1474 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1475 
ùoib_√igh_hash
 *
htbl
;

1476 
ùoib_√igh
 
__rcu
 **
≈
;

1477 
ùoib_√igh
 *
n
;

1478 
u32
 
hash_vÆ
;

1480 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1481 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1482 i‡(!
htbl
)

1485 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1486 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1487 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1488 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1489 
n
 !
NULL
;

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1492 i‡(
n
 =
√igh
) {

1494 
	`rcu_assign_poöãr
(*
≈
,

1495 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1496 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1498 
	`li°_dñ_öô
(&
√igh
->
li°
);

1499 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1502 
≈
 = &
n
->
h√xt
;

1505 
	}
}

1507 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1509 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1510 
ùoib_√igh_hash
 *
htbl
;

1511 
ùoib_√igh
 
__rcu
 **
buckës
;

1512 
u32
 
size
;

1514 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1515 
¡bl
->
htbl
 = 
NULL
;

1516 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1517 i‡(!
htbl
)

1518  -
ENOMEM
;

1519 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1520 
buckës
 = 
	`kˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1521 i‡(!
buckës
) {

1522 
	`k‰ì
(
htbl
);

1523  -
ENOMEM
;

1525 
htbl
->
size
 = size;

1526 
htbl
->
mask
 = (
size
 - 1);

1527 
htbl
->
buckës
 = buckets;

1528 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1529 
htbl
->
¡bl
 =Çtbl;

1530 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1533 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1534 
¨p_tbl
.
gc_öãrvÆ
);

1537 
	}
}

1539 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1541 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1542 
ùoib_√igh_hash
,

1543 
rcu
);

1544 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1545 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1547 
	`k‰ì
(
buckës
);

1548 
	`k‰ì
(
htbl
);

1549 
	`com∂ëe
(&
¡bl
->
dñëed
);

1550 
	}
}

1552 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1554 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1555 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1556 
ùoib_√igh_hash
 *
htbl
;

1557 
Êags
;

1558 
i
;

1561 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1563 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1564 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1566 i‡(!
htbl
)

1567 
out_u∆ock
;

1569 
i
 = 0; i < 
htbl
->
size
; i++) {

1570 
ùoib_√igh
 *
√igh
;

1571 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1573 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1574 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1576 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1577 
	`rcu_assign_poöãr
(*
≈
,

1578 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1579 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1581 
	`li°_dñ_öô
(&
√igh
->
li°
);

1582 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1584 
≈
 = &
√igh
->
h√xt
;

1589 
out_u∆ock
:

1590 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1591 
	}
}

1593 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1595 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1596 
ùoib_√igh_hash
 *
htbl
;

1597 
Êags
;

1598 
i
, 
waô_Êushed
 = 0;

1600 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1601 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1603 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1605 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1606 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1607 i‡(!
htbl
)

1608 
out_u∆ock
;

1610 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1611 i‡(!
waô_Êushed
)

1612 
‰ì_htbl
;

1614 
i
 = 0; i < 
htbl
->
size
; i++) {

1615 
ùoib_√igh
 *
√igh
;

1616 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1618 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1619 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1620 
	`rcu_assign_poöãr
(*
≈
,

1621 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1624 
	`li°_dñ_öô
(&
√igh
->
li°
);

1625 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1629 
‰ì_htbl
:

1630 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1631 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1633 
out_u∆ock
:

1634 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1635 i‡(
waô_Êushed
)

1636 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1637 
	}
}

1639 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1641 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1643 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1644 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1646 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1648 
	`ùoib_Êush_√ighs
(
¥iv
);

1650 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1651 
	}
}

1653 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1655 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1657 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1658 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1659 
	}
}

1661 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1663 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1665 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1666 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1667 
	}
}

1669 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1671 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1673 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1675 
	`ùoib_«pi_dñ
(
dev
);

1677 
	`ùoib_cm_dev_˛ónup
(
dev
);

1679 
	`k‰ì
(
¥iv
->
rx_rög
);

1680 
	`v‰ì
(
¥iv
->
tx_rög
);

1682 
¥iv
->
rx_rög
 = 
NULL
;

1683 
¥iv
->
tx_rög
 = 
NULL
;

1684 
	}
}

1686 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1688 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1690 
	`ùoib_«pi_add
(
dev
);

1693 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1694 (*
¥iv
->
rx_rög
),

1695 
GFP_KERNEL
);

1696 i‡(!
¥iv
->
rx_rög
)

1697 
out
;

1699 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1700 (*
¥iv
->
tx_rög
)));

1701 i‡(!
¥iv
->
tx_rög
) {

1702 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1703 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1704 
out_rx_rög_˛ónup
;

1709 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1710 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1711 
¥iv
->
ˇ
->
«me
);

1712 
out_tx_rög_˛ónup
;

1716 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1717 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1718 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1722 
out_tx_rög_˛ónup
:

1723 
	`v‰ì
(
¥iv
->
tx_rög
);

1725 
out_rx_rög_˛ónup
:

1726 
	`k‰ì
(
¥iv
->
rx_rög
);

1728 
out
:

1729 
	`ùoib_«pi_dñ
(
dev
);

1730  -
ENOMEM
;

1731 
	}
}

1733 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1734 
cmd
)

1736 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1738 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1739  -
EOPNOTSUPP
;

1741  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1742 
	}
}

1744 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1746 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1747 
ªt
 = -
ENOMEM
;

1749 
¥iv
->
qp
 = 
NULL
;

1755 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1756 i‡(!
¥iv
->
wq
) {

1757 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1758 
out
;

1762 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1763 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1764 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1765 
˛ón_wq
;

1768 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1769 i‡(
ªt
) {

1770 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1771 
out_‰ì_pd
;

1774 i‡(
	`ùoib_√igh_hash_öô
(
¥iv
) < 0) {

1775 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1776 
out_dev_unöô
;

1779 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1780 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1781 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1782 
ªt
 = -
ENODEV
;

1783 
out_hash_unöô
;

1789 
out_hash_unöô
:

1790 
	`ùoib_√igh_hash_unöô
(
dev
);

1792 
out_dev_unöô
:

1793 
	`ùoib_ib_dev_˛ónup
(
dev
);

1795 
out_‰ì_pd
:

1796 i‡(
¥iv
->
pd
) {

1797 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1798 
¥iv
->
pd
 = 
NULL
;

1801 
˛ón_wq
:

1802 i‡(
¥iv
->
wq
) {

1803 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1804 
¥iv
->
wq
 = 
NULL
;

1807 
out
:

1808  
ªt
;

1809 
	}
}

1815 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1817 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1823 
	`π∆_lock
();

1824 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

1825 
	`π∆_u∆ock
();

1828 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1834 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1835 
	}
}

1837 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1839 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1841 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1842 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1844 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1845 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1847 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1849 
	}
}

1851 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1853 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1854 
ib_p‹t_©å
 
©å
;

1855 
ªsu…
;

1857 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1858 i‡(
ªsu…
) {

1859 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1860 
¥iv
->
p‹t
);

1861  
ªsu…
;

1864 i‡(
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
Ë&& 
ùoib_ac˚l
)

1865 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1867 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1869 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1870 i‡(
ªsu…
) {

1871 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1872 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1873  
ªsu…
;

1876 
ªsu…
 = 
	`ib_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
, 
NULL
);

1877 i‡(
ªsu…
) {

1878 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1879 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1880  
ªsu…
;

1882 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1883 (
ib_gid
));

1885 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1886 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1889 
	}
}

1891 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1893 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1894 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1896 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1897 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1898 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1899 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1900 
	}
}

1902 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1905 
rc
;

1906 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
ndev
);

1908 i‡(
¥iv
->
∑ª¡
) {

1909 
	`ùoib_chûd_öô
(
ndev
);

1911 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1912 i‡(
rc
)

1913  
rc
;

1917 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1918 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1919 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1920 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1922 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1928 
¥iv
->
pkey
 |= 0x8000;

1930 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1931 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1932 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1934 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1936 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1937 i‡(
rc
) {

1938 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1939 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1940  
rc
;

1943 i‡(
¥iv
->
∑ª¡
) {

1944 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1946 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1948 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1949 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1950 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1954 
	}
}

1956 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1958 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1960 
	`ASSERT_RTNL
();

1966 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1968 i‡(
¥iv
->
∑ª¡
) {

1969 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1971 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1972 
	`li°_dñ
(&
¥iv
->
li°
);

1973 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1976 
	`ùoib_√igh_hash_unöô
(
dev
);

1978 
	`ùoib_ib_dev_˛ónup
(
dev
);

1981 i‡(
¥iv
->
wq
) {

1982 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1983 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1984 
¥iv
->
wq
 = 
NULL
;

1987 i‡(
¥iv
->
∑ª¡
)

1988 
	`dev_put
(
¥iv
->
∑ª¡
);

1989 
	}
}

1991 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1993 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1995  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

1996 
	}
}

1998 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

1999 
iÊa_vf_öfo
 *
ivf
)

2001 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2002 
îr
;

2004 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2005 i‡(
îr
)

2006  
îr
;

2008 
ivf
->
vf
 = vf;

2011 
	}
}

2013 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2015 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2017 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2018  -
EINVAL
;

2020  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2021 
	}
}

2023 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2024 
iÊa_vf_°©s
 *
vf_°©s
)

2026 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2028  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2029 
	}
}

2031 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2032 .
¸óã
 = 
ùoib_h¨d_hódî
,

2035 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2036 .
ndo_öô
 = 
ùoib_ndo_öô
,

2037 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2038 .
	gndo_›í
 = 
ùoib_›í
,

2039 .
	gndo_°›
 = 
ùoib_°›
,

2040 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2041 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2042 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2043 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2044 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2045 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2046 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2047 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2048 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2049 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2050 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2051 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2052 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2055 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2056 .
ndo_öô
 = 
ùoib_ndo_öô
,

2057 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2058 .
	gndo_›í
 = 
ùoib_›í
,

2059 .
	gndo_°›
 = 
ùoib_°›
,

2060 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2061 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2062 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2063 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2064 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2065 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2066 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2067 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2070 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2071 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2072 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2073 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2074 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2077 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2079 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2080 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2082 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2084 
dev
->
w©chdog_timeo
 = 
HZ
;

2086 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2088 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2089 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2090 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2091 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2092 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2093 
NETIF_F_HIGHDMA
);

2094 
	`√tif_kìp_d°
(
dev
);

2096 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2103 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2104 
	}
}

2106 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2108 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2110 
¥iv
->
dev
 = dev;

2111 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2112 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2113 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2115 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2116 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2117 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2118 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2120 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2121 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2122 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2123 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2124 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2125 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2126 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2127 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2128 
	}
}

2130 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2131 c⁄° *
«me
)

2133 
√t_devi˚
 *
dev
;

2135 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2136 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2137 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2138  
dev
;

2140 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2141 
ùoib_£tup_comm⁄
);

2142 i‡(!
dev
)

2143  
	`ERR_PTR
(-
ENOMEM
);

2144  
dev
;

2145 
	}
}

2147 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2148 
√t_devi˚
 *
dev
)

2150 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2151 
ùoib_dev_¥iv
 *
¥iv
;

2152 
rc
;

2154 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2155 i‡(!
¥iv
)

2156  -
ENOMEM
;

2158 
¥iv
->
ˇ
 = 
hˇ
;

2159 
¥iv
->
p‹t
 =Öort;

2161 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2162 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2163 i‡(
rc
) {

2164 i‡(
rc
 !-
EOPNOTSUPP
)

2165 
out
;

2167 
∫
->
£nd
 = 
ùoib_£nd
;

2168 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2169 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2170 
∫
->
hˇ
 = hca;

2173 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2175 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2176 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2178 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2180 
∫
->
˛¡_¥iv
 = 
¥iv
;

2186 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2187 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2189 
	`ùoib_buûd_¥iv
(
dev
);

2193 
out
:

2194 
	`k‰ì
(
¥iv
);

2195  
rc
;

2196 
	}
}

2198 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2199 c⁄° *
«me
)

2201 
√t_devi˚
 *
dev
;

2202 
rc
;

2204 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2205 i‡(
	`IS_ERR
(
dev
))

2206  
dev
;

2208 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2209 i‡(
rc
) {

2210 
	`‰ì_√tdev
(
dev
);

2211  
	`ERR_PTR
(
rc
);

2219  
dev
;

2220 
	}
}

2222 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2224 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2225 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2227 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2228 i‡(
dev
->
¥iv_de°ru˘‹
)

2229 
dev
->
	`¥iv_de°ru˘‹
(dev);

2235 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2238 
∫
->
˛¡_¥iv
 = 
NULL
;

2240 
	`k‰ì
(
¥iv
);

2241 
	}
}

2243 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2244 
devi˚_©åibuã
 *
©å
, *
buf
)

2246 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2247 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2249  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2250 
	}
}

2251 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2253 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2254 
devi˚_©åibuã
 *
©å
, *
buf
)

2256 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2259  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2260 
	}
}

2262 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2266 i‡(
umˇ°_vÆ
 > 0) {

2267 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2268 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2271 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2272 
	}
}

2274 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2275 
devi˚_©åibuã
 *
©å
,

2276 c⁄° *
buf
, 
size_t
 
cou¡
)

2278 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2280 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2282  
cou¡
;

2283 
	}
}

2284 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2286 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2288  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2289 
	}
}

2291 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2293 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2294 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2296 
	`√tif_addr_lock_bh
(
√tdev
);

2298 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2299 &
gid
->
globÆ
.
öãrÁ˚_id
,

2300 (
gid
->
globÆ
.
öãrÁ˚_id
));

2301 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2302 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2304 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2306 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2307 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2308 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2309 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2310 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2312 
	}
}

2314 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2315 
sockaddr_°‹age
 *
ss
)

2317 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2318 
ªt
 = 0;

2320 
	`√tif_addr_lock_bh
(
dev
);

2325 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2326 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2327 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2328 
ªt
 = -
EINVAL
;

2330 
	`√tif_addr_u∆ock_bh
(
dev
);

2332  
ªt
;

2333 
	}
}

2335 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2337 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2338 
sockaddr_°‹age
 *
ss
 = 
addr
;

2339 
ªt
;

2341 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2342  -
EBUSY
;

2344 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2345 i‡(
ªt
)

2346  
ªt
;

2348 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2350 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2353 
	}
}

2355 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2356 
devi˚_©åibuã
 *
©å
,

2357 c⁄° *
buf
, 
size_t
 
cou¡
)

2359 
pkey
;

2360 
ªt
;

2362 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2363  -
EINVAL
;

2365 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2366  -
EINVAL
;

2368 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2370  
ªt
 ?Ñë : 
cou¡
;

2371 
	}
}

2372 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2374 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2375 
devi˚_©åibuã
 *
©å
,

2376 c⁄° *
buf
, 
size_t
 
cou¡
)

2378 
pkey
;

2379 
ªt
;

2381 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2382  -
EINVAL
;

2384 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2385  -
EINVAL
;

2387 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2389  
ªt
 ?Ñë : 
cou¡
;

2391 
	}
}

2392 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2394 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2396  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2397 
	}
}

2399 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2400 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2402 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2403 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2404 
ùoib_dev_¥iv
 *
¥iv
;

2405 
√t_devi˚
 *
ndev
;

2406 
ªsu…
;

2408 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2409 i‡(
	`IS_ERR
(
ndev
)) {

2410 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2411 
	`PTR_ERR
(
ndev
));

2412  
ndev
;

2414 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2416 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2417 
¥iv
->
ˇ
, 
ùoib_evít
);

2418 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2421 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2423 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2424 i‡(
ªsu…
) {

2425 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2426 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2428 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2429 
	`ùoib_ötf_‰ì
(
ndev
);

2430 
	`‰ì_√tdev
(
ndev
);

2432  
	`ERR_PTR
(
ªsu…
);

2435 i‡(
hˇ
->
rdma_√tdev_gë_∑øms
) {

2436 
rc
 = 
hˇ
->
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2437 
RDMA_NETDEV_IPOIB
,

2438 &
∑øms
);

2440 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2441 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2449 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2451 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2452 
sysfs_Áûed
;

2453 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2454 
sysfs_Áûed
;

2455 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2456 
sysfs_Áûed
;

2457 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2458 
sysfs_Áûed
;

2459 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2460 
sysfs_Áûed
;

2462  
ndev
;

2464 
sysfs_Áûed
:

2465 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2466 
	`uƒegi°î_√tdev
(
ndev
);

2467  
	`ERR_PTR
(-
ENOMEM
);

2468 
	}
}

2470 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2472 
li°_hód
 *
dev_li°
;

2473 
√t_devi˚
 *
dev
;

2474 
ùoib_dev_¥iv
 *
¥iv
;

2475 
p
;

2476 
cou¡
 = 0;

2478 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2479 i‡(!
dev_li°
)

2482 
	`INIT_LIST_HEAD
(
dev_li°
);

2484 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2485 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2487 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2488 i‡(!
	`IS_ERR
(
dev
)) {

2489 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2490 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2491 
cou¡
++;

2495 i‡(!
cou¡
) {

2496 
	`k‰ì
(
dev_li°
);

2500 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2501 
	}
}

2503 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2505 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2506 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2508 i‡(!
dev_li°
)

2511 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2512 
	`LIST_HEAD
(
hód
);

2513 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2515 
	`π∆_lock
();

2517 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2518 
li°
)

2519 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2520 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2521 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2523 
	`π∆_u∆ock
();

2526 
	`k‰ì
(
dev_li°
);

2527 
	}
}

2529 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2530 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2531 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2535 
__öô
 
	$ùoib_öô_moduÀ
()

2537 
ªt
;

2539 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2540 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2541 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2543 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2544 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2545 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2546 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2547 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2548 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2555 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2557 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2558 i‡(
ªt
)

2559  
ªt
;

2571 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2572 i‡(!
ùoib_w‹kqueue
) {

2573 
ªt
 = -
ENOMEM
;

2574 
îr_fs
;

2577 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2579 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2580 i‡(
ªt
)

2581 
îr_ß
;

2583 
ªt
 = 
	`ùoib_√éök_öô
();

2584 i‡(
ªt
)

2585 
îr_˛õ¡
;

2587 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2588 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2592 
îr_˛õ¡
:

2593 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2595 
îr_ß
:

2596 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2597 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2599 
îr_fs
:

2600 
	`ùoib_uƒegi°î_debugfs
();

2602  
ªt
;

2603 
	}
}

2605 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2607 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2608 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2610 
	`ùoib_√éök_föi
();

2611 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2612 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2613 
	`ùoib_uƒegi°î_debugfs
();

2614 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2615 
	}
}

2617 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2618 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL80/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@RHEL80/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL80/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
ENOSYS
)

172  -
ENODEV
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
ªc‹d
->
devi˚
->
«me
,Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@RHEL80/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

100 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
ndev
);

102 
	`ASSERT_RTNL
();

108 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

114 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

116 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

117 
ªsu…
 = -
EINVAL
;

118 
out_óæy
;

121 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

123 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

124 
¥iv
->
pkey
 =Ökey;

125 
¥iv
->
chûd_ty≥
 = 
ty≥
;

127 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

128 
ªsu…
 = -
ENOTUNIQ
;

129 
out_óæy
;

132 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

133 i‡(
ªsu…
) {

134 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

140 
out_óæy
;

144 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

145 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

146 
sysfs_Áûed
;

147 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

148 
sysfs_Áûed
;

149 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

150 
sysfs_Áûed
;

152 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

153 
sysfs_Áûed
;

158 
sysfs_Áûed
:

159 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

160  -
ENOMEM
;

162 
out_óæy
:

163 i‡(
ndev
->
¥iv_de°ru˘‹
)

164 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

165  
ªsu…
;

166 
	}
}

168 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

170 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

171 
ötf_«me
[
IFNAMSIZ
];

172 
√t_devi˚
 *
ndev
;

173 
ªsu…
;

175 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

176  -
EPERM
;

178 i‡(!
	`π∆_åylock
())

179  
	`ª°¨t_sysˇŒ
();

181 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

182 
	`π∆_u∆ock
();

183  -
EPERM
;

186 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

188 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

189 
µriv
->
dev
->
«me
, 
pkey
);

191 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

192 i‡(
	`IS_ERR
(
ndev
)) {

193 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

194 
out
;

196 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

198 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

200 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

201 
	`‰ì_√tdev
(
ndev
);

203 
out
:

204 
	`π∆_u∆ock
();

206  
ªsu…
;

207 
	}
}

209 
	sùoib_vœn_dñëe_w‹k
 {

210 
w‹k_°ru˘
 
	mw‹k
;

211 
√t_devi˚
 *
	mdev
;

224 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

226 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

227 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

228 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

230 
	`π∆_lock
();

233 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

234 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

235 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

237 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

238 
	`uƒegi°î_√tdevi˚
(
dev
);

241 
	`π∆_u∆ock
();

243 
	`k‰ì
(
pw‹k
);

244 
	}
}

246 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

248 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

249 
rc
;

251 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

252  -
EPERM
;

254 i‡(!
	`π∆_åylock
())

255  
	`ª°¨t_sysˇŒ
();

257 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

258 
	`π∆_u∆ock
();

259  -
EPERM
;

262 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

264 
rc
 = -
ENODEV
;

265 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

266 i‡(
¥iv
->
pkey
 ==Ökey &&

267 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

268 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

270 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

271 i‡(!
w‹k
) {

272 
rc
 = -
ENOMEM
;

273 
out
;

276 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

277 
	`li°_dñ_öô
(&
¥iv
->
li°
);

278 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

279 
w‹k
->
dev
 = 
¥iv
->dev;

280 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

281 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

283 
rc
 = 0;

288 
out
:

289 
	`π∆_u∆ock
();

291  
rc
;

292 
	}
}

	@RHEL81/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

845 
uöt
 
ùoib_ac˚l
;

	@RHEL81/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

359 (*
rx
->
rx_rög
)));

360 i‡(!
rx
->
rx_rög
)

361  -
ENOMEM
;

363 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

364 i‡(!
t
) {

365 
ªt
 = -
ENOMEM
;

366 
îr_‰ì_1
;

369 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

371 
	`•ö_lock_úq
(&
¥iv
->
lock
);

373 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

374 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

375 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

376 
ªt
 = -
EINVAL
;

377 
îr_‰ì
;

379 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

381 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

383 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

384 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

385 
rx
->
rx_rög
[
i
].
m≠pög
,

386 
GFP_KERNEL
)) {

387 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

388 
ªt
 = -
ENOMEM
;

389 
îr_cou¡
;

391 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

392 i‡(
ªt
) {

393 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

394 "Áûed f‹ bu‡%d\n", 
i
);

395 
ªt
 = -
EIO
;

396 
îr_cou¡
;

400 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

402 
	`k‰ì
(
t
);

406 
îr_cou¡
:

407 
	`•ö_lock_úq
(&
¥iv
->
lock
);

408 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

409 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

411 
îr_‰ì
:

412 
	`k‰ì
(
t
);

414 
îr_‰ì_1
:

415 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

417  
ªt
;

418 
	}
}

420 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

421 
ib_qp
 *
qp
,

422 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

443 c⁄° 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 c⁄° 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
,

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

644 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

645 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

984 c⁄° 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1073 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 c⁄° 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1440 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1441 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1443 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1444 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1445 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1446 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1449 
	`dev_k‰ì_skb_™y
(
skb
);

1451 
	`√tif_tx_lock_bh
(
dev
);

1452 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1455 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1456 
	`√tif_tx_u∆ock_bh
(
dev
);

1457 
	}
}

1459 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1460 
mtu
)

1462 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1463 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1465 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1574 (*
¥iv
->
cm
.
§q_rög
)));

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@RHEL81/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

141 
ETH_SS_TEST
:

145 
	}
}

146 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

147 
s£t
)

149 
s£t
) {

150 
ETH_SS_STATS
:

151  
IPOIB_GLOBAL_STATS_LEN
;

152 
ETH_SS_TEST
:

156  -
EOPNOTSUPP
;

157 
	}
}

160 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

162 
•ìd
) {

163 
IB_SPEED_SDR
:

164  
SPEED_2500
;

165 
IB_SPEED_DDR
:

166  
SPEED_5000
;

167 
IB_SPEED_QDR
:

168 
IB_SPEED_FDR10
:

169  
SPEED_10000
;

170 
IB_SPEED_FDR
:

171  
SPEED_14000
;

172 
IB_SPEED_EDR
:

173  
SPEED_25000
;

176  
SPEED_UNKNOWN
;

177 
	}
}

179 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

180 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

183 
ib_p‹t_©å
 
©å
;

184 
ªt
, 
•ìd
, 
width
;

186 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

187 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

188 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

192 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

193 i‡(
ªt
 < 0)

194  -
EINVAL
;

196 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

197 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

199 i‡(
•ìd
 < 0 || 
width
 < 0)

200  -
EINVAL
;

206 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

207 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

209 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

211 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

212 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

215 
	}
}

217 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

218 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

219 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

220 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

221 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

222 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

223 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

224 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

227 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

229 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

230 
	}
}

	@RHEL81/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@RHEL81/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
Êags
;

674 
	`√tif_tx_lock_bh
(
dev
);

675 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

677 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

678 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

679 
	`li°_dñ
(&
ah
->
li°
);

680 
	`rdma_de°roy_ah
(
ah
->ah, 0);

681 
	`k‰ì
(
ah
);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	`√tif_tx_u∆ock_bh
(
dev
);

686 
	}
}

688 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

690 
ùoib_dev_¥iv
 *
¥iv
 =

691 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

692 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

694 
	`__ùoib_ª≠_ah
(
dev
);

696 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

697 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

698 
	`round_jiffõs_ªœtive
(
HZ
));

699 
	}
}

701 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

705 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

706 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

707 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

708 
	}
}

710 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

712 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

714 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

715 
	`ùoib_Êush_ah
(
dev
);

716 
	}
}

718 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

720 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

721 
≥ndög
 = 0;

722 
i
;

724 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

725 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

726 ++
≥ndög
;

728  
≥ndög
;

729 
	}
}

731 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

732 
ib_qp
 *
qp
,

733 
ib_qp_°©e
 
√w_°©e
)

735 
ib_qp_©å
 
qp_©å
;

736 
ib_qp_öô_©å
 
quîy_öô_©å
;

737 
ªt
;

739 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

740 i‡(
ªt
) {

741 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

745 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

746 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

748 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

749 
√w_°©e
, 
qp_©å
.
qp_°©e
);

750 
	}
}

752 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

754 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

757 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

758 
	}
}

760 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

764 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

765 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

766 
	}
}

768 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
ib_qp_©å
 
qp_©å
;

772 
begö
;

773 
ùoib_tx_buf
 *
tx_ªq
;

774 
i
;

776 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

777 
	`ùoib_«pi_dißbÀ
(
dev
);

779 
	`ùoib_cm_dev_°›
(
dev
);

785 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

786 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

787 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

790 
begö
 = 
jiffõs
;

792 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

793 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

794 
	`ùoib_w¨n
(
¥iv
,

796 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

797 
	`ªcvs_≥ndög
(
dev
));

803 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

804 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

805 (
ùoib_£ndq_size
 - 1)];

806 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

807 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

808 ++
¥iv
->
tx_èû
;

811 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

812 
ùoib_rx_buf
 *
rx_ªq
;

814 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

815 i‡(!
rx_ªq
->
skb
)

817 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

818 
¥iv
->
rx_rög
[
i
].
m≠pög
);

819 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

820 
rx_ªq
->
skb
 = 
NULL
;

823 
timeout
;

826 
	`ùoib_døö_cq
(
dev
);

828 
	`u¶ìp_ønge
(1000, 2000);

831 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

833 
timeout
:

834 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

835 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

836 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

838 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

841 
	}
}

843 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

847 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

849 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

850 
	`ùoib_Êush_ah
(
dev
);

853 
	}
}

855 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

858 
ªt
;

860 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

861 i‡(
ªt
) {

862 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

866 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

867 i‡(
ªt
) {

868 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

869 
out
;

872 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

873 i‡(
ªt
) {

874 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

875 
out
;

878 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

879 
	`ùoib_«pi_íabÀ
(
dev
);

882 
out
:

884 
	}
}

886 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

888 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

890 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

892 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

893 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

894 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

898 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

899 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

900 
	`round_jiffõs_ªœtive
(
HZ
));

902 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

903 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

904 
dev_°›
;

907 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

911 
dev_°›
:

912 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

913 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

914 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

915 
	`ùoib_ib_dev_°›
(
dev
);

917 
	}
}

919 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

921 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

922 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

924 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

925 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

926 &
¥iv
->
pkey_ödex
)) {

927 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

929 i‡(
∫
->
£t_id
)

930 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

931 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

933 
	}
}

935 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

939 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

941 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

942 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

946 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

948 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

949 
	}
}

951 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

953 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

955 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

957 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

958 
	`√tif_ˇºõr_off
(
dev
);

960 
	`ùoib_mˇ°_°›_thªad
(
dev
);

961 
	`ùoib_mˇ°_dev_Êush
(
dev
);

963 
	`ùoib_Êush_∑ths
(
dev
);

964 
	}
}

966 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

968 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

969 
i
, 
n
;

976 
	`loˇl_bh_dißbÀ
();

979 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

980 
i
 = 0; i < 
n
; ++i) {

986 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

987 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

989 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

991 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

993 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

998 } 
n
 =
IPOIB_NUM_WC
);

1000 
	`pﬁl_tx
(
¥iv
))

1003 
	`loˇl_bh_íabÀ
();

1004 
	}
}

1010 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1012 
ªsu…
;

1013 
u16
 
¥ev_pkey
;

1015 
¥ev_pkey
 = 
¥iv
->
pkey
;

1016 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1017 i‡(
ªsu…
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1019 
¥iv
->
p‹t
, 
ªsu…
);

1020  
ªsu…
;

1023 
¥iv
->
pkey
 |= 0x8000;

1025 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1026 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1027 
¥ev_pkey
, 
¥iv
->
pkey
);

1032 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1033 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1038 
	}
}

1042 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1044 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1046 
¥iv
->
pkey_ödex
 = 0;

1047 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1049 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1050 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1053 
	}
}

1059 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1061 
ib_gid
 
£¨ch_gid
;

1062 
ib_gid
 
gid0
;

1063 
ib_gid
 *
√tdev_gid
;

1064 
îr
;

1065 
u16
 
ödex
;

1066 
u8
 
p‹t
;

1067 
boﬁ
 
ªt
 = 
Ál£
;

1069 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1070 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1071  
Ál£
;

1073 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1078 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1079 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1084 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1086 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1088 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1090 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1091 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1095 
out
;

1122 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1123 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1124 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1125 i‡(
ödex
 == 0)

1126 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1127 &
¥iv
->
Êags
);

1129 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1130 
ªt
 = 
åue
;

1132 
ªt
 = 
Ál£
;

1135 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1136 
ªt
 = 
åue
;

1138 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1139 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1140 (
¥iv
->
loˇl_gid
));

1141 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1142 (
¥iv
->
loˇl_gid
));

1143 
ªt
 = 
åue
;

1148 
out
:

1149 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1151  
ªt
;

1152 
	}
}

1154 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1155 
ùoib_Êush_Àvñ
 
Àvñ
,

1156 
√°ög
)

1158 
ùoib_dev_¥iv
 *
˝riv
;

1159 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1160 
ªsu…
;

1162 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1168 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1169 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1171 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1173 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1174 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1176 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1177 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1178 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1182 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1184 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1185 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1186 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1188 
	`upd©e_chûd_pkey
(
¥iv
);

1189 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1190 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1191 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1195 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1199 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1200 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1201 i‡(
ªsu…
) {

1203 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1208 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1210 i‡(
ªsu…
) {

1211 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1217 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1218 
›î_up
;

1219 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1225 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1226 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1227 i‡(
›î_up
)

1228 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1229 
	`ùoib_Êush_ah
(
dev
);

1232 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1233 
	`ùoib_ib_dev_down
(
dev
);

1235 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1236 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1237 
	`ùoib_ib_dev_°›
(
dev
);

1239 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1242 i‡(
	`√tif_queue_°›≥d
(
dev
))

1243 
	`√tif_°¨t_queue
(
dev
);

1250 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1251 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1252 
	`ùoib_ib_dev_up
(
dev
);

1253 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1254 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1256 
	}
}

1258 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1260 
ùoib_dev_¥iv
 *
¥iv
 =

1261 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1263 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1264 
	}
}

1266 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1268 
ùoib_dev_¥iv
 *
¥iv
 =

1269 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1271 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1272 
	}
}

1274 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1276 
ùoib_dev_¥iv
 *
¥iv
 =

1277 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1279 
	`π∆_lock
();

1280 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1281 
	`π∆_u∆ock
();

1282 
	}
}

1284 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1286 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1288 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1293 
	`ùoib_Êush_∑ths
(
dev
);

1295 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1296 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1304 
	`ùoib_°›_ah
(
dev
);

1306 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1308 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1310 i‡(
¥iv
->
pd
) {

1311 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1312 
¥iv
->
pd
 = 
NULL
;

1314 
	}
}

	@RHEL81/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
, 
NULL
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
, 
NULL
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

247 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

248  -
EINVAL
;

250 
¥iv
->
admö_mtu
 = 
√w_mtu
;

252 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

253 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

254 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

256 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

258 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

259 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

261 
	`√tif_ˇºõr_off
(
dev
);

264 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

266 i‡(
ˇºõr_°©us
)

267 
	`√tif_ˇºõr_⁄
(
dev
);

269 
dev
->
mtu
 = 
√w_mtu
;

272  
ªt
;

273 
	}
}

275 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

276 
π∆_lök_°©s64
 *
°©s
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

281 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

283 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

284 
	}
}

287 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

288 
√t_devi˚
 *
dev
)

290 
√t
 *√à
	`dev_√t
(
dev
);

291 
ö_devi˚
 *
ö_dev
;

292 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

293 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

294 
__be32
 
ªt_addr
;

296 
addr
->
ß_Ámûy
) {

297 
AF_INET
:

298 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

299 i‡(!
ö_dev
)

300  
Ál£
;

302 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

303 
addr_ö
->
sö_addr
.
s_addr
,

304 
RT_SCOPE_HOST
);

305 
	`ö_dev_put
(
ö_dev
);

306 i‡(
ªt_addr
)

307  
åue
;

310 
AF_INET6
:

311 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

312 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

313  
åue
;

317  
Ál£
;

318 
	}
}

327 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

329 
√t_devi˚
 *
ma°î
;

331 
	`rcu_ªad_lock
();

332 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

333 i‡(
ma°î
)

334 
	`dev_hﬁd
(
ma°î
);

335 
	`rcu_ªad_u∆ock
();

337 i‡(
ma°î
)

338  
ma°î
;

340 
	`dev_hﬁd
(
dev
);

341  
dev
;

342 
	}
}

344 
	sùoib_wÆk_d©a
 {

345 c⁄° 
sockaddr
 *
	maddr
;

346 
√t_devi˚
 *
	mªsu…
;

349 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

351 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

352 
ªt
 = 0;

354 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

355 
	`dev_hﬁd
(
uµî
);

356 
d©a
->
ªsu…
 = 
uµî
;

357 
ªt
 = 1;

360  
ªt
;

361 
	}
}

372 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

373 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

375 
ùoib_wÆk_d©a
 
d©a
 = {

376 .
addr
 =áddr,

379 
	`rcu_ªad_lock
();

380 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

381 
	`dev_hﬁd
(
dev
);

382 
d©a
.
ªsu…
 = 
dev
;

383 
out
;

386 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

387 
out
:

388 
	`rcu_ªad_u∆ock
();

389  
d©a
.
ªsu…
;

390 
	}
}

397 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

398 c⁄° 
ib_gid
 *
gid
,

399 
u16
 
pkey_ödex
,

400 c⁄° 
sockaddr
 *
addr
,

401 
√°ög
,

402 
√t_devi˚
 **
found_√t_dev
)

404 
ùoib_dev_¥iv
 *
chûd_¥iv
;

405 
√t_devi˚
 *
√t_dev
 = 
NULL
;

406 
m©ches
 = 0;

408 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

409 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

410 i‡(!
addr
) {

411 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

415 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

417 i‡(
√t_dev
) {

418 i‡(!*
found_√t_dev
)

419 *
found_√t_dev
 = 
√t_dev
;

421 
	`dev_put
(
√t_dev
);

422 ++
m©ches
;

427 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

428 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

429 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

430 
pkey_ödex
, 
addr
,

431 
√°ög
 + 1,

432 
found_√t_dev
);

433 i‡(
m©ches
 > 1)

436 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

438  
m©ches
;

439 
	}
}

444 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

445 
u16
 
pkey_ödex
,

446 c⁄° 
ib_gid
 *
gid
,

447 c⁄° 
sockaddr
 *
addr
,

448 
√t_devi˚
 **
√t_dev
)

450 
ùoib_dev_¥iv
 *
¥iv
;

451 
m©ches
 = 0;

453 *
√t_dev
 = 
NULL
;

455 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

456 i‡(
¥iv
->
p‹t
 !=Öort)

459 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

460 
addr
, 0, 
√t_dev
);

461 i‡(
m©ches
 > 1)

465  
m©ches
;

466 
	}
}

468 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

469 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

470 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

471 *
˛õ¡_d©a
)

473 
√t_devi˚
 *
√t_dev
;

474 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

475 
u16
 
pkey_ödex
;

476 
m©ches
;

477 
ªt
;

479 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

480  
NULL
;

482 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

483 i‡(
ªt
)

484  
NULL
;

486 i‡(!
dev_li°
)

487  
NULL
;

490 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

491 
gid
, 
NULL
, &
√t_dev
);

493 
m©ches
) {

495  
NULL
;

497  
√t_dev
;

500 
	`dev_put
(
√t_dev
);

504 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

505 
gid
, 
addr
, &
√t_dev
);

506 
m©ches
) {

508  
NULL
;

510 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

514  
√t_dev
;

516 
	}
}

518 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

522 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

523 !
	`°rcmp
(
buf
, "connected\n")) ||

524 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "datagram\n"))) {

530 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

531 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

532 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

534 
	`√tdev_upd©e_„©uªs
(
dev
);

535 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

536 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

537 
	`π∆_u∆ock
();

538 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

540 
	`ùoib_Êush_∑ths
(
dev
);

541  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

544 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

545 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

546 
	`√tdev_upd©e_„©uªs
(
dev
);

547 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

548 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

549 
	`π∆_u∆ock
();

550 
	`ùoib_Êush_∑ths
(
dev
);

551  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

554  -
EINVAL
;

555 
	}
}

557 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

560 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

561 
ùoib_∑th
 *
∑th
;

562 
ªt
;

564 
n
) {

565 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

567 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

568  (
ib_gid
));

570 i‡(
ªt
 < 0)

571 
n
 =Ç->
rb_À·
;

572 i‡(
ªt
 > 0)

573 
n
 =Ç->
rb_right
;

575  
∑th
;

578  
NULL
;

579 
	}
}

581 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

584 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

585 
rb_node
 *
≤
 = 
NULL
;

586 
ùoib_∑th
 *
ç©h
;

587 
ªt
;

589 *
n
) {

590 
≤
 = *
n
;

591 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

593 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

594  (
ib_gid
));

595 i‡(
ªt
 < 0)

596 
n
 = &
≤
->
rb_À·
;

597 i‡(
ªt
 > 0)

598 
n
 = &
≤
->
rb_right
;

600  -
EEXIST
;

603 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

604 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

606 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

609 
	}
}

611 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

613 
sk_buff
 *
skb
;

615 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

616 
	`dev_k‰ì_skb_úq
(
skb
);

618 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

621 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

623 i‡(
∑th
->
ah
)

624 
	`ùoib_put_ah
(
∑th
->
ah
);

626 
	`k‰ì
(
∑th
);

627 
	}
}

629 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


631 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

633 
ùoib_∑th_ôî
 *
ôî
;

635 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

636 i‡(!
ôî
)

637  
NULL
;

639 
ôî
->
dev
 = dev;

640 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

642 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

643 
	`k‰ì
(
ôî
);

644  
NULL
;

647  
ôî
;

648 
	}
}

650 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

653 
rb_node
 *
n
;

654 
ùoib_∑th
 *
∑th
;

655 
ªt
 = 1;

657 
	`•ö_lock_úq
(&
¥iv
->
lock
);

659 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

661 
n
) {

662 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

664 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

665  (
ib_gid
)) < 0) {

666 
ôî
->
∑th
 = *path;

667 
ªt
 = 0;

671 
n
 = 
	`rb_√xt
(n);

674 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676  
ªt
;

677 
	}
}

679 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

680 
ùoib_∑th
 *
∑th
)

682 *
∑th
 = 
ôî
->path;

683 
	}
}

687 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

690 
ùoib_∑th
 *
∑th
, *
ç
;

692 
	`•ö_lock_úq
(&
¥iv
->
lock
);

694 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

695 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

696 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

697 
∑th
->
∑thªc
.
dgid
.
øw
);

698 i‡(
∑th
->
ah
)

699 
∑th
->
ah
->
vÆid
 = 0;

702 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

703 
	}
}

705 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

707 
ùoib_p£udo_hódî
 *
phdr
;

709 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

710 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

711 
	}
}

713 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

715 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
ùoib_∑th
 *
∑th
, *
ç
;

717 
	`LIST_HEAD
(
ªmove_li°
);

718 
Êags
;

720 
	`√tif_tx_lock_bh
(
dev
);

721 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

723 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

725 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

726 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

728 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

729 i‡(
∑th
->
quîy
)

730 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

731 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

732 
	`√tif_tx_u∆ock_bh
(
dev
);

733 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

734 
	`∑th_‰ì
(
dev
, 
∑th
);

735 
	`√tif_tx_lock_bh
(
dev
);

736 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	}
}

743 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

744 
ß_∑th_ªc
 *
∑thªc
,

745 *
∑th_±r
)

747 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

748 
√t_devi˚
 *
dev
 = 
∑th
->dev;

749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

750 
ùoib_ah
 *
ah
 = 
NULL
;

751 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

752 
ùoib_√igh
 *
√igh
, *
ä
;

753 
sk_buff_hód
 
skqueue
;

754 
sk_buff
 *
skb
;

755 
Êags
;

757 i‡(!
°©us
)

758 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

759 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

760 
∑thªc
->
dgid
.
øw
);

762 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

763 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

765 
	`skb_queue_hód_öô
(&
skqueue
);

767 i‡(!
°©us
) {

768 
rdma_ah_©å
 
av
;

770 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

771 
∑thªc
, &
av
, 
NULL
)) {

772 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

773 
	`rdma_de°roy_ah_©å
(&
av
);

777 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

779 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

785 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

786 (
ib_gid
))) {

787 
	`ùoib_dbg
(

788 
¥iv
,

790 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

791 
∑th
->
∑thªc
.
dgid
.
øw
);

792 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

793 (
ib_gid
));

796 
∑th
->
∑thªc
 = *pathrec;

798 
ﬁd_ah
 = 
∑th
->
ah
;

799 
∑th
->
ah
 =áh;

801 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

802 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

803 
∑thªc
->
¶
);

805 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

806 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

808 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

809 i‡(
√igh
->
ah
) {

810 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

818 
	`ùoib_put_ah
(
√igh
->
ah
);

820 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

821 
√igh
->
ah
 = 
∑th
->ah;

823 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

824 i‡(!
	`ùoib_cm_gë
(
√igh
))

825 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

826 
∑th
,

827 
√igh
));

828 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

829 
	`ùoib_√igh_‰ì
(
√igh
);

834 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

835 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

837 
∑th
->
ah
->
vÆid
 = 1;

840 
∑th
->
quîy
 = 
NULL
;

841 
	`com∂ëe
(&
∑th
->
d⁄e
);

843 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 i‡(
	`IS_ERR_OR_NULL
(
ah
))

846 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

848 i‡(
ﬁd_ah
)

849 
	`ùoib_put_ah
(
ﬁd_ah
);

851 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

852 
ªt
;

853 
skb
->
dev
 = dev;

854 
ªt
 = 
	`dev_queue_xmô
(
skb
);

855 i‡(
ªt
)

856 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

857 
__func__
, 
ªt
);

859 
	}
}

861 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

862 *
gid
)

864 
∑th
->
dev
 = 
¥iv
->dev;

866 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

867 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

871 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

872 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

873 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

874 
∑th
->
∑thªc
.
numb_∑th
 = 1;

875 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

876 
	}
}

878 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

880 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

881 
ùoib_∑th
 *
∑th
;

883 i‡(!
¥iv
->
brﬂdˇ°
)

884  
NULL
;

886 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

887 i‡(!
∑th
)

888  
NULL
;

890 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

892 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

894 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

896  
∑th
;

897 
	}
}

899 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

900 
ùoib_∑th
 *
∑th
)

902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

905 
∑th
->
∑thªc
.
dgid
.
øw
);

907 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

909 
∑th
->
quîy_id
 =

910 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

911 &
∑th
->
∑thªc
,

912 
IB_SA_PATH_REC_DGID
 |

913 
IB_SA_PATH_REC_SGID
 |

914 
IB_SA_PATH_REC_NUMB_PATH
 |

915 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

916 
IB_SA_PATH_REC_PKEY
,

917 1000, 
GFP_ATOMIC
,

918 
∑th_ªc_com∂ëi⁄
,

919 
∑th
, &∑th->
quîy
);

920 i‡(
∑th
->
quîy_id
 < 0) {

921 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

922 
∑th
->
quîy
 = 
NULL
;

923 
	`com∂ëe
(&
∑th
->
d⁄e
);

924  
∑th
->
quîy_id
;

928 
	}
}

930 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

931 
√t_devi˚
 *
dev
)

933 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

934 
ùoib_∑th
 *
∑th
;

935 
Êags
;

937 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

939 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

940 i‡(!
∑th
)

941 
out
;

942 i‡(!
∑th
->
quîy
)

943 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

944 
out
:

945 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

946 
	}
}

948 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

949 
√t_devi˚
 *
dev
)

951 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

952 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

953 
ùoib_∑th
 *
∑th
;

954 
ùoib_√igh
 *
√igh
;

955 
Êags
;

957 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

958 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

959 i‡(!
√igh
) {

960 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

961 ++
dev
->
°©s
.
tx_dr›≥d
;

962 
	`dev_k‰ì_skb_™y
(
skb
);

963  
NULL
;

969 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

970 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

971  
√igh
;

974 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

975 i‡(!
∑th
) {

976 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
)

978 
îr_∑th
;

980 
	`__∑th_add
(
dev
, 
∑th
);

983 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

985 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

986 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

987 
√igh
->
ah
 = 
∑th
->ah;

989 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

990 i‡(!
	`ùoib_cm_gë
(
√igh
))

991 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

992 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

993 
	`ùoib_√igh_‰ì
(
√igh
);

994 
îr_dr›
;

996 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

997 
IPOIB_MAX_PATH_REC_QUEUE
) {

998 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

999 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1001 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1002 
	`skb_queue_Àn
(&
√igh
->
queue
));

1003 
îr_dr›
;

1006 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1007 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1008 
	`IPOIB_QPN
(
daddr
));

1009 
	`ùoib_√igh_put
(
√igh
);

1010  
NULL
;

1013 
√igh
->
ah
 = 
NULL
;

1015 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1016 
îr_∑th
;

1017 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1018 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1019 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1021 
îr_dr›
;

1025 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1026 
	`ùoib_√igh_put
(
√igh
);

1027  
NULL
;

1029 
îr_∑th
:

1030 
	`ùoib_√igh_‰ì
(
√igh
);

1031 
îr_dr›
:

1032 ++
dev
->
°©s
.
tx_dr›≥d
;

1033 
	`dev_k‰ì_skb_™y
(
skb
);

1035 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1036 
	`ùoib_√igh_put
(
√igh
);

1038  
NULL
;

1039 
	}
}

1041 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1042 
ùoib_p£udo_hódî
 *
phdr
)

1044 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1045 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1046 
ùoib_∑th
 *
∑th
;

1047 
Êags
;

1049 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1052 i‡(!
¥iv
->
brﬂdˇ°
)

1053 
dr›_™d_u∆ock
;

1055 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1056 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1057 i‡(!
∑th
) {

1058 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1059 i‡(!
∑th
)

1060 
dr›_™d_u∆ock
;

1061 
	`__∑th_add
(
dev
, 
∑th
);

1067 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
dr›_™d_u∆ock
;

1073 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1074 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1075 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1076 
u∆ock
;

1078 
dr›_™d_u∆ock
;

1082 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1083 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1084 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1089 
dr›_™d_u∆ock
:

1090 ++
dev
->
°©s
.
tx_dr›≥d
;

1091 
	`dev_k‰ì_skb_™y
(
skb
);

1092 
u∆ock
:

1093 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1094 
	}
}

1096 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1098 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1099 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1100 
ùoib_√igh
 *
√igh
;

1101 
ùoib_p£udo_hódî
 *
phdr
;

1102 
ùoib_hódî
 *
hódî
;

1103 
Êags
;

1105 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1106 
	`skb_puŒ
(
skb
, (*
phdr
));

1107 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1109 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1111 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1117 ++
dev
->
°©s
.
tx_dr›≥d
;

1118 
	`dev_k‰ì_skb_™y
(
skb
);

1119  
NETDEV_TX_OK
;

1122 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1123 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1125 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1126 i‡(
	`likñy
(
√igh
))

1127 
£nd_usög_√igh
;

1128 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1129  
NETDEV_TX_OK
;

1133 
hódî
->
¥Ÿo
) {

1134 
	`ht⁄s
(
ETH_P_IP
):

1135 
	`ht⁄s
(
ETH_P_IPV6
):

1136 
	`ht⁄s
(
ETH_P_TIPC
):

1137 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1138 i‡(
	`u∆ikñy
(!
√igh
)) {

1139 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1140 i‡(
	`likñy
(!
√igh
))

1141  
NETDEV_TX_OK
;

1144 
	`ht⁄s
(
ETH_P_ARP
):

1145 
	`ht⁄s
(
ETH_P_RARP
):

1147 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1148  
NETDEV_TX_OK
;

1151 ++
dev
->
°©s
.
tx_dr›≥d
;

1152 
	`dev_k‰ì_skb_™y
(
skb
);

1153  
NETDEV_TX_OK
;

1156 
£nd_usög_√igh
:

1158 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1159 i‡(
	`ùoib_cm_up
(
√igh
)) {

1160 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1161 
uƒef
;

1163 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1164 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1165 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1166 
uƒef
;

1167 } i‡(
√igh
->
ah
) {

1168 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1171 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1172 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1173 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1174 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1175 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1177 ++
dev
->
°©s
.
tx_dr›≥d
;

1178 
	`dev_k‰ì_skb_™y
(
skb
);

1181 
uƒef
:

1182 
	`ùoib_√igh_put
(
√igh
);

1184  
NETDEV_TX_OK
;

1185 
	}
}

1187 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1191 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1192 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1193 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1194 
	`√tif_queue_°›≥d
(
dev
),

1195 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1197 
	}
}

1199 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1200 
√t_devi˚
 *
dev
,

1201 
ty≥
,

1202 c⁄° *
daddr
,

1203 c⁄° *
ßddr
,

1204 
Àn
)

1206 
ùoib_hódî
 *
hódî
;

1208 
hódî
 = 
	`skb_push
(
skb
, (*header));

1210 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1211 
hódî
->
ª£rved
 = 0;

1218 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1220  
IPOIB_HARD_LEN
;

1221 
	}
}

1223 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1225 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1227 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1228 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1232 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1233 
	}
}

1235 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1240 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1241  
dev
->
ifödex
;

1244  
¥iv
->
∑ª¡
->
ifödex
;

1245 
	}
}

1247 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1256 
u32
 *
d32
 = (u32 *Ë
daddr
;

1257 
u32
 
hv
;

1259 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1260  
hv
 & 
htbl
->
mask
;

1261 
	}
}

1263 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1265 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1266 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1267 
ùoib_√igh_hash
 *
htbl
;

1268 
ùoib_√igh
 *
√igh
 = 
NULL
;

1269 
u32
 
hash_vÆ
;

1271 
	`rcu_ªad_lock_bh
();

1273 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1275 i‡(!
htbl
)

1276 
out_u∆ock
;

1278 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1279 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1280 
√igh
 !
NULL
;

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1282 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1284 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1286 
√igh
 = 
NULL
;

1287 
out_u∆ock
;

1290 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1291 
√igh
->
Æive
 = 
jiffõs
;

1292 
out_u∆ock
;

1296 
out_u∆ock
:

1297 
	`rcu_ªad_u∆ock_bh
();

1298  
√igh
;

1299 
	}
}

1301 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1303 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1304 
ùoib_√igh_hash
 *
htbl
;

1305 
√igh_obsﬁëe
;

1306 
dt
;

1307 
Êags
;

1308 
i
;

1309 
	`LIST_HEAD
(
ªmove_li°
);

1311 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1313 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1314 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1316 i‡(!
htbl
)

1317 
out_u∆ock
;

1320 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1321 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1323 
i
 = 0; i < 
htbl
->
size
; i++) {

1324 
ùoib_√igh
 *
√igh
;

1325 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1327 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1328 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1330 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1332 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1334 
	`rcu_assign_poöãr
(*
≈
,

1335 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1338 
	`li°_dñ_öô
(&
√igh
->
li°
);

1339 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1341 
≈
 = &
√igh
->
h√xt
;

1347 
out_u∆ock
:

1348 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1349 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1350 
	}
}

1352 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1354 
ùoib_dev_¥iv
 *
¥iv
 =

1355 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1357 
	`__ùoib_ª≠_√igh
(
¥iv
);

1359 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1360 
¨p_tbl
.
gc_öãrvÆ
);

1361 
	}
}

1364 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1365 
√t_devi˚
 *
dev
)

1367 
ùoib_√igh
 *
√igh
;

1369 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1370 i‡(!
√igh
)

1371  
NULL
;

1373 
√igh
->
dev
 = dev;

1374 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1375 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1376 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1377 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1379 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1381  
√igh
;

1382 
	}
}

1384 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1385 
√t_devi˚
 *
dev
)

1387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1388 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1389 
ùoib_√igh_hash
 *
htbl
;

1390 
ùoib_√igh
 *
√igh
;

1391 
u32
 
hash_vÆ
;

1393 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1394 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1395 i‡(!
htbl
) {

1396 
√igh
 = 
NULL
;

1397 
out_u∆ock
;

1403 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1406 
√igh
 !
NULL
;

1407 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1408 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1409 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1411 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1413 
√igh
 = 
NULL
;

1416 
√igh
->
Æive
 = 
jiffõs
;

1417 
out_u∆ock
;

1421 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1422 i‡(!
√igh
)

1423 
out_u∆ock
;

1426 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1427 
√igh
->
Æive
 = 
jiffõs
;

1429 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1430 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1431 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1432 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1433 
	`©omic_öc
(&
¡bl
->
íåõs
);

1435 
out_u∆ock
:

1437  
√igh
;

1438 
	}
}

1440 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1443 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1444 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1445 
sk_buff
 *
skb
;

1446 i‡(
√igh
->
ah
)

1447 
	`ùoib_put_ah
(
√igh
->
ah
);

1448 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1449 ++
dev
->
°©s
.
tx_dr›≥d
;

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 i‡(
	`ùoib_cm_gë
(
√igh
))

1453 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1454 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1456 
	`IPOIB_QPN
(
√igh
->
daddr
),

1457 
√igh
->
daddr
 + 4);

1458 
	`k‰ì
(
√igh
);

1459 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1460 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1461 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1463 
	}
}

1465 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1468 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1470 
	`ùoib_√igh_put
(
√igh
);

1471 
	}
}

1473 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1475 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1477 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1478 
ùoib_√igh_hash
 *
htbl
;

1479 
ùoib_√igh
 
__rcu
 **
≈
;

1480 
ùoib_√igh
 *
n
;

1481 
u32
 
hash_vÆ
;

1483 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1484 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1485 i‡(!
htbl
)

1488 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1489 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1492 
n
 !
NULL
;

1493 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1494 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1495 i‡(
n
 =
√igh
) {

1497 
	`rcu_assign_poöãr
(*
≈
,

1498 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1499 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1501 
	`li°_dñ_öô
(&
√igh
->
li°
);

1502 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1505 
≈
 = &
n
->
h√xt
;

1508 
	}
}

1510 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1512 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1513 
ùoib_√igh_hash
 *
htbl
;

1514 
ùoib_√igh
 
__rcu
 **
buckës
;

1515 
u32
 
size
;

1517 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1518 
¡bl
->
htbl
 = 
NULL
;

1519 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1520 i‡(!
htbl
)

1521  -
ENOMEM
;

1522 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1523 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1524 i‡(!
buckës
) {

1525 
	`k‰ì
(
htbl
);

1526  -
ENOMEM
;

1528 
htbl
->
size
 = size;

1529 
htbl
->
mask
 = (
size
 - 1);

1530 
htbl
->
buckës
 = buckets;

1531 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1532 
htbl
->
¡bl
 =Çtbl;

1533 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1536 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1537 
¨p_tbl
.
gc_öãrvÆ
);

1540 
	}
}

1542 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1544 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1545 
ùoib_√igh_hash
,

1546 
rcu
);

1547 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1548 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1550 
	`kv‰ì
(
buckës
);

1551 
	`k‰ì
(
htbl
);

1552 
	`com∂ëe
(&
¡bl
->
dñëed
);

1553 
	}
}

1555 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1557 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1558 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1559 
ùoib_√igh_hash
 *
htbl
;

1560 
Êags
;

1561 
i
;

1564 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1566 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1567 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1569 i‡(!
htbl
)

1570 
out_u∆ock
;

1572 
i
 = 0; i < 
htbl
->
size
; i++) {

1573 
ùoib_√igh
 *
√igh
;

1574 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1576 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1577 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1579 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1580 
	`rcu_assign_poöãr
(*
≈
,

1581 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1582 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1584 
	`li°_dñ_öô
(&
√igh
->
li°
);

1585 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1587 
≈
 = &
√igh
->
h√xt
;

1592 
out_u∆ock
:

1593 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1594 
	}
}

1596 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1598 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1599 
ùoib_√igh_hash
 *
htbl
;

1600 
Êags
;

1601 
i
, 
waô_Êushed
 = 0;

1603 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1604 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1608 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1609 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1610 i‡(!
htbl
)

1611 
out_u∆ock
;

1613 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1614 i‡(!
waô_Êushed
)

1615 
‰ì_htbl
;

1617 
i
 = 0; i < 
htbl
->
size
; i++) {

1618 
ùoib_√igh
 *
√igh
;

1619 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1621 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1623 
	`rcu_assign_poöãr
(*
≈
,

1624 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1625 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1627 
	`li°_dñ_öô
(&
√igh
->
li°
);

1628 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1632 
‰ì_htbl
:

1633 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1634 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1636 
out_u∆ock
:

1637 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1638 i‡(
waô_Êushed
)

1639 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1640 
	}
}

1642 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1647 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1649 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1651 
	`ùoib_Êush_√ighs
(
¥iv
);

1653 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1654 
	}
}

1656 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1660 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1661 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1662 
	}
}

1664 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1666 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1668 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1669 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1670 
	}
}

1672 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1674 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1676 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1678 
	`ùoib_«pi_dñ
(
dev
);

1680 
	`ùoib_cm_dev_˛ónup
(
dev
);

1682 
	`k‰ì
(
¥iv
->
rx_rög
);

1683 
	`v‰ì
(
¥iv
->
tx_rög
);

1685 
¥iv
->
rx_rög
 = 
NULL
;

1686 
¥iv
->
tx_rög
 = 
NULL
;

1687 
	}
}

1689 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1693 
	`ùoib_«pi_add
(
dev
);

1696 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1697 (*
¥iv
->
rx_rög
),

1698 
GFP_KERNEL
);

1699 i‡(!
¥iv
->
rx_rög
)

1700 
out
;

1702 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1703 (*
¥iv
->
tx_rög
)));

1704 i‡(!
¥iv
->
tx_rög
) {

1705 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1706 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1707 
out_rx_rög_˛ónup
;

1712 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1713 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1714 
¥iv
->
ˇ
->
«me
);

1715 
out_tx_rög_˛ónup
;

1719 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1720 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1721 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1725 
out_tx_rög_˛ónup
:

1726 
	`v‰ì
(
¥iv
->
tx_rög
);

1728 
out_rx_rög_˛ónup
:

1729 
	`k‰ì
(
¥iv
->
rx_rög
);

1731 
out
:

1732 
	`ùoib_«pi_dñ
(
dev
);

1733  -
ENOMEM
;

1734 
	}
}

1736 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1737 
cmd
)

1739 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1741 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1742  -
EOPNOTSUPP
;

1744  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1745 
	}
}

1747 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1750 
ªt
 = -
ENOMEM
;

1752 
¥iv
->
qp
 = 
NULL
;

1758 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1759 i‡(!
¥iv
->
wq
) {

1760 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1761 
out
;

1765 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1766 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1767 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1768 
˛ón_wq
;

1771 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1772 i‡(
ªt
) {

1773 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1774 
out_‰ì_pd
;

1777 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1778 i‡(
ªt
) {

1779 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1780 
out_dev_unöô
;

1783 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1784 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1785 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1786 
ªt
 = -
ENODEV
;

1787 
out_hash_unöô
;

1793 
out_hash_unöô
:

1794 
	`ùoib_√igh_hash_unöô
(
dev
);

1796 
out_dev_unöô
:

1797 
	`ùoib_ib_dev_˛ónup
(
dev
);

1799 
out_‰ì_pd
:

1800 i‡(
¥iv
->
pd
) {

1801 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1802 
¥iv
->
pd
 = 
NULL
;

1805 
˛ón_wq
:

1806 i‡(
¥iv
->
wq
) {

1807 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1808 
¥iv
->
wq
 = 
NULL
;

1811 
out
:

1812  
ªt
;

1813 
	}
}

1819 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1821 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1827 
	`π∆_lock
();

1828 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
, 
NULL
);

1829 
	`π∆_u∆ock
();

1832 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1838 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1839 
	}
}

1841 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1843 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1845 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1846 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1848 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1849 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1851 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1853 
	}
}

1855 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1858 
ib_p‹t_©å
 
©å
;

1859 
ªsu…
;

1861 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1862 i‡(
ªsu…
) {

1863 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1864 
¥iv
->
p‹t
);

1865  
ªsu…
;

1867 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1868 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1870 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1872 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1873 i‡(
ªsu…
) {

1874 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1875 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1876  
ªsu…
;

1879 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1880 i‡(
ªsu…
) {

1881 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1882 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1883  
ªsu…
;

1885 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1886 (
ib_gid
));

1888 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1889 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1891 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1894 
	}
}

1896 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1898 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1899 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1901 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1902 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1903 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1904 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1905 
	}
}

1907 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1909 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1910 
rdma_√tdev
 *
∫
;

1911 
rc
;

1913 i‡(
¥iv
->
∑ª¡
) {

1914 
	`ùoib_chûd_öô
(
ndev
);

1916 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1917 i‡(
rc
)

1918  
rc
;

1922 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1923 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1924 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1925 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1926 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1928 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1934 
¥iv
->
pkey
 |= 0x8000;

1936 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1937 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1938 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1940 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1942 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1943 i‡(
rc
) {

1944 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1945 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1946  
rc
;

1949 i‡(
¥iv
->
∑ª¡
) {

1950 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1952 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1954 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1955 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1956 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1960 
	}
}

1962 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1964 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1966 
	`ASSERT_RTNL
();

1972 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1974 i‡(
¥iv
->
∑ª¡
) {

1975 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1977 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1978 
	`li°_dñ
(&
¥iv
->
li°
);

1979 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`ùoib_√igh_hash_unöô
(
dev
);

1984 
	`ùoib_ib_dev_˛ónup
(
dev
);

1987 i‡(
¥iv
->
wq
) {

1988 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1989 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1990 
¥iv
->
wq
 = 
NULL
;

1993 i‡(
¥iv
->
∑ª¡
)

1994 
	`dev_put
(
¥iv
->
∑ª¡
);

1995 
	}
}

1997 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1999 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2001  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2002 
	}
}

2004 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2005 
iÊa_vf_öfo
 *
ivf
)

2007 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2008 
îr
;

2010 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2011 i‡(
îr
)

2012  
îr
;

2014 
ivf
->
vf
 = vf;

2017 
	}
}

2019 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2021 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2023 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2024  -
EINVAL
;

2026  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2027 
	}
}

2029 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2030 
iÊa_vf_°©s
 *
vf_°©s
)

2032 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2034  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2035 
	}
}

2037 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2038 .
¸óã
 = 
ùoib_h¨d_hódî
,

2041 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2042 .
ndo_öô
 = 
ùoib_ndo_öô
,

2043 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2044 .
	gndo_›í
 = 
ùoib_›í
,

2045 .
	gndo_°›
 = 
ùoib_°›
,

2046 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2047 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2048 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2049 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2050 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2051 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2052 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2053 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2054 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2055 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2056 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2057 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2058 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2061 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2062 .
ndo_öô
 = 
ùoib_ndo_öô
,

2063 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2064 .
	gndo_›í
 = 
ùoib_›í
,

2065 .
	gndo_°›
 = 
ùoib_°›
,

2066 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2067 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2068 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2069 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2070 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2071 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2072 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2073 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2076 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2077 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2078 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2079 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2080 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2083 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2085 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2086 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2088 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2090 
dev
->
w©chdog_timeo
 = 
HZ
;

2092 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2094 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2095 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2096 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2097 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2098 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2099 
NETIF_F_HIGHDMA
);

2100 
	`√tif_kìp_d°
(
dev
);

2102 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2109 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2110 
	}
}

2112 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2114 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2116 
¥iv
->
dev
 = dev;

2117 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2118 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2119 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2121 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2122 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2123 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2124 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2126 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2127 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2128 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2129 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2130 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2131 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2132 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2133 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2134 
	}
}

2136 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2137 c⁄° *
«me
)

2139 
√t_devi˚
 *
dev
;

2141 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2142 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2143 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2144  
dev
;

2146 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2147 
ùoib_£tup_comm⁄
);

2148 i‡(!
dev
)

2149  
	`ERR_PTR
(-
ENOMEM
);

2150  
dev
;

2151 
	}
}

2153 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2154 
√t_devi˚
 *
dev
)

2156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2157 
ùoib_dev_¥iv
 *
¥iv
;

2158 
rc
;

2160 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2161 i‡(!
¥iv
)

2162  -
ENOMEM
;

2164 
¥iv
->
ˇ
 = 
hˇ
;

2165 
¥iv
->
p‹t
 =Öort;

2167 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2168 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2169 i‡(
rc
) {

2170 i‡(
rc
 !-
EOPNOTSUPP
)

2171 
out
;

2173 
∫
->
£nd
 = 
ùoib_£nd
;

2174 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2175 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2176 
∫
->
hˇ
 = hca;

2179 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2181 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2182 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2184 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2186 
∫
->
˛¡_¥iv
 = 
¥iv
;

2192 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2193 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2195 
	`ùoib_buûd_¥iv
(
dev
);

2199 
out
:

2200 
	`k‰ì
(
¥iv
);

2201  
rc
;

2202 
	}
}

2204 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2205 c⁄° *
«me
)

2207 
√t_devi˚
 *
dev
;

2208 
rc
;

2210 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2211 i‡(
	`IS_ERR
(
dev
))

2212  
dev
;

2214 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2215 i‡(
rc
) {

2216 
	`‰ì_√tdev
(
dev
);

2217  
	`ERR_PTR
(
rc
);

2225  
dev
;

2226 
	}
}

2228 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2231 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2233 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2234 i‡(
dev
->
¥iv_de°ru˘‹
)

2235 
dev
->
	`¥iv_de°ru˘‹
(dev);

2241 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2244 
∫
->
˛¡_¥iv
 = 
NULL
;

2246 
	`k‰ì
(
¥iv
);

2247 
	}
}

2249 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2250 
devi˚_©åibuã
 *
©å
, *
buf
)

2252 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2255  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2256 
	}
}

2257 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2259 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2260 
devi˚_©åibuã
 *
©å
, *
buf
)

2262 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2263 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2265  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2266 
	}
}

2268 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2270 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2272 i‡(
umˇ°_vÆ
 > 0) {

2273 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2274 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2277 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2278 
	}
}

2280 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2281 
devi˚_©åibuã
 *
©å
,

2282 c⁄° *
buf
, 
size_t
 
cou¡
)

2284 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2286 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2288  
cou¡
;

2289 
	}
}

2290 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2292 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2294  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2295 
	}
}

2297 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2299 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2300 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2302 
	`√tif_addr_lock_bh
(
√tdev
);

2304 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2305 &
gid
->
globÆ
.
öãrÁ˚_id
,

2306 (
gid
->
globÆ
.
öãrÁ˚_id
));

2307 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2308 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2310 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2312 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2313 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2314 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2315 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2316 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2318 
	}
}

2320 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2321 
sockaddr_°‹age
 *
ss
)

2323 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2324 
ªt
 = 0;

2326 
	`√tif_addr_lock_bh
(
dev
);

2331 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2332 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2333 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2334 
ªt
 = -
EINVAL
;

2336 
	`√tif_addr_u∆ock_bh
(
dev
);

2338  
ªt
;

2339 
	}
}

2341 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2343 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2344 
sockaddr_°‹age
 *
ss
 = 
addr
;

2345 
ªt
;

2347 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2348  -
EBUSY
;

2350 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2351 i‡(
ªt
)

2352  
ªt
;

2354 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2356 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2359 
	}
}

2361 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2362 
devi˚_©åibuã
 *
©å
,

2363 c⁄° *
buf
, 
size_t
 
cou¡
)

2365 
pkey
;

2366 
ªt
;

2368 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2369  -
EINVAL
;

2371 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2372  -
EINVAL
;

2374 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2376  
ªt
 ?Ñë : 
cou¡
;

2377 
	}
}

2378 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2380 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2381 
devi˚_©åibuã
 *
©å
,

2382 c⁄° *
buf
, 
size_t
 
cou¡
)

2384 
pkey
;

2385 
ªt
;

2387 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2388  -
EINVAL
;

2390 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2391  -
EINVAL
;

2393 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2395  
ªt
 ?Ñë : 
cou¡
;

2397 
	}
}

2398 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2400 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2402  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2403 
	}
}

2414 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2415 
devi˚_©åibuã
 *
©å
, *
buf
)

2417 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2430 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2431 
	`√tdev_öfo_⁄˚
(
ndev
,

2433 
cuºít
->
comm
);

2435  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2436 
	}
}

2437 
DEVICE_ATTR_RO
(
dev_id
);

2439 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2441 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2442  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2443 
	}
}

2445 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2446 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2448 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2449 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2450 
ùoib_dev_¥iv
 *
¥iv
;

2451 
√t_devi˚
 *
ndev
;

2452 
ªsu…
;

2454 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2455 i‡(
	`IS_ERR
(
ndev
)) {

2456 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2457 
	`PTR_ERR
(
ndev
));

2458  
ndev
;

2460 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2462 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2463 
¥iv
->
ˇ
, 
ùoib_evít
);

2464 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2467 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2469 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2470 i‡(
ªsu…
) {

2471 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2472 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2474 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2475 
	`ùoib_ötf_‰ì
(
ndev
);

2476 
	`‰ì_√tdev
(
ndev
);

2478  
	`ERR_PTR
(
ªsu…
);

2481 i‡(
hˇ
->
›s
.
rdma_√tdev_gë_∑øms
) {

2482 
rc
 = 
hˇ
->
›s
.
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2483 
RDMA_NETDEV_IPOIB
,

2484 &
∑øms
);

2486 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2487 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2495 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2497 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2498 
sysfs_Áûed
;

2499 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2500 
sysfs_Áûed
;

2501 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2502 
sysfs_Áûed
;

2503 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2504 
sysfs_Áûed
;

2505 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2506 
sysfs_Áûed
;

2507 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2508 
sysfs_Áûed
;

2510  
ndev
;

2512 
sysfs_Áûed
:

2513 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2514 
	`uƒegi°î_√tdev
(
ndev
);

2515  
	`ERR_PTR
(-
ENOMEM
);

2516 
	}
}

2518 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2520 
li°_hód
 *
dev_li°
;

2521 
√t_devi˚
 *
dev
;

2522 
ùoib_dev_¥iv
 *
¥iv
;

2523 
p
;

2524 
cou¡
 = 0;

2526 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2527 i‡(!
dev_li°
)

2530 
	`INIT_LIST_HEAD
(
dev_li°
);

2532 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2533 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2535 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2536 i‡(!
	`IS_ERR
(
dev
)) {

2537 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2538 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2539 
cou¡
++;

2543 i‡(!
cou¡
) {

2544 
	`k‰ì
(
dev_li°
);

2548 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2549 
	}
}

2551 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2553 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2554 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2556 i‡(!
dev_li°
)

2559 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2560 
	`LIST_HEAD
(
hód
);

2561 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2563 
	`π∆_lock
();

2565 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2566 
li°
)

2567 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2568 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2569 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2571 
	`π∆_u∆ock
();

2574 
	`k‰ì
(
dev_li°
);

2575 
	}
}

2577 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2578 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2579 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2583 
__öô
 
	$ùoib_öô_moduÀ
()

2585 
ªt
;

2587 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2588 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2589 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2591 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2592 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2593 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2594 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2595 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2596 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2603 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2605 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2607 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2608 i‡(
ªt
)

2609  
ªt
;

2621 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2622 i‡(!
ùoib_w‹kqueue
) {

2623 
ªt
 = -
ENOMEM
;

2624 
îr_fs
;

2627 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2629 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2630 i‡(
ªt
)

2631 
îr_ß
;

2633 
ªt
 = 
	`ùoib_√éök_öô
();

2634 i‡(
ªt
)

2635 
îr_˛õ¡
;

2637 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2638 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2642 
îr_˛õ¡
:

2643 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2645 
îr_ß
:

2646 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2647 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2649 
îr_fs
:

2650 
	`ùoib_uƒegi°î_debugfs
();

2652  
ªt
;

2653 
	}
}

2655 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2657 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2658 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2660 
	`ùoib_√éök_föi
();

2661 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2662 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2663 
	`ùoib_uƒegi°î_debugfs
();

2664 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2665 
	}
}

2667 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2668 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL81/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@RHEL81/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL81/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@RHEL81/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@RHEL82/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{ 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

845 
uöt
 
ùoib_ac˚l
;

	@RHEL82/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

359 (*
rx
->
rx_rög
)));

360 i‡(!
rx
->
rx_rög
)

361  -
ENOMEM
;

363 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

364 i‡(!
t
) {

365 
ªt
 = -
ENOMEM
;

366 
îr_‰ì_1
;

369 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

371 
	`•ö_lock_úq
(&
¥iv
->
lock
);

373 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

374 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

375 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

376 
ªt
 = -
EINVAL
;

377 
îr_‰ì
;

379 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

381 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

383 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

384 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

385 
rx
->
rx_rög
[
i
].
m≠pög
,

386 
GFP_KERNEL
)) {

387 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

388 
ªt
 = -
ENOMEM
;

389 
îr_cou¡
;

391 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

392 i‡(
ªt
) {

393 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

394 "Áûed f‹ bu‡%d\n", 
i
);

395 
ªt
 = -
EIO
;

396 
îr_cou¡
;

400 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

402 
	`k‰ì
(
t
);

406 
îr_cou¡
:

407 
	`•ö_lock_úq
(&
¥iv
->
lock
);

408 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

409 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

411 
îr_‰ì
:

412 
	`k‰ì
(
t
);

414 
îr_‰ì_1
:

415 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

417  
ªt
;

418 
	}
}

420 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

421 
ib_qp
 *
qp
,

422 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

443 c⁄° 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 c⁄° 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
,

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

644 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

645 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

984 c⁄° 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1073 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 c⁄° 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1440 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1441 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1443 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1444 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1445 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1446 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1449 
	`dev_k‰ì_skb_™y
(
skb
);

1451 
	`√tif_tx_lock_bh
(
dev
);

1452 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1455 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1456 
	`√tif_tx_u∆ock_bh
(
dev
);

1457 
	}
}

1459 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1460 
mtu
)

1462 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1463 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1465 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1574 (*
¥iv
->
cm
.
§q_rög
)));

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@RHEL82/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

144 
	}
}

145 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

146 
s£t
)

148 
s£t
) {

149 
ETH_SS_STATS
:

150  
IPOIB_GLOBAL_STATS_LEN
;

154  -
EOPNOTSUPP
;

155 
	}
}

158 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

160 
•ìd
) {

161 
IB_SPEED_SDR
:

162  
SPEED_2500
;

163 
IB_SPEED_DDR
:

164  
SPEED_5000
;

165 
IB_SPEED_QDR
:

166 
IB_SPEED_FDR10
:

167  
SPEED_10000
;

168 
IB_SPEED_FDR
:

169  
SPEED_14000
;

170 
IB_SPEED_EDR
:

171  
SPEED_25000
;

174  
SPEED_UNKNOWN
;

175 
	}
}

177 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

178 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

180 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

181 
ib_p‹t_©å
 
©å
;

182 
ªt
, 
•ìd
, 
width
;

184 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

185 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

186 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

190 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

191 i‡(
ªt
 < 0)

192  -
EINVAL
;

194 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

195 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

197 i‡(
•ìd
 < 0 || 
width
 < 0)

198  -
EINVAL
;

204 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

205 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

207 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

209 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

210 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

213 
	}
}

215 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

216 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

217 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

218 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

219 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

220 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

221 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

222 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

223 .
	ggë_lök
 = 
ëhtoﬁ_›_gë_lök
,

226 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

228 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

229 
	}
}

	@RHEL82/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

271 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

272 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

273 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

274 
	}
}

276 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

281 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

282 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

283 
	}
}

285 
	$ùoib_ªgi°î_debugfs
()

287 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

288 
	}
}

290 
	$ùoib_uƒegi°î_debugfs
()

292 
	`debugfs_ªmove
(
ùoib_roŸ
);

293 
	}
}

	@RHEL82/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
Êags
;

674 
	`√tif_tx_lock_bh
(
dev
);

675 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

677 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

678 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

679 
	`li°_dñ
(&
ah
->
li°
);

680 
	`rdma_de°roy_ah
(
ah
->ah, 0);

681 
	`k‰ì
(
ah
);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	`√tif_tx_u∆ock_bh
(
dev
);

686 
	}
}

688 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

690 
ùoib_dev_¥iv
 *
¥iv
 =

691 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

692 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

694 
	`__ùoib_ª≠_ah
(
dev
);

696 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

697 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

698 
	`round_jiffõs_ªœtive
(
HZ
));

699 
	}
}

701 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

705 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

706 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

707 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

708 
	}
}

710 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

712 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

714 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

715 
	`ùoib_Êush_ah
(
dev
);

716 
	}
}

718 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

720 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

721 
≥ndög
 = 0;

722 
i
;

724 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

725 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

726 ++
≥ndög
;

728  
≥ndög
;

729 
	}
}

731 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

732 
ib_qp
 *
qp
,

733 
ib_qp_°©e
 
√w_°©e
)

735 
ib_qp_©å
 
qp_©å
;

736 
ib_qp_öô_©å
 
quîy_öô_©å
;

737 
ªt
;

739 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

740 i‡(
ªt
) {

741 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

745 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

746 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

748 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

749 
√w_°©e
, 
qp_©å
.
qp_°©e
);

750 
	}
}

752 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

754 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

757 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

758 
	}
}

760 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

764 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

765 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

766 
	}
}

768 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
ib_qp_©å
 
qp_©å
;

772 
begö
;

773 
ùoib_tx_buf
 *
tx_ªq
;

774 
i
;

776 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

777 
	`ùoib_«pi_dißbÀ
(
dev
);

779 
	`ùoib_cm_dev_°›
(
dev
);

785 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

786 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

787 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

790 
begö
 = 
jiffõs
;

792 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

793 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

794 
	`ùoib_w¨n
(
¥iv
,

796 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

797 
	`ªcvs_≥ndög
(
dev
));

803 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

804 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

805 (
ùoib_£ndq_size
 - 1)];

806 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

807 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

808 ++
¥iv
->
tx_èû
;

811 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

812 
ùoib_rx_buf
 *
rx_ªq
;

814 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

815 i‡(!
rx_ªq
->
skb
)

817 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

818 
¥iv
->
rx_rög
[
i
].
m≠pög
);

819 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

820 
rx_ªq
->
skb
 = 
NULL
;

823 
timeout
;

826 
	`ùoib_døö_cq
(
dev
);

828 
	`u¶ìp_ønge
(1000, 2000);

831 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

833 
timeout
:

834 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

835 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

836 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

838 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

841 
	}
}

843 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

847 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

849 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

850 
	`ùoib_Êush_ah
(
dev
);

853 
	}
}

855 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

858 
ªt
;

860 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

861 i‡(
ªt
) {

862 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

866 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

867 i‡(
ªt
) {

868 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

869 
out
;

872 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

873 i‡(
ªt
) {

874 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

875 
out
;

878 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

879 
	`ùoib_«pi_íabÀ
(
dev
);

882 
out
:

884 
	}
}

886 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

888 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

890 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

892 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

893 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

894 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

898 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

899 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

900 
	`round_jiffõs_ªœtive
(
HZ
));

902 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

903 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

904 
dev_°›
;

907 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

911 
dev_°›
:

912 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

913 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

914 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

915 
	`ùoib_ib_dev_°›
(
dev
);

917 
	}
}

919 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

921 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

922 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

924 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

925 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

926 &
¥iv
->
pkey_ödex
)) {

927 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

929 i‡(
∫
->
£t_id
)

930 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

931 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

933 
	}
}

935 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

939 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

941 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

942 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

946 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

948 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

949 
	}
}

951 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

953 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

955 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

957 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

958 
	`√tif_ˇºõr_off
(
dev
);

960 
	`ùoib_mˇ°_°›_thªad
(
dev
);

961 
	`ùoib_mˇ°_dev_Êush
(
dev
);

963 
	`ùoib_Êush_∑ths
(
dev
);

964 
	}
}

966 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

968 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

969 
i
, 
n
;

976 
	`loˇl_bh_dißbÀ
();

979 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

980 
i
 = 0; i < 
n
; ++i) {

986 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

987 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

989 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

991 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

993 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

998 } 
n
 =
IPOIB_NUM_WC
);

1000 
	`pﬁl_tx
(
¥iv
))

1003 
	`loˇl_bh_íabÀ
();

1004 
	}
}

1010 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1012 
ªsu…
;

1013 
u16
 
¥ev_pkey
;

1015 
¥ev_pkey
 = 
¥iv
->
pkey
;

1016 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1017 i‡(
ªsu…
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1019 
¥iv
->
p‹t
, 
ªsu…
);

1020  
ªsu…
;

1023 
¥iv
->
pkey
 |= 0x8000;

1025 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1026 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1027 
¥ev_pkey
, 
¥iv
->
pkey
);

1032 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1033 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1038 
	}
}

1042 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1044 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1046 
¥iv
->
pkey_ödex
 = 0;

1047 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1049 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1050 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1053 
	}
}

1059 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1061 
ib_gid
 
£¨ch_gid
;

1062 
ib_gid
 
gid0
;

1063 
ib_gid
 *
√tdev_gid
;

1064 
îr
;

1065 
u16
 
ödex
;

1066 
u8
 
p‹t
;

1067 
boﬁ
 
ªt
 = 
Ál£
;

1069 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1070 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1071  
Ál£
;

1073 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1078 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1079 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1084 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1086 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1088 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1090 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1091 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1095 
out
;

1122 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1123 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1124 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1125 i‡(
ödex
 == 0)

1126 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1127 &
¥iv
->
Êags
);

1129 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1130 
ªt
 = 
åue
;

1132 
ªt
 = 
Ál£
;

1135 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1136 
ªt
 = 
åue
;

1138 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1139 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1140 (
¥iv
->
loˇl_gid
));

1141 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1142 (
¥iv
->
loˇl_gid
));

1143 
ªt
 = 
åue
;

1148 
out
:

1149 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1151  
ªt
;

1152 
	}
}

1154 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1155 
ùoib_Êush_Àvñ
 
Àvñ
,

1156 
√°ög
)

1158 
ùoib_dev_¥iv
 *
˝riv
;

1159 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1160 
ªsu…
;

1162 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1168 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1169 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1171 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1173 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1174 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1176 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1177 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1178 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1182 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1184 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1185 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1186 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1188 
	`upd©e_chûd_pkey
(
¥iv
);

1189 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1190 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1191 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1195 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1199 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1200 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1201 i‡(
ªsu…
) {

1203 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1208 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1210 i‡(
ªsu…
) {

1211 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1217 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1218 
›î_up
;

1219 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1225 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1226 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1227 i‡(
›î_up
)

1228 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1229 
	`ùoib_Êush_ah
(
dev
);

1232 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1233 
	`ùoib_ib_dev_down
(
dev
);

1235 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1236 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1237 
	`ùoib_ib_dev_°›
(
dev
);

1239 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1242 i‡(
	`√tif_queue_°›≥d
(
dev
))

1243 
	`√tif_°¨t_queue
(
dev
);

1250 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1251 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1252 
	`ùoib_ib_dev_up
(
dev
);

1253 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1254 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1256 
	}
}

1258 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1260 
ùoib_dev_¥iv
 *
¥iv
 =

1261 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1263 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1264 
	}
}

1266 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1268 
ùoib_dev_¥iv
 *
¥iv
 =

1269 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1271 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1272 
	}
}

1274 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1276 
ùoib_dev_¥iv
 *
¥iv
 =

1277 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1279 
	`π∆_lock
();

1280 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1281 
	`π∆_u∆ock
();

1282 
	}
}

1284 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1286 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1288 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1293 
	`ùoib_Êush_∑ths
(
dev
);

1295 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1296 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1304 
	`ùoib_°›_ah
(
dev
);

1306 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1308 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1310 i‡(
¥iv
->
pd
) {

1311 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1312 
¥iv
->
pd
 = 
NULL
;

1314 
	}
}

	@RHEL82/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
, 
NULL
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
, 
NULL
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

247 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

248  -
EINVAL
;

250 
¥iv
->
admö_mtu
 = 
√w_mtu
;

252 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

253 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

254 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

256 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

258 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

259 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

261 
	`√tif_ˇºõr_off
(
dev
);

264 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

266 i‡(
ˇºõr_°©us
)

267 
	`√tif_ˇºõr_⁄
(
dev
);

269 
dev
->
mtu
 = 
√w_mtu
;

272  
ªt
;

273 
	}
}

275 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

276 
π∆_lök_°©s64
 *
°©s
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

281 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

283 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

284 
	}
}

287 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

288 
√t_devi˚
 *
dev
)

290 
√t
 *√à
	`dev_√t
(
dev
);

291 
ö_devi˚
 *
ö_dev
;

292 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

293 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

294 
__be32
 
ªt_addr
;

296 
addr
->
ß_Ámûy
) {

297 
AF_INET
:

298 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

299 i‡(!
ö_dev
)

300  
Ál£
;

302 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

303 
addr_ö
->
sö_addr
.
s_addr
,

304 
RT_SCOPE_HOST
);

305 
	`ö_dev_put
(
ö_dev
);

306 i‡(
ªt_addr
)

307  
åue
;

310 
AF_INET6
:

311 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

312 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

313  
åue
;

317  
Ál£
;

318 
	}
}

327 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

329 
√t_devi˚
 *
ma°î
;

331 
	`rcu_ªad_lock
();

332 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

333 i‡(
ma°î
)

334 
	`dev_hﬁd
(
ma°î
);

335 
	`rcu_ªad_u∆ock
();

337 i‡(
ma°î
)

338  
ma°î
;

340 
	`dev_hﬁd
(
dev
);

341  
dev
;

342 
	}
}

344 
	sùoib_wÆk_d©a
 {

345 c⁄° 
sockaddr
 *
	maddr
;

346 
√t_devi˚
 *
	mªsu…
;

349 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

351 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

352 
ªt
 = 0;

354 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

355 
	`dev_hﬁd
(
uµî
);

356 
d©a
->
ªsu…
 = 
uµî
;

357 
ªt
 = 1;

360  
ªt
;

361 
	}
}

372 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

373 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

375 
ùoib_wÆk_d©a
 
d©a
 = {

376 .
addr
 =áddr,

379 
	`rcu_ªad_lock
();

380 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

381 
	`dev_hﬁd
(
dev
);

382 
d©a
.
ªsu…
 = 
dev
;

383 
out
;

386 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

387 
out
:

388 
	`rcu_ªad_u∆ock
();

389  
d©a
.
ªsu…
;

390 
	}
}

397 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

398 c⁄° 
ib_gid
 *
gid
,

399 
u16
 
pkey_ödex
,

400 c⁄° 
sockaddr
 *
addr
,

401 
√°ög
,

402 
√t_devi˚
 **
found_√t_dev
)

404 
ùoib_dev_¥iv
 *
chûd_¥iv
;

405 
√t_devi˚
 *
√t_dev
 = 
NULL
;

406 
m©ches
 = 0;

408 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

409 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

410 i‡(!
addr
) {

411 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

415 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

417 i‡(
√t_dev
) {

418 i‡(!*
found_√t_dev
)

419 *
found_√t_dev
 = 
√t_dev
;

421 
	`dev_put
(
√t_dev
);

422 ++
m©ches
;

427 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

428 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

429 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

430 
pkey_ödex
, 
addr
,

431 
√°ög
 + 1,

432 
found_√t_dev
);

433 i‡(
m©ches
 > 1)

436 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

438  
m©ches
;

439 
	}
}

444 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

445 
u16
 
pkey_ödex
,

446 c⁄° 
ib_gid
 *
gid
,

447 c⁄° 
sockaddr
 *
addr
,

448 
√t_devi˚
 **
√t_dev
)

450 
ùoib_dev_¥iv
 *
¥iv
;

451 
m©ches
 = 0;

453 *
√t_dev
 = 
NULL
;

455 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

456 i‡(
¥iv
->
p‹t
 !=Öort)

459 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

460 
addr
, 0, 
√t_dev
);

461 i‡(
m©ches
 > 1)

465  
m©ches
;

466 
	}
}

468 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

469 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

470 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

471 *
˛õ¡_d©a
)

473 
√t_devi˚
 *
√t_dev
;

474 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

475 
u16
 
pkey_ödex
;

476 
m©ches
;

477 
ªt
;

479 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

480  
NULL
;

482 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

483 i‡(
ªt
)

484  
NULL
;

486 i‡(!
dev_li°
)

487  
NULL
;

490 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

491 
gid
, 
NULL
, &
√t_dev
);

493 
m©ches
) {

495  
NULL
;

497  
√t_dev
;

500 
	`dev_put
(
√t_dev
);

504 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

505 
gid
, 
addr
, &
√t_dev
);

506 
m©ches
) {

508  
NULL
;

510 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

514  
√t_dev
;

516 
	}
}

518 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

522 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

523 !
	`°rcmp
(
buf
, "connected\n")) ||

524 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "datagram\n"))) {

530 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

531 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

532 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

534 
	`√tdev_upd©e_„©uªs
(
dev
);

535 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

536 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

537 
	`π∆_u∆ock
();

538 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

540 
	`ùoib_Êush_∑ths
(
dev
);

541  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

544 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

545 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

546 
	`√tdev_upd©e_„©uªs
(
dev
);

547 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

548 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

549 
	`π∆_u∆ock
();

550 
	`ùoib_Êush_∑ths
(
dev
);

551  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

554  -
EINVAL
;

555 
	}
}

557 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

560 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

561 
ùoib_∑th
 *
∑th
;

562 
ªt
;

564 
n
) {

565 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

567 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

568  (
ib_gid
));

570 i‡(
ªt
 < 0)

571 
n
 =Ç->
rb_À·
;

572 i‡(
ªt
 > 0)

573 
n
 =Ç->
rb_right
;

575  
∑th
;

578  
NULL
;

579 
	}
}

581 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

584 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

585 
rb_node
 *
≤
 = 
NULL
;

586 
ùoib_∑th
 *
ç©h
;

587 
ªt
;

589 *
n
) {

590 
≤
 = *
n
;

591 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

593 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

594  (
ib_gid
));

595 i‡(
ªt
 < 0)

596 
n
 = &
≤
->
rb_À·
;

597 i‡(
ªt
 > 0)

598 
n
 = &
≤
->
rb_right
;

600  -
EEXIST
;

603 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

604 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

606 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

609 
	}
}

611 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

613 
sk_buff
 *
skb
;

615 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

616 
	`dev_k‰ì_skb_úq
(
skb
);

618 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "%s\n", 
__func__
);

621 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

623 i‡(
∑th
->
ah
)

624 
	`ùoib_put_ah
(
∑th
->
ah
);

626 
	`k‰ì
(
∑th
);

627 
	}
}

629 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


631 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

633 
ùoib_∑th_ôî
 *
ôî
;

635 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

636 i‡(!
ôî
)

637  
NULL
;

639 
ôî
->
dev
 = dev;

640 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

642 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

643 
	`k‰ì
(
ôî
);

644  
NULL
;

647  
ôî
;

648 
	}
}

650 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

653 
rb_node
 *
n
;

654 
ùoib_∑th
 *
∑th
;

655 
ªt
 = 1;

657 
	`•ö_lock_úq
(&
¥iv
->
lock
);

659 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

661 
n
) {

662 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

664 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

665  (
ib_gid
)) < 0) {

666 
ôî
->
∑th
 = *path;

667 
ªt
 = 0;

671 
n
 = 
	`rb_√xt
(n);

674 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676  
ªt
;

677 
	}
}

679 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

680 
ùoib_∑th
 *
∑th
)

682 *
∑th
 = 
ôî
->path;

683 
	}
}

687 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

690 
ùoib_∑th
 *
∑th
, *
ç
;

692 
	`•ö_lock_úq
(&
¥iv
->
lock
);

694 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

695 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

696 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

697 
∑th
->
∑thªc
.
dgid
.
øw
);

698 i‡(
∑th
->
ah
)

699 
∑th
->
ah
->
vÆid
 = 0;

702 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

703 
	}
}

705 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

707 
ùoib_p£udo_hódî
 *
phdr
;

709 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

710 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

711 
	}
}

713 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

715 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
ùoib_∑th
 *
∑th
, *
ç
;

717 
	`LIST_HEAD
(
ªmove_li°
);

718 
Êags
;

720 
	`√tif_tx_lock_bh
(
dev
);

721 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

723 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

725 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

726 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

728 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

729 i‡(
∑th
->
quîy
)

730 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

731 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

732 
	`√tif_tx_u∆ock_bh
(
dev
);

733 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

734 
	`∑th_‰ì
(
dev
, 
∑th
);

735 
	`√tif_tx_lock_bh
(
dev
);

736 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	}
}

743 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

744 
ß_∑th_ªc
 *
∑thªc
,

745 *
∑th_±r
)

747 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

748 
√t_devi˚
 *
dev
 = 
∑th
->dev;

749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

750 
ùoib_ah
 *
ah
 = 
NULL
;

751 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

752 
ùoib_√igh
 *
√igh
, *
ä
;

753 
sk_buff_hód
 
skqueue
;

754 
sk_buff
 *
skb
;

755 
Êags
;

757 i‡(!
°©us
)

758 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

759 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

760 
∑thªc
->
dgid
.
øw
);

762 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

763 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

765 
	`skb_queue_hód_öô
(&
skqueue
);

767 i‡(!
°©us
) {

768 
rdma_ah_©å
 
av
;

770 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

771 
∑thªc
, &
av
, 
NULL
)) {

772 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

773 
	`rdma_de°roy_ah_©å
(&
av
);

777 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

779 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

785 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

786 (
ib_gid
))) {

787 
	`ùoib_dbg
(

788 
¥iv
,

790 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

791 
∑th
->
∑thªc
.
dgid
.
øw
);

792 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

793 (
ib_gid
));

796 
∑th
->
∑thªc
 = *pathrec;

798 
ﬁd_ah
 = 
∑th
->
ah
;

799 
∑th
->
ah
 =áh;

801 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

802 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

803 
∑thªc
->
¶
);

805 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

806 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

808 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

809 i‡(
√igh
->
ah
) {

810 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

818 
	`ùoib_put_ah
(
√igh
->
ah
);

820 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

821 
√igh
->
ah
 = 
∑th
->ah;

823 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

824 i‡(!
	`ùoib_cm_gë
(
√igh
))

825 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

826 
∑th
,

827 
√igh
));

828 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

829 
	`ùoib_√igh_‰ì
(
√igh
);

834 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

835 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

837 
∑th
->
ah
->
vÆid
 = 1;

840 
∑th
->
quîy
 = 
NULL
;

841 
	`com∂ëe
(&
∑th
->
d⁄e
);

843 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 i‡(
	`IS_ERR_OR_NULL
(
ah
))

846 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

848 i‡(
ﬁd_ah
)

849 
	`ùoib_put_ah
(
ﬁd_ah
);

851 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

852 
ªt
;

853 
skb
->
dev
 = dev;

854 
ªt
 = 
	`dev_queue_xmô
(
skb
);

855 i‡(
ªt
)

856 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

857 
__func__
, 
ªt
);

859 
	}
}

861 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

862 *
gid
)

864 
∑th
->
dev
 = 
¥iv
->dev;

866 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

867 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

871 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

872 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

873 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

874 
∑th
->
∑thªc
.
numb_∑th
 = 1;

875 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

876 
	}
}

878 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

880 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

881 
ùoib_∑th
 *
∑th
;

883 i‡(!
¥iv
->
brﬂdˇ°
)

884  
NULL
;

886 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

887 i‡(!
∑th
)

888  
NULL
;

890 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

892 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

894 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

896  
∑th
;

897 
	}
}

899 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

900 
ùoib_∑th
 *
∑th
)

902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

905 
∑th
->
∑thªc
.
dgid
.
øw
);

907 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

909 
∑th
->
quîy_id
 =

910 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

911 &
∑th
->
∑thªc
,

912 
IB_SA_PATH_REC_DGID
 |

913 
IB_SA_PATH_REC_SGID
 |

914 
IB_SA_PATH_REC_NUMB_PATH
 |

915 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

916 
IB_SA_PATH_REC_PKEY
,

917 1000, 
GFP_ATOMIC
,

918 
∑th_ªc_com∂ëi⁄
,

919 
∑th
, &∑th->
quîy
);

920 i‡(
∑th
->
quîy_id
 < 0) {

921 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

922 
∑th
->
quîy
 = 
NULL
;

923 
	`com∂ëe
(&
∑th
->
d⁄e
);

924  
∑th
->
quîy_id
;

928 
	}
}

930 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

931 
√t_devi˚
 *
dev
)

933 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

934 
ùoib_∑th
 *
∑th
;

935 
Êags
;

937 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

939 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

940 i‡(!
∑th
)

941 
out
;

942 i‡(!
∑th
->
quîy
)

943 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

944 
out
:

945 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

946 
	}
}

948 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

949 
√t_devi˚
 *
dev
)

951 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

952 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

953 
ùoib_∑th
 *
∑th
;

954 
ùoib_√igh
 *
√igh
;

955 
Êags
;

957 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

958 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

959 i‡(!
√igh
) {

960 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

961 ++
dev
->
°©s
.
tx_dr›≥d
;

962 
	`dev_k‰ì_skb_™y
(
skb
);

963  
NULL
;

969 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

970 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

971  
√igh
;

974 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

975 i‡(!
∑th
) {

976 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
)

978 
îr_∑th
;

980 
	`__∑th_add
(
dev
, 
∑th
);

983 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

985 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

986 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

987 
√igh
->
ah
 = 
∑th
->ah;

989 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

990 i‡(!
	`ùoib_cm_gë
(
√igh
))

991 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

992 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

993 
	`ùoib_√igh_‰ì
(
√igh
);

994 
îr_dr›
;

996 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

997 
IPOIB_MAX_PATH_REC_QUEUE
) {

998 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

999 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1001 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1002 
	`skb_queue_Àn
(&
√igh
->
queue
));

1003 
îr_dr›
;

1006 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1007 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1008 
	`IPOIB_QPN
(
daddr
));

1009 
	`ùoib_√igh_put
(
√igh
);

1010  
NULL
;

1013 
√igh
->
ah
 = 
NULL
;

1015 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1016 
îr_∑th
;

1017 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1018 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1019 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1021 
îr_dr›
;

1025 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1026 
	`ùoib_√igh_put
(
√igh
);

1027  
NULL
;

1029 
îr_∑th
:

1030 
	`ùoib_√igh_‰ì
(
√igh
);

1031 
îr_dr›
:

1032 ++
dev
->
°©s
.
tx_dr›≥d
;

1033 
	`dev_k‰ì_skb_™y
(
skb
);

1035 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1036 
	`ùoib_√igh_put
(
√igh
);

1038  
NULL
;

1039 
	}
}

1041 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1042 
ùoib_p£udo_hódî
 *
phdr
)

1044 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1045 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1046 
ùoib_∑th
 *
∑th
;

1047 
Êags
;

1049 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1052 i‡(!
¥iv
->
brﬂdˇ°
)

1053 
dr›_™d_u∆ock
;

1055 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1056 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1057 i‡(!
∑th
) {

1058 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1059 i‡(!
∑th
)

1060 
dr›_™d_u∆ock
;

1061 
	`__∑th_add
(
dev
, 
∑th
);

1067 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
dr›_™d_u∆ock
;

1073 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1074 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1075 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1076 
u∆ock
;

1078 
dr›_™d_u∆ock
;

1082 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1083 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1084 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1089 
dr›_™d_u∆ock
:

1090 ++
dev
->
°©s
.
tx_dr›≥d
;

1091 
	`dev_k‰ì_skb_™y
(
skb
);

1092 
u∆ock
:

1093 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1094 
	}
}

1096 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1098 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1099 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1100 
ùoib_√igh
 *
√igh
;

1101 
ùoib_p£udo_hódî
 *
phdr
;

1102 
ùoib_hódî
 *
hódî
;

1103 
Êags
;

1105 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1106 
	`skb_puŒ
(
skb
, (*
phdr
));

1107 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1109 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1111 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1117 ++
dev
->
°©s
.
tx_dr›≥d
;

1118 
	`dev_k‰ì_skb_™y
(
skb
);

1119  
NETDEV_TX_OK
;

1122 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1123 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1125 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1126 i‡(
	`likñy
(
√igh
))

1127 
£nd_usög_√igh
;

1128 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1129  
NETDEV_TX_OK
;

1133 
hódî
->
¥Ÿo
) {

1134 
	`ht⁄s
(
ETH_P_IP
):

1135 
	`ht⁄s
(
ETH_P_IPV6
):

1136 
	`ht⁄s
(
ETH_P_TIPC
):

1137 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1138 i‡(
	`u∆ikñy
(!
√igh
)) {

1139 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1140 i‡(
	`likñy
(!
√igh
))

1141  
NETDEV_TX_OK
;

1144 
	`ht⁄s
(
ETH_P_ARP
):

1145 
	`ht⁄s
(
ETH_P_RARP
):

1147 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1148  
NETDEV_TX_OK
;

1151 ++
dev
->
°©s
.
tx_dr›≥d
;

1152 
	`dev_k‰ì_skb_™y
(
skb
);

1153  
NETDEV_TX_OK
;

1156 
£nd_usög_√igh
:

1158 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1159 i‡(
	`ùoib_cm_up
(
√igh
)) {

1160 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1161 
uƒef
;

1163 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1164 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1165 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1166 
uƒef
;

1167 } i‡(
√igh
->
ah
) {

1168 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1171 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1172 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1173 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1174 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1175 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1177 ++
dev
->
°©s
.
tx_dr›≥d
;

1178 
	`dev_k‰ì_skb_™y
(
skb
);

1181 
uƒef
:

1182 
	`ùoib_√igh_put
(
√igh
);

1184  
NETDEV_TX_OK
;

1185 
	}
}

1187 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1191 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1192 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1193 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1194 
	`√tif_queue_°›≥d
(
dev
),

1195 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1197 
	}
}

1199 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1200 
√t_devi˚
 *
dev
,

1201 
ty≥
,

1202 c⁄° *
daddr
,

1203 c⁄° *
ßddr
,

1204 
Àn
)

1206 
ùoib_hódî
 *
hódî
;

1208 
hódî
 = 
	`skb_push
(
skb
, (*header));

1210 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1211 
hódî
->
ª£rved
 = 0;

1218 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1220  
IPOIB_HARD_LEN
;

1221 
	}
}

1223 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1225 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1227 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1228 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1232 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1233 
	}
}

1235 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1240 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1241  
dev
->
ifödex
;

1244  
¥iv
->
∑ª¡
->
ifödex
;

1245 
	}
}

1247 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1256 
u32
 *
d32
 = (u32 *Ë
daddr
;

1257 
u32
 
hv
;

1259 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1260  
hv
 & 
htbl
->
mask
;

1261 
	}
}

1263 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1265 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1266 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1267 
ùoib_√igh_hash
 *
htbl
;

1268 
ùoib_√igh
 *
√igh
 = 
NULL
;

1269 
u32
 
hash_vÆ
;

1271 
	`rcu_ªad_lock_bh
();

1273 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1275 i‡(!
htbl
)

1276 
out_u∆ock
;

1278 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1279 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1280 
√igh
 !
NULL
;

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1282 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1284 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1286 
√igh
 = 
NULL
;

1287 
out_u∆ock
;

1290 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1291 
√igh
->
Æive
 = 
jiffõs
;

1292 
out_u∆ock
;

1296 
out_u∆ock
:

1297 
	`rcu_ªad_u∆ock_bh
();

1298  
√igh
;

1299 
	}
}

1301 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1303 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1304 
ùoib_√igh_hash
 *
htbl
;

1305 
√igh_obsﬁëe
;

1306 
dt
;

1307 
Êags
;

1308 
i
;

1309 
	`LIST_HEAD
(
ªmove_li°
);

1311 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1313 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1314 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1316 i‡(!
htbl
)

1317 
out_u∆ock
;

1320 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1321 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1323 
i
 = 0; i < 
htbl
->
size
; i++) {

1324 
ùoib_√igh
 *
√igh
;

1325 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1327 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1328 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1330 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1332 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1334 
	`rcu_assign_poöãr
(*
≈
,

1335 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1338 
	`li°_dñ_öô
(&
√igh
->
li°
);

1339 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1341 
≈
 = &
√igh
->
h√xt
;

1347 
out_u∆ock
:

1348 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1349 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1350 
	}
}

1352 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1354 
ùoib_dev_¥iv
 *
¥iv
 =

1355 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1357 
	`__ùoib_ª≠_√igh
(
¥iv
);

1359 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1360 
¨p_tbl
.
gc_öãrvÆ
);

1361 
	}
}

1364 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1365 
√t_devi˚
 *
dev
)

1367 
ùoib_√igh
 *
√igh
;

1369 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1370 i‡(!
√igh
)

1371  
NULL
;

1373 
√igh
->
dev
 = dev;

1374 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1375 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1376 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1377 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1379 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1381  
√igh
;

1382 
	}
}

1384 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1385 
√t_devi˚
 *
dev
)

1387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1388 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1389 
ùoib_√igh_hash
 *
htbl
;

1390 
ùoib_√igh
 *
√igh
;

1391 
u32
 
hash_vÆ
;

1393 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1394 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1395 i‡(!
htbl
) {

1396 
√igh
 = 
NULL
;

1397 
out_u∆ock
;

1403 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1406 
√igh
 !
NULL
;

1407 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1408 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1409 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1411 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1413 
√igh
 = 
NULL
;

1416 
√igh
->
Æive
 = 
jiffõs
;

1417 
out_u∆ock
;

1421 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1422 i‡(!
√igh
)

1423 
out_u∆ock
;

1426 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1427 
√igh
->
Æive
 = 
jiffõs
;

1429 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1430 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1431 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1432 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1433 
	`©omic_öc
(&
¡bl
->
íåõs
);

1435 
out_u∆ock
:

1437  
√igh
;

1438 
	}
}

1440 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1443 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1444 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1445 
sk_buff
 *
skb
;

1446 i‡(
√igh
->
ah
)

1447 
	`ùoib_put_ah
(
√igh
->
ah
);

1448 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1449 ++
dev
->
°©s
.
tx_dr›≥d
;

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 i‡(
	`ùoib_cm_gë
(
√igh
))

1453 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1454 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1456 
	`IPOIB_QPN
(
√igh
->
daddr
),

1457 
√igh
->
daddr
 + 4);

1458 
	`k‰ì
(
√igh
);

1459 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1460 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1461 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1463 
	}
}

1465 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1468 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1470 
	`ùoib_√igh_put
(
√igh
);

1471 
	}
}

1473 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1475 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1477 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1478 
ùoib_√igh_hash
 *
htbl
;

1479 
ùoib_√igh
 
__rcu
 **
≈
;

1480 
ùoib_√igh
 *
n
;

1481 
u32
 
hash_vÆ
;

1483 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1484 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1485 i‡(!
htbl
)

1488 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1489 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1492 
n
 !
NULL
;

1493 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1494 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1495 i‡(
n
 =
√igh
) {

1497 
	`rcu_assign_poöãr
(*
≈
,

1498 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1499 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1501 
	`li°_dñ_öô
(&
√igh
->
li°
);

1502 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1505 
≈
 = &
n
->
h√xt
;

1508 
	}
}

1510 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1512 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1513 
ùoib_√igh_hash
 *
htbl
;

1514 
ùoib_√igh
 
__rcu
 **
buckës
;

1515 
u32
 
size
;

1517 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1518 
¡bl
->
htbl
 = 
NULL
;

1519 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1520 i‡(!
htbl
)

1521  -
ENOMEM
;

1522 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1523 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1524 i‡(!
buckës
) {

1525 
	`k‰ì
(
htbl
);

1526  -
ENOMEM
;

1528 
htbl
->
size
 = size;

1529 
htbl
->
mask
 = (
size
 - 1);

1530 
htbl
->
buckës
 = buckets;

1531 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1532 
htbl
->
¡bl
 =Çtbl;

1533 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1536 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1537 
¨p_tbl
.
gc_öãrvÆ
);

1540 
	}
}

1542 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1544 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1545 
ùoib_√igh_hash
,

1546 
rcu
);

1547 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1548 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1550 
	`kv‰ì
(
buckës
);

1551 
	`k‰ì
(
htbl
);

1552 
	`com∂ëe
(&
¡bl
->
dñëed
);

1553 
	}
}

1555 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1557 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1558 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1559 
ùoib_√igh_hash
 *
htbl
;

1560 
Êags
;

1561 
i
;

1564 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1566 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1567 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1569 i‡(!
htbl
)

1570 
out_u∆ock
;

1572 
i
 = 0; i < 
htbl
->
size
; i++) {

1573 
ùoib_√igh
 *
√igh
;

1574 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1576 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1577 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1579 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1580 
	`rcu_assign_poöãr
(*
≈
,

1581 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1582 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1584 
	`li°_dñ_öô
(&
√igh
->
li°
);

1585 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1587 
≈
 = &
√igh
->
h√xt
;

1592 
out_u∆ock
:

1593 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1594 
	}
}

1596 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1598 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1599 
ùoib_√igh_hash
 *
htbl
;

1600 
Êags
;

1601 
i
, 
waô_Êushed
 = 0;

1603 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1604 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1608 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1609 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1610 i‡(!
htbl
)

1611 
out_u∆ock
;

1613 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1614 i‡(!
waô_Êushed
)

1615 
‰ì_htbl
;

1617 
i
 = 0; i < 
htbl
->
size
; i++) {

1618 
ùoib_√igh
 *
√igh
;

1619 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1621 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1623 
	`rcu_assign_poöãr
(*
≈
,

1624 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1625 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1627 
	`li°_dñ_öô
(&
√igh
->
li°
);

1628 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1632 
‰ì_htbl
:

1633 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1634 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1636 
out_u∆ock
:

1637 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1638 i‡(
waô_Êushed
)

1639 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1640 
	}
}

1642 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
	`ùoib_dbg
(
¥iv
, "%s\n", 
__func__
);

1647 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1649 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1651 
	`ùoib_Êush_√ighs
(
¥iv
);

1653 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1654 
	}
}

1656 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1660 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1661 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1662 
	}
}

1664 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1666 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1668 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1669 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1670 
	}
}

1672 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1674 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1676 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1678 
	`ùoib_«pi_dñ
(
dev
);

1680 
	`ùoib_cm_dev_˛ónup
(
dev
);

1682 
	`k‰ì
(
¥iv
->
rx_rög
);

1683 
	`v‰ì
(
¥iv
->
tx_rög
);

1685 
¥iv
->
rx_rög
 = 
NULL
;

1686 
¥iv
->
tx_rög
 = 
NULL
;

1687 
	}
}

1689 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1693 
	`ùoib_«pi_add
(
dev
);

1696 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1697 (*
¥iv
->
rx_rög
),

1698 
GFP_KERNEL
);

1699 i‡(!
¥iv
->
rx_rög
)

1700 
out
;

1702 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1703 (*
¥iv
->
tx_rög
)));

1704 i‡(!
¥iv
->
tx_rög
) {

1705 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1706 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1707 
out_rx_rög_˛ónup
;

1712 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1713 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1714 
¥iv
->
ˇ
->
«me
);

1715 
out_tx_rög_˛ónup
;

1719 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1720 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1721 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1725 
out_tx_rög_˛ónup
:

1726 
	`v‰ì
(
¥iv
->
tx_rög
);

1728 
out_rx_rög_˛ónup
:

1729 
	`k‰ì
(
¥iv
->
rx_rög
);

1731 
out
:

1732 
	`ùoib_«pi_dñ
(
dev
);

1733  -
ENOMEM
;

1734 
	}
}

1736 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1737 
cmd
)

1739 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1741 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1742  -
EOPNOTSUPP
;

1744  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1745 
	}
}

1747 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1750 
ªt
 = -
ENOMEM
;

1752 
¥iv
->
qp
 = 
NULL
;

1758 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1759 i‡(!
¥iv
->
wq
) {

1760 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1761 
out
;

1765 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1766 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1767 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1768 
˛ón_wq
;

1771 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1772 i‡(
ªt
) {

1773 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1774 
out_‰ì_pd
;

1777 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1778 i‡(
ªt
) {

1779 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1780 
out_dev_unöô
;

1783 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1784 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1785 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1786 
ªt
 = -
ENODEV
;

1787 
out_hash_unöô
;

1793 
out_hash_unöô
:

1794 
	`ùoib_√igh_hash_unöô
(
dev
);

1796 
out_dev_unöô
:

1797 
	`ùoib_ib_dev_˛ónup
(
dev
);

1799 
out_‰ì_pd
:

1800 i‡(
¥iv
->
pd
) {

1801 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1802 
¥iv
->
pd
 = 
NULL
;

1805 
˛ón_wq
:

1806 i‡(
¥iv
->
wq
) {

1807 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1808 
¥iv
->
wq
 = 
NULL
;

1811 
out
:

1812  
ªt
;

1813 
	}
}

1819 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1821 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1827 
	`π∆_lock
();

1828 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
, 
NULL
);

1829 
	`π∆_u∆ock
();

1832 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1838 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1839 
	}
}

1841 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1843 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1845 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1846 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1848 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1849 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1851 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1853 
	}
}

1855 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1858 
ib_p‹t_©å
 
©å
;

1859 
ªsu…
;

1861 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1862 i‡(
ªsu…
) {

1863 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1864 
¥iv
->
p‹t
);

1865  
ªsu…
;

1867 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1868 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1870 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1872 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1873 i‡(
ªsu…
) {

1874 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1875 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1876  
ªsu…
;

1879 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1880 i‡(
ªsu…
) {

1881 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1882 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1883  
ªsu…
;

1885 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1886 (
ib_gid
));

1888 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1889 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1891 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1894 
	}
}

1896 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1898 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1899 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1901 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1902 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1903 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1904 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1905 
	}
}

1907 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1909 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1910 
rdma_√tdev
 *
∫
;

1911 
rc
;

1913 i‡(
¥iv
->
∑ª¡
) {

1914 
	`ùoib_chûd_öô
(
ndev
);

1916 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1917 i‡(
rc
)

1918  
rc
;

1922 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1923 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1924 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1925 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1926 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1928 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1934 
¥iv
->
pkey
 |= 0x8000;

1936 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1937 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1938 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1940 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1942 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1943 i‡(
rc
) {

1944 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1945 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1946  
rc
;

1949 i‡(
¥iv
->
∑ª¡
) {

1950 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1952 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1954 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1955 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1956 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1960 
	}
}

1962 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1964 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1966 
	`ASSERT_RTNL
();

1972 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1974 i‡(
¥iv
->
∑ª¡
) {

1975 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1977 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1978 
	`li°_dñ
(&
¥iv
->
li°
);

1979 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`ùoib_√igh_hash_unöô
(
dev
);

1984 
	`ùoib_ib_dev_˛ónup
(
dev
);

1987 i‡(
¥iv
->
wq
) {

1988 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1989 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1990 
¥iv
->
wq
 = 
NULL
;

1993 i‡(
¥iv
->
∑ª¡
)

1994 
	`dev_put
(
¥iv
->
∑ª¡
);

1995 
	}
}

1997 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1999 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2001  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2002 
	}
}

2004 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2005 
iÊa_vf_öfo
 *
ivf
)

2007 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2008 
îr
;

2010 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2011 i‡(
îr
)

2012  
îr
;

2014 
ivf
->
vf
 = vf;

2015 
	`mem˝y
(
ivf
->
mac
, 
dev
->
dev_addr
, dev->
addr_Àn
);

2018 
	}
}

2020 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2022 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2024 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2025  -
EINVAL
;

2027  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2028 
	}
}

2030 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2031 
iÊa_vf_°©s
 *
vf_°©s
)

2033 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2035  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2036 
	}
}

2038 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2039 .
¸óã
 = 
ùoib_h¨d_hódî
,

2042 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2043 .
ndo_öô
 = 
ùoib_ndo_öô
,

2044 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2045 .
	gndo_›í
 = 
ùoib_›í
,

2046 .
	gndo_°›
 = 
ùoib_°›
,

2047 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2048 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2049 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2050 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2051 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2052 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2053 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2054 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2055 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2056 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2057 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2058 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2059 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2062 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2063 .
ndo_öô
 = 
ùoib_ndo_öô
,

2064 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2065 .
	gndo_›í
 = 
ùoib_›í
,

2066 .
	gndo_°›
 = 
ùoib_°›
,

2067 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2068 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2069 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2070 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2071 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2072 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2073 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2074 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2077 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2078 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2079 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2080 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2081 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2084 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2086 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2087 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2089 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2091 
dev
->
w©chdog_timeo
 = 
HZ
;

2093 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2095 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2096 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2097 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2098 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2099 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2100 
NETIF_F_HIGHDMA
);

2101 
	`√tif_kìp_d°
(
dev
);

2103 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2110 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2111 
	}
}

2113 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2115 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2117 
¥iv
->
dev
 = dev;

2118 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2119 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2120 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2122 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2123 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2124 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2125 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2127 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2128 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2129 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2130 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2131 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2132 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2133 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2134 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2135 
	}
}

2137 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2138 c⁄° *
«me
)

2140 
√t_devi˚
 *
dev
;

2142 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2143 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2144 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2145  
dev
;

2147 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2148 
ùoib_£tup_comm⁄
);

2149 i‡(!
dev
)

2150  
	`ERR_PTR
(-
ENOMEM
);

2151  
dev
;

2152 
	}
}

2154 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2155 
√t_devi˚
 *
dev
)

2157 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2158 
ùoib_dev_¥iv
 *
¥iv
;

2159 
rc
;

2161 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2162 i‡(!
¥iv
)

2163  -
ENOMEM
;

2165 
¥iv
->
ˇ
 = 
hˇ
;

2166 
¥iv
->
p‹t
 =Öort;

2168 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2169 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2170 i‡(
rc
) {

2171 i‡(
rc
 !-
EOPNOTSUPP
)

2172 
out
;

2174 
∫
->
£nd
 = 
ùoib_£nd
;

2175 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2176 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2177 
∫
->
hˇ
 = hca;

2180 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2182 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2183 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2185 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2187 
∫
->
˛¡_¥iv
 = 
¥iv
;

2193 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2194 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2196 
	`ùoib_buûd_¥iv
(
dev
);

2200 
out
:

2201 
	`k‰ì
(
¥iv
);

2202  
rc
;

2203 
	}
}

2205 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2206 c⁄° *
«me
)

2208 
√t_devi˚
 *
dev
;

2209 
rc
;

2211 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2212 i‡(
	`IS_ERR
(
dev
))

2213  
dev
;

2215 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2216 i‡(
rc
) {

2217 
	`‰ì_√tdev
(
dev
);

2218  
	`ERR_PTR
(
rc
);

2226  
dev
;

2227 
	}
}

2229 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2232 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2234 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2235 i‡(
dev
->
¥iv_de°ru˘‹
)

2236 
dev
->
	`¥iv_de°ru˘‹
(dev);

2242 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2245 
∫
->
˛¡_¥iv
 = 
NULL
;

2247 
	`k‰ì
(
¥iv
);

2248 
	}
}

2250 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2251 
devi˚_©åibuã
 *
©å
, *
buf
)

2253 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2256  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2257 
	}
}

2258 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2260 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2261 
devi˚_©åibuã
 *
©å
, *
buf
)

2263 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2266  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2267 
	}
}

2269 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2271 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2273 i‡(
umˇ°_vÆ
 > 0) {

2274 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2275 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2278 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2279 
	}
}

2281 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2282 
devi˚_©åibuã
 *
©å
,

2283 c⁄° *
buf
, 
size_t
 
cou¡
)

2285 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2287 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2289  
cou¡
;

2290 
	}
}

2291 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2293 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2295  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2296 
	}
}

2298 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2300 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2301 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2303 
	`√tif_addr_lock_bh
(
√tdev
);

2305 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2306 &
gid
->
globÆ
.
öãrÁ˚_id
,

2307 (
gid
->
globÆ
.
öãrÁ˚_id
));

2308 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2309 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2311 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2313 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2314 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2315 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2316 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2317 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2319 
	}
}

2321 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2322 
sockaddr_°‹age
 *
ss
)

2324 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2325 
ªt
 = 0;

2327 
	`√tif_addr_lock_bh
(
dev
);

2332 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2333 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2334 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2335 
ªt
 = -
EINVAL
;

2337 
	`√tif_addr_u∆ock_bh
(
dev
);

2339  
ªt
;

2340 
	}
}

2342 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2344 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2345 
sockaddr_°‹age
 *
ss
 = 
addr
;

2346 
ªt
;

2348 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2349  -
EBUSY
;

2351 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2352 i‡(
ªt
)

2353  
ªt
;

2355 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2357 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2360 
	}
}

2362 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2363 
devi˚_©åibuã
 *
©å
,

2364 c⁄° *
buf
, 
size_t
 
cou¡
)

2366 
pkey
;

2367 
ªt
;

2369 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2370  -
EINVAL
;

2372 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2373  -
EINVAL
;

2375 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2377  
ªt
 ?Ñë : 
cou¡
;

2378 
	}
}

2379 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2381 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2382 
devi˚_©åibuã
 *
©å
,

2383 c⁄° *
buf
, 
size_t
 
cou¡
)

2385 
pkey
;

2386 
ªt
;

2388 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2389  -
EINVAL
;

2391 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2392  -
EINVAL
;

2394 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2396  
ªt
 ?Ñë : 
cou¡
;

2398 
	}
}

2399 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2401 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2403  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2404 
	}
}

2415 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2416 
devi˚_©åibuã
 *
©å
, *
buf
)

2418 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2431 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2432 
	`√tdev_öfo_⁄˚
(
ndev
,

2434 
cuºít
->
comm
);

2436  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2437 
	}
}

2438 
DEVICE_ATTR_RO
(
dev_id
);

2440 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2442 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2443  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2444 
	}
}

2446 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2447 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2449 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2450 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2451 
ùoib_dev_¥iv
 *
¥iv
;

2452 
√t_devi˚
 *
ndev
;

2453 
ªsu…
;

2455 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2456 i‡(
	`IS_ERR
(
ndev
)) {

2457 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2458 
	`PTR_ERR
(
ndev
));

2459  
ndev
;

2461 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2463 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2464 
¥iv
->
ˇ
, 
ùoib_evít
);

2465 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2468 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2470 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2471 i‡(
ªsu…
) {

2472 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2473 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2475 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2476 
	`ùoib_ötf_‰ì
(
ndev
);

2477 
	`‰ì_√tdev
(
ndev
);

2479  
	`ERR_PTR
(
ªsu…
);

2482 i‡(
hˇ
->
›s
.
rdma_√tdev_gë_∑øms
) {

2483 
rc
 = 
hˇ
->
›s
.
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2484 
RDMA_NETDEV_IPOIB
,

2485 &
∑øms
);

2487 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2488 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2496 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2498 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2499 
sysfs_Áûed
;

2500 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2501 
sysfs_Áûed
;

2502 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2503 
sysfs_Áûed
;

2504 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2505 
sysfs_Áûed
;

2506 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2507 
sysfs_Áûed
;

2508 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2509 
sysfs_Áûed
;

2511  
ndev
;

2513 
sysfs_Áûed
:

2514 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2515 
	`uƒegi°î_√tdev
(
ndev
);

2516  
	`ERR_PTR
(-
ENOMEM
);

2517 
	}
}

2519 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2521 
li°_hód
 *
dev_li°
;

2522 
√t_devi˚
 *
dev
;

2523 
ùoib_dev_¥iv
 *
¥iv
;

2524 
p
;

2525 
cou¡
 = 0;

2527 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2528 i‡(!
dev_li°
)

2531 
	`INIT_LIST_HEAD
(
dev_li°
);

2533 
	`rdma_f‹_óch_p‹t
 (
devi˚
, 
p
) {

2534 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2536 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2537 i‡(!
	`IS_ERR
(
dev
)) {

2538 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2539 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2540 
cou¡
++;

2544 i‡(!
cou¡
) {

2545 
	`k‰ì
(
dev_li°
);

2549 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2550 
	}
}

2552 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2554 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2555 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2557 i‡(!
dev_li°
)

2560 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2561 
	`LIST_HEAD
(
hód
);

2562 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2564 
	`π∆_lock
();

2566 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2567 
li°
)

2568 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2569 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2570 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2572 
	`π∆_u∆ock
();

2575 
	`k‰ì
(
dev_li°
);

2576 
	}
}

2578 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2579 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2580 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2584 
__öô
 
	$ùoib_öô_moduÀ
()

2586 
ªt
;

2588 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2589 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2590 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2592 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2593 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2594 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2595 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2596 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2597 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2604 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2606 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2608 
	`ùoib_ªgi°î_debugfs
();

2620 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2621 i‡(!
ùoib_w‹kqueue
) {

2622 
ªt
 = -
ENOMEM
;

2623 
îr_fs
;

2626 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2628 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2629 i‡(
ªt
)

2630 
îr_ß
;

2632 
ªt
 = 
	`ùoib_√éök_öô
();

2633 i‡(
ªt
)

2634 
îr_˛õ¡
;

2636 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2637 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2641 
îr_˛õ¡
:

2642 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2644 
îr_ß
:

2645 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2646 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2648 
îr_fs
:

2649 
	`ùoib_uƒegi°î_debugfs
();

2651  
ªt
;

2652 
	}
}

2654 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2656 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2657 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2659 
	`ùoib_√éök_föi
();

2660 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2661 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2662 
	`ùoib_uƒegi°î_debugfs
();

2663 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2664 
	}
}

2666 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2667 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL82/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@RHEL82/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL82/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

267 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

268 
	}
}

270 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

271 
ib_evít
 *
ªc‹d
)

273 
ùoib_dev_¥iv
 *
¥iv
 =

274 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

276 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

279 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

280 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

282 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

283 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

284 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

285 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

286 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

287 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

288 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

289 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

290 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

291 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

294 
	}
}

	@RHEL82/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@RHEL83/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

57 
	eùoib_Êush_Àvñ
 {

58 
	mIPOIB_FLUSH_LIGHT
,

59 
	mIPOIB_FLUSH_NORMAL
,

60 
	mIPOIB_FLUSH_HEAVY


64 
	mIPOIB_ENCAP_LEN
 = 4,

65 
	mIPOIB_PSEUDO_LEN
 = 20,

66 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

68 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

69 
	mIPOIB_UD_RX_SG
 = 2,

71 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

72 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

73 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

74 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

75 
	mIPOIB_RX_RING_SIZE
 = 256,

76 
	mIPOIB_TX_RING_SIZE
 = 128,

77 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

78 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

79 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

81 
	mIPOIB_NUM_WC
 = 4,

83 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

84 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

86 
	mIPOIB_FLAG_OPER_UP
 = 0,

87 
	mIPOIB_FLAG_INITIALIZED
 = 1,

88 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

89 
	mIPOIB_PKEY_ASSIGNED
 = 3,

90 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

91 
	mIPOIB_STOP_REAPER
 = 7,

92 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

93 
	mIPOIB_FLAG_UMCAST
 = 10,

94 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

95 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

96 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

98 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

100 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

101 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

109 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

110 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

112 
	mMAX_SEND_CQE
 = 64,

113 
	mIPOIB_CM_COPYBREAK
 = 256,

115 
	mIPOIB_NON_CHILD
 = 0,

116 
	mIPOIB_LEGACY_CHILD
 = 1,

117 
	mIPOIB_RTNL_CHILD
 = 2,

120 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

121 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


122 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

124 
	#IPOIB_OP_CM
 (0)

	)

127 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

131 
	sùoib_hódî
 {

132 
__be16
 
	m¥Ÿo
;

133 
u16
 
	mª£rved
;

136 
	sùoib_p£udo_hódî
 {

137 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

140 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

142 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

148 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

149 
	`skb_ª£t_mac_hódî
(
skb
);

150 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

151 
	}
}

153 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

155 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

157  
∫
->
˛¡_¥iv
;

158 
	}
}

161 
	sùoib_mˇ°
 {

162 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

163 
ib_ß_mu…iˇ°
 *
	mmc
;

164 
ùoib_ah
 *
	mah
;

166 
rb_node
 
	mrb_node
;

167 
li°_hód
 
	mli°
;

169 
	m¸óãd
;

170 
	mbackoff
;

171 
	mdñay_u¡û
;

173 
	mÊags
;

174 
	mlogcou¡
;

176 
li°_hód
 
	m√igh_li°
;

178 
sk_buff_hód
 
	mpkt_queue
;

180 
√t_devi˚
 *
	mdev
;

181 
com∂ëi⁄
 
	md⁄e
;

184 
	sùoib_rx_buf
 {

185 
sk_buff
 *
	mskb
;

186 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

189 
	sùoib_tx_buf
 {

190 
sk_buff
 *
	mskb
;

191 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

194 
	gib_cm_id
;

196 
	sùoib_cm_d©a
 {

197 
__be32
 
	mq≤
;

198 
__be32
 
	mmtu
;

228 
	eùoib_cm_°©e
 {

229 
	mIPOIB_CM_RX_LIVE
,

230 
	mIPOIB_CM_RX_ERROR
,

231 
	mIPOIB_CM_RX_FLUSH


234 
	sùoib_cm_rx
 {

235 
ib_cm_id
 *
	mid
;

236 
ib_qp
 *
	mqp
;

237 
ùoib_cm_rx_buf
 *
	mrx_rög
;

238 
li°_hód
 
	mli°
;

239 
√t_devi˚
 *
	mdev
;

240 
	mjiffõs
;

241 
ùoib_cm_°©e
 
	m°©e
;

242 
	mªcv_cou¡
;

245 
	sùoib_cm_tx
 {

246 
ib_cm_id
 *
	mid
;

247 
ib_qp
 *
	mqp
;

248 
li°_hód
 
	mli°
;

249 
√t_devi˚
 *
	mdev
;

250 
ùoib_√igh
 *
	m√igh
;

251 
ùoib_tx_buf
 *
	mtx_rög
;

252 
	mtx_hód
;

253 
	mtx_èû
;

254 
	mÊags
;

255 
u32
 
	mmtu
;

256 
	mmax_£nd_sge
;

259 
	sùoib_cm_rx_buf
 {

260 
sk_buff
 *
	mskb
;

261 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

264 
	sùoib_cm_dev_¥iv
 {

265 
ib_§q
 *
	m§q
;

266 
ùoib_cm_rx_buf
 *
	m§q_rög
;

267 
ib_cm_id
 *
	mid
;

268 
li°_hód
 
	m∑ssive_ids
;

269 
li°_hód
 
	mrx_îr‹_li°
;

270 
li°_hód
 
	mrx_Êush_li°
;

271 
li°_hód
 
	mrx_døö_li°
;

272 
li°_hód
 
	mrx_ª≠_li°
;

273 
w‹k_°ru˘
 
	m°¨t_èsk
;

274 
w‹k_°ru˘
 
	mª≠_èsk
;

275 
w‹k_°ru˘
 
	mskb_èsk
;

276 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

277 
dñayed_w‹k
 
	m°Æe_èsk
;

278 
sk_buff_hód
 
	mskb_queue
;

279 
li°_hód
 
	m°¨t_li°
;

280 
li°_hód
 
	mª≠_li°
;

281 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

282 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

283 
ib_ªcv_wr
 
	mrx_wr
;

284 
	mn⁄§q_c⁄n_qp
;

285 
	mmax_cm_mtu
;

286 
	mnum_‰ags
;

289 
	sùoib_ëhtoﬁ_°
 {

290 
u16
 
	mcﬂÀs˚_u£cs
;

291 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

294 
	gùoib_√igh_èbÀ
;

296 
	sùoib_√igh_hash
 {

297 
ùoib_√igh_èbÀ
 *
	m¡bl
;

298 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

299 
rcu_hód
 
	mrcu
;

300 
u32
 
	mmask
;

301 
u32
 
	msize
;

304 
	sùoib_√igh_èbÀ
 {

305 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

306 
©omic_t
 
	míåõs
;

307 
com∂ëi⁄
 
	mÊushed
;

308 
com∂ëi⁄
 
	mdñëed
;

311 
	sùoib_qp_°©e_vÆid©e
 {

312 
w‹k_°ru˘
 
	mw‹k
;

313 
ùoib_dev_¥iv
 *
	m¥iv
;

321 
	sùoib_dev_¥iv
 {

322 
•ölock_t
 
	mlock
;

324 
√t_devi˚
 *
	mdev
;

325 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

327 
«pi_°ru˘
 
	m£nd_«pi
;

328 
«pi_°ru˘
 
	mªcv_«pi
;

330 
	mÊags
;

339 
rw_£m≠h‹e
 
	mvœn_rw£m
;

340 
muãx
 
	mmˇ°_muãx
;

342 
rb_roŸ
 
	m∑th_åì
;

343 
li°_hód
 
	m∑th_li°
;

345 
ùoib_√igh_èbÀ
 
	m¡bl
;

347 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

348 
li°_hód
 
	mmu…iˇ°_li°
;

349 
rb_roŸ
 
	mmu…iˇ°_åì
;

351 
w‹kqueue_°ru˘
 *
	mwq
;

352 
dñayed_w‹k
 
	mmˇ°_èsk
;

353 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

354 
w‹k_°ru˘
 
	mÊush_light
;

355 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

356 
w‹k_°ru˘
 
	mÊush_hóvy
;

357 
w‹k_°ru˘
 
	mª°¨t_èsk
;

358 
dñayed_w‹k
 
	mah_ª≠_èsk
;

359 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

360 
ib_devi˚
 *
	mˇ
;

361 
u8
 
	mp‹t
;

362 
u16
 
	mpkey
;

363 
u16
 
	mpkey_ödex
;

364 
ib_pd
 *
	mpd
;

365 
ib_cq
 *
	mªcv_cq
;

366 
ib_cq
 *
	m£nd_cq
;

367 
ib_qp
 *
	mqp
;

368 
u32
 
	mqkey
;

370 
ib_gid
 
	mloˇl_gid
;

371 
u32
 
	mloˇl_lid
;

373 
	madmö_mtu
;

374 
	mmˇ°_mtu
;

375 
	mmax_ib_mtu
;

377 
ùoib_rx_buf
 *
	mrx_rög
;

379 
ùoib_tx_buf
 *
	mtx_rög
;

380 
	mtx_hód
;

381 
	mtx_èû
;

382 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

383 
ib_ud_wr
 
	mtx_wr
;

384 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

386 
ib_ªcv_wr
 
	mrx_wr
;

387 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

389 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

391 
li°_hód
 
	mdód_ahs
;

393 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

395 
√t_devi˚
 *
	m∑ª¡
;

396 
li°_hód
 
	mchûd_ötfs
;

397 
li°_hód
 
	mli°
;

398 
	mchûd_ty≥
;

400 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


401 
ùoib_cm_dev_¥iv
 
	mcm
;

404 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


405 
li°_hód
 
	mfs_li°
;

406 
díåy
 *
	mmcg_díåy
;

407 
díåy
 *
	m∑th_díåy
;

409 
u64
 
	mhˇ_ˇps
;

410 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

411 
	mmax_£nd_sge
;

412 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

413 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

416 
	sùoib_ah
 {

417 
√t_devi˚
 *
	mdev
;

418 
ib_ah
 *
	mah
;

419 
li°_hód
 
	mli°
;

420 
kªf
 
	mªf
;

421 
	mœ°_£nd
;

422 
	mvÆid
;

425 
	sùoib_∑th
 {

426 
√t_devi˚
 *
	mdev
;

427 
ß_∑th_ªc
 
	m∑thªc
;

428 
ùoib_ah
 *
	mah
;

429 
sk_buff_hód
 
	mqueue
;

431 
li°_hód
 
	m√igh_li°
;

433 
	mquîy_id
;

434 
ib_ß_quîy
 *
	mquîy
;

435 
com∂ëi⁄
 
	md⁄e
;

437 
rb_node
 
	mrb_node
;

438 
li°_hód
 
	mli°
;

441 
	sùoib_√igh
 {

442 
ùoib_ah
 *
	mah
;

443 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


444 
ùoib_cm_tx
 *
	mcm
;

446 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

447 
sk_buff_hód
 
	mqueue
;

449 
√t_devi˚
 *
	mdev
;

451 
li°_hód
 
	mli°
;

452 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

453 
rcu_hód
 
	mrcu
;

454 
©omic_t
 
	mªf˙t
;

455 
	mÆive
;

458 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

459 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

461 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

462 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

464 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

465 
	`ùoib_√igh_dt‹
(
√igh
);

466 
	}
}

467 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

468 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

469 
√t_devi˚
 *
dev
);

470 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

471 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

473 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

477 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

478 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

480 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

482 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

483 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

484 
ùoib_‰ì_ah
(
kªf
 *kref);

485 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

487 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

488 
	}
}

489 
ùoib_›í
(
√t_devi˚
 *
dev
);

490 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

491 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

492 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

494 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

495 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

496 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

498 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

499 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

500 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

501 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

502 c⁄° *
f‹m©
);

503 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

504 
√t_devi˚
 *
dev
);

505 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

506 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

507 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

512 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

518 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

520 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

521 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

524 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

525 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

526 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

528 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

531 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

532 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

533 
ùoib_tx_buf
 *
tx_ªq
);

535 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

537 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

538 
ùoib_tx_buf
 *
tx_ªq
)

540 
i
, 
off
;

541 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

542 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

543 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

544 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

546 i‡(
	`skb_hódÀn
(
skb
)) {

547 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

548 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

549 
off
 = 1;

551 
off
 = 0;

553 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

554 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

555 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

557 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

558 
	}
}

560 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


561 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

562 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

563 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

564 
ib_gid
 *
gid
,

565 *
¸óãd
,

566 *
queuñí
,

567 *
com∂ëe
,

568 *
£nd_⁄ly
);

570 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

571 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

572 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

573 
ùoib_∑th
 *
∑th
);

576 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

577 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

578 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

579 
ib_gid
 *
mgid
, 
u16
 
mlid
);

580 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

581 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

582 
li°_hód
 *
ªmove_li°
);

584 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

585 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

586 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

588 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

589 
ib_evít
 *
ªc‹d
);

591 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

592 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

594 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

595 
u16
 
pkey
, 
chûd_ty≥
);

597 
__öô
 
ùoib_√éök_öô
();

598 
__exô
 
ùoib_√éök_föi
();

600 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

601 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

603 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

605 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

606 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

608 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

610 
	#IPOIB_FLAGS_RC
 0x80

	)

611 
	#IPOIB_FLAGS_UC
 0x40

	)

614 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

616 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


618 
ùoib_max_c⁄n_qp
;

620 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

622 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

623  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

624 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

625 
	}
}

627 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

629 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

630  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

631 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

632 
	}
}

634 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

637  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

638 
	}
}

640 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

642  
√igh
->
cm
;

643 
	}
}

645 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

647 
√igh
->
cm
 = 
tx
;

648 
	}
}

650 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

653  !!
¥iv
->
cm
.
§q
;

654 
	}
}

656 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

659  
¥iv
->
cm
.
max_cm_mtu
;

660 
	}
}

662 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

663 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

664 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

669 
ùoib_√igh
 *
√igh
);

670 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

671 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

672 
mtu
);

673 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

674 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

677 
	gùoib_cm_tx
;

679 
	#ùoib_max_c⁄n_qp
 0

	)

681 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

684 
	}
}

685 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

689 
	}
}

691 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

695 
	}
}

697 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

699  
NULL
;

700 
	}
}

702 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

704 
	}
}

706 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

709 
	}
}

711 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

714 
	}
}

716 
ölöe


717 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

720 
	}
}

722 
ölöe


723 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

726 
	}
}

728 
ölöe


729 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

732 
	}
}

734 
ölöe


735 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

737  -
EOPNOTSUPP
;

738 
	}
}

740 
ölöe


741 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

744 
	}
}

746 
ölöe


747 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

748 
ùoib_√igh
 *
√igh
)

750  
NULL
;

751 
	}
}

753 
ölöe


754 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

757 
	}
}

759 
ölöe


760 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

763 
	}
}

765 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

766 
mtu
)

768 
	`dev_k‰ì_skb_™y
(
skb
);

769 
	}
}

771 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

773 
	}
}

775 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

777 
	}
}

780 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


781 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

782 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_ªgi°î_debugfs
();

784 
ùoib_uƒegi°î_debugfs
();

786 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

787 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{ 
	}
}

789 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

792 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

793 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

794 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

796 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

797 10 * 
HZ
 , \

799 i‡(
	`__øãlimô
(&
_rs
)) \

800 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

801 } 0)

	)

803 
ùoib_£ndq_size
;

804 
ùoib_ªcvq_size
;

806 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

808 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


809 
ùoib_debug_Àvñ
;

811 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

813 i‡(
ùoib_debug_Àvñ
 > 0) \

814 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

815 } 0)

	)

816 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

818 i‡(
mˇ°_debug_Àvñ
 > 0) \

819 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

820 } 0)

	)

822 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

823 dÿ{ (Ë(
¥iv
); } 0)

	)

824 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

825 dÿ{ (Ë(
¥iv
); } 0)

	)

828 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


829 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

831 i‡(
d©a_debug_Àvñ
 > 0) \

832 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

833 } 0)

	)

835 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

836 dÿ{ (Ë(
¥iv
); } 0)

	)

839 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

841 c⁄° 
ùoib_drivî_vîsi⁄
[];

	@RHEL83/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

359 (*
rx
->
rx_rög
)));

360 i‡(!
rx
->
rx_rög
)

361  -
ENOMEM
;

363 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

364 i‡(!
t
) {

365 
ªt
 = -
ENOMEM
;

366 
îr_‰ì_1
;

369 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

371 
	`•ö_lock_úq
(&
¥iv
->
lock
);

373 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

374 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

375 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

376 
ªt
 = -
EINVAL
;

377 
îr_‰ì
;

379 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

381 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

383 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

384 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

385 
rx
->
rx_rög
[
i
].
m≠pög
,

386 
GFP_KERNEL
)) {

387 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

388 
ªt
 = -
ENOMEM
;

389 
îr_cou¡
;

391 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

392 i‡(
ªt
) {

393 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

394 "Áûed f‹ bu‡%d\n", 
i
);

395 
ªt
 = -
EIO
;

396 
îr_cou¡
;

400 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

402 
	`k‰ì
(
t
);

406 
îr_cou¡
:

407 
	`•ö_lock_úq
(&
¥iv
->
lock
);

408 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

409 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

411 
îr_‰ì
:

412 
	`k‰ì
(
t
);

414 
îr_‰ì_1
:

415 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

417  
ªt
;

418 
	}
}

420 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

421 
ib_qp
 *
qp
,

422 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

443 c⁄° 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 c⁄° 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
,

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

644 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

645 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

984 c⁄° 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1073 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 c⁄° 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1440 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1441 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1443 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1444 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1445 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1446 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1449 
	`dev_k‰ì_skb_™y
(
skb
);

1451 
	`√tif_tx_lock_bh
(
dev
);

1452 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1455 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1456 
	`√tif_tx_u∆ock_bh
(
dev
);

1457 
	}
}

1459 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1460 
mtu
)

1462 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1463 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1465 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1574 (*
¥iv
->
cm
.
§q_rög
)));

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@RHEL83/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

144 
	}
}

145 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

146 
s£t
)

148 
s£t
) {

149 
ETH_SS_STATS
:

150  
IPOIB_GLOBAL_STATS_LEN
;

154  -
EOPNOTSUPP
;

155 
	}
}

158 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

160 
•ìd
) {

161 
IB_SPEED_SDR
:

162  
SPEED_2500
;

163 
IB_SPEED_DDR
:

164  
SPEED_5000
;

165 
IB_SPEED_QDR
:

166 
IB_SPEED_FDR10
:

167  
SPEED_10000
;

168 
IB_SPEED_FDR
:

169  
SPEED_14000
;

170 
IB_SPEED_EDR
:

171  
SPEED_25000
;

174  
SPEED_UNKNOWN
;

175 
	}
}

177 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

178 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

180 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

181 
ib_p‹t_©å
 
©å
;

182 
ªt
, 
•ìd
, 
width
;

184 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

185 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

186 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

190 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

191 i‡(
ªt
 < 0)

192  -
EINVAL
;

194 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

195 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

197 i‡(
•ìd
 < 0 || 
width
 < 0)

198  -
EINVAL
;

204 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

205 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

207 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

209 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

210 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

213 
	}
}

215 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

216 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

217 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

218 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

219 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

220 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

221 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

222 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

223 .
	ggë_lök
 = 
ëhtoﬁ_›_gë_lök
,

226 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

228 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

229 
	}
}

	@RHEL83/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

271 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

272 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

273 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

274 
	}
}

276 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

281 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

282 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

283 
	}
}

285 
	$ùoib_ªgi°î_debugfs
()

287 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

288 
	}
}

290 
	$ùoib_uƒegi°î_debugfs
()

292 
	`debugfs_ªmove
(
ùoib_roŸ
);

293 
	}
}

	@RHEL83/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
	`skb_‰ag_off
(
‰ag
),

297 
	`skb_‰ag_size
(
‰ag
),

298 
DMA_TO_DEVICE
);

299 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

300 
∑πül_îr‹
;

304 
∑πül_îr‹
:

305 ; 
i
 > 0; --i) {

306 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

308 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

311 i‡(
off
)

312 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

314  -
EIO
;

315 
	}
}

317 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

318 
ùoib_tx_buf
 *
tx_ªq
)

320 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

321 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

322 
i
;

323 
off
;

325 i‡(
	`skb_hódÀn
(
skb
)) {

326 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

327 
DMA_TO_DEVICE
);

328 
off
 = 1;

330 
off
 = 0;

332 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

333 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

335 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

336 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

338 
	}
}

345 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

347 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

348 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

350 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

351 
ib_qp_©å
 
qp_©å
;

352 
ib_qp_öô_©å
 
quîy_öô_©å
;

353 
ªt
;

355 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

356 i‡(
ªt
) {

357 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

358 
__func__
, 
ªt
);

359 
‰ì_ªs
;

361 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

362 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

365 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

366 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

368 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

369 i‡(
ªt
) {

370 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

371 
ªt
, 
¥iv
->
qp
->
qp_num
);

372 
‰ì_ªs
;

374 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

375 
__func__
, 
¥iv
->
qp
->
qp_num
);

377 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

378 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

381 
‰ì_ªs
:

382 
	`k‰ì
(
qp_w‹k
);

383 
	}
}

385 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

388 
wr_id
 = 
wc
->wr_id;

389 
ùoib_tx_buf
 *
tx_ªq
;

391 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

392 
wr_id
, 
wc
->
°©us
);

394 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

395 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

396 
wr_id
, 
ùoib_£ndq_size
);

400 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

402 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

404 ++
dev
->
°©s
.
tx_∑ckës
;

405 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

407 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

409 ++
¥iv
->
tx_èû
;

411 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

412 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

413 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

414 
	`√tif_wake_queue
(
dev
);

416 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

417 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

418 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

419 
	`ùoib_w¨n
(
¥iv
,

421 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

422 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

423 i‡(!
qp_w‹k
)

426 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

427 
qp_w‹k
->
¥iv
 =Öriv;

428 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

430 
	}
}

432 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

434 
n
, 
i
;

435 
ib_wc
 *
wc
;

437 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

438 
i
 = 0; i < 
n
; ++i) {

439 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

440 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

441 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

443 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

445  
n
 =
MAX_SEND_CQE
;

446 
	}
}

448 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

450 
ùoib_dev_¥iv
 *
¥iv
 =

451 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

452 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

453 
d⁄e
;

454 
t
;

455 
n
, 
i
;

457 
d⁄e
 = 0;

459 
pﬁl_m‹e
:

460 
d⁄e
 < 
budgë
) {

461 
max
 = (
budgë
 - 
d⁄e
);

463 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

464 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

466 
i
 = 0; i < 
n
; i++) {

467 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

469 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

470 ++
d⁄e
;

471 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

472 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

474 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

476 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

480 i‡(
n
 !
t
)

484 i‡(
d⁄e
 < 
budgë
) {

485 
	`«pi_com∂ëe
(
«pi
);

486 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

487 
IB_CQ_NEXT_COMP
 |

488 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

489 
	`«pi_ªscheduÀ
(
«pi
))

490 
pﬁl_m‹e
;

493  
d⁄e
;

494 
	}
}

496 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

498 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

499 
£nd_«pi
);

500 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

501 
n
, 
i
;

502 
ib_wc
 *
wc
;

504 
pﬁl_m‹e
:

505 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

507 
i
 = 0; i < 
n
; i++) {

508 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

509 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

510 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

512 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

515 i‡(
n
 < 
budgë
) {

516 
	`«pi_com∂ëe
(
«pi
);

517 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

518 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

519 
	`«pi_ªscheduÀ
(
«pi
))

520 
pﬁl_m‹e
;

522  
n
 < 0 ? 0 :Ç;

523 
	}
}

525 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

527 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

529 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

530 
	}
}

532 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

534 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

536 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

537 
	}
}

539 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

540 
wr_id
,

541 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

542 
ùoib_tx_buf
 *
tx_ªq
,

543 *
hód
, 
hÀn
)

545 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

547 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

549 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

550 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

551 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

553 i‡(
hód
) {

554 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

555 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

556 
¥iv
->
tx_wr
.
hÀn
 = hlen;

557 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

559 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

561  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

562 
	}
}

564 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

565 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

567 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

568 
ùoib_tx_buf
 *
tx_ªq
;

569 
hÀn
, 
rc
;

570 *
phód
;

571 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

573 i‡(
	`skb_is_gso
(
skb
)) {

574 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

575 
phód
 = 
skb
->
d©a
;

576 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

577 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

578 ++
dev
->
°©s
.
tx_dr›≥d
;

579 ++
dev
->
°©s
.
tx_îr‹s
;

580 
	`dev_k‰ì_skb_™y
(
skb
);

584 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

585 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

586 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

587 ++
dev
->
°©s
.
tx_dr›≥d
;

588 ++
dev
->
°©s
.
tx_îr‹s
;

589 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

592 
phód
 = 
NULL
;

593 
hÀn
 = 0;

595 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

596 i‡(
	`skb_löórize
(
skb
) < 0) {

597 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

598 ++
dev
->
°©s
.
tx_dr›≥d
;

599 ++
dev
->
°©s
.
tx_îr‹s
;

600 
	`dev_k‰ì_skb_™y
(
skb
);

604 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

605 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

606 ++
dev
->
°©s
.
tx_dr›≥d
;

607 ++
dev
->
°©s
.
tx_îr‹s
;

608 
	`dev_k‰ì_skb_™y
(
skb
);

613 
	`ùoib_dbg_d©a
(
¥iv
,

615 
skb
->
Àn
, 
addªss
, 
dq≤
);

624 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

625 
tx_ªq
->
skb
 = skb;

626 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

627 ++
dev
->
°©s
.
tx_îr‹s
;

628 
	`dev_k‰ì_skb_™y
(
skb
);

632 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

633 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

635 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

637 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

638 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

639 
	`√tif_°›_queue
(
dev
);

642 
	`skb_‹ph™
(
skb
);

643 
	`skb_d°_dr›
(
skb
);

645 i‡(
	`√tif_queue_°›≥d
(
dev
))

646 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

647 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

648 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

650 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

651 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

652 i‡(
	`u∆ikñy
(
rc
)) {

653 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

654 ++
dev
->
°©s
.
tx_îr‹s
;

655 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

656 
	`dev_k‰ì_skb_™y
(
skb
);

657 i‡(
	`√tif_queue_°›≥d
(
dev
))

658 
	`√tif_wake_queue
(
dev
);

659 
rc
 = 0;

661 
	`√tif_å™s_upd©e
(
dev
);

663 
rc
 = 
¥iv
->
tx_hód
;

664 ++
¥iv
->
tx_hód
;

666  
rc
;

667 
	}
}

669 
	$ùoib_ª≠_dód_ahs
(
ùoib_dev_¥iv
 *
¥iv
)

671 
ùoib_ah
 *
ah
, *
èh
;

672 
Êags
;

674 
	`√tif_tx_lock_bh
(
¥iv
->
dev
);

675 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

677 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

678 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

679 
	`li°_dñ
(&
ah
->
li°
);

680 
	`rdma_de°roy_ah
(
ah
->ah, 0);

681 
	`k‰ì
(
ah
);

684 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

685 
	`√tif_tx_u∆ock_bh
(
¥iv
->
dev
);

686 
	}
}

688 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

690 
ùoib_dev_¥iv
 *
¥iv
 =

691 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

693 
	`ùoib_ª≠_dód_ahs
(
¥iv
);

695 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

696 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

697 
	`round_jiffõs_ªœtive
(
HZ
));

698 
	}
}

700 
	$ùoib_°¨t_ah_ª≠î
(
ùoib_dev_¥iv
 *
¥iv
)

702 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

703 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

704 
	`round_jiffõs_ªœtive
(
HZ
));

705 
	}
}

707 
	$ùoib_°›_ah_ª≠î
(
ùoib_dev_¥iv
 *
¥iv
)

709 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

710 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

716 
	}
}

718 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

720 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

721 
≥ndög
 = 0;

722 
i
;

724 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

725 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

726 ++
≥ndög
;

728  
≥ndög
;

729 
	}
}

731 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

732 
ib_qp
 *
qp
,

733 
ib_qp_°©e
 
√w_°©e
)

735 
ib_qp_©å
 
qp_©å
;

736 
ib_qp_öô_©å
 
quîy_öô_©å
;

737 
ªt
;

739 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

740 i‡(
ªt
) {

741 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

745 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

746 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

748 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

749 
√w_°©e
, 
qp_©å
.
qp_°©e
);

750 
	}
}

752 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

754 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

757 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

758 
	}
}

760 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

764 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

765 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

766 
	}
}

768 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
ib_qp_©å
 
qp_©å
;

772 
begö
;

773 
ùoib_tx_buf
 *
tx_ªq
;

774 
i
;

776 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

777 
	`ùoib_«pi_dißbÀ
(
dev
);

779 
	`ùoib_cm_dev_°›
(
dev
);

785 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

786 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

787 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

790 
begö
 = 
jiffõs
;

792 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

793 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

794 
	`ùoib_w¨n
(
¥iv
,

796 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

797 
	`ªcvs_≥ndög
(
dev
));

803 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

804 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

805 (
ùoib_£ndq_size
 - 1)];

806 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

807 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

808 ++
¥iv
->
tx_èû
;

811 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

812 
ùoib_rx_buf
 *
rx_ªq
;

814 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

815 i‡(!
rx_ªq
->
skb
)

817 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

818 
¥iv
->
rx_rög
[
i
].
m≠pög
);

819 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

820 
rx_ªq
->
skb
 = 
NULL
;

823 
timeout
;

826 
	`ùoib_døö_cq
(
dev
);

828 
	`u¶ìp_ønge
(1000, 2000);

831 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

833 
timeout
:

834 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

835 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

836 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

838 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

841 
	}
}

843 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

845 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

846 
ªt
;

848 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

849 i‡(
ªt
) {

850 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

854 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

855 i‡(
ªt
) {

856 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

857 
out
;

860 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

861 i‡(
ªt
) {

862 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

863 
out
;

866 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

867 
	`ùoib_«pi_íabÀ
(
dev
);

870 
out
:

872 
	}
}

874 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

876 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

878 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

880 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

881 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

882 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

886 
	`ùoib_°¨t_ah_ª≠î
(
¥iv
);

887 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

888 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

889 
dev_°›
;

892 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

896 
dev_°›
:

897 
	`ùoib_°›_ah_ª≠î
(
¥iv
);

899 
	}
}

901 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

903 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

907 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

908 
	`ùoib_°›_ah_ª≠î
(
¥iv
);

909 
	}
}

911 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

913 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

914 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

916 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

917 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

918 &
¥iv
->
pkey_ödex
)) {

919 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

921 i‡(
∫
->
£t_id
)

922 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

923 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

925 
	}
}

927 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

929 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

931 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

933 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

934 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

938 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

940 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

941 
	}
}

943 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

945 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

947 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

949 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

950 
	`√tif_ˇºõr_off
(
dev
);

952 
	`ùoib_mˇ°_°›_thªad
(
dev
);

953 
	`ùoib_mˇ°_dev_Êush
(
dev
);

955 
	`ùoib_Êush_∑ths
(
dev
);

956 
	}
}

958 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

960 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

961 
i
, 
n
;

968 
	`loˇl_bh_dißbÀ
();

971 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

972 
i
 = 0; i < 
n
; ++i) {

978 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

979 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

981 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

982 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

983 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

985 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

987 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

990 } 
n
 =
IPOIB_NUM_WC
);

992 
	`pﬁl_tx
(
¥iv
))

995 
	`loˇl_bh_íabÀ
();

996 
	}
}

1002 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1004 
ªsu…
;

1005 
u16
 
¥ev_pkey
;

1007 
¥ev_pkey
 = 
¥iv
->
pkey
;

1008 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1009 i‡(
ªsu…
) {

1010 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1011 
¥iv
->
p‹t
, 
ªsu…
);

1012  
ªsu…
;

1015 
¥iv
->
pkey
 |= 0x8000;

1017 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1018 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1019 
¥ev_pkey
, 
¥iv
->
pkey
);

1024 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1025 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1030 
	}
}

1034 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1036 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1038 
¥iv
->
pkey_ödex
 = 0;

1039 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1041 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1042 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1045 
	}
}

1051 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1053 
ib_gid
 
£¨ch_gid
;

1054 
ib_gid
 
gid0
;

1055 
ib_gid
 *
√tdev_gid
;

1056 
îr
;

1057 
u16
 
ödex
;

1058 
u8
 
p‹t
;

1059 
boﬁ
 
ªt
 = 
Ál£
;

1061 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1062 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1063  
Ál£
;

1065 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1070 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1071 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1072 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1074 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1076 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1078 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1080 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1082 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1083 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1087 
out
;

1114 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1115 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1116 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1117 i‡(
ödex
 == 0)

1118 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1119 &
¥iv
->
Êags
);

1121 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1122 
ªt
 = 
åue
;

1124 
ªt
 = 
Ál£
;

1127 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1128 
ªt
 = 
åue
;

1130 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1131 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1132 (
¥iv
->
loˇl_gid
));

1133 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1134 (
¥iv
->
loˇl_gid
));

1135 
ªt
 = 
åue
;

1140 
out
:

1141 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1143  
ªt
;

1144 
	}
}

1146 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1147 
ùoib_Êush_Àvñ
 
Àvñ
,

1148 
√°ög
)

1150 
ùoib_dev_¥iv
 *
˝riv
;

1151 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1152 
ªsu…
;

1154 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1160 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1161 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1163 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1165 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1166 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1168 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1169 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1170 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1174 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1176 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1177 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1178 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1180 
	`upd©e_chûd_pkey
(
¥iv
);

1181 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1182 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1183 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1187 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1191 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1192 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1193 i‡(
ªsu…
) {

1195 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1200 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1202 i‡(
ªsu…
) {

1203 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1209 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1210 
›î_up
;

1211 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1217 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1218 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1219 i‡(
›î_up
)

1220 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1221 
	`ùoib_ª≠_dód_ahs
(
¥iv
);

1224 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1225 
	`ùoib_ib_dev_down
(
dev
);

1227 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1228 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1229 
	`ùoib_ib_dev_°›
(
dev
);

1231 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1234 i‡(
	`√tif_queue_°›≥d
(
dev
))

1235 
	`√tif_°¨t_queue
(
dev
);

1242 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1243 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1244 
	`ùoib_ib_dev_up
(
dev
);

1245 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1246 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1248 
	}
}

1250 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1252 
ùoib_dev_¥iv
 *
¥iv
 =

1253 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1255 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1256 
	}
}

1258 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1260 
ùoib_dev_¥iv
 *
¥iv
 =

1261 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1263 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1264 
	}
}

1266 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1268 
ùoib_dev_¥iv
 *
¥iv
 =

1269 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1271 
	`π∆_lock
();

1272 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1273 
	`π∆_u∆ock
();

1274 
	}
}

1276 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1280 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1285 
	`ùoib_Êush_∑ths
(
dev
);

1287 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1288 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1296 
	`ùoib_ª≠_dód_ahs
(
¥iv
);

1298 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1300 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1302 i‡(
¥iv
->
pd
) {

1303 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1304 
¥iv
->
pd
 = 
NULL
;

1306 
	}
}

	@RHEL83/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
, 
NULL
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
, 
NULL
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 
	`¥ötk
("ipoib_change_mtu:Çew_mtu %uÖriv->max_ib_mtu %u\n",

247 
√w_mtu
, 
¥iv
->
max_ib_mtu
);

248 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

249 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

250  -
EINVAL
;

252 
¥iv
->
admö_mtu
 = 
√w_mtu
;

253 
	`¥ötk
("ipoib_change_mtu:Öriv->admin_mtu %uÖriv->mcast_mtu %u\n",

254 
¥iv
->
admö_mtu
,Öriv->
mˇ°_mtu
);

256 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

257 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

258 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

260 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

262 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

263 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

265 
	`√tif_ˇºõr_off
(
dev
);

268 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

270 i‡(
ˇºõr_°©us
)

271 
	`√tif_ˇºõr_⁄
(
dev
);

273 
dev
->
mtu
 = 
√w_mtu
;

276  
ªt
;

277 
	}
}

279 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

280 
π∆_lök_°©s64
 *
°©s
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

285 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

287 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

288 
	}
}

291 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

292 
√t_devi˚
 *
dev
)

294 
√t
 *√à
	`dev_√t
(
dev
);

295 
ö_devi˚
 *
ö_dev
;

296 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

297 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

298 
__be32
 
ªt_addr
;

300 
addr
->
ß_Ámûy
) {

301 
AF_INET
:

302 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

303 i‡(!
ö_dev
)

304  
Ál£
;

306 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

307 
addr_ö
->
sö_addr
.
s_addr
,

308 
RT_SCOPE_HOST
);

309 
	`ö_dev_put
(
ö_dev
);

310 i‡(
ªt_addr
)

311  
åue
;

314 
AF_INET6
:

315 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

316 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

317  
åue
;

321  
Ál£
;

322 
	}
}

331 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

333 
√t_devi˚
 *
ma°î
;

335 
	`rcu_ªad_lock
();

336 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

337 i‡(
ma°î
)

338 
	`dev_hﬁd
(
ma°î
);

339 
	`rcu_ªad_u∆ock
();

341 i‡(
ma°î
)

342  
ma°î
;

344 
	`dev_hﬁd
(
dev
);

345  
dev
;

346 
	}
}

348 
	sùoib_wÆk_d©a
 {

349 c⁄° 
sockaddr
 *
	maddr
;

350 
√t_devi˚
 *
	mªsu…
;

353 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

355 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

356 
ªt
 = 0;

358 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

359 
	`dev_hﬁd
(
uµî
);

360 
d©a
->
ªsu…
 = 
uµî
;

361 
ªt
 = 1;

364  
ªt
;

365 
	}
}

376 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

377 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

379 
ùoib_wÆk_d©a
 
d©a
 = {

380 .
addr
 =áddr,

383 
	`rcu_ªad_lock
();

384 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

385 
	`dev_hﬁd
(
dev
);

386 
d©a
.
ªsu…
 = 
dev
;

387 
out
;

390 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

391 
out
:

392 
	`rcu_ªad_u∆ock
();

393  
d©a
.
ªsu…
;

394 
	}
}

401 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

402 c⁄° 
ib_gid
 *
gid
,

403 
u16
 
pkey_ödex
,

404 c⁄° 
sockaddr
 *
addr
,

405 
√°ög
,

406 
√t_devi˚
 **
found_√t_dev
)

408 
ùoib_dev_¥iv
 *
chûd_¥iv
;

409 
√t_devi˚
 *
√t_dev
 = 
NULL
;

410 
m©ches
 = 0;

412 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

413 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

414 i‡(!
addr
) {

415 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

419 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

421 i‡(
√t_dev
) {

422 i‡(!*
found_√t_dev
)

423 *
found_√t_dev
 = 
√t_dev
;

425 
	`dev_put
(
√t_dev
);

426 ++
m©ches
;

431 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

432 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

433 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

434 
pkey_ödex
, 
addr
,

435 
√°ög
 + 1,

436 
found_√t_dev
);

437 i‡(
m©ches
 > 1)

440 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

442  
m©ches
;

443 
	}
}

448 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

449 
u16
 
pkey_ödex
,

450 c⁄° 
ib_gid
 *
gid
,

451 c⁄° 
sockaddr
 *
addr
,

452 
√t_devi˚
 **
√t_dev
)

454 
ùoib_dev_¥iv
 *
¥iv
;

455 
m©ches
 = 0;

457 *
√t_dev
 = 
NULL
;

459 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

460 i‡(
¥iv
->
p‹t
 !=Öort)

463 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

464 
addr
, 0, 
√t_dev
);

465 i‡(
m©ches
 > 1)

469  
m©ches
;

470 
	}
}

472 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

473 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

474 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

475 *
˛õ¡_d©a
)

477 
√t_devi˚
 *
√t_dev
;

478 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

479 
u16
 
pkey_ödex
;

480 
m©ches
;

481 
ªt
;

483 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

484  
NULL
;

486 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

487 i‡(
ªt
)

488  
NULL
;

490 i‡(!
dev_li°
)

491  
NULL
;

494 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

495 
gid
, 
NULL
, &
√t_dev
);

497 
m©ches
) {

499  
NULL
;

501  
√t_dev
;

504 
	`dev_put
(
√t_dev
);

508 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

509 
gid
, 
addr
, &
√t_dev
);

510 
m©ches
) {

512  
NULL
;

514 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

518  
√t_dev
;

520 
	}
}

522 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

524 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

526 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

527 !
	`°rcmp
(
buf
, "connected\n")) ||

528 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

529 !
	`°rcmp
(
buf
, "datagram\n"))) {

534 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

535 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

536 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

538 
	`√tdev_upd©e_„©uªs
(
dev
);

539 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

540 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

541 
	`π∆_u∆ock
();

542 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

544 
	`ùoib_Êush_∑ths
(
dev
);

545  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

548 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

549 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

550 
	`√tdev_upd©e_„©uªs
(
dev
);

551 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

552 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

553 
	`π∆_u∆ock
();

554 
	`ùoib_Êush_∑ths
(
dev
);

555  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

558  -
EINVAL
;

559 
	}
}

561 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

563 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

564 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

565 
ùoib_∑th
 *
∑th
;

566 
ªt
;

568 
n
) {

569 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

571 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

572  (
ib_gid
));

574 i‡(
ªt
 < 0)

575 
n
 =Ç->
rb_À·
;

576 i‡(
ªt
 > 0)

577 
n
 =Ç->
rb_right
;

579  
∑th
;

582  
NULL
;

583 
	}
}

585 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

587 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

588 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

589 
rb_node
 *
≤
 = 
NULL
;

590 
ùoib_∑th
 *
ç©h
;

591 
ªt
;

593 *
n
) {

594 
≤
 = *
n
;

595 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

597 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

598  (
ib_gid
));

599 i‡(
ªt
 < 0)

600 
n
 = &
≤
->
rb_À·
;

601 i‡(
ªt
 > 0)

602 
n
 = &
≤
->
rb_right
;

604  -
EEXIST
;

607 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

608 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

610 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

613 
	}
}

615 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

617 
sk_buff
 *
skb
;

619 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

620 
	`dev_k‰ì_skb_úq
(
skb
);

622 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "%s\n", 
__func__
);

625 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

627 i‡(
∑th
->
ah
)

628 
	`ùoib_put_ah
(
∑th
->
ah
);

630 
	`k‰ì
(
∑th
);

631 
	}
}

633 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


635 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

637 
ùoib_∑th_ôî
 *
ôî
;

639 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

640 i‡(!
ôî
)

641  
NULL
;

643 
ôî
->
dev
 = dev;

644 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

646 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

647 
	`k‰ì
(
ôî
);

648  
NULL
;

651  
ôî
;

652 
	}
}

654 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

656 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

657 
rb_node
 *
n
;

658 
ùoib_∑th
 *
∑th
;

659 
ªt
 = 1;

661 
	`•ö_lock_úq
(&
¥iv
->
lock
);

663 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

665 
n
) {

666 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

668 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

669  (
ib_gid
)) < 0) {

670 
ôî
->
∑th
 = *path;

671 
ªt
 = 0;

675 
n
 = 
	`rb_√xt
(n);

678 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

680  
ªt
;

681 
	}
}

683 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

684 
ùoib_∑th
 *
∑th
)

686 *
∑th
 = 
ôî
->path;

687 
	}
}

691 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

693 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
ùoib_∑th
 *
∑th
, *
ç
;

696 
	`•ö_lock_úq
(&
¥iv
->
lock
);

698 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

699 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

700 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

701 
∑th
->
∑thªc
.
dgid
.
øw
);

702 i‡(
∑th
->
ah
)

703 
∑th
->
ah
->
vÆid
 = 0;

706 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

707 
	}
}

709 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

711 
ùoib_p£udo_hódî
 *
phdr
;

713 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

714 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

715 
	}
}

717 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

719 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

720 
ùoib_∑th
 *
∑th
, *
ç
;

721 
	`LIST_HEAD
(
ªmove_li°
);

722 
Êags
;

724 
	`√tif_tx_lock_bh
(
dev
);

725 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

727 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

729 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

730 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

732 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

733 i‡(
∑th
->
quîy
)

734 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

735 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

736 
	`√tif_tx_u∆ock_bh
(
dev
);

737 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

738 
	`∑th_‰ì
(
dev
, 
∑th
);

739 
	`√tif_tx_lock_bh
(
dev
);

740 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

743 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

744 
	`√tif_tx_u∆ock_bh
(
dev
);

745 
	}
}

747 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

748 
ß_∑th_ªc
 *
∑thªc
,

749 *
∑th_±r
)

751 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

752 
√t_devi˚
 *
dev
 = 
∑th
->dev;

753 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

754 
ùoib_ah
 *
ah
 = 
NULL
;

755 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

756 
ùoib_√igh
 *
√igh
, *
ä
;

757 
sk_buff_hód
 
skqueue
;

758 
sk_buff
 *
skb
;

759 
Êags
;

761 i‡(!
°©us
)

762 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

763 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

764 
∑thªc
->
dgid
.
øw
);

766 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

767 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

769 
	`skb_queue_hód_öô
(&
skqueue
);

771 i‡(!
°©us
) {

772 
rdma_ah_©å
 
av
;

774 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

775 
∑thªc
, &
av
, 
NULL
)) {

776 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

777 
	`rdma_de°roy_ah_©å
(&
av
);

781 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

783 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

789 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

790 (
ib_gid
))) {

791 
	`ùoib_dbg
(

792 
¥iv
,

794 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

795 
∑th
->
∑thªc
.
dgid
.
øw
);

796 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

797 (
ib_gid
));

800 
∑th
->
∑thªc
 = *pathrec;

802 
ﬁd_ah
 = 
∑th
->
ah
;

803 
∑th
->
ah
 =áh;

805 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

806 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

807 
∑thªc
->
¶
);

809 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

810 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

812 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

813 i‡(
√igh
->
ah
) {

814 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

822 
	`ùoib_put_ah
(
√igh
->
ah
);

824 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

825 
√igh
->
ah
 = 
∑th
->ah;

827 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

828 i‡(!
	`ùoib_cm_gë
(
√igh
))

829 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

830 
∑th
,

831 
√igh
));

832 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

833 
	`ùoib_√igh_‰ì
(
√igh
);

838 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

839 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

841 
∑th
->
ah
->
vÆid
 = 1;

844 
∑th
->
quîy
 = 
NULL
;

845 
	`com∂ëe
(&
∑th
->
d⁄e
);

847 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

849 i‡(
	`IS_ERR_OR_NULL
(
ah
))

850 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

852 i‡(
ﬁd_ah
)

853 
	`ùoib_put_ah
(
ﬁd_ah
);

855 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

856 
ªt
;

857 
skb
->
dev
 = dev;

858 
ªt
 = 
	`dev_queue_xmô
(
skb
);

859 i‡(
ªt
)

860 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

861 
__func__
, 
ªt
);

863 
	}
}

865 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

866 *
gid
)

868 
∑th
->
dev
 = 
¥iv
->dev;

870 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

871 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

873 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

875 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

876 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

877 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

878 
∑th
->
∑thªc
.
numb_∑th
 = 1;

879 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

880 
	}
}

882 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

884 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

885 
ùoib_∑th
 *
∑th
;

887 i‡(!
¥iv
->
brﬂdˇ°
)

888  
NULL
;

890 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

891 i‡(!
∑th
)

892  
NULL
;

894 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

896 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

898 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

900  
∑th
;

901 
	}
}

903 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

904 
ùoib_∑th
 *
∑th
)

906 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

908 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

909 
∑th
->
∑thªc
.
dgid
.
øw
);

911 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

913 
∑th
->
quîy_id
 =

914 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

915 &
∑th
->
∑thªc
,

916 
IB_SA_PATH_REC_DGID
 |

917 
IB_SA_PATH_REC_SGID
 |

918 
IB_SA_PATH_REC_NUMB_PATH
 |

919 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

920 
IB_SA_PATH_REC_PKEY
,

921 1000, 
GFP_ATOMIC
,

922 
∑th_ªc_com∂ëi⁄
,

923 
∑th
, &∑th->
quîy
);

924 i‡(
∑th
->
quîy_id
 < 0) {

925 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

926 
∑th
->
quîy
 = 
NULL
;

927 
	`com∂ëe
(&
∑th
->
d⁄e
);

928  
∑th
->
quîy_id
;

932 
	}
}

934 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

935 
√t_devi˚
 *
dev
)

937 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

938 
ùoib_∑th
 *
∑th
;

939 
Êags
;

941 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

943 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

944 i‡(!
∑th
)

945 
out
;

946 i‡(!
∑th
->
quîy
)

947 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

948 
out
:

949 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

950 
	}
}

952 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

953 
√t_devi˚
 *
dev
)

955 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

956 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

957 
ùoib_∑th
 *
∑th
;

958 
ùoib_√igh
 *
√igh
;

959 
Êags
;

961 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

962 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

963 i‡(!
√igh
) {

964 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

965 ++
dev
->
°©s
.
tx_dr›≥d
;

966 
	`dev_k‰ì_skb_™y
(
skb
);

967  
NULL
;

973 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

974 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

975  
√igh
;

978 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

979 i‡(!
∑th
) {

980 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

981 i‡(!
∑th
)

982 
îr_∑th
;

984 
	`__∑th_add
(
dev
, 
∑th
);

987 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

989 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

990 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

991 
√igh
->
ah
 = 
∑th
->ah;

993 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

994 i‡(!
	`ùoib_cm_gë
(
√igh
))

995 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

996 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

997 
	`ùoib_√igh_‰ì
(
√igh
);

998 
îr_dr›
;

1000 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

1001 
IPOIB_MAX_PATH_REC_QUEUE
) {

1002 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1003 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1005 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1006 
	`skb_queue_Àn
(&
√igh
->
queue
));

1007 
îr_dr›
;

1010 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1011 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1012 
	`IPOIB_QPN
(
daddr
));

1013 
	`ùoib_√igh_put
(
√igh
);

1014  
NULL
;

1017 
√igh
->
ah
 = 
NULL
;

1019 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1020 
îr_∑th
;

1021 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1022 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1023 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1025 
îr_dr›
;

1029 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1030 
	`ùoib_√igh_put
(
√igh
);

1031  
NULL
;

1033 
îr_∑th
:

1034 
	`ùoib_√igh_‰ì
(
√igh
);

1035 
îr_dr›
:

1036 ++
dev
->
°©s
.
tx_dr›≥d
;

1037 
	`dev_k‰ì_skb_™y
(
skb
);

1039 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1040 
	`ùoib_√igh_put
(
√igh
);

1042  
NULL
;

1043 
	}
}

1045 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1046 
ùoib_p£udo_hódî
 *
phdr
)

1048 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1049 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1050 
ùoib_∑th
 *
∑th
;

1051 
Êags
;

1053 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1056 i‡(!
¥iv
->
brﬂdˇ°
)

1057 
dr›_™d_u∆ock
;

1059 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1060 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1061 i‡(!
∑th
) {

1062 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1063 i‡(!
∑th
)

1064 
dr›_™d_u∆ock
;

1065 
	`__∑th_add
(
dev
, 
∑th
);

1071 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1073 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1074 
dr›_™d_u∆ock
;

1077 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1078 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1079 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1080 
u∆ock
;

1082 
dr›_™d_u∆ock
;

1086 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1087 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1088 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1089 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1090 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1093 
dr›_™d_u∆ock
:

1094 ++
dev
->
°©s
.
tx_dr›≥d
;

1095 
	`dev_k‰ì_skb_™y
(
skb
);

1096 
u∆ock
:

1097 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1098 
	}
}

1100 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1103 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1104 
ùoib_√igh
 *
√igh
;

1105 
ùoib_p£udo_hódî
 *
phdr
;

1106 
ùoib_hódî
 *
hódî
;

1107 
Êags
;

1109 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1110 
	`skb_puŒ
(
skb
, (*
phdr
));

1111 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1113 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1115 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1116 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1117 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1118 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1119 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1121 ++
dev
->
°©s
.
tx_dr›≥d
;

1122 
	`dev_k‰ì_skb_™y
(
skb
);

1123  
NETDEV_TX_OK
;

1126 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1127 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1129 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1130 i‡(
	`likñy
(
√igh
))

1131 
£nd_usög_√igh
;

1132 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1133  
NETDEV_TX_OK
;

1137 
hódî
->
¥Ÿo
) {

1138 
	`ht⁄s
(
ETH_P_IP
):

1139 
	`ht⁄s
(
ETH_P_IPV6
):

1140 
	`ht⁄s
(
ETH_P_TIPC
):

1141 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1142 i‡(
	`u∆ikñy
(!
√igh
)) {

1143 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1144 i‡(
	`likñy
(!
√igh
))

1145  
NETDEV_TX_OK
;

1148 
	`ht⁄s
(
ETH_P_ARP
):

1149 
	`ht⁄s
(
ETH_P_RARP
):

1151 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1152  
NETDEV_TX_OK
;

1155 ++
dev
->
°©s
.
tx_dr›≥d
;

1156 
	`dev_k‰ì_skb_™y
(
skb
);

1157  
NETDEV_TX_OK
;

1160 
£nd_usög_√igh
:

1162 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1163 i‡(
	`ùoib_cm_up
(
√igh
)) {

1164 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1165 
uƒef
;

1167 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1168 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1169 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1170 
uƒef
;

1171 } i‡(
√igh
->
ah
) {

1172 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1175 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1176 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1177 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1178 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1179 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1181 ++
dev
->
°©s
.
tx_dr›≥d
;

1182 
	`dev_k‰ì_skb_™y
(
skb
);

1185 
uƒef
:

1186 
	`ùoib_√igh_put
(
√igh
);

1188  
NETDEV_TX_OK
;

1189 
	}
}

1191 
	$ùoib_timeout
(
√t_devi˚
 *
dev
, 
txqueue
)

1193 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1195 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1196 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1197 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1198 
	`√tif_queue_°›≥d
(
dev
),

1199 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1201 
	}
}

1203 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1204 
√t_devi˚
 *
dev
,

1205 
ty≥
,

1206 c⁄° *
daddr
,

1207 c⁄° *
ßddr
,

1208 
Àn
)

1210 
ùoib_hódî
 *
hódî
;

1212 
hódî
 = 
	`skb_push
(
skb
, (*header));

1214 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1215 
hódî
->
ª£rved
 = 0;

1222 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1224  
IPOIB_HARD_LEN
;

1225 
	}
}

1227 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1229 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1231 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1232 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1236 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1237 
	}
}

1239 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1241 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1244 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1245  
dev
->
ifödex
;

1248  
¥iv
->
∑ª¡
->
ifödex
;

1249 
	}
}

1251 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1260 
u32
 *
d32
 = (u32 *Ë
daddr
;

1261 
u32
 
hv
;

1263 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1264  
hv
 & 
htbl
->
mask
;

1265 
	}
}

1267 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1269 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1270 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1271 
ùoib_√igh_hash
 *
htbl
;

1272 
ùoib_√igh
 *
√igh
 = 
NULL
;

1273 
u32
 
hash_vÆ
;

1275 
	`rcu_ªad_lock_bh
();

1277 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1279 i‡(!
htbl
)

1280 
out_u∆ock
;

1282 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1283 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1284 
√igh
 !
NULL
;

1285 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1286 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1288 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1290 
√igh
 = 
NULL
;

1291 
out_u∆ock
;

1294 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1295 
√igh
->
Æive
 = 
jiffõs
;

1296 
out_u∆ock
;

1300 
out_u∆ock
:

1301 
	`rcu_ªad_u∆ock_bh
();

1302  
√igh
;

1303 
	}
}

1305 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1307 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1308 
ùoib_√igh_hash
 *
htbl
;

1309 
√igh_obsﬁëe
;

1310 
dt
;

1311 
Êags
;

1312 
i
;

1313 
	`LIST_HEAD
(
ªmove_li°
);

1315 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1317 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1318 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1320 i‡(!
htbl
)

1321 
out_u∆ock
;

1324 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1325 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1327 
i
 = 0; i < 
htbl
->
size
; i++) {

1328 
ùoib_√igh
 *
√igh
;

1329 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1331 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1332 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1334 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1336 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1338 
	`rcu_assign_poöãr
(*
≈
,

1339 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1340 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1342 
	`li°_dñ_öô
(&
√igh
->
li°
);

1343 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1345 
≈
 = &
√igh
->
h√xt
;

1351 
out_u∆ock
:

1352 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1353 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1354 
	}
}

1356 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1358 
ùoib_dev_¥iv
 *
¥iv
 =

1359 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1361 
	`__ùoib_ª≠_√igh
(
¥iv
);

1363 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1364 
¨p_tbl
.
gc_öãrvÆ
);

1365 
	}
}

1368 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1369 
√t_devi˚
 *
dev
)

1371 
ùoib_√igh
 *
√igh
;

1373 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1374 i‡(!
√igh
)

1375  
NULL
;

1377 
√igh
->
dev
 = dev;

1378 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1379 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1380 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1381 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1383 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1385  
√igh
;

1386 
	}
}

1388 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1389 
√t_devi˚
 *
dev
)

1391 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1392 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1393 
ùoib_√igh_hash
 *
htbl
;

1394 
ùoib_√igh
 *
√igh
;

1395 
u32
 
hash_vÆ
;

1397 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1398 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1399 i‡(!
htbl
) {

1400 
√igh
 = 
NULL
;

1401 
out_u∆ock
;

1407 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1408 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1409 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1410 
√igh
 !
NULL
;

1411 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1412 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1413 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1415 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1417 
√igh
 = 
NULL
;

1420 
√igh
->
Æive
 = 
jiffõs
;

1421 
out_u∆ock
;

1425 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1426 i‡(!
√igh
)

1427 
out_u∆ock
;

1430 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1431 
√igh
->
Æive
 = 
jiffõs
;

1433 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1434 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1435 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1436 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1437 
	`©omic_öc
(&
¡bl
->
íåõs
);

1439 
out_u∆ock
:

1441  
√igh
;

1442 
	}
}

1444 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1447 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1448 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1449 
sk_buff
 *
skb
;

1450 i‡(
√igh
->
ah
)

1451 
	`ùoib_put_ah
(
√igh
->
ah
);

1452 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1453 ++
dev
->
°©s
.
tx_dr›≥d
;

1454 
	`dev_k‰ì_skb_™y
(
skb
);

1456 i‡(
	`ùoib_cm_gë
(
√igh
))

1457 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1458 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1460 
	`IPOIB_QPN
(
√igh
->
daddr
),

1461 
√igh
->
daddr
 + 4);

1462 
	`k‰ì
(
√igh
);

1463 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1464 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1465 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1467 
	}
}

1469 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1472 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1474 
	`ùoib_√igh_put
(
√igh
);

1475 
	}
}

1477 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1479 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1481 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1482 
ùoib_√igh_hash
 *
htbl
;

1483 
ùoib_√igh
 
__rcu
 **
≈
;

1484 
ùoib_√igh
 *
n
;

1485 
u32
 
hash_vÆ
;

1487 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1488 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1489 i‡(!
htbl
)

1492 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1493 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1494 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1495 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1496 
n
 !
NULL
;

1497 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1498 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1499 i‡(
n
 =
√igh
) {

1501 
	`rcu_assign_poöãr
(*
≈
,

1502 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1503 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1505 
	`li°_dñ_öô
(&
√igh
->
li°
);

1506 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1509 
≈
 = &
n
->
h√xt
;

1512 
	}
}

1514 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1516 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1517 
ùoib_√igh_hash
 *
htbl
;

1518 
ùoib_√igh
 
__rcu
 **
buckës
;

1519 
u32
 
size
;

1521 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1522 
¡bl
->
htbl
 = 
NULL
;

1523 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1524 i‡(!
htbl
)

1525  -
ENOMEM
;

1526 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1527 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1528 i‡(!
buckës
) {

1529 
	`k‰ì
(
htbl
);

1530  -
ENOMEM
;

1532 
htbl
->
size
 = size;

1533 
htbl
->
mask
 = (
size
 - 1);

1534 
htbl
->
buckës
 = buckets;

1535 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1536 
htbl
->
¡bl
 =Çtbl;

1537 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1540 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1541 
¨p_tbl
.
gc_öãrvÆ
);

1544 
	}
}

1546 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1548 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1549 
ùoib_√igh_hash
,

1550 
rcu
);

1551 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1552 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1554 
	`kv‰ì
(
buckës
);

1555 
	`k‰ì
(
htbl
);

1556 
	`com∂ëe
(&
¡bl
->
dñëed
);

1557 
	}
}

1559 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1562 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1563 
ùoib_√igh_hash
 *
htbl
;

1564 
Êags
;

1565 
i
;

1568 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1570 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1571 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1573 i‡(!
htbl
)

1574 
out_u∆ock
;

1576 
i
 = 0; i < 
htbl
->
size
; i++) {

1577 
ùoib_√igh
 *
√igh
;

1578 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1580 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1581 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1583 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1584 
	`rcu_assign_poöãr
(*
≈
,

1585 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1586 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1588 
	`li°_dñ_öô
(&
√igh
->
li°
);

1589 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1591 
≈
 = &
√igh
->
h√xt
;

1596 
out_u∆ock
:

1597 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1598 
	}
}

1600 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1602 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1603 
ùoib_√igh_hash
 *
htbl
;

1604 
Êags
;

1605 
i
, 
waô_Êushed
 = 0;

1607 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1608 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1610 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1612 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1613 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1614 i‡(!
htbl
)

1615 
out_u∆ock
;

1617 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1618 i‡(!
waô_Êushed
)

1619 
‰ì_htbl
;

1621 
i
 = 0; i < 
htbl
->
size
; i++) {

1622 
ùoib_√igh
 *
√igh
;

1623 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1625 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1626 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1627 
	`rcu_assign_poöãr
(*
≈
,

1628 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1629 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1631 
	`li°_dñ_öô
(&
√igh
->
li°
);

1632 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1636 
‰ì_htbl
:

1637 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1638 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1640 
out_u∆ock
:

1641 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1642 i‡(
waô_Êushed
)

1643 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1644 
	}
}

1646 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1648 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1650 
	`ùoib_dbg
(
¥iv
, "%s\n", 
__func__
);

1651 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1653 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1655 
	`ùoib_Êush_√ighs
(
¥iv
);

1657 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1658 
	}
}

1660 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1662 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1664 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1665 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1666 
	}
}

1668 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1672 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1673 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1674 
	}
}

1676 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1678 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1680 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1682 
	`ùoib_«pi_dñ
(
dev
);

1684 
	`ùoib_cm_dev_˛ónup
(
dev
);

1686 
	`k‰ì
(
¥iv
->
rx_rög
);

1687 
	`v‰ì
(
¥iv
->
tx_rög
);

1689 
¥iv
->
rx_rög
 = 
NULL
;

1690 
¥iv
->
tx_rög
 = 
NULL
;

1691 
	}
}

1693 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1695 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1697 
	`ùoib_«pi_add
(
dev
);

1700 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1701 (*
¥iv
->
rx_rög
),

1702 
GFP_KERNEL
);

1703 i‡(!
¥iv
->
rx_rög
)

1704 
out
;

1706 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1707 (*
¥iv
->
tx_rög
)));

1708 i‡(!
¥iv
->
tx_rög
) {

1709 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1710 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1711 
out_rx_rög_˛ónup
;

1716 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1717 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1718 
¥iv
->
ˇ
->
«me
);

1719 
out_tx_rög_˛ónup
;

1723 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1724 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1725 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1729 
out_tx_rög_˛ónup
:

1730 
	`v‰ì
(
¥iv
->
tx_rög
);

1732 
out_rx_rög_˛ónup
:

1733 
	`k‰ì
(
¥iv
->
rx_rög
);

1735 
out
:

1736 
	`ùoib_«pi_dñ
(
dev
);

1737  -
ENOMEM
;

1738 
	}
}

1740 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1741 
cmd
)

1743 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1745 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1746  -
EOPNOTSUPP
;

1748  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1749 
	}
}

1751 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1753 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1754 
ªt
 = -
ENOMEM
;

1756 
¥iv
->
qp
 = 
NULL
;

1762 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1763 i‡(!
¥iv
->
wq
) {

1764 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1765 
out
;

1769 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1770 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1771 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1772 
˛ón_wq
;

1775 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1776 i‡(
ªt
) {

1777 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1778 
out_‰ì_pd
;

1781 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1782 i‡(
ªt
) {

1783 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1784 
out_dev_unöô
;

1787 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1788 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1789 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1790 
ªt
 = -
ENODEV
;

1791 
out_hash_unöô
;

1797 
out_hash_unöô
:

1798 
	`ùoib_√igh_hash_unöô
(
dev
);

1800 
out_dev_unöô
:

1801 
	`ùoib_ib_dev_˛ónup
(
dev
);

1803 
out_‰ì_pd
:

1804 i‡(
¥iv
->
pd
) {

1805 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1806 
¥iv
->
pd
 = 
NULL
;

1809 
˛ón_wq
:

1810 i‡(
¥iv
->
wq
) {

1811 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1812 
¥iv
->
wq
 = 
NULL
;

1815 
out
:

1816  
ªt
;

1817 
	}
}

1823 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1825 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1831 
	`π∆_lock
();

1832 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
, 
NULL
);

1833 
	`π∆_u∆ock
();

1836 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1842 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1843 
	}
}

1845 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1847 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1849 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1850 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1852 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1853 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1855 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1857 
	}
}

1859 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1861 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1862 
ib_p‹t_©å
 
©å
;

1863 
ªsu…
;

1865 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1866 i‡(
ªsu…
) {

1867 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1868 
¥iv
->
p‹t
);

1869  
ªsu…
;

1871 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1873 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1874 i‡(
ªsu…
) {

1875 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1876 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1877  
ªsu…
;

1880 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1881 i‡(
ªsu…
) {

1882 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1883 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1884  
ªsu…
;

1886 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1887 (
ib_gid
));

1889 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1890 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1892 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1895 
	}
}

1897 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1899 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1900 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1902 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1903 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1904 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1905 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1906 
	}
}

1908 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1910 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1911 
rdma_√tdev
 *
∫
;

1912 
rc
;

1914 i‡(
¥iv
->
∑ª¡
) {

1915 
	`ùoib_chûd_öô
(
ndev
);

1917 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1918 i‡(
rc
)

1919  
rc
;

1923 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1924 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1925 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1926 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1927 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1929 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1935 
¥iv
->
pkey
 |= 0x8000;

1937 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1938 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1939 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1941 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1943 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1944 i‡(
rc
) {

1945 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1946 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1947  
rc
;

1950 i‡(
¥iv
->
∑ª¡
) {

1951 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1953 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1955 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1956 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1957 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1961 
	}
}

1963 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1965 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1967 
	`ASSERT_RTNL
();

1973 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1975 i‡(
¥iv
->
∑ª¡
) {

1976 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1978 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1979 
	`li°_dñ
(&
¥iv
->
li°
);

1980 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1983 
	`ùoib_√igh_hash_unöô
(
dev
);

1985 
	`ùoib_ib_dev_˛ónup
(
dev
);

1988 i‡(
¥iv
->
wq
) {

1990 
	`WARN_ON
(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
));

1991 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1992 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1993 
¥iv
->
wq
 = 
NULL
;

1996 i‡(
¥iv
->
∑ª¡
)

1997 
	`dev_put
(
¥iv
->
∑ª¡
);

1998 
	}
}

2000 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

2002 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2004  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2005 
	}
}

2007 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2008 
iÊa_vf_öfo
 *
ivf
)

2010 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2011 
îr
;

2013 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2014 i‡(
îr
)

2015  
îr
;

2017 
ivf
->
vf
 = vf;

2018 
	`mem˝y
(
ivf
->
mac
, 
dev
->
dev_addr
, dev->
addr_Àn
);

2021 
	}
}

2023 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2025 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2027 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2028  -
EINVAL
;

2030  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2031 
	}
}

2033 
	$ùoib_gë_vf_guid
(
√t_devi˚
 *
dev
, 
vf
,

2034 
iÊa_vf_guid
 *
node_guid
,

2035 
iÊa_vf_guid
 *
p‹t_guid
)

2037 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2039  
	`ib_gë_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
node_guid
, 
p‹t_guid
);

2040 
	}
}

2042 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2043 
iÊa_vf_°©s
 *
vf_°©s
)

2045 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2047  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2048 
	}
}

2050 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2051 .
¸óã
 = 
ùoib_h¨d_hódî
,

2054 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2055 .
ndo_öô
 = 
ùoib_ndo_öô
,

2056 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2057 .
	gndo_›í
 = 
ùoib_›í
,

2058 .
	gndo_°›
 = 
ùoib_°›
,

2059 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2060 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2061 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2062 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2063 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2064 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2065 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2066 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2067 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2068 .
	gndo_gë_vf_guid
 = 
ùoib_gë_vf_guid
,

2069 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2070 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2071 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2072 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2075 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2076 .
ndo_öô
 = 
ùoib_ndo_öô
,

2077 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2078 .
	gndo_›í
 = 
ùoib_›í
,

2079 .
	gndo_°›
 = 
ùoib_°›
,

2080 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2081 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2082 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2083 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2084 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2085 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2086 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2087 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2090 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2091 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2092 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2093 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2094 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2097 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2099 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2100 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2102 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2104 
dev
->
w©chdog_timeo
 = 
HZ
;

2106 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2108 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2109 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2110 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2111 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2112 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2113 
NETIF_F_HIGHDMA
);

2114 
	`√tif_kìp_d°
(
dev
);

2116 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2123 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2124 
	}
}

2126 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2128 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2130 
¥iv
->
dev
 = dev;

2131 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2132 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2133 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2135 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2136 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2137 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2138 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2140 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2141 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2142 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2143 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2144 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2145 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2146 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2147 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2148 
	}
}

2150 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2151 c⁄° *
«me
)

2153 
√t_devi˚
 *
dev
;

2155 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2156 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2157 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2158  
dev
;

2160 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2161 
ùoib_£tup_comm⁄
);

2162 i‡(!
dev
)

2163  
	`ERR_PTR
(-
ENOMEM
);

2164  
dev
;

2165 
	}
}

2167 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2168 
√t_devi˚
 *
dev
)

2170 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2171 
ùoib_dev_¥iv
 *
¥iv
;

2172 
rc
;

2174 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2175 i‡(!
¥iv
)

2176  -
ENOMEM
;

2178 
¥iv
->
ˇ
 = 
hˇ
;

2179 
¥iv
->
p‹t
 =Öort;

2181 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2182 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2183 i‡(
rc
) {

2184 i‡(
rc
 !-
EOPNOTSUPP
)

2185 
out
;

2187 
∫
->
£nd
 = 
ùoib_£nd
;

2188 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2189 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2190 
∫
->
hˇ
 = hca;

2193 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2195 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2196 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2198 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2200 
∫
->
˛¡_¥iv
 = 
¥iv
;

2206 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2207 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2209 
	`ùoib_buûd_¥iv
(
dev
);

2213 
out
:

2214 
	`k‰ì
(
¥iv
);

2215  
rc
;

2216 
	}
}

2218 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2219 c⁄° *
«me
)

2221 
√t_devi˚
 *
dev
;

2222 
rc
;

2224 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2225 i‡(
	`IS_ERR
(
dev
))

2226  
dev
;

2228 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2229 i‡(
rc
) {

2230 
	`‰ì_√tdev
(
dev
);

2231  
	`ERR_PTR
(
rc
);

2239  
dev
;

2240 
	}
}

2242 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2244 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2245 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2247 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2248 i‡(
dev
->
¥iv_de°ru˘‹
)

2249 
dev
->
	`¥iv_de°ru˘‹
(dev);

2255 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2258 
∫
->
˛¡_¥iv
 = 
NULL
;

2260 
	`k‰ì
(
¥iv
);

2261 
	}
}

2263 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2264 
devi˚_©åibuã
 *
©å
, *
buf
)

2266 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2267 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2269  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2270 
	}
}

2271 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2273 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2274 
devi˚_©åibuã
 *
©å
, *
buf
)

2276 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2279  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2280 
	}
}

2282 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2284 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2286 i‡(
umˇ°_vÆ
 > 0) {

2287 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2288 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2291 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2292 
	}
}

2294 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2295 
devi˚_©åibuã
 *
©å
,

2296 c⁄° *
buf
, 
size_t
 
cou¡
)

2298 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2300 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2302  
cou¡
;

2303 
	}
}

2304 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2306 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2308  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2309 
	}
}

2311 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2313 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2314 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2316 
	`√tif_addr_lock_bh
(
√tdev
);

2318 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2319 &
gid
->
globÆ
.
öãrÁ˚_id
,

2320 (
gid
->
globÆ
.
öãrÁ˚_id
));

2321 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2322 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2324 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2326 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2327 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2328 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2329 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2330 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2332 
	}
}

2334 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2335 
sockaddr_°‹age
 *
ss
)

2337 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2338 
ªt
 = 0;

2340 
	`√tif_addr_lock_bh
(
dev
);

2345 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2346 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2347 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2348 
ªt
 = -
EINVAL
;

2350 
	`√tif_addr_u∆ock_bh
(
dev
);

2352  
ªt
;

2353 
	}
}

2355 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2357 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2358 
sockaddr_°‹age
 *
ss
 = 
addr
;

2359 
ªt
;

2361 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2362  -
EBUSY
;

2364 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2365 i‡(
ªt
)

2366  
ªt
;

2368 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2370 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2373 
	}
}

2375 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2376 
devi˚_©åibuã
 *
©å
,

2377 c⁄° *
buf
, 
size_t
 
cou¡
)

2379 
pkey
;

2380 
ªt
;

2382 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2383  -
EINVAL
;

2385 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2386  -
EINVAL
;

2388 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2390  
ªt
 ?Ñë : 
cou¡
;

2391 
	}
}

2392 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2394 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2395 
devi˚_©åibuã
 *
©å
,

2396 c⁄° *
buf
, 
size_t
 
cou¡
)

2398 
pkey
;

2399 
ªt
;

2401 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2402  -
EINVAL
;

2404 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2405  -
EINVAL
;

2407 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2409  
ªt
 ?Ñë : 
cou¡
;

2411 
	}
}

2412 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2414 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2416  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2417 
	}
}

2428 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2429 
devi˚_©åibuã
 *
©å
, *
buf
)

2431 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2444 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2445 
	`√tdev_öfo_⁄˚
(
ndev
,

2447 
cuºít
->
comm
);

2449  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2450 
	}
}

2451 
DEVICE_ATTR_RO
(
dev_id
);

2453 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2455 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2456  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2457 
	}
}

2459 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2460 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2462 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2463 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2464 
ùoib_dev_¥iv
 *
¥iv
;

2465 
√t_devi˚
 *
ndev
;

2466 
ªsu…
;

2468 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2469 i‡(
	`IS_ERR
(
ndev
)) {

2470 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2471 
	`PTR_ERR
(
ndev
));

2472  
ndev
;

2474 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2476 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2477 
¥iv
->
ˇ
, 
ùoib_evít
);

2478 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2481 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2483 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2484 i‡(
ªsu…
) {

2485 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2486 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2488 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2489 
	`ùoib_ötf_‰ì
(
ndev
);

2490 
	`‰ì_√tdev
(
ndev
);

2492  
	`ERR_PTR
(
ªsu…
);

2495 i‡(
hˇ
->
›s
.
rdma_√tdev_gë_∑øms
) {

2496 
rc
 = 
hˇ
->
›s
.
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2497 
RDMA_NETDEV_IPOIB
,

2498 &
∑øms
);

2500 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2501 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2509 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2511 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2512 
sysfs_Áûed
;

2513 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2514 
sysfs_Áûed
;

2515 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2516 
sysfs_Áûed
;

2517 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2518 
sysfs_Áûed
;

2519 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2520 
sysfs_Áûed
;

2521 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2522 
sysfs_Áûed
;

2524  
ndev
;

2526 
sysfs_Áûed
:

2527 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2528 
	`uƒegi°î_√tdev
(
ndev
);

2529  
	`ERR_PTR
(-
ENOMEM
);

2530 
	}
}

2532 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2534 
li°_hód
 *
dev_li°
;

2535 
√t_devi˚
 *
dev
;

2536 
ùoib_dev_¥iv
 *
¥iv
;

2537 
p
;

2538 
cou¡
 = 0;

2540 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2541 i‡(!
dev_li°
)

2544 
	`INIT_LIST_HEAD
(
dev_li°
);

2546 
	`rdma_f‹_óch_p‹t
 (
devi˚
, 
p
) {

2547 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2549 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2550 i‡(!
	`IS_ERR
(
dev
)) {

2551 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2552 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2553 
cou¡
++;

2557 i‡(!
cou¡
) {

2558 
	`k‰ì
(
dev_li°
);

2562 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2563 
	}
}

2565 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2567 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2568 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2570 i‡(!
dev_li°
)

2573 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2574 
	`LIST_HEAD
(
hód
);

2575 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2577 
	`π∆_lock
();

2579 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2580 
li°
)

2581 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2582 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2583 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2585 
	`π∆_u∆ock
();

2588 
	`k‰ì
(
dev_li°
);

2589 
	}
}

2591 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2592 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2593 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2597 
__öô
 
	$ùoib_öô_moduÀ
()

2599 
ªt
;

2601 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2602 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2603 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2605 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2606 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2607 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2608 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2609 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2610 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2617 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2619 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2621 
	`ùoib_ªgi°î_debugfs
();

2633 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2634 i‡(!
ùoib_w‹kqueue
) {

2635 
ªt
 = -
ENOMEM
;

2636 
îr_fs
;

2639 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2641 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2642 i‡(
ªt
)

2643 
îr_ß
;

2645 
ªt
 = 
	`ùoib_√éök_öô
();

2646 i‡(
ªt
)

2647 
îr_˛õ¡
;

2649 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2650 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2654 
îr_˛õ¡
:

2655 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2657 
îr_ß
:

2658 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2659 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2661 
îr_fs
:

2662 
	`ùoib_uƒegi°î_debugfs
();

2664  
ªt
;

2665 
	}
}

2667 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2669 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2670 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2672 
	`ùoib_√éök_föi
();

2673 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2674 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2675 
	`ùoib_uƒegi°î_debugfs
();

2676 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2677 
	}
}

2679 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2680 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@RHEL83/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
	`¥ötk
("ipoib_mcast_join_finish:Öriv->broadcast->mcmember.mtu %uÑn->mtu %uÖriv->mcast_mtu %uÖriv->admin_mtu %u\n",

260 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
, 
∫
->mtu,Öriv->
mˇ°_mtu
,Öriv->
admö_mtu
);

261 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

262 
£t_qkey
 = 1;

265 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

266 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

267 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

268 
mˇ°
->
mcmembî
.
mgid
.
øw
);

273 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

274 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

275 
£t_qkey
, 
¥iv
->
qkey
);

276 i‡(
ªt
 < 0) {

277 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

278 
mˇ°
->
mcmembî
.
mgid
.
øw
);

280 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

281  
ªt
;

285 
	`mem£t
(&
av
, 0, (av));

286 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

287 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

288 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

289 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

290 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

292 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

293 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

294 0, 
mˇ°
->
mcmembî
.
h›_limô
,

295 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

297 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

298 i‡(
	`IS_ERR
(
ah
)) {

299 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

300 -
	`PTR_ERR
(
ah
));

302  
	`PTR_ERR
(
ah
);

304 
	`•ö_lock_úq
(&
¥iv
->
lock
);

305 
mˇ°
->
ah
 =áh;

306 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

308 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

309 
mˇ°
->
mcmembî
.
mgid
.
øw
,

310 
mˇ°
->
ah
->ah,

311 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

312 
mˇ°
->
mcmembî
.
¶
);

315 
	`√tif_tx_lock_bh
(
dev
);

316 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

317 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

319 
	`√tif_tx_u∆ock_bh
(
dev
);

321 
skb
->
dev
 = dev;

323 
ªt
 = 
	`dev_queue_xmô
(
skb
);

324 i‡(
ªt
)

325 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

326 
__func__
, 
ªt
);

327 
	`√tif_tx_lock_bh
(
dev
);

329 
	`√tif_tx_u∆ock_bh
(
dev
);

332 
	}
}

334 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

336 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

337 
ˇºõr_⁄_èsk
);

338 
ib_p‹t_©å
 
©å
;

340 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

341 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

342 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

351 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

352 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

353 
¥iv
->
ˇ
,Öriv->
p‹t
);

363 !
	`π∆_åylock
()) {

364 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

367 
	`m¶ìp
(20);

369 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

370 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

371 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

372 
	`π∆_u∆ock
();

373 
	}
}

375 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

376 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

378 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

379 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

380 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

382 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

383 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

385 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

388 i‡(
°©us
 =-
ENETRESET
) {

389 
°©us
 = 0;

390 
out
;

393 i‡(!
°©us
)

394 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

396 i‡(!
°©us
) {

397 
mˇ°
->
backoff
 = 1;

398 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

407 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

408 
	`•ö_lock_úq
(&
¥iv
->
lock
);

409 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

410 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

411 
out_locked
;

414 
boﬁ
 
sûít_Áû
 =

415 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

416 
°©us
 =-
EINVAL
;

418 i‡(
mˇ°
->
logcou¡
 < 20) {

419 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

420 
sûít_Áû
) {

421 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

422 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

423 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

425 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

426 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

427 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

430 i‡(!
sûít_Áû
)

431 
mˇ°
->
logcou¡
++;

434 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

435 
mˇ°
->
backoff
 >= 2) {

445 
mˇ°
->
backoff
 = 1;

446 
	`√tif_tx_lock_bh
(
dev
);

447 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

448 ++
dev
->
°©s
.
tx_dr›≥d
;

449 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

451 
	`√tif_tx_u∆ock_bh
(
dev
);

453 
	`•ö_lock_úq
(&
¥iv
->
lock
);

455 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

456 
out_locked
;

459 
out
:

460 
	`•ö_lock_úq
(&
¥iv
->
lock
);

461 
out_locked
:

466 i‡(
°©us
)

467 
mˇ°
->
mc
 = 
NULL
;

469 
mˇ°
->
mc
 = 
mu…iˇ°
;

470 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

471 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

472 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

474  
°©us
;

475 
	}
}

480 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

482 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

483 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

484 
ib_ß_mcmembî_ªc
 
ªc
 = {

485 .
joö_°©e
 = 1

487 
ib_ß_comp_mask
 
comp_mask
;

488 
ªt
 = 0;

490 i‡(!
¥iv
->
brﬂdˇ°
 ||

491 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

492  -
EINVAL
;

494 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

495 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

497 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

499 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

500 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

501 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

503 
comp_mask
 =

504 
IB_SA_MCMEMBER_REC_MGID
 |

505 
IB_SA_MCMEMBER_REC_PORT_GID
 |

506 
IB_SA_MCMEMBER_REC_PKEY
 |

507 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

509 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

517 
comp_mask
 |=

518 
IB_SA_MCMEMBER_REC_QKEY
 |

519 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

520 
IB_SA_MCMEMBER_REC_MTU
 |

521 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

522 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

523 
IB_SA_MCMEMBER_REC_RATE
 |

524 
IB_SA_MCMEMBER_REC_SL
 |

525 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

526 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

528 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

529 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

530 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

531 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

532 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

533 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

534 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

535 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

536 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

549 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

550 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

552 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

554 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

556 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

557 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

558 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

559 
	`•ö_lock_úq
(&
¥iv
->
lock
);

560 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

561 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

562 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

564 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

565 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

566 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

567 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

568 
	`•ö_lock_úq
(&
¥iv
->
lock
);

571 
	}
}

573 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

575 
ùoib_dev_¥iv
 *
¥iv
 =

576 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

577 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

578 
ib_p‹t_©å
 
p‹t_©å
;

579 
dñay_u¡û
 = 0;

580 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

582 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

585 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

586 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

589 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

590 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

591 
p‹t_©å
.
°©e
);

594 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

595 
	`√tif_addr_lock_bh
(
dev
);

597 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

598 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`√tif_addr_u∆ock_bh
(
dev
);

603 
	`•ö_lock_úq
(&
¥iv
->
lock
);

604 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

605 
out
;

607 i‡(!
¥iv
->
brﬂdˇ°
) {

608 
ùoib_mˇ°
 *
brﬂdˇ°
;

610 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

611 i‡(!
brﬂdˇ°
) {

612 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

619 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

620 
out
;

623 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

624  (
ib_gid
));

625 
¥iv
->
brﬂdˇ°
 = broadcast;

627 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

630 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

632 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

633 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

634 i‡(
mˇ°
->
backoff
 > 1 &&

635 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

636 
dñay_u¡û
 = 
mˇ°
->delay_until;

637 
mˇ°
 = 
NULL
;

640 
out
;

647 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

648 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

649 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

650 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

651 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

652 i‡(
mˇ°
->
backoff
 == 1 ||

653 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

655 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

656 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

659 } i‡(!
dñay_u¡û
 ||

660 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

661 
dñay_u¡û
 = 
mˇ°
->delay_until;

665 
mˇ°
 = 
NULL
;

666 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

668 
out
:

669 i‡(
dñay_u¡û
) {

670 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

671 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

672 
dñay_u¡û
 - 
jiffõs
);

674 i‡(
mˇ°
)

675 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

677 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

678 
	}
}

680 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

682 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

683 
Êags
;

685 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

687 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

688 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

689 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

690 
	}
}

692 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

694 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

696 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

698 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

701 
	}
}

703 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

705 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

706 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

707 
ªt
 = 0;

709 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

710 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

712 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

713 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

715 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

716 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

717 
mˇ°
->
mcmembî
.
mgid
.
øw
);

720 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

721 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

722 i‡(
ªt
)

723 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

724 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

725 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

729 
	}
}

735 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

736 
li°_hód
 *
ªmove_li°
)

739 i‡(*
mgid
 == 0xff) {

740 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

742 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

743 
	`li°_dñ
(&
mˇ°
->
li°
);

744 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

745 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

748 
	}
}

750 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

752 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

758 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

759 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

760 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

762 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

763 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

764 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

766 
	}
}

768 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

770 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

771 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

772 
ùoib_mˇ°
 *
mˇ°
;

773 
Êags
;

774 *
mgid
 = 
daddr
 + 4;

776 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

778 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

779 !
¥iv
->
brﬂdˇ°
 ||

780 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

781 ++
dev
->
°©s
.
tx_dr›≥d
;

782 
	`dev_k‰ì_skb_™y
(
skb
);

783 
u∆ock
;

786 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

787 i‡(!
mˇ°
 || !mˇ°->
ah
) {

788 i‡(!
mˇ°
) {

790 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

791 
mgid
);

793 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

794 i‡(!
mˇ°
) {

795 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

797 ++
dev
->
°©s
.
tx_dr›≥d
;

798 
	`dev_k‰ì_skb_™y
(
skb
);

799 
u∆ock
;

802 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

803 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

804  (
ib_gid
));

805 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

806 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

808 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

810 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

811 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

813 ++
dev
->
°©s
.
tx_dr›≥d
;

814 
	`dev_k‰ì_skb_™y
(
skb
);

816 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

817 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

820 
ùoib_√igh
 *
√igh
;

822 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

823 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

824 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

825 i‡(!
√igh
) {

826 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

830 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

831 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

832 
√igh
->
ah
 = 
mˇ°
->ah;

833 
√igh
->
ah
->
vÆid
 = 1;

834 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

837 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

838 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

839 
IB_MULTICAST_QPN
);

840 i‡(
√igh
)

841 
	`ùoib_√igh_put
(
√igh
);

845 
u∆ock
:

846 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

847 
	}
}

849 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

851 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

852 
	`LIST_HEAD
(
ªmove_li°
);

853 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

854 
Êags
;

856 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

857 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

859 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

861 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

862 
	`li°_dñ
(&
mˇ°
->
li°
);

863 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

864 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

867 i‡(
¥iv
->
brﬂdˇ°
) {

868 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

869 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

870 
¥iv
->
brﬂdˇ°
 = 
NULL
;

873 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

875 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

876 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

877 
	}
}

879 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

882 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

885 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

888 
	}
}

890 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

892 
ùoib_dev_¥iv
 *
¥iv
 =

893 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

894 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

895 
√tdev_hw_addr
 *
ha
;

896 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

897 
	`LIST_HEAD
(
ªmove_li°
);

898 
ib_ß_mcmembî_ªc
 
ªc
;

900 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

907 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

909 
	`√tif_addr_lock_bh
(
dev
);

910 
	`•ö_lock_úq
(&
¥iv
->
lock
);

919 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

920 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

923 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

924 
ib_gid
 
mgid
;

926 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

929 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

931 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

932 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

933 
ùoib_mˇ°
 *
nmˇ°
;

936 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

937 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

938 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

939 
mgid
.
øw
);

944 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

945 
mgid
.
øw
);

947 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

948 i‡(!
nmˇ°
) {

949 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

953 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

955 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

957 i‡(
mˇ°
) {

959 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

961 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

962 &
nmˇ°
->
rb_node
,

963 &
¥iv
->
mu…iˇ°_åì
);

965 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

967 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

970 i‡(
mˇ°
)

971 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

975 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

976 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

977 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

978 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

979 
mˇ°
->
mcmembî
.
mgid
.
øw
);

981 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

984 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

988 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

989 
	`√tif_addr_u∆ock_bh
(
dev
);

991 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

996 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

997 
	`•ö_lock_úq
(&
¥iv
->
lock
);

998 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

999 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1001 
	}
}

1003 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1005 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1007 
ùoib_mˇ°_ôî
 *
ôî
;

1009 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1010 i‡(!
ôî
)

1011  
NULL
;

1013 
ôî
->
dev
 = dev;

1014 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1016 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1017 
	`k‰ì
(
ôî
);

1018  
NULL
;

1021  
ôî
;

1022 
	}
}

1024 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1026 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1027 
rb_node
 *
n
;

1028 
ùoib_mˇ°
 *
mˇ°
;

1029 
ªt
 = 1;

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1033 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1035 
n
) {

1036 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1038 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1039  (
ib_gid
)) < 0) {

1040 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1041 
ôî
->
¸óãd
 = 
mˇ°
->created;

1042 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1043 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1044 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1046 
ªt
 = 0;

1051 
n
 = 
	`rb_√xt
(n);

1054 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1056  
ªt
;

1057 
	}
}

1059 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1060 
ib_gid
 *
mgid
,

1061 *
¸óãd
,

1062 *
queuñí
,

1063 *
com∂ëe
,

1064 *
£nd_⁄ly
)

1066 *
mgid
 = 
ôî
->mgid;

1067 *
¸óãd
 = 
ôî
->created;

1068 *
queuñí
 = 
ôî
->queuelen;

1069 *
com∂ëe
 = 
ôî
->complete;

1070 *
£nd_⁄ly
 = 
ôî
->send_only;

1071 
	}
}

	@RHEL83/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@RHEL83/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

267 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

268 
	}
}

270 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

271 
ib_evít
 *
ªc‹d
)

273 
ùoib_dev_¥iv
 *
¥iv
 =

274 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

276 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

279 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

280 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

282 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

283 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

284 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

285 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

286 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

287 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

288 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

289 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

290 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

291 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

294 
	}
}

	@RHEL83/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@SLES12SP4/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_STOP_NEIGH_GC
 = 11,

96 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

97 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

98 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_FLAG_GOING_DOWN
 = 15,

101 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

103 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

104 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

112 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

113 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

115 
	mMAX_SEND_CQE
 = 64,

116 
	mIPOIB_CM_COPYBREAK
 = 256,

118 
	mIPOIB_NON_CHILD
 = 0,

119 
	mIPOIB_LEGACY_CHILD
 = 1,

120 
	mIPOIB_RTNL_CHILD
 = 2,

123 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

124 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


125 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

127 
	#IPOIB_OP_CM
 (0)

	)

130 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

134 
	sùoib_hódî
 {

135 
__be16
 
	m¥Ÿo
;

136 
u16
 
	mª£rved
;

139 
	sùoib_p£udo_hódî
 {

140 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

143 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

145 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

151 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

152 
	`skb_ª£t_mac_hódî
(
skb
);

153 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

154 
	}
}

156 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

158 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

160  
∫
->
˛¡_¥iv
;

161 
	}
}

164 
	sùoib_mˇ°
 {

165 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

166 
ib_ß_mu…iˇ°
 *
	mmc
;

167 
ùoib_ah
 *
	mah
;

169 
rb_node
 
	mrb_node
;

170 
li°_hód
 
	mli°
;

172 
	m¸óãd
;

173 
	mbackoff
;

174 
	mdñay_u¡û
;

176 
	mÊags
;

177 
	mlogcou¡
;

179 
li°_hód
 
	m√igh_li°
;

181 
sk_buff_hód
 
	mpkt_queue
;

183 
√t_devi˚
 *
	mdev
;

184 
com∂ëi⁄
 
	md⁄e
;

187 
	sùoib_rx_buf
 {

188 
sk_buff
 *
	mskb
;

189 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

192 
	sùoib_tx_buf
 {

193 
sk_buff
 *
	mskb
;

194 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

197 
	sùoib_cm_tx_buf
 {

198 
sk_buff
 *
	mskb
;

199 
u64
 
	mm≠pög
;

202 
	gib_cm_id
;

204 
	sùoib_cm_d©a
 {

205 
__be32
 
	mq≤
;

206 
__be32
 
	mmtu
;

236 
	eùoib_cm_°©e
 {

237 
	mIPOIB_CM_RX_LIVE
,

238 
	mIPOIB_CM_RX_ERROR
,

239 
	mIPOIB_CM_RX_FLUSH


242 
	sùoib_cm_rx
 {

243 
ib_cm_id
 *
	mid
;

244 
ib_qp
 *
	mqp
;

245 
ùoib_cm_rx_buf
 *
	mrx_rög
;

246 
li°_hód
 
	mli°
;

247 
√t_devi˚
 *
	mdev
;

248 
	mjiffõs
;

249 
ùoib_cm_°©e
 
	m°©e
;

250 
	mªcv_cou¡
;

253 
	sùoib_cm_tx
 {

254 
ib_cm_id
 *
	mid
;

255 
ib_qp
 *
	mqp
;

256 
li°_hód
 
	mli°
;

257 
√t_devi˚
 *
	mdev
;

258 
ùoib_√igh
 *
	m√igh
;

259 
ùoib_tx_buf
 *
	mtx_rög
;

260 
	mtx_hód
;

261 
	mtx_èû
;

262 
	mÊags
;

263 
u32
 
	mmtu
;

264 
	mmax_£nd_sge
;

267 
	sùoib_cm_rx_buf
 {

268 
sk_buff
 *
	mskb
;

269 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

272 
	sùoib_cm_dev_¥iv
 {

273 
ib_§q
 *
	m§q
;

274 
ùoib_cm_rx_buf
 *
	m§q_rög
;

275 
ib_cm_id
 *
	mid
;

276 
li°_hód
 
	m∑ssive_ids
;

277 
li°_hód
 
	mrx_îr‹_li°
;

278 
li°_hód
 
	mrx_Êush_li°
;

279 
li°_hód
 
	mrx_døö_li°
;

280 
li°_hód
 
	mrx_ª≠_li°
;

281 
w‹k_°ru˘
 
	m°¨t_èsk
;

282 
w‹k_°ru˘
 
	mª≠_èsk
;

283 
w‹k_°ru˘
 
	mskb_èsk
;

284 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

285 
dñayed_w‹k
 
	m°Æe_èsk
;

286 
sk_buff_hód
 
	mskb_queue
;

287 
li°_hód
 
	m°¨t_li°
;

288 
li°_hód
 
	mª≠_li°
;

289 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

290 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

291 
ib_ªcv_wr
 
	mrx_wr
;

292 
	mn⁄§q_c⁄n_qp
;

293 
	mmax_cm_mtu
;

294 
	mnum_‰ags
;

297 
	sùoib_ëhtoﬁ_°
 {

298 
u16
 
	mcﬂÀs˚_u£cs
;

299 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

302 
	gùoib_√igh_èbÀ
;

304 
	sùoib_√igh_hash
 {

305 
ùoib_√igh_èbÀ
 *
	m¡bl
;

306 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

307 
rcu_hód
 
	mrcu
;

308 
u32
 
	mmask
;

309 
u32
 
	msize
;

312 
	sùoib_√igh_èbÀ
 {

313 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

314 
©omic_t
 
	míåõs
;

315 
com∂ëi⁄
 
	mÊushed
;

316 
com∂ëi⁄
 
	mdñëed
;

319 
	sùoib_qp_°©e_vÆid©e
 {

320 
w‹k_°ru˘
 
	mw‹k
;

321 
ùoib_dev_¥iv
 *
	m¥iv
;

329 
	sùoib_dev_¥iv
 {

330 
•ölock_t
 
	mlock
;

332 
√t_devi˚
 *
	mdev
;

334 
«pi_°ru˘
 
	m£nd_«pi
;

335 
«pi_°ru˘
 
	mªcv_«pi
;

337 
	mÊags
;

339 
rw_£m≠h‹e
 
	mvœn_rw£m
;

340 
muãx
 
	mmˇ°_muãx
;

341 
muãx
 
	msysfs_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

492 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

494 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

495 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

496 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

498 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

499 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

500 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

501 
ùoib_dev_¥iv
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

502 c⁄° *
f‹m©
);

503 
ùoib_ib_tx_timî_func
(
˘x
);

504 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

505 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

506 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

507 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

510 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

511 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

512 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

516 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

518 
ùoib_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
, 
p‹t
);

519 
ùoib_dev_˛ónup
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

537 
ùoib_tx_buf
 *
tx_ªq
)

539 
i
, 
off
;

540 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

541 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

542 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

543 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

545 i‡(
	`skb_hódÀn
(
skb
)) {

546 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

547 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

548 
off
 = 1;

550 
off
 = 0;

552 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

553 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

554 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

556 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

557 
	}
}

559 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


560 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

561 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

562 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

563 
ib_gid
 *
gid
,

564 *
¸óãd
,

565 *
queuñí
,

566 *
com∂ëe
,

567 *
£nd_⁄ly
);

569 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

570 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

571 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

572 
ùoib_∑th
 *
∑th
);

575 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

576 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

577 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
);

579 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

580 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

581 
li°_hód
 *
ªmove_li°
);

583 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

584 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

585 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

587 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

588 
ib_evít
 *
ªc‹d
);

590 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

591 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

594 
u16
 
pkey
, 
chûd_ty≥
);

596 
__öô
 
ùoib_√éök_öô
();

597 
__exô
 
ùoib_√éök_föi
();

599 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

600 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

602 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

604 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

605 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

607 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

608 
ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_devi˚
 *
hˇ
);

610 
	#IPOIB_FLAGS_RC
 0x80

	)

611 
	#IPOIB_FLAGS_UC
 0x40

	)

614 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

616 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


618 
ùoib_max_c⁄n_qp
;

620 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

622 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

623  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

624 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

625 
	}
}

627 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

629 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

630  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

631 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

632 
	}
}

634 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

637  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

638 
	}
}

640 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

642  
√igh
->
cm
;

643 
	}
}

645 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

647 
√igh
->
cm
 = 
tx
;

648 
	}
}

650 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

653  !!
¥iv
->
cm
.
§q
;

654 
	}
}

656 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

659  
¥iv
->
cm
.
max_cm_mtu
;

660 
	}
}

662 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

663 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

664 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

669 
ùoib_√igh
 *
√igh
);

670 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

671 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

672 
mtu
);

673 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

674 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

677 
	gùoib_cm_tx
;

679 
	#ùoib_max_c⁄n_qp
 0

	)

681 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

684 
	}
}

685 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

689 
	}
}

691 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

695 
	}
}

697 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

699  
NULL
;

700 
	}
}

702 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

704 
	}
}

706 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

709 
	}
}

711 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

714 
	}
}

716 
ölöe


717 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

720 
	}
}

722 
ölöe


723 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

726 
	}
}

728 
ölöe


729 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

732 
	}
}

734 
ölöe


735 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

737  -
ENOSYS
;

738 
	}
}

740 
ölöe


741 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

744 
	}
}

746 
ölöe


747 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

748 
ùoib_√igh
 *
√igh
)

750  
NULL
;

751 
	}
}

753 
ölöe


754 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

757 
	}
}

759 
ölöe


760 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

763 
	}
}

765 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

766 
mtu
)

768 
	`dev_k‰ì_skb_™y
(
skb
);

769 
	}
}

771 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

773 
	}
}

775 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

777 
	}
}

780 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


781 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

782 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_ªgi°î_debugfs
();

784 
ùoib_uƒegi°î_debugfs
();

786 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

787 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

789 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

792 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

793 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

794 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

796 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

797 10 * 
HZ
 , \

799 i‡(
	`__øãlimô
(&
_rs
)) \

800 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

801 } 0)

	)

803 
ùoib_£ndq_size
;

804 
ùoib_ªcvq_size
;

806 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

808 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


809 
ùoib_debug_Àvñ
;

811 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

813 i‡(
ùoib_debug_Àvñ
 > 0) \

814 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

815 } 0)

	)

816 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

818 i‡(
mˇ°_debug_Àvñ
 > 0) \

819 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

820 } 0)

	)

822 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

823 dÿ{ (Ë(
¥iv
); } 0)

	)

824 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

825 dÿ{ (Ë(
¥iv
); } 0)

	)

828 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


829 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

831 i‡(
d©a_debug_Àvñ
 > 0) \

832 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

833 } 0)

	)

835 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

836 dÿ{ (Ë(
¥iv
); } 0)

	)

839 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

841 c⁄° 
ùoib_drivî_vîsi⁄
[];

843 
hfi1_max_mtu
;

	@SLES12SP4/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
ib_ªcv_wr
 *
bad_wr
;

98 
i
, 
ªt
;

100 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

102 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

103 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

105 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, &
bad_wr
);

106 i‡(
	`u∆ikñy
(
ªt
)) {

107 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

108 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

109 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

110 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

111 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

114  
ªt
;

115 
	}
}

117 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

118 
ùoib_cm_rx
 *
rx
,

119 
ib_ªcv_wr
 *
wr
,

120 
ib_sge
 *
sge
, 
id
)

122 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

123 
ib_ªcv_wr
 *
bad_wr
;

124 
i
, 
ªt
;

126 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

128 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

129 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

131 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, &
bad_wr
);

132 i‡(
	`u∆ikñy
(
ªt
)) {

133 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

134 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

135 
rx
->
rx_rög
[
id
].
m≠pög
);

136 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

137 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

140  
ªt
;

141 
	}
}

143 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

144 
ùoib_cm_rx_buf
 *
rx_rög
,

145 
id
, 
‰ags
,

146 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

147 
gÂ_t
 
gÂ
)

149 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

150 
sk_buff
 *
skb
;

151 
i
;

153 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

154 i‡(
	`u∆ikñy
(!
skb
))

155  
NULL
;

161 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

163 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

164 
DMA_FROM_DEVICE
);

165 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

166 
	`dev_k‰ì_skb_™y
(
skb
);

167  
NULL
;

170 
i
 = 0; i < 
‰ags
; i++) {

171 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

173 i‡(!
∑ge
)

174 
∑πül_îr‹
;

175 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

177 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

178 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

179 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

180 
∑πül_îr‹
;

183 
rx_rög
[
id
].
skb
 = skb;

184  
skb
;

186 
∑πül_îr‹
:

188 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

190 ; 
i
 > 0; --i)

191 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

193 
	`dev_k‰ì_skb_™y
(
skb
);

194  
NULL
;

195 
	}
}

197 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

198 
ùoib_cm_rx_buf
 *
rx_rög
)

200 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

201 
i
;

203 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

204 i‡(
rx_rög
[
i
].
skb
) {

205 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

206 
rx_rög
[
i
].
m≠pög
);

207 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

210 
	`v‰ì
(
rx_rög
);

211 
	}
}

213 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

215 
ib_£nd_wr
 *
bad_wr
;

216 
ùoib_cm_rx
 *
p
;

220 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

221 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

228 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

229 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

230 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, &
bad_wr
))

231 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

233 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

234 
	}
}

236 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

238 
ùoib_cm_rx
 *
p
 = 
˘x
;

239 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

240 
Êags
;

242 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

245 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

246 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

247 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

248 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

249 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

250 
	}
}

252 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

253 
ùoib_cm_rx
 *
p
)

255 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

256 
ib_qp_öô_©å
 
©å
 = {

257 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

258 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

259 .
ªcv_cq
 = 
¥iv
->recv_cq,

260 .
§q
 = 
¥iv
->
cm
.srq,

261 .
ˇp
.
max_£nd_wr
 = 1,

262 .
ˇp
.
max_£nd_sge
 = 1,

263 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

264 .
qp_ty≥
 = 
IB_QPT_RC
,

265 .
qp_c⁄ãxt
 = 
p
,

268 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

269 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

270 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

273  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

274 
	}
}

276 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

277 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

278 
p¢
)

280 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

281 
ib_qp_©å
 
qp_©å
;

282 
qp_©å_mask
, 
ªt
;

284 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

285 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

286 i‡(
ªt
) {

287 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

288  
ªt
;

290 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

291 i‡(
ªt
) {

292 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

293  
ªt
;

295 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

296 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

297 i‡(
ªt
) {

298 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

299  
ªt
;

301 
qp_©å
.
rq_p¢
 = 
p¢
;

302 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

303 i‡(
ªt
) {

304 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

305  
ªt
;

316 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

317 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

318 i‡(
ªt
) {

319 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

322 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

323 i‡(
ªt
) {

324 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

329 
	}
}

331 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

332 
ib_ªcv_wr
 *
wr
,

333 
ib_sge
 *
sge
)

335 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

336 
i
;

338 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

339 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

341 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

342 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

343 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

345 
wr
->
√xt
 = 
NULL
;

346 
wr
->
sg_li°
 = 
sge
;

347 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

348 
	}
}

350 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

351 
ùoib_cm_rx
 *
rx
)

353 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

355 
ib_ªcv_wr
 
wr
;

356 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

357 } *
t
;

358 
ªt
;

359 
i
;

361 
rx
->
rx_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *rx->rx_ring);

362 i‡(!
rx
->
rx_rög
)

363  -
ENOMEM
;

365 
t
 = 
	`kmÆloc
( *t, 
GFP_KERNEL
);

366 i‡(!
t
) {

367 
ªt
 = -
ENOMEM
;

368 
îr_‰ì_1
;

371 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

373 
	`•ö_lock_úq
(&
¥iv
->
lock
);

375 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

376 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

377 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

378 
ªt
 = -
EINVAL
;

379 
îr_‰ì
;

381 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

383 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

385 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

386 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

387 
rx
->
rx_rög
[
i
].
m≠pög
,

388 
GFP_KERNEL
)) {

389 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

390 
ªt
 = -
ENOMEM
;

391 
îr_cou¡
;

393 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

394 i‡(
ªt
) {

395 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

396 "Áûed f‹ bu‡%d\n", 
i
);

397 
ªt
 = -
EIO
;

398 
îr_cou¡
;

402 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

404 
	`k‰ì
(
t
);

408 
îr_cou¡
:

409 
	`•ö_lock_úq
(&
¥iv
->
lock
);

410 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

411 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

413 
îr_‰ì
:

414 
	`k‰ì
(
t
);

416 
îr_‰ì_1
:

417 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

419  
ªt
;

420 
	}
}

422 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

423 
ib_qp
 *
qp
, 
ib_cm_ªq_evít_∑øm
 *
ªq
,

424 
p¢
)

426 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

427 
ùoib_cm_d©a
 
d©a
 = {};

428 
ib_cm_ªp_∑øm
 
ªp
 = {};

430 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

431 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

433 
ªp
.
¥iv©e_d©a
 = &
d©a
;

434 
ªp
.
¥iv©e_d©a_Àn
 =  
d©a
;

435 
ªp
.
Êow_c⁄åﬁ
 = 0;

436 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

437 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

438 
ªp
.
qp_num
 = 
qp
->qp_num;

439 
ªp
.
°¨tög_p¢
 = 
p¢
;

440  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

441 
	}
}

443 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
( *p, 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö
(
Àngth
, (Ë
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
, "cmÑecvÉrror "

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 - 
	`mö
(wc->byte_len,

644 ()
IPOIB_CM_HEAD_SIZE
)Ë/ 
PAGE_SIZE
;

646 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

647 
m≠pög
, 
GFP_ATOMIC
);

648 i‡(
	`u∆ikñy
(!
√wskb
)) {

653 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

654 ++
dev
->
°©s
.
rx_dr›≥d
;

655 
ªpo°
;

658 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

659 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) *  *mapping);

661 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

662 
wc
->
byã_Àn
, wc->
¶id
);

664 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

666 
c›õd
:

667 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

668 
	`skb_add_p£udo_hdr
(
skb
);

670 ++
dev
->
°©s
.
rx_∑ckës
;

671 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

673 
skb
->
dev
 = dev;

675 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

676 
	`√tif_ª˚ive_skb
(
skb
);

678 
ªpo°
:

679 i‡(
has_§q
) {

680 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

681 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

682 "f‹ bu‡%d\n", 
wr_id
);

684 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

685 &
¥iv
->
cm
.
rx_wr
,

686 
¥iv
->
cm
.
rx_sge
,

687 
wr_id
))) {

688 --
p
->
ªcv_cou¡
;

689 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

690 "f‹ bu‡%d\n", 
wr_id
);

693 
	}
}

695 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

696 
ùoib_cm_tx
 *
tx
,

697 
wr_id
,

698 
ùoib_tx_buf
 *
tx_ªq
)

700 
ib_£nd_wr
 *
bad_wr
;

702 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

704 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

706  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, &
bad_wr
);

707 
	}
}

709 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

711 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

712 
ùoib_tx_buf
 *
tx_ªq
;

713 
rc
;

714 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

716 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

717 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

718 
skb
->
Àn
, 
tx
->
mtu
);

719 ++
dev
->
°©s
.
tx_dr›≥d
;

720 ++
dev
->
°©s
.
tx_îr‹s
;

721 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

724 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

725 i‡(
	`skb_löórize
(
skb
) < 0) {

726 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

727 ++
dev
->
°©s
.
tx_dr›≥d
;

728 ++
dev
->
°©s
.
tx_îr‹s
;

729 
	`dev_k‰ì_skb_™y
(
skb
);

733 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

734 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

735 ++
dev
->
°©s
.
tx_dr›≥d
;

736 ++
dev
->
°©s
.
tx_îr‹s
;

737 
	`dev_k‰ì_skb_™y
(
skb
);

741 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

742 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

751 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

752 
tx_ªq
->
skb
 = skb;

754 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

755 ++
dev
->
°©s
.
tx_îr‹s
;

756 
	`dev_k‰ì_skb_™y
(
skb
);

760 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

761 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

762 
tx
->
qp
->
qp_num
);

763 
	`√tif_°›_queue
(
dev
);

766 
	`skb_‹ph™
(
skb
);

767 
	`skb_d°_dr›
(
skb
);

769 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

770 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

771 
IB_CQ_REPORT_MISSED_EVENTS
);

772 i‡(
	`u∆ikñy
(
rc
 < 0))

773 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

774 i‡(
rc
)

775 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

778 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

779 i‡(
	`u∆ikñy
(
rc
)) {

780 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

781 ++
dev
->
°©s
.
tx_îr‹s
;

782 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

783 
	`dev_k‰ì_skb_™y
(
skb
);

785 i‡(
	`√tif_queue_°›≥d
(
dev
))

786 
	`√tif_wake_queue
(
dev
);

788 
	`√tif_å™s_upd©e
(
dev
);

789 ++
tx
->
tx_hód
;

790 ++
¥iv
->
tx_hód
;

792 
	}
}

794 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

796 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

797 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

798 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

799 
ùoib_tx_buf
 *
tx_ªq
;

800 
Êags
;

802 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

803 
wr_id
, 
wc
->
°©us
);

805 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

806 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

807 
wr_id
, 
ùoib_£ndq_size
);

811 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

813 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

816 ++
dev
->
°©s
.
tx_∑ckës
;

817 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

819 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

821 
	`√tif_tx_lock
(
dev
);

823 ++
tx
->
tx_èû
;

824 ++
¥iv
->
tx_èû
;

826 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

827 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

828 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

829 
	`√tif_wake_queue
(
dev
);

831 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

832 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

833 
ùoib_√igh
 *
√igh
;

838 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

839 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

840 
	`ùoib_dbg
(
¥iv
,

842 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

844 
	`ùoib_w¨n
(
¥iv
,

846 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

848 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

849 
√igh
 = 
tx
->neigh;

851 i‡(
√igh
) {

852 
√igh
->
cm
 = 
NULL
;

853 
	`ùoib_√igh_‰ì
(
√igh
);

855 
tx
->
√igh
 = 
NULL
;

858 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

859 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

860 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

863 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

865 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

868 
	`√tif_tx_u∆ock
(
dev
);

869 
	}
}

871 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

873 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

874 
ªt
;

876 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

879 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

880 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

881 
	`¥ötk
(
KERN_WARNING
 "%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

882 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

883 
îr_cm
;

886 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

888 i‡(
ªt
) {

889 
	`¥ötk
(
KERN_WARNING
 "%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

890 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

891 
îr_li°í
;

896 
îr_li°í
:

897 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

898 
îr_cm
:

899 
¥iv
->
cm
.
id
 = 
NULL
;

900  
ªt
;

901 
	}
}

903 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

905 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

906 
ùoib_cm_rx
 *
rx
, *
n
;

907 
	`LIST_HEAD
(
li°
);

909 
	`•ö_lock_úq
(&
¥iv
->
lock
);

910 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

911 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

913 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

914 
	`ib_de°roy_cm_id
(
rx
->
id
);

915 
	`ib_de°roy_qp
(
rx
->
qp
);

916 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

917 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

918 
	`•ö_lock_úq
(&
¥iv
->
lock
);

919 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

920 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

922 
	`k‰ì
(
rx
);

924 
	}
}

926 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

928 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

929 
ùoib_cm_rx
 *
p
;

930 
begö
;

931 
ªt
;

933 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

936 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

937 
¥iv
->
cm
.
id
 = 
NULL
;

939 
	`•ö_lock_úq
(&
¥iv
->
lock
);

940 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

941 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

942 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

943 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

944 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

945 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

946 i‡(
ªt
)

947 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

948 
	`•ö_lock_úq
(&
¥iv
->
lock
);

952 
begö
 = 
jiffõs
;

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

956 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

957 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

958 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

963 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

964 &
¥iv
->
cm
.
rx_ª≠_li°
);

965 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

966 &
¥iv
->
cm
.
rx_ª≠_li°
);

967 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

968 &
¥iv
->
cm
.
rx_ª≠_li°
);

971 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

972 
	`u¶ìp_ønge
(1000, 2000);

973 
	`ùoib_døö_cq
(
dev
);

974 
	`•ö_lock_úq
(&
¥iv
->
lock
);

977 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

979 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

981 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

982 
	}
}

984 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
, 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 =

1073 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.
max_sge
, 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 =  
d©a
;

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 * (*p->tx_ring));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
( *tx, 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, Öathrec);

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
))

1440 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1441 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1442 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
))

1443 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1445 
	`dev_k‰ì_skb_™y
(
skb
);

1447 
	`√tif_tx_lock_bh
(
dev
);

1448 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1451 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1452 
	`√tif_tx_u∆ock_bh
(
dev
);

1453 
	}
}

1455 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1456 
mtu
)

1458 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1459 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1461 i‡(
	`skb_d°
(
skb
))

1462 
	`skb_d°
(
skb
)->
›s
->
	`upd©e_pmtu
(skb_d°(skb), 
NULL
, skb, 
mtu
);

1464 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1465 i‡(
e
)

1466 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1467 
	}
}

1469 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1471 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1472 
cm
.
rx_ª≠_èsk
)->
dev
);

1473 
	}
}

1475 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1477 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1478 
cm
.
°Æe_èsk
.
w‹k
);

1479 
ùoib_cm_rx
 *
p
;

1480 
ªt
;

1482 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1483 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1486 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1487 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1489 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1490 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1491 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1492 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1493 i‡(
ªt
)

1494 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1495 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1498 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1499 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1500 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1501 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1502 
	}
}

1504 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1505 *
buf
)

1507 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1508 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1510 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1511  
	`•rötf
(
buf
, "connected\n");

1513  
	`•rötf
(
buf
, "datagram\n");

1514 
	}
}

1516 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1517 c⁄° *
buf
, 
size_t
 
cou¡
)

1519 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1520 
ªt
;

1521 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1523 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
¥iv
->
Êags
))

1524  -
EPERM
;

1526 i‡(!
	`muãx_åylock
(&
¥iv
->
sysfs_muãx
))

1527  
	`ª°¨t_sysˇŒ
();

1529 i‡(!
	`π∆_åylock
()) {

1530 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

1531  
	`ª°¨t_sysˇŒ
();

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1542 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

1544  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1545 
	}
}

1547 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1549 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1551  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1552 
	}
}

1554 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1556 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1557 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1558 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1559 .
©å
 = {

1560 .
max_wr
 = 
ùoib_ªcvq_size
,

1561 .
max_sge
 = max_sge

1565 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1566 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1567 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
ENOSYS
)

1568 
	`¥ötk
(
KERN_WARNING
 "%s: failedÅoállocate SRQ,Érror %ld\n",

1569 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1570 
¥iv
->
cm
.
§q
 = 
NULL
;

1574 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *priv->cm.srq_ring);

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@SLES12SP4/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`ib_modify_cq
(
¥iv
->
ªcv_cq
, 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

103 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

104 i‡(
ªt
 &&Ñë !-
ENOSYS
) {

105 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

106  
ªt
;

109 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

110 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

113 
	}
}

114 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

115 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

116 
u64
 *
d©a
)

118 
i
;

119 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

120 
u8
 *
p
 = (u8 *)
√t_°©s
;

122 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

123 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

125 
	}
}

126 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

127 
u32
 
°rög£t
, 
u8
 *
d©a
)

129 
u8
 *
p
 = 
d©a
;

130 
i
;

132 
°rög£t
) {

133 
ETH_SS_STATS
:

134 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

135 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

136 
ETH_GSTRING_LEN
);

137 
p
 +
ETH_GSTRING_LEN
;

140 
ETH_SS_TEST
:

144 
	}
}

145 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

146 
s£t
)

148 
s£t
) {

149 
ETH_SS_STATS
:

150  
IPOIB_GLOBAL_STATS_LEN
;

151 
ETH_SS_TEST
:

155  -
EOPNOTSUPP
;

156 
	}
}

159 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

161 
•ìd
) {

162 
IB_SPEED_SDR
:

163  
SPEED_2500
;

164 
IB_SPEED_DDR
:

165  
SPEED_5000
;

166 
IB_SPEED_QDR
:

167 
IB_SPEED_FDR10
:

168  
SPEED_10000
;

169 
IB_SPEED_FDR
:

170  
SPEED_14000
;

171 
IB_SPEED_EDR
:

172  
SPEED_25000
;

175  
SPEED_UNKNOWN
;

176 
	}
}

178 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

179 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

181 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

182 
ib_p‹t_©å
 
©å
;

183 
ªt
, 
•ìd
, 
width
;

185 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

186 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

187 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

191 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

192 i‡(
ªt
 < 0)

193  -
EINVAL
;

195 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

196 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

198 i‡(
•ìd
 < 0 || 
width
 < 0)

199  -
EINVAL
;

205 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

206 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

208 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

210 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

211 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

214 
	}
}

216 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

217 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

218 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

219 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

220 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

221 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

222 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

223 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

226 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

228 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

229 
	}
}

	@SLES12SP4/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 +  "_path"];

267 
	`¢¥ötf
(
«me
, Çame, "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, Çame, "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@SLES12SP4/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

44 
	~"ùoib.h
"

46 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


47 
	gd©a_debug_Àvñ
;

49 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

50 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

54 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

55 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

57 
ùoib_ah
 *
ah
;

58 
ib_ah
 *
vah
;

60 
ah
 = 
	`kmÆloc
( *ah, 
GFP_KERNEL
);

61 i‡(!
ah
)

62  
	`ERR_PTR
(-
ENOMEM
);

64 
ah
->
dev
 = dev;

65 
ah
->
œ°_£nd
 = 0;

66 
	`kªf_öô
(&
ah
->
ªf
);

68 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

69 i‡(
	`IS_ERR
(
vah
)) {

70 
	`k‰ì
(
ah
);

71 
ah
 = (
ùoib_ah
 *)
vah
;

73 
ah
->ah = 
vah
;

74 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

77  
ah
;

78 
	}
}

80 
	$ùoib_‰ì_ah
(
kªf
 *kref)

82 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

83 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

85 
Êags
;

87 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

88 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

89 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

90 
	}
}

92 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

93 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

95 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

96 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

97 
DMA_FROM_DEVICE
);

98 
	}
}

100 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

103 
ib_ªcv_wr
 *
bad_wr
;

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, &
bad_wr
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
, "failedÑecvÉvent "

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 *  *
m≠pög
);

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
, "failed sendÉvent "

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
ib_£nd_wr
 *
bad_wr
;

545 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

547 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

549 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

550 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

551 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

553 i‡(
hód
) {

554 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

555 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

556 
¥iv
->
tx_wr
.
hÀn
 = hlen;

557 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

559 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

561  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, &
bad_wr
);

562 
	}
}

564 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

565 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

567 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

568 
ùoib_tx_buf
 *
tx_ªq
;

569 
hÀn
, 
rc
;

570 *
phód
;

571 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

573 i‡(
	`skb_is_gso
(
skb
)) {

574 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

575 
phód
 = 
skb
->
d©a
;

576 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

577 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

578 ++
dev
->
°©s
.
tx_dr›≥d
;

579 ++
dev
->
°©s
.
tx_îr‹s
;

580 
	`dev_k‰ì_skb_™y
(
skb
);

584 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

585 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

586 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

587 ++
dev
->
°©s
.
tx_dr›≥d
;

588 ++
dev
->
°©s
.
tx_îr‹s
;

589 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

592 
phód
 = 
NULL
;

593 
hÀn
 = 0;

595 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

596 i‡(
	`skb_löórize
(
skb
) < 0) {

597 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

598 ++
dev
->
°©s
.
tx_dr›≥d
;

599 ++
dev
->
°©s
.
tx_îr‹s
;

600 
	`dev_k‰ì_skb_™y
(
skb
);

604 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

605 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

606 ++
dev
->
°©s
.
tx_dr›≥d
;

607 ++
dev
->
°©s
.
tx_îr‹s
;

608 
	`dev_k‰ì_skb_™y
(
skb
);

613 
	`ùoib_dbg_d©a
(
¥iv
,

615 
skb
->
Àn
, 
addªss
, 
dq≤
);

624 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

625 
tx_ªq
->
skb
 = skb;

626 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

627 ++
dev
->
°©s
.
tx_îr‹s
;

628 
	`dev_k‰ì_skb_™y
(
skb
);

632 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

633 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

635 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

637 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

638 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

639 
	`√tif_°›_queue
(
dev
);

642 
	`skb_‹ph™
(
skb
);

643 
	`skb_d°_dr›
(
skb
);

645 i‡(
	`√tif_queue_°›≥d
(
dev
))

646 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

647 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

648 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

650 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

651 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

652 i‡(
	`u∆ikñy
(
rc
)) {

653 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

654 ++
dev
->
°©s
.
tx_îr‹s
;

655 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

656 
	`dev_k‰ì_skb_™y
(
skb
);

657 i‡(
	`√tif_queue_°›≥d
(
dev
))

658 
	`√tif_wake_queue
(
dev
);

659 
rc
 = 0;

661 
	`√tif_å™s_upd©e
(
dev
);

663 
rc
 = 
¥iv
->
tx_hód
;

664 ++
¥iv
->
tx_hód
;

666  
rc
;

667 
	}
}

669 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

671 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

672 
ùoib_ah
 *
ah
, *
èh
;

673 
	`LIST_HEAD
(
ªmove_li°
);

674 
Êags
;

676 
	`√tif_tx_lock_bh
(
dev
);

677 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

679 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

680 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

681 
	`li°_dñ
(&
ah
->
li°
);

682 
	`rdma_de°roy_ah
(
ah
->ah, 0);

683 
	`k‰ì
(
ah
);

686 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

687 
	`√tif_tx_u∆ock_bh
(
dev
);

688 
	}
}

690 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

692 
ùoib_dev_¥iv
 *
¥iv
 =

693 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

694 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

696 
	`__ùoib_ª≠_ah
(
dev
);

698 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

699 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

700 
	`round_jiffõs_ªœtive
(
HZ
));

701 
	}
}

703 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

705 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

707 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

708 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

709 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

710 
	}
}

712 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

714 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

717 
	`ùoib_Êush_ah
(
dev
);

718 
	}
}

720 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

722 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

723 
≥ndög
 = 0;

724 
i
;

726 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

727 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

728 ++
≥ndög
;

730  
≥ndög
;

731 
	}
}

733 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

734 
ib_qp
 *
qp
,

735 
ib_qp_°©e
 
√w_°©e
)

737 
ib_qp_©å
 
qp_©å
;

738 
ib_qp_öô_©å
 
quîy_öô_©å
;

739 
ªt
;

741 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

742 i‡(
ªt
) {

743 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

747 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

748 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

750 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

751 
√w_°©e
, 
qp_©å
.
qp_°©e
);

752 
	}
}

754 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

756 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

758 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

759 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

760 
	}
}

762 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

764 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

766 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

767 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

768 
	}
}

770 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

772 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

773 
ib_qp_©å
 
qp_©å
;

774 
begö
;

775 
ùoib_tx_buf
 *
tx_ªq
;

776 
i
;

778 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

779 
	`ùoib_«pi_dißbÀ
(
dev
);

781 
	`ùoib_cm_dev_°›
(
dev
);

787 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

788 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

789 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

792 
begö
 = 
jiffõs
;

794 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

795 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

796 
	`ùoib_w¨n
(
¥iv
,

798 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

799 
	`ªcvs_≥ndög
(
dev
));

805 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

806 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

807 (
ùoib_£ndq_size
 - 1)];

808 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

809 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

810 ++
¥iv
->
tx_èû
;

813 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

814 
ùoib_rx_buf
 *
rx_ªq
;

816 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

817 i‡(!
rx_ªq
->
skb
)

819 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

820 
¥iv
->
rx_rög
[
i
].
m≠pög
);

821 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

822 
rx_ªq
->
skb
 = 
NULL
;

825 
timeout
;

828 
	`ùoib_døö_cq
(
dev
);

830 
	`u¶ìp_ønge
(1000, 2000);

833 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

835 
timeout
:

836 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

837 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

838 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

840 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

843 
	}
}

845 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

847 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

849 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

851 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

852 
	`ùoib_Êush_ah
(
dev
);

855 
	}
}

857 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

859 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

860 
ªt
;

862 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

863 i‡(
ªt
) {

864 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

868 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

869 i‡(
ªt
) {

870 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

871 
out
;

874 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

875 i‡(
ªt
) {

876 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

877 
out
;

880 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

881 
	`ùoib_«pi_íabÀ
(
dev
);

884 
out
:

886 
	}
}

888 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

890 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

892 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

894 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

895 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

896 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

900 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

901 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

902 
	`round_jiffõs_ªœtive
(
HZ
));

904 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

905 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

906 
dev_°›
;

909 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

913 
dev_°›
:

914 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

915 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

916 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

917 
	`ùoib_ib_dev_°›
(
dev
);

919 
	}
}

921 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

923 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

924 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

926 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

927 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

928 &
¥iv
->
pkey_ödex
)) {

929 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

931 i‡(
∫
->
£t_id
)

932 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

933 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

935 
	}
}

937 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

939 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

941 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

943 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

944 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

948 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

950 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

951 
	}
}

953 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

955 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

957 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

959 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

960 
	`√tif_ˇºõr_off
(
dev
);

962 
	`ùoib_mˇ°_°›_thªad
(
dev
);

963 
	`ùoib_mˇ°_dev_Êush
(
dev
);

965 
	`ùoib_Êush_∑ths
(
dev
);

966 
	}
}

968 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

970 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

971 
i
, 
n
;

978 
	`loˇl_bh_dißbÀ
();

981 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

982 
i
 = 0; i < 
n
; ++i) {

988 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

989 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

992 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

993 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

995 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

997 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

1000 } 
n
 =
IPOIB_NUM_WC
);

1002 
	`pﬁl_tx
(
¥iv
))

1005 
	`loˇl_bh_íabÀ
();

1006 
	}
}

1012 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1014 
ªsu…
;

1015 
u16
 
¥ev_pkey
;

1017 
¥ev_pkey
 = 
¥iv
->
pkey
;

1018 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1019 i‡(
ªsu…
) {

1020 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1021 
¥iv
->
p‹t
, 
ªsu…
);

1022  
ªsu…
;

1025 
¥iv
->
pkey
 |= 0x8000;

1027 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1028 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1029 
¥ev_pkey
, 
¥iv
->
pkey
);

1034 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1035 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1040 
	}
}

1044 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1046 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1048 
¥iv
->
pkey_ödex
 = 0;

1049 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1051 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1052 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1055 
	}
}

1061 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1063 
ib_gid
 
£¨ch_gid
;

1064 
ib_gid
 
gid0
;

1065 
ib_gid
 *
√tdev_gid
;

1066 
îr
;

1067 
u16
 
ödex
;

1068 
u8
 
p‹t
;

1069 
boﬁ
 
ªt
 = 
Ál£
;

1071 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1072 i‡(
	`ib_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
, 
NULL
))

1073  
Ál£
;

1075 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1080 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1082 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1084 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1086 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1088 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, 
IB_GID_TYPE_IB
,

1089 
¥iv
->
dev
, &
p‹t
, &
ödex
);

1091 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1093 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1094 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1098 
out
;

1125 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1126 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1127 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1128 i‡(
ödex
 == 0)

1129 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1130 &
¥iv
->
Êags
);

1132 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1133 
ªt
 = 
åue
;

1135 
ªt
 = 
Ál£
;

1138 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1139 
ªt
 = 
åue
;

1141 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1142 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1143 (
¥iv
->
loˇl_gid
));

1144 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1145 (
¥iv
->
loˇl_gid
));

1146 
ªt
 = 
åue
;

1151 
out
:

1152 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1154  
ªt
;

1155 
	}
}

1157 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1158 
ùoib_Êush_Àvñ
 
Àvñ
,

1159 
√°ög
)

1161 
ùoib_dev_¥iv
 *
˝riv
;

1162 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1163 
ªsu…
;

1165 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1171 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1172 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1174 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1176 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1177 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1179 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1180 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1181 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1185 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1187 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1188 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1189 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1191 
	`upd©e_chûd_pkey
(
¥iv
);

1192 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1193 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1194 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1198 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1202 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1203 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1204 i‡(
ªsu…
) {

1206 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1211 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1213 i‡(
ªsu…
) {

1214 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1220 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1221 
›î_up
;

1222 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1228 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1229 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1230 i‡(
›î_up
)

1231 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1232 
	`ùoib_Êush_ah
(
dev
);

1235 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1236 
	`ùoib_ib_dev_down
(
dev
);

1238 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1239 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1240 
	`ùoib_ib_dev_°›
(
dev
);

1242 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1245 i‡(
	`√tif_queue_°›≥d
(
dev
))

1246 
	`√tif_°¨t_queue
(
dev
);

1253 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1254 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1255 
	`ùoib_ib_dev_up
(
dev
);

1256 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1257 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1259 
	}
}

1261 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1263 
ùoib_dev_¥iv
 *
¥iv
 =

1264 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1266 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1267 
	}
}

1269 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1271 
ùoib_dev_¥iv
 *
¥iv
 =

1272 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1274 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1275 
	}
}

1277 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1279 
ùoib_dev_¥iv
 *
¥iv
 =

1280 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1282 
	`π∆_lock
();

1283 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1284 
	`π∆_u∆ock
();

1285 
	}
}

1287 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1289 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1291 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1296 
	`ùoib_Êush_∑ths
(
dev
);

1298 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1299 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1307 
	`ùoib_°›_ah
(
dev
);

1309 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1311 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1313 i‡(
¥iv
->
pd
) {

1314 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1315 
¥iv
->
pd
 = 
NULL
;

1317 
	}
}

	@SLES12SP4/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
uöt
 
ùoib_ac˚l
;

80 
	sùoib_∑th_ôî
 {

81 
√t_devi˚
 *
	mdev
;

82 
ùoib_∑th
 
	m∑th
;

85 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

91 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

93 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

95 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

96 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

97 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

98 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

99 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

100 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

101 *
˛õ¡_d©a
);

102 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

103 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

104 
cmd
);

106 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

107 .
«me
 = "ipoib",

108 .
	gadd
 = 
ùoib_add_⁄e
,

109 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

110 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

113 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


114 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

115 
evít
, *
±r
)

117 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

118 
√t_devi˚
 *
dev
 = 
ni
->dev;

120 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

121  
NOTIFY_DONE
;

123 
evít
) {

124 
NETDEV_REGISTER
:

125 
	`ùoib_¸óã_debug_fûes
(
dev
);

127 
NETDEV_CHANGENAME
:

128 
	`ùoib_dñëe_debug_fûes
(
dev
);

129 
	`ùoib_¸óã_debug_fûes
(
dev
);

131 
NETDEV_UNREGISTER
:

132 
	`ùoib_dñëe_debug_fûes
(
dev
);

136  
NOTIFY_DONE
;

137 
	}
}

140 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

142 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

144 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

146 
	`√tif_ˇºõr_off
(
dev
);

148 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

150 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

152 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

153 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

155 
îr_dißbÀ
;

158 
	`ùoib_ib_dev_up
(
dev
);

160 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

161 
ùoib_dev_¥iv
 *
˝riv
;

164 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

165 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

166 
Êags
;

168 
Êags
 = 
˝riv
->
dev
->flags;

169 i‡(
Êags
 & 
IFF_UP
)

172 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

174 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

177 
	`√tif_°¨t_queue
(
dev
);

181 
îr_dißbÀ
:

182 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

184  -
EINVAL
;

185 
	}
}

187 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

191 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

193 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

195 
	`√tif_°›_queue
(
dev
);

197 
	`ùoib_ib_dev_down
(
dev
);

198 
	`ùoib_ib_dev_°›
(
dev
);

200 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

201 
ùoib_dev_¥iv
 *
˝riv
;

204 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

205 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

206 
Êags
;

208 
Êags
 = 
˝riv
->
dev
->flags;

209 i‡(!(
Êags
 & 
IFF_UP
))

212 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

214 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

218 
	}
}

220 
	$ùoib_unöô
(
√t_devi˚
 *
dev
)

222 
	`ùoib_dev_˛ónup
(
dev
);

223 
	}
}

225 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

227 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

229 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

230 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

232  
„©uªs
;

233 
	}
}

235 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

238 
ªt
 = 0;

241 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

242 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

243  -
EINVAL
;

245 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

246 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

247 
¥iv
->
mˇ°_mtu
);

249 
dev
->
mtu
 = 
√w_mtu
;

253 i‡(
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

254  -
EINVAL
;

256 
¥iv
->
admö_mtu
 = 
√w_mtu
;

258 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

259 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

260 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

262 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

264 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

265 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

267 
	`√tif_ˇºõr_off
(
dev
);

270 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

272 i‡(
ˇºõr_°©us
)

273 
	`√tif_ˇºõr_⁄
(
dev
);

275 
dev
->
mtu
 = 
√w_mtu
;

278  
ªt
;

279 
	}
}

281 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

282 
π∆_lök_°©s64
 *
°©s
)

284 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

286 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

287 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

289 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

290 
	}
}

293 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

294 
√t_devi˚
 *
dev
)

296 
√t
 *√à
	`dev_√t
(
dev
);

297 
ö_devi˚
 *
ö_dev
;

298 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

299 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

300 
__be32
 
ªt_addr
;

302 
addr
->
ß_Ámûy
) {

303 
AF_INET
:

304 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

305 i‡(!
ö_dev
)

306  
Ál£
;

308 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

309 
addr_ö
->
sö_addr
.
s_addr
,

310 
RT_SCOPE_HOST
);

311 
	`ö_dev_put
(
ö_dev
);

312 i‡(
ªt_addr
)

313  
åue
;

316 
AF_INET6
:

317 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

318 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

319  
åue
;

323  
Ál£
;

324 
	}
}

333 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

335 
√t_devi˚
 *
ma°î
;

337 
	`rcu_ªad_lock
();

338 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

339 i‡(
ma°î
)

340 
	`dev_hﬁd
(
ma°î
);

341 
	`rcu_ªad_u∆ock
();

343 i‡(
ma°î
)

344  
ma°î
;

346 
	`dev_hﬁd
(
dev
);

347  
dev
;

348 
	}
}

350 
	sùoib_wÆk_d©a
 {

351 c⁄° 
sockaddr
 *
	maddr
;

352 
√t_devi˚
 *
	mªsu…
;

355 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

357 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

358 
ªt
 = 0;

360 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

361 
	`dev_hﬁd
(
uµî
);

362 
d©a
->
ªsu…
 = 
uµî
;

363 
ªt
 = 1;

366  
ªt
;

367 
	}
}

378 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

379 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

381 
ùoib_wÆk_d©a
 
d©a
 = {

382 .
addr
 =áddr,

385 
	`rcu_ªad_lock
();

386 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

387 
	`dev_hﬁd
(
dev
);

388 
d©a
.
ªsu…
 = 
dev
;

389 
out
;

392 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

393 
out
:

394 
	`rcu_ªad_u∆ock
();

395  
d©a
.
ªsu…
;

396 
	}
}

403 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

404 c⁄° 
ib_gid
 *
gid
,

405 
u16
 
pkey_ödex
,

406 c⁄° 
sockaddr
 *
addr
,

407 
√°ög
,

408 
√t_devi˚
 **
found_√t_dev
)

410 
ùoib_dev_¥iv
 *
chûd_¥iv
;

411 
√t_devi˚
 *
√t_dev
 = 
NULL
;

412 
m©ches
 = 0;

414 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

415 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

416 i‡(!
addr
) {

417 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

421 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

423 i‡(
√t_dev
) {

424 i‡(!*
found_√t_dev
)

425 *
found_√t_dev
 = 
√t_dev
;

427 
	`dev_put
(
√t_dev
);

428 ++
m©ches
;

433 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

434 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

435 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

436 
pkey_ödex
, 
addr
,

437 
√°ög
 + 1,

438 
found_√t_dev
);

439 i‡(
m©ches
 > 1)

442 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

444  
m©ches
;

445 
	}
}

450 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

451 
u16
 
pkey_ödex
,

452 c⁄° 
ib_gid
 *
gid
,

453 c⁄° 
sockaddr
 *
addr
,

454 
√t_devi˚
 **
√t_dev
)

456 
ùoib_dev_¥iv
 *
¥iv
;

457 
m©ches
 = 0;

459 *
√t_dev
 = 
NULL
;

461 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

462 i‡(
¥iv
->
p‹t
 !=Öort)

465 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

466 
addr
, 0, 
√t_dev
);

467 i‡(
m©ches
 > 1)

471  
m©ches
;

472 
	}
}

474 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

475 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

476 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

477 *
˛õ¡_d©a
)

479 
√t_devi˚
 *
√t_dev
;

480 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

481 
u16
 
pkey_ödex
;

482 
m©ches
;

483 
ªt
;

485 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

486  
NULL
;

488 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

489 i‡(
ªt
)

490  
NULL
;

492 i‡(!
dev_li°
)

493  
NULL
;

496 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

497 
gid
, 
NULL
, &
√t_dev
);

499 
m©ches
) {

501  
NULL
;

503  
√t_dev
;

506 
	`dev_put
(
√t_dev
);

510 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

511 
gid
, 
addr
, &
√t_dev
);

512 
m©ches
) {

514  
NULL
;

516 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

520  
√t_dev
;

522 
	}
}

524 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

528 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

529 !
	`°rcmp
(
buf
, "connected\n")) ||

530 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

531 !
	`°rcmp
(
buf
, "datagram\n"))) {

536 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

537 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

538 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

540 
	`√tdev_upd©e_„©uªs
(
dev
);

541 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

542 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

543 
	`π∆_u∆ock
();

544 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

546 
	`ùoib_Êush_∑ths
(
dev
);

547  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

550 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

551 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

552 
	`√tdev_upd©e_„©uªs
(
dev
);

553 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

554 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

555 
	`π∆_u∆ock
();

556 
	`ùoib_Êush_∑ths
(
dev
);

557  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

560  -
EINVAL
;

561 
	}
}

563 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

565 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

566 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

567 
ùoib_∑th
 *
∑th
;

568 
ªt
;

570 
n
) {

571 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

573 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

574  (
ib_gid
));

576 i‡(
ªt
 < 0)

577 
n
 =Ç->
rb_À·
;

578 i‡(
ªt
 > 0)

579 
n
 =Ç->
rb_right
;

581  
∑th
;

584  
NULL
;

585 
	}
}

587 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

589 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

590 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

591 
rb_node
 *
≤
 = 
NULL
;

592 
ùoib_∑th
 *
ç©h
;

593 
ªt
;

595 *
n
) {

596 
≤
 = *
n
;

597 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

599 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

600  (
ib_gid
));

601 i‡(
ªt
 < 0)

602 
n
 = &
≤
->
rb_À·
;

603 i‡(
ªt
 > 0)

604 
n
 = &
≤
->
rb_right
;

606  -
EEXIST
;

609 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

610 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

612 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

615 
	}
}

617 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

619 
sk_buff
 *
skb
;

621 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

622 
	`dev_k‰ì_skb_úq
(
skb
);

624 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

627 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

629 i‡(
∑th
->
ah
)

630 
	`ùoib_put_ah
(
∑th
->
ah
);

632 
	`k‰ì
(
∑th
);

633 
	}
}

635 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


637 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

639 
ùoib_∑th_ôî
 *
ôî
;

641 
ôî
 = 
	`kmÆloc
( *ôî, 
GFP_KERNEL
);

642 i‡(!
ôî
)

643  
NULL
;

645 
ôî
->
dev
 = dev;

646 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

648 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

649 
	`k‰ì
(
ôî
);

650  
NULL
;

653  
ôî
;

654 
	}
}

656 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

659 
rb_node
 *
n
;

660 
ùoib_∑th
 *
∑th
;

661 
ªt
 = 1;

663 
	`•ö_lock_úq
(&
¥iv
->
lock
);

665 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

667 
n
) {

668 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

670 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

671  (
ib_gid
)) < 0) {

672 
ôî
->
∑th
 = *path;

673 
ªt
 = 0;

677 
n
 = 
	`rb_√xt
(n);

680 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

682  
ªt
;

683 
	}
}

685 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

686 
ùoib_∑th
 *
∑th
)

688 *
∑th
 = 
ôî
->path;

689 
	}
}

693 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

695 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

696 
ùoib_∑th
 *
∑th
, *
ç
;

698 
	`•ö_lock_úq
(&
¥iv
->
lock
);

700 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

701 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

702 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

703 
∑th
->
∑thªc
.
dgid
.
øw
);

704 i‡(
∑th
->
ah
)

705 
∑th
->
ah
->
vÆid
 = 0;

708 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

709 
	}
}

711 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

713 
ùoib_p£udo_hódî
 *
phdr
;

715 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

716 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

717 
	}
}

719 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

721 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

722 
ùoib_∑th
 *
∑th
, *
ç
;

723 
	`LIST_HEAD
(
ªmove_li°
);

724 
Êags
;

726 
	`√tif_tx_lock_bh
(
dev
);

727 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

729 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

731 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

732 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

734 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

735 i‡(
∑th
->
quîy
)

736 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

737 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

738 
	`√tif_tx_u∆ock_bh
(
dev
);

739 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

740 
	`∑th_‰ì
(
dev
, 
∑th
);

741 
	`√tif_tx_lock_bh
(
dev
);

742 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

745 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

746 
	`√tif_tx_u∆ock_bh
(
dev
);

747 
	}
}

749 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

750 
ß_∑th_ªc
 *
∑thªc
,

751 *
∑th_±r
)

753 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

754 
√t_devi˚
 *
dev
 = 
∑th
->dev;

755 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

756 
ùoib_ah
 *
ah
 = 
NULL
;

757 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

758 
ùoib_√igh
 *
√igh
, *
ä
;

759 
sk_buff_hód
 
skqueue
;

760 
sk_buff
 *
skb
;

761 
Êags
;

763 i‡(!
°©us
)

764 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

765 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

766 
∑thªc
->
dgid
.
øw
);

768 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

769 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

771 
	`skb_queue_hód_öô
(&
skqueue
);

773 i‡(!
°©us
) {

774 
rdma_ah_©å
 
av
;

776 i‡(!
	`ib_öô_ah_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
, 
∑thªc
, &
av
))

777 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

780 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

782 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

788 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

789 (
ib_gid
))) {

790 
	`ùoib_dbg
(

791 
¥iv
,

793 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

794 
∑th
->
∑thªc
.
dgid
.
øw
);

795 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

796 (
ib_gid
));

799 
∑th
->
∑thªc
 = *pathrec;

801 
ﬁd_ah
 = 
∑th
->
ah
;

802 
∑th
->
ah
 =áh;

804 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

805 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

806 
∑thªc
->
¶
);

808 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

809 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

811 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

812 i‡(
√igh
->
ah
) {

813 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

821 
	`ùoib_put_ah
(
√igh
->
ah
);

823 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

824 
√igh
->
ah
 = 
∑th
->ah;

826 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

827 i‡(!
	`ùoib_cm_gë
(
√igh
))

828 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

829 
∑th
,

830 
√igh
));

831 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

832 
	`ùoib_√igh_‰ì
(
√igh
);

837 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

838 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

840 
∑th
->
ah
->
vÆid
 = 1;

843 
∑th
->
quîy
 = 
NULL
;

844 
	`com∂ëe
(&
∑th
->
d⁄e
);

846 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

848 i‡(
	`IS_ERR_OR_NULL
(
ah
))

849 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

851 i‡(
ﬁd_ah
)

852 
	`ùoib_put_ah
(
ﬁd_ah
);

854 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

855 
ªt
;

856 
skb
->
dev
 = dev;

857 
ªt
 = 
	`dev_queue_xmô
(
skb
);

858 i‡(
ªt
)

859 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

860 
__func__
, 
ªt
);

862 
	}
}

864 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

866 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

867 
ùoib_∑th
 *
∑th
;

869 i‡(!
¥iv
->
brﬂdˇ°
)

870  
NULL
;

872 
∑th
 = 
	`kzÆloc
( *∑th, 
GFP_ATOMIC
);

873 i‡(!
∑th
)

874  
NULL
;

876 
∑th
->
dev
 = dev;

878 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

880 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

882 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

883 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

885 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

886 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
,  (
ib_gid
));

887 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

888 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

889 
∑th
->
∑thªc
.
numb_∑th
 = 1;

890 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

892  
∑th
;

893 
	}
}

895 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

896 
ùoib_∑th
 *
∑th
)

898 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

900 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

901 
∑th
->
∑thªc
.
dgid
.
øw
);

903 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

905 
∑th
->
quîy_id
 =

906 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

907 &
∑th
->
∑thªc
,

908 
IB_SA_PATH_REC_DGID
 |

909 
IB_SA_PATH_REC_SGID
 |

910 
IB_SA_PATH_REC_NUMB_PATH
 |

911 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

912 
IB_SA_PATH_REC_PKEY
,

913 1000, 
GFP_ATOMIC
,

914 
∑th_ªc_com∂ëi⁄
,

915 
∑th
, &∑th->
quîy
);

916 i‡(
∑th
->
quîy_id
 < 0) {

917 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

918 
∑th
->
quîy
 = 
NULL
;

919 
	`com∂ëe
(&
∑th
->
d⁄e
);

920  
∑th
->
quîy_id
;

924 
	}
}

926 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

927 
√t_devi˚
 *
dev
)

929 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

930 
ùoib_∑th
 *
∑th
;

931 
Êags
;

933 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

935 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

936 i‡(!
∑th
)

937 
out
;

938 i‡(!
∑th
->
quîy
)

939 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

940 
out
:

941 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

942 
	}
}

944 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

945 
√t_devi˚
 *
dev
)

947 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

948 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

949 
ùoib_∑th
 *
∑th
;

950 
ùoib_√igh
 *
√igh
;

951 
Êags
;

953 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

954 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

955 i‡(!
√igh
) {

956 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

957 ++
dev
->
°©s
.
tx_dr›≥d
;

958 
	`dev_k‰ì_skb_™y
(
skb
);

959  
NULL
;

965 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

966 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

967  
√igh
;

970 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

971 i‡(!
∑th
) {

972 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

973 i‡(!
∑th
)

974 
îr_∑th
;

976 
	`__∑th_add
(
dev
, 
∑th
);

979 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

981 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

982 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

983 
√igh
->
ah
 = 
∑th
->ah;

985 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

986 i‡(!
	`ùoib_cm_gë
(
√igh
))

987 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

988 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

989 
	`ùoib_√igh_‰ì
(
√igh
);

990 
îr_dr›
;

992 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

993 
IPOIB_MAX_PATH_REC_QUEUE
) {

994 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

995 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

997 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

998 
	`skb_queue_Àn
(&
√igh
->
queue
));

999 
îr_dr›
;

1002 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1003 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1004 
	`IPOIB_QPN
(
daddr
));

1005 
	`ùoib_√igh_put
(
√igh
);

1006  
NULL
;

1009 
√igh
->
ah
 = 
NULL
;

1011 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1012 
îr_∑th
;

1013 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1014 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1015 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1017 
îr_dr›
;

1021 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1022 
	`ùoib_√igh_put
(
√igh
);

1023  
NULL
;

1025 
îr_∑th
:

1026 
	`ùoib_√igh_‰ì
(
√igh
);

1027 
îr_dr›
:

1028 ++
dev
->
°©s
.
tx_dr›≥d
;

1029 
	`dev_k‰ì_skb_™y
(
skb
);

1031 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1032 
	`ùoib_√igh_put
(
√igh
);

1034  
NULL
;

1035 
	}
}

1037 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1038 
ùoib_p£udo_hódî
 *
phdr
)

1040 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1041 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1042 
ùoib_∑th
 *
∑th
;

1043 
Êags
;

1045 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1047 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1048 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1049 
√w_∑th
 = 0;

1051 i‡(!
∑th
) {

1052 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1053 
√w_∑th
 = 1;

1055 i‡(
∑th
) {

1056 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1057 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1058 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1060 ++
dev
->
°©s
.
tx_dr›≥d
;

1061 
	`dev_k‰ì_skb_™y
(
skb
);

1064 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1065 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1066 i‡(
√w_∑th
)

1067 
	`∑th_‰ì
(
dev
, 
∑th
);

1070 
	`__∑th_add
(
dev
, 
∑th
);

1072 ++
dev
->
°©s
.
tx_dr›≥d
;

1073 
	`dev_k‰ì_skb_™y
(
skb
);

1076 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1080 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

1081 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1082 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1084 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1088 } i‡((
∑th
->
quîy
 || !
	`∑th_ªc_°¨t
(
dev
,Öath)) &&

1089 
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1090 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1091 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1093 ++
dev
->
°©s
.
tx_dr›≥d
;

1094 
	`dev_k‰ì_skb_™y
(
skb
);

1097 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1098 
	}
}

1100 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1102 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1103 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1104 
ùoib_√igh
 *
√igh
;

1105 
ùoib_p£udo_hódî
 *
phdr
;

1106 
ùoib_hódî
 *
hódî
;

1107 
Êags
;

1109 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1110 
	`skb_puŒ
(
skb
, (*
phdr
));

1111 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1113 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1115 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1116 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1117 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1118 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1119 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1121 ++
dev
->
°©s
.
tx_dr›≥d
;

1122 
	`dev_k‰ì_skb_™y
(
skb
);

1123  
NETDEV_TX_OK
;

1126 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1127 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1129 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1130 i‡(
	`likñy
(
√igh
))

1131 
£nd_usög_√igh
;

1132 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1133  
NETDEV_TX_OK
;

1137 
hódî
->
¥Ÿo
) {

1138 
	`ht⁄s
(
ETH_P_IP
):

1139 
	`ht⁄s
(
ETH_P_IPV6
):

1140 
	`ht⁄s
(
ETH_P_TIPC
):

1141 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1142 i‡(
	`u∆ikñy
(!
√igh
)) {

1143 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1144 i‡(
	`likñy
(!
√igh
))

1145  
NETDEV_TX_OK
;

1148 
	`ht⁄s
(
ETH_P_ARP
):

1149 
	`ht⁄s
(
ETH_P_RARP
):

1151 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1152  
NETDEV_TX_OK
;

1155 ++
dev
->
°©s
.
tx_dr›≥d
;

1156 
	`dev_k‰ì_skb_™y
(
skb
);

1157  
NETDEV_TX_OK
;

1160 
£nd_usög_√igh
:

1162 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1163 i‡(
	`ùoib_cm_up
(
√igh
)) {

1164 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1165 
uƒef
;

1167 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1168 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1169 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1170 
uƒef
;

1171 } i‡(
√igh
->
ah
) {

1172 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1175 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1176 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1177 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1178 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1179 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1181 ++
dev
->
°©s
.
tx_dr›≥d
;

1182 
	`dev_k‰ì_skb_™y
(
skb
);

1185 
uƒef
:

1186 
	`ùoib_√igh_put
(
√igh
);

1188  
NETDEV_TX_OK
;

1189 
	}
}

1191 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1193 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1195 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1196 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1197 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1198 
	`√tif_queue_°›≥d
(
dev
),

1199 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1201 
	}
}

1203 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1204 
√t_devi˚
 *
dev
,

1205 
ty≥
,

1206 c⁄° *
daddr
, c⁄° *
ßddr
, 
Àn
)

1208 
ùoib_hódî
 *
hódî
;

1210 
hódî
 = 
	`skb_push
(
skb
,  *header);

1212 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1213 
hódî
->
ª£rved
 = 0;

1220 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1222  
IPOIB_HARD_LEN
;

1223 
	}
}

1225 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1227 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1229 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1230 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1234 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1235 
	}
}

1237 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1239 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1242 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1243  
dev
->
ifödex
;

1246  
¥iv
->
∑ª¡
->
ifödex
;

1247 
	}
}

1249 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1258 
u32
 *
d32
 = (u32 *Ë
daddr
;

1259 
u32
 
hv
;

1261 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1262  
hv
 & 
htbl
->
mask
;

1263 
	}
}

1265 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1267 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1268 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1269 
ùoib_√igh_hash
 *
htbl
;

1270 
ùoib_√igh
 *
√igh
 = 
NULL
;

1271 
u32
 
hash_vÆ
;

1273 
	`rcu_ªad_lock_bh
();

1275 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1277 i‡(!
htbl
)

1278 
out_u∆ock
;

1280 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1282 
√igh
 !
NULL
;

1283 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1284 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1286 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1288 
√igh
 = 
NULL
;

1289 
out_u∆ock
;

1292 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1293 
√igh
->
Æive
 = 
jiffõs
;

1294 
out_u∆ock
;

1298 
out_u∆ock
:

1299 
	`rcu_ªad_u∆ock_bh
();

1300  
√igh
;

1301 
	}
}

1303 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1305 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1306 
ùoib_√igh_hash
 *
htbl
;

1307 
√igh_obsﬁëe
;

1308 
dt
;

1309 
Êags
;

1310 
i
;

1311 
	`LIST_HEAD
(
ªmove_li°
);

1313 i‡(
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1316 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1318 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1319 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1321 i‡(!
htbl
)

1322 
out_u∆ock
;

1325 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1326 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1328 i‡(
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1329 
out_u∆ock
;

1331 
i
 = 0; i < 
htbl
->
size
; i++) {

1332 
ùoib_√igh
 *
√igh
;

1333 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1335 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1338 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1340 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1342 
	`rcu_assign_poöãr
(*
≈
,

1343 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1344 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1346 
	`li°_dñ_öô
(&
√igh
->
li°
);

1347 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1349 
≈
 = &
√igh
->
h√xt
;

1355 
out_u∆ock
:

1356 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1357 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1358 
	}
}

1360 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1362 
ùoib_dev_¥iv
 *
¥iv
 =

1363 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1365 
	`__ùoib_ª≠_√igh
(
¥iv
);

1367 i‡(!
	`ã°_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
))

1368 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1369 
¨p_tbl
.
gc_öãrvÆ
);

1370 
	}
}

1373 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1374 
√t_devi˚
 *
dev
)

1376 
ùoib_√igh
 *
√igh
;

1378 
√igh
 = 
	`kzÆloc
( *√igh, 
GFP_ATOMIC
);

1379 i‡(!
√igh
)

1380  
NULL
;

1382 
√igh
->
dev
 = dev;

1383 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1384 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1385 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1386 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1388 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1390  
√igh
;

1391 
	}
}

1393 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1394 
√t_devi˚
 *
dev
)

1396 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1397 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1398 
ùoib_√igh_hash
 *
htbl
;

1399 
ùoib_√igh
 *
√igh
;

1400 
u32
 
hash_vÆ
;

1402 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1403 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1404 i‡(!
htbl
) {

1405 
√igh
 = 
NULL
;

1406 
out_u∆ock
;

1412 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1413 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1414 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1415 
√igh
 !
NULL
;

1416 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1417 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1418 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1420 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1422 
√igh
 = 
NULL
;

1425 
√igh
->
Æive
 = 
jiffõs
;

1426 
out_u∆ock
;

1430 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1431 i‡(!
√igh
)

1432 
out_u∆ock
;

1435 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1436 
√igh
->
Æive
 = 
jiffõs
;

1438 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1439 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1440 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1441 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1442 
	`©omic_öc
(&
¡bl
->
íåõs
);

1444 
out_u∆ock
:

1446  
√igh
;

1447 
	}
}

1449 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1452 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1453 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1454 
sk_buff
 *
skb
;

1455 i‡(
√igh
->
ah
)

1456 
	`ùoib_put_ah
(
√igh
->
ah
);

1457 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1458 ++
dev
->
°©s
.
tx_dr›≥d
;

1459 
	`dev_k‰ì_skb_™y
(
skb
);

1461 i‡(
	`ùoib_cm_gë
(
√igh
))

1462 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1463 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1465 
	`IPOIB_QPN
(
√igh
->
daddr
),

1466 
√igh
->
daddr
 + 4);

1467 
	`k‰ì
(
√igh
);

1468 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1469 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1470 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1472 
	}
}

1474 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1477 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1479 
	`ùoib_√igh_put
(
√igh
);

1480 
	}
}

1482 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1484 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1485 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1486 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1487 
ùoib_√igh_hash
 *
htbl
;

1488 
ùoib_√igh
 
__rcu
 **
≈
;

1489 
ùoib_√igh
 *
n
;

1490 
u32
 
hash_vÆ
;

1492 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1493 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1494 i‡(!
htbl
)

1497 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1498 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1499 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1500 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1501 
n
 !
NULL
;

1502 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1503 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1504 i‡(
n
 =
√igh
) {

1506 
	`rcu_assign_poöãr
(*
≈
,

1507 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1508 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1510 
	`li°_dñ_öô
(&
√igh
->
li°
);

1511 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1514 
≈
 = &
n
->
h√xt
;

1517 
	}
}

1519 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1521 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1522 
ùoib_√igh_hash
 *
htbl
;

1523 
ùoib_√igh
 
__rcu
 **
buckës
;

1524 
u32
 
size
;

1526 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1527 
¡bl
->
htbl
 = 
NULL
;

1528 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1529 i‡(!
htbl
)

1530  -
ENOMEM
;

1531 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1532 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1533 
buckës
 = 
	`kzÆloc
(
size
 * (*buckës), 
GFP_KERNEL
);

1534 i‡(!
buckës
) {

1535 
	`k‰ì
(
htbl
);

1536  -
ENOMEM
;

1538 
htbl
->
size
 = size;

1539 
htbl
->
mask
 = (
size
 - 1);

1540 
htbl
->
buckës
 = buckets;

1541 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1542 
htbl
->
¡bl
 =Çtbl;

1543 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1546 
	`˛ór_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1547 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1548 
¨p_tbl
.
gc_öãrvÆ
);

1551 
	}
}

1553 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1555 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1556 
ùoib_√igh_hash
,

1557 
rcu
);

1558 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1559 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1561 
	`k‰ì
(
buckës
);

1562 
	`k‰ì
(
htbl
);

1563 
	`com∂ëe
(&
¡bl
->
dñëed
);

1564 
	}
}

1566 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1568 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1569 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1570 
ùoib_√igh_hash
 *
htbl
;

1571 
Êags
;

1572 
i
;

1575 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1577 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1578 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1580 i‡(!
htbl
)

1581 
out_u∆ock
;

1583 
i
 = 0; i < 
htbl
->
size
; i++) {

1584 
ùoib_√igh
 *
√igh
;

1585 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1587 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1588 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1590 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1591 
	`rcu_assign_poöãr
(*
≈
,

1592 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1593 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1595 
	`li°_dñ_öô
(&
√igh
->
li°
);

1596 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1598 
≈
 = &
√igh
->
h√xt
;

1603 
out_u∆ock
:

1604 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1605 
	}
}

1607 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1609 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1610 
ùoib_√igh_hash
 *
htbl
;

1611 
Êags
;

1612 
i
, 
waô_Êushed
 = 0;

1614 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1615 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1617 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1619 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1620 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1621 i‡(!
htbl
)

1622 
out_u∆ock
;

1624 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1625 i‡(!
waô_Êushed
)

1626 
‰ì_htbl
;

1628 
i
 = 0; i < 
htbl
->
size
; i++) {

1629 
ùoib_√igh
 *
√igh
;

1630 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1632 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1633 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1634 
	`rcu_assign_poöãr
(*
≈
,

1635 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1636 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1638 
	`li°_dñ_öô
(&
√igh
->
li°
);

1639 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1643 
‰ì_htbl
:

1644 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1645 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1647 
out_u∆ock
:

1648 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1649 i‡(
waô_Êushed
)

1650 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1651 
	}
}

1653 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1655 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1656 
°›≥d
;

1658 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1659 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1662 
°›≥d
 = 
	`ã°_™d_£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

1663 i‡(!
°›≥d
)

1664 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

1666 
	`ùoib_Êush_√ighs
(
¥iv
);

1668 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1669 
	}
}

1671 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1673 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1675 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1676 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1677 
	}
}

1679 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1681 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1683 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1684 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1685 
	}
}

1687 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1691 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1693 
	`ùoib_«pi_dñ
(
dev
);

1695 
	`ùoib_cm_dev_˛ónup
(
dev
);

1697 
	`k‰ì
(
¥iv
->
rx_rög
);

1698 
	`v‰ì
(
¥iv
->
tx_rög
);

1700 
¥iv
->
rx_rög
 = 
NULL
;

1701 
¥iv
->
tx_rög
 = 
NULL
;

1702 
	}
}

1704 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1706 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1708 
	`ùoib_«pi_add
(
dev
);

1711 
¥iv
->
rx_rög
 = 
	`kzÆloc
(
ùoib_ªcvq_size
 *  *priv->rx_ring,

1712 
GFP_KERNEL
);

1713 i‡(!
¥iv
->
rx_rög
)

1714 
out
;

1716 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 *  *priv->tx_ring);

1717 i‡(!
¥iv
->
tx_rög
) {

1718 
	`¥ötk
(
KERN_WARNING
 "%s: failedÅoállocate TXÑing (%dÉntries)\n",

1719 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1720 
out_rx_rög_˛ónup
;

1725 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1726 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1727 
¥iv
->
ˇ
->
«me
);

1728 
out_tx_rög_˛ónup
;

1732 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1733 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1734 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1738 
out_tx_rög_˛ónup
:

1739 
	`v‰ì
(
¥iv
->
tx_rög
);

1741 
out_rx_rög_˛ónup
:

1742 
	`k‰ì
(
¥iv
->
rx_rög
);

1744 
out
:

1745 
	`ùoib_«pi_dñ
(
dev
);

1746  -
ENOMEM
;

1747 
	}
}

1749 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1750 
cmd
)

1752 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1754 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1755  -
EOPNOTSUPP
;

1757  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1758 
	}
}

1760 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
, 
p‹t
)

1762 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1763 
ªt
 = -
ENOMEM
;

1765 
¥iv
->
ˇ
 = ca;

1766 
¥iv
->
p‹t
 =Öort;

1767 
¥iv
->
qp
 = 
NULL
;

1773 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1774 i‡(!
¥iv
->
wq
) {

1775 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1776 
out
;

1780 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1781 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1782 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
ˇ
->
«me
);

1783 
˛ón_wq
;

1786 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1787 i‡(
ªt
) {

1788 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1789 
out_‰ì_pd
;

1792 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1793 i‡(
ªt
) {

1794 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1795 
out_dev_unöô
;

1798 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1799 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1800 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1801 
ªt
 = -
ENODEV
;

1802 
out_dev_unöô
;

1808 
out_dev_unöô
:

1809 
	`ùoib_ib_dev_˛ónup
(
dev
);

1811 
out_‰ì_pd
:

1812 i‡(
¥iv
->
pd
) {

1813 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1814 
¥iv
->
pd
 = 
NULL
;

1817 
˛ón_wq
:

1818 i‡(
¥iv
->
wq
) {

1819 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1820 
¥iv
->
wq
 = 
NULL
;

1823 
out
:

1824  
ªt
;

1825 
	}
}

1827 
	$ùoib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1829 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
), *
˝riv
, *
t˝riv
;

1830 
	`LIST_HEAD
(
hód
);

1832 
	`ASSERT_RTNL
();

1835 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

1837 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
˝riv
->
Êags
);

1838 
	`ˇn˚l_dñayed_w‹k
(&
˝riv
->
√igh_ª≠_èsk
);

1839 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

1841 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

1843 
	`ùoib_√igh_hash_unöô
(
dev
);

1845 
	`ùoib_ib_dev_˛ónup
(
dev
);

1848 i‡(
¥iv
->
wq
) {

1849 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1850 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1851 
¥iv
->
wq
 = 
NULL
;

1853 
	}
}

1855 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1859  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

1860 
	}
}

1862 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

1863 
iÊa_vf_öfo
 *
ivf
)

1865 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1866 
îr
;

1868 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

1869 i‡(
îr
)

1870  
îr
;

1872 
ivf
->
vf
 = vf;

1875 
	}
}

1877 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

1879 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1881 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

1882  -
EINVAL
;

1884  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

1885 
	}
}

1887 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

1888 
iÊa_vf_°©s
 *
vf_°©s
)

1890 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1892  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

1893 
	}
}

1895 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

1896 .
¸óã
 = 
ùoib_h¨d_hódî
,

1899 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

1900 .
ndo_unöô
 = 
ùoib_unöô
,

1901 .
	gndo_›í
 = 
ùoib_›í
,

1902 .
	gndo_°›
 = 
ùoib_°›
,

1903 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

1904 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

1905 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

1906 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

1907 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

1908 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

1909 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

1910 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

1911 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

1912 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

1913 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

1914 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

1915 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

1918 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

1919 .
ndo_unöô
 = 
ùoib_unöô
,

1920 .
	gndo_›í
 = 
ùoib_›í
,

1921 .
	gndo_°›
 = 
ùoib_°›
,

1922 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

1923 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

1924 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

1925 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

1926 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

1927 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

1928 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

1929 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

1932 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

1933 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

1934 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

1935 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

1936 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

1939 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

1941 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

1942 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

1944 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

1946 
dev
->
w©chdog_timeo
 = 
HZ
;

1948 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

1950 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

1951 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

1952 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

1953 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

1954 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

1955 
NETIF_F_HIGHDMA
);

1956 
	`√tif_kìp_d°
(
dev
);

1958 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

1959 
	}
}

1961 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

1963 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1965 
¥iv
->
dev
 = dev;

1966 
	`•ö_lock_öô
(&
¥iv
->
lock
);

1967 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

1968 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

1969 
	`muãx_öô
(&
¥iv
->
sysfs_muãx
);

1971 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

1972 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

1973 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

1974 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

1976 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

1977 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

1978 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

1979 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

1980 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

1981 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

1982 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

1983 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

1984 
	}
}

1986 
√t_devi˚


1987 *
ùoib_¸óã_√tdev_deÁu…
(
ib_devi˚
 *
hˇ
,

1988 c⁄° *
«me
,

1989 
«me_assign_ty≥
,

1990 (*
£tup
)(
√t_devi˚
 *))

1992 
√t_devi˚
 *
dev
;

1993 
rdma_√tdev
 *
∫
;

1995 
dev
 = 
	`Æloc_√tdev
(()(
rdma_√tdev
),

1996 
«me
,

1997 
«me_assign_ty≥
, 
£tup
);

1998 i‡(!
dev
)

1999  
NULL
;

2001 
∫
 = 
	`√tdev_¥iv
(
dev
);

2003 
∫
->
£nd
 = 
ùoib_£nd
;

2004 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2005 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2006 
∫
->
‰ì_rdma_√tdev
 = 
‰ì_√tdev
;

2007 
∫
->
hˇ
 = hca;

2009  
dev
;

2010 
	}
}

2012 
√t_devi˚
 *
	$ùoib_gë_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2013 c⁄° *
«me
)

2015 
√t_devi˚
 *
dev
;

2017 i‡(
hˇ
->
Æloc_rdma_√tdev
) {

2018 
dev
 = 
hˇ
->
	`Æloc_rdma_√tdev
(hˇ, 
p‹t
,

2019 
RDMA_NETDEV_IPOIB
, 
«me
,

2020 
NET_NAME_UNKNOWN
,

2021 
ùoib_£tup_comm⁄
);

2022 i‡(
	`IS_ERR_OR_NULL
(
dev
Ë&& 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2023  
NULL
;

2026 i‡(!
hˇ
->
Æloc_rdma_√tdev
 || 
	`PTR_ERR
(
dev
Ë=-
EOPNOTSUPP
)

2027 
dev
 = 
	`ùoib_¸óã_√tdev_deÁu…
(
hˇ
, 
«me
, 
NET_NAME_UNKNOWN
,

2028 
ùoib_£tup_comm⁄
);

2030  
dev
;

2031 
	}
}

2033 
ùoib_dev_¥iv
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2034 c⁄° *
«me
)

2036 
√t_devi˚
 *
dev
;

2037 
ùoib_dev_¥iv
 *
¥iv
;

2038 
rdma_√tdev
 *
∫
;

2040 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2041 i‡(!
¥iv
)

2042  
NULL
;

2044 
dev
 = 
	`ùoib_gë_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2045 i‡(!
dev
)

2046 
‰ì_¥iv
;

2048 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2051 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2052 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2054 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2056 
∫
 = 
	`√tdev_¥iv
(
dev
);

2057 
∫
->
˛¡_¥iv
 = 
¥iv
;

2058 
	`ùoib_buûd_¥iv
(
dev
);

2060  
¥iv
;

2061 
‰ì_¥iv
:

2062 
	`k‰ì
(
¥iv
);

2063  
NULL
;

2064 
	}
}

2066 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2067 
devi˚_©åibuã
 *
©å
, *
buf
)

2069 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2070 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2072  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2073 
	}
}

2074 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2076 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2077 
devi˚_©åibuã
 *
©å
, *
buf
)

2079 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2080 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2082  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2083 
	}
}

2085 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2087 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2089 i‡(
umˇ°_vÆ
 > 0) {

2090 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2091 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2094 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2095 
	}
}

2097 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2098 
devi˚_©åibuã
 *
©å
,

2099 c⁄° *
buf
, 
size_t
 
cou¡
)

2101 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2103 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2105  
cou¡
;

2106 
	}
}

2107 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2109 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2111  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2112 
	}
}

2114 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2116 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2117 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2119 
	`√tif_addr_lock_bh
(
√tdev
);

2121 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2122 &
gid
->
globÆ
.
öãrÁ˚_id
,

2123 (
gid
->
globÆ
.
öãrÁ˚_id
));

2124 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2125 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2127 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2129 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2130 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2131 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2132 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2133 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2135 
	}
}

2137 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2138 
sockaddr_°‹age
 *
ss
)

2140 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2141 
ªt
 = 0;

2143 
	`√tif_addr_lock_bh
(
dev
);

2148 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2149 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2150 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2151 
ªt
 = -
EINVAL
;

2153 
	`√tif_addr_u∆ock_bh
(
dev
);

2155  
ªt
;

2156 
	}
}

2158 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2160 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2161 
sockaddr_°‹age
 *
ss
 = 
addr
;

2162 
ªt
;

2164 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2165  -
EBUSY
;

2167 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2168 i‡(
ªt
)

2169  
ªt
;

2171 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2173 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2176 
	}
}

2178 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2179 
devi˚_©åibuã
 *
©å
,

2180 c⁄° *
buf
, 
size_t
 
cou¡
)

2182 
pkey
;

2183 
ªt
;

2185 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2186  -
EINVAL
;

2188 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2189  -
EINVAL
;

2195 
pkey
 |= 0x8000;

2197 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2199  
ªt
 ?Ñë : 
cou¡
;

2200 
	}
}

2201 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2203 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2204 
devi˚_©åibuã
 *
©å
,

2205 c⁄° *
buf
, 
size_t
 
cou¡
)

2207 
pkey
;

2208 
ªt
;

2210 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2211  -
EINVAL
;

2213 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2214  -
EINVAL
;

2216 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2218  
ªt
 ?Ñë : 
cou¡
;

2220 
	}
}

2221 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2223 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2225  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2226 
	}
}

2228 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_devi˚
 *
hˇ
)

2230 
¥iv
->
hˇ_ˇps
 = 
hˇ
->
©ås
.
devi˚_ˇp_Êags
;

2232 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

2233 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

2235 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

2236 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

2238 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

2240 
	}
}

2242 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2243 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2245 
ùoib_dev_¥iv
 *
¥iv
;

2246 
ib_p‹t_©å
 
©å
;

2247 
rdma_√tdev
 *
∫
;

2248 
ªsu…
 = -
ENOMEM
;

2250 
¥iv
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2251 i‡(!
¥iv
)

2252 
Æloc_mem_Áûed
;

2254 
	`SET_NETDEV_DEV
(
¥iv
->
dev
, 
hˇ
->dev.
∑ª¡
);

2255 
¥iv
->
dev
->
dev_id
 = 
p‹t
 - 1;

2257 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

2259 
ªsu…
 = 
	`ib_quîy_p‹t
(
hˇ
, 
p‹t
, &
©å
);

2260 i‡(
ªsu…
) {

2261 
	`¥ötk
(
KERN_WARNING
 "%s: ib_query_port %d failed\n",

2262 
hˇ
->
«me
, 
p‹t
);

2263 
devi˚_öô_Áûed
;

2266 i‡(
	`rdma_c‹e_ˇp_›a_p‹t
(
hˇ
, 
p‹t
Ë&& 
ùoib_ac˚l
)

2267 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

2269 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

2272 
¥iv
->
dev
->
mtu
 = 
	`IPOIB_UD_MTU
’riv->
max_ib_mtu
);

2273 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 =Öriv->
dev
->
mtu
;

2274 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

2275 
¥iv
->
dev
->
max_mtu
 = 
IPOIB_CM_MTU
;

2276 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

2277 
¥iv
->
dev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

2279 
ªsu…
 = 
	`ib_quîy_pkey
(
hˇ
, 
p‹t
, 0, &
¥iv
->
pkey
);

2280 i‡(
ªsu…
) {

2281 
	`¥ötk
(
KERN_WARNING
 "%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

2282 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2283 
devi˚_öô_Áûed
;

2286 
	`ùoib_£t_dev_„©uªs
(
¥iv
, 
hˇ
);

2292 
¥iv
->
pkey
 |= 0x8000;

2294 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

2295 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

2297 
ªsu…
 = 
	`ib_quîy_gid
(
hˇ
, 
p‹t
, 0, &
¥iv
->
loˇl_gid
, 
NULL
);

2298 i‡(
ªsu…
) {

2299 
	`¥ötk
(
KERN_WARNING
 "%s: ib_query_gidÖort %d failed (ret = %d)\n",

2300 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2301 
devi˚_öô_Áûed
;

2304 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

2305 (
ib_gid
));

2306 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2308 
ªsu…
 = 
	`ùoib_dev_öô
(
¥iv
->
dev
, 
hˇ
, 
p‹t
);

2309 i‡(
ªsu…
) {

2310 
	`¥ötk
(
KERN_WARNING
 "%s: failedÅo initializeÖort %d (ret = %d)\n",

2311 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2312 
devi˚_öô_Áûed
;

2315 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2316 
¥iv
->
ˇ
, 
ùoib_evít
);

2317 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2320 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2322 
ªsu…
 = 
	`ªgi°î_√tdev
(
¥iv
->
dev
);

2323 i‡(
ªsu…
) {

2324 
	`¥ötk
(
KERN_WARNING
 "%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2325 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2326 
ªgi°î_Áûed
;

2329 
ªsu…
 = -
ENOMEM
;

2330 i‡(
	`ùoib_cm_add_mode_©å
(
¥iv
->
dev
))

2331 
sysfs_Áûed
;

2332 i‡(
	`ùoib_add_pkey_©å
(
¥iv
->
dev
))

2333 
sysfs_Áûed
;

2334 i‡(
	`ùoib_add_umˇ°_©å
(
¥iv
->
dev
))

2335 
sysfs_Áûed
;

2336 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_¸óã_chûd
))

2337 
sysfs_Áûed
;

2338 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_dñëe_chûd
))

2339 
sysfs_Áûed
;

2341  
¥iv
->
dev
;

2343 
sysfs_Áûed
:

2344 
	`uƒegi°î_√tdev
(
¥iv
->
dev
);

2346 
ªgi°î_Áûed
:

2347 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2348 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

2350 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

2351 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

2352 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

2353 
	`ùoib_dev_˛ónup
(
¥iv
->
dev
);

2355 
devi˚_öô_Áûed
:

2356 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

2357 
	`k‰ì
(
¥iv
);

2359 
Æloc_mem_Áûed
:

2360  
	`ERR_PTR
(
ªsu…
);

2361 
	}
}

2363 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2365 
li°_hód
 *
dev_li°
;

2366 
√t_devi˚
 *
dev
;

2367 
ùoib_dev_¥iv
 *
¥iv
;

2368 
p
;

2369 
cou¡
 = 0;

2371 
dev_li°
 = 
	`kmÆloc
( *dev_li°, 
GFP_KERNEL
);

2372 i‡(!
dev_li°
)

2375 
	`INIT_LIST_HEAD
(
dev_li°
);

2377 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2378 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2380 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2381 i‡(!
	`IS_ERR
(
dev
)) {

2382 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2383 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2384 
cou¡
++;

2388 i‡(!
cou¡
) {

2389 
	`k‰ì
(
dev_li°
);

2393 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2394 
	}
}

2396 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2398 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2399 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2401 i‡(!
dev_li°
)

2404 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2405 
rdma_√tdev
 *
∑ª¡_∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

2407 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2408 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

2411 
	`£t_bô
(
IPOIB_FLAG_GOING_DOWN
, &
¥iv
->
Êags
);

2413 
	`π∆_lock
();

2414 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

2415 
	`π∆_u∆ock
();

2418 
	`£t_bô
(
IPOIB_STOP_NEIGH_GC
, &
¥iv
->
Êags
);

2419 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
√igh_ª≠_èsk
);

2420 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

2423 
	`muãx_lock
(&
¥iv
->
sysfs_muãx
);

2424 
	`uƒegi°î_√tdev
(
¥iv
->
dev
);

2425 
	`muãx_u∆ock
(&
¥iv
->
sysfs_muãx
);

2427 
∑ª¡_∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

2429 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

2430 
rdma_√tdev
 *
chûd_∫
;

2432 
chûd_∫
 = 
	`√tdev_¥iv
(
˝riv
->
dev
);

2433 
chûd_∫
->
	`‰ì_rdma_√tdev
(
˝riv
->
dev
);

2434 
	`k‰ì
(
˝riv
);

2437 
	`k‰ì
(
¥iv
);

2440 
	`k‰ì
(
dev_li°
);

2441 
	}
}

2443 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2444 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2445 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2449 
__öô
 
	$ùoib_öô_moduÀ
()

2451 
ªt
;

2453 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2454 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2455 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2457 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2458 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2459 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2460 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2461 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2462 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2469 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2471 
	`¥_nŸi˚
("Intel Accelerated IPoIB for SLESÜoaded.\n");

2473 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2474 i‡(
ªt
)

2475  
ªt
;

2487 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush",

2488 
WQ_MEM_RECLAIM
);

2489 i‡(!
ùoib_w‹kqueue
) {

2490 
ªt
 = -
ENOMEM
;

2491 
îr_fs
;

2494 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2496 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2497 i‡(
ªt
)

2498 
îr_ß
;

2500 
ªt
 = 
	`ùoib_√éök_öô
();

2501 i‡(
ªt
)

2502 
îr_˛õ¡
;

2504 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2505 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2509 
îr_˛õ¡
:

2510 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2512 
îr_ß
:

2513 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2514 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2516 
îr_fs
:

2517 
	`ùoib_uƒegi°î_debugfs
();

2519  
ªt
;

2520 
	}
}

2522 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2524 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2525 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2527 
	`ùoib_√éök_föi
();

2528 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2529 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2530 
	`ùoib_uƒegi°î_debugfs
();

2531 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2532 
	}
}

2534 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2535 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@SLES12SP4/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
( *mˇ°, 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 #i‡
	`deföed
(
IFS_RH75
Ë|| deföed(
IFS_RH76
)

248 
	`IPOIB_UD_MTU
(
	`ib_mtu_íum_to_öt
(
¥iv
->
ˇ
,

249 
¥iv
->
p‹t
,

250 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

252 
	`IPOIB_UD_MTU
(
	`ib_mtu_íum_to_öt
(
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

255 
∫
->
mtu
 =

256 
¥iv
->
mˇ°_mtu
 =

257 #i‡
	`deföed
(
IFS_RH75
Ë|| deföed(
IFS_RH76
)

258 
	`IPOIB_UD_MTU
(
	`ib_mtu_íum_to_öt
(
¥iv
->
ˇ
,

259 
¥iv
->
p‹t
,

260 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

262 
	`IPOIB_UD_MTU
(
	`ib_mtu_íum_to_öt
(
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

264 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

265 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

266 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

267 
£t_qkey
 = 1;

270 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

271 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

272 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

273 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

279 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

280 
£t_qkey
, 
¥iv
->
qkey
);

281 i‡(
ªt
 < 0) {

282 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

283 
mˇ°
->
mcmembî
.
mgid
.
øw
);

285 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

286  
ªt
;

290 
	`mem£t
(&
av
, 0, (av));

291 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

292 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

293 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

294 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

295 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

297 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

298 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

299 0, 
mˇ°
->
mcmembî
.
h›_limô
,

300 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

302 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

303 i‡(
	`IS_ERR
(
ah
)) {

304 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

305 -
	`PTR_ERR
(
ah
));

307  
	`PTR_ERR
(
ah
);

309 
	`•ö_lock_úq
(&
¥iv
->
lock
);

310 
mˇ°
->
ah
 =áh;

311 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

313 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

314 
mˇ°
->
mcmembî
.
mgid
.
øw
,

315 
mˇ°
->
ah
->ah,

316 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

317 
mˇ°
->
mcmembî
.
¶
);

320 
	`√tif_tx_lock_bh
(
dev
);

321 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

322 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

324 
	`√tif_tx_u∆ock_bh
(
dev
);

326 
skb
->
dev
 = dev;

328 
ªt
 = 
	`dev_queue_xmô
(
skb
);

329 i‡(
ªt
)

330 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

331 
__func__
, 
ªt
);

332 
	`√tif_tx_lock_bh
(
dev
);

334 
	`√tif_tx_u∆ock_bh
(
dev
);

337 
	}
}

339 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

341 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

342 
ˇºõr_⁄_èsk
);

343 
ib_p‹t_©å
 
©å
;

345 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

346 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

347 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

356 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

357 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

358 
¥iv
->
ˇ
,Öriv->
p‹t
);

368 !
	`π∆_åylock
()) {

369 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

372 
	`m¶ìp
(20);

374 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

375 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

376 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

377 
	`π∆_u∆ock
();

378 
	}
}

380 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

381 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

383 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

384 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

385 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

388 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

390 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

393 i‡(
°©us
 =-
ENETRESET
) {

394 
°©us
 = 0;

395 
out
;

398 i‡(!
°©us
)

399 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

401 i‡(!
°©us
) {

402 
mˇ°
->
backoff
 = 1;

403 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

412 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

413 
	`•ö_lock_úq
(&
¥iv
->
lock
);

414 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

415 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

416 
out_locked
;

419 
boﬁ
 
sûít_Áû
 =

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

421 
°©us
 =-
EINVAL
;

423 i‡(
mˇ°
->
logcou¡
 < 20) {

424 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

425 
sûít_Áû
) {

426 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

427 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

428 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

430 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

431 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

432 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

435 i‡(!
sûít_Áû
)

436 
mˇ°
->
logcou¡
++;

439 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

440 
mˇ°
->
backoff
 >= 2) {

450 
mˇ°
->
backoff
 = 1;

451 
	`√tif_tx_lock_bh
(
dev
);

452 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

453 ++
dev
->
°©s
.
tx_dr›≥d
;

454 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

456 
	`√tif_tx_u∆ock_bh
(
dev
);

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

460 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

461 
out_locked
;

464 
out
:

465 
	`•ö_lock_úq
(&
¥iv
->
lock
);

466 
out_locked
:

471 i‡(
°©us
)

472 
mˇ°
->
mc
 = 
NULL
;

474 
mˇ°
->
mc
 = 
mu…iˇ°
;

475 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

476 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

477 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

479  
°©us
;

480 
	}
}

485 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

487 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

488 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

489 
ib_ß_mcmembî_ªc
 
ªc
 = {

490 .
joö_°©e
 = 1

492 
ib_ß_comp_mask
 
comp_mask
;

493 
ªt
 = 0;

495 i‡(!
¥iv
->
brﬂdˇ°
 ||

496 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

497  -
EINVAL
;

499 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

500 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

502 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

504 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

505 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

506 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

508 
comp_mask
 =

509 
IB_SA_MCMEMBER_REC_MGID
 |

510 
IB_SA_MCMEMBER_REC_PORT_GID
 |

511 
IB_SA_MCMEMBER_REC_PKEY
 |

512 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

514 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

522 
comp_mask
 |=

523 
IB_SA_MCMEMBER_REC_QKEY
 |

524 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

525 
IB_SA_MCMEMBER_REC_MTU
 |

526 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

527 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

528 
IB_SA_MCMEMBER_REC_RATE
 |

529 
IB_SA_MCMEMBER_REC_SL
 |

530 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

531 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

533 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

534 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

535 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

536 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

537 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

538 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

539 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

540 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

541 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

554 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

555 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

557 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

559 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

561 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

562 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

563 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

564 
	`•ö_lock_úq
(&
¥iv
->
lock
);

565 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

566 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

567 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

569 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

570 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

571 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

572 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

573 
	`•ö_lock_úq
(&
¥iv
->
lock
);

576 
	}
}

578 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

580 
ùoib_dev_¥iv
 *
¥iv
 =

581 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

582 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

583 
ib_p‹t_©å
 
p‹t_©å
;

584 
dñay_u¡û
 = 0;

585 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

587 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

590 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

591 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

594 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

595 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

596 
p‹t_©å
.
°©e
);

599 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

600 
	`√tif_addr_lock_bh
(
dev
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

603 
	`√tif_addr_u∆ock_bh
(
dev
);

606 
	`√tif_addr_u∆ock_bh
(
dev
);

608 
	`•ö_lock_úq
(&
¥iv
->
lock
);

609 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

610 
out
;

612 i‡(!
¥iv
->
brﬂdˇ°
) {

613 
ùoib_mˇ°
 *
brﬂdˇ°
;

615 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

616 i‡(!
brﬂdˇ°
) {

617 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

624 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

625 
out
;

628 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

629  (
ib_gid
));

630 
¥iv
->
brﬂdˇ°
 = broadcast;

632 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

635 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

636 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

637 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

638 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

639 i‡(
mˇ°
->
backoff
 > 1 &&

640 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

641 
dñay_u¡û
 = 
mˇ°
->delay_until;

642 
mˇ°
 = 
NULL
;

645 
out
;

652 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

653 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

654 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

655 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

656 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

657 i‡(
mˇ°
->
backoff
 == 1 ||

658 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

660 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

661 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

664 } i‡(!
dñay_u¡û
 ||

665 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

666 
dñay_u¡û
 = 
mˇ°
->delay_until;

670 
mˇ°
 = 
NULL
;

671 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

673 
out
:

674 i‡(
dñay_u¡û
) {

675 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

676 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

677 
dñay_u¡û
 - 
jiffõs
);

679 i‡(
mˇ°
)

680 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

682 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

683 
	}
}

685 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

687 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

688 
Êags
;

690 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

692 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

693 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

694 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

695 
	}
}

697 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

699 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

701 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

703 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

706 
	}
}

708 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

712 
ªt
 = 0;

714 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

715 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

717 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

718 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

720 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

721 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

722 
mˇ°
->
mcmembî
.
mgid
.
øw
);

725 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

726 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

727 i‡(
ªt
)

728 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

729 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

730 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

734 
	}
}

740 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

741 
li°_hód
 *
ªmove_li°
)

744 i‡(*
mgid
 == 0xff) {

745 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

747 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

748 
	`li°_dñ
(&
mˇ°
->
li°
);

749 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

750 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

753 
	}
}

755 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

757 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

763 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

764 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

765 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

767 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

768 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

769 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

771 
	}
}

773 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

775 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

776 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

777 
ùoib_mˇ°
 *
mˇ°
;

778 
Êags
;

779 *
mgid
 = 
daddr
 + 4;

781 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

783 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

784 !
¥iv
->
brﬂdˇ°
 ||

785 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

786 ++
dev
->
°©s
.
tx_dr›≥d
;

787 
	`dev_k‰ì_skb_™y
(
skb
);

788 
u∆ock
;

791 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

792 i‡(!
mˇ°
 || !mˇ°->
ah
) {

793 i‡(!
mˇ°
) {

795 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

796 
mgid
);

798 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

799 i‡(!
mˇ°
) {

800 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

802 ++
dev
->
°©s
.
tx_dr›≥d
;

803 
	`dev_k‰ì_skb_™y
(
skb
);

804 
u∆ock
;

807 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

808 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

809  (
ib_gid
));

810 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

811 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

813 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

815 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

816 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

818 ++
dev
->
°©s
.
tx_dr›≥d
;

819 
	`dev_k‰ì_skb_™y
(
skb
);

821 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

822 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

825 
ùoib_√igh
 *
√igh
;

827 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

828 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

829 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

830 i‡(!
√igh
) {

831 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

835 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

836 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

837 
√igh
->
ah
 = 
mˇ°
->ah;

838 
√igh
->
ah
->
vÆid
 = 1;

839 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

842 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

843 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

844 
IB_MULTICAST_QPN
);

845 i‡(
√igh
)

846 
	`ùoib_√igh_put
(
√igh
);

850 
u∆ock
:

851 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

852 
	}
}

854 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

856 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

857 
	`LIST_HEAD
(
ªmove_li°
);

858 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

859 
Êags
;

861 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

862 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

864 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

866 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

867 
	`li°_dñ
(&
mˇ°
->
li°
);

868 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

869 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

872 i‡(
¥iv
->
brﬂdˇ°
) {

873 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

874 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

875 
¥iv
->
brﬂdˇ°
 = 
NULL
;

878 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

880 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

881 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

882 
	}
}

884 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

887 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

890 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

893 
	}
}

895 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

897 
ùoib_dev_¥iv
 *
¥iv
 =

898 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

899 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

900 
√tdev_hw_addr
 *
ha
;

901 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

902 
	`LIST_HEAD
(
ªmove_li°
);

903 
Êags
;

904 
ib_ß_mcmembî_ªc
 
ªc
;

906 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

913 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

915 
	`loˇl_úq_ßve
(
Êags
);

916 
	`√tif_addr_lock
(
dev
);

917 
	`•ö_lock
(&
¥iv
->
lock
);

926 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

927 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

930 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

931 
ib_gid
 
mgid
;

933 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

936 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4,  mgid);

938 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

939 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

940 
ùoib_mˇ°
 *
nmˇ°
;

943 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

944 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

945 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

946 
mgid
.
øw
);

951 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

952 
mgid
.
øw
);

954 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

955 i‡(!
nmˇ°
) {

956 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

960 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

962 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

964 i‡(
mˇ°
) {

966 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

968 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

969 &
nmˇ°
->
rb_node
,

970 &
¥iv
->
mu…iˇ°_åì
);

972 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

974 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

977 i‡(
mˇ°
)

978 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

982 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

983 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

984 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

985 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

986 
mˇ°
->
mcmembî
.
mgid
.
øw
);

988 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

991 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

995 
	`•ö_u∆ock
(&
¥iv
->
lock
);

996 
	`√tif_addr_u∆ock
(
dev
);

997 
	`loˇl_úq_ª°‹e
(
Êags
);

999 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1004 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1005 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1006 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

1007 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1009 
	}
}

1011 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1013 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1015 
ùoib_mˇ°_ôî
 *
ôî
;

1017 
ôî
 = 
	`kmÆloc
( *ôî, 
GFP_KERNEL
);

1018 i‡(!
ôî
)

1019  
NULL
;

1021 
ôî
->
dev
 = dev;

1022 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1024 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1025 
	`k‰ì
(
ôî
);

1026  
NULL
;

1029  
ôî
;

1030 
	}
}

1032 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1034 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1035 
rb_node
 *
n
;

1036 
ùoib_mˇ°
 *
mˇ°
;

1037 
ªt
 = 1;

1039 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1041 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1043 
n
) {

1044 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1046 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1047  (
ib_gid
)) < 0) {

1048 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1049 
ôî
->
¸óãd
 = 
mˇ°
->created;

1050 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1051 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1052 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1054 
ªt
 = 0;

1059 
n
 = 
	`rb_√xt
(n);

1062 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1064  
ªt
;

1065 
	}
}

1067 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1068 
ib_gid
 *
mgid
,

1069 *
¸óãd
,

1070 *
queuñí
,

1071 *
com∂ëe
,

1072 *
£nd_⁄ly
)

1074 *
mgid
 = 
ôî
->mgid;

1075 *
¸óãd
 = 
ôî
->created;

1076 *
queuñí
 = 
ôî
->queuelen;

1077 *
com∂ëe
 = 
ôî
->complete;

1078 *
£nd_⁄ly
 = 
ôî
->send_only;

1079 
	}
}

	@SLES12SP4/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 i‡(
chûd_pkey
 == 0 || child_pkey == 0x8000)

126  -
EINVAL
;

132 
chûd_pkey
 |= 0x8000;

134 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

135 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

137 i‡(!
îr
 && 
d©a
)

138 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

139  
îr
;

140 
	}
}

142 
	$ùoib_uƒegi°î_chûd_dev
(
√t_devi˚
 *
dev
, 
li°_hód
 *
hód
)

144 
ùoib_dev_¥iv
 *
¥iv
, *
µriv
;

146 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

147 
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

149 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

150 
	`uƒegi°î_√tdevi˚_queue
(
dev
, 
hód
);

151 
	`li°_dñ
(&
¥iv
->
li°
);

152 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

153 
	}
}

155 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

157  
	`∆a_tŸÆ_size
(2) +

158 
	`∆a_tŸÆ_size
(2) +

159 
	`∆a_tŸÆ_size
(2);

160 
	}
}

162 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

163 .
köd
 = "ipoib",

164 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

165 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

166 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

167 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

168 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

169 .
	gch™gñök
 = 
ùoib_ch™gñök
,

170 .
	gdñlök
 = 
ùoib_uƒegi°î_chûd_dev
,

171 .
	ggë_size
 = 
ùoib_gë_size
,

172 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

175 
__öô
 
	$ùoib_√éök_öô
()

177  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

178 
	}
}

180 
__exô
 
	$ùoib_√éök_föi
()

182 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

183 
	}
}

185 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@SLES12SP4/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
( *qp_©å, 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.
max_sge
,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
ENOSYS
)

172  -
ENODEV
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥ötk
(
KERN_WARNING
 "%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥ötk
(
KERN_WARNING
 "%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥ötk
(
KERN_WARNING
 "%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
ªc‹d
->
devi˚
->
«me
,Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@SLES12SP4/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

54 
u16
 
pkey
, 
ty≥
)

56 
ªsu…
;

57 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

59 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

61 
¥iv
->
dev
->
mtu
 = 
	`IPOIB_UD_MTU
’riv->
max_ib_mtu
);

62 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 =Öriv->
dev
->
mtu
;

63 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

64 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

65 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

67 
	`ùoib_£t_dev_„©uªs
(
¥iv
, 
µriv
->
ˇ
);

69 
¥iv
->
pkey
 =Ökey;

71 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

72 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

73 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

74 
¥iv
->
dev
->
brﬂdˇ°
[8] = 
pkey
 >> 8;

75 
¥iv
->
dev
->
brﬂdˇ°
[9] = 
pkey
 & 0xff;

77 
ªsu…
 = 
	`ùoib_dev_öô
(
¥iv
->
dev
, 
µriv
->
ˇ
,Ö¥iv->
p‹t
);

78 i‡(
ªsu…
 < 0) {

79 
	`ùoib_w¨n
(
µriv
, "failedÅo initialize subinterface: "

81 
µriv
->
ˇ
->
«me
,Ö¥iv->
p‹t
);

82 
îr
;

85 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
¥iv
->
dev
);

86 i‡(
ªsu…
) {

87 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

88 
ªgi°î_Áûed
;

92 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

93 i‡(
	`ùoib_cm_add_mode_©å
(
¥iv
->
dev
))

94 
sysfs_Áûed
;

95 i‡(
	`ùoib_add_pkey_©å
(
¥iv
->
dev
))

96 
sysfs_Áûed
;

97 i‡(
	`ùoib_add_umˇ°_©å
(
¥iv
->
dev
))

98 
sysfs_Áûed
;

100 i‡(
	`devi˚_¸óã_fûe
(&
¥iv
->
dev
->dev, &
dev_©å_∑ª¡
))

101 
sysfs_Áûed
;

104 
¥iv
->
chûd_ty≥
 = 
ty≥
;

105 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

109 
sysfs_Áûed
:

110 
ªsu…
 = -
ENOMEM
;

111 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

113 
ªgi°î_Áûed
:

114 
	`ùoib_dev_˛ónup
(
¥iv
->
dev
);

116 
îr
:

117  
ªsu…
;

118 
	}
}

120 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

122 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

123 
ötf_«me
[
IFNAMSIZ
];

124 
ùoib_dev_¥iv
 *
çriv
;

125 
ªsu…
;

127 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

128  -
EPERM
;

130 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

132 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
µriv
->
Êags
))

133  -
EPERM
;

135 
	`¢¥ötf
(
ötf_«me
,  intf_name, "%s.%04x",

136 
µriv
->
dev
->
«me
, 
pkey
);

138 i‡(!
	`muãx_åylock
(&
µriv
->
sysfs_muãx
))

139  
	`ª°¨t_sysˇŒ
();

141 i‡(!
	`π∆_åylock
()) {

142 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

143  
	`ª°¨t_sysˇŒ
();

146 i‡(!
	`down_wrôe_åylock
(&
µriv
->
vœn_rw£m
)) {

147 
	`π∆_u∆ock
();

148 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

149  
	`ª°¨t_sysˇŒ
();

152 
¥iv
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

153 i‡(!
¥iv
) {

154 
ªsu…
 = -
ENOMEM
;

155 
out
;

163 i‡(
µriv
->
pkey
 ==Ökey) {

164 
ªsu…
 = -
ENOTUNIQ
;

165 
out
;

168 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

169 i‡(
çriv
->
pkey
 ==Ökey &&

170 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

171 
ªsu…
 = -
ENOTUNIQ
;

172 
out
;

176 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

178 
out
:

179 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

180 
	`π∆_u∆ock
();

181 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

183 i‡(
ªsu…
 && 
¥iv
) {

184 
rdma_√tdev
 *
∫
;

186 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

187 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

188 
	`k‰ì
(
¥iv
);

191  
ªsu…
;

192 
	}
}

194 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

196 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

197 
√t_devi˚
 *
dev
 = 
NULL
;

199 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

200  -
EPERM
;

202 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

204 i‡(
	`ã°_bô
(
IPOIB_FLAG_GOING_DOWN
, &
µriv
->
Êags
))

205  -
EPERM
;

207 i‡(!
	`muãx_åylock
(&
µriv
->
sysfs_muãx
))

208  
	`ª°¨t_sysˇŒ
();

210 i‡(!
	`π∆_åylock
()) {

211 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

212  
	`ª°¨t_sysˇŒ
();

215 i‡(!
	`down_wrôe_åylock
(&
µriv
->
vœn_rw£m
)) {

216 
	`π∆_u∆ock
();

217 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

218  
	`ª°¨t_sysˇŒ
();

221 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

222 i‡(
¥iv
->
pkey
 ==Ökey &&

223 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

224 
	`li°_dñ
(&
¥iv
->
li°
);

225 
dev
 = 
¥iv
->dev;

229 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

231 i‡(
dev
) {

232 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

233 
	`uƒegi°î_√tdevi˚
(
dev
);

236 
	`π∆_u∆ock
();

237 
	`muãx_u∆ock
(&
µriv
->
sysfs_muãx
);

239 i‡(
dev
) {

240 
rdma_√tdev
 *
∫
;

242 
∫
 = 
	`√tdev_¥iv
(
dev
);

243 
∫
->
	`‰ì_rdma_√tdev
(
¥iv
->
dev
);

244 
	`k‰ì
(
¥iv
);

248  -
ENODEV
;

249 
	}
}

	@SLES12SP5/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
˘x
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

845 
uöt
 
ùoib_ac˚l
;

	@SLES12SP5/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *rx->rx_ring);

359 i‡(!
rx
->
rx_rög
)

360  -
ENOMEM
;

362 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

363 i‡(!
t
) {

364 
ªt
 = -
ENOMEM
;

365 
îr_‰ì_1
;

368 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

370 
	`•ö_lock_úq
(&
¥iv
->
lock
);

372 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

373 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

374 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

375 
ªt
 = -
EINVAL
;

376 
îr_‰ì
;

378 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

380 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

382 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

383 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

384 
rx
->
rx_rög
[
i
].
m≠pög
,

385 
GFP_KERNEL
)) {

386 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

387 
ªt
 = -
ENOMEM
;

388 
îr_cou¡
;

390 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

391 i‡(
ªt
) {

392 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

393 "Áûed f‹ bu‡%d\n", 
i
);

394 
ªt
 = -
EIO
;

395 
îr_cou¡
;

399 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

401 
	`k‰ì
(
t
);

405 
îr_cou¡
:

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

408 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

410 
îr_‰ì
:

411 
	`k‰ì
(
t
);

413 
îr_‰ì_1
:

414 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

416  
ªt
;

417 
	}
}

419 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

420 
ib_qp
 *
qp
,

421 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

422 
p¢
)

424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

425 
ùoib_cm_d©a
 
d©a
 = {};

426 
ib_cm_ªp_∑øm
 
ªp
 = {};

428 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

429 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

431 
ªp
.
¥iv©e_d©a
 = &
d©a
;

432 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

433 
ªp
.
Êow_c⁄åﬁ
 = 0;

434 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

435 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

436 
ªp
.
qp_num
 = 
qp
->qp_num;

437 
ªp
.
°¨tög_p¢
 = 
p¢
;

438  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

439 
	}
}

441 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

442 c⁄° 
ib_cm_evít
 *
evít
)

444 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

445 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

446 
ùoib_cm_rx
 *
p
;

447 
p¢
;

448 
ªt
;

450 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

451 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

452 i‡(!
p
)

453  -
ENOMEM
;

454 
p
->
dev
 = dev;

455 
p
->
id
 = 
cm_id
;

456 
cm_id
->
c⁄ãxt
 = 
p
;

457 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

458 
p
->
jiffõs
 = jiffies;

459 
	`INIT_LIST_HEAD
(&
p
->
li°
);

461 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

462 i‡(
	`IS_ERR
(
p
->
qp
)) {

463 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

464 
îr_qp
;

467 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

468 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

469 i‡(
ªt
)

470 
îr_modify
;

472 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

473 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

474 i‡(
ªt
)

475 
îr_modify
;

478 
	`•ö_lock_úq
(&
¥iv
->
lock
);

479 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

480 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

483 
p
->
jiffõs
 = jiffies;

484 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

485 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

486 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

488 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

489 i‡(
ªt
) {

490 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

491 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

492 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

496 
îr_modify
:

497 
	`ib_de°roy_qp
(
p
->
qp
);

498 
îr_qp
:

499 
	`k‰ì
(
p
);

500  
ªt
;

501 
	}
}

503 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

504 c⁄° 
ib_cm_evít
 *
evít
)

506 
ùoib_cm_rx
 *
p
;

507 
ùoib_dev_¥iv
 *
¥iv
;

509 
evít
->event) {

510 
IB_CM_REQ_RECEIVED
:

511  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

512 
IB_CM_DREQ_RECEIVED
:

513 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

515 
IB_CM_REJ_RECEIVED
:

516 
p
 = 
cm_id
->
c⁄ãxt
;

517 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

518 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

519 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

524 
	}
}

526 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

527 
Àngth
, 
sk_buff
 *
toskb
)

529 
i
, 
num_‰ags
;

530 
size
;

533 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

534 
skb
->
èû
 +
size
;

535 
skb
->
Àn
 +
size
;

536 
Àngth
 -
size
;

538 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

539 
i
 = 0; i < 
num_‰ags
; i++) {

540 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

542 i‡(
Àngth
 == 0) {

544 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

545 0, 
PAGE_SIZE
);

546 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

548 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

550 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

551 
skb
->
d©a_Àn
 +
size
;

552 
skb
->
åuesize
 +
size
;

553 
skb
->
Àn
 +
size
;

554 
Àngth
 -
size
;

557 
	}
}

559 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

562 
ùoib_cm_rx_buf
 *
rx_rög
;

563 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

564 
sk_buff
 *
skb
, *
√wskb
;

565 
ùoib_cm_rx
 *
p
;

566 
Êags
;

567 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

568 
‰ags
;

569 
has_§q
;

570 
sk_buff
 *
smÆl_skb
;

572 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

573 
wr_id
, 
wc
->
°©us
);

575 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

576 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

577 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

578 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

579 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

580 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

581 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

583 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

584 
wr_id
, 
ùoib_ªcvq_size
);

588 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

590 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

591 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

593 
skb
 = 
rx_rög
[
wr_id
].skb;

595 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

596 
	`ùoib_dbg
(
¥iv
,

598 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

599 ++
dev
->
°©s
.
rx_dr›≥d
;

600 i‡(
has_§q
)

601 
ªpo°
;

603 i‡(!--
p
->
ªcv_cou¡
) {

604 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

605 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

606 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

607 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

613 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

614 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

615 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

616 
p
->
jiffõs
 = jiffies;

619 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

620 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

621 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

625 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

626 
dÀn
 = 
wc
->
byã_Àn
;

628 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

629 i‡(
smÆl_skb
) {

630 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

631 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

632 
dÀn
, 
DMA_FROM_DEVICE
);

633 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

634 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

635 
dÀn
, 
DMA_FROM_DEVICE
);

636 
	`skb_put
(
smÆl_skb
, 
dÀn
);

637 
skb
 = 
smÆl_skb
;

638 
c›õd
;

642 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

643 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

644 
PAGE_SIZE
;

646 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

647 
m≠pög
, 
GFP_ATOMIC
);

648 i‡(
	`u∆ikñy
(!
√wskb
)) {

653 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

654 ++
dev
->
°©s
.
rx_dr›≥d
;

655 
ªpo°
;

658 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

659 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

661 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

662 
wc
->
byã_Àn
, wc->
¶id
);

664 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

666 
c›õd
:

667 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

668 
	`skb_add_p£udo_hdr
(
skb
);

670 ++
dev
->
°©s
.
rx_∑ckës
;

671 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

673 
skb
->
dev
 = dev;

675 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

676 
	`√tif_ª˚ive_skb
(
skb
);

678 
ªpo°
:

679 i‡(
has_§q
) {

680 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

681 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

682 "f‹ bu‡%d\n", 
wr_id
);

684 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

685 &
¥iv
->
cm
.
rx_wr
,

686 
¥iv
->
cm
.
rx_sge
,

687 
wr_id
))) {

688 --
p
->
ªcv_cou¡
;

689 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

690 "f‹ bu‡%d\n", 
wr_id
);

693 
	}
}

695 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

696 
ùoib_cm_tx
 *
tx
,

697 
wr_id
,

698 
ùoib_tx_buf
 *
tx_ªq
)

700 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

702 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

704  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

705 
	}
}

707 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

709 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

710 
ùoib_tx_buf
 *
tx_ªq
;

711 
rc
;

712 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

714 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

715 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

716 
skb
->
Àn
, 
tx
->
mtu
);

717 ++
dev
->
°©s
.
tx_dr›≥d
;

718 ++
dev
->
°©s
.
tx_îr‹s
;

719 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

722 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

723 i‡(
	`skb_löórize
(
skb
) < 0) {

724 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

725 ++
dev
->
°©s
.
tx_dr›≥d
;

726 ++
dev
->
°©s
.
tx_îr‹s
;

727 
	`dev_k‰ì_skb_™y
(
skb
);

731 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

732 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

733 ++
dev
->
°©s
.
tx_dr›≥d
;

734 ++
dev
->
°©s
.
tx_îr‹s
;

735 
	`dev_k‰ì_skb_™y
(
skb
);

739 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

740 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

749 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

750 
tx_ªq
->
skb
 = skb;

752 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

753 ++
dev
->
°©s
.
tx_îr‹s
;

754 
	`dev_k‰ì_skb_™y
(
skb
);

758 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

759 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

760 
tx
->
qp
->
qp_num
);

761 
	`√tif_°›_queue
(
dev
);

764 
	`skb_‹ph™
(
skb
);

765 
	`skb_d°_dr›
(
skb
);

767 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

768 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

769 
IB_CQ_REPORT_MISSED_EVENTS
);

770 i‡(
	`u∆ikñy
(
rc
 < 0))

771 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

772 i‡(
rc
)

773 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

776 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

777 i‡(
	`u∆ikñy
(
rc
)) {

778 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

779 ++
dev
->
°©s
.
tx_îr‹s
;

780 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

781 
	`dev_k‰ì_skb_™y
(
skb
);

783 i‡(
	`√tif_queue_°›≥d
(
dev
))

784 
	`√tif_wake_queue
(
dev
);

786 
	`√tif_å™s_upd©e
(
dev
);

787 ++
tx
->
tx_hód
;

788 ++
¥iv
->
tx_hód
;

790 
	}
}

792 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

794 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

795 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

796 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

797 
ùoib_tx_buf
 *
tx_ªq
;

798 
Êags
;

800 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

801 
wr_id
, 
wc
->
°©us
);

803 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

804 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

805 
wr_id
, 
ùoib_£ndq_size
);

809 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

811 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

814 ++
dev
->
°©s
.
tx_∑ckës
;

815 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

817 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

819 
	`√tif_tx_lock
(
dev
);

821 ++
tx
->
tx_èû
;

822 ++
¥iv
->
tx_èû
;

824 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

825 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

826 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

827 
	`√tif_wake_queue
(
dev
);

829 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

830 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

831 
ùoib_√igh
 *
√igh
;

836 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

837 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

838 
	`ùoib_dbg
(
¥iv
,

840 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

842 
	`ùoib_w¨n
(
¥iv
,

844 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

846 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

847 
√igh
 = 
tx
->neigh;

849 i‡(
√igh
) {

850 
√igh
->
cm
 = 
NULL
;

851 
	`ùoib_√igh_‰ì
(
√igh
);

853 
tx
->
√igh
 = 
NULL
;

856 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

857 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

858 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

861 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

863 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

866 
	`√tif_tx_u∆ock
(
dev
);

867 
	}
}

869 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

871 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

872 
ªt
;

874 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

877 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

878 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

879 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

880 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

881 
îr_cm
;

884 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

886 i‡(
ªt
) {

887 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

888 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

889 
îr_li°í
;

894 
îr_li°í
:

895 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

896 
îr_cm
:

897 
¥iv
->
cm
.
id
 = 
NULL
;

898  
ªt
;

899 
	}
}

901 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

903 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
ùoib_cm_rx
 *
rx
, *
n
;

905 
	`LIST_HEAD
(
li°
);

907 
	`•ö_lock_úq
(&
¥iv
->
lock
);

908 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

909 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

911 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

912 
	`ib_de°roy_cm_id
(
rx
->
id
);

913 
	`ib_de°roy_qp
(
rx
->
qp
);

914 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

915 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

916 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

918 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

920 
	`k‰ì
(
rx
);

922 
	}
}

924 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

926 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

927 
ùoib_cm_rx
 *
p
;

928 
begö
;

929 
ªt
;

931 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

934 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

935 
¥iv
->
cm
.
id
 = 
NULL
;

937 
	`•ö_lock_úq
(&
¥iv
->
lock
);

938 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

939 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

940 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

941 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

942 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

943 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

944 i‡(
ªt
)

945 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

946 
	`•ö_lock_úq
(&
¥iv
->
lock
);

950 
begö
 = 
jiffõs
;

952 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

955 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

956 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

961 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

962 &
¥iv
->
cm
.
rx_ª≠_li°
);

963 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

964 &
¥iv
->
cm
.
rx_ª≠_li°
);

965 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

966 &
¥iv
->
cm
.
rx_ª≠_li°
);

969 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

970 
	`u¶ìp_ønge
(1000, 2000);

971 
	`ùoib_døö_cq
(
dev
);

972 
	`•ö_lock_úq
(&
¥iv
->
lock
);

975 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

977 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

979 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

980 
	}
}

982 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

983 c⁄° 
ib_cm_evít
 *
evít
)

985 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

986 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

987 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

988 
sk_buff_hód
 
skqueue
;

989 
ib_qp_©å
 
qp_©å
;

990 
qp_©å_mask
, 
ªt
;

991 
sk_buff
 *
skb
;

993 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

995 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

996 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

997 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

998  -
EINVAL
;

1001 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1002 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1003 i‡(
ªt
) {

1004 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1005  
ªt
;

1008 
qp_©å
.
rq_p¢
 = 0 ;

1009 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1010 i‡(
ªt
) {

1011 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1012  
ªt
;

1015 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1016 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1017 i‡(
ªt
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1019  
ªt
;

1021 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1022 i‡(
ªt
) {

1023 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1024  
ªt
;

1027 
	`skb_queue_hód_öô
(&
skqueue
);

1029 
	`√tif_tx_lock_bh
(
p
->
dev
);

1030 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1032 i‡(
p
->
√igh
)

1033 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1034 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1035 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1036 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1038 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1039 
skb
->
dev
 = 
p
->dev;

1040 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1041 i‡(
ªt
)

1042 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1043 
__func__
, 
ªt
);

1046 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1047 i‡(
ªt
) {

1048 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1049  
ªt
;

1052 
	}
}

1054 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1056 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1057 
ib_qp_öô_©å
 
©å
 = {

1058 .
£nd_cq
 = 
¥iv
->send_cq,

1059 .
ªcv_cq
 = 
¥iv
->recv_cq,

1060 .
§q
 = 
¥iv
->
cm
.srq,

1061 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1062 .
ˇp
.
max_£nd_sge
 = 1,

1063 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1064 .
qp_ty≥
 = 
IB_QPT_RC
,

1065 .
qp_c⁄ãxt
 = 
tx
,

1066 .
¸óã_Êags
 = 0

1068 
ib_qp
 *
tx_qp
;

1070 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1071 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1072 
MAX_SKB_FRAGS
 + 1);

1074 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1075 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1076  
tx_qp
;

1077 
	}
}

1079 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1080 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1081 
u32
 
q≤
,

1082 
ß_∑th_ªc
 *
∑thªc
)

1084 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1085 
ùoib_cm_d©a
 
d©a
 = {};

1086 
ib_cm_ªq_∑øm
 
ªq
 = {};

1088 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1089 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1091 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1092 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1093 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1094 
ªq
.
qp_num
 = 
qp
->qp_num;

1095 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1096 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1097 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1098 
ªq
.
Êow_c⁄åﬁ
 = 0;

1100 
ªq
.
°¨tög_p¢
 = 0;

1106 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1107 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1108 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
ªåy_cou¡
 = 0;

1110 
ªq
.
∫r_ªåy_cou¡
 = 0;

1111 
ªq
.
max_cm_ªåõs
 = 15;

1112 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1113  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1114 
	}
}

1116 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1117 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1119 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1120 
ib_qp_©å
 
qp_©å
;

1121 
qp_©å_mask
, 
ªt
;

1122 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1123 i‡(
ªt
) {

1124 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1125  
ªt
;

1128 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1129 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1130 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1131 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1133 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1134 i‡(
ªt
) {

1135 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1136  
ªt
;

1139 
	}
}

1141 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1142 
ß_∑th_ªc
 *
∑thªc
)

1144 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1145 
noio_Êag
;

1146 
ªt
;

1148 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1149 
p
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 * (*p->tx_ring));

1150 i‡(!
p
->
tx_rög
) {

1151 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1152 
ªt
 = -
ENOMEM
;

1153 
îr_tx
;

1156 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1157 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1158 i‡(
	`IS_ERR
(
p
->
qp
)) {

1159 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1160 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1161 
îr_qp
;

1164 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1165 i‡(
	`IS_ERR
(
p
->
id
)) {

1166 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1167 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1168 
îr_id
;

1171 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1172 i‡(
ªt
) {

1173 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1174 
îr_modify_£nd
;

1177 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1178 i‡(
ªt
) {

1179 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1180 
îr_modify_£nd
;

1183 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1184 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1188 
îr_modify_£nd
:

1189 
	`ib_de°roy_cm_id
(
p
->
id
);

1190 
îr_id
:

1191 
p
->
id
 = 
NULL
;

1192 
	`ib_de°roy_qp
(
p
->
qp
);

1193 
îr_qp
:

1194 
p
->
qp
 = 
NULL
;

1195 
	`v‰ì
(
p
->
tx_rög
);

1196 
îr_tx
:

1197  
ªt
;

1198 
	}
}

1200 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1202 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1203 
ùoib_tx_buf
 *
tx_ªq
;

1204 
begö
;

1206 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1207 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1209 i‡(
p
->
id
)

1210 
	`ib_de°roy_cm_id
(
p
->
id
);

1212 i‡(
p
->
tx_rög
) {

1214 
begö
 = 
jiffõs
;

1215 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1216 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1217 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1218 
p
->
tx_hód
 -Ö->
tx_èû
);

1219 
timeout
;

1222 
	`u¶ìp_ønge
(1000, 2000);

1226 
timeout
:

1228 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1229 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1230 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1231 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1232 
	`√tif_tx_lock_bh
(
p
->
dev
);

1233 ++
p
->
tx_èû
;

1234 ++
¥iv
->
tx_èû
;

1235 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1236 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1237 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1238 
	`√tif_wake_queue
(
p
->
dev
);

1239 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1242 i‡(
p
->
qp
)

1243 
	`ib_de°roy_qp
(
p
->
qp
);

1245 
	`v‰ì
(
p
->
tx_rög
);

1246 
	`k‰ì
(
p
);

1247 
	}
}

1249 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1250 c⁄° 
ib_cm_evít
 *
evít
)

1252 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1254 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1255 
ùoib_√igh
 *
√igh
;

1256 
Êags
;

1257 
ªt
;

1259 
evít
->event) {

1260 
IB_CM_DREQ_RECEIVED
:

1261 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1262 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1264 
IB_CM_REP_RECEIVED
:

1265 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1266 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1267 i‡(
ªt
)

1268 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1269 
NULL
, 0, NULL, 0);

1271 
IB_CM_REQ_ERROR
:

1272 
IB_CM_REJ_RECEIVED
:

1273 
IB_CM_TIMEWAIT_EXIT
:

1274 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1275 
	`√tif_tx_lock_bh
(
dev
);

1276 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1277 
√igh
 = 
tx
->neigh;

1279 i‡(
√igh
) {

1280 
√igh
->
cm
 = 
NULL
;

1281 
	`ùoib_√igh_‰ì
(
√igh
);

1283 
tx
->
√igh
 = 
NULL
;

1286 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1287 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1288 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1291 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1292 
	`√tif_tx_u∆ock_bh
(
dev
);

1299 
	}
}

1301 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1302 
ùoib_√igh
 *
√igh
)

1304 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1305 
ùoib_cm_tx
 *
tx
;

1307 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1308 i‡(!
tx
)

1309  
NULL
;

1311 
√igh
->
cm
 = 
tx
;

1312 
tx
->
√igh
 =Çeigh;

1313 
tx
->
dev
 = dev;

1314 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1315 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1316 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1317  
tx
;

1318 
	}
}

1320 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1322 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1323 
Êags
;

1324 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1325 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1326 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1327 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1328 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1329 
tx
->
√igh
->
daddr
 + 4);

1330 
tx
->
√igh
 = 
NULL
;

1331 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1333 
	}
}

1335 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1337 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1339 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1340 
cm
.
°¨t_èsk
);

1341 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1342 
ùoib_√igh
 *
√igh
;

1343 
ùoib_cm_tx
 *
p
;

1344 
Êags
;

1345 
ùoib_∑th
 *
∑th
;

1346 
ªt
;

1348 
ß_∑th_ªc
 
∑thªc
;

1349 
u32
 
q≤
;

1351 
	`√tif_tx_lock_bh
(
dev
);

1352 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1354 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1355 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1356 
	`li°_dñ_öô
(&
p
->
li°
);

1357 
√igh
 = 
p
->neigh;

1359 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1364 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1365 i‡(!
∑th
) {

1366 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1367 
__func__
,

1368 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1369 
‰ì_√igh
;

1371 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1373 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1374 
	`√tif_tx_u∆ock_bh
(
dev
);

1376 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1378 
	`√tif_tx_lock_bh
(
dev
);

1379 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1381 i‡(
ªt
) {

1382 
‰ì_√igh
:

1383 
√igh
 = 
p
->neigh;

1384 i‡(
√igh
) {

1385 
√igh
->
cm
 = 
NULL
;

1386 
	`ùoib_√igh_‰ì
(
√igh
);

1388 
	`li°_dñ
(&
p
->
li°
);

1389 
	`k‰ì
(
p
);

1393 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1394 
	`√tif_tx_u∆ock_bh
(
dev
);

1395 
	}
}

1397 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1399 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1400 
cm
.
ª≠_èsk
);

1401 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1402 
ùoib_cm_tx
 *
p
;

1403 
Êags
;

1405 
	`√tif_tx_lock_bh
(
dev
);

1406 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1408 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1409 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1410 
	`li°_dñ_öô
(&
p
->
li°
);

1411 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1412 
	`√tif_tx_u∆ock_bh
(
dev
);

1413 
	`ùoib_cm_tx_de°roy
(
p
);

1414 
	`√tif_tx_lock_bh
(
dev
);

1415 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1418 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1419 
	`√tif_tx_u∆ock_bh
(
dev
);

1420 
	}
}

1422 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1425 
cm
.
skb_èsk
);

1426 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1427 
sk_buff
 *
skb
;

1428 
Êags
;

1429 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1431 
	`√tif_tx_lock_bh
(
dev
);

1432 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1434 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1435 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1436 
	`√tif_tx_u∆ock_bh
(
dev
);

1438 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1439 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1440 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1442 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1443 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1444 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1445 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1448 
	`dev_k‰ì_skb_™y
(
skb
);

1450 
	`√tif_tx_lock_bh
(
dev
);

1451 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1454 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1455 
	`√tif_tx_u∆ock_bh
(
dev
);

1456 
	}
}

1458 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1459 
mtu
)

1461 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1462 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1464 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1466 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1467 i‡(
e
)

1468 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1469 
	}
}

1471 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1473 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1474 
cm
.
rx_ª≠_èsk
)->
dev
);

1475 
	}
}

1477 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1479 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1480 
cm
.
°Æe_èsk
.
w‹k
);

1481 
ùoib_cm_rx
 *
p
;

1482 
ªt
;

1484 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1485 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1488 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1489 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1491 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1492 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1493 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1494 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1495 i‡(
ªt
)

1496 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1497 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1500 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1501 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1502 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1503 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1504 
	}
}

1506 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1507 *
buf
)

1509 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1510 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1512 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1513  
	`•rötf
(
buf
, "connected\n");

1515  
	`•rötf
(
buf
, "datagram\n");

1516 
	}
}

1518 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1519 c⁄° *
buf
, 
size_t
 
cou¡
)

1521 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1522 
ªt
;

1524 i‡(!
	`π∆_åylock
()) {

1525  
	`ª°¨t_sysˇŒ
();

1528 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1529 
	`π∆_u∆ock
();

1530  -
EPERM
;

1533 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1539 i‡(
ªt
 !-
EBUSY
)

1540 
	`π∆_u∆ock
();

1542  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1543 
	}
}

1545 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1547 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1549  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1550 
	}
}

1552 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1554 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1555 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1556 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1557 .
©å
 = {

1558 .
max_wr
 = 
ùoib_ªcvq_size
,

1559 .
max_sge
 = max_sge

1563 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1564 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1565 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1566 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1567 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1568 
¥iv
->
cm
.
§q
 = 
NULL
;

1572 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *priv->cm.srq_ring);

1573 i‡(!
¥iv
->
cm
.
§q_rög
) {

1574 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1575 
¥iv
->
cm
.
§q
 = 
NULL
;

1579 
	}
}

1581 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1584 
max_§q_sge
, 
i
;

1586 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1587 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1593 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1594 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1597 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1599 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1601 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1603 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1604 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1605 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1606 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1607 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1608 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1609 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1611 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1612 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1615 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1617 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1618 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1619 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1620 
¥iv
->
cm
.
num_‰ags
 - 1,

1621 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1622 
GFP_KERNEL
)) {

1623 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1624 "ª˚ivêbuf„∏%d\n", 
i
);

1625 
	`ùoib_cm_dev_˛ónup
(
dev
);

1626  -
ENOMEM
;

1629 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1630 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1631 "Áûed f‹ bu‡%d\n", 
i
);

1632 
	`ùoib_cm_dev_˛ónup
(
dev
);

1633  -
EIO
;

1638 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1640 
	}
}

1642 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1645 
ªt
;

1647 i‡(!
¥iv
->
cm
.
§q
)

1650 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1652 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1653 i‡(
ªt
)

1654 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1656 
¥iv
->
cm
.
§q
 = 
NULL
;

1657 i‡(!
¥iv
->
cm
.
§q_rög
)

1660 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1661 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1662 
	}
}

	@SLES12SP5/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

141 
ETH_SS_TEST
:

145 
	}
}

146 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

147 
s£t
)

149 
s£t
) {

150 
ETH_SS_STATS
:

151  
IPOIB_GLOBAL_STATS_LEN
;

152 
ETH_SS_TEST
:

156  -
EOPNOTSUPP
;

157 
	}
}

160 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

162 
•ìd
) {

163 
IB_SPEED_SDR
:

164  
SPEED_2500
;

165 
IB_SPEED_DDR
:

166  
SPEED_5000
;

167 
IB_SPEED_QDR
:

168 
IB_SPEED_FDR10
:

169  
SPEED_10000
;

170 
IB_SPEED_FDR
:

171  
SPEED_14000
;

172 
IB_SPEED_EDR
:

173  
SPEED_25000
;

176  
SPEED_UNKNOWN
;

177 
	}
}

179 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

180 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

183 
ib_p‹t_©å
 
©å
;

184 
ªt
, 
•ìd
, 
width
;

186 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

187 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

188 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

192 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

193 i‡(
ªt
 < 0)

194  -
EINVAL
;

196 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

197 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

199 i‡(
•ìd
 < 0 || 
width
 < 0)

200  -
EINVAL
;

206 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

207 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

209 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

211 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

212 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

215 
	}
}

217 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

218 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

219 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

220 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

221 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

222 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

223 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

224 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

227 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

229 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

230 
	}
}

	@SLES12SP5/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@SLES12SP5/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
	`LIST_HEAD
(
ªmove_li°
);

673 
Êags
;

675 
	`√tif_tx_lock_bh
(
dev
);

676 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

678 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

679 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

680 
	`li°_dñ
(&
ah
->
li°
);

681 
	`rdma_de°roy_ah
(
ah
->ah, 0);

682 
	`k‰ì
(
ah
);

685 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

686 
	`√tif_tx_u∆ock_bh
(
dev
);

687 
	}
}

689 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

691 
ùoib_dev_¥iv
 *
¥iv
 =

692 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

693 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

695 
	`__ùoib_ª≠_ah
(
dev
);

697 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

698 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

699 
	`round_jiffõs_ªœtive
(
HZ
));

700 
	}
}

702 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

704 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

706 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

707 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

708 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

709 
	}
}

711 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

713 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

715 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

716 
	`ùoib_Êush_ah
(
dev
);

717 
	}
}

719 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

721 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

722 
≥ndög
 = 0;

723 
i
;

725 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

726 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

727 ++
≥ndög
;

729  
≥ndög
;

730 
	}
}

732 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

733 
ib_qp
 *
qp
,

734 
ib_qp_°©e
 
√w_°©e
)

736 
ib_qp_©å
 
qp_©å
;

737 
ib_qp_öô_©å
 
quîy_öô_©å
;

738 
ªt
;

740 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

741 i‡(
ªt
) {

742 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

746 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

747 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

749 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

750 
√w_°©e
, 
qp_©å
.
qp_°©e
);

751 
	}
}

753 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

755 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

757 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

758 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

759 
	}
}

761 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

763 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

765 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

766 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

767 
	}
}

769 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

771 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

772 
ib_qp_©å
 
qp_©å
;

773 
begö
;

774 
ùoib_tx_buf
 *
tx_ªq
;

775 
i
;

777 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

778 
	`ùoib_«pi_dißbÀ
(
dev
);

780 
	`ùoib_cm_dev_°›
(
dev
);

786 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

787 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

788 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

791 
begö
 = 
jiffõs
;

793 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

794 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

795 
	`ùoib_w¨n
(
¥iv
,

797 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

798 
	`ªcvs_≥ndög
(
dev
));

804 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

805 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

806 (
ùoib_£ndq_size
 - 1)];

807 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

808 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

809 ++
¥iv
->
tx_èû
;

812 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

813 
ùoib_rx_buf
 *
rx_ªq
;

815 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

816 i‡(!
rx_ªq
->
skb
)

818 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

819 
¥iv
->
rx_rög
[
i
].
m≠pög
);

820 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

821 
rx_ªq
->
skb
 = 
NULL
;

824 
timeout
;

827 
	`ùoib_døö_cq
(
dev
);

829 
	`u¶ìp_ønge
(1000, 2000);

832 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

834 
timeout
:

835 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

836 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

837 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

839 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

842 
	}
}

844 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

846 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

848 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

850 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

851 
	`ùoib_Êush_ah
(
dev
);

854 
	}
}

856 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

858 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

859 
ªt
;

861 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

862 i‡(
ªt
) {

863 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

867 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

868 i‡(
ªt
) {

869 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

870 
out
;

873 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

874 i‡(
ªt
) {

875 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

876 
out
;

879 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

880 
	`ùoib_«pi_íabÀ
(
dev
);

883 
out
:

885 
	}
}

887 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

889 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

891 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

893 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

894 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

895 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

899 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

900 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

901 
	`round_jiffõs_ªœtive
(
HZ
));

903 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

904 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

905 
dev_°›
;

908 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

912 
dev_°›
:

913 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

914 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

915 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

916 
	`ùoib_ib_dev_°›
(
dev
);

918 
	}
}

920 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

922 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

923 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

925 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

926 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

927 &
¥iv
->
pkey_ödex
)) {

928 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

930 i‡(
∫
->
£t_id
)

931 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

932 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

934 
	}
}

936 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

938 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

940 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

942 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

943 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

947 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

949 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

950 
	}
}

952 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

954 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

956 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

958 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

959 
	`√tif_ˇºõr_off
(
dev
);

961 
	`ùoib_mˇ°_°›_thªad
(
dev
);

962 
	`ùoib_mˇ°_dev_Êush
(
dev
);

964 
	`ùoib_Êush_∑ths
(
dev
);

965 
	}
}

967 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

969 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

970 
i
, 
n
;

977 
	`loˇl_bh_dißbÀ
();

980 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

981 
i
 = 0; i < 
n
; ++i) {

987 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

988 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

992 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

994 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

996 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

999 } 
n
 =
IPOIB_NUM_WC
);

1001 
	`pﬁl_tx
(
¥iv
))

1004 
	`loˇl_bh_íabÀ
();

1005 
	}
}

1011 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1013 
ªsu…
;

1014 
u16
 
¥ev_pkey
;

1016 
¥ev_pkey
 = 
¥iv
->
pkey
;

1017 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1018 i‡(
ªsu…
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1020 
¥iv
->
p‹t
, 
ªsu…
);

1021  
ªsu…
;

1024 
¥iv
->
pkey
 |= 0x8000;

1026 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1027 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1028 
¥ev_pkey
, 
¥iv
->
pkey
);

1033 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1034 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1039 
	}
}

1043 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1045 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1047 
¥iv
->
pkey_ödex
 = 0;

1048 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1050 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1051 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1054 
	}
}

1060 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1062 
ib_gid
 
£¨ch_gid
;

1063 
ib_gid
 
gid0
;

1064 
ib_gid
 *
√tdev_gid
;

1065 
îr
;

1066 
u16
 
ödex
;

1067 
u8
 
p‹t
;

1068 
boﬁ
 
ªt
 = 
Ál£
;

1070 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1071 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1072  
Ál£
;

1074 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1079 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1083 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1085 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1087 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1089 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1091 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1092 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1096 
out
;

1123 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1124 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1125 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1126 i‡(
ödex
 == 0)

1127 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1128 &
¥iv
->
Êags
);

1130 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1131 
ªt
 = 
åue
;

1133 
ªt
 = 
Ál£
;

1136 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1137 
ªt
 = 
åue
;

1139 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1140 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1141 (
¥iv
->
loˇl_gid
));

1142 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1143 (
¥iv
->
loˇl_gid
));

1144 
ªt
 = 
åue
;

1149 
out
:

1150 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1152  
ªt
;

1153 
	}
}

1155 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1156 
ùoib_Êush_Àvñ
 
Àvñ
,

1157 
√°ög
)

1159 
ùoib_dev_¥iv
 *
˝riv
;

1160 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1161 
ªsu…
;

1163 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1169 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1170 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1174 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1175 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1177 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1178 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1179 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1183 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1185 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1186 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1187 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1189 
	`upd©e_chûd_pkey
(
¥iv
);

1190 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1191 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1192 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1196 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1200 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1201 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1202 i‡(
ªsu…
) {

1204 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1209 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1211 i‡(
ªsu…
) {

1212 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1218 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1219 
›î_up
;

1220 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1226 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1227 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1228 i‡(
›î_up
)

1229 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1230 
	`ùoib_Êush_ah
(
dev
);

1233 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1234 
	`ùoib_ib_dev_down
(
dev
);

1236 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1237 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1238 
	`ùoib_ib_dev_°›
(
dev
);

1240 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1243 i‡(
	`√tif_queue_°›≥d
(
dev
))

1244 
	`√tif_°¨t_queue
(
dev
);

1251 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1252 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1253 
	`ùoib_ib_dev_up
(
dev
);

1254 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1255 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1257 
	}
}

1259 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1261 
ùoib_dev_¥iv
 *
¥iv
 =

1262 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1264 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1265 
	}
}

1267 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1269 
ùoib_dev_¥iv
 *
¥iv
 =

1270 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1272 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1273 
	}
}

1275 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1277 
ùoib_dev_¥iv
 *
¥iv
 =

1278 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1280 
	`π∆_lock
();

1281 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1282 
	`π∆_u∆ock
();

1283 
	}
}

1285 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1287 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1289 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1294 
	`ùoib_Êush_∑ths
(
dev
);

1296 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1297 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1305 
	`ùoib_°›_ah
(
dev
);

1307 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1309 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1311 i‡(
¥iv
->
pd
) {

1312 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1313 
¥iv
->
pd
 = 
NULL
;

1315 
	}
}

	@SLES12SP5/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

247 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

248  -
EINVAL
;

250 
¥iv
->
admö_mtu
 = 
√w_mtu
;

252 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

253 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

254 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

256 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

258 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

259 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

261 
	`√tif_ˇºõr_off
(
dev
);

264 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

266 i‡(
ˇºõr_°©us
)

267 
	`√tif_ˇºõr_⁄
(
dev
);

269 
dev
->
mtu
 = 
√w_mtu
;

272  
ªt
;

273 
	}
}

275 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

276 
π∆_lök_°©s64
 *
°©s
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

281 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

283 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

284 
	}
}

287 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

288 
√t_devi˚
 *
dev
)

290 
√t
 *√à
	`dev_√t
(
dev
);

291 
ö_devi˚
 *
ö_dev
;

292 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

293 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

294 
__be32
 
ªt_addr
;

296 
addr
->
ß_Ámûy
) {

297 
AF_INET
:

298 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

299 i‡(!
ö_dev
)

300  
Ál£
;

302 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

303 
addr_ö
->
sö_addr
.
s_addr
,

304 
RT_SCOPE_HOST
);

305 
	`ö_dev_put
(
ö_dev
);

306 i‡(
ªt_addr
)

307  
åue
;

310 
AF_INET6
:

311 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

312 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

313  
åue
;

317  
Ál£
;

318 
	}
}

327 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

329 
√t_devi˚
 *
ma°î
;

331 
	`rcu_ªad_lock
();

332 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

333 i‡(
ma°î
)

334 
	`dev_hﬁd
(
ma°î
);

335 
	`rcu_ªad_u∆ock
();

337 i‡(
ma°î
)

338  
ma°î
;

340 
	`dev_hﬁd
(
dev
);

341  
dev
;

342 
	}
}

344 
	sùoib_wÆk_d©a
 {

345 c⁄° 
sockaddr
 *
	maddr
;

346 
√t_devi˚
 *
	mªsu…
;

349 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

351 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

352 
ªt
 = 0;

354 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

355 
	`dev_hﬁd
(
uµî
);

356 
d©a
->
ªsu…
 = 
uµî
;

357 
ªt
 = 1;

360  
ªt
;

361 
	}
}

372 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

373 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

375 
ùoib_wÆk_d©a
 
d©a
 = {

376 .
addr
 =áddr,

379 
	`rcu_ªad_lock
();

380 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

381 
	`dev_hﬁd
(
dev
);

382 
d©a
.
ªsu…
 = 
dev
;

383 
out
;

386 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

387 
out
:

388 
	`rcu_ªad_u∆ock
();

389  
d©a
.
ªsu…
;

390 
	}
}

397 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

398 c⁄° 
ib_gid
 *
gid
,

399 
u16
 
pkey_ödex
,

400 c⁄° 
sockaddr
 *
addr
,

401 
√°ög
,

402 
√t_devi˚
 **
found_√t_dev
)

404 
ùoib_dev_¥iv
 *
chûd_¥iv
;

405 
√t_devi˚
 *
√t_dev
 = 
NULL
;

406 
m©ches
 = 0;

408 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

409 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

410 i‡(!
addr
) {

411 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

415 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

417 i‡(
√t_dev
) {

418 i‡(!*
found_√t_dev
)

419 *
found_√t_dev
 = 
√t_dev
;

421 
	`dev_put
(
√t_dev
);

422 ++
m©ches
;

427 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

428 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

429 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

430 
pkey_ödex
, 
addr
,

431 
√°ög
 + 1,

432 
found_√t_dev
);

433 i‡(
m©ches
 > 1)

436 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

438  
m©ches
;

439 
	}
}

444 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

445 
u16
 
pkey_ödex
,

446 c⁄° 
ib_gid
 *
gid
,

447 c⁄° 
sockaddr
 *
addr
,

448 
√t_devi˚
 **
√t_dev
)

450 
ùoib_dev_¥iv
 *
¥iv
;

451 
m©ches
 = 0;

453 *
√t_dev
 = 
NULL
;

455 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

456 i‡(
¥iv
->
p‹t
 !=Öort)

459 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

460 
addr
, 0, 
√t_dev
);

461 i‡(
m©ches
 > 1)

465  
m©ches
;

466 
	}
}

468 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

469 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

470 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

471 *
˛õ¡_d©a
)

473 
√t_devi˚
 *
√t_dev
;

474 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

475 
u16
 
pkey_ödex
;

476 
m©ches
;

477 
ªt
;

479 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

480  
NULL
;

482 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

483 i‡(
ªt
)

484  
NULL
;

486 i‡(!
dev_li°
)

487  
NULL
;

490 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

491 
gid
, 
NULL
, &
√t_dev
);

493 
m©ches
) {

495  
NULL
;

497  
√t_dev
;

500 
	`dev_put
(
√t_dev
);

504 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

505 
gid
, 
addr
, &
√t_dev
);

506 
m©ches
) {

508  
NULL
;

510 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

514  
√t_dev
;

516 
	}
}

518 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

522 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

523 !
	`°rcmp
(
buf
, "connected\n")) ||

524 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "datagram\n"))) {

530 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

531 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

532 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

534 
	`√tdev_upd©e_„©uªs
(
dev
);

535 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

536 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

537 
	`π∆_u∆ock
();

538 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

540 
	`ùoib_Êush_∑ths
(
dev
);

541  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

544 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

545 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

546 
	`√tdev_upd©e_„©uªs
(
dev
);

547 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

548 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

549 
	`π∆_u∆ock
();

550 
	`ùoib_Êush_∑ths
(
dev
);

551  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

554  -
EINVAL
;

555 
	}
}

557 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

560 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

561 
ùoib_∑th
 *
∑th
;

562 
ªt
;

564 
n
) {

565 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

567 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

568  (
ib_gid
));

570 i‡(
ªt
 < 0)

571 
n
 =Ç->
rb_À·
;

572 i‡(
ªt
 > 0)

573 
n
 =Ç->
rb_right
;

575  
∑th
;

578  
NULL
;

579 
	}
}

581 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

584 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

585 
rb_node
 *
≤
 = 
NULL
;

586 
ùoib_∑th
 *
ç©h
;

587 
ªt
;

589 *
n
) {

590 
≤
 = *
n
;

591 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

593 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

594  (
ib_gid
));

595 i‡(
ªt
 < 0)

596 
n
 = &
≤
->
rb_À·
;

597 i‡(
ªt
 > 0)

598 
n
 = &
≤
->
rb_right
;

600  -
EEXIST
;

603 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

604 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

606 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

609 
	}
}

611 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

613 
sk_buff
 *
skb
;

615 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

616 
	`dev_k‰ì_skb_úq
(
skb
);

618 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

621 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

623 i‡(
∑th
->
ah
)

624 
	`ùoib_put_ah
(
∑th
->
ah
);

626 
	`k‰ì
(
∑th
);

627 
	}
}

629 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


631 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

633 
ùoib_∑th_ôî
 *
ôî
;

635 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

636 i‡(!
ôî
)

637  
NULL
;

639 
ôî
->
dev
 = dev;

640 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

642 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

643 
	`k‰ì
(
ôî
);

644  
NULL
;

647  
ôî
;

648 
	}
}

650 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

653 
rb_node
 *
n
;

654 
ùoib_∑th
 *
∑th
;

655 
ªt
 = 1;

657 
	`•ö_lock_úq
(&
¥iv
->
lock
);

659 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

661 
n
) {

662 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

664 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

665  (
ib_gid
)) < 0) {

666 
ôî
->
∑th
 = *path;

667 
ªt
 = 0;

671 
n
 = 
	`rb_√xt
(n);

674 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676  
ªt
;

677 
	}
}

679 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

680 
ùoib_∑th
 *
∑th
)

682 *
∑th
 = 
ôî
->path;

683 
	}
}

687 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

690 
ùoib_∑th
 *
∑th
, *
ç
;

692 
	`•ö_lock_úq
(&
¥iv
->
lock
);

694 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

695 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

696 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

697 
∑th
->
∑thªc
.
dgid
.
øw
);

698 i‡(
∑th
->
ah
)

699 
∑th
->
ah
->
vÆid
 = 0;

702 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

703 
	}
}

705 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

707 
ùoib_p£udo_hódî
 *
phdr
;

709 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

710 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

711 
	}
}

713 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

715 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
ùoib_∑th
 *
∑th
, *
ç
;

717 
	`LIST_HEAD
(
ªmove_li°
);

718 
Êags
;

720 
	`√tif_tx_lock_bh
(
dev
);

721 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

723 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

725 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

726 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

728 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

729 i‡(
∑th
->
quîy
)

730 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

731 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

732 
	`√tif_tx_u∆ock_bh
(
dev
);

733 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

734 
	`∑th_‰ì
(
dev
, 
∑th
);

735 
	`√tif_tx_lock_bh
(
dev
);

736 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	}
}

743 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

744 
ß_∑th_ªc
 *
∑thªc
,

745 *
∑th_±r
)

747 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

748 
√t_devi˚
 *
dev
 = 
∑th
->dev;

749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

750 
ùoib_ah
 *
ah
 = 
NULL
;

751 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

752 
ùoib_√igh
 *
√igh
, *
ä
;

753 
sk_buff_hód
 
skqueue
;

754 
sk_buff
 *
skb
;

755 
Êags
;

757 i‡(!
°©us
)

758 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

759 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

760 
∑thªc
->
dgid
.
øw
);

762 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

763 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

765 
	`skb_queue_hód_öô
(&
skqueue
);

767 i‡(!
°©us
) {

768 
rdma_ah_©å
 
av
;

770 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

771 
∑thªc
, &
av
, 
NULL
)) {

772 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

773 
	`rdma_de°roy_ah_©å
(&
av
);

777 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

779 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

785 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

786 (
ib_gid
))) {

787 
	`ùoib_dbg
(

788 
¥iv
,

790 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

791 
∑th
->
∑thªc
.
dgid
.
øw
);

792 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

793 (
ib_gid
));

796 
∑th
->
∑thªc
 = *pathrec;

798 
ﬁd_ah
 = 
∑th
->
ah
;

799 
∑th
->
ah
 =áh;

801 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

802 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

803 
∑thªc
->
¶
);

805 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

806 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

808 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

809 i‡(
√igh
->
ah
) {

810 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

818 
	`ùoib_put_ah
(
√igh
->
ah
);

820 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

821 
√igh
->
ah
 = 
∑th
->ah;

823 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

824 i‡(!
	`ùoib_cm_gë
(
√igh
))

825 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

826 
∑th
,

827 
√igh
));

828 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

829 
	`ùoib_√igh_‰ì
(
√igh
);

834 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

835 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

837 
∑th
->
ah
->
vÆid
 = 1;

840 
∑th
->
quîy
 = 
NULL
;

841 
	`com∂ëe
(&
∑th
->
d⁄e
);

843 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 i‡(
	`IS_ERR_OR_NULL
(
ah
))

846 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

848 i‡(
ﬁd_ah
)

849 
	`ùoib_put_ah
(
ﬁd_ah
);

851 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

852 
ªt
;

853 
skb
->
dev
 = dev;

854 
ªt
 = 
	`dev_queue_xmô
(
skb
);

855 i‡(
ªt
)

856 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

857 
__func__
, 
ªt
);

859 
	}
}

861 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

862 *
gid
)

864 
∑th
->
dev
 = 
¥iv
->dev;

866 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

867 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

871 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

872 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

873 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

874 
∑th
->
∑thªc
.
numb_∑th
 = 1;

875 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

876 
	}
}

878 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

880 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

881 
ùoib_∑th
 *
∑th
;

883 i‡(!
¥iv
->
brﬂdˇ°
)

884  
NULL
;

886 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

887 i‡(!
∑th
)

888  
NULL
;

890 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

892 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

894 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

896  
∑th
;

897 
	}
}

899 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

900 
ùoib_∑th
 *
∑th
)

902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

905 
∑th
->
∑thªc
.
dgid
.
øw
);

907 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

909 
∑th
->
quîy_id
 =

910 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

911 &
∑th
->
∑thªc
,

912 
IB_SA_PATH_REC_DGID
 |

913 
IB_SA_PATH_REC_SGID
 |

914 
IB_SA_PATH_REC_NUMB_PATH
 |

915 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

916 
IB_SA_PATH_REC_PKEY
,

917 1000, 
GFP_ATOMIC
,

918 
∑th_ªc_com∂ëi⁄
,

919 
∑th
, &∑th->
quîy
);

920 i‡(
∑th
->
quîy_id
 < 0) {

921 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

922 
∑th
->
quîy
 = 
NULL
;

923 
	`com∂ëe
(&
∑th
->
d⁄e
);

924  
∑th
->
quîy_id
;

928 
	}
}

930 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

931 
√t_devi˚
 *
dev
)

933 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

934 
ùoib_∑th
 *
∑th
;

935 
Êags
;

937 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

939 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

940 i‡(!
∑th
)

941 
out
;

942 i‡(!
∑th
->
quîy
)

943 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

944 
out
:

945 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

946 
	}
}

948 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

949 
√t_devi˚
 *
dev
)

951 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

952 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

953 
ùoib_∑th
 *
∑th
;

954 
ùoib_√igh
 *
√igh
;

955 
Êags
;

957 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

958 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

959 i‡(!
√igh
) {

960 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

961 ++
dev
->
°©s
.
tx_dr›≥d
;

962 
	`dev_k‰ì_skb_™y
(
skb
);

963  
NULL
;

969 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

970 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

971  
√igh
;

974 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

975 i‡(!
∑th
) {

976 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
)

978 
îr_∑th
;

980 
	`__∑th_add
(
dev
, 
∑th
);

983 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

985 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

986 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

987 
√igh
->
ah
 = 
∑th
->ah;

989 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

990 i‡(!
	`ùoib_cm_gë
(
√igh
))

991 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

992 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

993 
	`ùoib_√igh_‰ì
(
√igh
);

994 
îr_dr›
;

996 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

997 
IPOIB_MAX_PATH_REC_QUEUE
) {

998 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

999 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1001 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1002 
	`skb_queue_Àn
(&
√igh
->
queue
));

1003 
îr_dr›
;

1006 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1007 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1008 
	`IPOIB_QPN
(
daddr
));

1009 
	`ùoib_√igh_put
(
√igh
);

1010  
NULL
;

1013 
√igh
->
ah
 = 
NULL
;

1015 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1016 
îr_∑th
;

1017 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1018 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1019 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1021 
îr_dr›
;

1025 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1026 
	`ùoib_√igh_put
(
√igh
);

1027  
NULL
;

1029 
îr_∑th
:

1030 
	`ùoib_√igh_‰ì
(
√igh
);

1031 
îr_dr›
:

1032 ++
dev
->
°©s
.
tx_dr›≥d
;

1033 
	`dev_k‰ì_skb_™y
(
skb
);

1035 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1036 
	`ùoib_√igh_put
(
√igh
);

1038  
NULL
;

1039 
	}
}

1041 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1042 
ùoib_p£udo_hódî
 *
phdr
)

1044 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1045 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1046 
ùoib_∑th
 *
∑th
;

1047 
Êags
;

1049 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1052 i‡(!
¥iv
->
brﬂdˇ°
)

1053 
dr›_™d_u∆ock
;

1055 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1056 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1057 i‡(!
∑th
) {

1058 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1059 i‡(!
∑th
)

1060 
dr›_™d_u∆ock
;

1061 
	`__∑th_add
(
dev
, 
∑th
);

1067 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
dr›_™d_u∆ock
;

1073 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1074 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1075 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1076 
u∆ock
;

1078 
dr›_™d_u∆ock
;

1082 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1083 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1084 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1089 
dr›_™d_u∆ock
:

1090 ++
dev
->
°©s
.
tx_dr›≥d
;

1091 
	`dev_k‰ì_skb_™y
(
skb
);

1092 
u∆ock
:

1093 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1094 
	}
}

1096 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1098 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1099 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1100 
ùoib_√igh
 *
√igh
;

1101 
ùoib_p£udo_hódî
 *
phdr
;

1102 
ùoib_hódî
 *
hódî
;

1103 
Êags
;

1105 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1106 
	`skb_puŒ
(
skb
, (*
phdr
));

1107 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1109 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1111 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1117 ++
dev
->
°©s
.
tx_dr›≥d
;

1118 
	`dev_k‰ì_skb_™y
(
skb
);

1119  
NETDEV_TX_OK
;

1122 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1123 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1125 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1126 i‡(
	`likñy
(
√igh
))

1127 
£nd_usög_√igh
;

1128 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1129  
NETDEV_TX_OK
;

1133 
hódî
->
¥Ÿo
) {

1134 
	`ht⁄s
(
ETH_P_IP
):

1135 
	`ht⁄s
(
ETH_P_IPV6
):

1136 
	`ht⁄s
(
ETH_P_TIPC
):

1137 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1138 i‡(
	`u∆ikñy
(!
√igh
)) {

1139 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1140 i‡(
	`likñy
(!
√igh
))

1141  
NETDEV_TX_OK
;

1144 
	`ht⁄s
(
ETH_P_ARP
):

1145 
	`ht⁄s
(
ETH_P_RARP
):

1147 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1148  
NETDEV_TX_OK
;

1151 ++
dev
->
°©s
.
tx_dr›≥d
;

1152 
	`dev_k‰ì_skb_™y
(
skb
);

1153  
NETDEV_TX_OK
;

1156 
£nd_usög_√igh
:

1158 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1159 i‡(
	`ùoib_cm_up
(
√igh
)) {

1160 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1161 
uƒef
;

1163 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1164 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1165 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1166 
uƒef
;

1167 } i‡(
√igh
->
ah
) {

1168 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1171 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1172 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1173 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1174 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1175 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1177 ++
dev
->
°©s
.
tx_dr›≥d
;

1178 
	`dev_k‰ì_skb_™y
(
skb
);

1181 
uƒef
:

1182 
	`ùoib_√igh_put
(
√igh
);

1184  
NETDEV_TX_OK
;

1185 
	}
}

1187 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1191 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1192 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1193 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1194 
	`√tif_queue_°›≥d
(
dev
),

1195 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1197 
	}
}

1199 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1200 
√t_devi˚
 *
dev
,

1201 
ty≥
,

1202 c⁄° *
daddr
,

1203 c⁄° *
ßddr
,

1204 
Àn
)

1206 
ùoib_hódî
 *
hódî
;

1208 
hódî
 = 
	`skb_push
(
skb
, (*header));

1210 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1211 
hódî
->
ª£rved
 = 0;

1218 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1220  
IPOIB_HARD_LEN
;

1221 
	}
}

1223 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1225 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1227 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1228 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1232 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1233 
	}
}

1235 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1240 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1241  
dev
->
ifödex
;

1244  
¥iv
->
∑ª¡
->
ifödex
;

1245 
	}
}

1247 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1256 
u32
 *
d32
 = (u32 *Ë
daddr
;

1257 
u32
 
hv
;

1259 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1260  
hv
 & 
htbl
->
mask
;

1261 
	}
}

1263 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1265 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1266 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1267 
ùoib_√igh_hash
 *
htbl
;

1268 
ùoib_√igh
 *
√igh
 = 
NULL
;

1269 
u32
 
hash_vÆ
;

1271 
	`rcu_ªad_lock_bh
();

1273 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1275 i‡(!
htbl
)

1276 
out_u∆ock
;

1278 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1279 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1280 
√igh
 !
NULL
;

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1282 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1284 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1286 
√igh
 = 
NULL
;

1287 
out_u∆ock
;

1290 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1291 
√igh
->
Æive
 = 
jiffõs
;

1292 
out_u∆ock
;

1296 
out_u∆ock
:

1297 
	`rcu_ªad_u∆ock_bh
();

1298  
√igh
;

1299 
	}
}

1301 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1303 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1304 
ùoib_√igh_hash
 *
htbl
;

1305 
√igh_obsﬁëe
;

1306 
dt
;

1307 
Êags
;

1308 
i
;

1309 
	`LIST_HEAD
(
ªmove_li°
);

1311 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1313 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1314 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1316 i‡(!
htbl
)

1317 
out_u∆ock
;

1320 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1321 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1323 
i
 = 0; i < 
htbl
->
size
; i++) {

1324 
ùoib_√igh
 *
√igh
;

1325 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1327 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1328 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1330 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1332 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1334 
	`rcu_assign_poöãr
(*
≈
,

1335 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1338 
	`li°_dñ_öô
(&
√igh
->
li°
);

1339 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1341 
≈
 = &
√igh
->
h√xt
;

1347 
out_u∆ock
:

1348 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1349 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1350 
	}
}

1352 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1354 
ùoib_dev_¥iv
 *
¥iv
 =

1355 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1357 
	`__ùoib_ª≠_√igh
(
¥iv
);

1359 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1360 
¨p_tbl
.
gc_öãrvÆ
);

1361 
	}
}

1364 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1365 
√t_devi˚
 *
dev
)

1367 
ùoib_√igh
 *
√igh
;

1369 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1370 i‡(!
√igh
)

1371  
NULL
;

1373 
√igh
->
dev
 = dev;

1374 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1375 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1376 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1377 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1379 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1381  
√igh
;

1382 
	}
}

1384 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1385 
√t_devi˚
 *
dev
)

1387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1388 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1389 
ùoib_√igh_hash
 *
htbl
;

1390 
ùoib_√igh
 *
√igh
;

1391 
u32
 
hash_vÆ
;

1393 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1394 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1395 i‡(!
htbl
) {

1396 
√igh
 = 
NULL
;

1397 
out_u∆ock
;

1403 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1406 
√igh
 !
NULL
;

1407 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1408 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1409 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1411 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1413 
√igh
 = 
NULL
;

1416 
√igh
->
Æive
 = 
jiffõs
;

1417 
out_u∆ock
;

1421 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1422 i‡(!
√igh
)

1423 
out_u∆ock
;

1426 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1427 
√igh
->
Æive
 = 
jiffõs
;

1429 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1430 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1431 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1432 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1433 
	`©omic_öc
(&
¡bl
->
íåõs
);

1435 
out_u∆ock
:

1437  
√igh
;

1438 
	}
}

1440 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1443 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1444 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1445 
sk_buff
 *
skb
;

1446 i‡(
√igh
->
ah
)

1447 
	`ùoib_put_ah
(
√igh
->
ah
);

1448 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1449 ++
dev
->
°©s
.
tx_dr›≥d
;

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 i‡(
	`ùoib_cm_gë
(
√igh
))

1453 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1454 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1456 
	`IPOIB_QPN
(
√igh
->
daddr
),

1457 
√igh
->
daddr
 + 4);

1458 
	`k‰ì
(
√igh
);

1459 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1460 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1461 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1463 
	}
}

1465 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1468 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1470 
	`ùoib_√igh_put
(
√igh
);

1471 
	}
}

1473 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1475 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1477 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1478 
ùoib_√igh_hash
 *
htbl
;

1479 
ùoib_√igh
 
__rcu
 **
≈
;

1480 
ùoib_√igh
 *
n
;

1481 
u32
 
hash_vÆ
;

1483 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1484 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1485 i‡(!
htbl
)

1488 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1489 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1492 
n
 !
NULL
;

1493 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1494 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1495 i‡(
n
 =
√igh
) {

1497 
	`rcu_assign_poöãr
(*
≈
,

1498 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1499 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1501 
	`li°_dñ_öô
(&
√igh
->
li°
);

1502 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1505 
≈
 = &
n
->
h√xt
;

1508 
	}
}

1510 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1512 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1513 
ùoib_√igh_hash
 *
htbl
;

1514 
ùoib_√igh
 
__rcu
 **
buckës
;

1515 
u32
 
size
;

1517 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1518 
¡bl
->
htbl
 = 
NULL
;

1519 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1520 i‡(!
htbl
)

1521  -
ENOMEM
;

1522 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1523 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1524 i‡(!
buckës
) {

1525 
	`k‰ì
(
htbl
);

1526  -
ENOMEM
;

1528 
htbl
->
size
 = size;

1529 
htbl
->
mask
 = (
size
 - 1);

1530 
htbl
->
buckës
 = buckets;

1531 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1532 
htbl
->
¡bl
 =Çtbl;

1533 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1536 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1537 
¨p_tbl
.
gc_öãrvÆ
);

1540 
	}
}

1542 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1544 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1545 
ùoib_√igh_hash
,

1546 
rcu
);

1547 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1548 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1550 
	`kv‰ì
(
buckës
);

1551 
	`k‰ì
(
htbl
);

1552 
	`com∂ëe
(&
¡bl
->
dñëed
);

1553 
	}
}

1555 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1557 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1558 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1559 
ùoib_√igh_hash
 *
htbl
;

1560 
Êags
;

1561 
i
;

1564 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1566 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1567 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1569 i‡(!
htbl
)

1570 
out_u∆ock
;

1572 
i
 = 0; i < 
htbl
->
size
; i++) {

1573 
ùoib_√igh
 *
√igh
;

1574 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1576 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1577 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1579 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1580 
	`rcu_assign_poöãr
(*
≈
,

1581 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1582 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1584 
	`li°_dñ_öô
(&
√igh
->
li°
);

1585 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1587 
≈
 = &
√igh
->
h√xt
;

1592 
out_u∆ock
:

1593 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1594 
	}
}

1596 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1598 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1599 
ùoib_√igh_hash
 *
htbl
;

1600 
Êags
;

1601 
i
, 
waô_Êushed
 = 0;

1603 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1604 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1608 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1609 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1610 i‡(!
htbl
)

1611 
out_u∆ock
;

1613 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1614 i‡(!
waô_Êushed
)

1615 
‰ì_htbl
;

1617 
i
 = 0; i < 
htbl
->
size
; i++) {

1618 
ùoib_√igh
 *
√igh
;

1619 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1621 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1623 
	`rcu_assign_poöãr
(*
≈
,

1624 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1625 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1627 
	`li°_dñ_öô
(&
√igh
->
li°
);

1628 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1632 
‰ì_htbl
:

1633 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1634 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1636 
out_u∆ock
:

1637 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1638 i‡(
waô_Êushed
)

1639 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1640 
	}
}

1642 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1647 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1649 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1651 
	`ùoib_Êush_√ighs
(
¥iv
);

1653 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1654 
	}
}

1656 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1660 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1661 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1662 
	}
}

1664 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1666 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1668 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1669 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1670 
	}
}

1672 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1674 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1676 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1678 
	`ùoib_«pi_dñ
(
dev
);

1680 
	`ùoib_cm_dev_˛ónup
(
dev
);

1682 
	`k‰ì
(
¥iv
->
rx_rög
);

1683 
	`v‰ì
(
¥iv
->
tx_rög
);

1685 
¥iv
->
rx_rög
 = 
NULL
;

1686 
¥iv
->
tx_rög
 = 
NULL
;

1687 
	}
}

1689 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1693 
	`ùoib_«pi_add
(
dev
);

1696 
¥iv
->
rx_rög
 = 
	`kzÆloc
(
ùoib_ªcvq_size
 *  *priv->rx_ring,

1697 
GFP_KERNEL
);

1698 i‡(!
¥iv
->
rx_rög
)

1699 
out
;

1701 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 *  *priv->tx_ring);

1702 i‡(!
¥iv
->
tx_rög
) {

1703 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1704 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1705 
out_rx_rög_˛ónup
;

1710 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1711 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1712 
¥iv
->
ˇ
->
«me
);

1713 
out_tx_rög_˛ónup
;

1717 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1718 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1719 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1723 
out_tx_rög_˛ónup
:

1724 
	`v‰ì
(
¥iv
->
tx_rög
);

1726 
out_rx_rög_˛ónup
:

1727 
	`k‰ì
(
¥iv
->
rx_rög
);

1729 
out
:

1730 
	`ùoib_«pi_dñ
(
dev
);

1731  -
ENOMEM
;

1732 
	}
}

1734 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1735 
cmd
)

1737 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1739 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1740  -
EOPNOTSUPP
;

1742  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1743 
	}
}

1745 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1747 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1748 
ªt
 = -
ENOMEM
;

1750 
¥iv
->
qp
 = 
NULL
;

1756 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1757 i‡(!
¥iv
->
wq
) {

1758 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1759 
out
;

1763 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1764 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1765 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1766 
˛ón_wq
;

1769 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1770 i‡(
ªt
) {

1771 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1772 
out_‰ì_pd
;

1775 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1776 i‡(
ªt
) {

1777 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1778 
out_dev_unöô
;

1781 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1782 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1783 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1784 
ªt
 = -
ENODEV
;

1785 
out_hash_unöô
;

1791 
out_hash_unöô
:

1792 
	`ùoib_√igh_hash_unöô
(
dev
);

1794 
out_dev_unöô
:

1795 
	`ùoib_ib_dev_˛ónup
(
dev
);

1797 
out_‰ì_pd
:

1798 i‡(
¥iv
->
pd
) {

1799 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1800 
¥iv
->
pd
 = 
NULL
;

1803 
˛ón_wq
:

1804 i‡(
¥iv
->
wq
) {

1805 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1806 
¥iv
->
wq
 = 
NULL
;

1809 
out
:

1810  
ªt
;

1811 
	}
}

1817 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1819 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1825 
	`π∆_lock
();

1826 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

1827 
	`π∆_u∆ock
();

1830 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1836 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1837 
	}
}

1839 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1841 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1843 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1844 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1846 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1847 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1849 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1851 
	}
}

1853 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1855 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1856 
ib_p‹t_©å
 
©å
;

1857 
ªsu…
;

1859 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1860 i‡(
ªsu…
) {

1861 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1862 
¥iv
->
p‹t
);

1863  
ªsu…
;

1865 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1866 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1868 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1870 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1871 i‡(
ªsu…
) {

1872 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1873 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1874  
ªsu…
;

1877 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1878 i‡(
ªsu…
) {

1879 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1880 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1881  
ªsu…
;

1883 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1884 (
ib_gid
));

1886 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1887 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1889 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1892 
	}
}

1894 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1896 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1897 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1899 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1900 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1901 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1902 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1903 
	}
}

1905 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1907 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1908 
rdma_√tdev
 *
∫
;

1909 
rc
;

1911 i‡(
¥iv
->
∑ª¡
) {

1912 
	`ùoib_chûd_öô
(
ndev
);

1914 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1915 i‡(
rc
)

1916  
rc
;

1920 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1921 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1922 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1923 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1924 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1926 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1932 
¥iv
->
pkey
 |= 0x8000;

1934 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1935 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1936 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1938 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1940 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1941 i‡(
rc
) {

1942 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1943 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1944  
rc
;

1947 i‡(
¥iv
->
∑ª¡
) {

1948 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1950 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1952 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1953 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1954 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1958 
	}
}

1960 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1962 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1964 
	`ASSERT_RTNL
();

1970 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1972 i‡(
¥iv
->
∑ª¡
) {

1973 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1975 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1976 
	`li°_dñ
(&
¥iv
->
li°
);

1977 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1980 
	`ùoib_√igh_hash_unöô
(
dev
);

1982 
	`ùoib_ib_dev_˛ónup
(
dev
);

1985 i‡(
¥iv
->
wq
) {

1986 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1987 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1988 
¥iv
->
wq
 = 
NULL
;

1991 i‡(
¥iv
->
∑ª¡
)

1992 
	`dev_put
(
¥iv
->
∑ª¡
);

1993 
	}
}

1995 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1997 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1999  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2000 
	}
}

2002 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2003 
iÊa_vf_öfo
 *
ivf
)

2005 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2006 
îr
;

2008 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2009 i‡(
îr
)

2010  
îr
;

2012 
ivf
->
vf
 = vf;

2015 
	}
}

2017 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2019 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2021 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2022  -
EINVAL
;

2024  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2025 
	}
}

2027 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2028 
iÊa_vf_°©s
 *
vf_°©s
)

2030 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2032  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2033 
	}
}

2035 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2036 .
¸óã
 = 
ùoib_h¨d_hódî
,

2039 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2040 .
ndo_öô
 = 
ùoib_ndo_öô
,

2041 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2042 .
	gndo_›í
 = 
ùoib_›í
,

2043 .
	gndo_°›
 = 
ùoib_°›
,

2044 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2045 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2046 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2047 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2048 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2049 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2050 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2051 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2052 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2053 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2054 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2055 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2056 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2059 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2060 .
ndo_öô
 = 
ùoib_ndo_öô
,

2061 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2062 .
	gndo_›í
 = 
ùoib_›í
,

2063 .
	gndo_°›
 = 
ùoib_°›
,

2064 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2065 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2066 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2067 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2068 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2069 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2070 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2071 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2074 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2075 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2076 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2077 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2078 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2081 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2083 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2084 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2086 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2088 
dev
->
w©chdog_timeo
 = 
HZ
;

2090 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2092 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2093 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2094 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2095 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2096 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2097 
NETIF_F_HIGHDMA
);

2098 
	`√tif_kìp_d°
(
dev
);

2100 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2107 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2108 
	}
}

2110 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2112 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2114 
¥iv
->
dev
 = dev;

2115 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2116 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2117 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2119 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2120 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2121 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2122 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2124 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2125 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2126 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2127 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2128 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2129 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2130 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2131 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2132 
	}
}

2134 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2135 c⁄° *
«me
)

2137 
√t_devi˚
 *
dev
;

2139 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2140 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2141 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2142  
dev
;

2144 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2145 
ùoib_£tup_comm⁄
);

2146 i‡(!
dev
)

2147  
	`ERR_PTR
(-
ENOMEM
);

2148  
dev
;

2149 
	}
}

2151 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2152 
√t_devi˚
 *
dev
)

2154 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2155 
ùoib_dev_¥iv
 *
¥iv
;

2156 
rc
;

2158 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2159 i‡(!
¥iv
)

2160  -
ENOMEM
;

2162 
¥iv
->
ˇ
 = 
hˇ
;

2163 
¥iv
->
p‹t
 =Öort;

2165 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2166 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2167 i‡(
rc
) {

2168 i‡(
rc
 !-
EOPNOTSUPP
)

2169 
out
;

2171 
∫
->
£nd
 = 
ùoib_£nd
;

2172 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2173 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2174 
∫
->
hˇ
 = hca;

2177 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2179 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2180 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2182 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2184 
∫
->
˛¡_¥iv
 = 
¥iv
;

2190 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2191 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2193 
	`ùoib_buûd_¥iv
(
dev
);

2197 
out
:

2198 
	`k‰ì
(
¥iv
);

2199  
rc
;

2200 
	}
}

2202 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2203 c⁄° *
«me
)

2205 
√t_devi˚
 *
dev
;

2206 
rc
;

2208 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2209 i‡(
	`IS_ERR
(
dev
))

2210  
dev
;

2212 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2213 i‡(
rc
) {

2214 
	`‰ì_√tdev
(
dev
);

2215  
	`ERR_PTR
(
rc
);

2223  
dev
;

2224 
	}
}

2226 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2228 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2229 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2231 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2232 i‡(
dev
->
¥iv_de°ru˘‹
)

2233 
dev
->
	`¥iv_de°ru˘‹
(dev);

2239 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2242 
∫
->
˛¡_¥iv
 = 
NULL
;

2244 
	`k‰ì
(
¥iv
);

2245 
	}
}

2247 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2248 
devi˚_©åibuã
 *
©å
, *
buf
)

2250 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2251 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2253  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2254 
	}
}

2255 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2257 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2258 
devi˚_©åibuã
 *
©å
, *
buf
)

2260 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2261 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2263  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2264 
	}
}

2266 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2268 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2270 i‡(
umˇ°_vÆ
 > 0) {

2271 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2272 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2275 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2276 
	}
}

2278 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2279 
devi˚_©åibuã
 *
©å
,

2280 c⁄° *
buf
, 
size_t
 
cou¡
)

2282 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2284 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2286  
cou¡
;

2287 
	}
}

2288 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2290 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2292  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2293 
	}
}

2295 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2297 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2298 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2300 
	`√tif_addr_lock_bh
(
√tdev
);

2302 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2303 &
gid
->
globÆ
.
öãrÁ˚_id
,

2304 (
gid
->
globÆ
.
öãrÁ˚_id
));

2305 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2306 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2308 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2310 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2311 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2312 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2313 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2314 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2316 
	}
}

2318 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2319 
sockaddr_°‹age
 *
ss
)

2321 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2322 
ªt
 = 0;

2324 
	`√tif_addr_lock_bh
(
dev
);

2329 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2330 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2331 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2332 
ªt
 = -
EINVAL
;

2334 
	`√tif_addr_u∆ock_bh
(
dev
);

2336  
ªt
;

2337 
	}
}

2339 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2341 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2342 
sockaddr_°‹age
 *
ss
 = 
addr
;

2343 
ªt
;

2345 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2346  -
EBUSY
;

2348 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2349 i‡(
ªt
)

2350  
ªt
;

2352 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2354 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2357 
	}
}

2359 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2360 
devi˚_©åibuã
 *
©å
,

2361 c⁄° *
buf
, 
size_t
 
cou¡
)

2363 
pkey
;

2364 
ªt
;

2366 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2367  -
EINVAL
;

2369 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2370  -
EINVAL
;

2372 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2374  
ªt
 ?Ñë : 
cou¡
;

2375 
	}
}

2376 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2378 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2379 
devi˚_©åibuã
 *
©å
,

2380 c⁄° *
buf
, 
size_t
 
cou¡
)

2382 
pkey
;

2383 
ªt
;

2385 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2386  -
EINVAL
;

2388 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2389  -
EINVAL
;

2391 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2393  
ªt
 ?Ñë : 
cou¡
;

2395 
	}
}

2396 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2398 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2400  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2401 
	}
}

2412 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2413 
devi˚_©åibuã
 *
©å
, *
buf
)

2415 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2428 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2429 
	`√tdev_öfo_⁄˚
(
ndev
,

2431 
cuºít
->
comm
);

2433  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2434 
	}
}

2435 
DEVICE_ATTR_RO
(
dev_id
);

2437 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2439 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2440  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2441 
	}
}

2443 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2444 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2446 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2447 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2448 
ùoib_dev_¥iv
 *
¥iv
;

2449 
√t_devi˚
 *
ndev
;

2450 
ªsu…
;

2452 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2453 i‡(
	`IS_ERR
(
ndev
)) {

2454 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2455 
	`PTR_ERR
(
ndev
));

2456  
ndev
;

2458 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2460 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2461 
¥iv
->
ˇ
, 
ùoib_evít
);

2462 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2465 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2467 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2468 i‡(
ªsu…
) {

2469 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2470 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2472 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2473 
	`ùoib_ötf_‰ì
(
ndev
);

2474 
	`‰ì_√tdev
(
ndev
);

2476  
	`ERR_PTR
(
ªsu…
);

2479 i‡(
hˇ
->
rdma_√tdev_gë_∑øms
) {

2480 
rc
 = 
hˇ
->
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2481 
RDMA_NETDEV_IPOIB
,

2482 &
∑øms
);

2484 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2485 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2493 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2495 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2496 
sysfs_Áûed
;

2497 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2498 
sysfs_Áûed
;

2499 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2500 
sysfs_Áûed
;

2501 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2502 
sysfs_Áûed
;

2503 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2504 
sysfs_Áûed
;

2505 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2506 
sysfs_Áûed
;

2508  
ndev
;

2510 
sysfs_Áûed
:

2511 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2512 
	`uƒegi°î_√tdev
(
ndev
);

2513  
	`ERR_PTR
(-
ENOMEM
);

2514 
	}
}

2516 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2518 
li°_hód
 *
dev_li°
;

2519 
√t_devi˚
 *
dev
;

2520 
ùoib_dev_¥iv
 *
¥iv
;

2521 
p
;

2522 
cou¡
 = 0;

2524 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2525 i‡(!
dev_li°
)

2528 
	`INIT_LIST_HEAD
(
dev_li°
);

2530 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2531 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2533 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2534 i‡(!
	`IS_ERR
(
dev
)) {

2535 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2536 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2537 
cou¡
++;

2541 i‡(!
cou¡
) {

2542 
	`k‰ì
(
dev_li°
);

2546 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2547 
	}
}

2549 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2551 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2552 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2554 i‡(!
dev_li°
)

2557 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2558 
	`LIST_HEAD
(
hód
);

2559 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2561 
	`π∆_lock
();

2563 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2564 
li°
)

2565 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2566 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2567 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2569 
	`π∆_u∆ock
();

2572 
	`k‰ì
(
dev_li°
);

2573 
	}
}

2575 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2576 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2577 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2581 
__öô
 
	$ùoib_öô_moduÀ
()

2583 
ªt
;

2585 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2586 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2587 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2589 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2590 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2591 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2592 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2593 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2594 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2601 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2603 
	`¥_nŸi˚
("Intel Accelerated IPoIB for SLESÜoaded.\n");

2605 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2606 i‡(
ªt
)

2607  
ªt
;

2619 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2620 i‡(!
ùoib_w‹kqueue
) {

2621 
ªt
 = -
ENOMEM
;

2622 
îr_fs
;

2625 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2627 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2628 i‡(
ªt
)

2629 
îr_ß
;

2631 
ªt
 = 
	`ùoib_√éök_öô
();

2632 i‡(
ªt
)

2633 
îr_˛õ¡
;

2635 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2636 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2640 
îr_˛õ¡
:

2641 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2643 
îr_ß
:

2644 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2645 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2647 
îr_fs
:

2648 
	`ùoib_uƒegi°î_debugfs
();

2650  
ªt
;

2651 
	}
}

2653 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2655 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2656 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2658 
	`ùoib_√éök_föi
();

2659 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2660 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2661 
	`ùoib_uƒegi°î_debugfs
();

2662 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2663 
	}
}

2665 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2666 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@SLES12SP5/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@SLES12SP5/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@SLES12SP5/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@SLES12SP5/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@SLES15SP1/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
˘x
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{  0; 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

	@SLES15SP1/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *rx->rx_ring);

359 i‡(!
rx
->
rx_rög
)

360  -
ENOMEM
;

362 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

363 i‡(!
t
) {

364 
ªt
 = -
ENOMEM
;

365 
îr_‰ì_1
;

368 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

370 
	`•ö_lock_úq
(&
¥iv
->
lock
);

372 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

373 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

374 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

375 
ªt
 = -
EINVAL
;

376 
îr_‰ì
;

378 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

380 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

382 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

383 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

384 
rx
->
rx_rög
[
i
].
m≠pög
,

385 
GFP_KERNEL
)) {

386 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

387 
ªt
 = -
ENOMEM
;

388 
îr_cou¡
;

390 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

391 i‡(
ªt
) {

392 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

393 "Áûed f‹ bu‡%d\n", 
i
);

394 
ªt
 = -
EIO
;

395 
îr_cou¡
;

399 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

401 
	`k‰ì
(
t
);

405 
îr_cou¡
:

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

408 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

410 
îr_‰ì
:

411 
	`k‰ì
(
t
);

413 
îr_‰ì_1
:

414 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

416  
ªt
;

417 
	}
}

419 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

420 
ib_qp
 *
qp
,

421 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

422 
p¢
)

424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

425 
ùoib_cm_d©a
 
d©a
 = {};

426 
ib_cm_ªp_∑øm
 
ªp
 = {};

428 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

429 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

431 
ªp
.
¥iv©e_d©a
 = &
d©a
;

432 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

433 
ªp
.
Êow_c⁄åﬁ
 = 0;

434 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

435 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

436 
ªp
.
qp_num
 = 
qp
->qp_num;

437 
ªp
.
°¨tög_p¢
 = 
p¢
;

438  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

439 
	}
}

441 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

442 c⁄° 
ib_cm_evít
 *
evít
)

444 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

445 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

446 
ùoib_cm_rx
 *
p
;

447 
p¢
;

448 
ªt
;

450 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

451 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

452 i‡(!
p
)

453  -
ENOMEM
;

454 
p
->
dev
 = dev;

455 
p
->
id
 = 
cm_id
;

456 
cm_id
->
c⁄ãxt
 = 
p
;

457 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

458 
p
->
jiffõs
 = jiffies;

459 
	`INIT_LIST_HEAD
(&
p
->
li°
);

461 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

462 i‡(
	`IS_ERR
(
p
->
qp
)) {

463 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

464 
îr_qp
;

467 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

468 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

469 i‡(
ªt
)

470 
îr_modify
;

472 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

473 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

474 i‡(
ªt
)

475 
îr_modify
;

478 
	`•ö_lock_úq
(&
¥iv
->
lock
);

479 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

480 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

483 
p
->
jiffõs
 = jiffies;

484 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

485 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

486 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

488 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

489 i‡(
ªt
) {

490 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

491 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

492 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

496 
îr_modify
:

497 
	`ib_de°roy_qp
(
p
->
qp
);

498 
îr_qp
:

499 
	`k‰ì
(
p
);

500  
ªt
;

501 
	}
}

503 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

504 c⁄° 
ib_cm_evít
 *
evít
)

506 
ùoib_cm_rx
 *
p
;

507 
ùoib_dev_¥iv
 *
¥iv
;

509 
evít
->event) {

510 
IB_CM_REQ_RECEIVED
:

511  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

512 
IB_CM_DREQ_RECEIVED
:

513 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

515 
IB_CM_REJ_RECEIVED
:

516 
p
 = 
cm_id
->
c⁄ãxt
;

517 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

518 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

519 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

524 
	}
}

526 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

527 
Àngth
, 
sk_buff
 *
toskb
)

529 
i
, 
num_‰ags
;

530 
size
;

533 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

534 
skb
->
èû
 +
size
;

535 
skb
->
Àn
 +
size
;

536 
Àngth
 -
size
;

538 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

539 
i
 = 0; i < 
num_‰ags
; i++) {

540 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

542 i‡(
Àngth
 == 0) {

544 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

545 0, 
PAGE_SIZE
);

546 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

548 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

550 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

551 
skb
->
d©a_Àn
 +
size
;

552 
skb
->
åuesize
 +
size
;

553 
skb
->
Àn
 +
size
;

554 
Àngth
 -
size
;

557 
	}
}

559 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

562 
ùoib_cm_rx_buf
 *
rx_rög
;

563 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

564 
sk_buff
 *
skb
, *
√wskb
;

565 
ùoib_cm_rx
 *
p
;

566 
Êags
;

567 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

568 
‰ags
;

569 
has_§q
;

570 
sk_buff
 *
smÆl_skb
;

572 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

573 
wr_id
, 
wc
->
°©us
);

575 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

576 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

577 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

578 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

579 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

580 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

581 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

583 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

584 
wr_id
, 
ùoib_ªcvq_size
);

588 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

590 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

591 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

593 
skb
 = 
rx_rög
[
wr_id
].skb;

595 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

596 
	`ùoib_dbg
(
¥iv
,

598 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

599 ++
dev
->
°©s
.
rx_dr›≥d
;

600 i‡(
has_§q
)

601 
ªpo°
;

603 i‡(!--
p
->
ªcv_cou¡
) {

604 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

605 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

606 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

607 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

613 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

614 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

615 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

616 
p
->
jiffõs
 = jiffies;

619 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

620 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

621 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

625 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

626 
dÀn
 = 
wc
->
byã_Àn
;

628 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

629 i‡(
smÆl_skb
) {

630 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

631 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

632 
dÀn
, 
DMA_FROM_DEVICE
);

633 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

634 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

635 
dÀn
, 
DMA_FROM_DEVICE
);

636 
	`skb_put
(
smÆl_skb
, 
dÀn
);

637 
skb
 = 
smÆl_skb
;

638 
c›õd
;

642 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

643 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

644 
PAGE_SIZE
;

646 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

647 
m≠pög
, 
GFP_ATOMIC
);

648 i‡(
	`u∆ikñy
(!
√wskb
)) {

653 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

654 ++
dev
->
°©s
.
rx_dr›≥d
;

655 
ªpo°
;

658 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

659 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

661 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

662 
wc
->
byã_Àn
, wc->
¶id
);

664 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

666 
c›õd
:

667 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

668 
	`skb_add_p£udo_hdr
(
skb
);

670 ++
dev
->
°©s
.
rx_∑ckës
;

671 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

673 
skb
->
dev
 = dev;

675 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

676 
	`√tif_ª˚ive_skb
(
skb
);

678 
ªpo°
:

679 i‡(
has_§q
) {

680 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

681 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

682 "f‹ bu‡%d\n", 
wr_id
);

684 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

685 &
¥iv
->
cm
.
rx_wr
,

686 
¥iv
->
cm
.
rx_sge
,

687 
wr_id
))) {

688 --
p
->
ªcv_cou¡
;

689 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

690 "f‹ bu‡%d\n", 
wr_id
);

693 
	}
}

695 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

696 
ùoib_cm_tx
 *
tx
,

697 
wr_id
,

698 
ùoib_tx_buf
 *
tx_ªq
)

700 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

702 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

704  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

705 
	}
}

707 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

709 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

710 
ùoib_tx_buf
 *
tx_ªq
;

711 
rc
;

712 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

714 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

715 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

716 
skb
->
Àn
, 
tx
->
mtu
);

717 ++
dev
->
°©s
.
tx_dr›≥d
;

718 ++
dev
->
°©s
.
tx_îr‹s
;

719 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

722 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

723 i‡(
	`skb_löórize
(
skb
) < 0) {

724 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

725 ++
dev
->
°©s
.
tx_dr›≥d
;

726 ++
dev
->
°©s
.
tx_îr‹s
;

727 
	`dev_k‰ì_skb_™y
(
skb
);

731 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

732 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

733 ++
dev
->
°©s
.
tx_dr›≥d
;

734 ++
dev
->
°©s
.
tx_îr‹s
;

735 
	`dev_k‰ì_skb_™y
(
skb
);

739 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

740 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

749 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

750 
tx_ªq
->
skb
 = skb;

752 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

753 ++
dev
->
°©s
.
tx_îr‹s
;

754 
	`dev_k‰ì_skb_™y
(
skb
);

758 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

759 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

760 
tx
->
qp
->
qp_num
);

761 
	`√tif_°›_queue
(
dev
);

764 
	`skb_‹ph™
(
skb
);

765 
	`skb_d°_dr›
(
skb
);

767 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

768 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

769 
IB_CQ_REPORT_MISSED_EVENTS
);

770 i‡(
	`u∆ikñy
(
rc
 < 0))

771 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

772 i‡(
rc
)

773 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

776 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

777 i‡(
	`u∆ikñy
(
rc
)) {

778 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

779 ++
dev
->
°©s
.
tx_îr‹s
;

780 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

781 
	`dev_k‰ì_skb_™y
(
skb
);

783 i‡(
	`√tif_queue_°›≥d
(
dev
))

784 
	`√tif_wake_queue
(
dev
);

786 
	`√tif_å™s_upd©e
(
dev
);

787 ++
tx
->
tx_hód
;

788 ++
¥iv
->
tx_hód
;

790 
	}
}

792 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

794 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

795 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

796 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

797 
ùoib_tx_buf
 *
tx_ªq
;

798 
Êags
;

800 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

801 
wr_id
, 
wc
->
°©us
);

803 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

804 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

805 
wr_id
, 
ùoib_£ndq_size
);

809 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

811 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

814 ++
dev
->
°©s
.
tx_∑ckës
;

815 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

817 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

819 
	`√tif_tx_lock
(
dev
);

821 ++
tx
->
tx_èû
;

822 ++
¥iv
->
tx_èû
;

824 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

825 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

826 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

827 
	`√tif_wake_queue
(
dev
);

829 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

830 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

831 
ùoib_√igh
 *
√igh
;

836 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

837 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

838 
	`ùoib_dbg
(
¥iv
,

840 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

842 
	`ùoib_w¨n
(
¥iv
,

844 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

846 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

847 
√igh
 = 
tx
->neigh;

849 i‡(
√igh
) {

850 
√igh
->
cm
 = 
NULL
;

851 
	`ùoib_√igh_‰ì
(
√igh
);

853 
tx
->
√igh
 = 
NULL
;

856 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

857 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

858 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

861 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

863 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

866 
	`√tif_tx_u∆ock
(
dev
);

867 
	}
}

869 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

871 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

872 
ªt
;

874 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

877 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

878 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

879 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

880 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

881 
îr_cm
;

884 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

886 i‡(
ªt
) {

887 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

888 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

889 
îr_li°í
;

894 
îr_li°í
:

895 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

896 
îr_cm
:

897 
¥iv
->
cm
.
id
 = 
NULL
;

898  
ªt
;

899 
	}
}

901 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

903 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
ùoib_cm_rx
 *
rx
, *
n
;

905 
	`LIST_HEAD
(
li°
);

907 
	`•ö_lock_úq
(&
¥iv
->
lock
);

908 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

909 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

911 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

912 
	`ib_de°roy_cm_id
(
rx
->
id
);

913 
	`ib_de°roy_qp
(
rx
->
qp
);

914 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

915 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

916 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

918 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

920 
	`k‰ì
(
rx
);

922 
	}
}

924 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

926 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

927 
ùoib_cm_rx
 *
p
;

928 
begö
;

929 
ªt
;

931 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

934 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

935 
¥iv
->
cm
.
id
 = 
NULL
;

937 
	`•ö_lock_úq
(&
¥iv
->
lock
);

938 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

939 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

940 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

941 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

942 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

943 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

944 i‡(
ªt
)

945 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

946 
	`•ö_lock_úq
(&
¥iv
->
lock
);

950 
begö
 = 
jiffõs
;

952 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

955 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

956 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

961 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

962 &
¥iv
->
cm
.
rx_ª≠_li°
);

963 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

964 &
¥iv
->
cm
.
rx_ª≠_li°
);

965 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

966 &
¥iv
->
cm
.
rx_ª≠_li°
);

969 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

970 
	`u¶ìp_ønge
(1000, 2000);

971 
	`ùoib_døö_cq
(
dev
);

972 
	`•ö_lock_úq
(&
¥iv
->
lock
);

975 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

977 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

979 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

980 
	}
}

982 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

983 c⁄° 
ib_cm_evít
 *
evít
)

985 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

986 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

987 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

988 
sk_buff_hód
 
skqueue
;

989 
ib_qp_©å
 
qp_©å
;

990 
qp_©å_mask
, 
ªt
;

991 
sk_buff
 *
skb
;

993 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

995 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

996 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

997 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

998  -
EINVAL
;

1001 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1002 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1003 i‡(
ªt
) {

1004 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1005  
ªt
;

1008 
qp_©å
.
rq_p¢
 = 0 ;

1009 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1010 i‡(
ªt
) {

1011 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1012  
ªt
;

1015 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1016 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1017 i‡(
ªt
) {

1018 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1019  
ªt
;

1021 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1022 i‡(
ªt
) {

1023 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1024  
ªt
;

1027 
	`skb_queue_hód_öô
(&
skqueue
);

1029 
	`√tif_tx_lock_bh
(
p
->
dev
);

1030 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1032 i‡(
p
->
√igh
)

1033 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1034 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1035 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1036 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1038 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1039 
skb
->
dev
 = 
p
->dev;

1040 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1041 i‡(
ªt
)

1042 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1043 
__func__
, 
ªt
);

1046 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1047 i‡(
ªt
) {

1048 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1049  
ªt
;

1052 
	}
}

1054 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1056 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1057 
ib_qp_öô_©å
 
©å
 = {

1058 .
£nd_cq
 = 
¥iv
->send_cq,

1059 .
ªcv_cq
 = 
¥iv
->recv_cq,

1060 .
§q
 = 
¥iv
->
cm
.srq,

1061 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1062 .
ˇp
.
max_£nd_sge
 = 1,

1063 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1064 .
qp_ty≥
 = 
IB_QPT_RC
,

1065 .
qp_c⁄ãxt
 = 
tx
,

1066 .
¸óã_Êags
 = 0

1068 
ib_qp
 *
tx_qp
;

1070 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1071 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1072 
MAX_SKB_FRAGS
 + 1);

1074 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1075 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1076  
tx_qp
;

1077 
	}
}

1079 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1080 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1081 
u32
 
q≤
,

1082 
ß_∑th_ªc
 *
∑thªc
)

1084 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1085 
ùoib_cm_d©a
 
d©a
 = {};

1086 
ib_cm_ªq_∑øm
 
ªq
 = {};

1088 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1089 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1091 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1092 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1093 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1094 
ªq
.
qp_num
 = 
qp
->qp_num;

1095 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1096 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1097 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1098 
ªq
.
Êow_c⁄åﬁ
 = 0;

1100 
ªq
.
°¨tög_p¢
 = 0;

1106 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1107 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1108 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
ªåy_cou¡
 = 0;

1110 
ªq
.
∫r_ªåy_cou¡
 = 0;

1111 
ªq
.
max_cm_ªåõs
 = 15;

1112 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1113  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1114 
	}
}

1116 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1117 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1119 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1120 
ib_qp_©å
 
qp_©å
;

1121 
qp_©å_mask
, 
ªt
;

1122 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1123 i‡(
ªt
) {

1124 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1125  
ªt
;

1128 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1129 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1130 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1131 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1133 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1134 i‡(
ªt
) {

1135 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1136  
ªt
;

1139 
	}
}

1141 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1142 
ß_∑th_ªc
 *
∑thªc
)

1144 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1145 
noio_Êag
;

1146 
ªt
;

1148 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1149 
p
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 * (*p->tx_ring));

1150 i‡(!
p
->
tx_rög
) {

1151 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1152 
ªt
 = -
ENOMEM
;

1153 
îr_tx
;

1156 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1157 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1158 i‡(
	`IS_ERR
(
p
->
qp
)) {

1159 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1160 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1161 
îr_qp
;

1164 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1165 i‡(
	`IS_ERR
(
p
->
id
)) {

1166 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1167 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1168 
îr_id
;

1171 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1172 i‡(
ªt
) {

1173 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1174 
îr_modify_£nd
;

1177 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1178 i‡(
ªt
) {

1179 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1180 
îr_modify_£nd
;

1183 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1184 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1188 
îr_modify_£nd
:

1189 
	`ib_de°roy_cm_id
(
p
->
id
);

1190 
îr_id
:

1191 
p
->
id
 = 
NULL
;

1192 
	`ib_de°roy_qp
(
p
->
qp
);

1193 
îr_qp
:

1194 
p
->
qp
 = 
NULL
;

1195 
	`v‰ì
(
p
->
tx_rög
);

1196 
îr_tx
:

1197  
ªt
;

1198 
	}
}

1200 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1202 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1203 
ùoib_tx_buf
 *
tx_ªq
;

1204 
begö
;

1206 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1207 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1209 i‡(
p
->
id
)

1210 
	`ib_de°roy_cm_id
(
p
->
id
);

1212 i‡(
p
->
tx_rög
) {

1214 
begö
 = 
jiffõs
;

1215 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1216 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1217 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1218 
p
->
tx_hód
 -Ö->
tx_èû
);

1219 
timeout
;

1222 
	`u¶ìp_ønge
(1000, 2000);

1226 
timeout
:

1228 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1229 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1230 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1231 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1232 
	`√tif_tx_lock_bh
(
p
->
dev
);

1233 ++
p
->
tx_èû
;

1234 ++
¥iv
->
tx_èû
;

1235 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1236 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1237 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1238 
	`√tif_wake_queue
(
p
->
dev
);

1239 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1242 i‡(
p
->
qp
)

1243 
	`ib_de°roy_qp
(
p
->
qp
);

1245 
	`v‰ì
(
p
->
tx_rög
);

1246 
	`k‰ì
(
p
);

1247 
	}
}

1249 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1250 c⁄° 
ib_cm_evít
 *
evít
)

1252 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1254 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1255 
ùoib_√igh
 *
√igh
;

1256 
Êags
;

1257 
ªt
;

1259 
evít
->event) {

1260 
IB_CM_DREQ_RECEIVED
:

1261 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1262 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1264 
IB_CM_REP_RECEIVED
:

1265 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1266 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1267 i‡(
ªt
)

1268 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1269 
NULL
, 0, NULL, 0);

1271 
IB_CM_REQ_ERROR
:

1272 
IB_CM_REJ_RECEIVED
:

1273 
IB_CM_TIMEWAIT_EXIT
:

1274 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1275 
	`√tif_tx_lock_bh
(
dev
);

1276 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1277 
√igh
 = 
tx
->neigh;

1279 i‡(
√igh
) {

1280 
√igh
->
cm
 = 
NULL
;

1281 
	`ùoib_√igh_‰ì
(
√igh
);

1283 
tx
->
√igh
 = 
NULL
;

1286 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1287 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1288 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1291 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1292 
	`√tif_tx_u∆ock_bh
(
dev
);

1299 
	}
}

1301 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1302 
ùoib_√igh
 *
√igh
)

1304 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1305 
ùoib_cm_tx
 *
tx
;

1307 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1308 i‡(!
tx
)

1309  
NULL
;

1311 
√igh
->
cm
 = 
tx
;

1312 
tx
->
√igh
 =Çeigh;

1313 
tx
->
dev
 = dev;

1314 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1315 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1316 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1317  
tx
;

1318 
	}
}

1320 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1322 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1323 
Êags
;

1324 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1325 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1326 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1327 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1328 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1329 
tx
->
√igh
->
daddr
 + 4);

1330 
tx
->
√igh
 = 
NULL
;

1331 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1333 
	}
}

1335 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1337 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1339 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1340 
cm
.
°¨t_èsk
);

1341 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1342 
ùoib_√igh
 *
√igh
;

1343 
ùoib_cm_tx
 *
p
;

1344 
Êags
;

1345 
ùoib_∑th
 *
∑th
;

1346 
ªt
;

1348 
ß_∑th_ªc
 
∑thªc
;

1349 
u32
 
q≤
;

1351 
	`√tif_tx_lock_bh
(
dev
);

1352 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1354 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1355 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1356 
	`li°_dñ_öô
(&
p
->
li°
);

1357 
√igh
 = 
p
->neigh;

1359 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1364 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1365 i‡(!
∑th
) {

1366 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1367 
__func__
,

1368 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1369 
‰ì_√igh
;

1371 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1373 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1374 
	`√tif_tx_u∆ock_bh
(
dev
);

1376 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1378 
	`√tif_tx_lock_bh
(
dev
);

1379 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1381 i‡(
ªt
) {

1382 
‰ì_√igh
:

1383 
√igh
 = 
p
->neigh;

1384 i‡(
√igh
) {

1385 
√igh
->
cm
 = 
NULL
;

1386 
	`ùoib_√igh_‰ì
(
√igh
);

1388 
	`li°_dñ
(&
p
->
li°
);

1389 
	`k‰ì
(
p
);

1393 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1394 
	`√tif_tx_u∆ock_bh
(
dev
);

1395 
	}
}

1397 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1399 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1400 
cm
.
ª≠_èsk
);

1401 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1402 
ùoib_cm_tx
 *
p
;

1403 
Êags
;

1405 
	`√tif_tx_lock_bh
(
dev
);

1406 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1408 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1409 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1410 
	`li°_dñ_öô
(&
p
->
li°
);

1411 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1412 
	`√tif_tx_u∆ock_bh
(
dev
);

1413 
	`ùoib_cm_tx_de°roy
(
p
);

1414 
	`√tif_tx_lock_bh
(
dev
);

1415 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1418 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1419 
	`√tif_tx_u∆ock_bh
(
dev
);

1420 
	}
}

1422 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1424 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1425 
cm
.
skb_èsk
);

1426 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1427 
sk_buff
 *
skb
;

1428 
Êags
;

1429 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1431 
	`√tif_tx_lock_bh
(
dev
);

1432 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1434 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1435 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1436 
	`√tif_tx_u∆ock_bh
(
dev
);

1438 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1439 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1440 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1442 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1443 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1444 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1445 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1448 
	`dev_k‰ì_skb_™y
(
skb
);

1450 
	`√tif_tx_lock_bh
(
dev
);

1451 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1454 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1455 
	`√tif_tx_u∆ock_bh
(
dev
);

1456 
	}
}

1458 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1459 
mtu
)

1461 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1462 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1464 i‡(
	`skb_d°
(
skb
))

1465 
	`skb_d°
(
skb
)->
›s
->
	`upd©e_pmtu
(skb_d°(skb), 
NULL
, skb, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
ùoib_ªcvq_size
 *  *priv->cm.srq_ring);

1574 i‡(!
¥iv
->
cm
.
§q_rög
) {

1575 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1576 
¥iv
->
cm
.
§q
 = 
NULL
;

1580 
	}
}

1582 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1584 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1585 
max_§q_sge
, 
i
;

1587 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1594 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1598 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1600 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1602 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1604 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1605 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1606 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1607 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1608 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1609 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1610 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1612 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1613 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1616 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1618 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1619 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1620 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1621 
¥iv
->
cm
.
num_‰ags
 - 1,

1622 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1623 
GFP_KERNEL
)) {

1624 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1625 "ª˚ivêbuf„∏%d\n", 
i
);

1626 
	`ùoib_cm_dev_˛ónup
(
dev
);

1627  -
ENOMEM
;

1630 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1631 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1632 "Áûed f‹ bu‡%d\n", 
i
);

1633 
	`ùoib_cm_dev_˛ónup
(
dev
);

1634  -
EIO
;

1639 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1641 
	}
}

1643 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1645 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
ªt
;

1648 i‡(!
¥iv
->
cm
.
§q
)

1651 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1653 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1654 i‡(
ªt
)

1655 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1657 
¥iv
->
cm
.
§q
 = 
NULL
;

1658 i‡(!
¥iv
->
cm
.
§q_rög
)

1661 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1662 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1663 
	}
}

	@SLES15SP1/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

141 
ETH_SS_TEST
:

145 
	}
}

146 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

147 
s£t
)

149 
s£t
) {

150 
ETH_SS_STATS
:

151  
IPOIB_GLOBAL_STATS_LEN
;

152 
ETH_SS_TEST
:

156  -
EOPNOTSUPP
;

157 
	}
}

160 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

162 
•ìd
) {

163 
IB_SPEED_SDR
:

164  
SPEED_2500
;

165 
IB_SPEED_DDR
:

166  
SPEED_5000
;

167 
IB_SPEED_QDR
:

168 
IB_SPEED_FDR10
:

169  
SPEED_10000
;

170 
IB_SPEED_FDR
:

171  
SPEED_14000
;

172 
IB_SPEED_EDR
:

173  
SPEED_25000
;

176  
SPEED_UNKNOWN
;

177 
	}
}

179 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

180 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

182 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

183 
ib_p‹t_©å
 
©å
;

184 
ªt
, 
•ìd
, 
width
;

186 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

187 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

188 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

192 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

193 i‡(
ªt
 < 0)

194  -
EINVAL
;

196 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

197 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

199 i‡(
•ìd
 < 0 || 
width
 < 0)

200  -
EINVAL
;

206 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

207 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

209 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

211 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

212 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

215 
	}
}

217 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

218 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

219 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

220 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

221 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

222 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

223 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

224 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

227 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

229 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

230 
	}
}

	@SLES15SP1/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

270 i‡(!
¥iv
->
mcg_díåy
)

271 
	`ùoib_w¨n
(
¥iv
, "failedÅo create mcg debug file\n");

273 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

274 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

275 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

276 i‡(!
¥iv
->
∑th_díåy
)

277 
	`ùoib_w¨n
(
¥iv
, "failedÅo createÖath debug file\n");

278 
	}
}

280 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

282 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

284 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

285 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

286 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

287 
	}
}

289 
	$ùoib_ªgi°î_debugfs
()

291 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

292  
ùoib_roŸ
 ? 0 : -
ENOMEM
;

293 
	}
}

295 
	$ùoib_uƒegi°î_debugfs
()

297 
	`debugfs_ªmove
(
ùoib_roŸ
);

298 
	}
}

	@SLES15SP1/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
‰ag
->
∑ge_off£t
, 
	`skb_‰ag_size
(frag),

297 
DMA_TO_DEVICE
);

298 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

299 
∑πül_îr‹
;

303 
∑πül_îr‹
:

304 ; 
i
 > 0; --i) {

305 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

307 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

310 i‡(
off
)

311 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

313  -
EIO
;

314 
	}
}

316 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

317 
ùoib_tx_buf
 *
tx_ªq
)

319 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

320 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

321 
i
;

322 
off
;

324 i‡(
	`skb_hódÀn
(
skb
)) {

325 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

326 
DMA_TO_DEVICE
);

327 
off
 = 1;

329 
off
 = 0;

331 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

332 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

334 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

335 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

337 
	}
}

344 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

346 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

347 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

349 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

350 
ib_qp_©å
 
qp_©å
;

351 
ib_qp_öô_©å
 
quîy_öô_©å
;

352 
ªt
;

354 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

355 i‡(
ªt
) {

356 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

357 
__func__
, 
ªt
);

358 
‰ì_ªs
;

360 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

361 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

364 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

365 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

367 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

368 i‡(
ªt
) {

369 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

370 
ªt
, 
¥iv
->
qp
->
qp_num
);

371 
‰ì_ªs
;

373 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

374 
__func__
, 
¥iv
->
qp
->
qp_num
);

376 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

377 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

380 
‰ì_ªs
:

381 
	`k‰ì
(
qp_w‹k
);

382 
	}
}

384 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

386 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

387 
wr_id
 = 
wc
->wr_id;

388 
ùoib_tx_buf
 *
tx_ªq
;

390 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

391 
wr_id
, 
wc
->
°©us
);

393 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

394 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

395 
wr_id
, 
ùoib_£ndq_size
);

399 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

401 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

403 ++
dev
->
°©s
.
tx_∑ckës
;

404 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

406 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

408 ++
¥iv
->
tx_èû
;

410 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

411 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

412 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

413 
	`√tif_wake_queue
(
dev
);

415 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

416 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

417 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

418 
	`ùoib_w¨n
(
¥iv
,

420 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

421 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

422 i‡(!
qp_w‹k
)

425 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

426 
qp_w‹k
->
¥iv
 =Öriv;

427 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

429 
	}
}

431 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

433 
n
, 
i
;

434 
ib_wc
 *
wc
;

436 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

437 
i
 = 0; i < 
n
; ++i) {

438 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

439 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

440 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

442 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

444  
n
 =
MAX_SEND_CQE
;

445 
	}
}

447 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

449 
ùoib_dev_¥iv
 *
¥iv
 =

450 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

451 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

452 
d⁄e
;

453 
t
;

454 
n
, 
i
;

456 
d⁄e
 = 0;

458 
pﬁl_m‹e
:

459 
d⁄e
 < 
budgë
) {

460 
max
 = (
budgë
 - 
d⁄e
);

462 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

463 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

465 
i
 = 0; i < 
n
; i++) {

466 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

468 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

469 ++
d⁄e
;

470 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

471 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

473 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

475 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

479 i‡(
n
 !
t
)

483 i‡(
d⁄e
 < 
budgë
) {

484 
	`«pi_com∂ëe
(
«pi
);

485 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

486 
IB_CQ_NEXT_COMP
 |

487 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

488 
	`«pi_ªscheduÀ
(
«pi
))

489 
pﬁl_m‹e
;

492  
d⁄e
;

493 
	}
}

495 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

497 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

498 
£nd_«pi
);

499 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

500 
n
, 
i
;

501 
ib_wc
 *
wc
;

503 
pﬁl_m‹e
:

504 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

506 
i
 = 0; i < 
n
; i++) {

507 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

508 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

509 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

511 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

514 i‡(
n
 < 
budgë
) {

515 
	`«pi_com∂ëe
(
«pi
);

516 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

517 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

518 
	`«pi_ªscheduÀ
(
«pi
))

519 
pﬁl_m‹e
;

521  
n
 < 0 ? 0 :Ç;

522 
	}
}

524 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

526 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

528 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

529 
	}
}

531 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

533 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

535 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

536 
	}
}

538 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

539 
wr_id
,

540 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

541 
ùoib_tx_buf
 *
tx_ªq
,

542 *
hód
, 
hÀn
)

544 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

546 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

548 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

549 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

550 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

552 i‡(
hód
) {

553 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

554 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

555 
¥iv
->
tx_wr
.
hÀn
 = hlen;

556 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

558 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

560  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

561 
	}
}

563 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

564 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

566 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

567 
ùoib_tx_buf
 *
tx_ªq
;

568 
hÀn
, 
rc
;

569 *
phód
;

570 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

572 i‡(
	`skb_is_gso
(
skb
)) {

573 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

574 
phód
 = 
skb
->
d©a
;

575 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

576 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

577 ++
dev
->
°©s
.
tx_dr›≥d
;

578 ++
dev
->
°©s
.
tx_îr‹s
;

579 
	`dev_k‰ì_skb_™y
(
skb
);

583 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

584 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

585 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

586 ++
dev
->
°©s
.
tx_dr›≥d
;

587 ++
dev
->
°©s
.
tx_îr‹s
;

588 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

591 
phód
 = 
NULL
;

592 
hÀn
 = 0;

594 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

595 i‡(
	`skb_löórize
(
skb
) < 0) {

596 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

597 ++
dev
->
°©s
.
tx_dr›≥d
;

598 ++
dev
->
°©s
.
tx_îr‹s
;

599 
	`dev_k‰ì_skb_™y
(
skb
);

603 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

604 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

605 ++
dev
->
°©s
.
tx_dr›≥d
;

606 ++
dev
->
°©s
.
tx_îr‹s
;

607 
	`dev_k‰ì_skb_™y
(
skb
);

612 
	`ùoib_dbg_d©a
(
¥iv
,

614 
skb
->
Àn
, 
addªss
, 
dq≤
);

623 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

624 
tx_ªq
->
skb
 = skb;

625 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

626 ++
dev
->
°©s
.
tx_îr‹s
;

627 
	`dev_k‰ì_skb_™y
(
skb
);

631 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

632 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

634 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

636 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

637 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

638 
	`√tif_°›_queue
(
dev
);

641 
	`skb_‹ph™
(
skb
);

642 
	`skb_d°_dr›
(
skb
);

644 i‡(
	`√tif_queue_°›≥d
(
dev
))

645 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

646 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

647 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

649 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

650 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

651 i‡(
	`u∆ikñy
(
rc
)) {

652 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

653 ++
dev
->
°©s
.
tx_îr‹s
;

654 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

655 
	`dev_k‰ì_skb_™y
(
skb
);

656 i‡(
	`√tif_queue_°›≥d
(
dev
))

657 
	`√tif_wake_queue
(
dev
);

658 
rc
 = 0;

660 
	`√tif_å™s_upd©e
(
dev
);

662 
rc
 = 
¥iv
->
tx_hód
;

663 ++
¥iv
->
tx_hód
;

665  
rc
;

666 
	}
}

668 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

670 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

671 
ùoib_ah
 *
ah
, *
èh
;

672 
	`LIST_HEAD
(
ªmove_li°
);

673 
Êags
;

675 
	`√tif_tx_lock_bh
(
dev
);

676 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

678 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

679 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

680 
	`li°_dñ
(&
ah
->
li°
);

681 
	`rdma_de°roy_ah
(
ah
->ah, 0);

682 
	`k‰ì
(
ah
);

685 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

686 
	`√tif_tx_u∆ock_bh
(
dev
);

687 
	}
}

689 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

691 
ùoib_dev_¥iv
 *
¥iv
 =

692 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

693 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

695 
	`__ùoib_ª≠_ah
(
dev
);

697 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

698 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

699 
	`round_jiffõs_ªœtive
(
HZ
));

700 
	}
}

702 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

704 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

706 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

707 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

708 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

709 
	}
}

711 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

713 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

715 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

716 
	`ùoib_Êush_ah
(
dev
);

717 
	}
}

719 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

721 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

722 
≥ndög
 = 0;

723 
i
;

725 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

726 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

727 ++
≥ndög
;

729  
≥ndög
;

730 
	}
}

732 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

733 
ib_qp
 *
qp
,

734 
ib_qp_°©e
 
√w_°©e
)

736 
ib_qp_©å
 
qp_©å
;

737 
ib_qp_öô_©å
 
quîy_öô_©å
;

738 
ªt
;

740 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

741 i‡(
ªt
) {

742 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

746 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

747 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

749 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

750 
√w_°©e
, 
qp_©å
.
qp_°©e
);

751 
	}
}

753 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

755 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

757 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

758 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

759 
	}
}

761 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

763 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

765 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

766 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

767 
	}
}

769 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

771 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

772 
ib_qp_©å
 
qp_©å
;

773 
begö
;

774 
ùoib_tx_buf
 *
tx_ªq
;

775 
i
;

777 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

778 
	`ùoib_«pi_dißbÀ
(
dev
);

780 
	`ùoib_cm_dev_°›
(
dev
);

786 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

787 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

788 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

791 
begö
 = 
jiffõs
;

793 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

794 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

795 
	`ùoib_w¨n
(
¥iv
,

797 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

798 
	`ªcvs_≥ndög
(
dev
));

804 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

805 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

806 (
ùoib_£ndq_size
 - 1)];

807 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

808 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

809 ++
¥iv
->
tx_èû
;

812 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

813 
ùoib_rx_buf
 *
rx_ªq
;

815 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

816 i‡(!
rx_ªq
->
skb
)

818 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

819 
¥iv
->
rx_rög
[
i
].
m≠pög
);

820 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

821 
rx_ªq
->
skb
 = 
NULL
;

824 
timeout
;

827 
	`ùoib_døö_cq
(
dev
);

829 
	`u¶ìp_ønge
(1000, 2000);

832 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

834 
timeout
:

835 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

836 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

837 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

839 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

842 
	}
}

844 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

846 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

848 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

850 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

851 
	`ùoib_Êush_ah
(
dev
);

854 
	}
}

856 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

858 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

859 
ªt
;

861 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

862 i‡(
ªt
) {

863 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

867 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

868 i‡(
ªt
) {

869 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

870 
out
;

873 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

874 i‡(
ªt
) {

875 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

876 
out
;

879 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

880 
	`ùoib_«pi_íabÀ
(
dev
);

883 
out
:

885 
	}
}

887 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

889 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

891 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

893 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

894 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

895 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

899 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

900 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

901 
	`round_jiffõs_ªœtive
(
HZ
));

903 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

904 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

905 
dev_°›
;

908 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

912 
dev_°›
:

913 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

914 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

915 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

916 
	`ùoib_ib_dev_°›
(
dev
);

918 
	}
}

920 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

922 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

923 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

925 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

926 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

927 &
¥iv
->
pkey_ödex
)) {

928 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

930 i‡(
∫
->
£t_id
)

931 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

932 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

934 
	}
}

936 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

938 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

940 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

942 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

943 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

947 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

949 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

950 
	}
}

952 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

954 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

956 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

958 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

959 
	`√tif_ˇºõr_off
(
dev
);

961 
	`ùoib_mˇ°_°›_thªad
(
dev
);

962 
	`ùoib_mˇ°_dev_Êush
(
dev
);

964 
	`ùoib_Êush_∑ths
(
dev
);

965 
	}
}

967 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

969 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

970 
i
, 
n
;

977 
	`loˇl_bh_dißbÀ
();

980 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

981 
i
 = 0; i < 
n
; ++i) {

987 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

988 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

992 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

994 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

996 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

999 } 
n
 =
IPOIB_NUM_WC
);

1001 
	`pﬁl_tx
(
¥iv
))

1004 
	`loˇl_bh_íabÀ
();

1005 
	}
}

1011 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1013 
ªsu…
;

1014 
u16
 
¥ev_pkey
;

1016 
¥ev_pkey
 = 
¥iv
->
pkey
;

1017 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1018 i‡(
ªsu…
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1020 
¥iv
->
p‹t
, 
ªsu…
);

1021  
ªsu…
;

1024 
¥iv
->
pkey
 |= 0x8000;

1026 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1027 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1028 
¥ev_pkey
, 
¥iv
->
pkey
);

1033 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1034 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1039 
	}
}

1043 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1045 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1047 
¥iv
->
pkey_ödex
 = 0;

1048 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1050 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1051 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1054 
	}
}

1060 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1062 
ib_gid
 
£¨ch_gid
;

1063 
ib_gid
 
gid0
;

1064 
ib_gid
 *
√tdev_gid
;

1065 
îr
;

1066 
u16
 
ödex
;

1067 
u8
 
p‹t
;

1068 
boﬁ
 
ªt
 = 
Ál£
;

1070 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1071 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1072  
Ál£
;

1074 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1079 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1083 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1085 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1087 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1089 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1091 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1092 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1096 
out
;

1123 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1124 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1125 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1126 i‡(
ödex
 == 0)

1127 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1128 &
¥iv
->
Êags
);

1130 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1131 
ªt
 = 
åue
;

1133 
ªt
 = 
Ál£
;

1136 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1137 
ªt
 = 
åue
;

1139 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1140 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1141 (
¥iv
->
loˇl_gid
));

1142 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1143 (
¥iv
->
loˇl_gid
));

1144 
ªt
 = 
åue
;

1149 
out
:

1150 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1152  
ªt
;

1153 
	}
}

1155 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1156 
ùoib_Êush_Àvñ
 
Àvñ
,

1157 
√°ög
)

1159 
ùoib_dev_¥iv
 *
˝riv
;

1160 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1161 
ªsu…
;

1163 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1169 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1170 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1174 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1175 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1177 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1178 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1179 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1183 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1185 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1186 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1187 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1189 
	`upd©e_chûd_pkey
(
¥iv
);

1190 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1191 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1192 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1196 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1200 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1201 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1202 i‡(
ªsu…
) {

1204 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1209 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1211 i‡(
ªsu…
) {

1212 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1218 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1219 
›î_up
;

1220 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1226 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1227 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1228 i‡(
›î_up
)

1229 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1230 
	`ùoib_Êush_ah
(
dev
);

1233 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1234 
	`ùoib_ib_dev_down
(
dev
);

1236 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1237 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1238 
	`ùoib_ib_dev_°›
(
dev
);

1240 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1243 i‡(
	`√tif_queue_°›≥d
(
dev
))

1244 
	`√tif_°¨t_queue
(
dev
);

1251 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1252 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1253 
	`ùoib_ib_dev_up
(
dev
);

1254 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1255 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1257 
	}
}

1259 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1261 
ùoib_dev_¥iv
 *
¥iv
 =

1262 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1264 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1265 
	}
}

1267 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1269 
ùoib_dev_¥iv
 *
¥iv
 =

1270 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1272 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1273 
	}
}

1275 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1277 
ùoib_dev_¥iv
 *
¥iv
 =

1278 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1280 
	`π∆_lock
();

1281 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1282 
	`π∆_u∆ock
();

1283 
	}
}

1285 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1287 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1289 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1294 
	`ùoib_Êush_∑ths
(
dev
);

1296 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1297 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1305 
	`ùoib_°›_ah
(
dev
);

1307 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1309 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1311 i‡(
¥iv
->
pd
) {

1312 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1313 
¥iv
->
pd
 = 
NULL
;

1315 
	}
}

	@SLES15SP1/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
uöt
 
ùoib_ac˚l
;

80 
	sùoib_∑th_ôî
 {

81 
√t_devi˚
 *
	mdev
;

82 
ùoib_∑th
 
	m∑th
;

85 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

91 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

93 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

95 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

96 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

97 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

98 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

99 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

100 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

101 *
˛õ¡_d©a
);

102 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

103 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

104 
cmd
);

106 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

107 .
«me
 = "ipoib",

108 .
	gadd
 = 
ùoib_add_⁄e
,

109 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

110 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

113 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


114 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

115 
evít
, *
±r
)

117 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

118 
√t_devi˚
 *
dev
 = 
ni
->dev;

120 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

121  
NOTIFY_DONE
;

123 
evít
) {

124 
NETDEV_REGISTER
:

125 
	`ùoib_¸óã_debug_fûes
(
dev
);

127 
NETDEV_CHANGENAME
:

128 
	`ùoib_dñëe_debug_fûes
(
dev
);

129 
	`ùoib_¸óã_debug_fûes
(
dev
);

131 
NETDEV_UNREGISTER
:

132 
	`ùoib_dñëe_debug_fûes
(
dev
);

136  
NOTIFY_DONE
;

137 
	}
}

140 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

142 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

144 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

146 
	`√tif_ˇºõr_off
(
dev
);

148 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

150 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

152 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

153 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

155 
îr_dißbÀ
;

158 
	`ùoib_ib_dev_up
(
dev
);

160 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

161 
ùoib_dev_¥iv
 *
˝riv
;

164 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

165 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

166 
Êags
;

168 
Êags
 = 
˝riv
->
dev
->flags;

169 i‡(
Êags
 & 
IFF_UP
)

172 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
);

174 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

177 
	`√tif_°¨t_queue
(
dev
);

181 
îr_dißbÀ
:

182 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

184  -
EINVAL
;

185 
	}
}

187 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

191 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

193 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

195 
	`√tif_°›_queue
(
dev
);

197 
	`ùoib_ib_dev_down
(
dev
);

198 
	`ùoib_ib_dev_°›
(
dev
);

200 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

201 
ùoib_dev_¥iv
 *
˝riv
;

204 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

205 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

206 
Êags
;

208 
Êags
 = 
˝riv
->
dev
->flags;

209 i‡(!(
Êags
 & 
IFF_UP
))

212 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
);

214 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

218 
	}
}

220 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

222 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

224 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

225 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

227  
„©uªs
;

228 
	}
}

230 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

232 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

233 
ªt
 = 0;

236 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

237 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

238  -
EINVAL
;

240 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

241 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

242 
¥iv
->
mˇ°_mtu
);

244 
dev
->
mtu
 = 
√w_mtu
;

248 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

249 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

250  -
EINVAL
;

252 
¥iv
->
admö_mtu
 = 
√w_mtu
;

254 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

255 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

256 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

258 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

260 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

261 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

263 
	`√tif_ˇºõr_off
(
dev
);

266 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

268 i‡(
ˇºõr_°©us
)

269 
	`√tif_ˇºõr_⁄
(
dev
);

271 
dev
->
mtu
 = 
√w_mtu
;

274  
ªt
;

275 
	}
}

277 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

278 
π∆_lök_°©s64
 *
°©s
)

280 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

282 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

283 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

285 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

286 
	}
}

289 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

290 
√t_devi˚
 *
dev
)

292 
√t
 *√à
	`dev_√t
(
dev
);

293 
ö_devi˚
 *
ö_dev
;

294 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

295 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

296 
__be32
 
ªt_addr
;

298 
addr
->
ß_Ámûy
) {

299 
AF_INET
:

300 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

301 i‡(!
ö_dev
)

302  
Ál£
;

304 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

305 
addr_ö
->
sö_addr
.
s_addr
,

306 
RT_SCOPE_HOST
);

307 
	`ö_dev_put
(
ö_dev
);

308 i‡(
ªt_addr
)

309  
åue
;

312 
AF_INET6
:

313 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

314 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

315  
åue
;

319  
Ál£
;

320 
	}
}

329 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

331 
√t_devi˚
 *
ma°î
;

333 
	`rcu_ªad_lock
();

334 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

335 i‡(
ma°î
)

336 
	`dev_hﬁd
(
ma°î
);

337 
	`rcu_ªad_u∆ock
();

339 i‡(
ma°î
)

340  
ma°î
;

342 
	`dev_hﬁd
(
dev
);

343  
dev
;

344 
	}
}

346 
	sùoib_wÆk_d©a
 {

347 c⁄° 
sockaddr
 *
	maddr
;

348 
√t_devi˚
 *
	mªsu…
;

351 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

353 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

354 
ªt
 = 0;

356 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

357 
	`dev_hﬁd
(
uµî
);

358 
d©a
->
ªsu…
 = 
uµî
;

359 
ªt
 = 1;

362  
ªt
;

363 
	}
}

374 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

375 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

377 
ùoib_wÆk_d©a
 
d©a
 = {

378 .
addr
 =áddr,

381 
	`rcu_ªad_lock
();

382 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

383 
	`dev_hﬁd
(
dev
);

384 
d©a
.
ªsu…
 = 
dev
;

385 
out
;

388 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

389 
out
:

390 
	`rcu_ªad_u∆ock
();

391  
d©a
.
ªsu…
;

392 
	}
}

399 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

400 c⁄° 
ib_gid
 *
gid
,

401 
u16
 
pkey_ödex
,

402 c⁄° 
sockaddr
 *
addr
,

403 
√°ög
,

404 
√t_devi˚
 **
found_√t_dev
)

406 
ùoib_dev_¥iv
 *
chûd_¥iv
;

407 
√t_devi˚
 *
√t_dev
 = 
NULL
;

408 
m©ches
 = 0;

410 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

411 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

412 i‡(!
addr
) {

413 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

417 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

419 i‡(
√t_dev
) {

420 i‡(!*
found_√t_dev
)

421 *
found_√t_dev
 = 
√t_dev
;

423 
	`dev_put
(
√t_dev
);

424 ++
m©ches
;

429 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

430 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

431 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

432 
pkey_ödex
, 
addr
,

433 
√°ög
 + 1,

434 
found_√t_dev
);

435 i‡(
m©ches
 > 1)

438 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

440  
m©ches
;

441 
	}
}

446 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

447 
u16
 
pkey_ödex
,

448 c⁄° 
ib_gid
 *
gid
,

449 c⁄° 
sockaddr
 *
addr
,

450 
√t_devi˚
 **
√t_dev
)

452 
ùoib_dev_¥iv
 *
¥iv
;

453 
m©ches
 = 0;

455 *
√t_dev
 = 
NULL
;

457 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

458 i‡(
¥iv
->
p‹t
 !=Öort)

461 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

462 
addr
, 0, 
√t_dev
);

463 i‡(
m©ches
 > 1)

467  
m©ches
;

468 
	}
}

470 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

471 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

472 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

473 *
˛õ¡_d©a
)

475 
√t_devi˚
 *
√t_dev
;

476 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

477 
u16
 
pkey_ödex
;

478 
m©ches
;

479 
ªt
;

481 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

482  
NULL
;

484 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

485 i‡(
ªt
)

486  
NULL
;

488 i‡(!
dev_li°
)

489  
NULL
;

492 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

493 
gid
, 
NULL
, &
√t_dev
);

495 
m©ches
) {

497  
NULL
;

499  
√t_dev
;

502 
	`dev_put
(
√t_dev
);

506 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

507 
gid
, 
addr
, &
√t_dev
);

508 
m©ches
) {

510  
NULL
;

512 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

516  
√t_dev
;

518 
	}
}

520 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

522 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

524 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "connected\n")) ||

526 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

527 !
	`°rcmp
(
buf
, "datagram\n"))) {

532 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

533 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

534 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

536 
	`√tdev_upd©e_„©uªs
(
dev
);

537 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

538 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

539 
	`π∆_u∆ock
();

540 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

542 
	`ùoib_Êush_∑ths
(
dev
);

543  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

546 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

547 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

548 
	`√tdev_upd©e_„©uªs
(
dev
);

549 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

550 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

551 
	`π∆_u∆ock
();

552 
	`ùoib_Êush_∑ths
(
dev
);

553  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

556  -
EINVAL
;

557 
	}
}

559 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

561 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

562 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

563 
ùoib_∑th
 *
∑th
;

564 
ªt
;

566 
n
) {

567 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

569 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

570  (
ib_gid
));

572 i‡(
ªt
 < 0)

573 
n
 =Ç->
rb_À·
;

574 i‡(
ªt
 > 0)

575 
n
 =Ç->
rb_right
;

577  
∑th
;

580  
NULL
;

581 
	}
}

583 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

586 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

587 
rb_node
 *
≤
 = 
NULL
;

588 
ùoib_∑th
 *
ç©h
;

589 
ªt
;

591 *
n
) {

592 
≤
 = *
n
;

593 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

595 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

596  (
ib_gid
));

597 i‡(
ªt
 < 0)

598 
n
 = &
≤
->
rb_À·
;

599 i‡(
ªt
 > 0)

600 
n
 = &
≤
->
rb_right
;

602  -
EEXIST
;

605 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

606 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

608 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

611 
	}
}

613 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

615 
sk_buff
 *
skb
;

617 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

618 
	`dev_k‰ì_skb_úq
(
skb
);

620 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "path_free\n");

623 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

625 i‡(
∑th
->
ah
)

626 
	`ùoib_put_ah
(
∑th
->
ah
);

628 
	`k‰ì
(
∑th
);

629 
	}
}

631 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


633 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

635 
ùoib_∑th_ôî
 *
ôî
;

637 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

638 i‡(!
ôî
)

639  
NULL
;

641 
ôî
->
dev
 = dev;

642 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

644 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

645 
	`k‰ì
(
ôî
);

646  
NULL
;

649  
ôî
;

650 
	}
}

652 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

654 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

655 
rb_node
 *
n
;

656 
ùoib_∑th
 *
∑th
;

657 
ªt
 = 1;

659 
	`•ö_lock_úq
(&
¥iv
->
lock
);

661 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

663 
n
) {

664 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

666 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

667  (
ib_gid
)) < 0) {

668 
ôî
->
∑th
 = *path;

669 
ªt
 = 0;

673 
n
 = 
	`rb_√xt
(n);

676 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

678  
ªt
;

679 
	}
}

681 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

682 
ùoib_∑th
 *
∑th
)

684 *
∑th
 = 
ôî
->path;

685 
	}
}

689 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

692 
ùoib_∑th
 *
∑th
, *
ç
;

694 
	`•ö_lock_úq
(&
¥iv
->
lock
);

696 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

697 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

698 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

699 
∑th
->
∑thªc
.
dgid
.
øw
);

700 i‡(
∑th
->
ah
)

701 
∑th
->
ah
->
vÆid
 = 0;

704 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

705 
	}
}

707 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

709 
ùoib_p£udo_hódî
 *
phdr
;

711 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

712 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

713 
	}
}

715 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

717 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

718 
ùoib_∑th
 *
∑th
, *
ç
;

719 
	`LIST_HEAD
(
ªmove_li°
);

720 
Êags
;

722 
	`√tif_tx_lock_bh
(
dev
);

723 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

725 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

727 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

728 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

730 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

731 i‡(
∑th
->
quîy
)

732 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

733 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

734 
	`√tif_tx_u∆ock_bh
(
dev
);

735 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

736 
	`∑th_‰ì
(
dev
, 
∑th
);

737 
	`√tif_tx_lock_bh
(
dev
);

738 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

741 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

742 
	`√tif_tx_u∆ock_bh
(
dev
);

743 
	}
}

745 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

746 
ß_∑th_ªc
 *
∑thªc
,

747 *
∑th_±r
)

749 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

750 
√t_devi˚
 *
dev
 = 
∑th
->dev;

751 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

752 
ùoib_ah
 *
ah
 = 
NULL
;

753 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

754 
ùoib_√igh
 *
√igh
, *
ä
;

755 
sk_buff_hód
 
skqueue
;

756 
sk_buff
 *
skb
;

757 
Êags
;

759 i‡(!
°©us
)

760 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

761 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

762 
∑thªc
->
dgid
.
øw
);

764 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

765 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

767 
	`skb_queue_hód_öô
(&
skqueue
);

769 i‡(!
°©us
) {

770 
rdma_ah_©å
 
av
;

772 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

773 
∑thªc
, &
av
, 
NULL
)) {

774 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

775 
	`rdma_de°roy_ah_©å
(&
av
);

779 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

781 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

787 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

788 (
ib_gid
))) {

789 
	`ùoib_dbg
(

790 
¥iv
,

792 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

793 
∑th
->
∑thªc
.
dgid
.
øw
);

794 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

795 (
ib_gid
));

798 
∑th
->
∑thªc
 = *pathrec;

800 
ﬁd_ah
 = 
∑th
->
ah
;

801 
∑th
->
ah
 =áh;

803 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

804 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

805 
∑thªc
->
¶
);

807 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

808 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

810 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

811 i‡(
√igh
->
ah
) {

812 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

820 
	`ùoib_put_ah
(
√igh
->
ah
);

822 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

823 
√igh
->
ah
 = 
∑th
->ah;

825 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

826 i‡(!
	`ùoib_cm_gë
(
√igh
))

827 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

828 
∑th
,

829 
√igh
));

830 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

831 
	`ùoib_√igh_‰ì
(
√igh
);

836 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

837 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

839 
∑th
->
ah
->
vÆid
 = 1;

842 
∑th
->
quîy
 = 
NULL
;

843 
	`com∂ëe
(&
∑th
->
d⁄e
);

845 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

847 i‡(
	`IS_ERR_OR_NULL
(
ah
))

848 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

850 i‡(
ﬁd_ah
)

851 
	`ùoib_put_ah
(
ﬁd_ah
);

853 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

854 
ªt
;

855 
skb
->
dev
 = dev;

856 
ªt
 = 
	`dev_queue_xmô
(
skb
);

857 i‡(
ªt
)

858 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

859 
__func__
, 
ªt
);

861 
	}
}

863 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

864 *
gid
)

866 
∑th
->
dev
 = 
¥iv
->dev;

868 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

871 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

873 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

874 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

875 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

876 
∑th
->
∑thªc
.
numb_∑th
 = 1;

877 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

878 
	}
}

880 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

882 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

883 
ùoib_∑th
 *
∑th
;

885 i‡(!
¥iv
->
brﬂdˇ°
)

886  
NULL
;

888 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

889 i‡(!
∑th
)

890  
NULL
;

892 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

894 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

896 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

898  
∑th
;

899 
	}
}

901 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

902 
ùoib_∑th
 *
∑th
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

906 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

907 
∑th
->
∑thªc
.
dgid
.
øw
);

909 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

911 
∑th
->
quîy_id
 =

912 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

913 &
∑th
->
∑thªc
,

914 
IB_SA_PATH_REC_DGID
 |

915 
IB_SA_PATH_REC_SGID
 |

916 
IB_SA_PATH_REC_NUMB_PATH
 |

917 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

918 
IB_SA_PATH_REC_PKEY
,

919 1000, 
GFP_ATOMIC
,

920 
∑th_ªc_com∂ëi⁄
,

921 
∑th
, &∑th->
quîy
);

922 i‡(
∑th
->
quîy_id
 < 0) {

923 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

924 
∑th
->
quîy
 = 
NULL
;

925 
	`com∂ëe
(&
∑th
->
d⁄e
);

926  
∑th
->
quîy_id
;

930 
	}
}

932 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

933 
√t_devi˚
 *
dev
)

935 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

936 
ùoib_∑th
 *
∑th
;

937 
Êags
;

939 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

941 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

942 i‡(!
∑th
)

943 
out
;

944 i‡(!
∑th
->
quîy
)

945 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

946 
out
:

947 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

948 
	}
}

950 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

951 
√t_devi˚
 *
dev
)

953 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

954 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

955 
ùoib_∑th
 *
∑th
;

956 
ùoib_√igh
 *
√igh
;

957 
Êags
;

959 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

960 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

961 i‡(!
√igh
) {

962 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

963 ++
dev
->
°©s
.
tx_dr›≥d
;

964 
	`dev_k‰ì_skb_™y
(
skb
);

965  
NULL
;

971 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

972 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

973  
√igh
;

976 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
) {

978 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

979 i‡(!
∑th
)

980 
îr_∑th
;

982 
	`__∑th_add
(
dev
, 
∑th
);

985 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

987 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

988 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

989 
√igh
->
ah
 = 
∑th
->ah;

991 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

992 i‡(!
	`ùoib_cm_gë
(
√igh
))

993 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

994 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

995 
	`ùoib_√igh_‰ì
(
√igh
);

996 
îr_dr›
;

998 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

999 
IPOIB_MAX_PATH_REC_QUEUE
) {

1000 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1001 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1003 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1004 
	`skb_queue_Àn
(&
√igh
->
queue
));

1005 
îr_dr›
;

1008 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1009 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1010 
	`IPOIB_QPN
(
daddr
));

1011 
	`ùoib_√igh_put
(
√igh
);

1012  
NULL
;

1015 
√igh
->
ah
 = 
NULL
;

1017 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1018 
îr_∑th
;

1019 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1020 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1021 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1023 
îr_dr›
;

1027 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1028 
	`ùoib_√igh_put
(
√igh
);

1029  
NULL
;

1031 
îr_∑th
:

1032 
	`ùoib_√igh_‰ì
(
√igh
);

1033 
îr_dr›
:

1034 ++
dev
->
°©s
.
tx_dr›≥d
;

1035 
	`dev_k‰ì_skb_™y
(
skb
);

1037 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1038 
	`ùoib_√igh_put
(
√igh
);

1040  
NULL
;

1041 
	}
}

1043 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1044 
ùoib_p£udo_hódî
 *
phdr
)

1046 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1047 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1048 
ùoib_∑th
 *
∑th
;

1049 
Êags
;

1051 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1054 i‡(!
¥iv
->
brﬂdˇ°
)

1055 
dr›_™d_u∆ock
;

1057 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1058 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1059 i‡(!
∑th
) {

1060 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1061 i‡(!
∑th
)

1062 
dr›_™d_u∆ock
;

1063 
	`__∑th_add
(
dev
, 
∑th
);

1069 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1071 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1072 
dr›_™d_u∆ock
;

1075 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1076 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1077 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1078 
u∆ock
;

1080 
dr›_™d_u∆ock
;

1084 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1085 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1086 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1087 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1088 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1091 
dr›_™d_u∆ock
:

1092 ++
dev
->
°©s
.
tx_dr›≥d
;

1093 
	`dev_k‰ì_skb_™y
(
skb
);

1094 
u∆ock
:

1095 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1096 
	}
}

1098 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1100 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1101 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1102 
ùoib_√igh
 *
√igh
;

1103 
ùoib_p£udo_hódî
 *
phdr
;

1104 
ùoib_hódî
 *
hódî
;

1105 
Êags
;

1107 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1108 
	`skb_puŒ
(
skb
, (*
phdr
));

1109 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1111 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1113 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1116 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1117 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1119 ++
dev
->
°©s
.
tx_dr›≥d
;

1120 
	`dev_k‰ì_skb_™y
(
skb
);

1121  
NETDEV_TX_OK
;

1124 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1125 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1127 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1128 i‡(
	`likñy
(
√igh
))

1129 
£nd_usög_√igh
;

1130 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1131  
NETDEV_TX_OK
;

1135 
hódî
->
¥Ÿo
) {

1136 
	`ht⁄s
(
ETH_P_IP
):

1137 
	`ht⁄s
(
ETH_P_IPV6
):

1138 
	`ht⁄s
(
ETH_P_TIPC
):

1139 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1140 i‡(
	`u∆ikñy
(!
√igh
)) {

1141 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1142 i‡(
	`likñy
(!
√igh
))

1143  
NETDEV_TX_OK
;

1146 
	`ht⁄s
(
ETH_P_ARP
):

1147 
	`ht⁄s
(
ETH_P_RARP
):

1149 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1150  
NETDEV_TX_OK
;

1153 ++
dev
->
°©s
.
tx_dr›≥d
;

1154 
	`dev_k‰ì_skb_™y
(
skb
);

1155  
NETDEV_TX_OK
;

1158 
£nd_usög_√igh
:

1160 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1161 i‡(
	`ùoib_cm_up
(
√igh
)) {

1162 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1163 
uƒef
;

1165 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1166 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1167 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1168 
uƒef
;

1169 } i‡(
√igh
->
ah
) {

1170 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1173 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1174 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1175 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1176 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1177 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1179 ++
dev
->
°©s
.
tx_dr›≥d
;

1180 
	`dev_k‰ì_skb_™y
(
skb
);

1183 
uƒef
:

1184 
	`ùoib_√igh_put
(
√igh
);

1186  
NETDEV_TX_OK
;

1187 
	}
}

1189 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1191 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1193 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1194 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1195 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1196 
	`√tif_queue_°›≥d
(
dev
),

1197 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1199 
	}
}

1201 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1202 
√t_devi˚
 *
dev
,

1203 
ty≥
,

1204 c⁄° *
daddr
,

1205 c⁄° *
ßddr
,

1206 
Àn
)

1208 
ùoib_hódî
 *
hódî
;

1210 
hódî
 = 
	`skb_push
(
skb
, (*header));

1212 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1213 
hódî
->
ª£rved
 = 0;

1220 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1222  
IPOIB_HARD_LEN
;

1223 
	}
}

1225 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1227 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1229 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1230 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1234 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1235 
	}
}

1237 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1239 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1242 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1243  
dev
->
ifödex
;

1246  
¥iv
->
∑ª¡
->
ifödex
;

1247 
	}
}

1249 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1258 
u32
 *
d32
 = (u32 *Ë
daddr
;

1259 
u32
 
hv
;

1261 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1262  
hv
 & 
htbl
->
mask
;

1263 
	}
}

1265 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1267 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1268 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1269 
ùoib_√igh_hash
 *
htbl
;

1270 
ùoib_√igh
 *
√igh
 = 
NULL
;

1271 
u32
 
hash_vÆ
;

1273 
	`rcu_ªad_lock_bh
();

1275 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1277 i‡(!
htbl
)

1278 
out_u∆ock
;

1280 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1282 
√igh
 !
NULL
;

1283 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1284 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1286 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1288 
√igh
 = 
NULL
;

1289 
out_u∆ock
;

1292 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1293 
√igh
->
Æive
 = 
jiffõs
;

1294 
out_u∆ock
;

1298 
out_u∆ock
:

1299 
	`rcu_ªad_u∆ock_bh
();

1300  
√igh
;

1301 
	}
}

1303 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1305 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1306 
ùoib_√igh_hash
 *
htbl
;

1307 
√igh_obsﬁëe
;

1308 
dt
;

1309 
Êags
;

1310 
i
;

1311 
	`LIST_HEAD
(
ªmove_li°
);

1313 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1315 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1316 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1318 i‡(!
htbl
)

1319 
out_u∆ock
;

1322 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1323 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1325 
i
 = 0; i < 
htbl
->
size
; i++) {

1326 
ùoib_√igh
 *
√igh
;

1327 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1329 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1330 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1332 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1334 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1336 
	`rcu_assign_poöãr
(*
≈
,

1337 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1338 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1340 
	`li°_dñ_öô
(&
√igh
->
li°
);

1341 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1343 
≈
 = &
√igh
->
h√xt
;

1349 
out_u∆ock
:

1350 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1351 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1352 
	}
}

1354 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1356 
ùoib_dev_¥iv
 *
¥iv
 =

1357 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1359 
	`__ùoib_ª≠_√igh
(
¥iv
);

1361 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1362 
¨p_tbl
.
gc_öãrvÆ
);

1363 
	}
}

1366 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1367 
√t_devi˚
 *
dev
)

1369 
ùoib_√igh
 *
√igh
;

1371 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1372 i‡(!
√igh
)

1373  
NULL
;

1375 
√igh
->
dev
 = dev;

1376 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1377 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1378 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1379 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1381 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1383  
√igh
;

1384 
	}
}

1386 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1387 
√t_devi˚
 *
dev
)

1389 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1390 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1391 
ùoib_√igh_hash
 *
htbl
;

1392 
ùoib_√igh
 *
√igh
;

1393 
u32
 
hash_vÆ
;

1395 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1396 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1397 i‡(!
htbl
) {

1398 
√igh
 = 
NULL
;

1399 
out_u∆ock
;

1405 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1406 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1407 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1408 
√igh
 !
NULL
;

1409 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1410 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1411 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1413 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1415 
√igh
 = 
NULL
;

1418 
√igh
->
Æive
 = 
jiffõs
;

1419 
out_u∆ock
;

1423 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1424 i‡(!
√igh
)

1425 
out_u∆ock
;

1428 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1429 
√igh
->
Æive
 = 
jiffõs
;

1431 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1432 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1433 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1434 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1435 
	`©omic_öc
(&
¡bl
->
íåõs
);

1437 
out_u∆ock
:

1439  
√igh
;

1440 
	}
}

1442 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1445 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1447 
sk_buff
 *
skb
;

1448 i‡(
√igh
->
ah
)

1449 
	`ùoib_put_ah
(
√igh
->
ah
);

1450 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1451 ++
dev
->
°©s
.
tx_dr›≥d
;

1452 
	`dev_k‰ì_skb_™y
(
skb
);

1454 i‡(
	`ùoib_cm_gë
(
√igh
))

1455 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1456 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1458 
	`IPOIB_QPN
(
√igh
->
daddr
),

1459 
√igh
->
daddr
 + 4);

1460 
	`k‰ì
(
√igh
);

1461 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1462 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1463 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1465 
	}
}

1467 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1470 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1472 
	`ùoib_√igh_put
(
√igh
);

1473 
	}
}

1475 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1477 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1478 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1479 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1480 
ùoib_√igh_hash
 *
htbl
;

1481 
ùoib_√igh
 
__rcu
 **
≈
;

1482 
ùoib_√igh
 *
n
;

1483 
u32
 
hash_vÆ
;

1485 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1486 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1487 i‡(!
htbl
)

1490 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1491 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1492 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1493 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1494 
n
 !
NULL
;

1495 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1496 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1497 i‡(
n
 =
√igh
) {

1499 
	`rcu_assign_poöãr
(*
≈
,

1500 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1501 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1503 
	`li°_dñ_öô
(&
√igh
->
li°
);

1504 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1507 
≈
 = &
n
->
h√xt
;

1510 
	}
}

1512 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1514 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1515 
ùoib_√igh_hash
 *
htbl
;

1516 
ùoib_√igh
 
__rcu
 **
buckës
;

1517 
u32
 
size
;

1519 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1520 
¡bl
->
htbl
 = 
NULL
;

1521 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1522 i‡(!
htbl
)

1523  -
ENOMEM
;

1524 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1525 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1526 i‡(!
buckës
) {

1527 
	`k‰ì
(
htbl
);

1528  -
ENOMEM
;

1530 
htbl
->
size
 = size;

1531 
htbl
->
mask
 = (
size
 - 1);

1532 
htbl
->
buckës
 = buckets;

1533 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1534 
htbl
->
¡bl
 =Çtbl;

1535 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1538 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1539 
¨p_tbl
.
gc_öãrvÆ
);

1542 
	}
}

1544 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1546 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1547 
ùoib_√igh_hash
,

1548 
rcu
);

1549 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1550 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1552 
	`kv‰ì
(
buckës
);

1553 
	`k‰ì
(
htbl
);

1554 
	`com∂ëe
(&
¡bl
->
dñëed
);

1555 
	}
}

1557 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1560 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1561 
ùoib_√igh_hash
 *
htbl
;

1562 
Êags
;

1563 
i
;

1566 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1568 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1569 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1571 i‡(!
htbl
)

1572 
out_u∆ock
;

1574 
i
 = 0; i < 
htbl
->
size
; i++) {

1575 
ùoib_√igh
 *
√igh
;

1576 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1578 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1579 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1581 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1582 
	`rcu_assign_poöãr
(*
≈
,

1583 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1584 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1586 
	`li°_dñ_öô
(&
√igh
->
li°
);

1587 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1589 
≈
 = &
√igh
->
h√xt
;

1594 
out_u∆ock
:

1595 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1596 
	}
}

1598 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1600 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1601 
ùoib_√igh_hash
 *
htbl
;

1602 
Êags
;

1603 
i
, 
waô_Êushed
 = 0;

1605 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1606 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1608 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1610 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1611 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1612 i‡(!
htbl
)

1613 
out_u∆ock
;

1615 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1616 i‡(!
waô_Êushed
)

1617 
‰ì_htbl
;

1619 
i
 = 0; i < 
htbl
->
size
; i++) {

1620 
ùoib_√igh
 *
√igh
;

1621 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1623 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1624 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1625 
	`rcu_assign_poöãr
(*
≈
,

1626 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1627 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1629 
	`li°_dñ_öô
(&
√igh
->
li°
);

1630 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1634 
‰ì_htbl
:

1635 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1636 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1638 
out_u∆ock
:

1639 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1640 i‡(
waô_Êushed
)

1641 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1642 
	}
}

1644 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1648 
	`ùoib_dbg
(
¥iv
, "ipoib_neigh_hash_uninit\n");

1649 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1651 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1653 
	`ùoib_Êush_√ighs
(
¥iv
);

1655 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1656 
	}
}

1658 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1660 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1662 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1663 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1664 
	}
}

1666 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1668 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1670 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1671 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1672 
	}
}

1674 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1676 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1678 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1680 
	`ùoib_«pi_dñ
(
dev
);

1682 
	`ùoib_cm_dev_˛ónup
(
dev
);

1684 
	`k‰ì
(
¥iv
->
rx_rög
);

1685 
	`v‰ì
(
¥iv
->
tx_rög
);

1687 
¥iv
->
rx_rög
 = 
NULL
;

1688 
¥iv
->
tx_rög
 = 
NULL
;

1689 
	}
}

1691 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1693 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1695 
	`ùoib_«pi_add
(
dev
);

1698 
¥iv
->
rx_rög
 = 
	`kzÆloc
(
ùoib_ªcvq_size
 *  *priv->rx_ring,

1699 
GFP_KERNEL
);

1700 i‡(!
¥iv
->
rx_rög
)

1701 
out
;

1703 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
ùoib_£ndq_size
 *  *priv->tx_ring);

1704 i‡(!
¥iv
->
tx_rög
) {

1705 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1706 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1707 
out_rx_rög_˛ónup
;

1712 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1713 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1714 
¥iv
->
ˇ
->
«me
);

1715 
out_tx_rög_˛ónup
;

1719 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1720 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1721 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1725 
out_tx_rög_˛ónup
:

1726 
	`v‰ì
(
¥iv
->
tx_rög
);

1728 
out_rx_rög_˛ónup
:

1729 
	`k‰ì
(
¥iv
->
rx_rög
);

1731 
out
:

1732 
	`ùoib_«pi_dñ
(
dev
);

1733  -
ENOMEM
;

1734 
	}
}

1736 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1737 
cmd
)

1739 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1741 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1742  -
EOPNOTSUPP
;

1744  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1745 
	}
}

1747 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1750 
ªt
 = -
ENOMEM
;

1752 
¥iv
->
qp
 = 
NULL
;

1758 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1759 i‡(!
¥iv
->
wq
) {

1760 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1761 
out
;

1765 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1766 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1767 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1768 
˛ón_wq
;

1771 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1772 i‡(
ªt
) {

1773 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1774 
out_‰ì_pd
;

1777 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1778 i‡(
ªt
) {

1779 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1780 
out_dev_unöô
;

1783 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1784 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1785 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1786 
ªt
 = -
ENODEV
;

1787 
out_hash_unöô
;

1793 
out_hash_unöô
:

1794 
	`ùoib_√igh_hash_unöô
(
dev
);

1796 
out_dev_unöô
:

1797 
	`ùoib_ib_dev_˛ónup
(
dev
);

1799 
out_‰ì_pd
:

1800 i‡(
¥iv
->
pd
) {

1801 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1802 
¥iv
->
pd
 = 
NULL
;

1805 
˛ón_wq
:

1806 i‡(
¥iv
->
wq
) {

1807 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1808 
¥iv
->
wq
 = 
NULL
;

1811 
out
:

1812  
ªt
;

1813 
	}
}

1819 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1821 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1827 
	`π∆_lock
();

1828 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
);

1829 
	`π∆_u∆ock
();

1832 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1838 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1839 
	}
}

1841 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1843 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1845 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1846 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1848 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1849 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1851 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1853 
	}
}

1855 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1858 
ib_p‹t_©å
 
©å
;

1859 
ªsu…
;

1861 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1862 i‡(
ªsu…
) {

1863 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1864 
¥iv
->
p‹t
);

1865  
ªsu…
;

1868 i‡(
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
Ë&& 
ùoib_ac˚l
)

1869 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1871 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1873 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1874 i‡(
ªsu…
) {

1875 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1876 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1877  
ªsu…
;

1880 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1881 i‡(
ªsu…
) {

1882 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1883 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1884  
ªsu…
;

1886 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1887 (
ib_gid
));

1889 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1890 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1892 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1895 
	}
}

1897 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1899 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1900 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1902 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1903 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1904 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1905 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1906 
	}
}

1908 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1910 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1911 
rc
;

1912 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
ndev
);

1914 i‡(
¥iv
->
∑ª¡
) {

1915 
	`ùoib_chûd_öô
(
ndev
);

1917 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1918 i‡(
rc
)

1919  
rc
;

1923 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1924 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1925 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1926 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1928 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1934 
¥iv
->
pkey
 |= 0x8000;

1936 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1937 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1938 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1940 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1942 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1943 i‡(
rc
) {

1944 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1945 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1946  
rc
;

1949 i‡(
¥iv
->
∑ª¡
) {

1950 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1952 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1954 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1955 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1956 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1960 
	}
}

1962 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1964 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1966 
	`ASSERT_RTNL
();

1972 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1974 i‡(
¥iv
->
∑ª¡
) {

1975 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1977 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1978 
	`li°_dñ
(&
¥iv
->
li°
);

1979 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`ùoib_√igh_hash_unöô
(
dev
);

1984 
	`ùoib_ib_dev_˛ónup
(
dev
);

1987 i‡(
¥iv
->
wq
) {

1988 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1989 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1990 
¥iv
->
wq
 = 
NULL
;

1993 i‡(
¥iv
->
∑ª¡
)

1994 
	`dev_put
(
¥iv
->
∑ª¡
);

1995 
	}
}

1997 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1999 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2001  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2002 
	}
}

2004 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2005 
iÊa_vf_öfo
 *
ivf
)

2007 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2008 
îr
;

2010 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2011 i‡(
îr
)

2012  
îr
;

2014 
ivf
->
vf
 = vf;

2017 
	}
}

2019 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2021 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2023 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2024  -
EINVAL
;

2026  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2027 
	}
}

2029 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2030 
iÊa_vf_°©s
 *
vf_°©s
)

2032 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2034  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2035 
	}
}

2037 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2038 .
¸óã
 = 
ùoib_h¨d_hódî
,

2041 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2042 .
ndo_öô
 = 
ùoib_ndo_öô
,

2043 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2044 .
	gndo_›í
 = 
ùoib_›í
,

2045 .
	gndo_°›
 = 
ùoib_°›
,

2046 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2047 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2048 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2049 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2050 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2051 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2052 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2053 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2054 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2055 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2056 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2057 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2058 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2061 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2062 .
ndo_öô
 = 
ùoib_ndo_öô
,

2063 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2064 .
	gndo_›í
 = 
ùoib_›í
,

2065 .
	gndo_°›
 = 
ùoib_°›
,

2066 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2067 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2068 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2069 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2070 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2071 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2072 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2073 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2076 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2077 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2078 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2079 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2080 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2083 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2085 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2086 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2088 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2090 
dev
->
w©chdog_timeo
 = 
HZ
;

2092 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2094 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2095 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2096 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2097 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2098 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2099 
NETIF_F_HIGHDMA
);

2100 
	`√tif_kìp_d°
(
dev
);

2102 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2109 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2110 
	}
}

2112 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2114 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2116 
¥iv
->
dev
 = dev;

2117 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2118 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2119 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2121 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2122 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2123 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2124 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2126 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2127 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2128 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2129 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2130 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2131 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2132 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2133 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2134 
	}
}

2136 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2137 c⁄° *
«me
)

2139 
√t_devi˚
 *
dev
;

2141 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2142 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2143 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2144  
dev
;

2146 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2147 
ùoib_£tup_comm⁄
);

2148 i‡(!
dev
)

2149  
	`ERR_PTR
(-
ENOMEM
);

2150  
dev
;

2151 
	}
}

2153 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2154 
√t_devi˚
 *
dev
)

2156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2157 
ùoib_dev_¥iv
 *
¥iv
;

2158 
rc
;

2160 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2161 i‡(!
¥iv
)

2162  -
ENOMEM
;

2164 
¥iv
->
ˇ
 = 
hˇ
;

2165 
¥iv
->
p‹t
 =Öort;

2167 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2168 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2169 i‡(
rc
) {

2170 i‡(
rc
 !-
EOPNOTSUPP
)

2171 
out
;

2173 
∫
->
£nd
 = 
ùoib_£nd
;

2174 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2175 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2176 
∫
->
hˇ
 = hca;

2179 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2181 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2182 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2184 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2186 
∫
->
˛¡_¥iv
 = 
¥iv
;

2192 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2193 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2195 
	`ùoib_buûd_¥iv
(
dev
);

2199 
out
:

2200 
	`k‰ì
(
¥iv
);

2201  
rc
;

2202 
	}
}

2204 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2205 c⁄° *
«me
)

2207 
√t_devi˚
 *
dev
;

2208 
rc
;

2210 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2211 i‡(
	`IS_ERR
(
dev
))

2212  
dev
;

2214 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2215 i‡(
rc
) {

2216 
	`‰ì_√tdev
(
dev
);

2217  
	`ERR_PTR
(
rc
);

2225  
dev
;

2226 
	}
}

2228 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2231 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2233 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2234 i‡(
dev
->
¥iv_de°ru˘‹
)

2235 
dev
->
	`¥iv_de°ru˘‹
(dev);

2241 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2244 
∫
->
˛¡_¥iv
 = 
NULL
;

2246 
	`k‰ì
(
¥iv
);

2247 
	}
}

2249 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2250 
devi˚_©åibuã
 *
©å
, *
buf
)

2252 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2253 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2255  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2256 
	}
}

2257 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2259 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2260 
devi˚_©åibuã
 *
©å
, *
buf
)

2262 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2263 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2265  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2266 
	}
}

2268 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2270 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2272 i‡(
umˇ°_vÆ
 > 0) {

2273 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2274 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2277 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2278 
	}
}

2280 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2281 
devi˚_©åibuã
 *
©å
,

2282 c⁄° *
buf
, 
size_t
 
cou¡
)

2284 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2286 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2288  
cou¡
;

2289 
	}
}

2290 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2292 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2294  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2295 
	}
}

2297 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2299 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2300 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2302 
	`√tif_addr_lock_bh
(
√tdev
);

2304 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2305 &
gid
->
globÆ
.
öãrÁ˚_id
,

2306 (
gid
->
globÆ
.
öãrÁ˚_id
));

2307 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2308 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2310 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2312 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2313 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2314 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2315 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2316 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2318 
	}
}

2320 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2321 
sockaddr_°‹age
 *
ss
)

2323 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2324 
ªt
 = 0;

2326 
	`√tif_addr_lock_bh
(
dev
);

2331 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2332 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2333 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2334 
ªt
 = -
EINVAL
;

2336 
	`√tif_addr_u∆ock_bh
(
dev
);

2338  
ªt
;

2339 
	}
}

2341 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2343 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2344 
sockaddr_°‹age
 *
ss
 = 
addr
;

2345 
ªt
;

2347 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2348  -
EBUSY
;

2350 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2351 i‡(
ªt
)

2352  
ªt
;

2354 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2356 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2359 
	}
}

2361 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2362 
devi˚_©åibuã
 *
©å
,

2363 c⁄° *
buf
, 
size_t
 
cou¡
)

2365 
pkey
;

2366 
ªt
;

2368 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2369  -
EINVAL
;

2371 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2372  -
EINVAL
;

2374 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2376  
ªt
 ?Ñë : 
cou¡
;

2377 
	}
}

2378 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2380 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2381 
devi˚_©åibuã
 *
©å
,

2382 c⁄° *
buf
, 
size_t
 
cou¡
)

2384 
pkey
;

2385 
ªt
;

2387 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2388  -
EINVAL
;

2390 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2391  -
EINVAL
;

2393 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2395  
ªt
 ?Ñë : 
cou¡
;

2397 
	}
}

2398 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2400 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2402  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2403 
	}
}

2414 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2415 
devi˚_©åibuã
 *
©å
, *
buf
)

2417 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2430 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2431 
	`√tdev_öfo_⁄˚
(
ndev
,

2433 
cuºít
->
comm
);

2435  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2436 
	}
}

2437 
DEVICE_ATTR_RO
(
dev_id
);

2439 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2441 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2442  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2443 
	}
}

2445 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2446 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2448 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2449 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2450 
ùoib_dev_¥iv
 *
¥iv
;

2451 
√t_devi˚
 *
ndev
;

2452 
ªsu…
;

2454 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2455 i‡(
	`IS_ERR
(
ndev
)) {

2456 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2457 
	`PTR_ERR
(
ndev
));

2458  
ndev
;

2460 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2462 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2463 
¥iv
->
ˇ
, 
ùoib_evít
);

2464 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2467 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2469 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2470 i‡(
ªsu…
) {

2471 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2472 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2474 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2475 
	`ùoib_ötf_‰ì
(
ndev
);

2476 
	`‰ì_√tdev
(
ndev
);

2478  
	`ERR_PTR
(
ªsu…
);

2481 i‡(
hˇ
->
rdma_√tdev_gë_∑øms
) {

2482 
rc
 = 
hˇ
->
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2483 
RDMA_NETDEV_IPOIB
,

2484 &
∑øms
);

2486 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2487 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2495 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2497 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2498 
sysfs_Áûed
;

2499 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2500 
sysfs_Áûed
;

2501 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2502 
sysfs_Áûed
;

2503 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2504 
sysfs_Áûed
;

2505 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2506 
sysfs_Áûed
;

2507 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2508 
sysfs_Áûed
;

2510  
ndev
;

2512 
sysfs_Áûed
:

2513 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2514 
	`uƒegi°î_√tdev
(
ndev
);

2515  
	`ERR_PTR
(-
ENOMEM
);

2516 
	}
}

2518 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2520 
li°_hód
 *
dev_li°
;

2521 
√t_devi˚
 *
dev
;

2522 
ùoib_dev_¥iv
 *
¥iv
;

2523 
p
;

2524 
cou¡
 = 0;

2526 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2527 i‡(!
dev_li°
)

2530 
	`INIT_LIST_HEAD
(
dev_li°
);

2532 
p
 = 
	`rdma_°¨t_p‹t
(
devi˚
);Ö <
	`rdma_íd_p‹t
(device); ++p) {

2533 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2535 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2536 i‡(!
	`IS_ERR
(
dev
)) {

2537 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2538 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2539 
cou¡
++;

2543 i‡(!
cou¡
) {

2544 
	`k‰ì
(
dev_li°
);

2548 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2549 
	}
}

2551 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2553 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2554 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2556 i‡(!
dev_li°
)

2559 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2560 
	`LIST_HEAD
(
hód
);

2561 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2563 
	`π∆_lock
();

2565 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2566 
li°
)

2567 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2568 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2569 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2571 
	`π∆_u∆ock
();

2574 
	`k‰ì
(
dev_li°
);

2575 
	}
}

2577 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2578 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2579 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2583 
__öô
 
	$ùoib_öô_moduÀ
()

2585 
ªt
;

2587 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2588 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2589 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2591 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2592 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2593 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2594 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2595 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2596 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2603 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2605 
ªt
 = 
	`ùoib_ªgi°î_debugfs
();

2606 i‡(
ªt
)

2607  
ªt
;

2619 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2620 i‡(!
ùoib_w‹kqueue
) {

2621 
ªt
 = -
ENOMEM
;

2622 
îr_fs
;

2625 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2627 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2628 i‡(
ªt
)

2629 
îr_ß
;

2631 
ªt
 = 
	`ùoib_√éök_öô
();

2632 i‡(
ªt
)

2633 
îr_˛õ¡
;

2635 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2636 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2640 
îr_˛õ¡
:

2641 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2643 
îr_ß
:

2644 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2645 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2647 
îr_fs
:

2648 
	`ùoib_uƒegi°î_debugfs
();

2650  
ªt
;

2651 
	}
}

2653 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2655 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2656 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2658 
	`ùoib_√éök_föi
();

2659 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2660 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2661 
	`ùoib_uƒegi°î_debugfs
();

2662 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2663 
	}
}

2665 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2666 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@SLES15SP1/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@SLES15SP1/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@SLES15SP1/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 i‡(
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
))

267 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (send) failed\n");

269 i‡(
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
))

270 
	`ùoib_w¨n
(
¥iv
, "ib_cq_destroy (recv) failed\n");

271 
	}
}

273 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

274 
ib_evít
 *
ªc‹d
)

276 
ùoib_dev_¥iv
 *
¥iv
 =

277 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

279 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

282 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

283 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

285 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

286 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

287 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

288 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

289 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

290 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

291 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

293 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

294 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

295 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

297 
	}
}

	@SLES15SP1/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

100 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
ndev
);

102 
	`ASSERT_RTNL
();

108 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

114 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

116 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

117 
ªsu…
 = -
EINVAL
;

118 
out_óæy
;

121 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

123 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

124 
¥iv
->
pkey
 =Ökey;

125 
¥iv
->
chûd_ty≥
 = 
ty≥
;

127 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

128 
ªsu…
 = -
ENOTUNIQ
;

129 
out_óæy
;

132 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

133 i‡(
ªsu…
) {

134 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

140 
out_óæy
;

144 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

145 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

146 
sysfs_Áûed
;

147 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

148 
sysfs_Áûed
;

149 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

150 
sysfs_Áûed
;

152 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

153 
sysfs_Áûed
;

158 
sysfs_Áûed
:

159 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

160  -
ENOMEM
;

162 
out_óæy
:

163 i‡(
ndev
->
¥iv_de°ru˘‹
)

164 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

165  
ªsu…
;

166 
	}
}

168 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

170 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

171 
ötf_«me
[
IFNAMSIZ
];

172 
√t_devi˚
 *
ndev
;

173 
ªsu…
;

175 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

176  -
EPERM
;

178 i‡(!
	`π∆_åylock
())

179  
	`ª°¨t_sysˇŒ
();

181 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

182 
	`π∆_u∆ock
();

183  -
EPERM
;

186 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

188 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

189 
µriv
->
dev
->
«me
, 
pkey
);

191 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

192 i‡(
	`IS_ERR
(
ndev
)) {

193 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

194 
out
;

196 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

198 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

200 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

201 
	`‰ì_√tdev
(
ndev
);

203 
out
:

204 
	`π∆_u∆ock
();

206  
ªsu…
;

207 
	}
}

209 
	sùoib_vœn_dñëe_w‹k
 {

210 
w‹k_°ru˘
 
	mw‹k
;

211 
√t_devi˚
 *
	mdev
;

224 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

226 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

227 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

228 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

230 
	`π∆_lock
();

233 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

234 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

235 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

237 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

238 
	`uƒegi°î_√tdevi˚
(
dev
);

241 
	`π∆_u∆ock
();

243 
	`k‰ì
(
pw‹k
);

244 
	}
}

246 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

248 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

249 
rc
;

251 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

252  -
EPERM
;

254 i‡(!
	`π∆_åylock
())

255  
	`ª°¨t_sysˇŒ
();

257 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

258 
	`π∆_u∆ock
();

259  -
EPERM
;

262 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

264 
rc
 = -
ENODEV
;

265 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

266 i‡(
¥iv
->
pkey
 ==Ökey &&

267 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

268 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

270 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

271 i‡(!
w‹k
) {

272 
rc
 = -
ENOMEM
;

273 
out
;

276 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

277 
	`li°_dñ_öô
(&
¥iv
->
li°
);

278 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

279 
w‹k
->
dev
 = 
¥iv
->dev;

280 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

281 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

283 
rc
 = 0;

288 
out
:

289 
	`π∆_u∆ock
();

291  
rc
;

292 
	}
}

	@SLES15SP2/ipoib/ipoib.h

35 #i‚de‡
_IPOIB_H


36 
	#_IPOIB_H


	)

38 
	~<löux/li°.h
>

39 
	~<löux/skbuff.h
>

40 
	~<löux/√tdevi˚.h
>

41 
	~<löux/w‹kqueue.h
>

42 
	~<löux/kªf.h
>

43 
	~<löux/if_öföib™d.h
>

44 
	~<löux/muãx.h
>

46 
	~<√t/√ighbour.h
>

47 
	~<√t/sch_gíîic.h
>

49 
	~<löux/©omic.h
>

51 
	~<rdma/ib_vîbs.h
>

52 
	~<rdma/ib_∑ck.h
>

53 
	~<rdma/ib_ß.h
>

54 
	~<löux/sched.h
>

58 
	eùoib_Êush_Àvñ
 {

59 
	mIPOIB_FLUSH_LIGHT
,

60 
	mIPOIB_FLUSH_NORMAL
,

61 
	mIPOIB_FLUSH_HEAVY


65 
	mIPOIB_ENCAP_LEN
 = 4,

66 
	mIPOIB_PSEUDO_LEN
 = 20,

67 
	mIPOIB_HARD_LEN
 = 
IPOIB_ENCAP_LEN
 + 
IPOIB_PSEUDO_LEN
,

69 
	mIPOIB_UD_HEAD_SIZE
 = 
IB_GRH_BYTES
 + 
IPOIB_ENCAP_LEN
,

70 
	mIPOIB_UD_RX_SG
 = 2,

72 
	mIPOIB_CM_MTU
 = 0x10000 - 0x10,

73 
	mIPOIB_CM_BUF_SIZE
 = 
IPOIB_CM_MTU
 + 
IPOIB_ENCAP_LEN
,

74 
	mIPOIB_CM_HEAD_SIZE
 = 
IPOIB_CM_BUF_SIZE
 % 
PAGE_SIZE
,

75 
	mIPOIB_CM_RX_SG
 = 
ALIGN
(
IPOIB_CM_BUF_SIZE
, 
PAGE_SIZE
Ë/ 
	mPAGE_SIZE
,

76 
	mIPOIB_RX_RING_SIZE
 = 256,

77 
	mIPOIB_TX_RING_SIZE
 = 128,

78 
	mIPOIB_MAX_QUEUE_SIZE
 = 8192,

79 
	mIPOIB_MIN_QUEUE_SIZE
 = 2,

80 
	mIPOIB_CM_MAX_CONN_QP
 = 4096,

82 
	mIPOIB_NUM_WC
 = 4,

84 
	mIPOIB_MAX_PATH_REC_QUEUE
 = 3,

85 
	mIPOIB_MAX_MCAST_QUEUE
 = 64,

87 
	mIPOIB_FLAG_OPER_UP
 = 0,

88 
	mIPOIB_FLAG_INITIALIZED
 = 1,

89 
	mIPOIB_FLAG_ADMIN_UP
 = 2,

90 
	mIPOIB_PKEY_ASSIGNED
 = 3,

91 
	mIPOIB_FLAG_SUBINTERFACE
 = 5,

92 
	mIPOIB_STOP_REAPER
 = 7,

93 
	mIPOIB_FLAG_ADMIN_CM
 = 9,

94 
	mIPOIB_FLAG_UMCAST
 = 10,

95 
	mIPOIB_NEIGH_TBL_FLUSH
 = 12,

96 
	mIPOIB_FLAG_DEV_ADDR_SET
 = 13,

97 
	mIPOIB_FLAG_DEV_ADDR_CTRL
 = 14,

99 
	mIPOIB_MAX_BACKOFF_SECONDS
 = 16,

101 
	mIPOIB_MCAST_FLAG_FOUND
 = 0,

102 
	mIPOIB_MCAST_FLAG_SENDONLY
 = 1,

110 
	mIPOIB_MCAST_FLAG_BUSY
 = 2,

111 
	mIPOIB_MCAST_FLAG_ATTACHED
 = 3,

113 
	mMAX_SEND_CQE
 = 64,

114 
	mIPOIB_CM_COPYBREAK
 = 256,

116 
	mIPOIB_NON_CHILD
 = 0,

117 
	mIPOIB_LEGACY_CHILD
 = 1,

118 
	mIPOIB_RTNL_CHILD
 = 2,

121 
	#IPOIB_OP_RECV
 (1u»<< 31)

	)

122 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


123 
	#IPOIB_OP_CM
 (1u»<< 30)

	)

125 
	#IPOIB_OP_CM
 (0)

	)

128 
	#IPOIB_QPN_MASK
 ((
__f‹˚
 
u32
Ë
	`˝u_to_be32
(0xFFFFFF))

	)

132 
	sùoib_hódî
 {

133 
__be16
 
	m¥Ÿo
;

134 
u16
 
	mª£rved
;

137 
	sùoib_p£udo_hódî
 {

138 
u8
 
	mhwaddr
[
INFINIBAND_ALEN
];

141 
ölöe
 
	$skb_add_p£udo_hdr
(
sk_buff
 *
skb
)

143 *
d©a
 = 
	`skb_push
(
skb
, 
IPOIB_PSEUDO_LEN
);

149 
	`mem£t
(
d©a
, 0, 
IPOIB_PSEUDO_LEN
);

150 
	`skb_ª£t_mac_hódî
(
skb
);

151 
	`skb_puŒ
(
skb
, 
IPOIB_HARD_LEN
);

152 
	}
}

154 
ölöe
 
ùoib_dev_¥iv
 *
	$ùoib_¥iv
(c⁄° 
√t_devi˚
 *
dev
)

156 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

158  
∫
->
˛¡_¥iv
;

159 
	}
}

162 
	sùoib_mˇ°
 {

163 
ib_ß_mcmembî_ªc
 
	mmcmembî
;

164 
ib_ß_mu…iˇ°
 *
	mmc
;

165 
ùoib_ah
 *
	mah
;

167 
rb_node
 
	mrb_node
;

168 
li°_hód
 
	mli°
;

170 
	m¸óãd
;

171 
	mbackoff
;

172 
	mdñay_u¡û
;

174 
	mÊags
;

175 
	mlogcou¡
;

177 
li°_hód
 
	m√igh_li°
;

179 
sk_buff_hód
 
	mpkt_queue
;

181 
√t_devi˚
 *
	mdev
;

182 
com∂ëi⁄
 
	md⁄e
;

185 
	sùoib_rx_buf
 {

186 
sk_buff
 *
	mskb
;

187 
u64
 
	mm≠pög
[
IPOIB_UD_RX_SG
];

190 
	sùoib_tx_buf
 {

191 
sk_buff
 *
	mskb
;

192 
u64
 
	mm≠pög
[
MAX_SKB_FRAGS
 + 1];

195 
	gib_cm_id
;

197 
	sùoib_cm_d©a
 {

198 
__be32
 
	mq≤
;

199 
__be32
 
	mmtu
;

229 
	eùoib_cm_°©e
 {

230 
	mIPOIB_CM_RX_LIVE
,

231 
	mIPOIB_CM_RX_ERROR
,

232 
	mIPOIB_CM_RX_FLUSH


235 
	sùoib_cm_rx
 {

236 
ib_cm_id
 *
	mid
;

237 
ib_qp
 *
	mqp
;

238 
ùoib_cm_rx_buf
 *
	mrx_rög
;

239 
li°_hód
 
	mli°
;

240 
√t_devi˚
 *
	mdev
;

241 
	mjiffõs
;

242 
ùoib_cm_°©e
 
	m°©e
;

243 
	mªcv_cou¡
;

246 
	sùoib_cm_tx
 {

247 
ib_cm_id
 *
	mid
;

248 
ib_qp
 *
	mqp
;

249 
li°_hód
 
	mli°
;

250 
√t_devi˚
 *
	mdev
;

251 
ùoib_√igh
 *
	m√igh
;

252 
ùoib_tx_buf
 *
	mtx_rög
;

253 
	mtx_hód
;

254 
	mtx_èû
;

255 
	mÊags
;

256 
u32
 
	mmtu
;

257 
	mmax_£nd_sge
;

260 
	sùoib_cm_rx_buf
 {

261 
sk_buff
 *
	mskb
;

262 
u64
 
	mm≠pög
[
IPOIB_CM_RX_SG
];

265 
	sùoib_cm_dev_¥iv
 {

266 
ib_§q
 *
	m§q
;

267 
ùoib_cm_rx_buf
 *
	m§q_rög
;

268 
ib_cm_id
 *
	mid
;

269 
li°_hód
 
	m∑ssive_ids
;

270 
li°_hód
 
	mrx_îr‹_li°
;

271 
li°_hód
 
	mrx_Êush_li°
;

272 
li°_hód
 
	mrx_døö_li°
;

273 
li°_hód
 
	mrx_ª≠_li°
;

274 
w‹k_°ru˘
 
	m°¨t_èsk
;

275 
w‹k_°ru˘
 
	mª≠_èsk
;

276 
w‹k_°ru˘
 
	mskb_èsk
;

277 
w‹k_°ru˘
 
	mrx_ª≠_èsk
;

278 
dñayed_w‹k
 
	m°Æe_èsk
;

279 
sk_buff_hód
 
	mskb_queue
;

280 
li°_hód
 
	m°¨t_li°
;

281 
li°_hód
 
	mª≠_li°
;

282 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

283 
ib_sge
 
	mrx_sge
[
IPOIB_CM_RX_SG
];

284 
ib_ªcv_wr
 
	mrx_wr
;

285 
	mn⁄§q_c⁄n_qp
;

286 
	mmax_cm_mtu
;

287 
	mnum_‰ags
;

290 
	sùoib_ëhtoﬁ_°
 {

291 
u16
 
	mcﬂÀs˚_u£cs
;

292 
u16
 
	mmax_cﬂÀs˚d_‰ames
;

295 
	gùoib_√igh_èbÀ
;

297 
	sùoib_√igh_hash
 {

298 
ùoib_√igh_èbÀ
 *
	m¡bl
;

299 
ùoib_√igh
 
__rcu
 **
	mbuckës
;

300 
rcu_hód
 
	mrcu
;

301 
u32
 
	mmask
;

302 
u32
 
	msize
;

305 
	sùoib_√igh_èbÀ
 {

306 
ùoib_√igh_hash
 
__rcu
 *
	mhtbl
;

307 
©omic_t
 
	míåõs
;

308 
com∂ëi⁄
 
	mÊushed
;

309 
com∂ëi⁄
 
	mdñëed
;

312 
	sùoib_qp_°©e_vÆid©e
 {

313 
w‹k_°ru˘
 
	mw‹k
;

314 
ùoib_dev_¥iv
 *
	m¥iv
;

322 
	sùoib_dev_¥iv
 {

323 
•ölock_t
 
	mlock
;

325 
√t_devi˚
 *
	mdev
;

326 (*
	m√xt_¥iv_de°ru˘‹
)(
√t_devi˚
 *
	mdev
);

328 
«pi_°ru˘
 
	m£nd_«pi
;

329 
«pi_°ru˘
 
	mªcv_«pi
;

331 
	mÊags
;

340 
rw_£m≠h‹e
 
	mvœn_rw£m
;

341 
muãx
 
	mmˇ°_muãx
;

343 
rb_roŸ
 
	m∑th_åì
;

344 
li°_hód
 
	m∑th_li°
;

346 
ùoib_√igh_èbÀ
 
	m¡bl
;

348 
ùoib_mˇ°
 *
	mbrﬂdˇ°
;

349 
li°_hód
 
	mmu…iˇ°_li°
;

350 
rb_roŸ
 
	mmu…iˇ°_åì
;

352 
w‹kqueue_°ru˘
 *
	mwq
;

353 
dñayed_w‹k
 
	mmˇ°_èsk
;

354 
w‹k_°ru˘
 
	mˇºõr_⁄_èsk
;

355 
w‹k_°ru˘
 
	mÊush_light
;

356 
w‹k_°ru˘
 
	mÊush_n‹mÆ
;

357 
w‹k_°ru˘
 
	mÊush_hóvy
;

358 
w‹k_°ru˘
 
	mª°¨t_èsk
;

359 
dñayed_w‹k
 
	mah_ª≠_èsk
;

360 
dñayed_w‹k
 
	m√igh_ª≠_èsk
;

361 
ib_devi˚
 *
	mˇ
;

362 
u8
 
	mp‹t
;

363 
u16
 
	mpkey
;

364 
u16
 
	mpkey_ödex
;

365 
ib_pd
 *
	mpd
;

366 
ib_cq
 *
	mªcv_cq
;

367 
ib_cq
 *
	m£nd_cq
;

368 
ib_qp
 *
	mqp
;

369 
u32
 
	mqkey
;

371 
ib_gid
 
	mloˇl_gid
;

372 
u32
 
	mloˇl_lid
;

374 
	madmö_mtu
;

375 
	mmˇ°_mtu
;

376 
	mmax_ib_mtu
;

378 
ùoib_rx_buf
 *
	mrx_rög
;

380 
ùoib_tx_buf
 *
	mtx_rög
;

381 
	mtx_hód
;

382 
	mtx_èû
;

383 
ib_sge
 
	mtx_sge
[
MAX_SKB_FRAGS
 + 1];

384 
ib_ud_wr
 
	mtx_wr
;

385 
ib_wc
 
	m£nd_wc
[
MAX_SEND_CQE
];

387 
ib_ªcv_wr
 
	mrx_wr
;

388 
ib_sge
 
	mrx_sge
[
IPOIB_UD_RX_SG
];

390 
ib_wc
 
	mibwc
[
IPOIB_NUM_WC
];

392 
li°_hód
 
	mdód_ahs
;

394 
ib_evít_h™dÀr
 
	mevít_h™dÀr
;

396 
√t_devi˚
 *
	m∑ª¡
;

397 
li°_hód
 
	mchûd_ötfs
;

398 
li°_hód
 
	mli°
;

399 
	mchûd_ty≥
;

401 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


402 
ùoib_cm_dev_¥iv
 
	mcm
;

405 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


406 
li°_hód
 
	mfs_li°
;

407 
díåy
 *
	mmcg_díåy
;

408 
díåy
 *
	m∑th_díåy
;

410 
u64
 
	mhˇ_ˇps
;

411 
ùoib_ëhtoﬁ_°
 
	mëhtoﬁ
;

412 
	mmax_£nd_sge
;

413 
boﬁ
 
	msm_fuŒmembî_£nd⁄ly_suµ‹t
;

414 c⁄° 
√t_devi˚_›s
 *
	m∫_›s
;

417 
	sùoib_ah
 {

418 
√t_devi˚
 *
	mdev
;

419 
ib_ah
 *
	mah
;

420 
li°_hód
 
	mli°
;

421 
kªf
 
	mªf
;

422 
	mœ°_£nd
;

423 
	mvÆid
;

426 
	sùoib_∑th
 {

427 
√t_devi˚
 *
	mdev
;

428 
ß_∑th_ªc
 
	m∑thªc
;

429 
ùoib_ah
 *
	mah
;

430 
sk_buff_hód
 
	mqueue
;

432 
li°_hód
 
	m√igh_li°
;

434 
	mquîy_id
;

435 
ib_ß_quîy
 *
	mquîy
;

436 
com∂ëi⁄
 
	md⁄e
;

438 
rb_node
 
	mrb_node
;

439 
li°_hód
 
	mli°
;

442 
	sùoib_√igh
 {

443 
ùoib_ah
 *
	mah
;

444 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


445 
ùoib_cm_tx
 *
	mcm
;

447 
u8
 
	mdaddr
[
INFINIBAND_ALEN
];

448 
sk_buff_hód
 
	mqueue
;

450 
√t_devi˚
 *
	mdev
;

452 
li°_hód
 
	mli°
;

453 
ùoib_√igh
 
__rcu
 *
	mh√xt
;

454 
rcu_hód
 
	mrcu
;

455 
©omic_t
 
	mªf˙t
;

456 
	mÆive
;

459 
	#IPOIB_UD_MTU
(
ib_mtu
Ë(ib_mtu - 
IPOIB_ENCAP_LEN
)

	)

460 
	#IPOIB_UD_BUF_SIZE
(
ib_mtu
Ë(ib_mtu + 
IB_GRH_BYTES
)

	)

462 
ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
);

463 
ölöe
 
	$ùoib_√igh_put
(
ùoib_√igh
 *
√igh
)

465 i‡(
	`©omic_dec_™d_ã°
(&
√igh
->
ªf˙t
))

466 
	`ùoib_√igh_dt‹
(
√igh
);

467 
	}
}

468 
ùoib_√igh
 *
ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
);

469 
ùoib_√igh
 *
ùoib_√igh_Æloc
(
u8
 *
daddr
,

470 
√t_devi˚
 *
dev
);

471 
ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
);

472 
ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
);

474 
w‹kqueue_°ru˘
 *
ùoib_w‹kqueue
;

478 
ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

479 
ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
);

480 
ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

481 
ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
);

483 
ùoib_ah
 *
ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

484 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
);

485 
ùoib_‰ì_ah
(
kªf
 *kref);

486 
ölöe
 
	$ùoib_put_ah
(
ùoib_ah
 *
ah
)

488 
	`kªf_put
(&
ah
->
ªf
, 
ùoib_‰ì_ah
);

489 
	}
}

490 
ùoib_›í
(
√t_devi˚
 *
dev
);

491 
ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
);

492 
ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
);

493 
ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
);

495 
ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

496 
ib_ah
 *
addªss
, 
u32
 
dq≤
);

497 
ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
);

499 
ùoib_∑th
 *
__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
);

500 
ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
);

501 
ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
);

502 
√t_devi˚
 *
ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

503 c⁄° *
f‹m©
);

504 
ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
f‹m©
,

505 
√t_devi˚
 *
dev
);

506 
ùoib_ib_tx_timî_func
(
timî_li°
 *
t
);

507 
ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
);

508 
ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
);

509 
ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
);

510 
ùoib_pkey_evít
(
w‹k_°ru˘
 *
w‹k
);

511 
ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
);

513 
ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
);

514 
ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
);

515 
ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
);

516 
ùoib_ib_dev_up
(
√t_devi˚
 *
dev
);

517 
ùoib_ib_dev_down
(
√t_devi˚
 *
dev
);

518 
ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
);

519 
ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
);

521 
ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
);

522 
ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
);

523 
ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
);

525 
ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
);

526 
ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
);

527 
ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
);

529 
ùoib_mˇ°_dev_down
(
√t_devi˚
 *
dev
);

530 
ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
);

532 
ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
);

533 
ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

534 
ùoib_tx_buf
 *
tx_ªq
);

536 
π∆_lök_›s
 *
ùoib_gë_lök_›s
();

538 
ölöe
 
	$ùoib_buûd_sge
(
ùoib_dev_¥iv
 *
¥iv
,

539 
ùoib_tx_buf
 *
tx_ªq
)

541 
i
, 
off
;

542 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

543 
skb_‰ag_t
 *
‰ags
 = 
	`skb_shöfo
(
skb
)->frags;

544 
ƒ_‰ags
 = 
	`skb_shöfo
(
skb
)->nr_frags;

545 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

547 i‡(
	`skb_hódÀn
(
skb
)) {

548 
¥iv
->
tx_sge
[0].
addr
 = 
m≠pög
[0];

549 
¥iv
->
tx_sge
[0].
Àngth
 = 
	`skb_hódÀn
(
skb
);

550 
off
 = 1;

552 
off
 = 0;

554 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

555 
¥iv
->
tx_sge
[
i
 + 
off
].
addr
 = 
m≠pög
[i + off];

556 
¥iv
->
tx_sge
[
i
 + 
off
].
Àngth
 = 
	`skb_‰ag_size
(&
‰ags
[i]);

558 
¥iv
->
tx_wr
.
wr
.
num_sge
 = 
ƒ_‰ags
 + 
off
;

559 
	}
}

561 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


562 
ùoib_mˇ°_ôî
 *
ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
);

563 
ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
);

564 
ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

565 
ib_gid
 *
gid
,

566 *
¸óãd
,

567 *
queuñí
,

568 *
com∂ëe
,

569 *
£nd_⁄ly
);

571 
ùoib_∑th_ôî
 *
ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
);

572 
ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
);

573 
ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

574 
ùoib_∑th
 *
∑th
);

577 
ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

578 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
);

579 
ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

580 
ib_gid
 *
mgid
, 
u16
 
mlid
);

581 
ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
);

582 
ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

583 
li°_hód
 *
ªmove_li°
);

585 
ùoib_öô_qp
(
√t_devi˚
 *
dev
);

586 
ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
);

587 
ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
);

589 
ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

590 
ib_evít
 *
ªc‹d
);

592 
ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
);

593 
ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
);

595 
__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

596 
u16
 
pkey
, 
chûd_ty≥
);

598 
__öô
 
ùoib_√éök_öô
();

599 
__exô
 
ùoib_√éök_föi
();

601 
ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
);

602 
ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
);

604 
ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
);

606 
ùoib_pkey_›í
(
ùoib_dev_¥iv
 *
¥iv
);

607 
ùoib_døö_cq
(
√t_devi˚
 *
dev
);

609 
ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
);

611 
	#IPOIB_FLAGS_RC
 0x80

	)

612 
	#IPOIB_FLAGS_UC
 0x40

	)

615 
	#IPOIB_CM_SUPPORTED
(
ha
Ë(ha[0] & (
IPOIB_FLAGS_RC
))

	)

617 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


619 
ùoib_max_c⁄n_qp
;

621 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

623 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

624  
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
) &&

625 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

626 
	}
}

628 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

630 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

631  
	`IPOIB_CM_SUPPORTED
(
hwaddr
) &&

632 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

633 
	}
}

635 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

638  
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
√igh
->
cm
->
Êags
);

639 
	}
}

641 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

643  
√igh
->
cm
;

644 
	}
}

646 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

648 
√igh
->
cm
 = 
tx
;

649 
	}
}

651 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

653 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

654  !!
¥iv
->
cm
.
§q
;

655 
	}
}

657 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

659 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

660  
¥iv
->
cm
.
max_cm_mtu
;

661 
	}
}

663 
ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
);

664 
ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
);

665 
ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
);

666 
ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
);

667 
ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
);

668 
ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
);

669 
ùoib_cm_tx
 *
ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

670 
ùoib_√igh
 *
√igh
);

671 
ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
);

672 
ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

673 
mtu
);

674 
ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

675 
ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
);

678 
	gùoib_cm_tx
;

680 
	#ùoib_max_c⁄n_qp
 0

	)

682 
ölöe
 
	$ùoib_cm_admö_íabÀd
(
√t_devi˚
 *
dev
)

685 
	}
}

686 
ölöe
 
	$ùoib_cm_íabÀd
(
√t_devi˚
 *
dev
, 
u8
 *
hwaddr
)

690 
	}
}

692 
ölöe
 
	$ùoib_cm_up
(
ùoib_√igh
 *
√igh
)

696 
	}
}

698 
ölöe
 
ùoib_cm_tx
 *
	$ùoib_cm_gë
(
ùoib_√igh
 *
√igh
)

700  
NULL
;

701 
	}
}

703 
ölöe
 
	$ùoib_cm_£t
(
ùoib_√igh
 *
√igh
, 
ùoib_cm_tx
 *
tx
)

705 
	}
}

707 
ölöe
 
	$ùoib_cm_has_§q
(
√t_devi˚
 *
dev
)

710 
	}
}

712 
ölöe
 
	$ùoib_cm_max_mtu
(
√t_devi˚
 *
dev
)

715 
	}
}

717 
ölöe


718 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

721 
	}
}

723 
ölöe


724 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

727 
	}
}

729 
ölöe


730 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

733 
	}
}

735 
ölöe


736 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

738  -
EOPNOTSUPP
;

739 
	}
}

741 
ölöe


742 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

745 
	}
}

747 
ölöe


748 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

749 
ùoib_√igh
 *
√igh
)

751  
NULL
;

752 
	}
}

754 
ölöe


755 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

758 
	}
}

760 
ölöe


761 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

764 
	}
}

766 
ölöe
 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

767 
mtu
)

769 
	`dev_k‰ì_skb_™y
(
skb
);

770 
	}
}

772 
ölöe
 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

774 
	}
}

776 
ölöe
 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

778 
	}
}

781 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


782 
ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
);

783 
ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
);

784 
ùoib_ªgi°î_debugfs
();

785 
ùoib_uƒegi°î_debugfs
();

787 
ölöe
 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

788 
ölöe
 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
Ë{ 
	}
}

789 
ölöe
 
	$ùoib_ªgi°î_debugfs
(Ë{ 
	}
}

790 
ölöe
 
	$ùoib_uƒegi°î_debugfs
(Ë{ 
	}
}

793 
	#ùoib_¥ötk
(
Àvñ
, 
¥iv
, 
f‹m©
, 
¨g
...) \

794 
	`¥ötk
(
Àvñ
 "%s: " 
f‹m©
, ((
ùoib_dev_¥iv
 *Ë
¥iv
)->
dev
->
«me
 , ## 
¨g
)

	)

795 
	#ùoib_w¨n
(
¥iv
, 
f‹m©
, 
¨g
...) \

797 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

798 10 * 
HZ
 , \

800 i‡(
	`__øãlimô
(&
_rs
)) \

801 
	`ùoib_¥ötk
(
KERN_WARNING
, 
¥iv
, 
f‹m©
 , ## 
¨g
);\

802 } 0)

	)

804 
ùoib_£ndq_size
;

805 
ùoib_ªcvq_size
;

807 
ib_ß_˛õ¡
 
ùoib_ß_˛õ¡
;

809 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


810 
ùoib_debug_Àvñ
;

812 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

814 i‡(
ùoib_debug_Àvñ
 > 0) \

815 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

816 } 0)

	)

817 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

819 i‡(
mˇ°_debug_Àvñ
 > 0) \

820 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

821 } 0)

	)

823 
	#ùoib_dbg
(
¥iv
, 
f‹m©
, 
¨g
...) \

824 dÿ{ (Ë(
¥iv
); } 0)

	)

825 
	#ùoib_dbg_mˇ°
(
¥iv
, 
f‹m©
, 
¨g
...) \

826 dÿ{ (Ë(
¥iv
); } 0)

	)

829 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


830 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

832 i‡(
d©a_debug_Àvñ
 > 0) \

833 
	`ùoib_¥ötk
(
KERN_DEBUG
, 
¥iv
, 
f‹m©
 , ## 
¨g
); \

834 } 0)

	)

836 
	#ùoib_dbg_d©a
(
¥iv
, 
f‹m©
, 
¨g
...) \

837 dÿ{ (Ë(
¥iv
); } 0)

	)

840 
	#IPOIB_QPN
(
ha
Ë(
	`be32_to_˝up
((
__be32
 *ËhaË& 0xffffff)

	)

842 c⁄° 
ùoib_drivî_vîsi⁄
[];

844 
hfi1_max_mtu
;

845 
uöt
 
ùoib_ac˚l
;

	@SLES15SP2/ipoib/ipoib_cm.c

33 
	~<rdma/ib_cm.h
>

34 
	~<√t/d°.h
>

35 
	~<√t/icmp.h
>

36 
	~<löux/icmpv6.h
>

37 
	~<löux/dñay.h
>

38 
	~<löux/¶ab.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/moduÀ∑øm.h
>

41 
	~<löux/sched/sig«l.h
>

42 
	~<löux/sched/mm.h
>

44 
	~"ùoib.h
"

46 
	gùoib_max_c⁄n_qp
 = 128;

48 
moduÀ_∑øm_«med
(
max_n⁄§q_c⁄n_qp
, 
ùoib_max_c⁄n_qp
, , 0444);

49 
MODULE_PARM_DESC
(
max_n⁄§q_c⁄n_qp
,

53 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


54 
	gd©a_debug_Àvñ
;

56 
moduÀ_∑øm_«med
(
cm_d©a_debug_Àvñ
, 
d©a_debug_Àvñ
, , 0644);

57 
MODULE_PARM_DESC
(
cm_d©a_debug_Àvñ
,

61 
	#IPOIB_CM_IETF_ID
 0x1000000000000000ULL

	)

63 
	#IPOIB_CM_RX_UPDATE_TIME
 (256 * 
HZ
)

	)

64 
	#IPOIB_CM_RX_TIMEOUT
 (2 * 256 * 
HZ
)

	)

65 
	#IPOIB_CM_RX_DELAY
 (3 * 256 * 
HZ
)

	)

66 
	#IPOIB_CM_RX_UPDATE_MASK
 (0x3)

	)

68 
	#IPOIB_CM_RX_RESERVE
 (
	`ALIGN
(
IPOIB_HARD_LEN
, 16Ë- 
IPOIB_ENCAP_LEN
)

	)

70 
ib_qp_©å
 
	gùoib_cm_îr_©å
 = {

71 .
qp_°©e
 = 
IB_QPS_ERR


74 
	#IPOIB_CM_RX_DRAIN_WRID
 0xffffffff

	)

76 
ib_£nd_wr
 
	gùoib_cm_rx_døö_wr
 = {

77 .
›code
 = 
IB_WR_SEND
,

80 
ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

81 c⁄° 
ib_cm_evít
 *
evít
);

83 
	$ùoib_cm_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
, 
‰ags
,

84 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
])

86 
i
;

88 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

90 
i
 = 0; i < 
‰ags
; ++i)

91 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

92 
	}
}

94 
	$ùoib_cm_po°_ª˚ive_§q
(
√t_devi˚
 *
dev
, 
id
)

96 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

97 
i
, 
ªt
;

99 
¥iv
->
cm
.
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

101 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

102 
¥iv
->
cm
.
rx_sge
[
i
].
addr
 =Öriv->cm.
§q_rög
[
id
].
m≠pög
[i];

104 
ªt
 = 
	`ib_po°_§q_ªcv
(
¥iv
->
cm
.
§q
, &¥iv->cm.
rx_wr
, 
NULL
);

105 i‡(
	`u∆ikñy
(
ªt
)) {

106 
	`ùoib_w¨n
(
¥iv
, "po° srq faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

107 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
,Öriv->
cm
.
num_‰ags
 - 1,

108 
¥iv
->
cm
.
§q_rög
[
id
].
m≠pög
);

109 
	`dev_k‰ì_skb_™y
(
¥iv
->
cm
.
§q_rög
[
id
].
skb
);

110 
¥iv
->
cm
.
§q_rög
[
id
].
skb
 = 
NULL
;

113  
ªt
;

114 
	}
}

116 
	$ùoib_cm_po°_ª˚ive_n⁄§q
(
√t_devi˚
 *
dev
,

117 
ùoib_cm_rx
 *
rx
,

118 
ib_ªcv_wr
 *
wr
,

119 
ib_sge
 *
sge
, 
id
)

121 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

122 
i
, 
ªt
;

124 
wr
->
wr_id
 = 
id
 | 
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
;

126 
i
 = 0; i < 
IPOIB_CM_RX_SG
; ++i)

127 
sge
[
i
].
addr
 = 
rx
->
rx_rög
[
id
].
m≠pög
[i];

129 
ªt
 = 
	`ib_po°_ªcv
(
rx
->
qp
, 
wr
, 
NULL
);

130 i‡(
	`u∆ikñy
(
ªt
)) {

131 
	`ùoib_w¨n
(
¥iv
, "po°Ñecv faûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

132 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

133 
rx
->
rx_rög
[
id
].
m≠pög
);

134 
	`dev_k‰ì_skb_™y
(
rx
->
rx_rög
[
id
].
skb
);

135 
rx
->
rx_rög
[
id
].
skb
 = 
NULL
;

138  
ªt
;

139 
	}
}

141 
sk_buff
 *
	$ùoib_cm_Æloc_rx_skb
(
√t_devi˚
 *
dev
,

142 
ùoib_cm_rx_buf
 *
rx_rög
,

143 
id
, 
‰ags
,

144 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
],

145 
gÂ_t
 
gÂ
)

147 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

148 
sk_buff
 *
skb
;

149 
i
;

151 
skb
 = 
	`dev_Æloc_skb
(
	`ALIGN
(
IPOIB_CM_HEAD_SIZE
 + 
IPOIB_PSEUDO_LEN
, 16));

152 i‡(
	`u∆ikñy
(!
skb
))

153  
NULL
;

159 
	`skb_ª£rve
(
skb
, 
IPOIB_CM_RX_RESERVE
);

161 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
IPOIB_CM_HEAD_SIZE
,

162 
DMA_FROM_DEVICE
);

163 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0]))) {

164 
	`dev_k‰ì_skb_™y
(
skb
);

165  
NULL
;

168 
i
 = 0; i < 
‰ags
; i++) {

169 
∑ge
 *∑gê
	`Æloc_∑ge
(
gÂ
);

171 i‡(!
∑ge
)

172 
∑πül_îr‹
;

173 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 
PAGE_SIZE
);

175 
m≠pög
[
i
 + 1] = 
	`ib_dma_m≠_∑ge
(
¥iv
->
ˇ
, 
∑ge
,

176 0, 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

177 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 1])))

178 
∑πül_îr‹
;

181 
rx_rög
[
id
].
skb
 = skb;

182  
skb
;

184 
∑πül_îr‹
:

186 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
IPOIB_CM_HEAD_SIZE
, 
DMA_FROM_DEVICE
);

188 ; 
i
 > 0; --i)

189 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
], 
PAGE_SIZE
, 
DMA_FROM_DEVICE
);

191 
	`dev_k‰ì_skb_™y
(
skb
);

192  
NULL
;

193 
	}
}

195 
	$ùoib_cm_‰ì_rx_rög
(
√t_devi˚
 *
dev
,

196 
ùoib_cm_rx_buf
 *
rx_rög
)

198 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

199 
i
;

201 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

202 i‡(
rx_rög
[
i
].
skb
) {

203 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
IPOIB_CM_RX_SG
 - 1,

204 
rx_rög
[
i
].
m≠pög
);

205 
	`dev_k‰ì_skb_™y
(
rx_rög
[
i
].
skb
);

208 
	`v‰ì
(
rx_rög
);

209 
	}
}

211 
	$ùoib_cm_°¨t_rx_døö
(
ùoib_dev_¥iv
 *
¥iv
)

213 
ùoib_cm_rx
 *
p
;

217 i‡(
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

218 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
))

225 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
rx_Êush_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

226 
ùoib_cm_rx_døö_wr
.
wr_id
 = 
IPOIB_CM_RX_DRAIN_WRID
;

227 i‡(
	`ib_po°_£nd
(
p
->
qp
, &
ùoib_cm_rx_døö_wr
, 
NULL
))

228 
	`ùoib_w¨n
(
¥iv
, "failedÅoÖost drain wr\n");

230 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
, &¥iv->cm.
rx_døö_li°
);

231 
	}
}

233 
	$ùoib_cm_rx_evít_h™dÀr
(
ib_evít
 *
evít
, *
˘x
)

235 
ùoib_cm_rx
 *
p
 = 
˘x
;

236 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

237 
Êags
;

239 i‡(
evít
->evíà!
IB_EVENT_QP_LAST_WQE_REACHED
)

242 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

243 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_Êush_li°
);

244 
p
->
°©e
 = 
IPOIB_CM_RX_FLUSH
;

245 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

246 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

247 
	}
}

249 
ib_qp
 *
	$ùoib_cm_¸óã_rx_qp
(
√t_devi˚
 *
dev
,

250 
ùoib_cm_rx
 *
p
)

252 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

253 
ib_qp_öô_©å
 
©å
 = {

254 .
evít_h™dÀr
 = 
ùoib_cm_rx_evít_h™dÀr
,

255 .
£nd_cq
 = 
¥iv
->
ªcv_cq
,

256 .
ªcv_cq
 = 
¥iv
->recv_cq,

257 .
§q
 = 
¥iv
->
cm
.srq,

258 .
ˇp
.
max_£nd_wr
 = 1,

259 .
ˇp
.
max_£nd_sge
 = 1,

260 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

261 .
qp_ty≥
 = 
IB_QPT_RC
,

262 .
qp_c⁄ãxt
 = 
p
,

265 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

266 
©å
.
ˇp
.
max_ªcv_wr
 = 
ùoib_ªcvq_size
;

267 
©å
.
ˇp
.
max_ªcv_sge
 = 
IPOIB_CM_RX_SG
;

270  
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

271 
	}
}

273 
	$ùoib_cm_modify_rx_qp
(
√t_devi˚
 *
dev
,

274 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
,

275 
p¢
)

277 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

278 
ib_qp_©å
 
qp_©å
;

279 
qp_©å_mask
, 
ªt
;

281 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

282 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

283 i‡(
ªt
) {

284 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ INIT: %d\n", 
ªt
);

285  
ªt
;

287 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

288 i‡(
ªt
) {

289 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿINIT: %d\n", 
ªt
);

290  
ªt
;

292 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

293 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

294 i‡(
ªt
) {

295 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

296  
ªt
;

298 
qp_©å
.
rq_p¢
 = 
p¢
;

299 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

300 i‡(
ªt
) {

301 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

302  
ªt
;

313 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

314 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

315 i‡(
ªt
) {

316 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

319 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

320 i‡(
ªt
) {

321 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

326 
	}
}

328 
	$ùoib_cm_öô_rx_wr
(
√t_devi˚
 *
dev
,

329 
ib_ªcv_wr
 *
wr
,

330 
ib_sge
 *
sge
)

332 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

333 
i
;

335 
i
 = 0; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

336 
sge
[
i
].
lkey
 = 
¥iv
->
pd
->
loˇl_dma_lkey
;

338 
sge
[0].
Àngth
 = 
IPOIB_CM_HEAD_SIZE
;

339 
i
 = 1; i < 
¥iv
->
cm
.
num_‰ags
; ++i)

340 
sge
[
i
].
Àngth
 = 
PAGE_SIZE
;

342 
wr
->
√xt
 = 
NULL
;

343 
wr
->
sg_li°
 = 
sge
;

344 
wr
->
num_sge
 = 
¥iv
->
cm
.
num_‰ags
;

345 
	}
}

347 
	$ùoib_cm_n⁄§q_öô_rx
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

348 
ùoib_cm_rx
 *
rx
)

350 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

352 
ib_ªcv_wr
 
wr
;

353 
ib_sge
 
sge
[
IPOIB_CM_RX_SG
];

354 } *
t
;

355 
ªt
;

356 
i
;

358 
rx
->
rx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

359 (*
rx
->
rx_rög
)));

360 i‡(!
rx
->
rx_rög
)

361  -
ENOMEM
;

363 
t
 = 
	`kmÆloc
((*t), 
GFP_KERNEL
);

364 i‡(!
t
) {

365 
ªt
 = -
ENOMEM
;

366 
îr_‰ì_1
;

369 
	`ùoib_cm_öô_rx_wr
(
dev
, &
t
->
wr
,Å->
sge
);

371 
	`•ö_lock_úq
(&
¥iv
->
lock
);

373 i‡(
¥iv
->
cm
.
n⁄§q_c⁄n_qp
 >
ùoib_max_c⁄n_qp
) {

374 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

375 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_NO_QP
, 
NULL
, 0, NULL, 0);

376 
ªt
 = -
EINVAL
;

377 
îr_‰ì
;

379 ++
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

381 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

383 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

384 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx
->
rx_rög
, 
i
, 
IPOIB_CM_RX_SG
 - 1,

385 
rx
->
rx_rög
[
i
].
m≠pög
,

386 
GFP_KERNEL
)) {

387 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

388 
ªt
 = -
ENOMEM
;

389 
îr_cou¡
;

391 
ªt
 = 
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
rx
, &
t
->
wr
,Å->
sge
, 
i
);

392 i‡(
ªt
) {

393 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq "

394 "Áûed f‹ bu‡%d\n", 
i
);

395 
ªt
 = -
EIO
;

396 
îr_cou¡
;

400 
rx
->
ªcv_cou¡
 = 
ùoib_ªcvq_size
;

402 
	`k‰ì
(
t
);

406 
îr_cou¡
:

407 
	`•ö_lock_úq
(&
¥iv
->
lock
);

408 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

409 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

411 
îr_‰ì
:

412 
	`k‰ì
(
t
);

414 
îr_‰ì_1
:

415 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
rx
->
rx_rög
);

417  
ªt
;

418 
	}
}

420 
	$ùoib_cm_£nd_ªp
(
√t_devi˚
 *
dev
, 
ib_cm_id
 *
cm_id
,

421 
ib_qp
 *
qp
,

422 c⁄° 
ib_cm_ªq_evít_∑øm
 *
ªq
,

423 
p¢
)

425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

426 
ùoib_cm_d©a
 
d©a
 = {};

427 
ib_cm_ªp_∑øm
 
ªp
 = {};

429 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

430 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

432 
ªp
.
¥iv©e_d©a
 = &
d©a
;

433 
ªp
.
¥iv©e_d©a_Àn
 = (
d©a
);

434 
ªp
.
Êow_c⁄åﬁ
 = 0;

435 
ªp
.
∫r_ªåy_cou¡
 = 
ªq
->rnr_retry_count;

436 
ªp
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

437 
ªp
.
qp_num
 = 
qp
->qp_num;

438 
ªp
.
°¨tög_p¢
 = 
p¢
;

439  
	`ib_£nd_cm_ªp
(
cm_id
, &
ªp
);

440 
	}
}

442 
	$ùoib_cm_ªq_h™dÀr
(
ib_cm_id
 *
cm_id
,

443 c⁄° 
ib_cm_evít
 *
evít
)

445 
√t_devi˚
 *
dev
 = 
cm_id
->
c⁄ãxt
;

446 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

447 
ùoib_cm_rx
 *
p
;

448 
p¢
;

449 
ªt
;

451 
	`ùoib_dbg
(
¥iv
, "REQárrived\n");

452 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

453 i‡(!
p
)

454  -
ENOMEM
;

455 
p
->
dev
 = dev;

456 
p
->
id
 = 
cm_id
;

457 
cm_id
->
c⁄ãxt
 = 
p
;

458 
p
->
°©e
 = 
IPOIB_CM_RX_LIVE
;

459 
p
->
jiffõs
 = jiffies;

460 
	`INIT_LIST_HEAD
(&
p
->
li°
);

462 
p
->
qp
 = 
	`ùoib_cm_¸óã_rx_qp
(
dev
,Ö);

463 i‡(
	`IS_ERR
(
p
->
qp
)) {

464 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

465 
îr_qp
;

468 
p¢
 = 
	`¥™dom_u32
() & 0xffffff;

469 
ªt
 = 
	`ùoib_cm_modify_rx_qp
(
dev
, 
cm_id
, 
p
->
qp
, 
p¢
);

470 i‡(
ªt
)

471 
îr_modify
;

473 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

474 
ªt
 = 
	`ùoib_cm_n⁄§q_öô_rx
(
dev
, 
cm_id
, 
p
);

475 i‡(
ªt
)

476 
îr_modify
;

479 
	`•ö_lock_úq
(&
¥iv
->
lock
);

480 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

481 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

484 
p
->
jiffõs
 = jiffies;

485 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

486 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

487 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

489 
ªt
 = 
	`ùoib_cm_£nd_ªp
(
dev
, 
cm_id
, 
p
->
qp
, &
evít
->
∑øm
.
ªq_rcvd
, 
p¢
);

490 i‡(
ªt
) {

491 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd REP: %d\n", 
ªt
);

492 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

493 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

497 
îr_modify
:

498 
	`ib_de°roy_qp
(
p
->
qp
);

499 
îr_qp
:

500 
	`k‰ì
(
p
);

501  
ªt
;

502 
	}
}

504 
	$ùoib_cm_rx_h™dÀr
(
ib_cm_id
 *
cm_id
,

505 c⁄° 
ib_cm_evít
 *
evít
)

507 
ùoib_cm_rx
 *
p
;

508 
ùoib_dev_¥iv
 *
¥iv
;

510 
evít
->event) {

511 
IB_CM_REQ_RECEIVED
:

512  
	`ùoib_cm_ªq_h™dÀr
(
cm_id
, 
evít
);

513 
IB_CM_DREQ_RECEIVED
:

514 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

516 
IB_CM_REJ_RECEIVED
:

517 
p
 = 
cm_id
->
c⁄ãxt
;

518 
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

519 i‡(
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
))

520 
	`ùoib_w¨n
(
¥iv
, "unableÅo move qpÅoÉrror state\n");

525 
	}
}

527 
	$skb_put_‰ags
(
sk_buff
 *
skb
, 
hdr_•a˚
,

528 
Àngth
, 
sk_buff
 *
toskb
)

530 
i
, 
num_‰ags
;

531 
size
;

534 
size
 = 
	`mö
(
Àngth
, 
hdr_•a˚
);

535 
skb
->
èû
 +
size
;

536 
skb
->
Àn
 +
size
;

537 
Àngth
 -
size
;

539 
num_‰ags
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

540 
i
 = 0; i < 
num_‰ags
; i++) {

541 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

543 i‡(
Àngth
 == 0) {

545 
	`skb_fûl_∑ge_desc
(
toskb
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

546 0, 
PAGE_SIZE
);

547 --
	`skb_shöfo
(
skb
)->
ƒ_‰ags
;

549 
size
 = 
	`mö_t
(, 
Àngth
, 
PAGE_SIZE
);

551 
	`skb_‰ag_size_£t
(
‰ag
, 
size
);

552 
skb
->
d©a_Àn
 +
size
;

553 
skb
->
åuesize
 +
size
;

554 
skb
->
Àn
 +
size
;

555 
Àngth
 -
size
;

558 
	}
}

560 
	$ùoib_cm_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

562 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

563 
ùoib_cm_rx_buf
 *
rx_rög
;

564 
wr_id
 = 
wc
->wr_id & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
);

565 
sk_buff
 *
skb
, *
√wskb
;

566 
ùoib_cm_rx
 *
p
;

567 
Êags
;

568 
u64
 
m≠pög
[
IPOIB_CM_RX_SG
];

569 
‰ags
;

570 
has_§q
;

571 
sk_buff
 *
smÆl_skb
;

573 
	`ùoib_dbg_d©a
(
¥iv
, "cmÑecv completion: id %d, status: %d\n",

574 
wr_id
, 
wc
->
°©us
);

576 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

577 i‡(
wr_id
 =(
IPOIB_CM_RX_DRAIN_WRID
 & ~(
IPOIB_OP_CM
 | 
IPOIB_OP_RECV
))) {

578 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

579 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
, &¥iv->cm.
rx_ª≠_li°
);

580 
	`ùoib_cm_°¨t_rx_døö
(
¥iv
);

581 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

582 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

584 
	`ùoib_w¨n
(
¥iv
, "cmÑecv completionÉvent with wrid %d (> %d)\n",

585 
wr_id
, 
ùoib_ªcvq_size
);

589 
p
 = 
wc
->
qp
->
qp_c⁄ãxt
;

591 
has_§q
 = 
	`ùoib_cm_has_§q
(
dev
);

592 
rx_rög
 = 
has_§q
 ? 
¥iv
->
cm
.
§q_rög
 : 
p
->rx_ring;

594 
skb
 = 
rx_rög
[
wr_id
].skb;

596 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

597 
	`ùoib_dbg
(
¥iv
,

599 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

600 ++
dev
->
°©s
.
rx_dr›≥d
;

601 i‡(
has_§q
)

602 
ªpo°
;

604 i‡(!--
p
->
ªcv_cou¡
) {

605 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

606 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_ª≠_li°
);

607 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

608 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
rx_ª≠_èsk
);

614 i‡(
	`u∆ikñy
(!(
wr_id
 & 
IPOIB_CM_RX_UPDATE_MASK
))) {

615 i‡(
p
 && 
	`time_a·î_eq
(
jiffõs
,Ö->jiffõ†+ 
IPOIB_CM_RX_UPDATE_TIME
)) {

616 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

617 
p
->
jiffõs
 = jiffies;

620 i‡(
p
->
°©e
 =
IPOIB_CM_RX_LIVE
)

621 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
∑ssive_ids
);

622 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

626 i‡(
wc
->
byã_Àn
 < 
IPOIB_CM_COPYBREAK
) {

627 
dÀn
 = 
wc
->
byã_Àn
;

629 
smÆl_skb
 = 
	`dev_Æloc_skb
(
dÀn
 + 
IPOIB_CM_RX_RESERVE
);

630 i‡(
smÆl_skb
) {

631 
	`skb_ª£rve
(
smÆl_skb
, 
IPOIB_CM_RX_RESERVE
);

632 
	`ib_dma_sync_sögÀ_f‹_˝u
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

633 
dÀn
, 
DMA_FROM_DEVICE
);

634 
	`skb_c›y_‰om_löór_d©a
(
skb
, 
smÆl_skb
->
d©a
, 
dÀn
);

635 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
¥iv
->
ˇ
, 
rx_rög
[
wr_id
].
m≠pög
[0],

636 
dÀn
, 
DMA_FROM_DEVICE
);

637 
	`skb_put
(
smÆl_skb
, 
dÀn
);

638 
skb
 = 
smÆl_skb
;

639 
c›õd
;

643 
‰ags
 = 
	`PAGE_ALIGN
(
wc
->
byã_Àn
 -

644 
	`mö_t
(
u32
, 
wc
->
byã_Àn
, 
IPOIB_CM_HEAD_SIZE
)) /

645 
PAGE_SIZE
;

647 
√wskb
 = 
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
rx_rög
, 
wr_id
, 
‰ags
,

648 
m≠pög
, 
GFP_ATOMIC
);

649 i‡(
	`u∆ikñy
(!
√wskb
)) {

654 
	`ùoib_dbg
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
wr_id
);

655 ++
dev
->
°©s
.
rx_dr›≥d
;

656 
ªpo°
;

659 
	`ùoib_cm_dma_unm≠_rx
(
¥iv
, 
‰ags
, 
rx_rög
[
wr_id
].
m≠pög
);

660 
	`mem˝y
(
rx_rög
[
wr_id
].
m≠pög
, m≠pög, (
‰ags
 + 1) * (*mapping));

662 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

663 
wc
->
byã_Àn
, wc->
¶id
);

665 
	`skb_put_‰ags
(
skb
, 
IPOIB_CM_HEAD_SIZE
, 
wc
->
byã_Àn
, 
√wskb
);

667 
c›õd
:

668 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

669 
	`skb_add_p£udo_hdr
(
skb
);

671 ++
dev
->
°©s
.
rx_∑ckës
;

672 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

674 
skb
->
dev
 = dev;

676 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

677 
	`√tif_ª˚ive_skb
(
skb
);

679 
ªpo°
:

680 i‡(
has_§q
) {

681 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
wr_id
)))

682 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq failed "

683 "f‹ bu‡%d\n", 
wr_id
);

685 i‡(
	`u∆ikñy
(
	`ùoib_cm_po°_ª˚ive_n⁄§q
(
dev
, 
p
,

686 &
¥iv
->
cm
.
rx_wr
,

687 
¥iv
->
cm
.
rx_sge
,

688 
wr_id
))) {

689 --
p
->
ªcv_cou¡
;

690 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_nonsrq failed "

691 "f‹ bu‡%d\n", 
wr_id
);

694 
	}
}

696 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

697 
ùoib_cm_tx
 *
tx
,

698 
wr_id
,

699 
ùoib_tx_buf
 *
tx_ªq
)

701 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

703 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id | 
IPOIB_OP_CM
;

705  
	`ib_po°_£nd
(
tx
->
qp
, &
¥iv
->
tx_wr
.
wr
, 
NULL
);

706 
	}
}

708 
	$ùoib_cm_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
, 
ùoib_cm_tx
 *
tx
)

710 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

711 
ùoib_tx_buf
 *
tx_ªq
;

712 
rc
;

713 
ußbÀ_sge
 = 
tx
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

715 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
tx
->
mtu
)) {

716 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

717 
skb
->
Àn
, 
tx
->
mtu
);

718 ++
dev
->
°©s
.
tx_dr›≥d
;

719 ++
dev
->
°©s
.
tx_îr‹s
;

720 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
tx
->
mtu
 - 
IPOIB_ENCAP_LEN
);

723 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

724 i‡(
	`skb_löórize
(
skb
) < 0) {

725 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

726 ++
dev
->
°©s
.
tx_dr›≥d
;

727 ++
dev
->
°©s
.
tx_îr‹s
;

728 
	`dev_k‰ì_skb_™y
(
skb
);

732 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

733 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

734 ++
dev
->
°©s
.
tx_dr›≥d
;

735 ++
dev
->
°©s
.
tx_îr‹s
;

736 
	`dev_k‰ì_skb_™y
(
skb
);

740 
	`ùoib_dbg_d©a
(
¥iv
, "sendingÖacket: head 0x%xÜength %d connection 0x%x\n",

741 
tx
->
tx_hód
, 
skb
->
Àn
,Åx->
qp
->
qp_num
);

750 
tx_ªq
 = &
tx
->
tx_rög
[tx->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

751 
tx_ªq
->
skb
 = skb;

753 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

754 ++
dev
->
°©s
.
tx_îr‹s
;

755 
	`dev_k‰ì_skb_™y
(
skb
);

759 i‡((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë=
ùoib_£ndq_size
 - 1) {

760 
	`ùoib_dbg
(
¥iv
, "TXÑing 0x%x full, stopping kernelÇet queue\n",

761 
tx
->
qp
->
qp_num
);

762 
	`√tif_°›_queue
(
dev
);

765 
	`skb_‹ph™
(
skb
);

766 
	`skb_d°_dr›
(
skb
);

768 i‡(
	`√tif_queue_°›≥d
(
dev
)) {

769 
rc
 = 
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

770 
IB_CQ_REPORT_MISSED_EVENTS
);

771 i‡(
	`u∆ikñy
(
rc
 < 0))

772 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:requestÇotify on send CQ failed\n");

773 i‡(
rc
)

774 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

777 
rc
 = 
	`po°_£nd
(
¥iv
, 
tx
,Åx->
tx_hód
 & (
ùoib_£ndq_size
 - 1), 
tx_ªq
);

778 i‡(
	`u∆ikñy
(
rc
)) {

779 
	`ùoib_w¨n
(
¥iv
, "IPoIB/CM:po°_£nd faûed,Éº‹ %d\n", 
rc
);

780 ++
dev
->
°©s
.
tx_îr‹s
;

781 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

782 
	`dev_k‰ì_skb_™y
(
skb
);

784 i‡(
	`√tif_queue_°›≥d
(
dev
))

785 
	`√tif_wake_queue
(
dev
);

787 
	`√tif_å™s_upd©e
(
dev
);

788 ++
tx
->
tx_hód
;

789 ++
¥iv
->
tx_hód
;

791 
	}
}

793 
	$ùoib_cm_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

795 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

796 
ùoib_cm_tx
 *
tx
 = 
wc
->
qp
->
qp_c⁄ãxt
;

797 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_CM
;

798 
ùoib_tx_buf
 *
tx_ªq
;

799 
Êags
;

801 
	`ùoib_dbg_d©a
(
¥iv
, "cm send completion: id %d, status: %d\n",

802 
wr_id
, 
wc
->
°©us
);

804 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

805 
	`ùoib_w¨n
(
¥iv
, "cm send completionÉvent with wrid %d (> %d)\n",

806 
wr_id
, 
ùoib_£ndq_size
);

810 
tx_ªq
 = &
tx
->
tx_rög
[
wr_id
];

812 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

815 ++
dev
->
°©s
.
tx_∑ckës
;

816 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

818 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

820 
	`√tif_tx_lock
(
dev
);

822 ++
tx
->
tx_èû
;

823 ++
¥iv
->
tx_èû
;

825 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

826 (
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1 &&

827 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

828 
	`√tif_wake_queue
(
dev
);

830 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

831 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

832 
ùoib_√igh
 *
√igh
;

837 i‡(
wc
->
°©us
 =
IB_WC_RNR_RETRY_EXC_ERR
 ||

838 
wc
->
°©us
 =
IB_WC_RETRY_EXC_ERR
)

839 
	`ùoib_dbg
(
¥iv
,

841 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

843 
	`ùoib_w¨n
(
¥iv
,

845 
__func__
, 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

847 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

848 
√igh
 = 
tx
->neigh;

850 i‡(
√igh
) {

851 
√igh
->
cm
 = 
NULL
;

852 
	`ùoib_√igh_‰ì
(
√igh
);

854 
tx
->
√igh
 = 
NULL
;

857 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

858 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

859 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

862 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
tx
->
Êags
);

864 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

867 
	`√tif_tx_u∆ock
(
dev
);

868 
	}
}

870 
	$ùoib_cm_dev_›í
(
√t_devi˚
 *
dev
)

872 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

873 
ªt
;

875 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
))

878 
¥iv
->
cm
.
id
 = 
	`ib_¸óã_cm_id
’riv->
ˇ
, 
ùoib_cm_rx_h™dÀr
, 
dev
);

879 i‡(
	`IS_ERR
(
¥iv
->
cm
.
id
)) {

880 
	`¥_w¨n
("%s: faûedÅÿ¸óã CM ID\n", 
¥iv
->
ˇ
->
«me
);

881 
ªt
 = 
	`PTR_ERR
(
¥iv
->
cm
.
id
);

882 
îr_cm
;

885 
ªt
 = 
	`ib_cm_li°í
(
¥iv
->
cm
.
id
, 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 |Öriv->
qp
->
qp_num
),

887 i‡(
ªt
) {

888 
	`¥_w¨n
("%s: faûedÅÿli°í o¿ID 0x%Œx\n", 
¥iv
->
ˇ
->
«me
,

889 
IPOIB_CM_IETF_ID
 | 
¥iv
->
qp
->
qp_num
);

890 
îr_li°í
;

895 
îr_li°í
:

896 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

897 
îr_cm
:

898 
¥iv
->
cm
.
id
 = 
NULL
;

899  
ªt
;

900 
	}
}

902 
	$ùoib_cm_‰ì_rx_ª≠_li°
(
√t_devi˚
 *
dev
)

904 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

905 
ùoib_cm_rx
 *
rx
, *
n
;

906 
	`LIST_HEAD
(
li°
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

909 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_ª≠_li°
, &
li°
);

910 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

912 
	`li°_f‹_óch_íåy_ß„
(
rx
, 
n
, &
li°
,Üist) {

913 
	`ib_de°roy_cm_id
(
rx
->
id
);

914 
	`ib_de°roy_qp
(
rx
->
qp
);

915 i‡(!
	`ùoib_cm_has_§q
(
dev
)) {

916 
	`ùoib_cm_‰ì_rx_rög
(
¥iv
->
dev
, 
rx
->
rx_rög
);

917 
	`•ö_lock_úq
(&
¥iv
->
lock
);

918 --
¥iv
->
cm
.
n⁄§q_c⁄n_qp
;

919 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

921 
	`k‰ì
(
rx
);

923 
	}
}

925 
	$ùoib_cm_dev_°›
(
√t_devi˚
 *
dev
)

927 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

928 
ùoib_cm_rx
 *
p
;

929 
begö
;

930 
ªt
;

932 i‡(!
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë|| !
¥iv
->
cm
.
id
)

935 
	`ib_de°roy_cm_id
(
¥iv
->
cm
.
id
);

936 
¥iv
->
cm
.
id
 = 
NULL
;

938 
	`•ö_lock_úq
(&
¥iv
->
lock
);

939 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

940 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
√xt
, 
	`ty≥of
(*p), 
li°
);

941 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

942 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

943 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

944 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

945 i‡(
ªt
)

946 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

947 
	`•ö_lock_úq
(&
¥iv
->
lock
);

951 
begö
 = 
jiffõs
;

953 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_îr‹_li°
) ||

954 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_Êush_li°
) ||

955 !
	`li°_em±y
(&
¥iv
->
cm
.
rx_døö_li°
)) {

956 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

957 
	`ùoib_w¨n
(
¥iv
, "RX drainÅiming out\n");

962 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_Êush_li°
,

963 &
¥iv
->
cm
.
rx_ª≠_li°
);

964 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_îr‹_li°
,

965 &
¥iv
->
cm
.
rx_ª≠_li°
);

966 
	`li°_•li˚_öô
(&
¥iv
->
cm
.
rx_døö_li°
,

967 &
¥iv
->
cm
.
rx_ª≠_li°
);

970 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

971 
	`u¶ìp_ønge
(1000, 2000);

972 
	`ùoib_døö_cq
(
dev
);

973 
	`•ö_lock_úq
(&
¥iv
->
lock
);

976 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

978 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
dev
);

980 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
cm
.
°Æe_èsk
);

981 
	}
}

983 
	$ùoib_cm_ªp_h™dÀr
(
ib_cm_id
 *
cm_id
,

984 c⁄° 
ib_cm_evít
 *
evít
)

986 
ùoib_cm_tx
 *
p
 = 
cm_id
->
c⁄ãxt
;

987 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

988 
ùoib_cm_d©a
 *
d©a
 = 
evít
->
¥iv©e_d©a
;

989 
sk_buff_hód
 
skqueue
;

990 
ib_qp_©å
 
qp_©å
;

991 
qp_©å_mask
, 
ªt
;

992 
sk_buff
 *
skb
;

994 
p
->
mtu
 = 
	`be32_to_˝u
(
d©a
->mtu);

996 i‡(
p
->
mtu
 <
IPOIB_ENCAP_LEN
) {

997 
	`ùoib_w¨n
(
¥iv
, "Rejecting connection: mtu %d <= %d\n",

998 
p
->
mtu
, 
IPOIB_ENCAP_LEN
);

999  -
EINVAL
;

1002 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

1003 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1004 i‡(
ªt
) {

1005 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTR: %d\n", 
ªt
);

1006  
ªt
;

1009 
qp_©å
.
rq_p¢
 = 0 ;

1010 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1011 i‡(
ªt
) {

1012 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR: %d\n", 
ªt
);

1013  
ªt
;

1016 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

1017 
ªt
 = 
	`ib_cm_öô_qp_©å
(
cm_id
, &
qp_©å
, &
qp_©å_mask
);

1018 i‡(
ªt
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöô QPáâ∏f‹ RTS: %d\n", 
ªt
);

1020  
ªt
;

1022 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
qp_©å
, 
qp_©å_mask
);

1023 i‡(
ªt
) {

1024 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS: %d\n", 
ªt
);

1025  
ªt
;

1028 
	`skb_queue_hód_öô
(&
skqueue
);

1030 
	`√tif_tx_lock_bh
(
p
->
dev
);

1031 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1032 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
p
->
Êags
);

1033 i‡(
p
->
√igh
)

1034 (
skb
 = 
	`__skb_dequeue
(&
p
->
√igh
->
queue
)))

1035 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

1036 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1037 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1039 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

1040 
skb
->
dev
 = 
p
->dev;

1041 
ªt
 = 
	`dev_queue_xmô
(
skb
);

1042 i‡(
ªt
)

1043 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

1044 
__func__
, 
ªt
);

1047 
ªt
 = 
	`ib_£nd_cm_πu
(
cm_id
, 
NULL
, 0);

1048 i‡(
ªt
) {

1049 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd RTU: %d\n", 
ªt
);

1050  
ªt
;

1053 
	}
}

1055 
ib_qp
 *
	$ùoib_cm_¸óã_tx_qp
(
√t_devi˚
 *
dev
, 
ùoib_cm_tx
 *
tx
)

1057 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1058 
ib_qp_öô_©å
 
©å
 = {

1059 .
£nd_cq
 = 
¥iv
->send_cq,

1060 .
ªcv_cq
 = 
¥iv
->recv_cq,

1061 .
§q
 = 
¥iv
->
cm
.srq,

1062 .
ˇp
.
max_£nd_wr
 = 
ùoib_£ndq_size
,

1063 .
ˇp
.
max_£nd_sge
 = 1,

1064 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

1065 .
qp_ty≥
 = 
IB_QPT_RC
,

1066 .
qp_c⁄ãxt
 = 
tx
,

1067 .
¸óã_Êags
 = 0

1069 
ib_qp
 *
tx_qp
;

1071 i‡(
dev
->
„©uªs
 & 
NETIF_F_SG
)

1072 
©å
.
ˇp
.
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

1073 
MAX_SKB_FRAGS
 + 1);

1075 
tx_qp
 = 
	`ib_¸óã_qp
(
¥iv
->
pd
, &
©å
);

1076 
tx
->
max_£nd_sge
 = 
©å
.
ˇp
.max_send_sge;

1077  
tx_qp
;

1078 
	}
}

1080 
	$ùoib_cm_£nd_ªq
(
√t_devi˚
 *
dev
,

1081 
ib_cm_id
 *
id
, 
ib_qp
 *
qp
,

1082 
u32
 
q≤
,

1083 
ß_∑th_ªc
 *
∑thªc
)

1085 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1086 
ùoib_cm_d©a
 
d©a
 = {};

1087 
ib_cm_ªq_∑øm
 
ªq
 = {};

1089 
d©a
.
q≤
 = 
	`˝u_to_be32
(
¥iv
->
qp
->
qp_num
);

1090 
d©a
.
mtu
 = 
	`˝u_to_be32
(
IPOIB_CM_BUF_SIZE
);

1092 
ªq
.
¥im¨y_∑th
 = 
∑thªc
;

1093 
ªq
.
Æã∫©e_∑th
 = 
NULL
;

1094 
ªq
.
£rvi˚_id
 = 
	`˝u_to_be64
(
IPOIB_CM_IETF_ID
 | 
q≤
);

1095 
ªq
.
qp_num
 = 
qp
->qp_num;

1096 
ªq
.
qp_ty≥
 = 
qp
->qp_type;

1097 
ªq
.
¥iv©e_d©a
 = &
d©a
;

1098 
ªq
.
¥iv©e_d©a_Àn
 = (
d©a
);

1099 
ªq
.
Êow_c⁄åﬁ
 = 0;

1101 
ªq
.
°¨tög_p¢
 = 0;

1107 
ªq
.
ª•⁄dî_ªsour˚s
 = 4;

1108 
ªq
.
ªmŸe_cm_ª•⁄£_timeout
 = 20;

1109 
ªq
.
loˇl_cm_ª•⁄£_timeout
 = 20;

1110 
ªq
.
ªåy_cou¡
 = 0;

1111 
ªq
.
∫r_ªåy_cou¡
 = 0;

1112 
ªq
.
max_cm_ªåõs
 = 15;

1113 
ªq
.
§q
 = 
	`ùoib_cm_has_§q
(
dev
);

1114  
	`ib_£nd_cm_ªq
(
id
, &
ªq
);

1115 
	}
}

1117 
	$ùoib_cm_modify_tx_öô
(
√t_devi˚
 *
dev
,

1118 
ib_cm_id
 *
cm_id
, 
ib_qp
 *
qp
)

1120 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1121 
ib_qp_©å
 
qp_©å
;

1122 
qp_©å_mask
, 
ªt
;

1123 
ªt
 = 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
qp_©å
.
pkey_ödex
);

1124 i‡(
ªt
) {

1125 
	`ùoib_w¨n
(
¥iv
, "pkey 0x%xÇŸ found: %d\n",Öriv->
pkey
, 
ªt
);

1126  
ªt
;

1129 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

1130 
qp_©å
.
qp_ac˚ss_Êags
 = 
IB_ACCESS_LOCAL_WRITE
;

1131 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

1132 
qp_©å_mask
 = 
IB_QP_STATE
 | 
IB_QP_ACCESS_FLAGS
 | 
IB_QP_PKEY_INDEX
 | 
IB_QP_PORT
;

1134 
ªt
 = 
	`ib_modify_qp
(
qp
, &
qp_©å
, 
qp_©å_mask
);

1135 i‡(
ªt
) {

1136 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx QPÅÿINIT: %d\n", 
ªt
);

1137  
ªt
;

1140 
	}
}

1142 
	$ùoib_cm_tx_öô
(
ùoib_cm_tx
 *
p
, 
u32
 
q≤
,

1143 
ß_∑th_ªc
 *
∑thªc
)

1145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1146 
noio_Êag
;

1147 
ªt
;

1149 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1150 
p
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
, (*p->tx_ring)));

1151 i‡(!
p
->
tx_rög
) {

1152 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1153 
ªt
 = -
ENOMEM
;

1154 
îr_tx
;

1157 
p
->
qp
 = 
	`ùoib_cm_¸óã_tx_qp
’->
dev
,Ö);

1158 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1159 i‡(
	`IS_ERR
(
p
->
qp
)) {

1160 
ªt
 = 
	`PTR_ERR
(
p
->
qp
);

1161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx qp: %d\n", 
ªt
);

1162 
îr_qp
;

1165 
p
->
id
 = 
	`ib_¸óã_cm_id
(
¥iv
->
ˇ
, 
ùoib_cm_tx_h™dÀr
,Ö);

1166 i‡(
	`IS_ERR
(
p
->
id
)) {

1167 
ªt
 = 
	`PTR_ERR
(
p
->
id
);

1168 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ¸óãÅx cm id: %d\n", 
ªt
);

1169 
îr_id
;

1172 
ªt
 = 
	`ùoib_cm_modify_tx_öô
(
p
->
dev
,Ö->
id
,Ö->
qp
);

1173 i‡(
ªt
) {

1174 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodifyÅx q∞tÿπr: %d\n", 
ªt
);

1175 
îr_modify_£nd
;

1178 
ªt
 = 
	`ùoib_cm_£nd_ªq
(
p
->
dev
,Ö->
id
,Ö->
qp
, 
q≤
, 
∑thªc
);

1179 i‡(
ªt
) {

1180 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ£nd cmÑeq: %d\n", 
ªt
);

1181 
îr_modify_£nd
;

1184 
	`ùoib_dbg
(
¥iv
, "Request connection 0x%x for gid %pI6 qpn 0x%x\n",

1185 
p
->
qp
->
qp_num
, 
∑thªc
->
dgid
.
øw
, 
q≤
);

1189 
îr_modify_£nd
:

1190 
	`ib_de°roy_cm_id
(
p
->
id
);

1191 
îr_id
:

1192 
p
->
id
 = 
NULL
;

1193 
	`ib_de°roy_qp
(
p
->
qp
);

1194 
îr_qp
:

1195 
p
->
qp
 = 
NULL
;

1196 
	`v‰ì
(
p
->
tx_rög
);

1197 
îr_tx
:

1198  
ªt
;

1199 
	}
}

1201 
	$ùoib_cm_tx_de°roy
(
ùoib_cm_tx
 *
p
)

1203 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
p
->
dev
);

1204 
ùoib_tx_buf
 *
tx_ªq
;

1205 
begö
;

1207 
	`ùoib_dbg
(
¥iv
, "Destroyáctive connection 0x%x head 0x%xÅail 0x%x\n",

1208 
p
->
qp
 ?Ö->qp->
qp_num
 : 0,Ö->
tx_hód
,Ö->
tx_èû
);

1210 i‡(
p
->
id
)

1211 
	`ib_de°roy_cm_id
(
p
->
id
);

1213 i‡(
p
->
tx_rög
) {

1215 
begö
 = 
jiffõs
;

1216 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1217 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

1218 
	`ùoib_w¨n
(
¥iv
, "timing out; %d sendsÇot completed\n",

1219 
p
->
tx_hód
 -Ö->
tx_èû
);

1220 
timeout
;

1223 
	`u¶ìp_ønge
(1000, 2000);

1227 
timeout
:

1229 (Ë
p
->
tx_èû
 - (Ëp->
tx_hód
 < 0) {

1230 
tx_ªq
 = &
p
->
tx_rög
[p->
tx_èû
 & (
ùoib_£ndq_size
 - 1)];

1231 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

1232 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

1233 
	`√tif_tx_lock_bh
(
p
->
dev
);

1234 ++
p
->
tx_èû
;

1235 ++
¥iv
->
tx_èû
;

1236 i‡(
	`u∆ikñy
(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 >> 1) &&

1237 
	`√tif_queue_°›≥d
(
p
->
dev
) &&

1238 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
))

1239 
	`√tif_wake_queue
(
p
->
dev
);

1240 
	`√tif_tx_u∆ock_bh
(
p
->
dev
);

1243 i‡(
p
->
qp
)

1244 
	`ib_de°roy_qp
(
p
->
qp
);

1246 
	`v‰ì
(
p
->
tx_rög
);

1247 
	`k‰ì
(
p
);

1248 
	}
}

1250 
	$ùoib_cm_tx_h™dÀr
(
ib_cm_id
 *
cm_id
,

1251 c⁄° 
ib_cm_evít
 *
evít
)

1253 
ùoib_cm_tx
 *
tx
 = 
cm_id
->
c⁄ãxt
;

1254 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1255 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1256 
ùoib_√igh
 *
√igh
;

1257 
Êags
;

1258 
ªt
;

1260 
evít
->event) {

1261 
IB_CM_DREQ_RECEIVED
:

1262 
	`ùoib_dbg
(
¥iv
, "DREQÑeceived.\n");

1263 
	`ib_£nd_cm_dªp
(
cm_id
, 
NULL
, 0);

1265 
IB_CM_REP_RECEIVED
:

1266 
	`ùoib_dbg
(
¥iv
, "REPÑeceived.\n");

1267 
ªt
 = 
	`ùoib_cm_ªp_h™dÀr
(
cm_id
, 
evít
);

1268 i‡(
ªt
)

1269 
	`ib_£nd_cm_ªj
(
cm_id
, 
IB_CM_REJ_CONSUMER_DEFINED
,

1270 
NULL
, 0, NULL, 0);

1272 
IB_CM_REQ_ERROR
:

1273 
IB_CM_REJ_RECEIVED
:

1274 
IB_CM_TIMEWAIT_EXIT
:

1275 
	`ùoib_dbg
(
¥iv
, "CMÉº‹ %d.\n", 
evít
->event);

1276 
	`√tif_tx_lock_bh
(
dev
);

1277 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1278 
√igh
 = 
tx
->neigh;

1280 i‡(
√igh
) {

1281 
√igh
->
cm
 = 
NULL
;

1282 
	`ùoib_√igh_‰ì
(
√igh
);

1284 
tx
->
√igh
 = 
NULL
;

1287 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1288 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1289 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1292 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1293 
	`√tif_tx_u∆ock_bh
(
dev
);

1300 
	}
}

1302 
ùoib_cm_tx
 *
	$ùoib_cm_¸óã_tx
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
,

1303 
ùoib_√igh
 *
√igh
)

1305 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1306 
ùoib_cm_tx
 *
tx
;

1308 
tx
 = 
	`kzÆloc
((*tx), 
GFP_ATOMIC
);

1309 i‡(!
tx
)

1310  
NULL
;

1312 
√igh
->
cm
 = 
tx
;

1313 
tx
->
√igh
 =Çeigh;

1314 
tx
->
dev
 = dev;

1315 
	`li°_add
(&
tx
->
li°
, &
¥iv
->
cm
.
°¨t_li°
);

1316 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
);

1317 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
°¨t_èsk
);

1318  
tx
;

1319 
	}
}

1321 
	$ùoib_cm_de°roy_tx
(
ùoib_cm_tx
 *
tx
)

1323 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
tx
->
dev
);

1324 
Êags
;

1325 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
tx
->
Êags
)) {

1326 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1327 
	`li°_move
(&
tx
->
li°
, &
¥iv
->
cm
.
ª≠_li°
);

1328 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
ª≠_èsk
);

1329 
	`ùoib_dbg
(
¥iv
, "Reap connection for gid %pI6\n",

1330 
tx
->
√igh
->
daddr
 + 4);

1331 
tx
->
√igh
 = 
NULL
;

1332 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1334 
	}
}

1336 
	#QPN_AND_OPTIONS_OFFSET
 4

	)

1338 
	$ùoib_cm_tx_°¨t
(
w‹k_°ru˘
 *
w‹k
)

1340 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1341 
cm
.
°¨t_èsk
);

1342 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1343 
ùoib_√igh
 *
√igh
;

1344 
ùoib_cm_tx
 *
p
;

1345 
Êags
;

1346 
ùoib_∑th
 *
∑th
;

1347 
ªt
;

1349 
ß_∑th_ªc
 
∑thªc
;

1350 
u32
 
q≤
;

1352 
	`√tif_tx_lock_bh
(
dev
);

1353 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1355 !
	`li°_em±y
(&
¥iv
->
cm
.
°¨t_li°
)) {

1356 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
°¨t_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1357 
	`li°_dñ_öô
(&
p
->
li°
);

1358 
√igh
 = 
p
->neigh;

1360 
q≤
 = 
	`IPOIB_QPN
(
√igh
->
daddr
);

1365 
∑th
 = 
	`__∑th_föd
(
dev
, 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1366 i‡(!
∑th
) {

1367 
	`¥_öfo
("%s ignoreÇot validÖath %pI6\n",

1368 
__func__
,

1369 
√igh
->
daddr
 + 
QPN_AND_OPTIONS_OFFSET
);

1370 
‰ì_√igh
;

1372 
	`mem˝y
(&
∑thªc
, &
∑th
->pathrec, (pathrec));

1374 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1375 
	`√tif_tx_u∆ock_bh
(
dev
);

1377 
ªt
 = 
	`ùoib_cm_tx_öô
(
p
, 
q≤
, &
∑thªc
);

1379 
	`√tif_tx_lock_bh
(
dev
);

1380 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1382 i‡(
ªt
) {

1383 
‰ì_√igh
:

1384 
√igh
 = 
p
->neigh;

1385 i‡(
√igh
) {

1386 
√igh
->
cm
 = 
NULL
;

1387 
	`ùoib_√igh_‰ì
(
√igh
);

1389 
	`li°_dñ
(&
p
->
li°
);

1390 
	`k‰ì
(
p
);

1394 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1395 
	`√tif_tx_u∆ock_bh
(
dev
);

1396 
	}
}

1398 
	$ùoib_cm_tx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1400 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1401 
cm
.
ª≠_èsk
);

1402 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1403 
ùoib_cm_tx
 *
p
;

1404 
Êags
;

1406 
	`√tif_tx_lock_bh
(
dev
);

1407 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1409 !
	`li°_em±y
(&
¥iv
->
cm
.
ª≠_li°
)) {

1410 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
ª≠_li°
.
√xt
, 
	`ty≥of
(*p), 
li°
);

1411 
	`li°_dñ_öô
(&
p
->
li°
);

1412 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1413 
	`√tif_tx_u∆ock_bh
(
dev
);

1414 
	`ùoib_cm_tx_de°roy
(
p
);

1415 
	`√tif_tx_lock_bh
(
dev
);

1416 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1419 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1420 
	`√tif_tx_u∆ock_bh
(
dev
);

1421 
	}
}

1423 
	$ùoib_cm_skb_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1425 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1426 
cm
.
skb_èsk
);

1427 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1428 
sk_buff
 *
skb
;

1429 
Êags
;

1430 
mtu
 = 
¥iv
->
mˇ°_mtu
;

1432 
	`√tif_tx_lock_bh
(
dev
);

1433 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1435 (
skb
 = 
	`skb_dequeue
(&
¥iv
->
cm
.
skb_queue
))) {

1436 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1437 
	`√tif_tx_u∆ock_bh
(
dev
);

1439 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

1440 
	`mem£t
(
	`IPCB
(
skb
), 0, (*IPCB(skb)));

1441 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
	`ht⁄l
(
mtu
));

1443 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1444 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
)) {

1445 
	`mem£t
(
	`IP6CB
(
skb
), 0, (*IP6CB(skb)));

1446 
	`icmpv6_£nd
(
skb
, 
ICMPV6_PKT_TOOBIG
, 0, 
mtu
);

1449 
	`dev_k‰ì_skb_™y
(
skb
);

1451 
	`√tif_tx_lock_bh
(
dev
);

1452 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1455 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1456 
	`√tif_tx_u∆ock_bh
(
dev
);

1457 
	}
}

1459 
	$ùoib_cm_skb_too_l⁄g
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

1460 
mtu
)

1462 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1463 
e
 = 
	`skb_queue_em±y
(&
¥iv
->
cm
.
skb_queue
);

1465 
	`skb_d°_upd©e_pmtu
(
skb
, 
mtu
);

1467 
	`skb_queue_èû
(&
¥iv
->
cm
.
skb_queue
, 
skb
);

1468 i‡(
e
)

1469 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
cm
.
skb_èsk
);

1470 
	}
}

1472 
	$ùoib_cm_rx_ª≠
(
w‹k_°ru˘
 *
w‹k
)

1474 
	`ùoib_cm_‰ì_rx_ª≠_li°
(
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
,

1475 
cm
.
rx_ª≠_èsk
)->
dev
);

1476 
	}
}

1478 
	$ùoib_cm_°Æe_èsk
(
w‹k_°ru˘
 *
w‹k
)

1480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

1481 
cm
.
°Æe_èsk
.
w‹k
);

1482 
ùoib_cm_rx
 *
p
;

1483 
ªt
;

1485 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1486 !
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
)) {

1489 
p
 = 
	`li°_íåy
(
¥iv
->
cm
.
∑ssive_ids
.
¥ev
, 
	`ty≥of
(*p), 
li°
);

1490 i‡(
	`time_bef‹e_eq
(
jiffõs
, 
p
->jiffõ†+ 
IPOIB_CM_RX_TIMEOUT
))

1492 
	`li°_move
(&
p
->
li°
, &
¥iv
->
cm
.
rx_îr‹_li°
);

1493 
p
->
°©e
 = 
IPOIB_CM_RX_ERROR
;

1494 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1495 
ªt
 = 
	`ib_modify_qp
(
p
->
qp
, &
ùoib_cm_îr_©å
, 
IB_QP_STATE
);

1496 i‡(
ªt
)

1497 
	`ùoib_w¨n
(
¥iv
, "u«bÀÅÿmovêq∞tÿîr‹ sèã: %d\n", 
ªt
);

1498 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1501 i‡(!
	`li°_em±y
(&
¥iv
->
cm
.
∑ssive_ids
))

1502 
	`queue_dñayed_w‹k
(
¥iv
->
wq
,

1503 &
¥iv
->
cm
.
°Æe_èsk
, 
IPOIB_CM_RX_DELAY
);

1504 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1505 
	}
}

1507 
ssize_t
 
	$show_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1508 *
buf
)

1510 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1511 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1513 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

1514  
	`•rötf
(
buf
, "connected\n");

1516  
	`•rötf
(
buf
, "datagram\n");

1517 
	}
}

1519 
ssize_t
 
	$£t_mode
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

1520 c⁄° *
buf
, 
size_t
 
cou¡
)

1522 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

1523 
ªt
;

1525 i‡(!
	`π∆_åylock
()) {

1526  
	`ª°¨t_sysˇŒ
();

1529 i‡(
dev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

1530 
	`π∆_u∆ock
();

1531  -
EPERM
;

1534 
ªt
 = 
	`ùoib_£t_mode
(
dev
, 
buf
);

1540 i‡(
ªt
 !-
EBUSY
)

1541 
	`π∆_u∆ock
();

1543  (!
ªt
 ||Ñë =-
EBUSY
Ë? 
cou¡
 :Ñet;

1544 
	}
}

1546 
DEVICE_ATTR
(
mode
, 
S_IWUSR
 | 
S_IRUGO
, 
show_mode
, 
£t_mode
);

1548 
	$ùoib_cm_add_mode_©å
(
√t_devi˚
 *
dev
)

1550  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_mode
);

1551 
	}
}

1553 
	$ùoib_cm_¸óã_§q
(
√t_devi˚
 *
dev
, 
max_sge
)

1555 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1556 
ib_§q_öô_©å
 
§q_öô_©å
 = {

1557 .
§q_ty≥
 = 
IB_SRQT_BASIC
,

1558 .
©å
 = {

1559 .
max_wr
 = 
ùoib_ªcvq_size
,

1560 .
max_sge
 = max_sge

1564 
¥iv
->
cm
.
§q
 = 
	`ib_¸óã_§q
’riv->
pd
, &
§q_öô_©å
);

1565 i‡(
	`IS_ERR
(
¥iv
->
cm
.
§q
)) {

1566 i‡(
	`PTR_ERR
(
¥iv
->
cm
.
§q
Ë!-
EOPNOTSUPP
)

1567 
	`¥_w¨n
("%s: failedÅoállocate SRQ,Érror %ld\n",

1568 
¥iv
->
ˇ
->
«me
, 
	`PTR_ERR
’riv->
cm
.
§q
));

1569 
¥iv
->
cm
.
§q
 = 
NULL
;

1573 
¥iv
->
cm
.
§q_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_ªcvq_size
,

1574 (*
¥iv
->
cm
.
§q_rög
)));

1575 i‡(!
¥iv
->
cm
.
§q_rög
) {

1576 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1577 
¥iv
->
cm
.
§q
 = 
NULL
;

1581 
	}
}

1583 
	$ùoib_cm_dev_öô
(
√t_devi˚
 *
dev
)

1585 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1586 
max_§q_sge
, 
i
;

1588 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
∑ssive_ids
);

1589 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
ª≠_li°
);

1590 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
°¨t_li°
);

1591 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_îr‹_li°
);

1592 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_Êush_li°
);

1593 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_døö_li°
);

1594 
	`INIT_LIST_HEAD
(&
¥iv
->
cm
.
rx_ª≠_li°
);

1595 
	`INIT_WORK
(&
¥iv
->
cm
.
°¨t_èsk
, 
ùoib_cm_tx_°¨t
);

1596 
	`INIT_WORK
(&
¥iv
->
cm
.
ª≠_èsk
, 
ùoib_cm_tx_ª≠
);

1597 
	`INIT_WORK
(&
¥iv
->
cm
.
skb_èsk
, 
ùoib_cm_skb_ª≠
);

1598 
	`INIT_WORK
(&
¥iv
->
cm
.
rx_ª≠_èsk
, 
ùoib_cm_rx_ª≠
);

1599 
	`INIT_DELAYED_WORK
(&
¥iv
->
cm
.
°Æe_èsk
, 
ùoib_cm_°Æe_èsk
);

1601 
	`skb_queue_hód_öô
(&
¥iv
->
cm
.
skb_queue
);

1603 
	`ùoib_dbg
(
¥iv
, "max_§q_sge=%d\n",Öriv->
ˇ
->
©ås
.
max_§q_sge
);

1605 
max_§q_sge
 = 
	`mö_t
(, 
IPOIB_CM_RX_SG
, 
¥iv
->
ˇ
->
©ås
.max_srq_sge);

1606 
	`ùoib_cm_¸óã_§q
(
dev
, 
max_§q_sge
);

1607 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1608 
¥iv
->
cm
.
max_cm_mtu
 = 
max_§q_sge
 * 
PAGE_SIZE
 - 0x10;

1609 
¥iv
->
cm
.
num_‰ags
 = 
max_§q_sge
;

1610 
	`ùoib_dbg
(
¥iv
, "max_cm_mtu = 0x%x,Çum_frags=%d\n",

1611 
¥iv
->
cm
.
max_cm_mtu
,Öriv->cm.
num_‰ags
);

1613 
¥iv
->
cm
.
max_cm_mtu
 = 
IPOIB_CM_MTU
;

1614 
¥iv
->
cm
.
num_‰ags
 = 
IPOIB_CM_RX_SG
;

1617 
	`ùoib_cm_öô_rx_wr
(
dev
, &
¥iv
->
cm
.
rx_wr
,Öriv->cm.
rx_sge
);

1619 i‡(
	`ùoib_cm_has_§q
(
dev
)) {

1620 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

1621 i‡(!
	`ùoib_cm_Æloc_rx_skb
(
dev
, 
¥iv
->
cm
.
§q_rög
, 
i
,

1622 
¥iv
->
cm
.
num_‰ags
 - 1,

1623 
¥iv
->
cm
.
§q_rög
[
i
].
m≠pög
,

1624 
GFP_KERNEL
)) {

1625 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate "

1626 "ª˚ivêbuf„∏%d\n", 
i
);

1627 
	`ùoib_cm_dev_˛ónup
(
dev
);

1628  -
ENOMEM
;

1631 i‡(
	`ùoib_cm_po°_ª˚ive_§q
(
dev
, 
i
)) {

1632 
	`ùoib_w¨n
(
¥iv
, "ipoib_cm_post_receive_srq "

1633 "Áûed f‹ bu‡%d\n", 
i
);

1634 
	`ùoib_cm_dev_˛ónup
(
dev
);

1635  -
EIO
;

1640 
¥iv
->
dev
->
dev_addr
[0] = 
IPOIB_FLAGS_RC
;

1642 
	}
}

1644 
	$ùoib_cm_dev_˛ónup
(
√t_devi˚
 *
dev
)

1646 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1647 
ªt
;

1649 i‡(!
¥iv
->
cm
.
§q
)

1652 
	`ùoib_dbg
(
¥iv
, "Cleanup ipoib connected mode.\n");

1654 
ªt
 = 
	`ib_de°roy_§q
(
¥iv
->
cm
.
§q
);

1655 i‡(
ªt
)

1656 
	`ùoib_w¨n
(
¥iv
, "ib_de°roy_§q faûed: %d\n", 
ªt
);

1658 
¥iv
->
cm
.
§q
 = 
NULL
;

1659 i‡(!
¥iv
->
cm
.
§q_rög
)

1662 
	`ùoib_cm_‰ì_rx_rög
(
dev
, 
¥iv
->
cm
.
§q_rög
);

1663 
¥iv
->
cm
.
§q_rög
 = 
NULL
;

1664 
	}
}

	@SLES15SP2/ipoib/ipoib_ethtool.c

33 
	~<löux/kî√l.h
>

34 
	~<löux/ëhtoﬁ.h
>

35 
	~<löux/√tdevi˚.h
>

37 
	~"ùoib.h
"

39 
	sùoib_°©s
 {

40 
	m°©_°rög
[
ETH_GSTRING_LEN
];

41 
	m°©_off£t
;

44 
	#IPOIB_NETDEV_STAT
(
m
) { \

45 .
°©_°rög
 = #m, \

46 .
°©_off£t
 = 
	`off£tof
(
π∆_lök_°©s64
, 
m
Ë}

	)

48 c⁄° 
ùoib_°©s
 
	gùoib_g°rögs_°©s
[] = {

49 
IPOIB_NETDEV_STAT
(
rx_∑ckës
),

50 
IPOIB_NETDEV_STAT
(
tx_∑ckës
),

51 
IPOIB_NETDEV_STAT
(
rx_byãs
),

52 
IPOIB_NETDEV_STAT
(
tx_byãs
),

53 
IPOIB_NETDEV_STAT
(
tx_îr‹s
),

54 
IPOIB_NETDEV_STAT
(
rx_dr›≥d
),

55 
IPOIB_NETDEV_STAT
(
tx_dr›≥d
),

56 
IPOIB_NETDEV_STAT
(
mu…iˇ°
),

59 
	#IPOIB_GLOBAL_STATS_LEN
 
	`ARRAY_SIZE
(
ùoib_g°rögs_°©s
)

	)

61 
	$ùoib_gë_drvöfo
(
√t_devi˚
 *
√tdev
,

62 
ëhtoﬁ_drvöfo
 *
drvöfo
)

64 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

66 
	`ib_gë_devi˚_fw_°r
(
¥iv
->
ˇ
, 
drvöfo
->
fw_vîsi⁄
);

68 
	`°æ˝y
(
drvöfo
->
bus_öfo
, 
	`dev_«me
(
¥iv
->
ˇ
->
dev
.
∑ª¡
),

69 (
drvöfo
->
bus_öfo
));

71 
	`°æ˝y
(
drvöfo
->
vîsi⁄
, 
ùoib_drivî_vîsi⁄
,

72 (
drvöfo
->
vîsi⁄
));

74 
	`°æ˝y
(
drvöfo
->
drivî
, "ib_ipoib", (drvinfo->driver));

75 
	}
}

77 
	$ùoib_gë_cﬂÀs˚
(
√t_devi˚
 *
dev
,

78 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

80 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
cﬂl
->
rx_cﬂÀs˚_u£cs
 = 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
;

83 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 = 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
;

86 
	}
}

88 
	$ùoib_£t_cﬂÀs˚
(
√t_devi˚
 *
dev
,

89 
ëhtoﬁ_cﬂÀs˚
 *
cﬂl
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

98 i‡(
cﬂl
->
rx_cﬂÀs˚_u£cs
 > 0xffff ||

99 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
 > 0xffff)

100  -
EINVAL
;

102 
ªt
 = 
	`rdma_£t_cq_modî©i⁄
(
¥iv
->
ªcv_cq
,

103 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
,

104 
cﬂl
->
rx_cﬂÀs˚_u£cs
);

105 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
) {

106 
	`ùoib_w¨n
(
¥iv
, "Áûed modifyög CQ (%d)\n", 
ªt
);

107  
ªt
;

110 
¥iv
->
ëhtoﬁ
.
cﬂÀs˚_u£cs
 = 
cﬂl
->
rx_cﬂÀs˚_u£cs
;

111 
¥iv
->
ëhtoﬁ
.
max_cﬂÀs˚d_‰ames
 = 
cﬂl
->
rx_max_cﬂÀs˚d_‰ames
;

114 
	}
}

115 
	$ùoib_gë_ëhtoﬁ_°©s
(
√t_devi˚
 *
dev
,

116 
ëhtoﬁ_°©s
 
__Æways_unu£d
 *
°©s
,

117 
u64
 *
d©a
)

119 
i
;

120 
√t_devi˚_°©s
 *
√t_°©s
 = &
dev
->
°©s
;

121 
u8
 *
p
 = (u8 *)
√t_°©s
;

123 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++)

124 
d©a
[
i
] = *(
u64
 *)(
p
 + 
ùoib_g°rögs_°©s
[i].
°©_off£t
);

126 
	}
}

127 
	$ùoib_gë_°rögs
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

128 
u32
 
°rög£t
, 
u8
 *
d©a
)

130 
u8
 *
p
 = 
d©a
;

131 
i
;

133 
°rög£t
) {

134 
ETH_SS_STATS
:

135 
i
 = 0; i < 
IPOIB_GLOBAL_STATS_LEN
; i++) {

136 
	`mem˝y
(
p
, 
ùoib_g°rögs_°©s
[
i
].
°©_°rög
,

137 
ETH_GSTRING_LEN
);

138 
p
 +
ETH_GSTRING_LEN
;

144 
	}
}

145 
	$ùoib_gë_s£t_cou¡
(
√t_devi˚
 
__Æways_unu£d
 *
dev
,

146 
s£t
)

148 
s£t
) {

149 
ETH_SS_STATS
:

150  
IPOIB_GLOBAL_STATS_LEN
;

154  -
EOPNOTSUPP
;

155 
	}
}

158 
ölöe
 
	$ib_•ìd_íum_to_öt
(
•ìd
)

160 
•ìd
) {

161 
IB_SPEED_SDR
:

162  
SPEED_2500
;

163 
IB_SPEED_DDR
:

164  
SPEED_5000
;

165 
IB_SPEED_QDR
:

166 
IB_SPEED_FDR10
:

167  
SPEED_10000
;

168 
IB_SPEED_FDR
:

169  
SPEED_14000
;

170 
IB_SPEED_EDR
:

171  
SPEED_25000
;

174  
SPEED_UNKNOWN
;

175 
	}
}

177 
	$ùoib_gë_lök_k£âögs
(
√t_devi˚
 *
√tdev
,

178 
ëhtoﬁ_lök_k£âögs
 *
cmd
)

180 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
√tdev
);

181 
ib_p‹t_©å
 
©å
;

182 
ªt
, 
•ìd
, 
width
;

184 i‡(!
	`√tif_ˇºõr_ok
(
√tdev
)) {

185 
cmd
->
ba£
.
•ìd
 = 
SPEED_UNKNOWN
;

186 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_UNKNOWN
;

190 
ªt
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

191 i‡(
ªt
 < 0)

192  -
EINVAL
;

194 
•ìd
 = 
	`ib_•ìd_íum_to_öt
(
©å
.
a˘ive_•ìd
);

195 
width
 = 
	`ib_width_íum_to_öt
(
©å
.
a˘ive_width
);

197 i‡(
•ìd
 < 0 || 
width
 < 0)

198  -
EINVAL
;

204 
cmd
->
ba£
.
•ìd
 = s≥ed * 
width
;

205 
cmd
->
ba£
.
du∂ex
 = 
DUPLEX_FULL
;

207 
cmd
->
ba£
.
phy_addªss
 = 0xFF;

209 
cmd
->
ba£
.
aut⁄eg
 = 
AUTONEG_ENABLE
;

210 
cmd
->
ba£
.
p‹t
 = 
PORT_OTHER
;

213 
	}
}

215 c⁄° 
ëhtoﬁ_›s
 
	gùoib_ëhtoﬁ_›s
 = {

216 .
gë_lök_k£âögs
 = 
ùoib_gë_lök_k£âögs
,

217 .
	ggë_drvöfo
 = 
ùoib_gë_drvöfo
,

218 .
	ggë_cﬂÀs˚
 = 
ùoib_gë_cﬂÀs˚
,

219 .
	g£t_cﬂÀs˚
 = 
ùoib_£t_cﬂÀs˚
,

220 .
	ggë_°rögs
 = 
ùoib_gë_°rögs
,

221 .
	ggë_ëhtoﬁ_°©s
 = 
ùoib_gë_ëhtoﬁ_°©s
,

222 .
	ggë_s£t_cou¡
 = 
ùoib_gë_s£t_cou¡
,

223 .
	ggë_lök
 = 
ëhtoﬁ_›_gë_lök
,

226 
	$ùoib_£t_ëhtoﬁ_›s
(
√t_devi˚
 *
dev
)

228 
dev
->
ëhtoﬁ_›s
 = &
ùoib_ëhtoﬁ_›s
;

229 
	}
}

	@SLES15SP2/ipoib/ipoib_fs.c

33 
	~<löux/îr.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/¶ab.h
>

37 
	gfûe_›î©i⁄s
;

39 
	~<löux/debugfs.h
>

40 
	~<löux/exp‹t.h
>

42 
	~"ùoib.h
"

44 
díåy
 *
	gùoib_roŸ
;

46 
	$f‹m©_gid
(
ib_gid
 *
gid
, *
buf
)

48 
i
, 
n
;

50 
n
 = 0, 
i
 = 0; i < 8; ++i) {

51 
n
 +
	`•rötf
(
buf
 +Ç, "%x",

52 
	`be16_to_˝u
(((
__be16
 *Ë
gid
->
øw
)[
i
]));

53 i‡(
i
 < 7)

54 
buf
[
n
++] = ':';

56 
	}
}

58 *
	$ùoib_mcg_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

60 
ùoib_mˇ°_ôî
 *
ôî
;

61 
loff_t
 
n
 = *
pos
;

63 
ôî
 = 
	`ùoib_mˇ°_ôî_öô
(
fûe
->
¥iv©e
);

64 i‡(!
ôî
)

65  
NULL
;

67 
n
--) {

68 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

69 
	`k‰ì
(
ôî
);

70  
NULL
;

74  
ôî
;

75 
	}
}

77 *
	$ùoib_mcg_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

78 
loff_t
 *
pos
)

80 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

82 (*
pos
)++;

84 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

85 
	`k‰ì
(
ôî
);

86  
NULL
;

89  
ôî
;

90 
	}
}

92 
	$ùoib_mcg_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

95 
	}
}

97 
	$ùoib_mcg_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

99 
ùoib_mˇ°_ôî
 *
ôî
 = 
ôî_±r
;

100 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

101 
ib_gid
 
mgid
;

102 
¸óãd
;

103 
queuñí
, 
com∂ëe
, 
£nd_⁄ly
;

105 i‡(!
ôî
)

108 
	`ùoib_mˇ°_ôî_ªad
(
ôî
, &
mgid
, &
¸óãd
, &
queuñí
,

109 &
com∂ëe
, &
£nd_⁄ly
);

111 
	`f‹m©_gid
(&
mgid
, 
gid_buf
);

113 
	`£q_¥ötf
(
fûe
,

120 
gid_buf
, 
¸óãd
, 
queuñí
,

121 
com∂ëe
 ? "yes" : "no",

122 
£nd_⁄ly
 ? "yes" : "no");

125 
	}
}

127 c⁄° 
£q_›î©i⁄s
 
	gùoib_mcg_£q_›s
 = {

128 .
°¨t
 = 
ùoib_mcg_£q_°¨t
,

129 .
	g√xt
 = 
ùoib_mcg_£q_√xt
,

130 .
	g°›
 = 
ùoib_mcg_£q_°›
,

131 .
	gshow
 = 
ùoib_mcg_£q_show
,

134 
	$ùoib_mcg_›í
(
öode
 *öode, 
fûe
 *file)

136 
£q_fûe
 *
£q
;

137 
ªt
;

139 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_mcg_£q_›s
);

140 i‡(
ªt
)

141  
ªt
;

143 
£q
 = 
fûe
->
¥iv©e_d©a
;

144 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

147 
	}
}

149 c⁄° 
fûe_›î©i⁄s
 
	gùoib_mcg_f›s
 = {

150 .
ow√r
 = 
THIS_MODULE
,

151 .
	g›í
 = 
ùoib_mcg_›í
,

152 .
	gªad
 = 
£q_ªad
,

153 .
	gŒ£ek
 = 
£q_l£ek
,

154 .
	gªÀa£
 = 
£q_ªÀa£


157 *
	$ùoib_∑th_£q_°¨t
(
£q_fûe
 *
fûe
, 
loff_t
 *
pos
)

159 
ùoib_∑th_ôî
 *
ôî
;

160 
loff_t
 
n
 = *
pos
;

162 
ôî
 = 
	`ùoib_∑th_ôî_öô
(
fûe
->
¥iv©e
);

163 i‡(!
ôî
)

164  
NULL
;

166 
n
--) {

167 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

168 
	`k‰ì
(
ôî
);

169  
NULL
;

173  
ôî
;

174 
	}
}

176 *
	$ùoib_∑th_£q_√xt
(
£q_fûe
 *
fûe
, *
ôî_±r
,

177 
loff_t
 *
pos
)

179 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

181 (*
pos
)++;

183 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

184 
	`k‰ì
(
ôî
);

185  
NULL
;

188  
ôî
;

189 
	}
}

191 
	$ùoib_∑th_£q_°›
(
£q_fûe
 *
fûe
, *
ôî_±r
)

194 
	}
}

196 
	$ùoib_∑th_£q_show
(
£q_fûe
 *
fûe
, *
ôî_±r
)

198 
ùoib_∑th_ôî
 *
ôî
 = 
ôî_±r
;

199 
gid_buf
[ "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];

200 
ùoib_∑th
 
∑th
;

201 
øã
;

203 i‡(!
ôî
)

206 
	`ùoib_∑th_ôî_ªad
(
ôî
, &
∑th
);

208 
	`f‹m©_gid
(&
∑th
.
∑thªc
.
dgid
, 
gid_buf
);

210 
	`£q_¥ötf
(
fûe
,

213 
gid_buf
, 
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
) ? "yes" : "no");

215 i‡(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)) {

216 
øã
 = 
	`ib_øã_to_mbps
(
∑th
.
∑thªc
.rate);

218 
	`£q_¥ötf
(
fûe
,

222 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
.
∑thªc
)),

223 
∑th
.
∑thªc
.
¶
,

224 
øã
 / 1000,Ñate % 1000);

227 
	`£q_putc
(
fûe
, '\n');

230 
	}
}

232 c⁄° 
£q_›î©i⁄s
 
	gùoib_∑th_£q_›s
 = {

233 .
°¨t
 = 
ùoib_∑th_£q_°¨t
,

234 .
	g√xt
 = 
ùoib_∑th_£q_√xt
,

235 .
	g°›
 = 
ùoib_∑th_£q_°›
,

236 .
	gshow
 = 
ùoib_∑th_£q_show
,

239 
	$ùoib_∑th_›í
(
öode
 *öode, 
fûe
 *file)

241 
£q_fûe
 *
£q
;

242 
ªt
;

244 
ªt
 = 
	`£q_›í
(
fûe
, &
ùoib_∑th_£q_›s
);

245 i‡(
ªt
)

246  
ªt
;

248 
£q
 = 
fûe
->
¥iv©e_d©a
;

249 
£q
->
¥iv©e
 = 
öode
->
i_¥iv©e
;

252 
	}
}

254 c⁄° 
fûe_›î©i⁄s
 
	gùoib_∑th_f›s
 = {

255 .
ow√r
 = 
THIS_MODULE
,

256 .
	g›í
 = 
ùoib_∑th_›í
,

257 .
	gªad
 = 
£q_ªad
,

258 .
	gŒ£ek
 = 
£q_l£ek
,

259 .
	gªÀa£
 = 
£q_ªÀa£


262 
	$ùoib_¸óã_debug_fûes
(
√t_devi˚
 *
dev
)

264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

265 
«me
[
IFNAMSIZ
 + ("_path")];

267 
	`¢¥ötf
(
«me
, “ame), "%s_mcg", 
dev
->name);

268 
¥iv
->
mcg_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

269 
ùoib_roŸ
, 
dev
, &
ùoib_mcg_f›s
);

271 
	`¢¥ötf
(
«me
, “ame), "%s_∑th", 
dev
->name);

272 
¥iv
->
∑th_díåy
 = 
	`debugfs_¸óã_fûe
(
«me
, 
S_IFREG
 | 
S_IRUGO
,

273 
ùoib_roŸ
, 
dev
, &
ùoib_∑th_f›s
);

274 
	}
}

276 
	$ùoib_dñëe_debug_fûes
(
√t_devi˚
 *
dev
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 
	`debugfs_ªmove
(
¥iv
->
mcg_díåy
);

281 
	`debugfs_ªmove
(
¥iv
->
∑th_díåy
);

282 
¥iv
->
mcg_díåy
 =Öriv->
∑th_díåy
 = 
NULL
;

283 
	}
}

285 
	$ùoib_ªgi°î_debugfs
()

287 
ùoib_roŸ
 = 
	`debugfs_¸óã_dú
("ùoib", 
NULL
);

288 
	}
}

290 
	$ùoib_uƒegi°î_debugfs
()

292 
	`debugfs_ªmove
(
ùoib_roŸ
);

293 
	}
}

	@SLES15SP2/ipoib/ipoib_ib.c

36 
	~<löux/dñay.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/dma-m≠pög.h
>

39 
	~<löux/¶ab.h
>

41 
	~<löux/ù.h
>

42 
	~<löux/t˝.h
>

43 
	~<rdma/ib_ˇche.h
>

45 
	~"ùoib.h
"

47 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG_DATA


48 
	gd©a_debug_Àvñ
;

50 
moduÀ_∑øm
(
d©a_debug_Àvñ
, , 0644);

51 
MODULE_PARM_DESC
(
d©a_debug_Àvñ
,

55 
ùoib_ah
 *
	$ùoib_¸óã_ah
(
√t_devi˚
 *
dev
,

56 
ib_pd
 *
pd
, 
rdma_ah_©å
 *
©å
)

58 
ùoib_ah
 *
ah
;

59 
ib_ah
 *
vah
;

61 
ah
 = 
	`kmÆloc
((*ah), 
GFP_KERNEL
);

62 i‡(!
ah
)

63  
	`ERR_PTR
(-
ENOMEM
);

65 
ah
->
dev
 = dev;

66 
ah
->
œ°_£nd
 = 0;

67 
	`kªf_öô
(&
ah
->
ªf
);

69 
vah
 = 
	`rdma_¸óã_ah
(
pd
, 
©å
, 
RDMA_CREATE_AH_SLEEPABLE
);

70 i‡(
	`IS_ERR
(
vah
)) {

71 
	`k‰ì
(
ah
);

72 
ah
 = (
ùoib_ah
 *)
vah
;

74 
ah
->ah = 
vah
;

75 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "Cª©edáh %p\n", 
ah
->ah);

78  
ah
;

79 
	}
}

81 
	$ùoib_‰ì_ah
(
kªf
 *kref)

83 
ùoib_ah
 *
ah
 = 
	`c⁄èöî_of
(
kªf
, ùoib_ah, 
ªf
);

84 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ah
->
dev
);

86 
Êags
;

88 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

89 
	`li°_add_èû
(&
ah
->
li°
, &
¥iv
->
dód_ahs
);

90 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

91 
	}
}

93 
	$ùoib_ud_dma_unm≠_rx
(
ùoib_dev_¥iv
 *
¥iv
,

94 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
])

96 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0],

97 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
),

98 
DMA_FROM_DEVICE
);

99 
	}
}

101 
	$ùoib_ib_po°_ª˚ive
(
√t_devi˚
 *
dev
, 
id
)

103 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

104 
ªt
;

106 
¥iv
->
rx_wr
.
wr_id
 = 
id
 | 
IPOIB_OP_RECV
;

107 
¥iv
->
rx_sge
[0].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[0];

108 
¥iv
->
rx_sge
[1].
addr
 =Öriv->
rx_rög
[
id
].
m≠pög
[1];

111 
ªt
 = 
	`ib_po°_ªcv
(
¥iv
->
qp
, &¥iv->
rx_wr
, 
NULL
);

112 i‡(
	`u∆ikñy
(
ªt
)) {

113 
	`ùoib_w¨n
(
¥iv
, "ª˚ivêÁûed f‹ bu‡%d (%d)\n", 
id
, 
ªt
);

114 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
id
].
m≠pög
);

115 
	`dev_k‰ì_skb_™y
(
¥iv
->
rx_rög
[
id
].
skb
);

116 
¥iv
->
rx_rög
[
id
].
skb
 = 
NULL
;

119  
ªt
;

120 
	}
}

122 
sk_buff
 *
	$ùoib_Æloc_rx_skb
(
√t_devi˚
 *
dev
, 
id
)

124 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

125 
sk_buff
 *
skb
;

126 
buf_size
;

127 
u64
 *
m≠pög
;

129 
buf_size
 = 
	`IPOIB_UD_BUF_SIZE
(
¥iv
->
max_ib_mtu
);

131 
skb
 = 
	`dev_Æloc_skb
(
buf_size
 + 
IPOIB_HARD_LEN
);

132 i‡(
	`u∆ikñy
(!
skb
))

133  
NULL
;

139 
	`skb_ª£rve
(
skb
, (
ùoib_p£udo_hódî
));

141 
m≠pög
 = 
¥iv
->
rx_rög
[
id
].mapping;

142 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
¥iv
->
ˇ
, 
skb
->
d©a
, 
buf_size
,

143 
DMA_FROM_DEVICE
);

144 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
¥iv
->
ˇ
, 
m≠pög
[0])))

145 
îr‹
;

147 
¥iv
->
rx_rög
[
id
].
skb
 = skb;

148  
skb
;

149 
îr‹
:

150 
	`dev_k‰ì_skb_™y
(
skb
);

151  
NULL
;

152 
	}
}

154 
	$ùoib_ib_po°_ª˚ives
(
√t_devi˚
 *
dev
)

156 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

157 
i
;

159 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

160 i‡(!
	`ùoib_Æloc_rx_skb
(
dev
, 
i
)) {

161 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿÆloˇãÑe˚ivêbuf„∏%d\n", 
i
);

162  -
ENOMEM
;

164 i‡(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
i
)) {

165 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ivêÁûed f‹ bu‡%d\n", 
i
);

166  -
EIO
;

171 
	}
}

173 
	$ùoib_ib_h™dÀ_rx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

175 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

176 
wr_id
 = 
wc
->wr_id & ~
IPOIB_OP_RECV
;

177 
sk_buff
 *
skb
;

178 
u64
 
m≠pög
[
IPOIB_UD_RX_SG
];

179 
ib_gid
 *
dgid
;

180 
ib_gid
 *
sgid
;

182 
	`ùoib_dbg_d©a
(
¥iv
, "recv completion: id %d, status: %d\n",

183 
wr_id
, 
wc
->
°©us
);

185 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_ªcvq_size
)) {

186 
	`ùoib_w¨n
(
¥iv
, "recv completionÉvent with wrid %d (> %d)\n",

187 
wr_id
, 
ùoib_ªcvq_size
);

191 
skb
 = 
¥iv
->
rx_rög
[
wr_id
].skb;

193 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

194 i‡(
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
)

195 
	`ùoib_w¨n
(
¥iv
,

197 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

198 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,Öriv->
rx_rög
[
wr_id
].
m≠pög
);

199 
	`dev_k‰ì_skb_™y
(
skb
);

200 
¥iv
->
rx_rög
[
wr_id
].
skb
 = 
NULL
;

204 
	`mem˝y
(
m≠pög
, 
¥iv
->
rx_rög
[
wr_id
].mapping,

205 
IPOIB_UD_RX_SG
 * (*
m≠pög
));

211 i‡(
	`u∆ikñy
(!
	`ùoib_Æloc_rx_skb
(
dev
, 
wr_id
))) {

212 ++
dev
->
°©s
.
rx_dr›≥d
;

213 
ªpo°
;

216 
	`ùoib_dbg_d©a
(
¥iv
, "received %d bytes, SLID 0x%04x\n",

217 
wc
->
byã_Àn
, wc->
¶id
);

219 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
, 
m≠pög
);

221 
	`skb_put
(
skb
, 
wc
->
byã_Àn
);

224 
dgid
 = &((
ib_grh
 *)
skb
->
d©a
)->dgid;

226 i‡(!(
wc
->
wc_Êags
 & 
IB_WC_GRH
Ë|| 
dgid
->
øw
[0] != 0xff)

227 
skb
->
pkt_ty≥
 = 
PACKET_HOST
;

228 i‡(
	`memcmp
(
dgid
, 
dev
->
brﬂdˇ°
 + 4, (
ib_gid
)) == 0)

229 
skb
->
pkt_ty≥
 = 
PACKET_BROADCAST
;

231 
skb
->
pkt_ty≥
 = 
PACKET_MULTICAST
;

233 
sgid
 = &((
ib_grh
 *)
skb
->
d©a
)->sgid;

239 i‡(
wc
->
¶id
 =
¥iv
->
loˇl_lid
 && wc->
§c_qp
 =¥iv->
qp
->
qp_num
) {

240 
√ed_ªpo°
 = 1;

242 i‡((
wc
->
wc_Êags
 & 
IB_WC_GRH
) &&

243 
sgid
->
globÆ
.
öãrÁ˚_id
 !
¥iv
->
loˇl_gid
.global.interface_id)

244 
√ed_ªpo°
 = 0;

246 i‡(
√ed_ªpo°
) {

247 
	`dev_k‰ì_skb_™y
(
skb
);

248 
ªpo°
;

252 
	`skb_puŒ
(
skb
, 
IB_GRH_BYTES
);

254 
skb
->
¥Ÿocﬁ
 = ((
ùoib_hódî
 *Ëskb->
d©a
)->
¥Ÿo
;

255 
	`skb_add_p£udo_hdr
(
skb
);

257 ++
dev
->
°©s
.
rx_∑ckës
;

258 
dev
->
°©s
.
rx_byãs
 +
skb
->
Àn
;

259 i‡(
skb
->
pkt_ty≥
 =
PACKET_MULTICAST
)

260 
dev
->
°©s
.
mu…iˇ°
++;

262 
skb
->
dev
 = dev;

263 i‡((
dev
->
„©uªs
 & 
NETIF_F_RXCSUM
) &&

264 
	`likñy
(
wc
->
wc_Êags
 & 
IB_WC_IP_CSUM_OK
))

265 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

267 
	`«pi_gro_ª˚ive
(&
¥iv
->
ªcv_«pi
, 
skb
);

269 
ªpo°
:

270 i‡(
	`u∆ikñy
(
	`ùoib_ib_po°_ª˚ive
(
dev
, 
wr_id
)))

271 
	`ùoib_w¨n
(
¥iv
, "ipoib_ib_post_receive failed "

272 "f‹ bu‡%d\n", 
wr_id
);

273 
	}
}

275 
	$ùoib_dma_m≠_tx
(
ib_devi˚
 *
ˇ
, 
ùoib_tx_buf
 *
tx_ªq
)

277 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

278 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

279 
i
;

280 
off
;

282 i‡(
	`skb_hódÀn
(
skb
)) {

283 
m≠pög
[0] = 
	`ib_dma_m≠_sögÀ
(
ˇ
, 
skb
->
d©a
, 
	`skb_hódÀn
(skb),

284 
DMA_TO_DEVICE
);

285 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[0])))

286  -
EIO
;

288 
off
 = 1;

290 
off
 = 0;

292 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

293 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

294 
m≠pög
[
i
 + 
off
] = 
	`ib_dma_m≠_∑ge
(
ˇ
,

295 
	`skb_‰ag_∑ge
(
‰ag
),

296 
	`skb_‰ag_off
(
‰ag
),

297 
	`skb_‰ag_size
(
‰ag
),

298 
DMA_TO_DEVICE
);

299 i‡(
	`u∆ikñy
(
	`ib_dma_m≠pög_îr‹
(
ˇ
, 
m≠pög
[
i
 + 
off
])))

300 
∑πül_îr‹
;

304 
∑πül_îr‹
:

305 ; 
i
 > 0; --i) {

306 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
 - 1];

308 
	`ib_dma_unm≠_∑ge
(
ˇ
, 
m≠pög
[
i
 - !
off
], 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

311 i‡(
off
)

312 
	`ib_dma_unm≠_sögÀ
(
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
), 
DMA_TO_DEVICE
);

314  -
EIO
;

315 
	}
}

317 
	$ùoib_dma_unm≠_tx
(
ùoib_dev_¥iv
 *
¥iv
,

318 
ùoib_tx_buf
 *
tx_ªq
)

320 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

321 
u64
 *
m≠pög
 = 
tx_ªq
->mapping;

322 
i
;

323 
off
;

325 i‡(
	`skb_hódÀn
(
skb
)) {

326 
	`ib_dma_unm≠_sögÀ
(
¥iv
->
ˇ
, 
m≠pög
[0], 
	`skb_hódÀn
(
skb
),

327 
DMA_TO_DEVICE
);

328 
off
 = 1;

330 
off
 = 0;

332 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; ++i) {

333 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

335 
	`ib_dma_unm≠_∑ge
(
¥iv
->
ˇ
, 
m≠pög
[
i
 + 
off
],

336 
	`skb_‰ag_size
(
‰ag
), 
DMA_TO_DEVICE
);

338 
	}
}

345 
	$ùoib_qp_°©e_vÆid©e_w‹k
(
w‹k_°ru˘
 *
w‹k
)

347 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
 =

348 
	`c⁄èöî_of
(
w‹k
, 
ùoib_qp_°©e_vÆid©e
, work);

350 
ùoib_dev_¥iv
 *
¥iv
 = 
qp_w‹k
->priv;

351 
ib_qp_©å
 
qp_©å
;

352 
ib_qp_öô_©å
 
quîy_öô_©å
;

353 
ªt
;

355 
ªt
 = 
	`ib_quîy_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

356 i‡(
ªt
) {

357 
	`ùoib_w¨n
(
¥iv
, "%s: FailedÅo query QPÑet: %d\n",

358 
__func__
, 
ªt
);

359 
‰ì_ªs
;

361 
	`¥_öfo
("%s: QP: 0x%x is in state: %d\n",

362 
__func__
, 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

365 i‡(
qp_©å
.
qp_°©e
 =
IB_QPS_SQE
) {

366 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

368 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
);

369 i‡(
ªt
) {

370 
	`¥_w¨n
("failed(%d) modify QP:0x%x SQE->RTS\n",

371 
ªt
, 
¥iv
->
qp
->
qp_num
);

372 
‰ì_ªs
;

374 
	`¥_öfo
("%s: QP: 0x%x moved from IB_QPS_SQEÅo IB_QPS_RTS\n",

375 
__func__
, 
¥iv
->
qp
->
qp_num
);

377 
	`¥_w¨n
("QP (%d) will stay in state: %d\n",

378 
¥iv
->
qp
->
qp_num
, 
qp_©å
.
qp_°©e
);

381 
‰ì_ªs
:

382 
	`k‰ì
(
qp_w‹k
);

383 
	}
}

385 
	$ùoib_ib_h™dÀ_tx_wc
(
√t_devi˚
 *
dev
, 
ib_wc
 *
wc
)

387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

388 
wr_id
 = 
wc
->wr_id;

389 
ùoib_tx_buf
 *
tx_ªq
;

391 
	`ùoib_dbg_d©a
(
¥iv
, "send completion: id %d, status: %d\n",

392 
wr_id
, 
wc
->
°©us
);

394 i‡(
	`u∆ikñy
(
wr_id
 >
ùoib_£ndq_size
)) {

395 
	`ùoib_w¨n
(
¥iv
, "send completionÉvent with wrid %d (> %d)\n",

396 
wr_id
, 
ùoib_£ndq_size
);

400 
tx_ªq
 = &
¥iv
->
tx_rög
[
wr_id
];

402 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

404 ++
dev
->
°©s
.
tx_∑ckës
;

405 
dev
->
°©s
.
tx_byãs
 +
tx_ªq
->
skb
->
Àn
;

407 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

409 ++
¥iv
->
tx_èû
;

411 i‡(
	`u∆ikñy
(
	`√tif_queue_°›≥d
(
dev
) &&

412 ((
¥iv
->
tx_hód
 -Öriv->
tx_èû
Ë<
ùoib_£ndq_size
 >> 1) &&

413 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)))

414 
	`√tif_wake_queue
(
dev
);

416 i‡(
wc
->
°©us
 !
IB_WC_SUCCESS
 &&

417 
wc
->
°©us
 !
IB_WC_WR_FLUSH_ERR
) {

418 
ùoib_qp_°©e_vÆid©e
 *
qp_w‹k
;

419 
	`ùoib_w¨n
(
¥iv
,

421 
wc
->
°©us
, 
wr_id
, wc->
víd‹_îr
);

422 
qp_w‹k
 = 
	`kzÆloc
((*qp_w‹k), 
GFP_ATOMIC
);

423 i‡(!
qp_w‹k
)

426 
	`INIT_WORK
(&
qp_w‹k
->
w‹k
, 
ùoib_qp_°©e_vÆid©e_w‹k
);

427 
qp_w‹k
->
¥iv
 =Öriv;

428 
	`queue_w‹k
(
¥iv
->
wq
, &
qp_w‹k
->
w‹k
);

430 
	}
}

432 
	$pﬁl_tx
(
ùoib_dev_¥iv
 *
¥iv
)

434 
n
, 
i
;

435 
ib_wc
 *
wc
;

437 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

438 
i
 = 0; i < 
n
; ++i) {

439 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

440 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

441 
	`ùoib_cm_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

443 
	`ùoib_ib_h™dÀ_tx_wc
(
¥iv
->
dev
,Öriv->
£nd_wc
 + 
i
);

445  
n
 =
MAX_SEND_CQE
;

446 
	}
}

448 
	$ùoib_rx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

450 
ùoib_dev_¥iv
 *
¥iv
 =

451 
	`c⁄èöî_of
(
«pi
, 
ùoib_dev_¥iv
, 
ªcv_«pi
);

452 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

453 
d⁄e
;

454 
t
;

455 
n
, 
i
;

457 
d⁄e
 = 0;

459 
pﬁl_m‹e
:

460 
d⁄e
 < 
budgë
) {

461 
max
 = (
budgë
 - 
d⁄e
);

463 
t
 = 
	`mö
(
IPOIB_NUM_WC
, 
max
);

464 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
t
,Öriv->
ibwc
);

466 
i
 = 0; i < 
n
; i++) {

467 
ib_wc
 *
wc
 = 
¥iv
->
ibwc
 + 
i
;

469 i‡(
wc
->
wr_id
 & 
IPOIB_OP_RECV
) {

470 ++
d⁄e
;

471 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

472 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
wc
);

474 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
wc
);

476 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

480 i‡(
n
 !
t
)

484 i‡(
d⁄e
 < 
budgë
) {

485 
	`«pi_com∂ëe
(
«pi
);

486 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
,

487 
IB_CQ_NEXT_COMP
 |

488 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

489 
	`«pi_ªscheduÀ
(
«pi
))

490 
pﬁl_m‹e
;

493  
d⁄e
;

494 
	}
}

496 
	$ùoib_tx_pﬁl
(
«pi_°ru˘
 *
«pi
, 
budgë
)

498 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
«pi
, ipoib_dev_priv,

499 
£nd_«pi
);

500 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

501 
n
, 
i
;

502 
ib_wc
 *
wc
;

504 
pﬁl_m‹e
:

505 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
£nd_cq
, 
MAX_SEND_CQE
,Öriv->
£nd_wc
);

507 
i
 = 0; i < 
n
; i++) {

508 
wc
 = 
¥iv
->
£nd_wc
 + 
i
;

509 i‡(
wc
->
wr_id
 & 
IPOIB_OP_CM
)

510 
	`ùoib_cm_h™dÀ_tx_wc
(
dev
, 
wc
);

512 
	`ùoib_ib_h™dÀ_tx_wc
(
dev
, 
wc
);

515 i‡(
n
 < 
budgë
) {

516 
	`«pi_com∂ëe
(
«pi
);

517 i‡(
	`u∆ikñy
(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

518 
IB_CQ_REPORT_MISSED_EVENTS
)) &&

519 
	`«pi_ªscheduÀ
(
«pi
))

520 
pﬁl_m‹e
;

522  
n
 < 0 ? 0 :Ç;

523 
	}
}

525 
	$ùoib_ib_rx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

527 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

529 
	`«pi_scheduÀ
(&
¥iv
->
ªcv_«pi
);

530 
	}
}

532 
	$ùoib_ib_tx_com∂ëi⁄
(
ib_cq
 *
cq
, *
˘x_±r
)

534 
ùoib_dev_¥iv
 *
¥iv
 = 
˘x_±r
;

536 
	`«pi_scheduÀ
(&
¥iv
->
£nd_«pi
);

537 
	}
}

539 
ölöe
 
	$po°_£nd
(
ùoib_dev_¥iv
 *
¥iv
,

540 
wr_id
,

541 
ib_ah
 *
addªss
, 
u32
 
dq≤
,

542 
ùoib_tx_buf
 *
tx_ªq
,

543 *
hód
, 
hÀn
)

545 
sk_buff
 *
skb
 = 
tx_ªq
->skb;

547 
	`ùoib_buûd_sge
(
¥iv
, 
tx_ªq
);

549 
¥iv
->
tx_wr
.
wr
.
wr_id
 = wr_id;

550 
¥iv
->
tx_wr
.
ªmŸe_q≤
 = 
dq≤
;

551 
¥iv
->
tx_wr
.
ah
 = 
addªss
;

553 i‡(
hód
) {

554 
¥iv
->
tx_wr
.
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

555 
¥iv
->
tx_wr
.
hódî
 = 
hód
;

556 
¥iv
->
tx_wr
.
hÀn
 = hlen;

557 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_LSO
;

559 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

561  
	`ib_po°_£nd
(
¥iv
->
qp
, &¥iv->
tx_wr
.
wr
, 
NULL
);

562 
	}
}

564 
	$ùoib_£nd
(
√t_devi˚
 *
dev
, 
sk_buff
 *
skb
,

565 
ib_ah
 *
addªss
, 
u32
 
dq≤
)

567 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

568 
ùoib_tx_buf
 *
tx_ªq
;

569 
hÀn
, 
rc
;

570 *
phód
;

571 
ußbÀ_sge
 = 
¥iv
->
max_£nd_sge
 - !!
	`skb_hódÀn
(
skb
);

573 i‡(
	`skb_is_gso
(
skb
)) {

574 
hÀn
 = 
	`skb_å™•‹t_off£t
(
skb
Ë+ 
	`t˝_hdæí
(skb);

575 
phód
 = 
skb
->
d©a
;

576 i‡(
	`u∆ikñy
(!
	`skb_puŒ
(
skb
, 
hÀn
))) {

577 
	`ùoib_w¨n
(
¥iv
, "linear dataÅoo small\n");

578 ++
dev
->
°©s
.
tx_dr›≥d
;

579 ++
dev
->
°©s
.
tx_îr‹s
;

580 
	`dev_k‰ì_skb_™y
(
skb
);

584 i‡(
	`u∆ikñy
(
skb
->
Àn
 > 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
)) {

585 
	`ùoib_w¨n
(
¥iv
, "packetÜen %d (> %d)ÅooÜongÅo send, dropping\n",

586 
skb
->
Àn
, 
¥iv
->
mˇ°_mtu
 + 
IPOIB_ENCAP_LEN
);

587 ++
dev
->
°©s
.
tx_dr›≥d
;

588 ++
dev
->
°©s
.
tx_îr‹s
;

589 
	`ùoib_cm_skb_too_l⁄g
(
dev
, 
skb
, 
¥iv
->
mˇ°_mtu
);

592 
phód
 = 
NULL
;

593 
hÀn
 = 0;

595 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

596 i‡(
	`skb_löórize
(
skb
) < 0) {

597 
	`ùoib_w¨n
(
¥iv
, "skb couldÇot beÜinearized\n");

598 ++
dev
->
°©s
.
tx_dr›≥d
;

599 ++
dev
->
°©s
.
tx_îr‹s
;

600 
	`dev_k‰ì_skb_™y
(
skb
);

604 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 > 
ußbÀ_sge
) {

605 
	`ùoib_w¨n
(
¥iv
, "too many fragsáfter skbÜinearize\n");

606 ++
dev
->
°©s
.
tx_dr›≥d
;

607 ++
dev
->
°©s
.
tx_îr‹s
;

608 
	`dev_k‰ì_skb_™y
(
skb
);

613 
	`ùoib_dbg_d©a
(
¥iv
,

615 
skb
->
Àn
, 
addªss
, 
dq≤
);

624 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_hód
 & (
ùoib_£ndq_size
 - 1)];

625 
tx_ªq
->
skb
 = skb;

626 i‡(
	`u∆ikñy
(
	`ùoib_dma_m≠_tx
(
¥iv
->
ˇ
, 
tx_ªq
))) {

627 ++
dev
->
°©s
.
tx_îr‹s
;

628 
	`dev_k‰ì_skb_™y
(
skb
);

632 i‡(
skb
->
ù_summed
 =
CHECKSUM_PARTIAL
)

633 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 |
IB_SEND_IP_CSUM
;

635 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

637 i‡(
¥iv
->
tx_hód
 -Öriv->
tx_èû
 =
ùoib_£ndq_size
 - 1) {

638 
	`ùoib_dbg
(
¥iv
, "TXÑing full, stopping kernelÇet queue\n");

639 
	`√tif_°›_queue
(
dev
);

642 
	`skb_‹ph™
(
skb
);

643 
	`skb_d°_dr›
(
skb
);

645 i‡(
	`√tif_queue_°›≥d
(
dev
))

646 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
 |

647 
IB_CQ_REPORT_MISSED_EVENTS
) < 0)

648 
	`ùoib_w¨n
(
¥iv
, "requestÇotify on send CQ failed\n");

650 
rc
 = 
	`po°_£nd
(
¥iv
,Öriv->
tx_hód
 & (
ùoib_£ndq_size
 - 1),

651 
addªss
, 
dq≤
, 
tx_ªq
, 
phód
, 
hÀn
);

652 i‡(
	`u∆ikñy
(
rc
)) {

653 
	`ùoib_w¨n
(
¥iv
, "po°_£nd faûed,Éº‹ %d\n", 
rc
);

654 ++
dev
->
°©s
.
tx_îr‹s
;

655 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

656 
	`dev_k‰ì_skb_™y
(
skb
);

657 i‡(
	`√tif_queue_°›≥d
(
dev
))

658 
	`√tif_wake_queue
(
dev
);

659 
rc
 = 0;

661 
	`√tif_å™s_upd©e
(
dev
);

663 
rc
 = 
¥iv
->
tx_hód
;

664 ++
¥iv
->
tx_hód
;

666  
rc
;

667 
	}
}

669 
	$__ùoib_ª≠_ah
(
√t_devi˚
 *
dev
)

671 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

672 
ùoib_ah
 *
ah
, *
èh
;

673 
Êags
;

675 
	`√tif_tx_lock_bh
(
dev
);

676 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

678 
	`li°_f‹_óch_íåy_ß„
(
ah
, 
èh
, &
¥iv
->
dód_ahs
, 
li°
)

679 i‡((Ë
¥iv
->
tx_èû
 - (Ë
ah
->
œ°_£nd
 >= 0) {

680 
	`li°_dñ
(&
ah
->
li°
);

681 
	`rdma_de°roy_ah
(
ah
->ah, 0);

682 
	`k‰ì
(
ah
);

685 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

686 
	`√tif_tx_u∆ock_bh
(
dev
);

687 
	}
}

689 
	$ùoib_ª≠_ah
(
w‹k_°ru˘
 *
w‹k
)

691 
ùoib_dev_¥iv
 *
¥iv
 =

692 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ah_ª≠_èsk
.work);

693 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

695 
	`__ùoib_ª≠_ah
(
dev
);

697 i‡(!
	`ã°_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
))

698 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

699 
	`round_jiffõs_ªœtive
(
HZ
));

700 
	}
}

702 
	$ùoib_Êush_ah
(
√t_devi˚
 *
dev
)

704 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

706 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

707 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

708 
	`ùoib_ª≠_ah
(&
¥iv
->
ah_ª≠_èsk
.
w‹k
);

709 
	}
}

711 
	$ùoib_°›_ah
(
√t_devi˚
 *
dev
)

713 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

715 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

716 
	`ùoib_Êush_ah
(
dev
);

717 
	}
}

719 
	$ªcvs_≥ndög
(
√t_devi˚
 *
dev
)

721 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

722 
≥ndög
 = 0;

723 
i
;

725 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i)

726 i‡(
¥iv
->
rx_rög
[
i
].
skb
)

727 ++
≥ndög
;

729  
≥ndög
;

730 
	}
}

732 
	$check_qp_movemít_™d_¥öt
(
ùoib_dev_¥iv
 *
¥iv
,

733 
ib_qp
 *
qp
,

734 
ib_qp_°©e
 
√w_°©e
)

736 
ib_qp_©å
 
qp_©å
;

737 
ib_qp_öô_©å
 
quîy_öô_©å
;

738 
ªt
;

740 
ªt
 = 
	`ib_quîy_qp
(
qp
, &
qp_©å
, 
IB_QP_STATE
, &
quîy_öô_©å
);

741 i‡(
ªt
) {

742 
	`ùoib_w¨n
(
¥iv
, "%s: FaûedÅÿquîy QP\n", 
__func__
);

746 i‡(
√w_°©e
 =
IB_QPS_ERR
 && 
qp_©å
.
qp_°©e
 =
IB_QPS_RESET
)

747 
	`ùoib_dbg
(
¥iv
, "Failed modify QP, IB_QPS_RESETÅo IB_QPS_ERR,ácceptable\n");

749 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo state: %d from state: %d\n",

750 
√w_°©e
, 
qp_©å
.
qp_°©e
);

751 
	}
}

753 
	$ùoib_«pi_íabÀ
(
√t_devi˚
 *
dev
)

755 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

757 
	`«pi_íabÀ
(&
¥iv
->
ªcv_«pi
);

758 
	`«pi_íabÀ
(&
¥iv
->
£nd_«pi
);

759 
	}
}

761 
	$ùoib_«pi_dißbÀ
(
√t_devi˚
 *
dev
)

763 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

765 
	`«pi_dißbÀ
(&
¥iv
->
ªcv_«pi
);

766 
	`«pi_dißbÀ
(&
¥iv
->
£nd_«pi
);

767 
	}
}

769 
	$ùoib_ib_dev_°›_deÁu…
(
√t_devi˚
 *
dev
)

771 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

772 
ib_qp_©å
 
qp_©å
;

773 
begö
;

774 
ùoib_tx_buf
 *
tx_ªq
;

775 
i
;

777 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

778 
	`ùoib_«pi_dißbÀ
(
dev
);

780 
	`ùoib_cm_dev_°›
(
dev
);

786 
qp_©å
.
qp_°©e
 = 
IB_QPS_ERR
;

787 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

788 
	`check_qp_movemít_™d_¥öt
(
¥iv
,Öriv->
qp
, 
IB_QPS_ERR
);

791 
begö
 = 
jiffõs
;

793 
¥iv
->
tx_hód
 !¥iv->
tx_èû
 || 
	`ªcvs_≥ndög
(
dev
)) {

794 i‡(
	`time_a·î
(
jiffõs
, 
begö
 + 5 * 
HZ
)) {

795 
	`ùoib_w¨n
(
¥iv
,

797 
¥iv
->
tx_hód
 -Öriv->
tx_èû
,

798 
	`ªcvs_≥ndög
(
dev
));

804 ()
¥iv
->
tx_èû
 - (Ìriv->
tx_hód
 < 0) {

805 
tx_ªq
 = &
¥iv
->
tx_rög
[¥iv->
tx_èû
 &

806 (
ùoib_£ndq_size
 - 1)];

807 
	`ùoib_dma_unm≠_tx
(
¥iv
, 
tx_ªq
);

808 
	`dev_k‰ì_skb_™y
(
tx_ªq
->
skb
);

809 ++
¥iv
->
tx_èû
;

812 
i
 = 0; i < 
ùoib_ªcvq_size
; ++i) {

813 
ùoib_rx_buf
 *
rx_ªq
;

815 
rx_ªq
 = &
¥iv
->
rx_rög
[
i
];

816 i‡(!
rx_ªq
->
skb
)

818 
	`ùoib_ud_dma_unm≠_rx
(
¥iv
,

819 
¥iv
->
rx_rög
[
i
].
m≠pög
);

820 
	`dev_k‰ì_skb_™y
(
rx_ªq
->
skb
);

821 
rx_ªq
->
skb
 = 
NULL
;

824 
timeout
;

827 
	`ùoib_døö_cq
(
dev
);

829 
	`u¶ìp_ønge
(1000, 2000);

832 
	`ùoib_dbg
(
¥iv
, "All sendsándÑeceives done.\n");

834 
timeout
:

835 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

836 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

837 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

839 
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
);

842 
	}
}

844 
	$ùoib_ib_dev_°›
(
√t_devi˚
 *
dev
)

846 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

848 
¥iv
->
∫_›s
->
	`ndo_°›
(
dev
);

850 
	`˛ór_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

851 
	`ùoib_Êush_ah
(
dev
);

854 
	}
}

856 
	$ùoib_ib_dev_›í_deÁu…
(
√t_devi˚
 *
dev
)

858 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

859 
ªt
;

861 
ªt
 = 
	`ùoib_öô_qp
(
dev
);

862 i‡(
ªt
) {

863 
	`ùoib_w¨n
(
¥iv
, "ùoib_öô_q∞ªtu∫ed %d\n", 
ªt
);

867 
ªt
 = 
	`ùoib_ib_po°_ª˚ives
(
dev
);

868 i‡(
ªt
) {

869 
	`ùoib_w¨n
(
¥iv
, "ùoib_ib_po°_ª˚ive†ªtu∫ed %d\n", 
ªt
);

870 
out
;

873 
ªt
 = 
	`ùoib_cm_dev_›í
(
dev
);

874 i‡(
ªt
) {

875 
	`ùoib_w¨n
(
¥iv
, "ùoib_cm_dev_›íÑëu∫ed %d\n", 
ªt
);

876 
out
;

879 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

880 
	`ùoib_«pi_íabÀ
(
dev
);

883 
out
:

885 
	}
}

887 
	$ùoib_ib_dev_›í
(
√t_devi˚
 *
dev
)

889 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

891 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

893 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

894 
	`ùoib_w¨n
(
¥iv
, "P_Key 0x%04x i†%s\n",Öriv->
pkey
,

895 (!(
¥iv
->
pkey
 & 0x7fff) ? "Invalid" : "not found"));

899 
	`˛ór_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

900 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
ah_ª≠_èsk
,

901 
	`round_jiffõs_ªœtive
(
HZ
));

903 i‡(
¥iv
->
∫_›s
->
	`ndo_›í
(
dev
)) {

904 
	`¥_w¨n
("%s: FaûedÅÿ›í dev\n", 
dev
->
«me
);

905 
dev_°›
;

908 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

912 
dev_°›
:

913 
	`£t_bô
(
IPOIB_STOP_REAPER
, &
¥iv
->
Êags
);

914 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
ah_ª≠_èsk
);

915 
	`£t_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
);

916 
	`ùoib_ib_dev_°›
(
dev
);

918 
	}
}

920 
	$ùoib_pkey_dev_check_¥e£n˚
(
√t_devi˚
 *
dev
)

922 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

923 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

925 i‡(!(
¥iv
->
pkey
 & 0x7fff) ||

926 
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
,

927 &
¥iv
->
pkey_ödex
)) {

928 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

930 i‡(
∫
->
£t_id
)

931 
∫
->
	`£t_id
(
dev
, 
¥iv
->
pkey_ödex
);

932 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

934 
	}
}

936 
	$ùoib_ib_dev_up
(
√t_devi˚
 *
dev
)

938 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

940 
	`ùoib_pkey_dev_check_¥e£n˚
(
dev
);

942 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
)) {

943 
	`ùoib_dbg
(
¥iv
, "PKEY isÇotássigned.\n");

947 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

949 
	`ùoib_mˇ°_°¨t_thªad
(
dev
);

950 
	}
}

952 
	$ùoib_ib_dev_down
(
√t_devi˚
 *
dev
)

954 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

956 
	`ùoib_dbg
(
¥iv
, "downing ib_dev\n");

958 
	`˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

959 
	`√tif_ˇºõr_off
(
dev
);

961 
	`ùoib_mˇ°_°›_thªad
(
dev
);

962 
	`ùoib_mˇ°_dev_Êush
(
dev
);

964 
	`ùoib_Êush_∑ths
(
dev
);

965 
	}
}

967 
	$ùoib_døö_cq
(
√t_devi˚
 *
dev
)

969 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

970 
i
, 
n
;

977 
	`loˇl_bh_dißbÀ
();

980 
n
 = 
	`ib_pﬁl_cq
(
¥iv
->
ªcv_cq
, 
IPOIB_NUM_WC
,Öriv->
ibwc
);

981 
i
 = 0; i < 
n
; ++i) {

987 i‡(
¥iv
->
ibwc
[
i
].
°©us
 =
IB_WC_SUCCESS
)

988 
¥iv
->
ibwc
[
i
].
°©us
 = 
IB_WC_WR_FLUSH_ERR
;

990 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_RECV
) {

991 i‡(
¥iv
->
ibwc
[
i
].
wr_id
 & 
IPOIB_OP_CM
)

992 
	`ùoib_cm_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

994 
	`ùoib_ib_h™dÀ_rx_wc
(
dev
, 
¥iv
->
ibwc
 + 
i
);

996 
	`¥_w¨n
("%s: GŸ u√x≥˘ed wqêid\n", 
__func__
);

999 } 
n
 =
IPOIB_NUM_WC
);

1001 
	`pﬁl_tx
(
¥iv
))

1004 
	`loˇl_bh_íabÀ
();

1005 
	}
}

1011 
ölöe
 
	$upd©e_∑ª¡_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1013 
ªsu…
;

1014 
u16
 
¥ev_pkey
;

1016 
¥ev_pkey
 = 
¥iv
->
pkey
;

1017 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1018 i‡(
ªsu…
) {

1019 
	`ùoib_w¨n
(
¥iv
, "ib_query_pkeyÖort %d failed (ret = %d)\n",

1020 
¥iv
->
p‹t
, 
ªsu…
);

1021  
ªsu…
;

1024 
¥iv
->
pkey
 |= 0x8000;

1026 i‡(
¥ev_pkey
 !
¥iv
->
pkey
) {

1027 
	`ùoib_dbg
(
¥iv
, "pkey changed from 0x%xÅo 0x%x\n",

1028 
¥ev_pkey
, 
¥iv
->
pkey
);

1033 
¥iv
->
dev
->
brﬂdˇ°
[8] =Öriv->
pkey
 >> 8;

1034 
¥iv
->
dev
->
brﬂdˇ°
[9] =Öriv->
pkey
 & 0xff;

1039 
	}
}

1043 
ölöe
 
	$upd©e_chûd_pkey
(
ùoib_dev_¥iv
 *
¥iv
)

1045 
u16
 
ﬁd_ödex
 = 
¥iv
->
pkey_ödex
;

1047 
¥iv
->
pkey_ödex
 = 0;

1048 
	`ùoib_pkey_dev_check_¥e£n˚
(
¥iv
->
dev
);

1050 i‡(
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
) &&

1051 (
ﬁd_ödex
 =
¥iv
->
pkey_ödex
))

1054 
	}
}

1060 
boﬁ
 
	$ùoib_dev_addr_ch™ged_vÆid
(
ùoib_dev_¥iv
 *
¥iv
)

1062 
ib_gid
 
£¨ch_gid
;

1063 
ib_gid
 
gid0
;

1064 
ib_gid
 *
√tdev_gid
;

1065 
îr
;

1066 
u16
 
ödex
;

1067 
u8
 
p‹t
;

1068 
boﬁ
 
ªt
 = 
Ál£
;

1070 
√tdev_gid
 = (
ib_gid
 *)(
¥iv
->
dev
->
dev_addr
 + 4);

1071 i‡(
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &
gid0
))

1072  
Ál£
;

1074 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1079 
¥iv
->
loˇl_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1080 
√tdev_gid
->
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1081 
£¨ch_gid
.
globÆ
.
sub√t_¥efix
 = 
gid0
.global.subnet_prefix;

1083 
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 = 
¥iv
->
loˇl_gid
.global.interface_id;

1085 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1087 
îr
 = 
	`ib_föd_gid
(
¥iv
->
ˇ
, &
£¨ch_gid
, &
p‹t
, &
ödex
);

1089 
	`√tif_addr_lock_bh
(
¥iv
->
dev
);

1091 i‡(
£¨ch_gid
.
globÆ
.
öãrÁ˚_id
 !=

1092 
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
)

1096 
out
;

1123 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

1124 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1125 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1126 i‡(
ödex
 == 0)

1127 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
,

1128 &
¥iv
->
Êags
);

1130 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
);

1131 
ªt
 = 
åue
;

1133 
ªt
 = 
Ál£
;

1136 i‡(!
îr
 && 
p‹t
 =
¥iv
->port) {

1137 
ªt
 = 
åue
;

1139 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_CTRL
, &
¥iv
->
Êags
)) {

1140 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
gid0
,

1141 (
¥iv
->
loˇl_gid
));

1142 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4, &
gid0
,

1143 (
¥iv
->
loˇl_gid
));

1144 
ªt
 = 
åue
;

1149 
out
:

1150 
	`√tif_addr_u∆ock_bh
(
¥iv
->
dev
);

1152  
ªt
;

1153 
	}
}

1155 
	$__ùoib_ib_dev_Êush
(
ùoib_dev_¥iv
 *
¥iv
,

1156 
ùoib_Êush_Àvñ
 
Àvñ
,

1157 
√°ög
)

1159 
ùoib_dev_¥iv
 *
˝riv
;

1160 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

1161 
ªsu…
;

1163 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

1169 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
)

1170 
	`__ùoib_ib_dev_Êush
(
˝riv
, 
Àvñ
, 
√°ög
 + 1);

1172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

1174 i‡(!
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
) &&

1175 
Àvñ
 !
IPOIB_FLUSH_HEAVY
) {

1177 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1178 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1179 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_INITIALIZEDÇot set.\n");

1183 i‡(!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1185 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1186 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1187 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1189 
	`upd©e_chûd_pkey
(
¥iv
);

1190 } i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
)

1191 
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
);

1192 
	`ùoib_dbg
(
¥iv
, "Not flushing - IPOIB_FLAG_ADMIN_UPÇot set.\n");

1196 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1200 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

1201 
ªsu…
 = 
	`upd©e_chûd_pkey
(
¥iv
);

1202 i‡(
ªsu…
) {

1204 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key indexÇot changed.\n");

1209 
ªsu…
 = 
	`upd©e_∑ª¡_pkey
(
¥iv
);

1211 i‡(
ªsu…
) {

1212 
	`ùoib_dbg
(
¥iv
, "Not flushing - P_Key valueÇot changed.\n");

1218 i‡(
Àvñ
 =
IPOIB_FLUSH_LIGHT
) {

1219 
›î_up
;

1220 
	`ùoib_m¨k_∑ths_övÆid
(
dev
);

1226 
›î_up
 = 
	`ã°_™d_˛ór_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1227 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1228 i‡(
›î_up
)

1229 
	`£t_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
);

1230 
	`ùoib_Êush_ah
(
dev
);

1233 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1234 
	`ùoib_ib_dev_down
(
dev
);

1236 i‡(
Àvñ
 =
IPOIB_FLUSH_HEAVY
) {

1237 i‡(
	`ã°_bô
(
IPOIB_FLAG_INITIALIZED
, &
¥iv
->
Êags
))

1238 
	`ùoib_ib_dev_°›
(
dev
);

1240 i‡(
	`ùoib_ib_dev_›í
(
dev
))

1243 i‡(
	`√tif_queue_°›≥d
(
dev
))

1244 
	`√tif_°¨t_queue
(
dev
);

1251 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
)) {

1252 i‡(
Àvñ
 >
IPOIB_FLUSH_NORMAL
)

1253 
	`ùoib_ib_dev_up
(
dev
);

1254 i‡(
	`ùoib_dev_addr_ch™ged_vÆid
(
¥iv
))

1255 
	`ùoib_mˇ°_ª°¨t_èsk
(&
¥iv
->
ª°¨t_èsk
);

1257 
	}
}

1259 
	$ùoib_ib_dev_Êush_light
(
w‹k_°ru˘
 *
w‹k
)

1261 
ùoib_dev_¥iv
 *
¥iv
 =

1262 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_light
);

1264 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_LIGHT
, 0);

1265 
	}
}

1267 
	$ùoib_ib_dev_Êush_n‹mÆ
(
w‹k_°ru˘
 *
w‹k
)

1269 
ùoib_dev_¥iv
 *
¥iv
 =

1270 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_n‹mÆ
);

1272 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_NORMAL
, 0);

1273 
	}
}

1275 
	$ùoib_ib_dev_Êush_hóvy
(
w‹k_°ru˘
 *
w‹k
)

1277 
ùoib_dev_¥iv
 *
¥iv
 =

1278 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
Êush_hóvy
);

1280 
	`π∆_lock
();

1281 
	`__ùoib_ib_dev_Êush
(
¥iv
, 
IPOIB_FLUSH_HEAVY
, 0);

1282 
	`π∆_u∆ock
();

1283 
	}
}

1285 
	$ùoib_ib_dev_˛ónup
(
√t_devi˚
 *
dev
)

1287 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1289 
	`ùoib_dbg
(
¥iv
, "cleaning up ib_dev\n");

1294 
	`ùoib_Êush_∑ths
(
dev
);

1296 
	`ùoib_mˇ°_°›_thªad
(
dev
);

1297 
	`ùoib_mˇ°_dev_Êush
(
dev
);

1305 
	`ùoib_°›_ah
(
dev
);

1307 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

1309 
¥iv
->
∫_›s
->
	`ndo_unöô
(
dev
);

1311 i‡(
¥iv
->
pd
) {

1312 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1313 
¥iv
->
pd
 = 
NULL
;

1315 
	}
}

	@SLES15SP2/ipoib/ipoib_main.c

35 
	~"ùoib.h
"

37 
	~<löux/moduÀ.h
>

39 
	~<löux/öô.h
>

40 
	~<löux/¶ab.h
>

41 
	~<löux/kî√l.h
>

42 
	~<löux/vmÆloc.h
>

44 
	~<löux/if_¨p.h
>

46 
	~<löux/ù.h
>

47 
	~<löux/ö.h
>

49 
	~<löux/jhash.h
>

50 
	~<√t/¨p.h
>

51 
	~<√t/addrc⁄f.h
>

52 
	~<löux/öëdevi˚.h
>

53 
	~<rdma/ib_ˇche.h
>

55 
	#DRV_VERSION
 "1.0.0"

	)

57 c⁄° 
	gùoib_drivî_vîsi⁄
[] = 
DRV_VERSION
;

59 
MODULE_AUTHOR
("Roland Dreier");

60 
MODULE_DESCRIPTION
("IP-over-InfiniBandÇet driver -- Intel Accelerated IPoIB version");

61 
MODULE_LICENSE
("Dual BSD/GPL");

63 
ùoib_£ndq_size
 
	g__ªad_mo°ly
 = 
IPOIB_TX_RING_SIZE
;

64 
ùoib_ªcvq_size
 
	g__ªad_mo°ly
 = 
IPOIB_RX_RING_SIZE
;

66 
moduÀ_∑øm_«med
(
£nd_queue_size
, 
ùoib_£ndq_size
, , 0444);

67 
MODULE_PARM_DESC
(
£nd_queue_size
, "Number of descriptors in send queue");

68 
moduÀ_∑øm_«med
(
ªcv_queue_size
, 
ùoib_ªcvq_size
, , 0444);

69 
MODULE_PARM_DESC
(
ªcv_queue_size
, "Number of descriptors inÑeceive queue");

71 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


72 
	gùoib_debug_Àvñ
;

74 
moduÀ_∑øm_«med
(
debug_Àvñ
, 
ùoib_debug_Àvñ
, , 0644);

75 
MODULE_PARM_DESC
(
debug_Àvñ
, "Enable debugÅracing if > 0");

78 
	sùoib_∑th_ôî
 {

79 
√t_devi˚
 *
	mdev
;

80 
ùoib_∑th
 
	m∑th
;

83 c⁄° 
u8
 
	gùv4_bˇ°_addr
[] = {

89 
w‹kqueue_°ru˘
 *
	gùoib_w‹kqueue
;

91 
ib_ß_˛õ¡
 
	gùoib_ß_˛õ¡
;

93 
ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
);

94 
ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
);

95 
ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
);

96 
√t_devi˚
 *
ùoib_gë_√t_dev_by_∑øms
(

97 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

98 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

99 *
˛õ¡_d©a
);

100 
ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
);

101 
ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

102 
cmd
);

104 
ib_˛õ¡
 
	gùoib_˛õ¡
 = {

105 .
«me
 = "ipoib",

106 .
	gadd
 = 
ùoib_add_⁄e
,

107 .
	gªmove
 = 
ùoib_ªmove_⁄e
,

108 .
	ggë_√t_dev_by_∑øms
 = 
ùoib_gë_√t_dev_by_∑øms
,

111 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


112 
	$ùoib_√tdev_evít
(
nŸifõr_block
 *
this
,

113 
evít
, *
±r
)

115 
√tdev_nŸifõr_öfo
 *
ni
 = 
±r
;

116 
√t_devi˚
 *
dev
 = 
ni
->dev;

118 i‡(
dev
->
√tdev_›s
->
ndo_›í
 !
ùoib_›í
)

119  
NOTIFY_DONE
;

121 
evít
) {

122 
NETDEV_REGISTER
:

123 
	`ùoib_¸óã_debug_fûes
(
dev
);

125 
NETDEV_CHANGENAME
:

126 
	`ùoib_dñëe_debug_fûes
(
dev
);

127 
	`ùoib_¸óã_debug_fûes
(
dev
);

129 
NETDEV_UNREGISTER
:

130 
	`ùoib_dñëe_debug_fûes
(
dev
);

134  
NOTIFY_DONE
;

135 
	}
}

138 
	$ùoib_›í
(
√t_devi˚
 *
dev
)

140 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

142 
	`ùoib_dbg
(
¥iv
, "bringing up interface\n");

144 
	`√tif_ˇºõr_off
(
dev
);

146 
	`£t_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

148 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 = 
Ál£
;

150 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

151 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

153 
îr_dißbÀ
;

156 
	`ùoib_ib_dev_up
(
dev
);

158 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

159 
ùoib_dev_¥iv
 *
˝riv
;

162 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

163 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

164 
Êags
;

166 
Êags
 = 
˝riv
->
dev
->flags;

167 i‡(
Êags
 & 
IFF_UP
)

170 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 | 
IFF_UP
, 
NULL
);

172 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

175 
	`√tif_°¨t_queue
(
dev
);

179 
îr_dißbÀ
:

180 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

182  -
EINVAL
;

183 
	}
}

185 
	$ùoib_°›
(
√t_devi˚
 *
dev
)

187 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

189 
	`ùoib_dbg
(
¥iv
, "stopping interface\n");

191 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_UP
, &
¥iv
->
Êags
);

193 
	`√tif_°›_queue
(
dev
);

195 
	`ùoib_ib_dev_down
(
dev
);

196 
	`ùoib_ib_dev_°›
(
dev
);

198 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

199 
ùoib_dev_¥iv
 *
˝riv
;

202 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

203 
	`li°_f‹_óch_íåy
(
˝riv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

204 
Êags
;

206 
Êags
 = 
˝riv
->
dev
->flags;

207 i‡(!(
Êags
 & 
IFF_UP
))

210 
	`dev_ch™ge_Êags
(
˝riv
->
dev
, 
Êags
 & ~
IFF_UP
, 
NULL
);

212 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

216 
	}
}

218 
√tdev_„©uªs_t
 
	$ùoib_fix_„©uªs
(
√t_devi˚
 *
dev
, 
√tdev_„©uªs_t
 
„©uªs
)

220 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

222 i‡(
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
))

223 
„©uªs
 &~(
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
);

225  
„©uªs
;

226 
	}
}

228 
	$ùoib_ch™ge_mtu
(
√t_devi˚
 *
dev
, 
√w_mtu
)

230 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

231 
ªt
 = 0;

234 i‡(
	`ùoib_cm_admö_íabÀd
(
dev
)) {

235 i‡(
√w_mtu
 > 
	`ùoib_cm_max_mtu
(
dev
))

236  -
EINVAL
;

238 i‡(
√w_mtu
 > 
¥iv
->
mˇ°_mtu
)

239 
	`ùoib_w¨n
(
¥iv
, "mtu > %d will cause multicastÖacket drops.\n",

240 
¥iv
->
mˇ°_mtu
);

242 
dev
->
mtu
 = 
√w_mtu
;

246 i‡(
√w_mtu
 < (
ETH_MIN_MTU
 + 
IPOIB_ENCAP_LEN
) ||

247 
√w_mtu
 > 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
))

248  -
EINVAL
;

250 
¥iv
->
admö_mtu
 = 
√w_mtu
;

252 i‡(
¥iv
->
mˇ°_mtu
 <Öriv->
admö_mtu
)

253 
	`ùoib_dbg
(
¥iv
, "MTU must be smallerÅhanÅhe underlying "

254 "lökÜayî MTU - 4 (%u)\n", 
¥iv
->
mˇ°_mtu
);

256 
√w_mtu
 = 
	`mö
(
¥iv
->
mˇ°_mtu
,Öriv->
admö_mtu
);

258 i‡(
¥iv
->
∫_›s
->
ndo_ch™ge_mtu
) {

259 
boﬁ
 
ˇºõr_°©us
 = 
	`√tif_ˇºõr_ok
(
dev
);

261 
	`√tif_ˇºõr_off
(
dev
);

264 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_ch™ge_mtu
(
dev
, 
√w_mtu
);

266 i‡(
ˇºõr_°©us
)

267 
	`√tif_ˇºõr_⁄
(
dev
);

269 
dev
->
mtu
 = 
√w_mtu
;

272  
ªt
;

273 
	}
}

275 
	$ùoib_gë_°©s
(
√t_devi˚
 *
dev
,

276 
π∆_lök_°©s64
 *
°©s
)

278 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

280 i‡(
¥iv
->
∫_›s
->
ndo_gë_°©s64
)

281 
¥iv
->
∫_›s
->
	`ndo_gë_°©s64
(
dev
, 
°©s
);

283 
	`√tdev_°©s_to_°©s64
(
°©s
, &
dev
->stats);

284 
	}
}

287 
boﬁ
 
	$ùoib_is_dev_m©ch_addr_rcu
(c⁄° 
sockaddr
 *
addr
,

288 
√t_devi˚
 *
dev
)

290 
√t
 *√à
	`dev_√t
(
dev
);

291 
ö_devi˚
 *
ö_dev
;

292 
sockaddr_ö
 *
addr_ö
 = (sockaddr_ö *)
addr
;

293 
sockaddr_ö6
 *
addr_ö6
 = (sockaddr_ö6 *)
addr
;

294 
__be32
 
ªt_addr
;

296 
addr
->
ß_Ámûy
) {

297 
AF_INET
:

298 
ö_dev
 = 
	`ö_dev_gë
(
dev
);

299 i‡(!
ö_dev
)

300  
Ál£
;

302 
ªt_addr
 = 
	`öë_c⁄fúm_addr
(
√t
, 
ö_dev
, 0,

303 
addr_ö
->
sö_addr
.
s_addr
,

304 
RT_SCOPE_HOST
);

305 
	`ö_dev_put
(
ö_dev
);

306 i‡(
ªt_addr
)

307  
åue
;

310 
AF_INET6
:

311 i‡(
	`IS_ENABLED
(
CONFIG_IPV6
) &&

312 
	`ùv6_chk_addr
(
√t
, &
addr_ö6
->
sö6_addr
, 
dev
, 1))

313  
åue
;

317  
Ál£
;

318 
	}
}

327 
√t_devi˚
 *
	$ùoib_gë_ma°î_√t_dev
(
√t_devi˚
 *
dev
)

329 
√t_devi˚
 *
ma°î
;

331 
	`rcu_ªad_lock
();

332 
ma°î
 = 
	`√tdev_ma°î_uµî_dev_gë_rcu
(
dev
);

333 i‡(
ma°î
)

334 
	`dev_hﬁd
(
ma°î
);

335 
	`rcu_ªad_u∆ock
();

337 i‡(
ma°î
)

338  
ma°î
;

340 
	`dev_hﬁd
(
dev
);

341  
dev
;

342 
	}
}

344 
	sùoib_wÆk_d©a
 {

345 c⁄° 
sockaddr
 *
	maddr
;

346 
√t_devi˚
 *
	mªsu…
;

349 
	$ùoib_uµî_wÆk
(
√t_devi˚
 *
uµî
, *
_d©a
)

351 
ùoib_wÆk_d©a
 *
d©a
 = 
_d©a
;

352 
ªt
 = 0;

354 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
d©a
->
addr
, 
uµî
)) {

355 
	`dev_hﬁd
(
uµî
);

356 
d©a
->
ªsu…
 = 
uµî
;

357 
ªt
 = 1;

360  
ªt
;

361 
	}
}

372 
√t_devi˚
 *
	$ùoib_gë_√t_dev_m©ch_addr
(

373 c⁄° 
sockaddr
 *
addr
, 
√t_devi˚
 *
dev
)

375 
ùoib_wÆk_d©a
 
d©a
 = {

376 .
addr
 =áddr,

379 
	`rcu_ªad_lock
();

380 i‡(
	`ùoib_is_dev_m©ch_addr_rcu
(
addr
, 
dev
)) {

381 
	`dev_hﬁd
(
dev
);

382 
d©a
.
ªsu…
 = 
dev
;

383 
out
;

386 
	`√tdev_wÆk_Æl_uµî_dev_rcu
(
dev
, 
ùoib_uµî_wÆk
, &
d©a
);

387 
out
:

388 
	`rcu_ªad_u∆ock
();

389  
d©a
.
ªsu…
;

390 
	}
}

397 
	$ùoib_m©ch_gid_pkey_addr
(
ùoib_dev_¥iv
 *
¥iv
,

398 c⁄° 
ib_gid
 *
gid
,

399 
u16
 
pkey_ödex
,

400 c⁄° 
sockaddr
 *
addr
,

401 
√°ög
,

402 
√t_devi˚
 **
found_√t_dev
)

404 
ùoib_dev_¥iv
 *
chûd_¥iv
;

405 
√t_devi˚
 *
√t_dev
 = 
NULL
;

406 
m©ches
 = 0;

408 i‡(
¥iv
->
pkey_ödex
 ==Ökey_index &&

409 (!
gid
 || !
	`memcmp
(gid, &
¥iv
->
loˇl_gid
, (*gid)))) {

410 i‡(!
addr
) {

411 
√t_dev
 = 
	`ùoib_gë_ma°î_√t_dev
(
¥iv
->
dev
);

415 
√t_dev
 = 
	`ùoib_gë_√t_dev_m©ch_addr
(
addr
, 
¥iv
->
dev
);

417 i‡(
√t_dev
) {

418 i‡(!*
found_√t_dev
)

419 *
found_√t_dev
 = 
√t_dev
;

421 
	`dev_put
(
√t_dev
);

422 ++
m©ches
;

427 
	`down_ªad_√°ed
(&
¥iv
->
vœn_rw£m
, 
√°ög
);

428 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
) {

429 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
chûd_¥iv
, 
gid
,

430 
pkey_ödex
, 
addr
,

431 
√°ög
 + 1,

432 
found_√t_dev
);

433 i‡(
m©ches
 > 1)

436 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

438  
m©ches
;

439 
	}
}

444 
	$__ùoib_gë_√t_dev_by_∑øms
(
li°_hód
 *
dev_li°
, 
u8
 
p‹t
,

445 
u16
 
pkey_ödex
,

446 c⁄° 
ib_gid
 *
gid
,

447 c⁄° 
sockaddr
 *
addr
,

448 
√t_devi˚
 **
√t_dev
)

450 
ùoib_dev_¥iv
 *
¥iv
;

451 
m©ches
 = 0;

453 *
√t_dev
 = 
NULL
;

455 
	`li°_f‹_óch_íåy
(
¥iv
, 
dev_li°
, 
li°
) {

456 i‡(
¥iv
->
p‹t
 !=Öort)

459 
m©ches
 +
	`ùoib_m©ch_gid_pkey_addr
(
¥iv
, 
gid
, 
pkey_ödex
,

460 
addr
, 0, 
√t_dev
);

461 i‡(
m©ches
 > 1)

465  
m©ches
;

466 
	}
}

468 
√t_devi˚
 *
	$ùoib_gë_√t_dev_by_∑øms
(

469 
ib_devi˚
 *
dev
, 
u8
 
p‹t
, 
u16
 
pkey
,

470 c⁄° 
ib_gid
 *
gid
, c⁄° 
sockaddr
 *
addr
,

471 *
˛õ¡_d©a
)

473 
√t_devi˚
 *
√t_dev
;

474 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

475 
u16
 
pkey_ödex
;

476 
m©ches
;

477 
ªt
;

479 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
dev
, 
p‹t
))

480  
NULL
;

482 
ªt
 = 
	`ib_föd_ˇched_pkey
(
dev
, 
p‹t
, 
pkey
, &
pkey_ödex
);

483 i‡(
ªt
)

484  
NULL
;

486 i‡(!
dev_li°
)

487  
NULL
;

490 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

491 
gid
, 
NULL
, &
√t_dev
);

493 
m©ches
) {

495  
NULL
;

497  
√t_dev
;

500 
	`dev_put
(
√t_dev
);

504 
m©ches
 = 
	`__ùoib_gë_√t_dev_by_∑øms
(
dev_li°
, 
p‹t
, 
pkey_ödex
,

505 
gid
, 
addr
, &
√t_dev
);

506 
m©ches
) {

508  
NULL
;

510 
	`dev_w¨n_øãlimôed
(&
dev
->dev,

514  
√t_dev
;

516 
	}
}

518 
	$ùoib_£t_mode
(
√t_devi˚
 *
dev
, c⁄° *
buf
)

520 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

522 i‡((
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

523 !
	`°rcmp
(
buf
, "connected\n")) ||

524 (!
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
) &&

525 !
	`°rcmp
(
buf
, "datagram\n"))) {

530 i‡(
	`IPOIB_CM_SUPPORTED
(
dev
->
dev_addr
Ë&& !
	`°rcmp
(
buf
, "connected\n")) {

531 
	`£t_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

532 
	`ùoib_w¨n
(
¥iv
, "enabling connected mode "

534 
	`√tdev_upd©e_„©uªs
(
dev
);

535 
	`dev_£t_mtu
(
dev
, 
	`ùoib_cm_max_mtu
(dev));

536 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, 1);

537 
	`π∆_u∆ock
();

538 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 &~
IB_SEND_IP_CSUM
;

540 
	`ùoib_Êush_∑ths
(
dev
);

541  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

544 i‡(!
	`°rcmp
(
buf
, "datagram\n")) {

545 
	`˛ór_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

546 
	`√tdev_upd©e_„©uªs
(
dev
);

547 
	`dev_£t_mtu
(
dev
, 
	`mö
(
¥iv
->
mˇ°_mtu
, dev->
mtu
));

548 
	`√tif_£t_ªÆ_num_tx_queues
(
dev
, dev->
num_tx_queues
);

549 
	`π∆_u∆ock
();

550 
	`ùoib_Êush_∑ths
(
dev
);

551  (!
	`π∆_åylock
()Ë? -
EBUSY
 : 0;

554  -
EINVAL
;

555 
	}
}

557 
ùoib_∑th
 *
	$__∑th_föd
(
√t_devi˚
 *
dev
, *
gid
)

559 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

560 
rb_node
 *
n
 = 
¥iv
->
∑th_åì
.rb_node;

561 
ùoib_∑th
 *
∑th
;

562 
ªt
;

564 
n
) {

565 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

567 
ªt
 = 
	`memcmp
(
gid
, 
∑th
->
∑thªc
.
dgid
.
øw
,

568  (
ib_gid
));

570 i‡(
ªt
 < 0)

571 
n
 =Ç->
rb_À·
;

572 i‡(
ªt
 > 0)

573 
n
 =Ç->
rb_right
;

575  
∑th
;

578  
NULL
;

579 
	}
}

581 
	$__∑th_add
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

583 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

584 
rb_node
 **
n
 = &
¥iv
->
∑th_åì
.rb_node;

585 
rb_node
 *
≤
 = 
NULL
;

586 
ùoib_∑th
 *
ç©h
;

587 
ªt
;

589 *
n
) {

590 
≤
 = *
n
;

591 
ç©h
 = 
	`rb_íåy
(
≤
, 
ùoib_∑th
, 
rb_node
);

593 
ªt
 = 
	`memcmp
(
∑th
->
∑thªc
.
dgid
.
øw
, 
ç©h
->pathrec.dgid.raw,

594  (
ib_gid
));

595 i‡(
ªt
 < 0)

596 
n
 = &
≤
->
rb_À·
;

597 i‡(
ªt
 > 0)

598 
n
 = &
≤
->
rb_right
;

600  -
EEXIST
;

603 
	`rb_lök_node
(&
∑th
->
rb_node
, 
≤
, 
n
);

604 
	`rb_ö£π_cﬁ‹
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

606 
	`li°_add_èû
(&
∑th
->
li°
, &
¥iv
->
∑th_li°
);

609 
	}
}

611 
	$∑th_‰ì
(
√t_devi˚
 *
dev
, 
ùoib_∑th
 *
∑th
)

613 
sk_buff
 *
skb
;

615 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

616 
	`dev_k‰ì_skb_úq
(
skb
);

618 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
), "%s\n", 
__func__
);

621 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

623 i‡(
∑th
->
ah
)

624 
	`ùoib_put_ah
(
∑th
->
ah
);

626 
	`k‰ì
(
∑th
);

627 
	}
}

629 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


631 
ùoib_∑th_ôî
 *
	$ùoib_∑th_ôî_öô
(
√t_devi˚
 *
dev
)

633 
ùoib_∑th_ôî
 *
ôî
;

635 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

636 i‡(!
ôî
)

637  
NULL
;

639 
ôî
->
dev
 = dev;

640 
	`mem£t
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
, 0, 16);

642 i‡(
	`ùoib_∑th_ôî_√xt
(
ôî
)) {

643 
	`k‰ì
(
ôî
);

644  
NULL
;

647  
ôî
;

648 
	}
}

650 
	$ùoib_∑th_ôî_√xt
(
ùoib_∑th_ôî
 *
ôî
)

652 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

653 
rb_node
 *
n
;

654 
ùoib_∑th
 *
∑th
;

655 
ªt
 = 1;

657 
	`•ö_lock_úq
(&
¥iv
->
lock
);

659 
n
 = 
	`rb_fú°
(&
¥iv
->
∑th_åì
);

661 
n
) {

662 
∑th
 = 
	`rb_íåy
(
n
, 
ùoib_∑th
, 
rb_node
);

664 i‡(
	`memcmp
(
ôî
->
∑th
.
∑thªc
.
dgid
.
øw
,Öath->pathrec.dgid.raw,

665  (
ib_gid
)) < 0) {

666 
ôî
->
∑th
 = *path;

667 
ªt
 = 0;

671 
n
 = 
	`rb_√xt
(n);

674 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676  
ªt
;

677 
	}
}

679 
	$ùoib_∑th_ôî_ªad
(
ùoib_∑th_ôî
 *
ôî
,

680 
ùoib_∑th
 *
∑th
)

682 *
∑th
 = 
ôî
->path;

683 
	}
}

687 
	$ùoib_m¨k_∑ths_övÆid
(
√t_devi˚
 *
dev
)

689 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

690 
ùoib_∑th
 *
∑th
, *
ç
;

692 
	`•ö_lock_úq
(&
¥iv
->
lock
);

694 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
¥iv
->
∑th_li°
, 
li°
) {

695 
	`ùoib_dbg
(
¥iv
, "markÖath LID 0x%08x GID %pI6 invalid\n",

696 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)),

697 
∑th
->
∑thªc
.
dgid
.
øw
);

698 i‡(
∑th
->
ah
)

699 
∑th
->
ah
->
vÆid
 = 0;

702 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

703 
	}
}

705 
	$push_p£udo_hódî
(
sk_buff
 *
skb
, c⁄° *
daddr
)

707 
ùoib_p£udo_hódî
 *
phdr
;

709 
phdr
 = 
	`skb_push
(
skb
, (*phdr));

710 
	`mem˝y
(
phdr
->
hwaddr
, 
daddr
, 
INFINIBAND_ALEN
);

711 
	}
}

713 
	$ùoib_Êush_∑ths
(
√t_devi˚
 *
dev
)

715 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

716 
ùoib_∑th
 *
∑th
, *
ç
;

717 
	`LIST_HEAD
(
ªmove_li°
);

718 
Êags
;

720 
	`√tif_tx_lock_bh
(
dev
);

721 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

723 
	`li°_•li˚_öô
(&
¥iv
->
∑th_li°
, &
ªmove_li°
);

725 
	`li°_f‹_óch_íåy
(
∑th
, &
ªmove_li°
, 
li°
)

726 
	`rb_îa£
(&
∑th
->
rb_node
, &
¥iv
->
∑th_åì
);

728 
	`li°_f‹_óch_íåy_ß„
(
∑th
, 
ç
, &
ªmove_li°
, 
li°
) {

729 i‡(
∑th
->
quîy
)

730 
	`ib_ß_ˇn˚l_quîy
(
∑th
->
quîy_id
,Ö©h->
quîy
);

731 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

732 
	`√tif_tx_u∆ock_bh
(
dev
);

733 
	`waô_f‹_com∂ëi⁄
(&
∑th
->
d⁄e
);

734 
	`∑th_‰ì
(
dev
, 
∑th
);

735 
	`√tif_tx_lock_bh
(
dev
);

736 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

739 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

740 
	`√tif_tx_u∆ock_bh
(
dev
);

741 
	}
}

743 
	$∑th_ªc_com∂ëi⁄
(
°©us
,

744 
ß_∑th_ªc
 *
∑thªc
,

745 *
∑th_±r
)

747 
ùoib_∑th
 *
∑th
 = 
∑th_±r
;

748 
√t_devi˚
 *
dev
 = 
∑th
->dev;

749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

750 
ùoib_ah
 *
ah
 = 
NULL
;

751 
ùoib_ah
 *
ﬁd_ah
 = 
NULL
;

752 
ùoib_√igh
 *
√igh
, *
ä
;

753 
sk_buff_hód
 
skqueue
;

754 
sk_buff
 *
skb
;

755 
Êags
;

757 i‡(!
°©us
)

758 
	`ùoib_dbg
(
¥iv
, "PathRec LID 0x%04x for GID %pI6\n",

759 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

760 
∑thªc
->
dgid
.
øw
);

762 
	`ùoib_dbg
(
¥iv
, "PathRec status %d for GID %pI6\n",

763 
°©us
, 
∑th
->
∑thªc
.
dgid
.
øw
);

765 
	`skb_queue_hód_öô
(&
skqueue
);

767 i‡(!
°©us
) {

768 
rdma_ah_©å
 
av
;

770 i‡(!
	`ib_öô_ah_©å_‰om_∑th
(
¥iv
->
ˇ
,Öriv->
p‹t
,

771 
∑thªc
, &
av
, 
NULL
)) {

772 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

773 
	`rdma_de°roy_ah_©å
(&
av
);

777 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

779 i‡(!
	`IS_ERR_OR_NULL
(
ah
)) {

785 i‡(
	`memcmp
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

786 (
ib_gid
))) {

787 
	`ùoib_dbg
(

788 
¥iv
,

790 
dev
->
«me
, 
∑thªc
->
dgid
.
øw
,

791 
∑th
->
∑thªc
.
dgid
.
øw
);

792 
	`mem˝y
(
∑thªc
->
dgid
.
øw
, 
∑th
->pathrec.dgid.raw,

793 (
ib_gid
));

796 
∑th
->
∑thªc
 = *pathrec;

798 
ﬁd_ah
 = 
∑th
->
ah
;

799 
∑th
->
ah
 =áh;

801 
	`ùoib_dbg
(
¥iv
, "createdáddress handle %p for LID 0x%04x, SL %d\n",

802 
ah
, 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(
∑thªc
)),

803 
∑thªc
->
¶
);

805 (
skb
 = 
	`__skb_dequeue
(&
∑th
->
queue
)))

806 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

808 
	`li°_f‹_óch_íåy_ß„
(
√igh
, 
ä
, &
∑th
->
√igh_li°
, 
li°
) {

809 i‡(
√igh
->
ah
) {

810 
	`WARN_ON
(
√igh
->
ah
 !
ﬁd_ah
);

818 
	`ùoib_put_ah
(
√igh
->
ah
);

820 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

821 
√igh
->
ah
 = 
∑th
->ah;

823 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

824 i‡(!
	`ùoib_cm_gë
(
√igh
))

825 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
,

826 
∑th
,

827 
√igh
));

828 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

829 
	`ùoib_√igh_‰ì
(
√igh
);

834 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
)))

835 
	`__skb_queue_èû
(&
skqueue
, 
skb
);

837 
∑th
->
ah
->
vÆid
 = 1;

840 
∑th
->
quîy
 = 
NULL
;

841 
	`com∂ëe
(&
∑th
->
d⁄e
);

843 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 i‡(
	`IS_ERR_OR_NULL
(
ah
))

846 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
∑th
->
∑thªc
.
dgid
.
øw
);

848 i‡(
ﬁd_ah
)

849 
	`ùoib_put_ah
(
ﬁd_ah
);

851 (
skb
 = 
	`__skb_dequeue
(&
skqueue
))) {

852 
ªt
;

853 
skb
->
dev
 = dev;

854 
ªt
 = 
	`dev_queue_xmô
(
skb
);

855 i‡(
ªt
)

856 
	`ùoib_w¨n
(
¥iv
, "%s: dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

857 
__func__
, 
ªt
);

859 
	}
}

861 
	$öô_∑th_ªc
(
ùoib_dev_¥iv
 *
¥iv
, 
ùoib_∑th
 *
∑th
,

862 *
gid
)

864 
∑th
->
dev
 = 
¥iv
->dev;

866 i‡(
	`rdma_ˇp_›a_ah
(
¥iv
->
ˇ
,Öriv->
p‹t
))

867 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_OPA
;

869 
∑th
->
∑thªc
.
ªc_ty≥
 = 
SA_PATH_REC_TYPE_IB
;

871 
	`mem˝y
(
∑th
->
∑thªc
.
dgid
.
øw
, 
gid
, (
ib_gid
));

872 
∑th
->
∑thªc
.
sgid
 = 
¥iv
->
loˇl_gid
;

873 
∑th
->
∑thªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

874 
∑th
->
∑thªc
.
numb_∑th
 = 1;

875 
∑th
->
∑thªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

876 
	}
}

878 
ùoib_∑th
 *
	$∑th_ªc_¸óã
(
√t_devi˚
 *
dev
, *
gid
)

880 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

881 
ùoib_∑th
 *
∑th
;

883 i‡(!
¥iv
->
brﬂdˇ°
)

884  
NULL
;

886 
∑th
 = 
	`kzÆloc
((*∑th), 
GFP_ATOMIC
);

887 i‡(!
∑th
)

888  
NULL
;

890 
	`skb_queue_hód_öô
(&
∑th
->
queue
);

892 
	`INIT_LIST_HEAD
(&
∑th
->
√igh_li°
);

894 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
gid
);

896  
∑th
;

897 
	}
}

899 
	$∑th_ªc_°¨t
(
√t_devi˚
 *
dev
,

900 
ùoib_∑th
 *
∑th
)

902 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

904 
	`ùoib_dbg
(
¥iv
, "StartÖathÑecordÜookup for %pI6\n",

905 
∑th
->
∑thªc
.
dgid
.
øw
);

907 
	`öô_com∂ëi⁄
(&
∑th
->
d⁄e
);

909 
∑th
->
quîy_id
 =

910 
	`ib_ß_∑th_ªc_gë
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

911 &
∑th
->
∑thªc
,

912 
IB_SA_PATH_REC_DGID
 |

913 
IB_SA_PATH_REC_SGID
 |

914 
IB_SA_PATH_REC_NUMB_PATH
 |

915 
IB_SA_PATH_REC_TRAFFIC_CLASS
 |

916 
IB_SA_PATH_REC_PKEY
,

917 1000, 
GFP_ATOMIC
,

918 
∑th_ªc_com∂ëi⁄
,

919 
∑th
, &∑th->
quîy
);

920 i‡(
∑th
->
quîy_id
 < 0) {

921 
	`ùoib_w¨n
(
¥iv
, "ib_ß_∑th_ªc_gë faûed: %d\n", 
∑th
->
quîy_id
);

922 
∑th
->
quîy
 = 
NULL
;

923 
	`com∂ëe
(&
∑th
->
d⁄e
);

924  
∑th
->
quîy_id
;

928 
	}
}

930 
	$√igh_ª‰esh_∑th
(
ùoib_√igh
 *
√igh
, 
u8
 *
daddr
,

931 
√t_devi˚
 *
dev
)

933 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

934 
ùoib_∑th
 *
∑th
;

935 
Êags
;

937 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

939 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

940 i‡(!
∑th
)

941 
out
;

942 i‡(!
∑th
->
quîy
)

943 
	`∑th_ªc_°¨t
(
dev
, 
∑th
);

944 
out
:

945 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

946 
	}
}

948 
ùoib_√igh
 *
	$√igh_add_∑th
(
sk_buff
 *
skb
, 
u8
 *
daddr
,

949 
√t_devi˚
 *
dev
)

951 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

952 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

953 
ùoib_∑th
 *
∑th
;

954 
ùoib_√igh
 *
√igh
;

955 
Êags
;

957 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

958 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

959 i‡(!
√igh
) {

960 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

961 ++
dev
->
°©s
.
tx_dr›≥d
;

962 
	`dev_k‰ì_skb_™y
(
skb
);

963  
NULL
;

969 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
√igh
->
li°
))) {

970 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

971  
√igh
;

974 
∑th
 = 
	`__∑th_föd
(
dev
, 
daddr
 + 4);

975 i‡(!
∑th
) {

976 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
daddr
 + 4);

977 i‡(!
∑th
)

978 
îr_∑th
;

980 
	`__∑th_add
(
dev
, 
∑th
);

983 
	`li°_add_èû
(&
√igh
->
li°
, &
∑th
->
√igh_li°
);

985 i‡(
∑th
->
ah
 &&Ö©h->ah->
vÆid
) {

986 
	`kªf_gë
(&
∑th
->
ah
->
ªf
);

987 
√igh
->
ah
 = 
∑th
->ah;

989 i‡(
	`ùoib_cm_íabÀd
(
dev
, 
√igh
->
daddr
)) {

990 i‡(!
	`ùoib_cm_gë
(
√igh
))

991 
	`ùoib_cm_£t
(
√igh
, 
	`ùoib_cm_¸óã_tx
(
dev
, 
∑th
,Çeigh));

992 i‡(!
	`ùoib_cm_gë
(
√igh
)) {

993 
	`ùoib_√igh_‰ì
(
√igh
);

994 
îr_dr›
;

996 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
) <

997 
IPOIB_MAX_PATH_REC_QUEUE
) {

998 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

999 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1001 
	`ùoib_w¨n
(
¥iv
, "queueÜengthÜimit %d. Packet drop.\n",

1002 
	`skb_queue_Àn
(&
√igh
->
queue
));

1003 
îr_dr›
;

1006 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1007 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1008 
	`IPOIB_QPN
(
daddr
));

1009 
	`ùoib_√igh_put
(
√igh
);

1010  
NULL
;

1013 
√igh
->
ah
 = 
NULL
;

1015 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath))

1016 
îr_∑th
;

1017 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1018 
	`push_p£udo_hódî
(
skb
, 
√igh
->
daddr
);

1019 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1021 
îr_dr›
;

1025 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1026 
	`ùoib_√igh_put
(
√igh
);

1027  
NULL
;

1029 
îr_∑th
:

1030 
	`ùoib_√igh_‰ì
(
√igh
);

1031 
îr_dr›
:

1032 ++
dev
->
°©s
.
tx_dr›≥d
;

1033 
	`dev_k‰ì_skb_™y
(
skb
);

1035 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1036 
	`ùoib_√igh_put
(
√igh
);

1038  
NULL
;

1039 
	}
}

1041 
	$uniˇ°_¨p_£nd
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
,

1042 
ùoib_p£udo_hódî
 *
phdr
)

1044 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1045 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1046 
ùoib_∑th
 *
∑th
;

1047 
Êags
;

1049 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1052 i‡(!
¥iv
->
brﬂdˇ°
)

1053 
dr›_™d_u∆ock
;

1055 
∑th
 = 
	`__∑th_föd
(
dev
, 
phdr
->
hwaddr
 + 4);

1056 i‡(!
∑th
 || !∑th->
ah
 || !∑th->ah->
vÆid
) {

1057 i‡(!
∑th
) {

1058 
∑th
 = 
	`∑th_ªc_¸óã
(
dev
, 
phdr
->
hwaddr
 + 4);

1059 i‡(!
∑th
)

1060 
dr›_™d_u∆ock
;

1061 
	`__∑th_add
(
dev
, 
∑th
);

1067 
	`öô_∑th_ªc
(
¥iv
, 
∑th
, 
phdr
->
hwaddr
 + 4);

1069 i‡(!
∑th
->
quîy
 && 
	`∑th_ªc_°¨t
(
dev
,Öath)) {

1070 
dr›_™d_u∆ock
;

1073 i‡(
	`skb_queue_Àn
(&
∑th
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1074 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1075 
	`__skb_queue_èû
(&
∑th
->
queue
, 
skb
);

1076 
u∆ock
;

1078 
dr›_™d_u∆ock
;

1082 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1083 
	`ùoib_dbg
(
¥iv
, "Send unicast ARPÅo %08x\n",

1084 
	`be32_to_˝u
(
	`ß_∑th_gë_dlid
(&
∑th
->
∑thªc
)));

1085 
∑th
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Öath->ah->ah,

1086 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1089 
dr›_™d_u∆ock
:

1090 ++
dev
->
°©s
.
tx_dr›≥d
;

1091 
	`dev_k‰ì_skb_™y
(
skb
);

1092 
u∆ock
:

1093 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1094 
	}
}

1096 
√tdev_tx_t
 
	$ùoib_°¨t_xmô
(
sk_buff
 *
skb
, 
√t_devi˚
 *
dev
)

1098 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1099 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

1100 
ùoib_√igh
 *
√igh
;

1101 
ùoib_p£udo_hódî
 *
phdr
;

1102 
ùoib_hódî
 *
hódî
;

1103 
Êags
;

1105 
phdr
 = (
ùoib_p£udo_hódî
 *Ë
skb
->
d©a
;

1106 
	`skb_puŒ
(
skb
, (*
phdr
));

1107 
hódî
 = (
ùoib_hódî
 *Ë
skb
->
d©a
;

1109 i‡(
	`u∆ikñy
(
phdr
->
hwaddr
[4] == 0xff)) {

1111 i‡((
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IP
)) &&

1112 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_IPV6
)) &&

1113 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_ARP
)) &&

1114 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_RARP
)) &&

1115 (
hódî
->
¥Ÿo
 !
	`ht⁄s
(
ETH_P_TIPC
))) {

1117 ++
dev
->
°©s
.
tx_dr›≥d
;

1118 
	`dev_k‰ì_skb_™y
(
skb
);

1119  
NETDEV_TX_OK
;

1122 
phdr
->
hwaddr
[8] = (
¥iv
->
pkey
 >> 8) & 0xff;

1123 
phdr
->
hwaddr
[9] = 
¥iv
->
pkey
 & 0xff;

1125 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1126 i‡(
	`likñy
(
√igh
))

1127 
£nd_usög_√igh
;

1128 
	`ùoib_mˇ°_£nd
(
dev
, 
phdr
->
hwaddr
, 
skb
);

1129  
NETDEV_TX_OK
;

1133 
hódî
->
¥Ÿo
) {

1134 
	`ht⁄s
(
ETH_P_IP
):

1135 
	`ht⁄s
(
ETH_P_IPV6
):

1136 
	`ht⁄s
(
ETH_P_TIPC
):

1137 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
phdr
->
hwaddr
);

1138 i‡(
	`u∆ikñy
(!
√igh
)) {

1139 
√igh
 = 
	`√igh_add_∑th
(
skb
, 
phdr
->
hwaddr
, 
dev
);

1140 i‡(
	`likñy
(!
√igh
))

1141  
NETDEV_TX_OK
;

1144 
	`ht⁄s
(
ETH_P_ARP
):

1145 
	`ht⁄s
(
ETH_P_RARP
):

1147 
	`uniˇ°_¨p_£nd
(
skb
, 
dev
, 
phdr
);

1148  
NETDEV_TX_OK
;

1151 ++
dev
->
°©s
.
tx_dr›≥d
;

1152 
	`dev_k‰ì_skb_™y
(
skb
);

1153  
NETDEV_TX_OK
;

1156 
£nd_usög_√igh
:

1158 i‡(
	`ùoib_cm_gë
(
√igh
)) {

1159 i‡(
	`ùoib_cm_up
(
√igh
)) {

1160 
	`ùoib_cm_£nd
(
dev
, 
skb
, 
	`ùoib_cm_gë
(
√igh
));

1161 
uƒef
;

1163 } i‡(
√igh
->
ah
 &&Çeigh->ah->
vÆid
) {

1164 
√igh
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
,Çeigh->ah->ah,

1165 
	`IPOIB_QPN
(
phdr
->
hwaddr
));

1166 
uƒef
;

1167 } i‡(
√igh
->
ah
) {

1168 
	`√igh_ª‰esh_∑th
(
√igh
, 
phdr
->
hwaddr
, 
dev
);

1171 i‡(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
) {

1172 
	`push_p£udo_hódî
(
skb
, 
phdr
->
hwaddr
);

1173 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1174 
	`__skb_queue_èû
(&
√igh
->
queue
, 
skb
);

1175 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1177 ++
dev
->
°©s
.
tx_dr›≥d
;

1178 
	`dev_k‰ì_skb_™y
(
skb
);

1181 
uƒef
:

1182 
	`ùoib_√igh_put
(
√igh
);

1184  
NETDEV_TX_OK
;

1185 
	}
}

1187 
	$ùoib_timeout
(
√t_devi˚
 *
dev
)

1189 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1191 
	`ùoib_w¨n
(
¥iv
, "transmitÅimeout:Üatency %d msecs\n",

1192 
	`jiffõs_to_m£cs
(
jiffõs
 - 
	`dev_å™s_°¨t
(
dev
)));

1193 
	`ùoib_w¨n
(
¥iv
, "queue stopped %d,Åx_head %u,Åx_tail %u\n",

1194 
	`√tif_queue_°›≥d
(
dev
),

1195 
¥iv
->
tx_hód
,Öriv->
tx_èû
);

1197 
	}
}

1199 
	$ùoib_h¨d_hódî
(
sk_buff
 *
skb
,

1200 
√t_devi˚
 *
dev
,

1201 
ty≥
,

1202 c⁄° *
daddr
,

1203 c⁄° *
ßddr
,

1204 
Àn
)

1206 
ùoib_hódî
 *
hódî
;

1208 
hódî
 = 
	`skb_push
(
skb
, (*header));

1210 
hódî
->
¥Ÿo
 = 
	`ht⁄s
(
ty≥
);

1211 
hódî
->
ª£rved
 = 0;

1218 
	`push_p£udo_hódî
(
skb
, 
daddr
);

1220  
IPOIB_HARD_LEN
;

1221 
	}
}

1223 
	$ùoib_£t_mˇ°_li°
(
√t_devi˚
 *
dev
)

1225 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1227 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

1228 
	`ùoib_dbg
(
¥iv
, "IPOIB_FLAG_OPER_UPÇot set");

1232 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ª°¨t_èsk
);

1233 
	}
}

1235 
	$ùoib_gë_iÊök
(c⁄° 
√t_devi˚
 *
dev
)

1237 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1240 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
))

1241  
dev
->
ifödex
;

1244  
¥iv
->
∑ª¡
->
ifödex
;

1245 
	}
}

1247 
u32
 
	$ùoib_addr_hash
(
ùoib_√igh_hash
 *
htbl
, 
u8
 *
daddr
)

1256 
u32
 *
d32
 = (u32 *Ë
daddr
;

1257 
u32
 
hv
;

1259 
hv
 = 
	`jhash_3w‹ds
(
d32
[3], d32[4], 
IPOIB_QPN_MASK
 & d32[0], 0);

1260  
hv
 & 
htbl
->
mask
;

1261 
	}
}

1263 
ùoib_√igh
 *
	$ùoib_√igh_gë
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
)

1265 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1266 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1267 
ùoib_√igh_hash
 *
htbl
;

1268 
ùoib_√igh
 *
√igh
 = 
NULL
;

1269 
u32
 
hash_vÆ
;

1271 
	`rcu_ªad_lock_bh
();

1273 
htbl
 = 
	`rcu_dîe„ªn˚_bh
(
¡bl
->htbl);

1275 i‡(!
htbl
)

1276 
out_u∆ock
;

1278 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1279 
√igh
 = 
	`rcu_dîe„ªn˚_bh
(
htbl
->
buckës
[
hash_vÆ
]);

1280 
√igh
 !
NULL
;

1281 
√igh
 = 
	`rcu_dîe„ªn˚_bh
“eigh->
h√xt
)) {

1282 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1284 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1286 
√igh
 = 
NULL
;

1287 
out_u∆ock
;

1290 i‡(
	`likñy
(
	`skb_queue_Àn
(&
√igh
->
queue
Ë< 
IPOIB_MAX_PATH_REC_QUEUE
))

1291 
√igh
->
Æive
 = 
jiffõs
;

1292 
out_u∆ock
;

1296 
out_u∆ock
:

1297 
	`rcu_ªad_u∆ock_bh
();

1298  
√igh
;

1299 
	}
}

1301 
	$__ùoib_ª≠_√igh
(
ùoib_dev_¥iv
 *
¥iv
)

1303 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1304 
ùoib_√igh_hash
 *
htbl
;

1305 
√igh_obsﬁëe
;

1306 
dt
;

1307 
Êags
;

1308 
i
;

1309 
	`LIST_HEAD
(
ªmove_li°
);

1311 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1313 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1314 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1316 i‡(!
htbl
)

1317 
out_u∆ock
;

1320 
dt
 = 2 * 
¨p_tbl
.
gc_öãrvÆ
;

1321 
√igh_obsﬁëe
 = 
jiffõs
 - 
dt
;

1323 
i
 = 0; i < 
htbl
->
size
; i++) {

1324 
ùoib_√igh
 *
√igh
;

1325 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1327 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1328 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1330 i‡(
	`time_a·î
(
√igh_obsﬁëe
, 
√igh
->
Æive
)) {

1332 
	`ùoib_check_™d_add_mˇ°_£nd⁄ly
(
¥iv
, 
√igh
->
daddr
 + 4, &
ªmove_li°
);

1334 
	`rcu_assign_poöãr
(*
≈
,

1335 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1336 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1338 
	`li°_dñ_öô
(&
√igh
->
li°
);

1339 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1341 
≈
 = &
√igh
->
h√xt
;

1347 
out_u∆ock
:

1348 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1349 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

1350 
	}
}

1352 
	$ùoib_ª≠_√igh
(
w‹k_°ru˘
 *
w‹k
)

1354 
ùoib_dev_¥iv
 *
¥iv
 =

1355 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
√igh_ª≠_èsk
.work);

1357 
	`__ùoib_ª≠_√igh
(
¥iv
);

1359 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1360 
¨p_tbl
.
gc_öãrvÆ
);

1361 
	}
}

1364 
ùoib_√igh
 *
	$ùoib_√igh_˘‹
(
u8
 *
daddr
,

1365 
√t_devi˚
 *
dev
)

1367 
ùoib_√igh
 *
√igh
;

1369 
√igh
 = 
	`kzÆloc
((*√igh), 
GFP_ATOMIC
);

1370 i‡(!
√igh
)

1371  
NULL
;

1373 
√igh
->
dev
 = dev;

1374 
	`mem˝y
(&
√igh
->
daddr
, daddr, (neigh->daddr));

1375 
	`skb_queue_hód_öô
(&
√igh
->
queue
);

1376 
	`INIT_LIST_HEAD
(&
√igh
->
li°
);

1377 
	`ùoib_cm_£t
(
√igh
, 
NULL
);

1379 
	`©omic_£t
(&
√igh
->
ªf˙t
, 1);

1381  
√igh
;

1382 
	}
}

1384 
ùoib_√igh
 *
	$ùoib_√igh_Æloc
(
u8
 *
daddr
,

1385 
√t_devi˚
 *
dev
)

1387 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1388 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1389 
ùoib_√igh_hash
 *
htbl
;

1390 
ùoib_√igh
 *
√igh
;

1391 
u32
 
hash_vÆ
;

1393 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1394 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1395 i‡(!
htbl
) {

1396 
√igh
 = 
NULL
;

1397 
out_u∆ock
;

1403 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
daddr
);

1404 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1405 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1406 
√igh
 !
NULL
;

1407 
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
“eigh->
h√xt
,

1408 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1409 i‡(
	`memcmp
(
daddr
, 
√igh
->daddr, 
INFINIBAND_ALEN
) == 0) {

1411 i‡(!
	`©omic_öc_nŸ_zîo
(&
√igh
->
ªf˙t
)) {

1413 
√igh
 = 
NULL
;

1416 
√igh
->
Æive
 = 
jiffõs
;

1417 
out_u∆ock
;

1421 
√igh
 = 
	`ùoib_√igh_˘‹
(
daddr
, 
dev
);

1422 i‡(!
√igh
)

1423 
out_u∆ock
;

1426 
	`©omic_öc
(&
√igh
->
ªf˙t
);

1427 
√igh
->
Æive
 = 
jiffõs
;

1429 
	`rcu_assign_poöãr
(
√igh
->
h√xt
,

1430 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
htbl
->
buckës
[
hash_vÆ
],

1431 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1432 
	`rcu_assign_poöãr
(
htbl
->
buckës
[
hash_vÆ
], 
√igh
);

1433 
	`©omic_öc
(&
¡bl
->
íåõs
);

1435 
out_u∆ock
:

1437  
√igh
;

1438 
	}
}

1440 
	$ùoib_√igh_dt‹
(
ùoib_√igh
 *
√igh
)

1443 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1444 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1445 
sk_buff
 *
skb
;

1446 i‡(
√igh
->
ah
)

1447 
	`ùoib_put_ah
(
√igh
->
ah
);

1448 (
skb
 = 
	`__skb_dequeue
(&
√igh
->
queue
))) {

1449 ++
dev
->
°©s
.
tx_dr›≥d
;

1450 
	`dev_k‰ì_skb_™y
(
skb
);

1452 i‡(
	`ùoib_cm_gë
(
√igh
))

1453 
	`ùoib_cm_de°roy_tx
(
	`ùoib_cm_gë
(
√igh
));

1454 
	`ùoib_dbg
(
	`ùoib_¥iv
(
dev
),

1456 
	`IPOIB_QPN
(
√igh
->
daddr
),

1457 
√igh
->
daddr
 + 4);

1458 
	`k‰ì
(
√igh
);

1459 i‡(
	`©omic_dec_™d_ã°
(&
¥iv
->
¡bl
.
íåõs
)) {

1460 i‡(
	`ã°_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
))

1461 
	`com∂ëe
(&
¥iv
->
¡bl
.
Êushed
);

1463 
	}
}

1465 
	$ùoib_√igh_ª˛aim
(
rcu_hód
 *
Ω
)

1468 
ùoib_√igh
 *
√igh
 = 
	`c⁄èöî_of
(
Ω
, ùoib_√igh, 
rcu
);

1470 
	`ùoib_√igh_put
(
√igh
);

1471 
	}
}

1473 
	$ùoib_√igh_‰ì
(
ùoib_√igh
 *
√igh
)

1475 
√t_devi˚
 *
dev
 = 
√igh
->dev;

1476 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1477 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1478 
ùoib_√igh_hash
 *
htbl
;

1479 
ùoib_√igh
 
__rcu
 **
≈
;

1480 
ùoib_√igh
 *
n
;

1481 
u32
 
hash_vÆ
;

1483 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1484 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1485 i‡(!
htbl
)

1488 
hash_vÆ
 = 
	`ùoib_addr_hash
(
htbl
, 
√igh
->
daddr
);

1489 
≈
 = &
htbl
->
buckës
[
hash_vÆ
];

1490 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1491 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1492 
n
 !
NULL
;

1493 
n
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1494 
	`lockdï_is_hñd
(&
¥iv
->
lock
))) {

1495 i‡(
n
 =
√igh
) {

1497 
	`rcu_assign_poöãr
(*
≈
,

1498 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1499 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1501 
	`li°_dñ_öô
(&
√igh
->
li°
);

1502 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1505 
≈
 = &
n
->
h√xt
;

1508 
	}
}

1510 
	$ùoib_√igh_hash_öô
(
ùoib_dev_¥iv
 *
¥iv
)

1512 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1513 
ùoib_√igh_hash
 *
htbl
;

1514 
ùoib_√igh
 
__rcu
 **
buckës
;

1515 
u32
 
size
;

1517 
	`˛ór_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1518 
¡bl
->
htbl
 = 
NULL
;

1519 
htbl
 = 
	`kzÆloc
((*htbl), 
GFP_KERNEL
);

1520 i‡(!
htbl
)

1521  -
ENOMEM
;

1522 
size
 = 
	`roundup_pow_of_two
(
¨p_tbl
.
gc_thªsh3
);

1523 
buckës
 = 
	`kvˇŒoc
(
size
, (*buckës), 
GFP_KERNEL
);

1524 i‡(!
buckës
) {

1525 
	`k‰ì
(
htbl
);

1526  -
ENOMEM
;

1528 
htbl
->
size
 = size;

1529 
htbl
->
mask
 = (
size
 - 1);

1530 
htbl
->
buckës
 = buckets;

1531 
	`RCU_INIT_POINTER
(
¡bl
->
htbl
, htbl);

1532 
htbl
->
¡bl
 =Çtbl;

1533 
	`©omic_£t
(&
¡bl
->
íåõs
, 0);

1536 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
√igh_ª≠_èsk
,

1537 
¨p_tbl
.
gc_öãrvÆ
);

1540 
	}
}

1542 
	$√igh_hash_‰ì_rcu
(
rcu_hód
 *
hód
)

1544 
ùoib_√igh_hash
 *
htbl
 = 
	`c⁄èöî_of
(
hód
,

1545 
ùoib_√igh_hash
,

1546 
rcu
);

1547 
ùoib_√igh
 
__rcu
 **
buckës
 = 
htbl
->buckets;

1548 
ùoib_√igh_èbÀ
 *
¡bl
 = 
htbl
->ntbl;

1550 
	`kv‰ì
(
buckës
);

1551 
	`k‰ì
(
htbl
);

1552 
	`com∂ëe
(&
¡bl
->
dñëed
);

1553 
	}
}

1555 
	$ùoib_dñ_√ighs_by_gid
(
√t_devi˚
 *
dev
, 
u8
 *
gid
)

1557 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1558 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1559 
ùoib_√igh_hash
 *
htbl
;

1560 
Êags
;

1561 
i
;

1564 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1566 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1567 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1569 i‡(!
htbl
)

1570 
out_u∆ock
;

1572 
i
 = 0; i < 
htbl
->
size
; i++) {

1573 
ùoib_√igh
 *
√igh
;

1574 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1576 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1577 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1579 i‡(!
	`memcmp
(
gid
, 
√igh
->
daddr
 + 4,  (
ib_gid
))) {

1580 
	`rcu_assign_poöãr
(*
≈
,

1581 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1582 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1584 
	`li°_dñ_öô
(&
√igh
->
li°
);

1585 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1587 
≈
 = &
√igh
->
h√xt
;

1592 
out_u∆ock
:

1593 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1594 
	}
}

1596 
	$ùoib_Êush_√ighs
(
ùoib_dev_¥iv
 *
¥iv
)

1598 
ùoib_√igh_èbÀ
 *
¡bl
 = &
¥iv
->ntbl;

1599 
ùoib_√igh_hash
 *
htbl
;

1600 
Êags
;

1601 
i
, 
waô_Êushed
 = 0;

1603 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1604 
	`£t_bô
(
IPOIB_NEIGH_TBL_FLUSH
, &
¥iv
->
Êags
);

1606 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

1608 
htbl
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
¡bl
->htbl,

1609 
	`lockdï_is_hñd
(&
¥iv
->
lock
));

1610 i‡(!
htbl
)

1611 
out_u∆ock
;

1613 
waô_Êushed
 = 
	`©omic_ªad
(&
¥iv
->
¡bl
.
íåõs
);

1614 i‡(!
waô_Êushed
)

1615 
‰ì_htbl
;

1617 
i
 = 0; i < 
htbl
->
size
; i++) {

1618 
ùoib_√igh
 *
√igh
;

1619 
ùoib_√igh
 
__rcu
 **
≈
 = &
htbl
->
buckës
[
i
];

1621 (
√igh
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(*
≈
,

1622 
	`lockdï_is_hñd
(&
¥iv
->
lock
))Ë!
NULL
) {

1623 
	`rcu_assign_poöãr
(*
≈
,

1624 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
√igh
->
h√xt
,

1625 
	`lockdï_is_hñd
(&
¥iv
->
lock
)));

1627 
	`li°_dñ_öô
(&
√igh
->
li°
);

1628 
	`ˇŒ_rcu
(&
√igh
->
rcu
, 
ùoib_√igh_ª˛aim
);

1632 
‰ì_htbl
:

1633 
	`rcu_assign_poöãr
(
¡bl
->
htbl
, 
NULL
);

1634 
	`ˇŒ_rcu
(&
htbl
->
rcu
, 
√igh_hash_‰ì_rcu
);

1636 
out_u∆ock
:

1637 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

1638 i‡(
waô_Êushed
)

1639 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
Êushed
);

1640 
	}
}

1642 
	$ùoib_√igh_hash_unöô
(
√t_devi˚
 *
dev
)

1644 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1646 
	`ùoib_dbg
(
¥iv
, "%s\n", 
__func__
);

1647 
	`öô_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1649 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
√igh_ª≠_èsk
);

1651 
	`ùoib_Êush_√ighs
(
¥iv
);

1653 
	`waô_f‹_com∂ëi⁄
(&
¥iv
->
¡bl
.
dñëed
);

1654 
	}
}

1656 
	$ùoib_«pi_add
(
√t_devi˚
 *
dev
)

1658 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1660 
	`√tif_«pi_add
(
dev
, &
¥iv
->
ªcv_«pi
, 
ùoib_rx_pﬁl
, 
IPOIB_NUM_WC
);

1661 
	`√tif_«pi_add
(
dev
, &
¥iv
->
£nd_«pi
, 
ùoib_tx_pﬁl
, 
MAX_SEND_CQE
);

1662 
	}
}

1664 
	$ùoib_«pi_dñ
(
√t_devi˚
 *
dev
)

1666 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1668 
	`√tif_«pi_dñ
(&
¥iv
->
ªcv_«pi
);

1669 
	`√tif_«pi_dñ
(&
¥iv
->
£nd_«pi
);

1670 
	}
}

1672 
	$ùoib_dev_unöô_deÁu…
(
√t_devi˚
 *
dev
)

1674 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1676 
	`ùoib_å™•‹t_dev_˛ónup
(
dev
);

1678 
	`ùoib_«pi_dñ
(
dev
);

1680 
	`ùoib_cm_dev_˛ónup
(
dev
);

1682 
	`k‰ì
(
¥iv
->
rx_rög
);

1683 
	`v‰ì
(
¥iv
->
tx_rög
);

1685 
¥iv
->
rx_rög
 = 
NULL
;

1686 
¥iv
->
tx_rög
 = 
NULL
;

1687 
	}
}

1689 
	$ùoib_dev_öô_deÁu…
(
√t_devi˚
 *
dev
)

1691 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1693 
	`ùoib_«pi_add
(
dev
);

1696 
¥iv
->
rx_rög
 = 
	`kˇŒoc
(
ùoib_ªcvq_size
,

1697 (*
¥iv
->
rx_rög
),

1698 
GFP_KERNEL
);

1699 i‡(!
¥iv
->
rx_rög
)

1700 
out
;

1702 
¥iv
->
tx_rög
 = 
	`vzÆloc
(
	`¨øy_size
(
ùoib_£ndq_size
,

1703 (*
¥iv
->
tx_rög
)));

1704 i‡(!
¥iv
->
tx_rög
) {

1705 
	`¥_w¨n
("%s: failedÅoállocate TXÑing (%dÉntries)\n",

1706 
¥iv
->
ˇ
->
«me
, 
ùoib_£ndq_size
);

1707 
out_rx_rög_˛ónup
;

1712 i‡(
	`ùoib_å™•‹t_dev_öô
(
dev
, 
¥iv
->
ˇ
)) {

1713 
	`¥_w¨n
("%s: ipoib_transport_dev_init failed\n",

1714 
¥iv
->
ˇ
->
«me
);

1715 
out_tx_rög_˛ónup
;

1719 
¥iv
->
dev
->
dev_addr
[1] = (¥iv->
qp
->
qp_num
 >> 16) & 0xff;

1720 
¥iv
->
dev
->
dev_addr
[2] = (¥iv->
qp
->
qp_num
 >> 8) & 0xff;

1721 
¥iv
->
dev
->
dev_addr
[3] = (¥iv->
qp
->
qp_num
) & 0xff;

1725 
out_tx_rög_˛ónup
:

1726 
	`v‰ì
(
¥iv
->
tx_rög
);

1728 
out_rx_rög_˛ónup
:

1729 
	`k‰ì
(
¥iv
->
rx_rög
);

1731 
out
:

1732 
	`ùoib_«pi_dñ
(
dev
);

1733  -
ENOMEM
;

1734 
	}
}

1736 
	$ùoib_io˘l
(
√t_devi˚
 *
dev
, 
i‰eq
 *
i‰
,

1737 
cmd
)

1739 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1741 i‡(!
¥iv
->
∫_›s
->
ndo_do_io˘l
)

1742  -
EOPNOTSUPP
;

1744  
¥iv
->
∫_›s
->
	`ndo_do_io˘l
(
dev
, 
i‰
, 
cmd
);

1745 
	}
}

1747 
	$ùoib_dev_öô
(
√t_devi˚
 *
dev
)

1749 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1750 
ªt
 = -
ENOMEM
;

1752 
¥iv
->
qp
 = 
NULL
;

1758 
¥iv
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("ùoib_wq", 
WQ_MEM_RECLAIM
);

1759 i‡(!
¥iv
->
wq
) {

1760 
	`¥_w¨n
("%s: faûedÅÿÆloˇã devi˚ WQ\n", 
dev
->
«me
);

1761 
out
;

1765 
¥iv
->
pd
 = 
	`ib_Æloc_pd
’riv->
ˇ
, 0);

1766 i‡(
	`IS_ERR
(
¥iv
->
pd
)) {

1767 
	`¥_w¨n
("%s: faûedÅÿÆloˇã PD\n", 
¥iv
->
ˇ
->
«me
);

1768 
˛ón_wq
;

1771 
ªt
 = 
¥iv
->
∫_›s
->
	`ndo_öô
(
dev
);

1772 i‡(
ªt
) {

1773 
	`¥_w¨n
("%†ÁûedÅÿöô HWÑesour˚\n", 
dev
->
«me
);

1774 
out_‰ì_pd
;

1777 
ªt
 = 
	`ùoib_√igh_hash_öô
(
¥iv
);

1778 i‡(
ªt
) {

1779 
	`¥_w¨n
("%†ÁûedÅÿöôÇeigh hash\n", 
dev
->
«me
);

1780 
out_dev_unöô
;

1783 i‡(
dev
->
Êags
 & 
IFF_UP
) {

1784 i‡(
	`ùoib_ib_dev_›í
(
dev
)) {

1785 
	`¥_w¨n
("%†ÁûedÅÿ›í devi˚\n", 
dev
->
«me
);

1786 
ªt
 = -
ENODEV
;

1787 
out_hash_unöô
;

1793 
out_hash_unöô
:

1794 
	`ùoib_√igh_hash_unöô
(
dev
);

1796 
out_dev_unöô
:

1797 
	`ùoib_ib_dev_˛ónup
(
dev
);

1799 
out_‰ì_pd
:

1800 i‡(
¥iv
->
pd
) {

1801 
	`ib_dóŒoc_pd
(
¥iv
->
pd
);

1802 
¥iv
->
pd
 = 
NULL
;

1805 
˛ón_wq
:

1806 i‡(
¥iv
->
wq
) {

1807 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1808 
¥iv
->
wq
 = 
NULL
;

1811 
out
:

1812  
ªt
;

1813 
	}
}

1819 
	$ùoib_∑ª¡_uƒegi°î_¥e
(
√t_devi˚
 *
ndev
)

1821 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1827 
	`π∆_lock
();

1828 
	`dev_ch™ge_Êags
(
¥iv
->
dev
,Öriv->dev->
Êags
 & ~
IFF_UP
, 
NULL
);

1829 
	`π∆_u∆ock
();

1832 
	`ib_uƒegi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

1838 
	`Êush_w‹kqueue
(
ùoib_w‹kqueue
);

1839 
	}
}

1841 
	$ùoib_£t_dev_„©uªs
(
ùoib_dev_¥iv
 *
¥iv
)

1843 
¥iv
->
hˇ_ˇps
 =Öriv->
ˇ
->
©ås
.
devi˚_ˇp_Êags
;

1845 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_IP_CSUM
) {

1846 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_IP_CSUM
 | 
NETIF_F_RXCSUM
;

1848 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

1849 
¥iv
->
dev
->
hw_„©uªs
 |
NETIF_F_TSO
;

1851 
¥iv
->
dev
->
„©uªs
 |¥iv->dev->
hw_„©uªs
;

1853 
	}
}

1855 
	$ùoib_∑ª¡_öô
(
√t_devi˚
 *
ndev
)

1857 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1858 
ib_p‹t_©å
 
©å
;

1859 
ªsu…
;

1861 
ªsu…
 = 
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
);

1862 i‡(
ªsu…
) {

1863 
	`¥_w¨n
("%s: ib_quîy_p‹à%d faûed\n", 
¥iv
->
ˇ
->
«me
,

1864 
¥iv
->
p‹t
);

1865  
ªsu…
;

1867 i‡(
ùoib_ac˚l
 && 
	`rdma_c‹e_ˇp_›a_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
))

1868 
¥iv
->
max_ib_mtu
 = 
hfi1_max_mtu
;

1870 
¥iv
->
max_ib_mtu
 = 
	`ib_mtu_íum_to_öt
(
©å
.
max_mtu
);

1872 
ªsu…
 = 
	`ib_quîy_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
pkey
);

1873 i‡(
ªsu…
) {

1874 
	`¥_w¨n
("%s: ib_query_pkeyÖort %d failed (ret = %d)\n",

1875 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1876  
ªsu…
;

1879 
ªsu…
 = 
	`rdma_quîy_gid
(
¥iv
->
ˇ
,Öriv->
p‹t
, 0, &¥iv->
loˇl_gid
);

1880 i‡(
ªsu…
) {

1881 
	`¥_w¨n
("%s:Ñdma_query_gidÖort %d failed (ret = %d)\n",

1882 
¥iv
->
ˇ
->
«me
,Öriv->
p‹t
, 
ªsu…
);

1883  
ªsu…
;

1885 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
 + 4,Öriv->
loˇl_gid
.
øw
,

1886 (
ib_gid
));

1888 
	`SET_NETDEV_DEV
(
¥iv
->
dev
,Öriv->
ˇ
->dev.
∑ª¡
);

1889 
¥iv
->
dev
->
dev_p‹t
 =Öriv->
p‹t
 - 1;

1891 
¥iv
->
dev
->
dev_id
 =Öriv->
p‹t
 - 1;

1894 
	}
}

1896 
	$ùoib_chûd_öô
(
√t_devi˚
 *
ndev
)

1898 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1899 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1901 
¥iv
->
max_ib_mtu
 = 
µriv
->max_ib_mtu;

1902 
	`£t_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
);

1903 
	`mem˝y
(
¥iv
->
dev
->
dev_addr
, 
µriv
->dev->dev_addr, 
INFINIBAND_ALEN
);

1904 
	`mem˝y
(&
¥iv
->
loˇl_gid
, &
µriv
->local_gid, (priv->local_gid));

1905 
	}
}

1907 
	$ùoib_ndo_öô
(
√t_devi˚
 *
ndev
)

1909 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

1910 
rdma_√tdev
 *
∫
;

1911 
rc
;

1913 i‡(
¥iv
->
∑ª¡
) {

1914 
	`ùoib_chûd_öô
(
ndev
);

1916 
rc
 = 
	`ùoib_∑ª¡_öô
(
ndev
);

1917 i‡(
rc
)

1918  
rc
;

1922 
ndev
->
mtu
 = 
	`IPOIB_UD_MTU
(
¥iv
->
max_ib_mtu
);

1923 
¥iv
->
mˇ°_mtu
 =Öriv->
admö_mtu
 = 
ndev
->
mtu
;

1924 
∫
 = 
	`√tdev_¥iv
(
¥iv
->
dev
);

1925 
∫
->
mtu
 = 
¥iv
->
mˇ°_mtu
;

1926 
ndev
->
max_mtu
 = 
IPOIB_CM_MTU
;

1928 
ndev
->
√igh_¥iv_Àn
 = (
ùoib_√igh
);

1934 
¥iv
->
pkey
 |= 0x8000;

1936 
ndev
->
brﬂdˇ°
[8] = 
¥iv
->
pkey
 >> 8;

1937 
ndev
->
brﬂdˇ°
[9] = 
¥iv
->
pkey
 & 0xff;

1938 
	`£t_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

1940 
	`ùoib_£t_dev_„©uªs
(
¥iv
);

1942 
rc
 = 
	`ùoib_dev_öô
(
ndev
);

1943 i‡(
rc
) {

1944 
	`¥_w¨n
("%s: failedÅo initialize device: %sÖort %d (ret = %d)\n",

1945 
¥iv
->
ˇ
->
«me
,Öriv->
dev
->«me,Öriv->
p‹t
, 
rc
);

1946  
rc
;

1949 i‡(
¥iv
->
∑ª¡
) {

1950 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1952 
	`dev_hﬁd
(
¥iv
->
∑ª¡
);

1954 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1955 
	`li°_add_èû
(&
¥iv
->
li°
, &
µriv
->
chûd_ötfs
);

1956 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1960 
	}
}

1962 
	$ùoib_ndo_unöô
(
√t_devi˚
 *
dev
)

1964 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

1966 
	`ASSERT_RTNL
();

1972 
	`WARN_ON
(!
	`li°_em±y
(&
¥iv
->
chûd_ötfs
));

1974 i‡(
¥iv
->
∑ª¡
) {

1975 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

1977 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

1978 
	`li°_dñ
(&
¥iv
->
li°
);

1979 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

1982 
	`ùoib_√igh_hash_unöô
(
dev
);

1984 
	`ùoib_ib_dev_˛ónup
(
dev
);

1987 i‡(
¥iv
->
wq
) {

1988 
	`Êush_w‹kqueue
(
¥iv
->
wq
);

1989 
	`de°roy_w‹kqueue
(
¥iv
->
wq
);

1990 
¥iv
->
wq
 = 
NULL
;

1993 i‡(
¥iv
->
∑ª¡
)

1994 
	`dev_put
(
¥iv
->
∑ª¡
);

1995 
	}
}

1997 
	$ùoib_£t_vf_lök_°©e
(
√t_devi˚
 *
dev
, 
vf
, 
lök_°©e
)

1999 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2001  
	`ib_£t_vf_lök_°©e
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
lök_°©e
);

2002 
	}
}

2004 
	$ùoib_gë_vf_c⁄fig
(
√t_devi˚
 *
dev
, 
vf
,

2005 
iÊa_vf_öfo
 *
ivf
)

2007 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2008 
îr
;

2010 
îr
 = 
	`ib_gë_vf_c⁄fig
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
ivf
);

2011 i‡(
îr
)

2012  
îr
;

2014 
ivf
->
vf
 = vf;

2015 
	`mem˝y
(
ivf
->
mac
, 
dev
->
dev_addr
, dev->
addr_Àn
);

2018 
	}
}

2020 
	$ùoib_£t_vf_guid
(
√t_devi˚
 *
dev
, 
vf
, 
u64
 
guid
, 
ty≥
)

2022 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2024 i‡(
ty≥
 !
IFLA_VF_IB_NODE_GUID
 &&Åy≥ !
IFLA_VF_IB_PORT_GUID
)

2025  -
EINVAL
;

2027  
	`ib_£t_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
guid
, 
ty≥
);

2028 
	}
}

2030 
	$ùoib_gë_vf_guid
(
√t_devi˚
 *
dev
, 
vf
,

2031 
iÊa_vf_guid
 *
node_guid
,

2032 
iÊa_vf_guid
 *
p‹t_guid
)

2034 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2036  
	`ib_gë_vf_guid
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
node_guid
, 
p‹t_guid
);

2037 
	}
}

2039 
	$ùoib_gë_vf_°©s
(
√t_devi˚
 *
dev
, 
vf
,

2040 
iÊa_vf_°©s
 *
vf_°©s
)

2042 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2044  
	`ib_gë_vf_°©s
(
¥iv
->
ˇ
, 
vf
,Öriv->
p‹t
, 
vf_°©s
);

2045 
	}
}

2047 c⁄° 
hódî_›s
 
	gùoib_hódî_›s
 = {

2048 .
¸óã
 = 
ùoib_h¨d_hódî
,

2051 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_pf
 = {

2052 .
ndo_öô
 = 
ùoib_ndo_öô
,

2053 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2054 .
	gndo_›í
 = 
ùoib_›í
,

2055 .
	gndo_°›
 = 
ùoib_°›
,

2056 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2057 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2058 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2059 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2060 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2061 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2062 .
	gndo_£t_vf_lök_°©e
 = 
ùoib_£t_vf_lök_°©e
,

2063 .
	gndo_gë_vf_c⁄fig
 = 
ùoib_gë_vf_c⁄fig
,

2064 .
	gndo_gë_vf_°©s
 = 
ùoib_gë_vf_°©s
,

2065 .
	gndo_gë_vf_guid
 = 
ùoib_gë_vf_guid
,

2066 .
	gndo_£t_vf_guid
 = 
ùoib_£t_vf_guid
,

2067 .
	gndo_£t_mac_addªss
 = 
ùoib_£t_mac
,

2068 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2069 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2072 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_›s_vf
 = {

2073 .
ndo_öô
 = 
ùoib_ndo_öô
,

2074 .
	gndo_unöô
 = 
ùoib_ndo_unöô
,

2075 .
	gndo_›í
 = 
ùoib_›í
,

2076 .
	gndo_°›
 = 
ùoib_°›
,

2077 .
	gndo_ch™ge_mtu
 = 
ùoib_ch™ge_mtu
,

2078 .
	gndo_fix_„©uªs
 = 
ùoib_fix_„©uªs
,

2079 .
	gndo_°¨t_xmô
 = 
ùoib_°¨t_xmô
,

2080 .
	gndo_tx_timeout
 = 
ùoib_timeout
,

2081 .
	gndo_£t_rx_mode
 = 
ùoib_£t_mˇ°_li°
,

2082 .
	gndo_gë_iÊök
 = 
ùoib_gë_iÊök
,

2083 .
	gndo_gë_°©s64
 = 
ùoib_gë_°©s
,

2084 .
	gndo_do_io˘l
 = 
ùoib_io˘l
,

2087 c⁄° 
√t_devi˚_›s
 
	gùoib_√tdev_deÁu…_pf
 = {

2088 .
ndo_öô
 = 
ùoib_dev_öô_deÁu…
,

2089 .
	gndo_unöô
 = 
ùoib_dev_unöô_deÁu…
,

2090 .
	gndo_›í
 = 
ùoib_ib_dev_›í_deÁu…
,

2091 .
	gndo_°›
 = 
ùoib_ib_dev_°›_deÁu…
,

2094 
	$ùoib_£tup_comm⁄
(
√t_devi˚
 *
dev
)

2096 
dev
->
hódî_›s
 = &
ùoib_hódî_›s
;

2097 
dev
->
√tdev_›s
 = &
ùoib_√tdev_deÁu…_pf
;

2099 
	`ùoib_£t_ëhtoﬁ_›s
(
dev
);

2101 
dev
->
w©chdog_timeo
 = 
HZ
;

2103 
dev
->
Êags
 |
IFF_BROADCAST
 | 
IFF_MULTICAST
;

2105 
dev
->
h¨d_hódî_Àn
 = 
IPOIB_HARD_LEN
;

2106 
dev
->
addr_Àn
 = 
INFINIBAND_ALEN
;

2107 
dev
->
ty≥
 = 
ARPHRD_INFINIBAND
;

2108 
dev
->
tx_queue_Àn
 = 
ùoib_£ndq_size
 * 2;

2109 
dev
->
„©uªs
 = (
NETIF_F_VLAN_CHALLENGED
 |

2110 
NETIF_F_HIGHDMA
);

2111 
	`√tif_kìp_d°
(
dev
);

2113 
	`mem˝y
(
dev
->
brﬂdˇ°
, 
ùv4_bˇ°_addr
, 
INFINIBAND_ALEN
);

2120 
dev
->
√eds_‰ì_√tdev
 = 
åue
;

2121 
	}
}

2123 
	$ùoib_buûd_¥iv
(
√t_devi˚
 *
dev
)

2125 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2127 
¥iv
->
dev
 = dev;

2128 
	`•ö_lock_öô
(&
¥iv
->
lock
);

2129 
	`öô_rw£m
(&
¥iv
->
vœn_rw£m
);

2130 
	`muãx_öô
(&
¥iv
->
mˇ°_muãx
);

2132 
	`INIT_LIST_HEAD
(&
¥iv
->
∑th_li°
);

2133 
	`INIT_LIST_HEAD
(&
¥iv
->
chûd_ötfs
);

2134 
	`INIT_LIST_HEAD
(&
¥iv
->
dód_ahs
);

2135 
	`INIT_LIST_HEAD
(&
¥iv
->
mu…iˇ°_li°
);

2137 
	`INIT_DELAYED_WORK
(&
¥iv
->
mˇ°_èsk
, 
ùoib_mˇ°_joö_èsk
);

2138 
	`INIT_WORK
(&
¥iv
->
ˇºõr_⁄_èsk
, 
ùoib_mˇ°_ˇºõr_⁄_èsk
);

2139 
	`INIT_WORK
(&
¥iv
->
Êush_light
, 
ùoib_ib_dev_Êush_light
);

2140 
	`INIT_WORK
(&
¥iv
->
Êush_n‹mÆ
, 
ùoib_ib_dev_Êush_n‹mÆ
);

2141 
	`INIT_WORK
(&
¥iv
->
Êush_hóvy
, 
ùoib_ib_dev_Êush_hóvy
);

2142 
	`INIT_WORK
(&
¥iv
->
ª°¨t_èsk
, 
ùoib_mˇ°_ª°¨t_èsk
);

2143 
	`INIT_DELAYED_WORK
(&
¥iv
->
ah_ª≠_èsk
, 
ùoib_ª≠_ah
);

2144 
	`INIT_DELAYED_WORK
(&
¥iv
->
√igh_ª≠_èsk
, 
ùoib_ª≠_√igh
);

2145 
	}
}

2147 
√t_devi˚
 *
	$ùoib_Æloc_√tdev
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2148 c⁄° *
«me
)

2150 
√t_devi˚
 *
dev
;

2152 
dev
 = 
	`rdma_Æloc_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2153 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
);

2154 i‡(!
	`IS_ERR
(
dev
Ë|| 
	`PTR_ERR
(devË!-
EOPNOTSUPP
)

2155  
dev
;

2157 
dev
 = 
	`Æloc_√tdev
((
rdma_√tdev
), 
«me
, 
NET_NAME_UNKNOWN
,

2158 
ùoib_£tup_comm⁄
);

2159 i‡(!
dev
)

2160  
	`ERR_PTR
(-
ENOMEM
);

2161  
dev
;

2162 
	}
}

2164 
	$ùoib_ötf_öô
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
, c⁄° *
«me
,

2165 
√t_devi˚
 *
dev
)

2167 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2168 
ùoib_dev_¥iv
 *
¥iv
;

2169 
rc
;

2171 
¥iv
 = 
	`kzÆloc
((*¥iv), 
GFP_KERNEL
);

2172 i‡(!
¥iv
)

2173  -
ENOMEM
;

2175 
¥iv
->
ˇ
 = 
hˇ
;

2176 
¥iv
->
p‹t
 =Öort;

2178 
rc
 = 
	`rdma_öô_√tdev
(
hˇ
, 
p‹t
, 
RDMA_NETDEV_IPOIB
, 
«me
,

2179 
NET_NAME_UNKNOWN
, 
ùoib_£tup_comm⁄
, 
dev
);

2180 i‡(
rc
) {

2181 i‡(
rc
 !-
EOPNOTSUPP
)

2182 
out
;

2184 
∫
->
£nd
 = 
ùoib_£nd
;

2185 
∫
->
©èch_mˇ°
 = 
ùoib_mˇ°_©èch
;

2186 
∫
->
dëach_mˇ°
 = 
ùoib_mˇ°_dëach
;

2187 
∫
->
hˇ
 = hca;

2190 
¥iv
->
∫_›s
 = 
dev
->
√tdev_›s
;

2192 i‡(
hˇ
->
©ås
.
devi˚_ˇp_Êags
 & 
IB_DEVICE_VIRTUAL_FUNCTION
)

2193 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_vf
;

2195 
dev
->
√tdev_›s
 = &
ùoib_√tdev_›s_pf
;

2197 
∫
->
˛¡_¥iv
 = 
¥iv
;

2203 
¥iv
->
√xt_¥iv_de°ru˘‹
 = 
dev
->
¥iv_de°ru˘‹
;

2204 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2206 
	`ùoib_buûd_¥iv
(
dev
);

2210 
out
:

2211 
	`k‰ì
(
¥iv
);

2212  
rc
;

2213 
	}
}

2215 
√t_devi˚
 *
	$ùoib_ötf_Æloc
(
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
,

2216 c⁄° *
«me
)

2218 
√t_devi˚
 *
dev
;

2219 
rc
;

2221 
dev
 = 
	`ùoib_Æloc_√tdev
(
hˇ
, 
p‹t
, 
«me
);

2222 i‡(
	`IS_ERR
(
dev
))

2223  
dev
;

2225 
rc
 = 
	`ùoib_ötf_öô
(
hˇ
, 
p‹t
, 
«me
, 
dev
);

2226 i‡(
rc
) {

2227 
	`‰ì_√tdev
(
dev
);

2228  
	`ERR_PTR
(
rc
);

2236  
dev
;

2237 
	}
}

2239 
	$ùoib_ötf_‰ì
(
√t_devi˚
 *
dev
)

2241 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2242 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

2244 
dev
->
¥iv_de°ru˘‹
 = 
¥iv
->
√xt_¥iv_de°ru˘‹
;

2245 i‡(
dev
->
¥iv_de°ru˘‹
)

2246 
dev
->
	`¥iv_de°ru˘‹
(dev);

2252 
dev
->
¥iv_de°ru˘‹
 = 
NULL
;

2255 
∫
->
˛¡_¥iv
 = 
NULL
;

2257 
	`k‰ì
(
¥iv
);

2258 
	}
}

2260 
ssize_t
 
	$show_pkey
(
devi˚
 *
dev
,

2261 
devi˚_©åibuã
 *
©å
, *
buf
)

2263 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2264 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2266  
	`•rötf
(
buf
, "0x%04x\n", 
¥iv
->
pkey
);

2267 
	}
}

2268 
DEVICE_ATTR
(
pkey
, 
S_IRUGO
, 
show_pkey
, 
NULL
);

2270 
ssize_t
 
	$show_umˇ°
(
devi˚
 *
dev
,

2271 
devi˚_©åibuã
 *
©å
, *
buf
)

2273 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2274 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2276  
	`•rötf
(
buf
, "%d\n", 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
));

2277 
	}
}

2279 
	$ùoib_£t_umˇ°
(
√t_devi˚
 *
ndev
, 
umˇ°_vÆ
)

2281 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2283 i‡(
umˇ°_vÆ
 > 0) {

2284 
	`£t_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2285 
	`ùoib_w¨n
(
¥iv
, "ignoring multicast groups joined directly "

2288 
	`˛ór_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

2289 
	}
}

2291 
ssize_t
 
	$£t_umˇ°
(
devi˚
 *
dev
,

2292 
devi˚_©åibuã
 *
©å
,

2293 c⁄° *
buf
, 
size_t
 
cou¡
)

2295 
umˇ°_vÆ
 = 
	`sim∂e_°πoul
(
buf
, 
NULL
, 0);

2297 
	`ùoib_£t_umˇ°
(
	`to_√t_dev
(
dev
), 
umˇ°_vÆ
);

2299  
cou¡
;

2300 
	}
}

2301 
DEVICE_ATTR
(
umˇ°
, 
S_IWUSR
 | 
S_IRUGO
, 
show_umˇ°
, 
£t_umˇ°
);

2303 
	$ùoib_add_umˇ°_©å
(
√t_devi˚
 *
dev
)

2305  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_umˇ°
);

2306 
	}
}

2308 
	$£t_ba£_guid
(
ùoib_dev_¥iv
 *
¥iv
, 
ib_gid
 *
gid
)

2310 
ùoib_dev_¥iv
 *
chûd_¥iv
;

2311 
√t_devi˚
 *
√tdev
 = 
¥iv
->
dev
;

2313 
	`√tif_addr_lock_bh
(
√tdev
);

2315 
	`mem˝y
(&
¥iv
->
loˇl_gid
.
globÆ
.
öãrÁ˚_id
,

2316 &
gid
->
globÆ
.
öãrÁ˚_id
,

2317 (
gid
->
globÆ
.
öãrÁ˚_id
));

2318 
	`mem˝y
(
√tdev
->
dev_addr
 + 4, &
¥iv
->
loˇl_gid
, (priv->local_gid));

2319 
	`˛ór_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
);

2321 
	`√tif_addr_u∆ock_bh
(
√tdev
);

2323 i‡(!
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
¥iv
->
Êags
)) {

2324 
	`down_ªad
(&
¥iv
->
vœn_rw£m
);

2325 
	`li°_f‹_óch_íåy
(
chûd_¥iv
, &
¥iv
->
chûd_ötfs
, 
li°
)

2326 
	`£t_ba£_guid
(
chûd_¥iv
, 
gid
);

2327 
	`up_ªad
(&
¥iv
->
vœn_rw£m
);

2329 
	}
}

2331 
	$ùoib_check_Œaddr
(
√t_devi˚
 *
dev
,

2332 
sockaddr_°‹age
 *
ss
)

2334 
ib_gid
 *
gid
 = (ib_gid *)(
ss
->
__d©a
 + 4);

2335 
ªt
 = 0;

2337 
	`√tif_addr_lock_bh
(
dev
);

2342 i‡(
	`memcmp
(
dev
->
dev_addr
, 
ss
->
__d©a
,

2343 4 + (
gid
->
globÆ
.
sub√t_¥efix
)) ||

2344 
gid
->
globÆ
.
öãrÁ˚_id
 == 0)

2345 
ªt
 = -
EINVAL
;

2347 
	`√tif_addr_u∆ock_bh
(
dev
);

2349  
ªt
;

2350 
	}
}

2352 
	$ùoib_£t_mac
(
√t_devi˚
 *
dev
, *
addr
)

2354 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2355 
sockaddr_°‹age
 *
ss
 = 
addr
;

2356 
ªt
;

2358 i‡(!(
dev
->
¥iv_Êags
 & 
IFF_LIVE_ADDR_CHANGE
Ë&& 
	`√tif_ru¬ög
(dev))

2359  -
EBUSY
;

2361 
ªt
 = 
	`ùoib_check_Œaddr
(
dev
, 
ss
);

2362 i‡(
ªt
)

2363  
ªt
;

2365 
	`£t_ba£_guid
(
¥iv
, (
ib_gid
 *)(
ss
->
__d©a
 + 4));

2367 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

2370 
	}
}

2372 
ssize_t
 
	$¸óã_chûd
(
devi˚
 *
dev
,

2373 
devi˚_©åibuã
 *
©å
,

2374 c⁄° *
buf
, 
size_t
 
cou¡
)

2376 
pkey
;

2377 
ªt
;

2379 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2380  -
EINVAL
;

2382 i‡(
pkey
 <= 0 ||Ökey > 0xffff ||Ökey == 0x8000)

2383  -
EINVAL
;

2385 
ªt
 = 
	`ùoib_vœn_add
(
	`to_√t_dev
(
dev
), 
pkey
);

2387  
ªt
 ?Ñë : 
cou¡
;

2388 
	}
}

2389 
DEVICE_ATTR
(
¸óã_chûd
, 
S_IWUSR
, 
NULL
, create_child);

2391 
ssize_t
 
	$dñëe_chûd
(
devi˚
 *
dev
,

2392 
devi˚_©åibuã
 *
©å
,

2393 c⁄° *
buf
, 
size_t
 
cou¡
)

2395 
pkey
;

2396 
ªt
;

2398 i‡(
	`ssˇnf
(
buf
, "%i", &
pkey
) != 1)

2399  -
EINVAL
;

2401 i‡(
pkey
 < 0 ||Ökey > 0xffff)

2402  -
EINVAL
;

2404 
ªt
 = 
	`ùoib_vœn_dñëe
(
	`to_√t_dev
(
dev
), 
pkey
);

2406  
ªt
 ?Ñë : 
cou¡
;

2408 
	}
}

2409 
DEVICE_ATTR
(
dñëe_chûd
, 
S_IWUSR
, 
NULL
, delete_child);

2411 
	$ùoib_add_pkey_©å
(
√t_devi˚
 *
dev
)

2413  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_pkey
);

2414 
	}
}

2425 
ssize_t
 
	$dev_id_show
(
devi˚
 *
dev
,

2426 
devi˚_©åibuã
 *
©å
, *
buf
)

2428 
√t_devi˚
 *
ndev
 = 
	`to_√t_dev
(
dev
);

2441 i‡(
ndev
->
dev_p‹t
 &&Çdev->
dev_id
 ==Çdev->dev_port)

2442 
	`√tdev_öfo_⁄˚
(
ndev
,

2444 
cuºít
->
comm
);

2446  
	`•rötf
(
buf
, "%#x\n", 
ndev
->
dev_id
);

2447 
	}
}

2448 
DEVICE_ATTR_RO
(
dev_id
);

2450 
	$ùoib_öãr˚±_dev_id_©å
(
√t_devi˚
 *
dev
)

2452 
	`devi˚_ªmove_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2453  
	`devi˚_¸óã_fûe
(&
dev
->dev, &
dev_©å_dev_id
);

2454 
	}
}

2456 
√t_devi˚
 *
	$ùoib_add_p‹t
(c⁄° *
f‹m©
,

2457 
ib_devi˚
 *
hˇ
, 
u8
 
p‹t
)

2459 
π∆_lök_›s
 *
›s
 = 
	`ùoib_gë_lök_›s
();

2460 
rdma_√tdev_Æloc_∑øms
 
∑øms
;

2461 
ùoib_dev_¥iv
 *
¥iv
;

2462 
√t_devi˚
 *
ndev
;

2463 
ªsu…
;

2465 
ndev
 = 
	`ùoib_ötf_Æloc
(
hˇ
, 
p‹t
, 
f‹m©
);

2466 i‡(
	`IS_ERR
(
ndev
)) {

2467 
	`¥_w¨n
("%s, %d: ipoib_ötf_Ælo¯Áûed %ld\n", 
hˇ
->
«me
, 
p‹t
,

2468 
	`PTR_ERR
(
ndev
));

2469  
ndev
;

2471 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

2473 
	`INIT_IB_EVENT_HANDLER
(&
¥iv
->
evít_h™dÀr
,

2474 
¥iv
->
ˇ
, 
ùoib_evít
);

2475 
	`ib_ªgi°î_evít_h™dÀr
(&
¥iv
->
evít_h™dÀr
);

2478 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

2480 
ªsu…
 = 
	`ªgi°î_√tdev
(
ndev
);

2481 i‡(
ªsu…
) {

2482 
	`¥_w¨n
("%s: couldn'tÑegister ipoibÖort %d;Érror %d\n",

2483 
hˇ
->
«me
, 
p‹t
, 
ªsu…
);

2485 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2486 
	`ùoib_ötf_‰ì
(
ndev
);

2487 
	`‰ì_√tdev
(
ndev
);

2489  
	`ERR_PTR
(
ªsu…
);

2492 i‡(
hˇ
->
›s
.
rdma_√tdev_gë_∑øms
) {

2493 
rc
 = 
hˇ
->
›s
.
	`rdma_√tdev_gë_∑øms
(hˇ, 
p‹t
,

2494 
RDMA_NETDEV_IPOIB
,

2495 &
∑øms
);

2497 i‡(!
rc
 && 
›s
->
¥iv_size
 < 
∑øms
.
sizeof_¥iv
)

2498 
›s
->
¥iv_size
 = 
∑øms
.
sizeof_¥iv
;

2506 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

2508 i‡(
	`ùoib_öãr˚±_dev_id_©å
(
ndev
))

2509 
sysfs_Áûed
;

2510 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

2511 
sysfs_Áûed
;

2512 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

2513 
sysfs_Áûed
;

2514 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

2515 
sysfs_Áûed
;

2516 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_¸óã_chûd
))

2517 
sysfs_Áûed
;

2518 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_dñëe_chûd
))

2519 
sysfs_Áûed
;

2521  
ndev
;

2523 
sysfs_Áûed
:

2524 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
ndev
);

2525 
	`uƒegi°î_√tdev
(
ndev
);

2526  
	`ERR_PTR
(-
ENOMEM
);

2527 
	}
}

2529 
	$ùoib_add_⁄e
(
ib_devi˚
 *
devi˚
)

2531 
li°_hód
 *
dev_li°
;

2532 
√t_devi˚
 *
dev
;

2533 
ùoib_dev_¥iv
 *
¥iv
;

2534 
p
;

2535 
cou¡
 = 0;

2537 
dev_li°
 = 
	`kmÆloc
((*dev_li°), 
GFP_KERNEL
);

2538 i‡(!
dev_li°
)

2541 
	`INIT_LIST_HEAD
(
dev_li°
);

2543 
	`rdma_f‹_óch_p‹t
 (
devi˚
, 
p
) {

2544 i‡(!
	`rdma_¥Ÿocﬁ_ib
(
devi˚
, 
p
))

2546 
dev
 = 
	`ùoib_add_p‹t
("ib%d", 
devi˚
, 
p
);

2547 i‡(!
	`IS_ERR
(
dev
)) {

2548 
¥iv
 = 
	`ùoib_¥iv
(
dev
);

2549 
	`li°_add_èû
(&
¥iv
->
li°
, 
dev_li°
);

2550 
cou¡
++;

2554 i‡(!
cou¡
) {

2555 
	`k‰ì
(
dev_li°
);

2559 
	`ib_£t_˛õ¡_d©a
(
devi˚
, &
ùoib_˛õ¡
, 
dev_li°
);

2560 
	}
}

2562 
	$ùoib_ªmove_⁄e
(
ib_devi˚
 *
devi˚
, *
˛õ¡_d©a
)

2564 
ùoib_dev_¥iv
 *
¥iv
, *
tmp
, *
˝riv
, *
t˝riv
;

2565 
li°_hód
 *
dev_li°
 = 
˛õ¡_d©a
;

2567 i‡(!
dev_li°
)

2570 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
tmp
, 
dev_li°
, 
li°
) {

2571 
	`LIST_HEAD
(
hód
);

2572 
	`ùoib_∑ª¡_uƒegi°î_¥e
(
¥iv
->
dev
);

2574 
	`π∆_lock
();

2576 
	`li°_f‹_óch_íåy_ß„
(
˝riv
, 
t˝riv
, &
¥iv
->
chûd_ötfs
,

2577 
li°
)

2578 
	`uƒegi°î_√tdevi˚_queue
(
˝riv
->
dev
, &
hód
);

2579 
	`uƒegi°î_√tdevi˚_queue
(
¥iv
->
dev
, &
hód
);

2580 
	`uƒegi°î_√tdevi˚_m™y
(&
hód
);

2582 
	`π∆_u∆ock
();

2585 
	`k‰ì
(
dev_li°
);

2586 
	}
}

2588 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2589 
nŸifõr_block
 
	gùoib_√tdev_nŸifõr
 = {

2590 .
nŸifõr_ˇŒ
 = 
ùoib_√tdev_evít
,

2594 
__öô
 
	$ùoib_öô_moduÀ
()

2596 
ªt
;

2598 
ùoib_ªcvq_size
 = 
	`roundup_pow_of_two
(ipoib_recvq_size);

2599 
ùoib_ªcvq_size
 = 
	`mö
(ùoib_ªcvq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2600 
ùoib_ªcvq_size
 = 
	`max
(ùoib_ªcvq_size, 
IPOIB_MIN_QUEUE_SIZE
);

2602 
ùoib_£ndq_size
 = 
	`roundup_pow_of_two
(ipoib_sendq_size);

2603 
ùoib_£ndq_size
 = 
	`mö
(ùoib_£ndq_size, 
IPOIB_MAX_QUEUE_SIZE
);

2604 
ùoib_£ndq_size
 = 
	`max3
(ùoib_£ndq_size, 2 * 
MAX_SEND_CQE
, 
IPOIB_MIN_QUEUE_SIZE
);

2605 #ifde‡
CONFIG_INFINIBAND_IPOIB_CM


2606 
ùoib_max_c⁄n_qp
 = 
	`mö
(ùoib_max_c⁄n_qp, 
IPOIB_CM_MAX_CONN_QP
);

2607 
ùoib_max_c⁄n_qp
 = 
	`max
(ipoib_max_conn_qp, 0);

2614 
	`BUILD_BUG_ON
(
IPOIB_CM_COPYBREAK
 > 
IPOIB_CM_HEAD_SIZE
);

2616 
	`¥_nŸi˚
("Intel Accelerated IPoIB for RHELÜoaded.\n");

2618 
	`ùoib_ªgi°î_debugfs
();

2630 
ùoib_w‹kqueue
 = 
	`Æloc_‹dîed_w‹kqueue
("ipoib_flush", 0);

2631 i‡(!
ùoib_w‹kqueue
) {

2632 
ªt
 = -
ENOMEM
;

2633 
îr_fs
;

2636 
	`ib_ß_ªgi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2638 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
ùoib_˛õ¡
);

2639 i‡(
ªt
)

2640 
îr_ß
;

2642 
ªt
 = 
	`ùoib_√éök_öô
();

2643 i‡(
ªt
)

2644 
îr_˛õ¡
;

2646 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2647 
	`ªgi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2651 
îr_˛õ¡
:

2652 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2654 
îr_ß
:

2655 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2656 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2658 
îr_fs
:

2659 
	`ùoib_uƒegi°î_debugfs
();

2661  
ªt
;

2662 
	}
}

2664 
__exô
 
	$ùoib_˛ónup_moduÀ
()

2666 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


2667 
	`uƒegi°î_√tdevi˚_nŸifõr
(&
ùoib_√tdev_nŸifõr
);

2669 
	`ùoib_√éök_föi
();

2670 
	`ib_uƒegi°î_˛õ¡
(&
ùoib_˛õ¡
);

2671 
	`ib_ß_uƒegi°î_˛õ¡
(&
ùoib_ß_˛õ¡
);

2672 
	`ùoib_uƒegi°î_debugfs
();

2673 
	`de°roy_w‹kqueue
(
ùoib_w‹kqueue
);

2674 
	}
}

2676 
moduÀ_öô
(
ùoib_öô_moduÀ
);

2677 
moduÀ_exô
(
ùoib_˛ónup_moduÀ
);

	@SLES15SP2/ipoib/ipoib_multicast.c

35 
	~<löux/skbuff.h
>

36 
	~<löux/π√éök.h
>

37 
	~<löux/moduÀ∑øm.h
>

38 
	~<löux/ù.h
>

39 
	~<löux/ö.h
>

40 
	~<löux/igmp.h
>

41 
	~<löux/öëdevi˚.h
>

42 
	~<löux/dñay.h
>

43 
	~<löux/com∂ëi⁄.h
>

44 
	~<löux/¶ab.h
>

46 
	~<√t/d°.h
>

48 
	~"ùoib.h
"

50 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


51 
	gmˇ°_debug_Àvñ
;

53 
moduÀ_∑øm
(
mˇ°_debug_Àvñ
, , 0644);

54 
MODULE_PARM_DESC
(
mˇ°_debug_Àvñ
,

58 
	sùoib_mˇ°_ôî
 {

59 
√t_devi˚
 *
	mdev
;

60 
ib_gid
 
	mmgid
;

61 
	m¸óãd
;

62 
	mqueuñí
;

63 
	mcom∂ëe
;

64 
	m£nd_⁄ly
;

68 
	#SENDONLY_FULLMEMBER_JOIN
 8

	)

73 
	$__ùoib_mˇ°_scheduÀ_joö_thªad
(
ùoib_dev_¥iv
 *
¥iv
,

74 
ùoib_mˇ°
 *
mˇ°
,

75 
boﬁ
 
dñay
)

77 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

84 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

85 i‡(
mˇ°
 && 
dñay
) {

89 
mˇ°
->
backoff
 *= 2;

90 i‡(
mˇ°
->
backoff
 > 
IPOIB_MAX_BACKOFF_SECONDS
)

91 
mˇ°
->
backoff
 = 
IPOIB_MAX_BACKOFF_SECONDS
;

92 
mˇ°
->
dñay_u¡û
 = 
jiffõs
 + (mˇ°->
backoff
 * 
HZ
);

100 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

101 } i‡(
dñay
) {

107 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 
HZ
);

109 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
, 0);

110 
	}
}

112 
	$ùoib_mˇ°_‰ì
(
ùoib_mˇ°
 *
mˇ°
)

114 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

115 
tx_dr›≥d
 = 0;

117 
	`ùoib_dbg_mˇ°
(
	`ùoib_¥iv
(
dev
), "deleting multicast group %pI6\n",

118 
mˇ°
->
mcmembî
.
mgid
.
øw
);

121 
	`ùoib_dñ_√ighs_by_gid
(
dev
, 
mˇ°
->
mcmembî
.
mgid
.
øw
);

123 i‡(
mˇ°
->
ah
)

124 
	`ùoib_put_ah
(
mˇ°
->
ah
);

126 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

127 ++
tx_dr›≥d
;

128 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

131 
	`√tif_tx_lock_bh
(
dev
);

132 
dev
->
°©s
.
tx_dr›≥d
 +=Åx_dropped;

133 
	`√tif_tx_u∆ock_bh
(
dev
);

135 
	`k‰ì
(
mˇ°
);

136 
	}
}

138 
ùoib_mˇ°
 *
	$ùoib_mˇ°_Æloc
(
√t_devi˚
 *
dev
,

139 
ˇn_¶ìp
)

141 
ùoib_mˇ°
 *
mˇ°
;

143 
mˇ°
 = 
	`kzÆloc
((*mˇ°), 
ˇn_¶ìp
 ? 
GFP_KERNEL
 : 
GFP_ATOMIC
);

144 i‡(!
mˇ°
)

145  
NULL
;

147 
mˇ°
->
dev
 = dev;

148 
mˇ°
->
¸óãd
 = 
jiffõs
;

149 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

150 
mˇ°
->
backoff
 = 1;

152 
	`INIT_LIST_HEAD
(&
mˇ°
->
li°
);

153 
	`INIT_LIST_HEAD
(&
mˇ°
->
√igh_li°
);

154 
	`skb_queue_hód_öô
(&
mˇ°
->
pkt_queue
);

156  
mˇ°
;

157 
	}
}

159 
ùoib_mˇ°
 *
	$__ùoib_mˇ°_föd
(
√t_devi˚
 *
dev
, *
mgid
)

161 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

162 
rb_node
 *
n
 = 
¥iv
->
mu…iˇ°_åì
.rb_node;

164 
n
) {

165 
ùoib_mˇ°
 *
mˇ°
;

166 
ªt
;

168 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

170 
ªt
 = 
	`memcmp
(
mgid
, 
mˇ°
->
mcmembî
.mgid.
øw
,

171  (
ib_gid
));

172 i‡(
ªt
 < 0)

173 
n
 =Ç->
rb_À·
;

174 i‡(
ªt
 > 0)

175 
n
 =Ç->
rb_right
;

177  
mˇ°
;

180  
NULL
;

181 
	}
}

183 
	$__ùoib_mˇ°_add
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

185 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

186 
rb_node
 **
n
 = &
¥iv
->
mu…iˇ°_åì
.rb_node, *
≤
 = 
NULL
;

188 *
n
) {

189 
ùoib_mˇ°
 *
tmˇ°
;

190 
ªt
;

192 
≤
 = *
n
;

193 
tmˇ°
 = 
	`rb_íåy
(
≤
, 
ùoib_mˇ°
, 
rb_node
);

195 
ªt
 = 
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
tmˇ°
->mcmember.mgid.raw,

196  (
ib_gid
));

197 i‡(
ªt
 < 0)

198 
n
 = &
≤
->
rb_À·
;

199 i‡(
ªt
 > 0)

200 
n
 = &
≤
->
rb_right
;

202  -
EEXIST
;

205 
	`rb_lök_node
(&
mˇ°
->
rb_node
, 
≤
, 
n
);

206 
	`rb_ö£π_cﬁ‹
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

209 
	}
}

211 
	$ùoib_mˇ°_joö_föish
(
ùoib_mˇ°
 *
mˇ°
,

212 
ib_ß_mcmembî_ªc
 *
mcmembî
)

214 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

215 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

216 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

217 
ùoib_ah
 *
ah
;

218 
rdma_ah_©å
 
av
;

219 
ªt
;

220 
£t_qkey
 = 0;

222 
mˇ°
->
mcmembî
 = *mcmember;

227 i‡(!
	`memcmp
(
mˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->
brﬂdˇ°
 + 4,

228  (
ib_gid
))) {

229 
	`•ö_lock_úq
(&
¥iv
->
lock
);

230 i‡(!
¥iv
->
brﬂdˇ°
) {

231 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

232  -
EAGAIN
;

235 
¥iv
->
brﬂdˇ°
->
mcmembî
.
qkey
 = mcmember->qkey;

236 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
 = mcmember->mtu;

237 
¥iv
->
brﬂdˇ°
->
mcmembî
.
åaffic_˛ass
 = mcmember->traffic_class;

238 
¥iv
->
brﬂdˇ°
->
mcmembî
.
øã
 = mcmember->rate;

239 
¥iv
->
brﬂdˇ°
->
mcmembî
.
¶
 = mcmember->sl;

240 
¥iv
->
brﬂdˇ°
->
mcmembî
.
Êow_œbñ
 = mcmember->flow_label;

241 
¥iv
->
brﬂdˇ°
->
mcmembî
.
h›_limô
 = mcmember->hop_limit;

243 i‡(
¥iv
->
mˇ°_mtu
 =¥iv->
admö_mtu
)

244 
∫
->
mtu
 =

245 
¥iv
->
admö_mtu
 =

246 
¥iv
->
mˇ°_mtu
 =

247 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

248 
¥iv
->
p‹t
,

249 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

251 
∫
->
mtu
 =

252 
¥iv
->
mˇ°_mtu
 =

253 
	`IPOIB_UD_MTU
(
	`rdma_mtu_íum_to_öt
(
¥iv
->
ˇ
,

254 
¥iv
->
p‹t
,

255 
¥iv
->
brﬂdˇ°
->
mcmembî
.
mtu
));

257 
¥iv
->
qkey
 = 
	`be32_to_˝u
’riv->
brﬂdˇ°
->
mcmembî
.qkey);

258 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

259 
¥iv
->
tx_wr
.
ªmŸe_qkey
 =Öriv->
qkey
;

260 
£t_qkey
 = 1;

263 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

264 i‡(
	`ã°_™d_£t_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

265 
	`ùoib_w¨n
(
¥iv
, "multicast group %pI6álreadyáttached\n",

266 
mˇ°
->
mcmembî
.
mgid
.
øw
);

271 
ªt
 = 
∫
->
	`©èch_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

272 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

273 
£t_qkey
, 
¥iv
->
qkey
);

274 i‡(
ªt
 < 0) {

275 
	`ùoib_w¨n
(
¥iv
, "couldn'táttach QPÅo multicast group %pI6\n",

276 
mˇ°
->
mcmembî
.
mgid
.
øw
);

278 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
);

279  
ªt
;

283 
	`mem£t
(&
av
, 0, (av));

284 
av
.
ty≥
 = 
	`rdma_ah_föd_ty≥
(
¥iv
->
ˇ
,Öriv->
p‹t
);

285 
	`rdma_ah_£t_dlid
(&
av
, 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
)),

286 
	`rdma_ah_£t_p‹t_num
(&
av
, 
¥iv
->
p‹t
);

287 
	`rdma_ah_£t_¶
(&
av
, 
mˇ°
->
mcmembî
.
¶
);

288 
	`rdma_ah_£t_°©ic_øã
(&
av
, 
mˇ°
->
mcmembî
.
øã
);

290 
	`rdma_ah_£t_grh
(&
av
, &
mˇ°
->
mcmembî
.
mgid
,

291 
	`be32_to_˝u
(
mˇ°
->
mcmembî
.
Êow_œbñ
),

292 0, 
mˇ°
->
mcmembî
.
h›_limô
,

293 
mˇ°
->
mcmembî
.
åaffic_˛ass
);

295 
ah
 = 
	`ùoib_¸óã_ah
(
dev
, 
¥iv
->
pd
, &
av
);

296 i‡(
	`IS_ERR
(
ah
)) {

297 
	`ùoib_w¨n
(
¥iv
, "ib_address_create failed %ld\n",

298 -
	`PTR_ERR
(
ah
));

300  
	`PTR_ERR
(
ah
);

302 
	`•ö_lock_úq
(&
¥iv
->
lock
);

303 
mˇ°
->
ah
 =áh;

304 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

306 
	`ùoib_dbg_mˇ°
(
¥iv
, "MGID %pI6 AV %p, LID 0x%04x, SL %d\n",

307 
mˇ°
->
mcmembî
.
mgid
.
øw
,

308 
mˇ°
->
ah
->ah,

309 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
),

310 
mˇ°
->
mcmembî
.
¶
);

313 
	`√tif_tx_lock_bh
(
dev
);

314 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

315 
sk_buff
 *
skb
 = 
	`skb_dequeue
(&
mˇ°
->
pkt_queue
);

317 
	`√tif_tx_u∆ock_bh
(
dev
);

319 
skb
->
dev
 = dev;

321 
ªt
 = 
	`dev_queue_xmô
(
skb
);

322 i‡(
ªt
)

323 
	`ùoib_w¨n
(
¥iv
, "%s:dev_queue_xmit failedÅoÑe-queueÖacket,Ñet:%d\n",

324 
__func__
, 
ªt
);

325 
	`√tif_tx_lock_bh
(
dev
);

327 
	`√tif_tx_u∆ock_bh
(
dev
);

330 
	}
}

332 
	$ùoib_mˇ°_ˇºõr_⁄_èsk
(
w‹k_°ru˘
 *
w‹k
)

334 
ùoib_dev_¥iv
 *
¥iv
 = 
	`c⁄èöî_of
(
w‹k
, ipoib_dev_priv,

335 
ˇºõr_⁄_èsk
);

336 
ib_p‹t_©å
 
©å
;

338 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
©å
) ||

339 
©å
.
°©e
 !
IB_PORT_ACTIVE
) {

340 
	`ùoib_dbg
(
¥iv
, "Keeping carrier off until IBÖort isáctive\n");

349 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
 =

350 
	`ib_ß_£nd⁄ly_fuŒmem_suµ‹t
(&
ùoib_ß_˛õ¡
,

351 
¥iv
->
ˇ
,Öriv->
p‹t
);

361 !
	`π∆_åylock
()) {

362 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

365 
	`m¶ìp
(20);

367 i‡(!
	`ùoib_cm_admö_íabÀd
(
¥iv
->
dev
))

368 
	`dev_£t_mtu
(
¥iv
->
dev
, 
	`mö
’riv->
mˇ°_mtu
,Öriv->
admö_mtu
));

369 
	`√tif_ˇºõr_⁄
(
¥iv
->
dev
);

370 
	`π∆_u∆ock
();

371 
	}
}

373 
	$ùoib_mˇ°_joö_com∂ëe
(
°©us
,

374 
ib_ß_mu…iˇ°
 *
mu…iˇ°
)

376 
ùoib_mˇ°
 *
mˇ°
 = 
mu…iˇ°
->
c⁄ãxt
;

377 
√t_devi˚
 *
dev
 = 
mˇ°
->dev;

378 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

380 
	`ùoib_dbg_mˇ°
(
¥iv
, "%sjoin completion for %pI6 (status %d)\n",

381 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ?

383 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

386 i‡(
°©us
 =-
ENETRESET
) {

387 
°©us
 = 0;

388 
out
;

391 i‡(!
°©us
)

392 
°©us
 = 
	`ùoib_mˇ°_joö_föish
(
mˇ°
, &
mu…iˇ°
->
ªc
);

394 i‡(!
°©us
) {

395 
mˇ°
->
backoff
 = 1;

396 
mˇ°
->
dñay_u¡û
 = 
jiffõs
;

405 i‡(
mˇ°
 =
¥iv
->
brﬂdˇ°
) {

406 
	`•ö_lock_úq
(&
¥iv
->
lock
);

407 
	`queue_w‹k
(
¥iv
->
wq
, &¥iv->
ˇºõr_⁄_èsk
);

408 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

409 
out_locked
;

412 
boﬁ
 
sûít_Áû
 =

413 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

414 
°©us
 =-
EINVAL
;

416 i‡(
mˇ°
->
logcou¡
 < 20) {

417 i‡(
°©us
 =-
ETIMEDOUT
 || sètu†=-
EAGAIN
 ||

418 
sûít_Áû
) {

419 
	`ùoib_dbg_mˇ°
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

420 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

421 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

423 
	`ùoib_w¨n
(
¥iv
, "%smulticast join failed for %pI6, status %d\n",

424 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ? "sendonly " : "",

425 
mˇ°
->
mcmembî
.
mgid
.
øw
, 
°©us
);

428 i‡(!
sûít_Áû
)

429 
mˇ°
->
logcou¡
++;

432 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

433 
mˇ°
->
backoff
 >= 2) {

443 
mˇ°
->
backoff
 = 1;

444 
	`√tif_tx_lock_bh
(
dev
);

445 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
)) {

446 ++
dev
->
°©s
.
tx_dr›≥d
;

447 
	`dev_k‰ì_skb_™y
(
	`skb_dequeue
(&
mˇ°
->
pkt_queue
));

449 
	`√tif_tx_u∆ock_bh
(
dev
);

451 
	`•ö_lock_úq
(&
¥iv
->
lock
);

453 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

454 
out_locked
;

457 
out
:

458 
	`•ö_lock_úq
(&
¥iv
->
lock
);

459 
out_locked
:

464 i‡(
°©us
)

465 
mˇ°
->
mc
 = 
NULL
;

467 
mˇ°
->
mc
 = 
mu…iˇ°
;

468 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

469 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

470 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

472  
°©us
;

473 
	}
}

478 
	$ùoib_mˇ°_joö
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

480 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

481 
ib_ß_mu…iˇ°
 *
mu…iˇ°
;

482 
ib_ß_mcmembî_ªc
 
ªc
 = {

483 .
joö_°©e
 = 1

485 
ib_ß_comp_mask
 
comp_mask
;

486 
ªt
 = 0;

488 i‡(!
¥iv
->
brﬂdˇ°
 ||

489 !
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

490  -
EINVAL
;

492 
	`öô_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

493 
	`£t_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

495 
	`ùoib_dbg_mˇ°
(
¥iv
, "joöög MGID %pI6\n", 
mˇ°
->
mcmembî
.
mgid
.
øw
);

497 
ªc
.
mgid
 = 
mˇ°
->
mcmembî
.mgid;

498 
ªc
.
p‹t_gid
 = 
¥iv
->
loˇl_gid
;

499 
ªc
.
pkey
 = 
	`˝u_to_be16
(
¥iv
->pkey);

501 
comp_mask
 =

502 
IB_SA_MCMEMBER_REC_MGID
 |

503 
IB_SA_MCMEMBER_REC_PORT_GID
 |

504 
IB_SA_MCMEMBER_REC_PKEY
 |

505 
IB_SA_MCMEMBER_REC_JOIN_STATE
;

507 i‡(
mˇ°
 !
¥iv
->
brﬂdˇ°
) {

515 
comp_mask
 |=

516 
IB_SA_MCMEMBER_REC_QKEY
 |

517 
IB_SA_MCMEMBER_REC_MTU_SELECTOR
 |

518 
IB_SA_MCMEMBER_REC_MTU
 |

519 
IB_SA_MCMEMBER_REC_TRAFFIC_CLASS
 |

520 
IB_SA_MCMEMBER_REC_RATE_SELECTOR
 |

521 
IB_SA_MCMEMBER_REC_RATE
 |

522 
IB_SA_MCMEMBER_REC_SL
 |

523 
IB_SA_MCMEMBER_REC_FLOW_LABEL
 |

524 
IB_SA_MCMEMBER_REC_HOP_LIMIT
;

526 
ªc
.
qkey
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.qkey;

527 
ªc
.
mtu_£À˘‹
 = 
IB_SA_EQ
;

528 
ªc
.
mtu
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.mtu;

529 
ªc
.
åaffic_˛ass
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.traffic_class;

530 
ªc
.
øã_£À˘‹
 = 
IB_SA_EQ
;

531 
ªc
.
øã
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.rate;

532 
ªc
.
¶
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.sl;

533 
ªc
.
Êow_œbñ
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.flow_label;

534 
ªc
.
h›_limô
 = 
¥iv
->
brﬂdˇ°
->
mcmembî
.hop_limit;

547 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) &&

548 
¥iv
->
sm_fuŒmembî_£nd⁄ly_suµ‹t
)

550 
ªc
.
joö_°©e
 = 
SENDONLY_FULLMEMBER_JOIN
;

552 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

554 
mu…iˇ°
 = 
	`ib_ß_joö_mu…iˇ°
(&
ùoib_ß_˛õ¡
, 
¥iv
->
ˇ
,Öriv->
p‹t
,

555 &
ªc
, 
comp_mask
, 
GFP_KERNEL
,

556 
ùoib_mˇ°_joö_com∂ëe
, 
mˇ°
);

557 
	`•ö_lock_úq
(&
¥iv
->
lock
);

558 i‡(
	`IS_ERR
(
mu…iˇ°
)) {

559 
ªt
 = 
	`PTR_ERR
(
mu…iˇ°
);

560 
	`ùoib_w¨n
(
¥iv
, "ib_ß_joö_mu…iˇ° faûed, sètu†%d\n", 
ªt
);

562 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
mˇ°
, 1);

563 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
);

564 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

565 
	`com∂ëe
(&
mˇ°
->
d⁄e
);

566 
	`•ö_lock_úq
(&
¥iv
->
lock
);

569 
	}
}

571 
	$ùoib_mˇ°_joö_èsk
(
w‹k_°ru˘
 *
w‹k
)

573 
ùoib_dev_¥iv
 *
¥iv
 =

574 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
mˇ°_èsk
.work);

575 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

576 
ib_p‹t_©å
 
p‹t_©å
;

577 
dñay_u¡û
 = 0;

578 
ùoib_mˇ°
 *
mˇ°
 = 
NULL
;

580 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

583 i‡(
	`ib_quîy_p‹t
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
p‹t_©å
)) {

584 
	`ùoib_dbg
(
¥iv
, "ib_query_port() failed\n");

587 i‡(
p‹t_©å
.
°©e
 !
IB_PORT_ACTIVE
) {

588 
	`ùoib_dbg
(
¥iv
, "port state isÇot ACTIVE (state = %d) suspending joinÅask\n",

589 
p‹t_©å
.
°©e
);

592 
¥iv
->
loˇl_lid
 = 
p‹t_©å
.
lid
;

593 
	`√tif_addr_lock_bh
(
dev
);

595 i‡(!
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

596 
	`√tif_addr_u∆ock_bh
(
dev
);

599 
	`√tif_addr_u∆ock_bh
(
dev
);

601 
	`•ö_lock_úq
(&
¥iv
->
lock
);

602 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

603 
out
;

605 i‡(!
¥iv
->
brﬂdˇ°
) {

606 
ùoib_mˇ°
 *
brﬂdˇ°
;

608 
brﬂdˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

609 i‡(!
brﬂdˇ°
) {

610 
	`ùoib_w¨n
(
¥iv
, "failedÅoállocate broadcast group\n");

617 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 1);

618 
out
;

621 
	`mem˝y
(
brﬂdˇ°
->
mcmembî
.
mgid
.
øw
, 
¥iv
->
dev
->broadcast + 4,

622  (
ib_gid
));

623 
¥iv
->
brﬂdˇ°
 = broadcast;

625 
	`__ùoib_mˇ°_add
(
dev
, 
¥iv
->
brﬂdˇ°
);

628 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

629 i‡(
	`IS_ERR_OR_NULL
(
¥iv
->
brﬂdˇ°
->
mc
) &&

630 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

631 
mˇ°
 = 
¥iv
->
brﬂdˇ°
;

632 i‡(
mˇ°
->
backoff
 > 1 &&

633 
	`time_bef‹e
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

634 
dñay_u¡û
 = 
mˇ°
->delay_until;

635 
mˇ°
 = 
NULL
;

638 
out
;

645 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

646 i‡(
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
) &&

647 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
) &&

648 (!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
) ||

649 !
	`skb_queue_em±y
(&
mˇ°
->
pkt_queue
))) {

650 i‡(
mˇ°
->
backoff
 == 1 ||

651 
	`time_a·î_eq
(
jiffõs
, 
mˇ°
->
dñay_u¡û
)) {

653 i‡(
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
)) {

654 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

657 } i‡(!
dñay_u¡û
 ||

658 
	`time_bef‹e
(
mˇ°
->
dñay_u¡û
, delay_until))

659 
dñay_u¡û
 = 
mˇ°
->delay_until;

663 
mˇ°
 = 
NULL
;

664 
	`ùoib_dbg_mˇ°
(
¥iv
, "successfully startedáll multicast joins\n");

666 
out
:

667 i‡(
dñay_u¡û
) {

668 
	`ˇn˚l_dñayed_w‹k
(&
¥iv
->
mˇ°_èsk
);

669 
	`queue_dñayed_w‹k
(
¥iv
->
wq
, &¥iv->
mˇ°_èsk
,

670 
dñay_u¡û
 - 
jiffõs
);

672 i‡(
mˇ°
)

673 
	`ùoib_mˇ°_joö
(
dev
, 
mˇ°
);

675 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

676 
	}
}

678 
	$ùoib_mˇ°_°¨t_thªad
(
√t_devi˚
 *
dev
)

680 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

681 
Êags
;

683 
	`ùoib_dbg_mˇ°
(
¥iv
, "starting multicastÅhread\n");

685 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

686 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

687 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

688 
	}
}

690 
	$ùoib_mˇ°_°›_thªad
(
√t_devi˚
 *
dev
)

692 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

694 
	`ùoib_dbg_mˇ°
(
¥iv
, "stopping multicastÅhread\n");

696 
	`ˇn˚l_dñayed_w‹k_sync
(&
¥iv
->
mˇ°_èsk
);

699 
	}
}

701 
	$ùoib_mˇ°_Àave
(
√t_devi˚
 *
dev
, 
ùoib_mˇ°
 *
mˇ°
)

703 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

704 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

705 
ªt
 = 0;

707 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

708 
	`ùoib_w¨n
(
¥iv
, "ipoib_mcast_leave onán in-flight join\n");

710 i‡(!
	`IS_ERR_OR_NULL
(
mˇ°
->
mc
))

711 
	`ib_ß_‰ì_mu…iˇ°
(
mˇ°
->
mc
);

713 i‡(
	`ã°_™d_˛ór_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
mˇ°
->
Êags
)) {

714 
	`ùoib_dbg_mˇ°
(
¥iv
, "leaving MGID %pI6\n",

715 
mˇ°
->
mcmembî
.
mgid
.
øw
);

718 
ªt
 = 
∫
->
	`dëach_mˇ°
(
dev
, 
¥iv
->
ˇ
, &
mˇ°
->
mcmembî
.
mgid
,

719 
	`be16_to_˝u
(
mˇ°
->
mcmembî
.
mlid
));

720 i‡(
ªt
)

721 
	`ùoib_w¨n
(
¥iv
, "ib_dëach_mˇ° faûed (ªsu… = %d)\n", 
ªt
);

722 } i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
))

723 
	`ùoib_dbg
(
¥iv
, "leaving withÇo mcmember butÇotá "

727 
	}
}

733 
	$ùoib_check_™d_add_mˇ°_£nd⁄ly
(
ùoib_dev_¥iv
 *
¥iv
, 
u8
 *
mgid
,

734 
li°_hód
 *
ªmove_li°
)

737 i‡(*
mgid
 == 0xff) {

738 
ùoib_mˇ°
 *
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
¥iv
->
dev
, 
mgid
);

740 i‡(
mˇ°
 && 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

741 
	`li°_dñ
(&
mˇ°
->
li°
);

742 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

743 
	`li°_add_èû
(&
mˇ°
->
li°
, 
ªmove_li°
);

746 
	}
}

748 
	$ùoib_mˇ°_ªmove_li°
(
li°_hód
 *
ªmove_li°
)

750 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

756 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
)

757 i‡(
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
))

758 
	`waô_f‹_com∂ëi⁄
(&
mˇ°
->
d⁄e
);

760 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, 
ªmove_li°
, 
li°
) {

761 
	`ùoib_mˇ°_Àave
(
mˇ°
->
dev
, mcast);

762 
	`ùoib_mˇ°_‰ì
(
mˇ°
);

764 
	}
}

766 
	$ùoib_mˇ°_£nd
(
√t_devi˚
 *
dev
, 
u8
 *
daddr
, 
sk_buff
 *
skb
)

768 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

769 
rdma_√tdev
 *
∫
 = 
	`√tdev_¥iv
(
dev
);

770 
ùoib_mˇ°
 *
mˇ°
;

771 
Êags
;

772 *
mgid
 = 
daddr
 + 4;

774 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

776 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
) ||

777 !
¥iv
->
brﬂdˇ°
 ||

778 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_ATTACHED
, &
¥iv
->
brﬂdˇ°
->
Êags
)) {

779 ++
dev
->
°©s
.
tx_dr›≥d
;

780 
	`dev_k‰ì_skb_™y
(
skb
);

781 
u∆ock
;

784 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, 
mgid
);

785 i‡(!
mˇ°
 || !mˇ°->
ah
) {

786 i‡(!
mˇ°
) {

788 
	`ùoib_dbg_mˇ°
(
¥iv
, "setting up send only multicast group for %pI6\n",

789 
mgid
);

791 
mˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

792 i‡(!
mˇ°
) {

793 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory "

795 ++
dev
->
°©s
.
tx_dr›≥d
;

796 
	`dev_k‰ì_skb_™y
(
skb
);

797 
u∆ock
;

800 
	`£t_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
);

801 
	`mem˝y
(
mˇ°
->
mcmembî
.
mgid
.
øw
, mgid,

802  (
ib_gid
));

803 
	`__ùoib_mˇ°_add
(
dev
, 
mˇ°
);

804 
	`li°_add_èû
(&
mˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

806 i‡(
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
Ë< 
IPOIB_MAX_MCAST_QUEUE
) {

808 
	`skb_push
(
skb
, (
ùoib_p£udo_hódî
));

809 
	`skb_queue_èû
(&
mˇ°
->
pkt_queue
, 
skb
);

811 ++
dev
->
°©s
.
tx_dr›≥d
;

812 
	`dev_k‰ì_skb_™y
(
skb
);

814 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_BUSY
, &
mˇ°
->
Êags
)) {

815 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

818 
ùoib_√igh
 *
√igh
;

820 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

821 
√igh
 = 
	`ùoib_√igh_gë
(
dev
, 
daddr
);

822 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

823 i‡(!
√igh
) {

824 
√igh
 = 
	`ùoib_√igh_Æloc
(
daddr
, 
dev
);

828 i‡(
√igh
 && 
	`li°_em±y
(&√igh->
li°
)) {

829 
	`kªf_gë
(&
mˇ°
->
ah
->
ªf
);

830 
√igh
->
ah
 = 
mˇ°
->ah;

831 
√igh
->
ah
->
vÆid
 = 1;

832 
	`li°_add_èû
(&
√igh
->
li°
, &
mˇ°
->
√igh_li°
);

835 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

836 
mˇ°
->
ah
->
œ°_£nd
 = 
∫
->
	`£nd
(
dev
, 
skb
, mcast->ah->ah,

837 
IB_MULTICAST_QPN
);

838 i‡(
√igh
)

839 
	`ùoib_√igh_put
(
√igh
);

843 
u∆ock
:

844 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

845 
	}
}

847 
	$ùoib_mˇ°_dev_Êush
(
√t_devi˚
 *
dev
)

849 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

850 
	`LIST_HEAD
(
ªmove_li°
);

851 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

852 
Êags
;

854 
	`muãx_lock
(&
¥iv
->
mˇ°_muãx
);

855 
	`ùoib_dbg_mˇ°
(
¥iv
, "flushing multicastÜist\n");

857 
	`•ö_lock_úqßve
(&
¥iv
->
lock
, 
Êags
);

859 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

860 
	`li°_dñ
(&
mˇ°
->
li°
);

861 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

862 
	`li°_add_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

865 i‡(
¥iv
->
brﬂdˇ°
) {

866 
	`rb_îa£
(&
¥iv
->
brﬂdˇ°
->
rb_node
, &¥iv->
mu…iˇ°_åì
);

867 
	`li°_add_èû
(&
¥iv
->
brﬂdˇ°
->
li°
, &
ªmove_li°
);

868 
¥iv
->
brﬂdˇ°
 = 
NULL
;

871 
	`•ö_u∆ock_úqª°‹e
(&
¥iv
->
lock
, 
Êags
);

873 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

874 
	`muãx_u∆ock
(&
¥iv
->
mˇ°_muãx
);

875 
	}
}

877 
	$ùoib_mˇ°_addr_is_vÆid
(c⁄° 
u8
 *
addr
, c⁄° u8 *
brﬂdˇ°
)

880 i‡(
	`memcmp
(
addr
, 
brﬂdˇ°
, 6))

883 i‡(
	`memcmp
(
addr
 + 7, 
brﬂdˇ°
 + 7, 3))

886 
	}
}

888 
	$ùoib_mˇ°_ª°¨t_èsk
(
w‹k_°ru˘
 *
w‹k
)

890 
ùoib_dev_¥iv
 *
¥iv
 =

891 
	`c⁄èöî_of
(
w‹k
, 
ùoib_dev_¥iv
, 
ª°¨t_èsk
);

892 
√t_devi˚
 *
dev
 = 
¥iv
->dev;

893 
√tdev_hw_addr
 *
ha
;

894 
ùoib_mˇ°
 *
mˇ°
, *
tmˇ°
;

895 
	`LIST_HEAD
(
ªmove_li°
);

896 
ib_ß_mcmembî_ªc
 
ªc
;

898 i‡(!
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
))

905 
	`ùoib_dbg_mˇ°
(
¥iv
, "restarting multicastÅask\n");

907 
	`√tif_addr_lock_bh
(
dev
);

908 
	`•ö_lock_úq
(&
¥iv
->
lock
);

917 
	`li°_f‹_óch_íåy
(
mˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
)

918 
	`˛ór_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

921 
	`√tdev_f‹_óch_mc_addr
(
ha
, 
dev
) {

922 
ib_gid
 
mgid
;

924 i‡(!
	`ùoib_mˇ°_addr_is_vÆid
(
ha
->
addr
, 
dev
->
brﬂdˇ°
))

927 
	`mem˝y
(
mgid
.
øw
, 
ha
->
addr
 + 4, (mgid));

929 
mˇ°
 = 
	`__ùoib_mˇ°_föd
(
dev
, &
mgid
);

930 i‡(!
mˇ°
 || 
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &mˇ°->
Êags
)) {

931 
ùoib_mˇ°
 *
nmˇ°
;

934 i‡(
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
) &&

935 !
	`ib_ß_gë_mcmembî_ªc
(
¥iv
->
ˇ
,Öriv->
p‹t
, &
mgid
, &
ªc
)) {

936 
	`ùoib_dbg_mˇ°
(
¥iv
, "ignoring multicastÉntry for mgid %pI6\n",

937 
mgid
.
øw
);

942 
	`ùoib_dbg_mˇ°
(
¥iv
, "adding multicastÉntry for mgid %pI6\n",

943 
mgid
.
øw
);

945 
nmˇ°
 = 
	`ùoib_mˇ°_Æloc
(
dev
, 0);

946 i‡(!
nmˇ°
) {

947 
	`ùoib_w¨n
(
¥iv
, "unableÅoállocate memory for multicast structure\n");

951 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
nmˇ°
->
Êags
);

953 
nmˇ°
->
mcmembî
.
mgid
 = mgid;

955 i‡(
mˇ°
) {

957 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

959 
	`rb_ª∂a˚_node
(&
mˇ°
->
rb_node
,

960 &
nmˇ°
->
rb_node
,

961 &
¥iv
->
mu…iˇ°_åì
);

963 
	`__ùoib_mˇ°_add
(
dev
, 
nmˇ°
);

965 
	`li°_add_èû
(&
nmˇ°
->
li°
, &
¥iv
->
mu…iˇ°_li°
);

968 i‡(
mˇ°
)

969 
	`£t_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
);

973 
	`li°_f‹_óch_íåy_ß„
(
mˇ°
, 
tmˇ°
, &
¥iv
->
mu…iˇ°_li°
, 
li°
) {

974 i‡(!
	`ã°_bô
(
IPOIB_MCAST_FLAG_FOUND
, &
mˇ°
->
Êags
) &&

975 !
	`ã°_bô
(
IPOIB_MCAST_FLAG_SENDONLY
, &
mˇ°
->
Êags
)) {

976 
	`ùoib_dbg_mˇ°
(
¥iv
, "deleting multicast group %pI6\n",

977 
mˇ°
->
mcmembî
.
mgid
.
øw
);

979 
	`rb_îa£
(&
mˇ°
->
rb_node
, &
¥iv
->
mu…iˇ°_åì
);

982 
	`li°_move_èû
(&
mˇ°
->
li°
, &
ªmove_li°
);

986 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

987 
	`√tif_addr_u∆ock_bh
(
dev
);

989 
	`ùoib_mˇ°_ªmove_li°
(&
ªmove_li°
);

994 i‡(
	`ã°_bô
(
IPOIB_FLAG_OPER_UP
, &
¥iv
->
Êags
)) {

995 
	`•ö_lock_úq
(&
¥iv
->
lock
);

996 
	`__ùoib_mˇ°_scheduÀ_joö_thªad
(
¥iv
, 
NULL
, 0);

997 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

999 
	}
}

1001 #ifde‡
CONFIG_INFINIBAND_IPOIB_DEBUG


1003 
ùoib_mˇ°_ôî
 *
	$ùoib_mˇ°_ôî_öô
(
√t_devi˚
 *
dev
)

1005 
ùoib_mˇ°_ôî
 *
ôî
;

1007 
ôî
 = 
	`kmÆloc
((*ôî), 
GFP_KERNEL
);

1008 i‡(!
ôî
)

1009  
NULL
;

1011 
ôî
->
dev
 = dev;

1012 
	`mem£t
(
ôî
->
mgid
.
øw
, 0, 16);

1014 i‡(
	`ùoib_mˇ°_ôî_√xt
(
ôî
)) {

1015 
	`k‰ì
(
ôî
);

1016  
NULL
;

1019  
ôî
;

1020 
	}
}

1022 
	$ùoib_mˇ°_ôî_√xt
(
ùoib_mˇ°_ôî
 *
ôî
)

1024 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
ôî
->
dev
);

1025 
rb_node
 *
n
;

1026 
ùoib_mˇ°
 *
mˇ°
;

1027 
ªt
 = 1;

1029 
	`•ö_lock_úq
(&
¥iv
->
lock
);

1031 
n
 = 
	`rb_fú°
(&
¥iv
->
mu…iˇ°_åì
);

1033 
n
) {

1034 
mˇ°
 = 
	`rb_íåy
(
n
, 
ùoib_mˇ°
, 
rb_node
);

1036 i‡(
	`memcmp
(
ôî
->
mgid
.
øw
, 
mˇ°
->
mcmembî
.mgid.raw,

1037  (
ib_gid
)) < 0) {

1038 
ôî
->
mgid
 = 
mˇ°
->
mcmembî
.mgid;

1039 
ôî
->
¸óãd
 = 
mˇ°
->created;

1040 
ôî
->
queuñí
 = 
	`skb_queue_Àn
(&
mˇ°
->
pkt_queue
);

1041 
ôî
->
com∂ëe
 = !!
mˇ°
->
ah
;

1042 
ôî
->
£nd_⁄ly
 = !!(
mˇ°
->
Êags
 & (1 << 
IPOIB_MCAST_FLAG_SENDONLY
));

1044 
ªt
 = 0;

1049 
n
 = 
	`rb_√xt
(n);

1052 
	`•ö_u∆ock_úq
(&
¥iv
->
lock
);

1054  
ªt
;

1055 
	}
}

1057 
	$ùoib_mˇ°_ôî_ªad
(
ùoib_mˇ°_ôî
 *
ôî
,

1058 
ib_gid
 *
mgid
,

1059 *
¸óãd
,

1060 *
queuñí
,

1061 *
com∂ëe
,

1062 *
£nd_⁄ly
)

1064 *
mgid
 = 
ôî
->mgid;

1065 *
¸óãd
 = 
ôî
->created;

1066 *
queuñí
 = 
ôî
->queuelen;

1067 *
com∂ëe
 = 
ôî
->complete;

1068 *
£nd_⁄ly
 = 
ôî
->send_only;

1069 
	}
}

	@SLES15SP2/ipoib/ipoib_netlink.c

33 
	~<löux/√tdevi˚.h
>

34 
	~<löux/if_¨p.h
>

35 
	~<löux/moduÀ.h
>

36 
	~<√t/π√éök.h
>

37 
	~"ùoib.h
"

39 c⁄° 
∆a_pﬁicy
 
	gùoib_pﬁicy
[
IFLA_IPOIB_MAX
 + 1] = {

40 [
IFLA_IPOIB_PKEY
] = { .
ty≥
 = 
NLA_U16
 },

41 [
IFLA_IPOIB_MODE
] = { .
ty≥
 = 
NLA_U16
 },

42 [
IFLA_IPOIB_UMCAST
] = { .
ty≥
 = 
NLA_U16
 },

45 
	$ùoib_fûl_öfo
(
sk_buff
 *
skb
, c⁄° 
√t_devi˚
 *
dev
)

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

48 
u16
 
vÆ
;

50 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_PKEY
, 
¥iv
->
pkey
))

51 
∆a_put_Áûuª
;

53 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_ADMIN_CM
, &
¥iv
->
Êags
);

54 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_MODE
, 
vÆ
))

55 
∆a_put_Áûuª
;

57 
vÆ
 = 
	`ã°_bô
(
IPOIB_FLAG_UMCAST
, &
¥iv
->
Êags
);

58 i‡(
	`∆a_put_u16
(
skb
, 
IFLA_IPOIB_UMCAST
, 
vÆ
))

59 
∆a_put_Áûuª
;

63 
∆a_put_Áûuª
:

64  -
EMSGSIZE
;

65 
	}
}

67 
	$ùoib_ch™gñök
(
√t_devi˚
 *
dev
, 
∆©å
 *
tb
[],

68 
∆©å
 *
d©a
[],

69 
√éök_ext_ack
 *
exèck
)

71 
u16
 
mode
, 
umˇ°
;

72 
ªt
 = 0;

74 i‡(
d©a
[
IFLA_IPOIB_MODE
]) {

75 
mode
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_MODE
]);

76 i‡(
mode
 =
IPOIB_MODE_DATAGRAM
)

77 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "datagram\n");

78 i‡(
mode
 =
IPOIB_MODE_CONNECTED
)

79 
ªt
 = 
	`ùoib_£t_mode
(
dev
, "connected\n");

81 
ªt
 = -
EINVAL
;

83 i‡(
ªt
 < 0)

84 
out_îr
;

87 i‡(
d©a
[
IFLA_IPOIB_UMCAST
]) {

88 
umˇ°
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_UMCAST
]);

89 
	`ùoib_£t_umˇ°
(
dev
, 
umˇ°
);

92 
out_îr
:

93  
ªt
;

94 
	}
}

96 
	$ùoib_√w_chûd_lök
(
√t
 *
§c_√t
, 
√t_devi˚
 *
dev
,

97 
∆©å
 *
tb
[], ∆©å *
d©a
[],

98 
√éök_ext_ack
 *
exèck
)

100 
√t_devi˚
 *
pdev
;

101 
ùoib_dev_¥iv
 *
µriv
;

102 
u16
 
chûd_pkey
;

103 
îr
;

105 i‡(!
tb
[
IFLA_LINK
])

106  -
EINVAL
;

108 
pdev
 = 
	`__dev_gë_by_ödex
(
§c_√t
, 
	`∆a_gë_u32
(
tb
[
IFLA_LINK
]));

109 i‡(!
pdev
 ||Ödev->
ty≥
 !
ARPHRD_INFINIBAND
)

110  -
ENODEV
;

112 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

114 i‡(
	`ã°_bô
(
IPOIB_FLAG_SUBINTERFACE
, &
µriv
->
Êags
)) {

115 
	`ùoib_w¨n
(
µriv
, "child creation disallowed for child devices\n");

116  -
EINVAL
;

119 i‡(!
d©a
 || !d©a[
IFLA_IPOIB_PKEY
]) {

120 
	`ùoib_dbg
(
µriv
, "noÖkey specified, usingÖarentÖkey\n");

121 
chûd_pkey
 = 
µriv
->
pkey
;

123 
chûd_pkey
 = 
	`∆a_gë_u16
(
d©a
[
IFLA_IPOIB_PKEY
]);

125 
îr
 = 
	`ùoib_ötf_öô
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
dev
->
«me
, dev);

126 i‡(
îr
) {

127 
	`ùoib_w¨n
(
µriv
, "failedÅo initializeÖkey device\n");

128  
îr
;

131 
îr
 = 
	`__ùoib_vœn_add
(
µriv
, 
	`ùoib_¥iv
(
dev
),

132 
chûd_pkey
, 
IPOIB_RTNL_CHILD
);

133 i‡(
îr
)

134  
îr
;

136 i‡(
d©a
) {

137 
îr
 = 
	`ùoib_ch™gñök
(
dev
, 
tb
, 
d©a
, 
exèck
);

138 i‡(
îr
) {

139 
	`uƒegi°î_√tdevi˚
(
dev
);

140  
îr
;

145 
	}
}

147 
size_t
 
	$ùoib_gë_size
(c⁄° 
√t_devi˚
 *
dev
)

149  
	`∆a_tŸÆ_size
(2) +

150 
	`∆a_tŸÆ_size
(2) +

151 
	`∆a_tŸÆ_size
(2);

152 
	}
}

154 
π∆_lök_›s
 
ùoib_lök_›s
 
	g__ªad_mo°ly
 = {

155 .
köd
 = "ipoib",

156 .
	gmaxty≥
 = 
IFLA_IPOIB_MAX
,

157 .
	gpﬁicy
 = 
ùoib_pﬁicy
,

158 .
	g¥iv_size
 = (
ùoib_dev_¥iv
),

159 .
	g£tup
 = 
ùoib_£tup_comm⁄
,

160 .
	g√wlök
 = 
ùoib_√w_chûd_lök
,

161 .
	gch™gñök
 = 
ùoib_ch™gñök
,

162 .
	ggë_size
 = 
ùoib_gë_size
,

163 .
	gfûl_öfo
 = 
ùoib_fûl_öfo
,

166 
π∆_lök_›s
 *
	$ùoib_gë_lök_›s
()

168  &
ùoib_lök_›s
;

169 
	}
}

171 
__öô
 
	$ùoib_√éök_öô
()

173  
	`π∆_lök_ªgi°î
(&
ùoib_lök_›s
);

174 
	}
}

176 
__exô
 
	$ùoib_√éök_föi
()

178 
	`π∆_lök_uƒegi°î
(&
ùoib_lök_›s
);

179 
	}
}

181 
MODULE_ALIAS_RTNL_LINK
("ipoib");

	@SLES15SP2/ipoib/ipoib_verbs.c

34 
	~<löux/¶ab.h
>

36 
	~"ùoib.h
"

38 
	$ùoib_mˇ°_©èch
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

39 
ib_gid
 *
mgid
, 
u16
 
mlid
, 
£t_qkey
, 
u32
 
qkey
)

41 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

42 
ib_qp_©å
 *
qp_©å
 = 
NULL
;

43 
ªt
;

44 
u16
 
pkey_ödex
;

46 i‡(
	`ib_föd_pkey
(
¥iv
->
ˇ
,Öriv->
p‹t
,Öriv->
pkey
, &
pkey_ödex
)) {

47 
	`˛ór_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

48 
ªt
 = -
ENXIO
;

49 
out
;

51 
	`£t_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
);

53 i‡(
£t_qkey
) {

54 
ªt
 = -
ENOMEM
;

55 
qp_©å
 = 
	`kmÆloc
((*qp_©å), 
GFP_KERNEL
);

56 i‡(!
qp_©å
)

57 
out
;

60 
qp_©å
->
qkey
 = qkey;

61 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, 
qp_©å
, 
IB_QP_QKEY
);

62 i‡(
ªt
) {

63 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QP,Ñë = %d\n", 
ªt
);

64 
out
;

69 
ªt
 = 
	`ib_©èch_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

70 i‡(
ªt
)

71 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿ©èchÅÿmu…iˇ° group,Ñë = %d\n", 
ªt
);

73 
out
:

74 
	`k‰ì
(
qp_©å
);

75  
ªt
;

76 
	}
}

78 
	$ùoib_mˇ°_dëach
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
hˇ
,

79 
ib_gid
 *
mgid
, 
u16
 
mlid
)

81 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

82 
ªt
;

84 
ªt
 = 
	`ib_dëach_mˇ°
(
¥iv
->
qp
, 
mgid
, 
mlid
);

86  
ªt
;

87 
	}
}

89 
	$ùoib_öô_qp
(
√t_devi˚
 *
dev
)

91 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

92 
ªt
;

93 
ib_qp_©å
 
qp_©å
;

94 
©å_mask
;

96 i‡(!
	`ã°_bô
(
IPOIB_PKEY_ASSIGNED
, &
¥iv
->
Êags
))

99 
qp_©å
.
qp_°©e
 = 
IB_QPS_INIT
;

100 
qp_©å
.
qkey
 = 0;

101 
qp_©å
.
p‹t_num
 = 
¥iv
->
p‹t
;

102 
qp_©å
.
pkey_ödex
 = 
¥iv
->pkey_index;

103 
©å_mask
 =

104 
IB_QP_QKEY
 |

105 
IB_QP_PORT
 |

106 
IB_QP_PKEY_INDEX
 |

107 
IB_QP_STATE
;

108 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

109 i‡(
ªt
) {

110 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿöô,Ñë = %d\n", 
ªt
);

111 
out_Áû
;

114 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTR
;

116 
©å_mask
 &~
IB_QP_PORT
;

117 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

118 i‡(
ªt
) {

119 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTR,Ñë = %d\n", 
ªt
);

120 
out_Áû
;

123 
qp_©å
.
qp_°©e
 = 
IB_QPS_RTS
;

124 
qp_©å
.
sq_p¢
 = 0;

125 
©å_mask
 |
IB_QP_SQ_PSN
;

126 
©å_mask
 &~
IB_QP_PKEY_INDEX
;

127 
ªt
 = 
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
©å_mask
);

128 i‡(
ªt
) {

129 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿmodify QPÅÿRTS,Ñë = %d\n", 
ªt
);

130 
out_Áû
;

135 
out_Áû
:

136 
qp_©å
.
qp_°©e
 = 
IB_QPS_RESET
;

137 i‡(
	`ib_modify_qp
(
¥iv
->
qp
, &
qp_©å
, 
IB_QP_STATE
))

138 
	`ùoib_w¨n
(
¥iv
, "FailedÅo modify QPÅo RESET state\n");

140  
ªt
;

141 
	}
}

143 
	$ùoib_å™•‹t_dev_öô
(
√t_devi˚
 *
dev
, 
ib_devi˚
 *
ˇ
)

145 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

146 
ib_qp_öô_©å
 
öô_©å
 = {

147 .
ˇp
 = {

148 .
max_£nd_wr
 = 
ùoib_£ndq_size
,

149 .
max_ªcv_wr
 = 
ùoib_ªcvq_size
,

150 .
max_£nd_sge
 = 
	`mö_t
(
u32
, 
¥iv
->
ˇ
->
©ås
.max_send_sge,

151 
MAX_SKB_FRAGS
 + 1),

152 .
max_ªcv_sge
 = 
IPOIB_UD_RX_SG


154 .
sq_sig_ty≥
 = 
IB_SIGNAL_ALL_WR
,

155 .
qp_ty≥
 = 
IB_QPT_UD


157 
ib_cq_öô_©å
 
cq_©å
 = {};

159 
ªt
, 
size
, 
ªq_vec
;

160 
i
;

162 
size
 = 
ùoib_ªcvq_size
 + 1;

163 
ªt
 = 
	`ùoib_cm_dev_öô
(
dev
);

164 i‡(!
ªt
) {

165 
size
 +
ùoib_£ndq_size
;

166 i‡(
	`ùoib_cm_has_§q
(
dev
))

167 
size
 +
ùoib_ªcvq_size
 + 1;

169 
size
 +
ùoib_ªcvq_size
 * 
ùoib_max_c⁄n_qp
;

171 i‡(
ªt
 !-
EOPNOTSUPP
)

172  
ªt
;

174 
ªq_vec
 = (
¥iv
->
p‹t
 - 1) * 2;

176 
cq_©å
.
cqe
 = 
size
;

177 
cq_©å
.
comp_ve˘‹
 = 
ªq_vec
 % 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

178 
¥iv
->
ªcv_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_rx_com∂ëi⁄
, 
NULL
,

179 
¥iv
, &
cq_©å
);

180 i‡(
	`IS_ERR
(
¥iv
->
ªcv_cq
)) {

181 
	`¥_w¨n
("%s: faûedÅÿ¸óãÑe˚ivêCQ\n", 
ˇ
->
«me
);

182 
out_cm_dev_˛ónup
;

185 
cq_©å
.
cqe
 = 
ùoib_£ndq_size
;

186 
cq_©å
.
comp_ve˘‹
 = (
ªq_vec
 + 1Ë% 
¥iv
->
ˇ
->
num_comp_ve˘‹s
;

187 
¥iv
->
£nd_cq
 = 
	`ib_¸óã_cq
’riv->
ˇ
, 
ùoib_ib_tx_com∂ëi⁄
, 
NULL
,

188 
¥iv
, &
cq_©å
);

189 i‡(
	`IS_ERR
(
¥iv
->
£nd_cq
)) {

190 
	`¥_w¨n
("%s: faûedÅÿ¸óã síd CQ\n", 
ˇ
->
«me
);

191 
out_‰ì_ªcv_cq
;

194 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
ªcv_cq
, 
IB_CQ_NEXT_COMP
))

195 
out_‰ì_£nd_cq
;

197 
öô_©å
.
£nd_cq
 = 
¥iv
->send_cq;

198 
öô_©å
.
ªcv_cq
 = 
¥iv
->recv_cq;

200 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_UD_TSO
)

201 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_IPOIB_UD_LSO
;

203 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
)

204 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_BLOCK_MULTICAST_LOOPBACK
;

206 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_MANAGED_FLOW_STEERING
)

207 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETIF_QP
;

209 i‡(
¥iv
->
hˇ_ˇps
 & 
IB_DEVICE_RDMA_NETDEV
)

210 
öô_©å
.
¸óã_Êags
 |
IB_QP_CREATE_NETDEV_USE
;

212 
¥iv
->
qp
 = 
	`ib_¸óã_qp
’riv->
pd
, &
öô_©å
);

213 i‡(
	`IS_ERR
(
¥iv
->
qp
)) {

214 
	`¥_w¨n
("%s: faûedÅÿ¸óã QP\n", 
ˇ
->
«me
);

215 
out_‰ì_£nd_cq
;

218 i‡(
	`ib_ªq_nŸify_cq
(
¥iv
->
£nd_cq
, 
IB_CQ_NEXT_COMP
))

219 
out_‰ì_£nd_cq
;

221 
i
 = 0; i < 
MAX_SKB_FRAGS
 + 1; ++i)

222 
¥iv
->
tx_sge
[
i
].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

224 
¥iv
->
tx_wr
.
wr
.
›code
 = 
IB_WR_SEND
;

225 
¥iv
->
tx_wr
.
wr
.
sg_li°
 =Öriv->
tx_sge
;

226 
¥iv
->
tx_wr
.
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

228 
¥iv
->
rx_sge
[0].
lkey
 =Öriv->
pd
->
loˇl_dma_lkey
;

230 
¥iv
->
rx_sge
[0].
Àngth
 = 
	`IPOIB_UD_BUF_SIZE
’riv->
max_ib_mtu
);

231 
¥iv
->
rx_wr
.
num_sge
 = 1;

233 
¥iv
->
rx_wr
.
√xt
 = 
NULL
;

234 
¥iv
->
rx_wr
.
sg_li°
 =Öriv->
rx_sge
;

236 i‡(
öô_©å
.
ˇp
.
max_£nd_sge
 > 1)

237 
dev
->
„©uªs
 |
NETIF_F_SG
;

239 
¥iv
->
max_£nd_sge
 = 
öô_©å
.
ˇp
.max_send_sge;

243 
out_‰ì_£nd_cq
:

244 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

246 
out_‰ì_ªcv_cq
:

247 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

249 
out_cm_dev_˛ónup
:

250 
	`ùoib_cm_dev_˛ónup
(
dev
);

252  -
ENODEV
;

253 
	}
}

255 
	$ùoib_å™•‹t_dev_˛ónup
(
√t_devi˚
 *
dev
)

257 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

259 i‡(
¥iv
->
qp
) {

260 i‡(
	`ib_de°roy_qp
(
¥iv
->
qp
))

261 
	`ùoib_w¨n
(
¥iv
, "ib_qp_destroy failed\n");

263 
¥iv
->
qp
 = 
NULL
;

266 
	`ib_de°roy_cq
(
¥iv
->
£nd_cq
);

267 
	`ib_de°roy_cq
(
¥iv
->
ªcv_cq
);

268 
	}
}

270 
	$ùoib_evít
(
ib_evít_h™dÀr
 *
h™dÀr
,

271 
ib_evít
 *
ªc‹d
)

273 
ùoib_dev_¥iv
 *
¥iv
 =

274 
	`c⁄èöî_of
(
h™dÀr
, 
ùoib_dev_¥iv
, 
evít_h™dÀr
);

276 i‡(
ªc‹d
->
ñemít
.
p‹t_num
 !
¥iv
->
p‹t
)

279 
	`ùoib_dbg
(
¥iv
, "Evíà%d o¿devi˚ %†p‹à%d\n", 
ªc‹d
->
evít
,

280 
	`dev_«me
(&
ªc‹d
->
devi˚
->
dev
),Ñec‹d->
ñemít
.
p‹t_num
);

282 i‡(
ªc‹d
->
evít
 =
IB_EVENT_CLIENT_REREGISTER
) {

283 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

284 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PORT_ERR
 ||

285 
ªc‹d
->
evít
 =
IB_EVENT_PORT_ACTIVE
 ||

286 
ªc‹d
->
evít
 =
IB_EVENT_LID_CHANGE
) {

287 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_n‹mÆ
);

288 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_PKEY_CHANGE
) {

289 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_hóvy
);

290 } i‡(
ªc‹d
->
evít
 =
IB_EVENT_GID_CHANGE
 &&

291 !
	`ã°_bô
(
IPOIB_FLAG_DEV_ADDR_SET
, &
¥iv
->
Êags
)) {

292 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
¥iv
->
Êush_light
);

294 
	}
}

	@SLES15SP2/ipoib/ipoib_vlan.c

33 
	~<löux/moduÀ.h
>

34 
	~<löux/sched/sig«l.h
>

36 
	~<löux/öô.h
>

37 
	~<löux/£q_fûe.h
>

39 
	~<löux/uac˚ss.h
>

41 
	~"ùoib.h
"

43 
ssize_t
 
	$show_∑ª¡
(
devi˚
 *
d
, 
devi˚_©åibuã
 *
©å
,

44 *
buf
)

46 
√t_devi˚
 *
dev
 = 
	`to_√t_dev
(
d
);

47 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

49  
	`•rötf
(
buf
, "%s\n", 
¥iv
->
∑ª¡
->
«me
);

50 
	}
}

51 
DEVICE_ATTR
(
∑ª¡
, 
S_IRUGO
, 
show_∑ª¡
, 
NULL
);

53 
boﬁ
 
	$is_chûd_unique
(
ùoib_dev_¥iv
 *
µriv
,

54 
ùoib_dev_¥iv
 *
¥iv
)

56 
ùoib_dev_¥iv
 *
çriv
;

58 
	`ASSERT_RTNL
();

66 i‡(
¥iv
->
chûd_ty≥
 !
IPOIB_LEGACY_CHILD
)

67  
åue
;

74 i‡(
µriv
->
pkey
 =
¥iv
->pkey)

75  
Ál£
;

77 
	`li°_f‹_óch_íåy
(
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

78 i‡(
çriv
->
pkey
 =
¥iv
->pkey &&

79 
çriv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
)

80  
Ál£
;

83  
åue
;

84 
	}
}

95 
	$__ùoib_vœn_add
(
ùoib_dev_¥iv
 *
µriv
, ùoib_dev_¥iv *
¥iv
,

96 
u16
 
pkey
, 
ty≥
)

98 
√t_devi˚
 *
ndev
 = 
¥iv
->
dev
;

99 
ªsu…
;

101 
	`ASSERT_RTNL
();

107 
ndev
->
¥iv_de°ru˘‹
 = 
ùoib_ötf_‰ì
;

113 
	`WARN_ON
(
µriv
->
dev
->
ªg_°©e
 !
NETREG_REGISTERED
);

115 i‡(
pkey
 == 0 ||Ökey == 0x8000) {

116 
ªsu…
 = -
EINVAL
;

117 
out_óæy
;

120 
¥iv
->
∑ª¡
 = 
µriv
->
dev
;

121 
¥iv
->
pkey
 =Ökey;

122 
¥iv
->
chûd_ty≥
 = 
ty≥
;

124 i‡(!
	`is_chûd_unique
(
µriv
, 
¥iv
)) {

125 
ªsu…
 = -
ENOTUNIQ
;

126 
out_óæy
;

129 
ªsu…
 = 
	`ªgi°î_√tdevi˚
(
ndev
);

130 i‡(
ªsu…
) {

131 
	`ùoib_w¨n
(
¥iv
, "ÁûedÅÿöôülize;Éº‹ %i", 
ªsu…
);

137 
out_óæy
;

141 i‡(
ty≥
 =
IPOIB_LEGACY_CHILD
) {

142 i‡(
	`ùoib_cm_add_mode_©å
(
ndev
))

143 
sysfs_Áûed
;

144 i‡(
	`ùoib_add_pkey_©å
(
ndev
))

145 
sysfs_Áûed
;

146 i‡(
	`ùoib_add_umˇ°_©å
(
ndev
))

147 
sysfs_Áûed
;

149 i‡(
	`devi˚_¸óã_fûe
(&
ndev
->
dev
, &
dev_©å_∑ª¡
))

150 
sysfs_Áûed
;

155 
sysfs_Áûed
:

156 
	`uƒegi°î_√tdevi˚
(
¥iv
->
dev
);

157  -
ENOMEM
;

159 
out_óæy
:

160 i‡(
ndev
->
¥iv_de°ru˘‹
)

161 
ndev
->
	`¥iv_de°ru˘‹
(ndev);

162  
ªsu…
;

163 
	}
}

165 
	$ùoib_vœn_add
(
√t_devi˚
 *
pdev
, 
pkey
)

167 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
;

168 
ötf_«me
[
IFNAMSIZ
];

169 
√t_devi˚
 *
ndev
;

170 
ªsu…
;

172 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

173  -
EPERM
;

175 i‡(!
	`π∆_åylock
())

176  
	`ª°¨t_sysˇŒ
();

178 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

179 
	`π∆_u∆ock
();

180  -
EPERM
;

183 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

185 
	`¢¥ötf
(
ötf_«me
, (intf_name), "%s.%04x",

186 
µriv
->
dev
->
«me
, 
pkey
);

188 
ndev
 = 
	`ùoib_ötf_Æloc
(
µriv
->
ˇ
,Ö¥iv->
p‹t
, 
ötf_«me
);

189 i‡(
	`IS_ERR
(
ndev
)) {

190 
ªsu…
 = 
	`PTR_ERR
(
ndev
);

191 
out
;

193 
¥iv
 = 
	`ùoib_¥iv
(
ndev
);

195 
ªsu…
 = 
	`__ùoib_vœn_add
(
µriv
, 
¥iv
, 
pkey
, 
IPOIB_LEGACY_CHILD
);

197 i‡(
ªsu…
 && 
ndev
->
ªg_°©e
 =
NETREG_UNINITIALIZED
)

198 
	`‰ì_√tdev
(
ndev
);

200 
out
:

201 
	`π∆_u∆ock
();

203  
ªsu…
;

204 
	}
}

206 
	sùoib_vœn_dñëe_w‹k
 {

207 
w‹k_°ru˘
 
	mw‹k
;

208 
√t_devi˚
 *
	mdev
;

221 
	$ùoib_vœn_dñëe_èsk
(
w‹k_°ru˘
 *
w‹k
)

223 
ùoib_vœn_dñëe_w‹k
 *
pw‹k
 =

224 
	`c⁄èöî_of
(
w‹k
, 
ùoib_vœn_dñëe_w‹k
, work);

225 
√t_devi˚
 *
dev
 = 
pw‹k
->dev;

227 
	`π∆_lock
();

230 i‡(
dev
->
ªg_°©e
 =
NETREG_REGISTERED
) {

231 
ùoib_dev_¥iv
 *
¥iv
 = 
	`ùoib_¥iv
(
dev
);

232 
ùoib_dev_¥iv
 *
µriv
 = 
	`ùoib_¥iv
(
¥iv
->
∑ª¡
);

234 
	`ùoib_dbg
(
µriv
, "dñëêchûd vœ¿%s\n", 
dev
->
«me
);

235 
	`uƒegi°î_√tdevi˚
(
dev
);

238 
	`π∆_u∆ock
();

240 
	`k‰ì
(
pw‹k
);

241 
	}
}

243 
	$ùoib_vœn_dñëe
(
√t_devi˚
 *
pdev
, 
pkey
)

245 
ùoib_dev_¥iv
 *
µriv
, *
¥iv
, *
çriv
;

246 
rc
;

248 i‡(!
	`ˇ∑bÀ
(
CAP_NET_ADMIN
))

249  -
EPERM
;

251 i‡(!
	`π∆_åylock
())

252  
	`ª°¨t_sysˇŒ
();

254 i‡(
pdev
->
ªg_°©e
 !
NETREG_REGISTERED
) {

255 
	`π∆_u∆ock
();

256  -
EPERM
;

259 
µriv
 = 
	`ùoib_¥iv
(
pdev
);

261 
rc
 = -
ENODEV
;

262 
	`li°_f‹_óch_íåy_ß„
(
¥iv
, 
çriv
, &
µriv
->
chûd_ötfs
, 
li°
) {

263 i‡(
¥iv
->
pkey
 ==Ökey &&

264 
¥iv
->
chûd_ty≥
 =
IPOIB_LEGACY_CHILD
) {

265 
ùoib_vœn_dñëe_w‹k
 *
w‹k
;

267 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_KERNEL
);

268 i‡(!
w‹k
) {

269 
rc
 = -
ENOMEM
;

270 
out
;

273 
	`down_wrôe
(&
µriv
->
vœn_rw£m
);

274 
	`li°_dñ_öô
(&
¥iv
->
li°
);

275 
	`up_wrôe
(&
µriv
->
vœn_rw£m
);

276 
w‹k
->
dev
 = 
¥iv
->dev;

277 
	`INIT_WORK
(&
w‹k
->w‹k, 
ùoib_vœn_dñëe_èsk
);

278 
	`queue_w‹k
(
ùoib_w‹kqueue
, &
w‹k
->work);

280 
rc
 = 0;

285 
out
:

286 
	`π∆_u∆ock
();

288  
rc
;

289 
	}
}

	@
1
.
0
100
2730
RHEL76/ipoib/ipoib.h
RHEL76/ipoib/ipoib_cm.c
RHEL76/ipoib/ipoib_ethtool.c
RHEL76/ipoib/ipoib_fs.c
RHEL76/ipoib/ipoib_ib.c
RHEL76/ipoib/ipoib_main.c
RHEL76/ipoib/ipoib_multicast.c
RHEL76/ipoib/ipoib_netlink.c
RHEL76/ipoib/ipoib_verbs.c
RHEL76/ipoib/ipoib_vlan.c
RHEL77/ipoib/ipoib.h
RHEL77/ipoib/ipoib_cm.c
RHEL77/ipoib/ipoib_ethtool.c
RHEL77/ipoib/ipoib_fs.c
RHEL77/ipoib/ipoib_ib.c
RHEL77/ipoib/ipoib_main.c
RHEL77/ipoib/ipoib_multicast.c
RHEL77/ipoib/ipoib_netlink.c
RHEL77/ipoib/ipoib_verbs.c
RHEL77/ipoib/ipoib_vlan.c
RHEL80/ipoib/ipoib.h
RHEL80/ipoib/ipoib_cm.c
RHEL80/ipoib/ipoib_ethtool.c
RHEL80/ipoib/ipoib_fs.c
RHEL80/ipoib/ipoib_ib.c
RHEL80/ipoib/ipoib_main.c
RHEL80/ipoib/ipoib_multicast.c
RHEL80/ipoib/ipoib_netlink.c
RHEL80/ipoib/ipoib_verbs.c
RHEL80/ipoib/ipoib_vlan.c
RHEL81/ipoib/ipoib.h
RHEL81/ipoib/ipoib_cm.c
RHEL81/ipoib/ipoib_ethtool.c
RHEL81/ipoib/ipoib_fs.c
RHEL81/ipoib/ipoib_ib.c
RHEL81/ipoib/ipoib_main.c
RHEL81/ipoib/ipoib_multicast.c
RHEL81/ipoib/ipoib_netlink.c
RHEL81/ipoib/ipoib_verbs.c
RHEL81/ipoib/ipoib_vlan.c
RHEL82/ipoib/ipoib.h
RHEL82/ipoib/ipoib_cm.c
RHEL82/ipoib/ipoib_ethtool.c
RHEL82/ipoib/ipoib_fs.c
RHEL82/ipoib/ipoib_ib.c
RHEL82/ipoib/ipoib_main.c
RHEL82/ipoib/ipoib_multicast.c
RHEL82/ipoib/ipoib_netlink.c
RHEL82/ipoib/ipoib_verbs.c
RHEL82/ipoib/ipoib_vlan.c
RHEL83/ipoib/ipoib.h
RHEL83/ipoib/ipoib_cm.c
RHEL83/ipoib/ipoib_ethtool.c
RHEL83/ipoib/ipoib_fs.c
RHEL83/ipoib/ipoib_ib.c
RHEL83/ipoib/ipoib_main.c
RHEL83/ipoib/ipoib_multicast.c
RHEL83/ipoib/ipoib_netlink.c
RHEL83/ipoib/ipoib_verbs.c
RHEL83/ipoib/ipoib_vlan.c
SLES12SP4/ipoib/ipoib.h
SLES12SP4/ipoib/ipoib_cm.c
SLES12SP4/ipoib/ipoib_ethtool.c
SLES12SP4/ipoib/ipoib_fs.c
SLES12SP4/ipoib/ipoib_ib.c
SLES12SP4/ipoib/ipoib_main.c
SLES12SP4/ipoib/ipoib_multicast.c
SLES12SP4/ipoib/ipoib_netlink.c
SLES12SP4/ipoib/ipoib_verbs.c
SLES12SP4/ipoib/ipoib_vlan.c
SLES12SP5/ipoib/ipoib.h
SLES12SP5/ipoib/ipoib_cm.c
SLES12SP5/ipoib/ipoib_ethtool.c
SLES12SP5/ipoib/ipoib_fs.c
SLES12SP5/ipoib/ipoib_ib.c
SLES12SP5/ipoib/ipoib_main.c
SLES12SP5/ipoib/ipoib_multicast.c
SLES12SP5/ipoib/ipoib_netlink.c
SLES12SP5/ipoib/ipoib_verbs.c
SLES12SP5/ipoib/ipoib_vlan.c
SLES15SP1/ipoib/ipoib.h
SLES15SP1/ipoib/ipoib_cm.c
SLES15SP1/ipoib/ipoib_ethtool.c
SLES15SP1/ipoib/ipoib_fs.c
SLES15SP1/ipoib/ipoib_ib.c
SLES15SP1/ipoib/ipoib_main.c
SLES15SP1/ipoib/ipoib_multicast.c
SLES15SP1/ipoib/ipoib_netlink.c
SLES15SP1/ipoib/ipoib_verbs.c
SLES15SP1/ipoib/ipoib_vlan.c
SLES15SP2/ipoib/ipoib.h
SLES15SP2/ipoib/ipoib_cm.c
SLES15SP2/ipoib/ipoib_ethtool.c
SLES15SP2/ipoib/ipoib_fs.c
SLES15SP2/ipoib/ipoib_ib.c
SLES15SP2/ipoib/ipoib_main.c
SLES15SP2/ipoib/ipoib_multicast.c
SLES15SP2/ipoib/ipoib_netlink.c
SLES15SP2/ipoib/ipoib_verbs.c
SLES15SP2/ipoib/ipoib_vlan.c
