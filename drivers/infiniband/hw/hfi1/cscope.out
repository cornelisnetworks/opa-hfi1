cscope 15 /local_home/mmarciniszyn/repos/ifs-all/components/Drivers/drivers/infiniband/hw/hfi1               0001998592
	@affinity.c

47 
	~<lšux/tÝÞogy.h
>

48 
	~<lšux/ýumask.h
>

49 
	~<lšux/moduË.h
>

50 
	~<lšux/š‹¼u±.h
>

51 
	~<lšux/numa.h
>

53 
	~"hfi.h
"

54 
	~"affš™y.h
"

55 
	~"sdma.h
"

56 
	~"Œaû.h
"

58 
hfi1_affš™y_node_li¡
 
	gnode_affš™y
 = {

59 .
li¡
 = 
LIST_HEAD_INIT
(
node_affš™y
.list),

60 .
	glock
 = 
__MUTEX_INITIALIZER
(
node_affš™y
.
lock
)

64 cÚ¡ * cÚ¡ 
	gœq_ty³_Çmes
[] = {

73 *
	ghfi1_³r_node_úŒ
;

75 
šlše
 
	$š™_ýu_mask_£t
(
ýu_mask_£t
 *
£t
)

77 
	`ýumask_þ—r
(&
£t
->
mask
);

78 
	`ýumask_þ—r
(&
£t
->
u£d
);

79 
£t
->
g’
 = 0;

80 
	}
}

83 
	$_ýu_mask_£t_g’_šc
(
ýu_mask_£t
 *
£t
)

85 ià(
	`ýumask_equ®
(&
£t
->
mask
, &£t->
u£d
)) {

90 
£t
->
g’
++;

91 
	`ýumask_þ—r
(&
£t
->
u£d
);

93 
	}
}

95 
	$_ýu_mask_£t_g’_dec
(
ýu_mask_£t
 *
£t
)

97 ià(
	`ýumask_em±y
(&
£t
->
u£d
è&& s‘->
g’
) {

98 
£t
->
g’
--;

99 
	`ýumask_cÝy
(&
£t
->
u£d
, &£t->
mask
);

101 
	}
}

104 
	$ýu_mask_£t_g‘_fœ¡
(
ýu_mask_£t
 *
£t
, 
ýumask_v¬_t
 
diff
)

106 
ýu
;

108 ià(!
diff
 || !
£t
)

109  -
EINVAL
;

111 
	`_ýu_mask_£t_g’_šc
(
£t
);

114 
	`ýumask_ªdnÙ
(
diff
, &
£t
->
mask
, &£t->
u£d
);

116 
ýu
 = 
	`ýumask_fœ¡
(
diff
);

117 ià(
ýu
 >ð
Ä_ýu_ids
)

118 
ýu
 = -
EINVAL
;

120 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
u£d
);

122  
ýu
;

123 
	}
}

125 
	$ýu_mask_£t_put
(
ýu_mask_£t
 *
£t
, 
ýu
)

127 ià(!
£t
)

130 
	`ýumask_þ—r_ýu
(
ýu
, &
£t
->
u£d
);

131 
	`_ýu_mask_£t_g’_dec
(
£t
);

132 
	}
}

135 
	$š™_»®_ýu_mask
()

137 
possibË
, 
cu¼_ýu
, 
i
, 
ht
;

139 
	`ýumask_þ—r
(&
node_affš™y
.
»®_ýu_mask
);

142 
	`ýumask_cÝy
(&
node_affš™y
.
»®_ýu_mask
, 
ýu_Úlše_mask
);

147 
possibË
 = 
	`ýumask_weight
(&
node_affš™y
.
»®_ýu_mask
);

148 
ht
 = 
	`ýumask_weight
(
	`tÝÞogy_siblšg_ýumask
(

149 
	`ýumask_fœ¡
(&
node_affš™y
.
»®_ýu_mask
)));

155 
cu¼_ýu
 = 
	`ýumask_fœ¡
(&
node_affš™y
.
»®_ýu_mask
);

156 
i
 = 0; i < 
possibË
 / 
ht
; i++)

157 
cu¼_ýu
 = 
	`ýumask_Ãxt
(cu¼_ýu, &
node_affš™y
.
»®_ýu_mask
);

162 ; 
i
 < 
possibË
; i++) {

163 
	`ýumask_þ—r_ýu
(
cu¼_ýu
, &
node_affš™y
.
»®_ýu_mask
);

164 
cu¼_ýu
 = 
	`ýumask_Ãxt
(cu¼_ýu, &
node_affš™y
.
»®_ýu_mask
);

166 
	}
}

168 
	$node_affš™y_š™
()

170 
node
;

171 
pci_dev
 *
dev
 = 
NULL
;

172 cÚ¡ 
pci_deviû_id
 *
ids
 = 
hfi1_pci_tbl
;

174 
	`ýumask_þ—r
(&
node_affš™y
.
´oc
.
u£d
);

175 
	`ýumask_cÝy
(&
node_affš™y
.
´oc
.
mask
, 
ýu_Úlše_mask
);

177 
node_affš™y
.
´oc
.
g’
 = 0;

178 
node_affš™y
.
num_cÜe_siblšgs
 =

179 
	`ýumask_weight
(
	`tÝÞogy_siblšg_ýumask
(

180 
	`ýumask_fœ¡
(&
node_affš™y
.
´oc
.
mask
)

182 
node_affš™y
.
num_possibË_nodes
 = 
	`num_possibË_nodes
();

183 
node_affš™y
.
num_Úlše_nodes
 = 
	`num_Úlše_nodes
();

184 
node_affš™y
.
num_Úlše_ýus
 = 
	`num_Úlše_ýus
();

191 
	`š™_»®_ýu_mask
();

193 
hfi1_³r_node_úŒ
 = 
	`kÿÎoc
(
node_affš™y
.
num_possibË_nodes
,

194 (*
hfi1_³r_node_úŒ
), 
GFP_KERNEL
);

195 ià(!
hfi1_³r_node_úŒ
)

196  -
ENOMEM
;

198 
ids
->
v’dÜ
) {

199 
dev
 = 
NULL
;

200 (
dev
 = 
	`pci_g‘_deviû
(
ids
->
v’dÜ
, ids->
deviû
, dev))) {

201 
node
 = 
	`pcibus_to_node
(
dev
->
bus
);

202 ià(
node
 < 0)

203 
out
;

205 
hfi1_³r_node_úŒ
[
node
]++;

207 
ids
++;

212 
out
:

217 
	`´_”r
("HFI: Invalid PCI NUMA‚ode. Performance may be‡ffected\n");

218 
	`´_”r
("HFI: System BIOS may‚eedo be upgraded\n");

219 
node
 = 0;‚od< 
node_affš™y
.
num_possibË_nodes
;‚ode++)

220 
hfi1_³r_node_úŒ
[
node
] = 1;

223 
	}
}

225 
	$node_affš™y_de¡roy
(
hfi1_affš™y_node
 *
’Œy
)

227 
	`ä“_³rýu
(
’Œy
->
comp_veù_affš™y
);

228 
	`kä“
(
’Œy
);

229 
	}
}

231 
	$node_affš™y_de¡roy_®l
()

233 
li¡_h—d
 *
pos
, *
q
;

234 
hfi1_affš™y_node
 *
’Œy
;

236 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

237 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
node_affš™y
.
li¡
) {

238 
’Œy
 = 
	`li¡_’Œy
(
pos
, 
hfi1_affš™y_node
,

239 
li¡
);

240 
	`li¡_d–
(
pos
);

241 
	`node_affš™y_de¡roy
(
’Œy
);

243 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

244 
	`kä“
(
hfi1_³r_node_úŒ
);

245 
	}
}

247 
hfi1_affš™y_node
 *
	$node_affš™y_®loÿ‹
(
node
)

249 
hfi1_affš™y_node
 *
’Œy
;

251 
’Œy
 = 
	`kz®loc
((*’Œy), 
GFP_KERNEL
);

252 ià(!
’Œy
)

253  
NULL
;

254 
’Œy
->
node
 =‚ode;

255 
’Œy
->
comp_veù_affš™y
 = 
	`®loc_³rýu
(
u16
);

256 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

258  
’Œy
;

259 
	}
}

265 
	$node_affš™y_add_ž
(
hfi1_affš™y_node
 *
’Œy
)

267 
	`li¡_add_ž
(&
’Œy
->
li¡
, &
node_affš™y
.list);

268 
	}
}

271 
hfi1_affš™y_node
 *
	$node_affš™y_lookup
(
node
)

273 
li¡_h—d
 *
pos
;

274 
hfi1_affš™y_node
 *
’Œy
;

276 
	`li¡_fÜ_—ch
(
pos
, &
node_affš™y
.
li¡
) {

277 
’Œy
 = 
	`li¡_’Œy
(
pos
, 
hfi1_affš™y_node
, 
li¡
);

278 ià(
’Œy
->
node
 ==‚ode)

279  
’Œy
;

282  
NULL
;

283 
	}
}

285 
	$³r_ýu_affš™y_g‘
(
ýumask_v¬_t
 
possibË_ýumask
,

286 
u16
 
__³rýu
 *
comp_veù_affš™y
)

288 
cu¼_ýu
;

289 
u16
 
úŒ
;

290 
u16
 
´ev_úŒ
;

291 
»t_ýu
;

293 ià(!
possibË_ýumask
) {

294 
»t_ýu
 = -
EINVAL
;

295 
çž
;

298 ià(!
comp_veù_affš™y
) {

299 
»t_ýu
 = -
EINVAL
;

300 
çž
;

303 
»t_ýu
 = 
	`ýumask_fœ¡
(
possibË_ýumask
);

304 ià(
»t_ýu
 >ð
Ä_ýu_ids
) {

305 
»t_ýu
 = -
EINVAL
;

306 
çž
;

309 
´ev_úŒ
 = *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
»t_ýu
);

310 
	`fÜ_—ch_ýu
(
cu¼_ýu
, 
possibË_ýumask
) {

311 
úŒ
 = *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
cu¼_ýu
);

313 ià(
úŒ
 < 
´ev_úŒ
) {

314 
»t_ýu
 = 
cu¼_ýu
;

315 
´ev_úŒ
 = 
úŒ
;

319 *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
»t_ýu
) += 1;

321 
çž
:

322  
»t_ýu
;

323 
	}
}

325 
	$³r_ýu_affš™y_put_max
(
ýumask_v¬_t
 
possibË_ýumask
,

326 
u16
 
__³rýu
 *
comp_veù_affš™y
)

328 
cu¼_ýu
;

329 
max_ýu
;

330 
u16
 
úŒ
;

331 
u16
 
´ev_úŒ
;

333 ià(!
possibË_ýumask
)

334  -
EINVAL
;

336 ià(!
comp_veù_affš™y
)

337  -
EINVAL
;

339 
max_ýu
 = 
	`ýumask_fœ¡
(
possibË_ýumask
);

340 ià(
max_ýu
 >ð
Ä_ýu_ids
)

341  -
EINVAL
;

343 
´ev_úŒ
 = *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
max_ýu
);

344 
	`fÜ_—ch_ýu
(
cu¼_ýu
, 
possibË_ýumask
) {

345 
úŒ
 = *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
cu¼_ýu
);

347 ià(
úŒ
 > 
´ev_úŒ
) {

348 
max_ýu
 = 
cu¼_ýu
;

349 
´ev_úŒ
 = 
úŒ
;

353 *
	`³r_ýu_±r
(
comp_veù_affš™y
, 
max_ýu
) -= 1;

355  
max_ýu
;

356 
	}
}

362 
	$_dev_comp_veù_ýu_g‘
(
hfi1_devd©a
 *
dd
,

363 
hfi1_affš™y_node
 *
’Œy
,

364 
ýumask_v¬_t
 
nÚ_šŒ_ýus
,

365 
ýumask_v¬_t
 
avažabË_ýus
)

366 
	$__mu¡_hÞd
(&
node_affš™y
.
lock
)

368 
ýu
;

369 
ýu_mask_£t
 *
£t
 = 
dd
->
comp_veù
;

371 
	`lockd•_as£¹_h–d
(&
node_affš™y
.
lock
);

372 ià(!
nÚ_šŒ_ýus
) {

373 
ýu
 = -1;

374 
çž
;

377 ià(!
avažabË_ýus
) {

378 
ýu
 = -1;

379 
çž
;

383 
	`_ýu_mask_£t_g’_šc
(
£t
);

384 
	`ýumask_ªdnÙ
(
avažabË_ýus
, &
£t
->
mask
, &£t->
u£d
);

387 
	`ýumask_ªdnÙ
(
nÚ_šŒ_ýus
, 
avažabË_ýus
,

388 &
’Œy
->
def_šŒ
.
u£d
);

391 ià(!
	`ýumask_em±y
(
nÚ_šŒ_ýus
))

392 
ýu
 = 
	`ýumask_fœ¡
(
nÚ_šŒ_ýus
);

394 
ýu
 = 
	`ýumask_fœ¡
(
avažabË_ýus
);

396 ià(
ýu
 >ð
Ä_ýu_ids
) {

397 
ýu
 = -1;

398 
çž
;

400 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
u£d
);

402 
çž
:

403  
ýu
;

404 
	}
}

406 
	$_dev_comp_veù_ýu_put
(
hfi1_devd©a
 *
dd
, 
ýu
)

408 
ýu_mask_£t
 *
£t
 = 
dd
->
comp_veù
;

410 ià(
ýu
 < 0)

413 
	`ýu_mask_£t_put
(
£t
, 
ýu
);

414 
	}
}

417 
	$_dev_comp_veù_m­pšgs_de¡roy
(
hfi1_devd©a
 *
dd
)

419 
i
, 
ýu
;

421 ià(!
dd
->
comp_veù_m­pšgs
)

424 
i
 = 0; i < 
dd
->
comp_veù_possibË_ýus
; i++) {

425 
ýu
 = 
dd
->
comp_veù_m­pšgs
[
i
];

426 
	`_dev_comp_veù_ýu_put
(
dd
, 
ýu
);

427 
dd
->
comp_veù_m­pšgs
[
i
] = -1;

428 
	`hfi1_cdbg
(
AFFINITY
,

430 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), 
ýu
, 
i
);

433 
	`kä“
(
dd
->
comp_veù_m­pšgs
);

434 
dd
->
comp_veù_m­pšgs
 = 
NULL
;

435 
	}
}

441 
	$_dev_comp_veù_m­pšgs_ü—‹
(
hfi1_devd©a
 *
dd
,

442 
hfi1_affš™y_node
 *
’Œy
)

443 
	$__mu¡_hÞd
(&
node_affš™y
.
lock
)

445 
i
, 
ýu
, 
»t
;

446 
ýumask_v¬_t
 
nÚ_šŒ_ýus
;

447 
ýumask_v¬_t
 
avažabË_ýus
;

449 
	`lockd•_as£¹_h–d
(&
node_affš™y
.
lock
);

451 ià(!
	`z®loc_ýumask_v¬
(&
nÚ_šŒ_ýus
, 
GFP_KERNEL
))

452  -
ENOMEM
;

454 ià(!
	`z®loc_ýumask_v¬
(&
avažabË_ýus
, 
GFP_KERNEL
)) {

455 
	`ä“_ýumask_v¬
(
nÚ_šŒ_ýus
);

456  -
ENOMEM
;

459 
dd
->
comp_veù_m­pšgs
 = 
	`kÿÎoc
(dd->
comp_veù_possibË_ýus
,

460 (*
dd
->
comp_veù_m­pšgs
),

461 
GFP_KERNEL
);

462 ià(!
dd
->
comp_veù_m­pšgs
) {

463 
»t
 = -
ENOMEM
;

464 
çž
;

466 
i
 = 0; i < 
dd
->
comp_veù_possibË_ýus
; i++)

467 
dd
->
comp_veù_m­pšgs
[
i
] = -1;

469 
i
 = 0; i < 
dd
->
comp_veù_possibË_ýus
; i++) {

470 
ýu
 = 
	`_dev_comp_veù_ýu_g‘
(
dd
, 
’Œy
, 
nÚ_šŒ_ýus
,

471 
avažabË_ýus
);

472 ià(
ýu
 < 0) {

473 
»t
 = -
EINVAL
;

474 
çž
;

477 
dd
->
comp_veù_m­pšgs
[
i
] = 
ýu
;

478 
	`hfi1_cdbg
(
AFFINITY
,

480 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), 
i
, 
ýu
);

483 
	`ä“_ýumask_v¬
(
avažabË_ýus
);

484 
	`ä“_ýumask_v¬
(
nÚ_šŒ_ýus
);

487 
çž
:

488 
	`ä“_ýumask_v¬
(
avažabË_ýus
);

489 
	`ä“_ýumask_v¬
(
nÚ_šŒ_ýus
);

490 
	`_dev_comp_veù_m­pšgs_de¡roy
(
dd
);

492  
»t
;

493 
	}
}

495 
	$hfi1_comp_veùÜs_£t_up
(
hfi1_devd©a
 *
dd
)

497 
»t
;

498 
hfi1_affš™y_node
 *
’Œy
;

500 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

501 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

502 ià(!
’Œy
) {

503 
»t
 = -
EINVAL
;

504 
uÆock
;

506 
»t
 = 
	`_dev_comp_veù_m­pšgs_ü—‹
(
dd
, 
’Œy
);

507 
uÆock
:

508 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

510  
»t
;

511 
	}
}

513 
	$hfi1_comp_veùÜs_þ—n_up
(
hfi1_devd©a
 *
dd
)

515 
	`_dev_comp_veù_m­pšgs_de¡roy
(
dd
);

516 
	}
}

518 
	$hfi1_comp_veù_m­pšgs_lookup
(
rvt_dev_šfo
 *
rdi
, 
comp_veù
)

520 
hfi1_ibdev
 *
v”bs_dev
 = 
	`dev_äom_rdi
(
rdi
);

521 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
v”bs_dev
);

523 ià(!
dd
->
comp_veù_m­pšgs
)

524  -
EINVAL
;

525 ià(
comp_veù
 >ð
dd
->
comp_veù_possibË_ýus
)

526  -
EINVAL
;

528  
dd
->
comp_veù_m­pšgs
[
comp_veù
];

529 
	}
}

534 
	$_dev_comp_veù_ýu_mask_š™
(
hfi1_devd©a
 *
dd
,

535 
hfi1_affš™y_node
 *
’Œy
,

536 
boÞ
 
fœ¡_dev_š™
)

537 
	$__mu¡_hÞd
(&
node_affš™y
.
lock
)

539 
i
, 
j
, 
cu¼_ýu
;

540 
possibË_ýus_comp_veù
 = 0;

541 
ýumask
 *
dev_comp_veù_mask
 = &
dd
->
comp_veù
->
mask
;

543 
	`lockd•_as£¹_h–d
(&
node_affš™y
.
lock
);

551 ià(
	`ýumask_weight
(&
’Œy
->
comp_veù_mask
) == 1) {

552 
possibË_ýus_comp_veù
 = 1;

553 
	`dd_dev_w¬n
(
dd
,

556 
possibË_ýus_comp_veù
 +=

557 
	`ýumask_weight
(&
’Œy
->
comp_veù_mask
) /

558 
hfi1_³r_node_úŒ
[
dd
->
node
];

565 ià(
fœ¡_dev_š™
 &&

566 
	`ýumask_weight
(&
’Œy
->
comp_veù_mask
) %

567 
hfi1_³r_node_úŒ
[
dd
->
node
] != 0)

568 
possibË_ýus_comp_veù
++;

571 
dd
->
comp_veù_possibË_ýus
 = 
possibË_ýus_comp_veù
;

574 
i
 = 0; i < 
dd
->
comp_veù_possibË_ýus
; i++) {

575 
cu¼_ýu
 = 
	`³r_ýu_affš™y_g‘
(&
’Œy
->
comp_veù_mask
,

576 
’Œy
->
comp_veù_affš™y
);

577 ià(
cu¼_ýu
 < 0)

578 
çž
;

580 
	`ýumask_£t_ýu
(
cu¼_ýu
, 
dev_comp_veù_mask
);

583 
	`hfi1_cdbg
(
AFFINITY
,

585 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
),

586 
	`ýumask_´_¬gs
(
dev_comp_veù_mask
));

590 
çž
:

591 
j
 = 0; j < 
i
; j++)

592 
	`³r_ýu_affš™y_put_max
(&
’Œy
->
comp_veù_mask
,

593 
’Œy
->
comp_veù_affš™y
);

595  
cu¼_ýu
;

596 
	}
}

601 
	$_dev_comp_veù_ýu_mask_þ—n_up
(
hfi1_devd©a
 *
dd
,

602 
hfi1_affš™y_node
 *
’Œy
)

603 
	$__mu¡_hÞd
(&
node_affš™y
.
lock
)

605 
i
, 
ýu
;

607 
	`lockd•_as£¹_h–d
(&
node_affš™y
.
lock
);

608 ià(!
dd
->
comp_veù_possibË_ýus
)

611 
i
 = 0; i < 
dd
->
comp_veù_possibË_ýus
; i++) {

612 
ýu
 = 
	`³r_ýu_affš™y_put_max
(&
dd
->
comp_veù
->
mask
,

613 
’Œy
->
comp_veù_affš™y
);

615 ià(
ýu
 >= 0)

616 
	`ýumask_þ—r_ýu
(
ýu
, &
dd
->
comp_veù
->
mask
);

619 
dd
->
comp_veù_possibË_ýus
 = 0;

620 
	}
}

633 
	$hfi1_dev_affš™y_š™
(
hfi1_devd©a
 *
dd
)

635 
node
 = 
	`pcibus_to_node
(
dd
->
pcidev
->
bus
);

636 
hfi1_affš™y_node
 *
’Œy
;

637 cÚ¡ 
ýumask
 *
loÿl_mask
;

638 
cu¼_ýu
, 
possibË
, 
i
, 
»t
;

639 
boÞ
 
Ãw_’Œy
 = 
çl£
;

645 ià(
node
 < 0) {

646 
	`dd_dev_”r
(
dd
, "Invalid PCI NUMA‚ode. Performance may be‡ffected\n");

647 
node
 = 0;

649 
dd
->
node
 =‚ode;

651 
loÿl_mask
 = 
	`ýumask_of_node
(
dd
->
node
);

652 ià(
	`ýumask_fœ¡
(
loÿl_mask
è>ð
Ä_ýu_ids
)

653 
loÿl_mask
 = 
	`tÝÞogy_cÜe_ýumask
(0);

655 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

656 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

662 ià(!
’Œy
) {

663 
’Œy
 = 
	`node_affš™y_®loÿ‹
(
node
);

664 ià(!
’Œy
) {

665 
	`dd_dev_”r
(
dd
,

667 
»t
 = -
ENOMEM
;

668 
çž
;

670 
Ãw_’Œy
 = 
Œue
;

672 
	`š™_ýu_mask_£t
(&
’Œy
->
def_šŒ
);

673 
	`š™_ýu_mask_£t
(&
’Œy
->
rcv_šŒ
);

674 
	`ýumask_þ—r
(&
’Œy
->
comp_veù_mask
);

675 
	`ýumask_þ—r
(&
’Œy
->
g’”®_šŒ_mask
);

677 
	`ýumask_ªd
(&
’Œy
->
def_šŒ
.
mask
, &
node_affš™y
.
»®_ýu_mask
,

678 
loÿl_mask
);

681 
possibË
 = 
	`ýumask_weight
(&
’Œy
->
def_šŒ
.
mask
);

682 
cu¼_ýu
 = 
	`ýumask_fœ¡
(&
’Œy
->
def_šŒ
.
mask
);

684 ià(
possibË
 == 1) {

686 
	`ýumask_£t_ýu
(
cu¼_ýu
, &
’Œy
->
rcv_šŒ
.
mask
);

687 
	`ýumask_£t_ýu
(
cu¼_ýu
, &
’Œy
->
g’”®_šŒ_mask
);

694 
	`ýumask_þ—r_ýu
(
cu¼_ýu
, &
’Œy
->
def_šŒ
.
mask
);

695 
	`ýumask_£t_ýu
(
cu¼_ýu
, &
’Œy
->
g’”®_šŒ_mask
);

696 
cu¼_ýu
 = 
	`ýumask_Ãxt
(curr_cpu,

697 &
’Œy
->
def_šŒ
.
mask
);

703 
i
 = 0;

704 
i
 < (
dd
->
n_krcv_queues
 - 1) *

705 
hfi1_³r_node_úŒ
[
dd
->
node
];

706 
i
++) {

707 
	`ýumask_þ—r_ýu
(
cu¼_ýu
,

708 &
’Œy
->
def_šŒ
.
mask
);

709 
	`ýumask_£t_ýu
(
cu¼_ýu
,

710 &
’Œy
->
rcv_šŒ
.
mask
);

711 
cu¼_ýu
 = 
	`ýumask_Ãxt
(curr_cpu,

712 &
’Œy
->
def_šŒ
.
mask
);

713 ià(
cu¼_ýu
 >ð
Ä_ýu_ids
)

722 ià(
	`ýumask_weight
(&
’Œy
->
def_šŒ
.
mask
) == 0)

723 
	`ýumask_cÝy
(&
’Œy
->
def_šŒ
.
mask
,

724 &
’Œy
->
g’”®_šŒ_mask
);

728 
	`ýumask_ªd
(&
’Œy
->
comp_veù_mask
,

729 &
node_affš™y
.
»®_ýu_mask
, 
loÿl_mask
);

730 
	`ýumask_ªdnÙ
(&
’Œy
->
comp_veù_mask
,

731 &
’Œy
->
comp_veù_mask
,

732 &
’Œy
->
rcv_šŒ
.
mask
);

733 
	`ýumask_ªdnÙ
(&
’Œy
->
comp_veù_mask
,

734 &
’Œy
->
comp_veù_mask
,

735 &
’Œy
->
g’”®_šŒ_mask
);

742 ià(
	`ýumask_weight
(&
’Œy
->
comp_veù_mask
) == 0)

743 
	`ýumask_cÝy
(&
’Œy
->
comp_veù_mask
,

744 &
’Œy
->
g’”®_šŒ_mask
);

747 
»t
 = 
	`_dev_comp_veù_ýu_mask_š™
(
dd
, 
’Œy
, 
Ãw_’Œy
);

748 ià(
»t
 < 0)

749 
çž
;

751 ià(
Ãw_’Œy
)

752 
	`node_affš™y_add_ž
(
’Œy
);

754 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

758 
çž
:

759 ià(
Ãw_’Œy
)

760 
	`node_affš™y_de¡roy
(
’Œy
);

761 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

762  
»t
;

763 
	}
}

765 
	$hfi1_dev_affš™y_þ—n_up
(
hfi1_devd©a
 *
dd
)

767 
hfi1_affš™y_node
 *
’Œy
;

769 ià(
dd
->
node
 < 0)

772 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

773 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

774 ià(!
’Œy
)

775 
uÆock
;

781 
	`_dev_comp_veù_ýu_mask_þ—n_up
(
dd
, 
’Œy
);

782 
uÆock
:

783 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

784 
dd
->
node
 = 
NUMA_NO_NODE
;

785 
	}
}

792 
	$hfi1_upd©e_sdma_affš™y
(
hfi1_msix_’Œy
 *
msix
, 
ýu
)

794 
sdma_’gše
 *
sde
 = 
msix
->
¬g
;

795 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

796 
hfi1_affš™y_node
 *
’Œy
;

797 
ýu_mask_£t
 *
£t
;

798 
i
, 
Þd_ýu
;

800 ià(
ýu
 > 
	`num_Úlše_ýus
(è|| cpu =ð
sde
->cpu)

803 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

804 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

805 ià(!
’Œy
)

806 
uÆock
;

808 
Þd_ýu
 = 
sde
->
ýu
;

809 
sde
->
ýu
 = cpu;

810 
	`ýumask_þ—r
(&
msix
->
mask
);

811 
	`ýumask_£t_ýu
(
ýu
, &
msix
->
mask
);

812 
	`dd_dev_dbg
(
dd
, "IRQ: %u,ype %sƒngine %u -> cpu: %d\n",

813 
msix
->
œq
, 
œq_ty³_Çmes
[msix->
ty³
],

814 
sde
->
this_idx
, 
ýu
);

815 
	`œq_£t_affš™y_hšt
(
msix
->
œq
, &msix->
mask
);

821 
£t
 = &
’Œy
->
def_šŒ
;

822 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
mask
);

823 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
u£d
);

824 
i
 = 0; i < 
dd
->
msix_šfo
.
max_»que¡ed
; i++) {

825 
hfi1_msix_’Œy
 *
Ùh”_msix
;

827 
Ùh”_msix
 = &
dd
->
msix_šfo
.
msix_’Œ›s
[
i
];

828 ià(
Ùh”_msix
->
ty³
 !ð
IRQ_SDMA
 || oth”_msix =ð
msix
)

831 ià(
	`ýumask_‹¡_ýu
(
Þd_ýu
, &
Ùh”_msix
->
mask
))

832 
uÆock
;

834 
	`ýumask_þ—r_ýu
(
Þd_ýu
, &
£t
->
mask
);

835 
	`ýumask_þ—r_ýu
(
Þd_ýu
, &
£t
->
u£d
);

836 
uÆock
:

837 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

838 
	}
}

840 
	$hfi1_œq_nÙif›r_nÙify
(
œq_affš™y_nÙify
 *
nÙify
,

841 cÚ¡ 
ýumask_t
 *
mask
)

843 
ýu
 = 
	`ýumask_fœ¡
(
mask
);

844 
hfi1_msix_’Œy
 *
msix
 = 
	`cÚš”_of
(
nÙify
,

845 
hfi1_msix_’Œy
,

846 
nÙify
);

849 
	`hfi1_upd©e_sdma_affš™y
(
msix
, 
ýu
);

850 
	}
}

852 
	$hfi1_œq_nÙif›r_»Ëa£
(
k»f
 *
»f
)

858 
	}
}

860 
	$hfi1_£tup_sdma_nÙif›r
(
hfi1_msix_’Œy
 *
msix
)

862 
œq_affš™y_nÙify
 *
nÙify
 = &
msix
->notify;

864 
nÙify
->
œq
 = 
msix
->irq;

865 
nÙify
->nÙify = 
hfi1_œq_nÙif›r_nÙify
;

866 
nÙify
->
»Ëa£
 = 
hfi1_œq_nÙif›r_»Ëa£
;

868 ià(
	`œq_£t_affš™y_nÙif›r
(
nÙify
->
œq
,‚otify))

869 
	`´_”r
("Failedo„egister sdma irq‡ffinity‚otifier for irq %d\n",

870 
nÙify
->
œq
);

871 
	}
}

873 
	$hfi1_þ—nup_sdma_nÙif›r
(
hfi1_msix_’Œy
 *
msix
)

875 
œq_affš™y_nÙify
 *
nÙify
 = &
msix
->notify;

877 ià(
	`œq_£t_affš™y_nÙif›r
(
nÙify
->
œq
, 
NULL
))

878 
	`´_”r
("Failedo cleanup sdma irq‡ffinity‚otifier for irq %d\n",

879 
nÙify
->
œq
);

880 
	}
}

886 
	$g‘_œq_affš™y
(
hfi1_devd©a
 *
dd
,

887 
hfi1_msix_’Œy
 *
msix
)

889 
ýumask_v¬_t
 
diff
;

890 
hfi1_affš™y_node
 *
’Œy
;

891 
ýu_mask_£t
 *
£t
 = 
NULL
;

892 
sdma_’gše
 *
sde
 = 
NULL
;

893 
hfi1_ùxtd©a
 *
rcd
 = 
NULL
;

894 
exŒa
[64];

895 
ýu
 = -1;

897 
exŒa
[0] = '\0';

898 
	`ýumask_þ—r
(&
msix
->
mask
);

900 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

902 
msix
->
ty³
) {

903 
IRQ_SDMA
:

904 
sde
 = (
sdma_’gše
 *)
msix
->
¬g
;

905 
	`sú´štf
(
exŒa
, 64, "’gš%u", 
sde
->
this_idx
);

906 
£t
 = &
’Œy
->
def_šŒ
;

908 
IRQ_GENERAL
:

909 
ýu
 = 
	`ýumask_fœ¡
(&
’Œy
->
g’”®_šŒ_mask
);

911 
IRQ_RCVCTXT
:

912 
rcd
 = (
hfi1_ùxtd©a
 *)
msix
->
¬g
;

913 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
)

914 
ýu
 = 
	`ýumask_fœ¡
(&
’Œy
->
g’”®_šŒ_mask
);

916 
£t
 = &
’Œy
->
rcv_šŒ
;

917 
	`sú´štf
(
exŒa
, 64, "ùxˆ%u", 
rcd
->
ùxt
);

919 
IRQ_NETDEVCTXT
:

920 
rcd
 = (
hfi1_ùxtd©a
 *)
msix
->
¬g
;

921 
£t
 = &
’Œy
->
def_šŒ
;

922 
	`sú´štf
(
exŒa
, 64, "ùxˆ%u", 
rcd
->
ùxt
);

925 
	`dd_dev_”r
(
dd
, "Inv®id IRQy³ %d\n", 
msix
->
ty³
);

926  -
EINVAL
;

934 ià(
ýu
 =ð-1 && 
£t
) {

935 ià(!
	`z®loc_ýumask_v¬
(&
diff
, 
GFP_KERNEL
))

936  -
ENOMEM
;

938 
ýu
 = 
	`ýu_mask_£t_g‘_fœ¡
(
£t
, 
diff
);

939 ià(
ýu
 < 0) {

940 
	`ä“_ýumask_v¬
(
diff
);

941 
	`dd_dev_”r
(
dd
, "Failureo obtain CPU for IRQ\n");

942  
ýu
;

945 
	`ä“_ýumask_v¬
(
diff
);

948 
	`ýumask_£t_ýu
(
ýu
, &
msix
->
mask
);

949 
	`dd_dev_šfo
(
dd
, "IRQ: %u,ype %s %s -> cpu: %d\n",

950 
msix
->
œq
, 
œq_ty³_Çmes
[msix->
ty³
],

951 
exŒa
, 
ýu
);

952 
	`œq_£t_affš™y_hšt
(
msix
->
œq
, &msix->
mask
);

954 ià(
msix
->
ty³
 =ð
IRQ_SDMA
) {

955 
sde
->
ýu
 = cpu;

956 
	`hfi1_£tup_sdma_nÙif›r
(
msix
);

960 
	}
}

962 
	$hfi1_g‘_œq_affš™y
(
hfi1_devd©a
 *
dd
, 
hfi1_msix_’Œy
 *
msix
)

964 
»t
;

966 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

967 
»t
 = 
	`g‘_œq_affš™y
(
dd
, 
msix
);

968 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

969  
»t
;

970 
	}
}

972 
	$hfi1_put_œq_affš™y
(
hfi1_devd©a
 *
dd
,

973 
hfi1_msix_’Œy
 *
msix
)

975 
ýu_mask_£t
 *
£t
 = 
NULL
;

976 
hfi1_ùxtd©a
 *
rcd
;

977 
hfi1_affš™y_node
 *
’Œy
;

979 
	`mu‹x_lock
(&
node_affš™y
.
lock
);

980 
’Œy
 = 
	`node_affš™y_lookup
(
dd
->
node
);

982 
msix
->
ty³
) {

983 
IRQ_SDMA
:

984 
£t
 = &
’Œy
->
def_šŒ
;

985 
	`hfi1_þ—nup_sdma_nÙif›r
(
msix
);

987 
IRQ_GENERAL
:

990 
IRQ_RCVCTXT
:

991 
rcd
 = (
hfi1_ùxtd©a
 *)
msix
->
¬g
;

993 ià(
rcd
->
ùxt
 !ð
HFI1_CTRL_CTXT
)

994 
£t
 = &
’Œy
->
rcv_šŒ
;

996 
IRQ_NETDEVCTXT
:

997 
rcd
 = (
hfi1_ùxtd©a
 *)
msix
->
¬g
;

998 
£t
 = &
’Œy
->
def_šŒ
;

1001 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

1005 ià(
£t
) {

1006 
	`ýumask_ªdnÙ
(&
£t
->
u£d
, &£t->u£d, &
msix
->
mask
);

1007 
	`_ýu_mask_£t_g’_dec
(
£t
);

1010 
	`œq_£t_affš™y_hšt
(
msix
->
œq
, 
NULL
);

1011 
	`ýumask_þ—r
(&
msix
->
mask
);

1012 
	`mu‹x_uÆock
(&
node_affš™y
.
lock
);

1013 
	}
}

1016 
	$fšd_hw_th»ad_mask
(
ušt
 
hw_th»ad_no
, 
ýumask_v¬_t
 
hw_th»ad_mask
,

1017 
hfi1_affš™y_node_li¡
 *
affš™y
)

1019 
possibË
, 
cu¼_ýu
, 
i
;

1020 
ušt
 
num_cÜes_³r_sock‘
 = 
node_affš™y
.
num_Úlše_ýus
 /

1021 
affš™y
->
num_cÜe_siblšgs
 /

1022 
node_affš™y
.
num_Úlše_nodes
;

1024 
	`ýumask_cÝy
(
hw_th»ad_mask
, &
affš™y
->
´oc
.
mask
);

1025 ià(
affš™y
->
num_cÜe_siblšgs
 > 0) {

1027 
possibË
 = 
	`ýumask_weight
(
hw_th»ad_mask
);

1028 
cu¼_ýu
 = 
	`ýumask_fœ¡
(
hw_th»ad_mask
);

1029 
i
 = 0;

1030 
i
 < 
num_cÜes_³r_sock‘
 * 
node_affš™y
.
num_Úlše_nodes
;

1031 
i
++)

1032 
cu¼_ýu
 = 
	`ýumask_Ãxt
(cu¼_ýu, 
hw_th»ad_mask
);

1034 ; 
i
 < 
possibË
; i++) {

1035 
	`ýumask_þ—r_ýu
(
cu¼_ýu
, 
hw_th»ad_mask
);

1036 
cu¼_ýu
 = 
	`ýumask_Ãxt
(cu¼_ýu, 
hw_th»ad_mask
);

1040 
	`ýumask_shiá_Ëá
(
hw_th»ad_mask
, hw_thread_mask,

1041 
num_cÜes_³r_sock‘
 *

1042 
node_affš™y
.
num_Úlše_nodes
 *

1043 
hw_th»ad_no
);

1045 
	}
}

1047 
	$hfi1_g‘_´oc_affš™y
(
node
)

1049 
ýu
 = -1, 
»t
, 
i
;

1050 
hfi1_affš™y_node
 *
’Œy
;

1051 
ýumask_v¬_t
 
diff
, 
hw_th»ad_mask
, 
avažabË_mask
, 
šŒs_mask
;

1052 cÚ¡ 
ýumask
 *
node_mask
,

1053 #ifdeà
HAVE_CPUS_PTR


1054 *
´oc_mask
 = 
cu¼’t
->
ýus_±r
;

1056 *
´oc_mask
 = &
cu¼’t
->
ýus_®lowed
;

1058 
hfi1_affš™y_node_li¡
 *
affš™y
 = &
node_affš™y
;

1059 
ýu_mask_£t
 *
£t
 = &
affš™y
->
´oc
;

1065 ià(
cu¼’t
->
Ä_ýus_®lowed
 == 1) {

1066 
	`hfi1_cdbg
(
PROC
, "PID %u %s‡ffinity seto CPU %*pbl",

1067 
cu¼’t
->
pid
, cu¼’t->
comm
,

1068 
	`ýumask_´_¬gs
(
´oc_mask
));

1073 
ýu
 = 
	`ýumask_fœ¡
(
´oc_mask
);

1074 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
u£d
);

1075 
dÚe
;

1076 } ià(
cu¼’t
->
Ä_ýus_®lowed
 < 
	`ýumask_weight
(&
£t
->
mask
)) {

1077 
	`hfi1_cdbg
(
PROC
, "PID %u %s‡ffinity seto CPU set(s) %*pbl",

1078 
cu¼’t
->
pid
, cu¼’t->
comm
,

1079 
	`ýumask_´_¬gs
(
´oc_mask
));

1080 
dÚe
;

1104 
»t
 = 
	`z®loc_ýumask_v¬
(&
diff
, 
GFP_KERNEL
);

1105 ià(!
»t
)

1106 
dÚe
;

1107 
»t
 = 
	`z®loc_ýumask_v¬
(&
hw_th»ad_mask
, 
GFP_KERNEL
);

1108 ià(!
»t
)

1109 
ä“_diff
;

1110 
»t
 = 
	`z®loc_ýumask_v¬
(&
avažabË_mask
, 
GFP_KERNEL
);

1111 ià(!
»t
)

1112 
ä“_hw_th»ad_mask
;

1113 
»t
 = 
	`z®loc_ýumask_v¬
(&
šŒs_mask
, 
GFP_KERNEL
);

1114 ià(!
»t
)

1115 
ä“_avažabË_mask
;

1117 
	`mu‹x_lock
(&
affš™y
->
lock
);

1122 
	`_ýu_mask_£t_g’_šc
(
£t
);

1128 
’Œy
 = 
	`node_affš™y_lookup
(
node
);

1129 ià(
’Œy
) {

1130 
	`ýumask_cÝy
(
šŒs_mask
, (
’Œy
->
def_šŒ
.
g’
 ?

1131 &
’Œy
->
def_šŒ
.
mask
 :

1132 &
’Œy
->
def_šŒ
.
u£d
));

1133 
	`ýumask_Ü
(
šŒs_mask
, iÁrs_mask, (
’Œy
->
rcv_šŒ
.
g’
 ?

1134 &
’Œy
->
rcv_šŒ
.
mask
 :

1135 &
’Œy
->
rcv_šŒ
.
u£d
));

1136 
	`ýumask_Ü
(
šŒs_mask
, iÁrs_mask, &
’Œy
->
g’”®_šŒ_mask
);

1138 
	`hfi1_cdbg
(
PROC
, "CPUs used by interrupts: %*pbl",

1139 
	`ýumask_´_¬gs
(
šŒs_mask
));

1141 
	`ýumask_cÝy
(
hw_th»ad_mask
, &
£t
->
mask
);

1147 ià(
affš™y
->
num_cÜe_siblšgs
 > 0) {

1148 
i
 = 0; i < 
affš™y
->
num_cÜe_siblšgs
; i++) {

1149 
	`fšd_hw_th»ad_mask
(
i
, 
hw_th»ad_mask
, 
affš™y
);

1159 
	`ýumask_ªdnÙ
(
diff
, 
hw_th»ad_mask
, &
£t
->
u£d
);

1160 ià(!
	`ýumask_em±y
(
diff
))

1164 
	`hfi1_cdbg
(
PROC
, "Same‡vailable HWhread on‡ll…hysical CPUs: %*pbl",

1165 
	`ýumask_´_¬gs
(
hw_th»ad_mask
));

1167 
node_mask
 = 
	`ýumask_of_node
(
node
);

1168 
	`hfi1_cdbg
(
PROC
, "Deviû oÀNUMA %u, CPU %*pbl", 
node
,

1169 
	`ýumask_´_¬gs
(
node_mask
));

1172 
	`ýumask_ªd
(
avažabË_mask
, 
hw_th»ad_mask
, 
node_mask
);

1173 
	`ýumask_ªdnÙ
(
avažabË_mask
,‡važabË_mask, &
£t
->
u£d
);

1174 
	`hfi1_cdbg
(
PROC
, "AvažabË CPU Ú NUMA %u: %*pbl", 
node
,

1175 
	`ýumask_´_¬gs
(
avažabË_mask
));

1193 
	`ýumask_ªdnÙ
(
diff
, 
avažabË_mask
, 
šŒs_mask
);

1194 ià(!
	`ýumask_em±y
(
diff
))

1195 
	`ýumask_cÝy
(
avažabË_mask
, 
diff
);

1198 ià(
	`ýumask_em±y
(
avažabË_mask
)) {

1199 
	`ýumask_ªdnÙ
(
avažabË_mask
, 
hw_th»ad_mask
, &
£t
->
u£d
);

1201 
	`ýumask_ªdnÙ
(
avažabË_mask
,‡važabË_mask, 
node_mask
);

1202 
	`hfi1_cdbg
(
PROC
,

1204 
	`ýumask_´_¬gs
(
avažabË_mask
));

1210 
	`ýumask_ªdnÙ
(
diff
, 
avažabË_mask
, 
šŒs_mask
);

1211 ià(!
	`ýumask_em±y
(
diff
))

1212 
	`ýumask_cÝy
(
avažabË_mask
, 
diff
);

1214 
	`hfi1_cdbg
(
PROC
, "Possible CPUs for…rocess: %*pbl",

1215 
	`ýumask_´_¬gs
(
avažabË_mask
));

1217 
ýu
 = 
	`ýumask_fœ¡
(
avažabË_mask
);

1218 ià(
ýu
 >ð
Ä_ýu_ids
)

1219 
ýu
 = -1;

1221 
	`ýumask_£t_ýu
(
ýu
, &
£t
->
u£d
);

1223 
	`mu‹x_uÆock
(&
affš™y
->
lock
);

1224 
	`hfi1_cdbg
(
PROC
, "Proûs assigÃdØCPU %d", 
ýu
);

1226 
	`ä“_ýumask_v¬
(
šŒs_mask
);

1227 
ä“_avažabË_mask
:

1228 
	`ä“_ýumask_v¬
(
avažabË_mask
);

1229 
ä“_hw_th»ad_mask
:

1230 
	`ä“_ýumask_v¬
(
hw_th»ad_mask
);

1231 
ä“_diff
:

1232 
	`ä“_ýumask_v¬
(
diff
);

1233 
dÚe
:

1234  
ýu
;

1235 
	}
}

1237 
	$hfi1_put_´oc_affš™y
(
ýu
)

1239 
hfi1_affš™y_node_li¡
 *
affš™y
 = &
node_affš™y
;

1240 
ýu_mask_£t
 *
£t
 = &
affš™y
->
´oc
;

1242 ià(
ýu
 < 0)

1245 
	`mu‹x_lock
(&
affš™y
->
lock
);

1246 
	`ýu_mask_£t_put
(
£t
, 
ýu
);

1247 
	`hfi1_cdbg
(
PROC
, "R‘uºšg CPU %d fÜ futu»…roûs assignm’t", 
ýu
);

1248 
	`mu‹x_uÆock
(&
affš™y
->
lock
);

1249 
	}
}

	@affinity.h

47 #iâdeà
_HFI1_AFFINITY_H


48 
	#_HFI1_AFFINITY_H


	)

50 
	~"hfi.h
"

52 
	eœq_ty³
 {

53 
	mIRQ_SDMA
,

54 
	mIRQ_RCVCTXT
,

55 
	mIRQ_NETDEVCTXT
,

56 
	mIRQ_GENERAL
,

57 
	mIRQ_OTHER


61 
	eaffš™y_æags
 {

62 
	mAFF_AUTO
,

63 
	mAFF_NUMA_LOCAL
,

64 
	mAFF_DEV_LOCAL
,

65 
	mAFF_IRQ_LOCAL


68 
	sýu_mask_£t
 {

69 
ýumask
 
	mmask
;

70 
ýumask
 
	mu£d
;

71 
ušt
 
	mg’
;

74 
	ghfi1_msix_’Œy
;

77 
š™_»®_ýu_mask
();

79 
hfi1_dev_affš™y_š™
(
hfi1_devd©a
 *
dd
);

84 
hfi1_g‘_œq_affš™y
(
hfi1_devd©a
 *
dd
,

85 
hfi1_msix_’Œy
 *
msix
);

90 
hfi1_put_œq_affš™y
(
hfi1_devd©a
 *
dd
,

91 
hfi1_msix_’Œy
 *
msix
);

96 
hfi1_g‘_´oc_affš™y
(
node
);

98 
hfi1_put_´oc_affš™y
(
ýu
);

100 
	shfi1_affš™y_node
 {

101 
	mnode
;

102 
u16
 
__³rýu
 *
	mcomp_veù_affš™y
;

103 
ýu_mask_£t
 
	mdef_šŒ
;

104 
ýu_mask_£t
 
	mrcv_šŒ
;

105 
ýumask
 
	mg’”®_šŒ_mask
;

106 
ýumask
 
	mcomp_veù_mask
;

107 
li¡_h—d
 
	mli¡
;

110 
	shfi1_affš™y_node_li¡
 {

111 
li¡_h—d
 
	mli¡
;

112 
ýumask
 
	m»®_ýu_mask
;

113 
ýu_mask_£t
 
	m´oc
;

114 
	mnum_cÜe_siblšgs
;

115 
	mnum_possibË_nodes
;

116 
	mnum_Úlše_nodes
;

117 
	mnum_Úlše_ýus
;

118 
mu‹x
 
	mlock
;

121 
node_affš™y_š™
();

122 
node_affš™y_de¡roy_®l
();

123 
hfi1_affš™y_node_li¡
 
node_affš™y
;

124 
hfi1_dev_affš™y_þ—n_up
(
hfi1_devd©a
 *
dd
);

125 
hfi1_comp_veù_m­pšgs_lookup
(
rvt_dev_šfo
 *
rdi
, 
comp_veù
);

126 
hfi1_comp_veùÜs_£t_up
(
hfi1_devd©a
 *
dd
);

127 
hfi1_comp_veùÜs_þ—n_up
(
hfi1_devd©a
 *
dd
);

	@aspm.c

7 
	~<lšux/moduË.h
>

8 
	~"com·t_commÚ.h
"

9 
	~"a¥m.h
"

12 
	#ASPM_TIMER_MS
 1000

	)

14 
	#ASPM_RESCHED_TIMER_MS
 (
ASPM_TIMER_MS
 / 2)

	)

16 
	#ASPM_TRIGGER_MS
 1

	)

17 
	#ASPM_TRIGGER_NS
 (
ASPM_TRIGGER_MS
 * 1000 * 1000uÎ)

	)

18 
	#ASPM_L1_SUPPORTED
(
»g
) \

19 ((((
»g
è& 
PCI_EXP_LNKCAP_ASPMS
è>> 10è& 0x2)

	)

21 
ušt
 
	ga¥m_mode
 = 
ASPM_MODE_DISABLED
;

22 
moduË_·¿m_Çmed
(
a¥m
, 
a¥m_mode
, 
ušt
, 0444);

23 
MODULE_PARM_DESC
(
a¥m
, "PCIe ASPM: 0: disable, 1:ƒnable, 2: dynamic");

25 
boÞ
 
	$a¥m_hw_l1_suµÜ‹d
(
hfi1_devd©a
 *
dd
)

27 
pci_dev
 *
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

28 
u32
 
up
, 
dn
;

34 ià(!
·»Á
)

35  
çl£
;

37 
	`pc›_ÿ·bž™y_»ad_dwÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCAP
, &
dn
);

38 
dn
 = 
	`ASPM_L1_SUPPORTED
(dn);

40 
	`pc›_ÿ·bž™y_»ad_dwÜd
(
·»Á
, 
PCI_EXP_LNKCAP
, &
up
);

41 
up
 = 
	`ASPM_L1_SUPPORTED
(up);

44  (!!
dn
 || 
	`is_ax
(
dd
)è&& !!
up
;

45 
	}
}

48 
	$a¥m_hw_£t_l1_’t_Ï‹ncy
(
hfi1_devd©a
 *
dd
)

50 
u32
 
l1_’t_Ït
 = 0x4u;

51 
u32
 
»g32
;

53 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL3
, &
»g32
);

54 
»g32
 &ð~
PCIE_CFG_REG_PL3_L1_ENT_LATENCY_SMASK
;

55 
»g32
 |ð
l1_’t_Ït
 << 
PCIE_CFG_REG_PL3_L1_ENT_LATENCY_SHIFT
;

56 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL3
, 
»g32
);

57 
	}
}

59 
	$a¥m_hw_’abË_l1
(
hfi1_devd©a
 *
dd
)

61 
pci_dev
 *
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

67 ià(!
·»Á
)

71 
	`pc›_ÿ·bž™y_þ—r_ªd_£t_wÜd
(
·»Á
, 
PCI_EXP_LNKCTL
,

72 
PCI_EXP_LNKCTL_ASPMC
,

73 
PCI_EXP_LNKCTL_ASPM_L1
);

74 
	`pc›_ÿ·bž™y_þ—r_ªd_£t_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL
,

75 
PCI_EXP_LNKCTL_ASPMC
,

76 
PCI_EXP_LNKCTL_ASPM_L1
);

77 
	}
}

79 
	$a¥m_hw_di§bË_l1
(
hfi1_devd©a
 *
dd
)

81 
pci_dev
 *
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

84 
	`pc›_ÿ·bž™y_þ—r_ªd_£t_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL
,

85 
PCI_EXP_LNKCTL_ASPMC
, 0x0);

86 ià(
·»Á
)

87 
	`pc›_ÿ·bž™y_þ—r_ªd_£t_wÜd
(
·»Á
, 
PCI_EXP_LNKCTL
,

88 
PCI_EXP_LNKCTL_ASPMC
, 0x0);

89 
	}
}

91 
	$a¥m_’abË
(
hfi1_devd©a
 *
dd
)

93 ià(
dd
->
a¥m_’abËd
 || 
a¥m_mode
 =ð
ASPM_MODE_DISABLED
 ||

94 !
dd
->
a¥m_suµÜ‹d
)

97 
	`a¥m_hw_’abË_l1
(
dd
);

98 
dd
->
a¥m_’abËd
 = 
Œue
;

99 
	}
}

101 
	$a¥m_di§bË
(
hfi1_devd©a
 *
dd
)

103 ià(!
dd
->
a¥m_’abËd
 || 
a¥m_mode
 =ð
ASPM_MODE_ENABLED
)

106 
	`a¥m_hw_di§bË_l1
(
dd
);

107 
dd
->
a¥m_’abËd
 = 
çl£
;

108 
	}
}

110 
	$a¥m_di§bË_šc
(
hfi1_devd©a
 *
dd
)

112 
æags
;

114 
	`¥š_lock_œq§ve
(&
dd
->
a¥m_lock
, 
æags
);

115 
	`a¥m_di§bË
(
dd
);

116 
	`©omic_šc
(&
dd
->
a¥m_di§bËd_út
);

117 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
a¥m_lock
, 
æags
);

118 
	}
}

120 
	$a¥m_’abË_dec
(
hfi1_devd©a
 *
dd
)

122 
æags
;

124 
	`¥š_lock_œq§ve
(&
dd
->
a¥m_lock
, 
æags
);

125 ià(
	`©omic_dec_ªd_‹¡
(&
dd
->
a¥m_di§bËd_út
))

126 
	`a¥m_’abË
(
dd
);

127 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
a¥m_lock
, 
æags
);

128 
	}
}

131 
	$__a¥m_ùx_di§bË
(
hfi1_ùxtd©a
 *
rcd
)

133 
boÞ
 
»¡¬t_tim”
;

134 
boÞ
 
þo£_š‹¼u±s
;

135 
æags
;

136 
ktime_t
 
now
, 
´ev
;

138 
	`¥š_lock_œq§ve
(&
rcd
->
a¥m_lock
, 
æags
);

140 ià(!
rcd
->
a¥m_šŒ_’abË
)

141 
uÆock
;

143 
´ev
 = 
rcd
->
a¥m_ts_Ï¡_šŒ
;

144 
now
 = 
	`ktime_g‘
();

145 
rcd
->
a¥m_ts_Ï¡_šŒ
 = 
now
;

148 
þo£_š‹¼u±s
 = 
	`ktime_to_ns
(
	`ktime_sub
(
now
, 
´ev
)è< 
ASPM_TRIGGER_NS
;

151 
»¡¬t_tim”
 = 
	`ktime_to_ns
(
	`ktime_sub
(
now
, 
rcd
->
a¥m_ts_tim”_sched
)) >

152 
ASPM_RESCHED_TIMER_MS
 * 
NSEC_PER_MSEC
;

153 
»¡¬t_tim”
 =„e¡¬t_tim” && 
þo£_š‹¼u±s
;

156 ià(
rcd
->
a¥m_’abËd
 && 
þo£_š‹¼u±s
) {

157 
	`a¥m_di§bË_šc
(
rcd
->
dd
);

158 
rcd
->
a¥m_’abËd
 = 
çl£
;

159 
»¡¬t_tim”
 = 
Œue
;

162 ià(
»¡¬t_tim”
) {

163 
	`mod_tim”
(&
rcd
->
a¥m_tim”
,

164 
jiff›s
 + 
	`m£cs_to_jiff›s
(
ASPM_TIMER_MS
));

165 
rcd
->
a¥m_ts_tim”_sched
 = 
now
;

167 
uÆock
:

168 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
a¥m_lock
, 
æags
);

169 
	}
}

172 
	$a¥m_ùx_tim”_funùiÚ
(
tim”_li¡
 *
t
)

174 
hfi1_ùxtd©a
 *
rcd
 = 
	`äom_tim”
Ôcd, 
t
, 
a¥m_tim”
);

175 
æags
;

177 
	`¥š_lock_œq§ve
(&
rcd
->
a¥m_lock
, 
æags
);

178 
	`a¥m_’abË_dec
(
rcd
->
dd
);

179 
rcd
->
a¥m_’abËd
 = 
Œue
;

180 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
a¥m_lock
, 
æags
);

181 
	}
}

187 
	$a¥m_di§bË_®l
(
hfi1_devd©a
 *
dd
)

189 
hfi1_ùxtd©a
 *
rcd
;

190 
æags
;

191 
u16
 
i
;

193 
i
 = 0; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; i++) {

194 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

195 ià(
rcd
) {

196 
	`d–_tim”_sync
(&
rcd
->
a¥m_tim”
);

197 
	`¥š_lock_œq§ve
(&
rcd
->
a¥m_lock
, 
æags
);

198 
rcd
->
a¥m_šŒ_’abË
 = 
çl£
;

199 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
a¥m_lock
, 
æags
);

200 
	`hfi1_rcd_put
(
rcd
);

204 
	`a¥m_di§bË
(
dd
);

205 
	`©omic_£t
(&
dd
->
a¥m_di§bËd_út
, 0);

206 
	}
}

209 
	$a¥m_’abË_®l
(
hfi1_devd©a
 *
dd
)

211 
hfi1_ùxtd©a
 *
rcd
;

212 
æags
;

213 
u16
 
i
;

215 
	`a¥m_’abË
(
dd
);

217 ià(
a¥m_mode
 !ð
ASPM_MODE_DYNAMIC
)

220 
i
 = 0; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; i++) {

221 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

222 ià(
rcd
) {

223 
	`¥š_lock_œq§ve
(&
rcd
->
a¥m_lock
, 
æags
);

224 
rcd
->
a¥m_šŒ_’abË
 = 
Œue
;

225 
rcd
->
a¥m_’abËd
 = 
Œue
;

226 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
a¥m_lock
, 
æags
);

227 
	`hfi1_rcd_put
(
rcd
);

230 
	}
}

232 
	$a¥m_ùx_š™
(
hfi1_ùxtd©a
 *
rcd
)

234 
	`¥š_lock_š™
(&
rcd
->
a¥m_lock
);

235 
	`tim”_£tup
(&
rcd
->
a¥m_tim”
, 
a¥m_ùx_tim”_funùiÚ
, 0);

236 
rcd
->
a¥m_šŒ_suµÜ‹d
 =„cd->
dd
->
a¥m_suµÜ‹d
 &&

237 
a¥m_mode
 =ð
ASPM_MODE_DYNAMIC
 &&

238 
rcd
->
ùxt
 <„cd->
dd
->
fœ¡_dyn_®loc_ùxt
;

239 
	}
}

241 
	$a¥m_š™
(
hfi1_devd©a
 *
dd
)

243 
hfi1_ùxtd©a
 *
rcd
;

244 
u16
 
i
;

246 
	`¥š_lock_š™
(&
dd
->
a¥m_lock
);

247 
dd
->
a¥m_suµÜ‹d
 = 
	`a¥m_hw_l1_suµÜ‹d
(dd);

249 
i
 = 0; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; i++) {

250 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

251 ià(
rcd
)

252 
	`a¥m_ùx_š™
(
rcd
);

253 
	`hfi1_rcd_put
(
rcd
);

257 
	`a¥m_hw_£t_l1_’t_Ï‹ncy
(
dd
);

258 
dd
->
a¥m_’abËd
 = 
çl£
;

259 
	`a¥m_hw_di§bË_l1
(
dd
);

262 
	`a¥m_’abË_®l
(
dd
);

263 
	}
}

265 
	$a¥m_ex™
(
hfi1_devd©a
 *
dd
)

267 
	`a¥m_di§bË_®l
(
dd
);

270 
	`a¥m_’abË
(
dd
);

271 
	}
}

	@aspm.h

47 #iâdeà
_ASPM_H


48 
	#_ASPM_H


	)

50 
	~"hfi.h
"

52 
ušt
 
a¥m_mode
;

54 
	ea¥m_mode
 {

55 
	mASPM_MODE_DISABLED
 = 0,

56 
	mASPM_MODE_ENABLED
 = 1,

57 
	mASPM_MODE_DYNAMIC
 = 2,

60 
a¥m_š™
(
hfi1_devd©a
 *
dd
);

61 
a¥m_ex™
(
hfi1_devd©a
 *
dd
);

62 
a¥m_hw_di§bË_l1
(
hfi1_devd©a
 *
dd
);

63 
__a¥m_ùx_di§bË
(
hfi1_ùxtd©a
 *
rcd
);

64 
a¥m_di§bË_®l
(
hfi1_devd©a
 *
dd
);

65 
a¥m_’abË_®l
(
hfi1_devd©a
 *
dd
);

67 
šlše
 
	$a¥m_ùx_di§bË
(
hfi1_ùxtd©a
 *
rcd
)

70 ià(
	`lik–y
(!
rcd
->
a¥m_šŒ_suµÜ‹d
))

73 
	`__a¥m_ùx_di§bË
(
rcd
);

74 
	}
}

	@chip.c

52 
	~<lšux/pci.h
>

53 
	~<lšux/d–ay.h
>

54 
	~<lšux/š‹¼u±.h
>

55 
	~<lšux/moduË.h
>

57 
	~"hfi.h
"

58 
	~"Œaû.h
"

59 
	~"mad.h
"

60 
	~"pio.h
"

61 
	~"sdma.h
"

62 
	~"•rom.h
"

63 
	~"efiv¬.h
"

64 
	~"¶©fÜm.h
"

65 
	~"a¥m.h
"

66 
	~"affš™y.h
"

67 
	~"debugfs.h
"

68 
	~"çuÉ.h
"

69 
	~"Ãtdev.h
"

71 
ušt
 
	gnum_vls
 = 
HFI1_MAX_VLS_SUPPORTED
;

72 
moduË_·¿m
(
num_vls
, 
ušt
, 
S_IRUGO
);

73 
MODULE_PARM_DESC
(
num_vls
, "Set‚umber of Virtual Laneso use (1-8)");

82 
ušt
 
	grcv_šŒ_timeout
 = (824 + 16);

83 
moduË_·¿m
(
rcv_šŒ_timeout
, 
ušt
, 
S_IRUGO
);

84 
MODULE_PARM_DESC
(
rcv_šŒ_timeout
, "Receive interrupt mitigationimeout in‚s");

86 
ušt
 
	grcv_šŒ_couÁ
 = 16;

87 
moduË_·¿m
(
rcv_šŒ_couÁ
, 
ušt
, 
S_IRUGO
);

88 
MODULE_PARM_DESC
(
rcv_šŒ_couÁ
, "Receive interrupt mitigation count");

90 
ushÜt
 
	glšk_üc_mask
 = 
SUPPORTED_CRCS
;

91 
moduË_·¿m
(
lšk_üc_mask
, 
ushÜt
, 
S_IRUGO
);

92 
MODULE_PARM_DESC
(
lšk_üc_mask
, "CRCso use onhe†ink");

94 
ušt
 
	gloÝback
;

95 
moduË_·¿m_Çmed
(
loÝback
,†oÝback, 
ušt
, 
S_IRUGO
);

96 
MODULE_PARM_DESC
(
loÝback
, "Put into†oopback mode (1 = serdes, 3 =ƒxternal cable");

99 
ušt
 
	grcv_šŒ_dyÇmic
 = 1;

100 
ushÜt
 
	güc_14b_sidebªd
 = 1;

101 
ušt
 
	gu£_ær
 = 1;

102 
ušt
 
	gquick_lškup
;

104 
	sæag_bË
 {

105 
u64
 
	mæag
;

106 *
	m¡r
;

107 
u16
 
	mexŒa
;

108 
u16
 
	munu£d0
;

109 
u32
 
	munu£d1
;

113 
	#FLAG_ENTRY
(
¡r
, 
exŒa
, 
æag
è{æag, sŒ,ƒxŒa}

	)

114 
	#FLAG_ENTRY0
(
¡r
, 
æag
è{æag, sŒ, 0}

	)

117 
	#SEC_WRITE_DROPPED
 0x1

	)

118 
	#SEC_PACKET_DROPPED
 0x2

	)

119 
	#SEC_SC_HALTED
 0x4

	)

120 
	#SEC_SPC_FREEZE
 0x8

	)

122 
	#DEFAULT_KRCVQS
 2

	)

123 
	#MIN_KERNEL_KCTXTS
 2

	)

124 
	#FIRST_KERNEL_KCTXT
 1

	)

133 
	#RSM_INS_FECN
 0

	)

134 
	#RSM_INS_VNIC
 1

	)

135 
	#RSM_INS_AIP
 2

	)

136 
	#RSM_INS_VERBS
 3

	)

139 
	#emuÏtÜ_»v
(
dd
è((dd)->
œev
 >> 8)

	)

141 
	#is_emuÏtÜ_p
(
dd
è((((dd)->
œev
è& 0xfè=ð3)

	)

142 
	#is_emuÏtÜ_s
(
dd
è((((dd)->
œev
è& 0xfè=ð4)

	)

146 
	#IB_PACKET_TYPE
 2uÎ

	)

147 
	#QW_SHIFT
 6uÎ

	)

149 
	#QPN_WIDTH
 7uÎ

	)

152 
	#LRH_BTH_QW
 0uÎ

	)

153 
	#LRH_BTH_BIT_OFFSET
 48uÎ

	)

154 
	#LRH_BTH_OFFSET
(
off
è((
LRH_BTH_QW
 << 
QW_SHIFT
è| (off))

	)

155 
	#LRH_BTH_MATCH_OFFSET
 
	`LRH_BTH_OFFSET
(
LRH_BTH_BIT_OFFSET
)

	)

156 
	#LRH_BTH_SELECT


	)

157 
	#LRH_BTH_MASK
 3uÎ

	)

158 
	#LRH_BTH_VALUE
 2uÎ

	)

161 
	#LRH_SC_QW
 0uÎ

	)

162 
	#LRH_SC_BIT_OFFSET
 56uÎ

	)

163 
	#LRH_SC_OFFSET
(
off
è((
LRH_SC_QW
 << 
QW_SHIFT
è| (off))

	)

164 
	#LRH_SC_MATCH_OFFSET
 
	`LRH_SC_OFFSET
(
LRH_SC_BIT_OFFSET
)

	)

165 
	#LRH_SC_MASK
 128uÎ

	)

166 
	#LRH_SC_VALUE
 0uÎ

	)

169 
	#LRH_SC_SELECT_OFFSET
 ((
LRH_SC_QW
 << 
QW_SHIFT
è| (60uÎ))

	)

172 
	#QPN_SELECT_OFFSET
 ((1uÎ << 
QW_SHIFT
è| (1uÎ))

	)

178 
	#BTH_DESTQP_QW
 1uÎ

	)

179 
	#BTH_DESTQP_BIT_OFFSET
 16uÎ

	)

180 
	#BTH_DESTQP_OFFSET
(
off
è((
BTH_DESTQP_QW
 << 
QW_SHIFT
è| (off))

	)

181 
	#BTH_DESTQP_MATCH_OFFSET
 
	`BTH_DESTQP_OFFSET
(
BTH_DESTQP_BIT_OFFSET
)

	)

182 
	#BTH_DESTQP_MASK
 0xFFuÎ

	)

183 
	#BTH_DESTQP_VALUE
 0x81uÎ

	)

187 
	#DETH_AIP_SQPN_QW
 3uÎ

	)

188 
	#DETH_AIP_SQPN_BIT_OFFSET
 56uÎ

	)

189 
	#DETH_AIP_SQPN_OFFSET
(
off
è((
DETH_AIP_SQPN_QW
 << 
QW_SHIFT
è| (off))

	)

190 
	#DETH_AIP_SQPN_SELECT_OFFSET
 \

191 
	`DETH_AIP_SQPN_OFFSET
(
DETH_AIP_SQPN_BIT_OFFSET
)

	)

195 
	#L2_TYPE_QW
 0uÎ

	)

196 
	#L2_TYPE_BIT_OFFSET
 61uÎ

	)

197 
	#L2_TYPE_OFFSET
(
off
è((
L2_TYPE_QW
 << 
QW_SHIFT
è| (off))

	)

198 
	#L2_TYPE_MATCH_OFFSET
 
	`L2_TYPE_OFFSET
(
L2_TYPE_BIT_OFFSET
)

	)

199 
	#L2_TYPE_MASK
 3uÎ

	)

200 
	#L2_16B_VALUE
 2uÎ

	)

203 
	#L4_TYPE_QW
 1uÎ

	)

204 
	#L4_TYPE_BIT_OFFSET
 0uÎ

	)

205 
	#L4_TYPE_OFFSET
(
off
è((
L4_TYPE_QW
 << 
QW_SHIFT
è| (off))

	)

206 
	#L4_TYPE_MATCH_OFFSET
 
	`L4_TYPE_OFFSET
(
L4_TYPE_BIT_OFFSET
)

	)

207 
	#L4_16B_TYPE_MASK
 0xFFuÎ

	)

208 
	#L4_16B_ETH_VALUE
 0x78uÎ

	)

211 
	#L4_16B_HDR_VESWID_OFFSET
 ((2 << 
QW_SHIFT
è| (16uÎ))

	)

213 
	#L2_16B_ENTROPY_OFFSET
 ((1 << 
QW_SHIFT
è| (32uÎ))

	)

216 
	#SC2VL_VAL
( \

217 
num
, \

218 
sc0
, 
sc0v®
, \

219 
sc1
, 
sc1v®
, \

220 
sc2
, 
sc2v®
, \

221 
sc3
, 
sc3v®
, \

222 
sc4
, 
sc4v®
, \

223 
sc5
, 
sc5v®
, \

224 
sc6
, 
sc6v®
, \

225 
sc7
, 
sc7v®
) \

227 ((
u64
)(
sc0v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc0
##
_SHIFT
) | \

228 ((
u64
)(
sc1v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc1
##
_SHIFT
) | \

229 ((
u64
)(
sc2v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc2
##
_SHIFT
) | \

230 ((
u64
)(
sc3v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc3
##
_SHIFT
) | \

231 ((
u64
)(
sc4v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc4
##
_SHIFT
) | \

232 ((
u64
)(
sc5v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc5
##
_SHIFT
) | \

233 ((
u64
)(
sc6v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc6
##
_SHIFT
) | \

234 ((
u64
)(
sc7v®
è<< 
SEND_SC2VLT
##
num
##
_SC
##
sc7
##
_SHIFT
) \

235 )

	)

237 
	#DC_SC_VL_VAL
( \

238 
¿nge
, \

239 
e0
, 
e0v®
, \

240 
e1
, 
e1v®
, \

241 
e2
, 
e2v®
, \

242 
e3
, 
e3v®
, \

243 
e4
, 
e4v®
, \

244 
e5
, 
e5v®
, \

245 
e6
, 
e6v®
, \

246 
e7
, 
e7v®
, \

247 
e8
, 
e8v®
, \

248 
e9
, 
e9v®
, \

249 
e10
, 
e10v®
, \

250 
e11
, 
e11v®
, \

251 
e12
, 
e12v®
, \

252 
e13
, 
e13v®
, \

253 
e14
, 
e14v®
, \

254 
e15
, 
e15v®
) \

256 ((
u64
)(
e0v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e0
##
_SHIFT
) | \

257 ((
u64
)(
e1v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e1
##
_SHIFT
) | \

258 ((
u64
)(
e2v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e2
##
_SHIFT
) | \

259 ((
u64
)(
e3v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e3
##
_SHIFT
) | \

260 ((
u64
)(
e4v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e4
##
_SHIFT
) | \

261 ((
u64
)(
e5v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e5
##
_SHIFT
) | \

262 ((
u64
)(
e6v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e6
##
_SHIFT
) | \

263 ((
u64
)(
e7v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e7
##
_SHIFT
) | \

264 ((
u64
)(
e8v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e8
##
_SHIFT
) | \

265 ((
u64
)(
e9v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e9
##
_SHIFT
) | \

266 ((
u64
)(
e10v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e10
##
_SHIFT
) | \

267 ((
u64
)(
e11v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e11
##
_SHIFT
) | \

268 ((
u64
)(
e12v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e12
##
_SHIFT
) | \

269 ((
u64
)(
e13v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e13
##
_SHIFT
) | \

270 ((
u64
)(
e14v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e14
##
_SHIFT
) | \

271 ((
u64
)(
e15v®
è<< 
DCC_CFG_SC_VL_TABLE_
##
¿nge
##
_ENTRY
##
e15
##
_SHIFT
) \

272 )

	)

275 
	#ALL_FROZE
 (
CCE_STATUS_SDMA_FROZE_SMASK
 \

276 | 
CCE_STATUS_RXE_FROZE_SMASK
 \

277 | 
CCE_STATUS_TXE_FROZE_SMASK
 \

278 | 
CCE_STATUS_TXE_PIO_FROZE_SMASK
)

	)

280 
	#ALL_TXE_PAUSE
 (
CCE_STATUS_TXE_PIO_PAUSED_SMASK
 \

281 | 
CCE_STATUS_TXE_PAUSED_SMASK
 \

282 | 
CCE_STATUS_SDMA_PAUSED_SMASK
)

	)

284 
	#ALL_RXE_PAUSE
 
CCE_STATUS_RXE_PAUSED_SMASK


	)

286 
	#CNTR_MAX
 0xFFFFFFFFFFFFFFFFULL

	)

287 
	#CNTR_32BIT_MAX
 0x00000000FFFFFFFF

	)

292 
æag_bË
 
	gcû_”r_¡©us_æags
[] = {

293  
FLAG_ENTRY0
("CceCsrParityErr",

294 
CCE_ERR_STATUS_CCE_CSR_PARITY_ERR_SMASK
),

295  
FLAG_ENTRY0
("CceCsrReadBadAddrErr",

296 
CCE_ERR_STATUS_CCE_CSR_READ_BAD_ADDR_ERR_SMASK
),

297  
FLAG_ENTRY0
("CceCsrWriteBadAddrErr",

298 
CCE_ERR_STATUS_CCE_CSR_WRITE_BAD_ADDR_ERR_SMASK
),

299  
FLAG_ENTRY0
("CceTrgtAsyncFifoParityErr",

300 
CCE_ERR_STATUS_CCE_TRGT_ASYNC_FIFO_PARITY_ERR_SMASK
),

301  
FLAG_ENTRY0
("CceTrgtAccessErr",

302 
CCE_ERR_STATUS_CCE_TRGT_ACCESS_ERR_SMASK
),

303  
FLAG_ENTRY0
("CceRspdDataParityErr",

304 
CCE_ERR_STATUS_CCE_RSPD_DATA_PARITY_ERR_SMASK
),

305  
FLAG_ENTRY0
("CceCli0AsyncFifoParityErr",

306 
CCE_ERR_STATUS_CCE_CLI0_ASYNC_FIFO_PARITY_ERR_SMASK
),

307  
FLAG_ENTRY0
("CceCsrCfgBusParityErr",

308 
CCE_ERR_STATUS_CCE_CSR_CFG_BUS_PARITY_ERR_SMASK
),

309  
FLAG_ENTRY0
("CceCli2AsyncFifoParityErr",

310 
CCE_ERR_STATUS_CCE_CLI2_ASYNC_FIFO_PARITY_ERR_SMASK
),

311  
FLAG_ENTRY0
("CceCli1AsyncFifoPioCrdtParityErr",

312 
CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_PIO_CRDT_PARITY_ERR_SMASK
),

313  
FLAG_ENTRY0
("CceCli1AsyncFifoPioCrdtParityErr",

314 
CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_SDMA_HD_PARITY_ERR_SMASK
),

315  
FLAG_ENTRY0
("CceCli1AsyncFifoRxdmaParityError",

316 
CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_RXDMA_PARITY_ERROR_SMASK
),

317  
FLAG_ENTRY0
("CceCli1AsyncFifoDbgParityError",

318 
CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_DBG_PARITY_ERROR_SMASK
),

319  
FLAG_ENTRY0
("PcicRetryMemCorErr",

320 
CCE_ERR_STATUS_PCIC_RETRY_MEM_COR_ERR_SMASK
),

321  
FLAG_ENTRY0
("PcicRetryMemCorErr",

322 
CCE_ERR_STATUS_PCIC_RETRY_SOT_MEM_COR_ERR_SMASK
),

323  
FLAG_ENTRY0
("PcicPostHdQCorErr",

324 
CCE_ERR_STATUS_PCIC_POST_HD_QCOR_ERR_SMASK
),

325  
FLAG_ENTRY0
("PcicPostHdQCorErr",

326 
CCE_ERR_STATUS_PCIC_POST_DAT_QCOR_ERR_SMASK
),

327  
FLAG_ENTRY0
("PcicPostHdQCorErr",

328 
CCE_ERR_STATUS_PCIC_CPL_HD_QCOR_ERR_SMASK
),

329  
FLAG_ENTRY0
("PcicCplDatQCorErr",

330 
CCE_ERR_STATUS_PCIC_CPL_DAT_QCOR_ERR_SMASK
),

331  
FLAG_ENTRY0
("PcicNPostHQParityErr",

332 
CCE_ERR_STATUS_PCIC_NPOST_HQ_PARITY_ERR_SMASK
),

333  
FLAG_ENTRY0
("PcicNPostDatQParityErr",

334 
CCE_ERR_STATUS_PCIC_NPOST_DAT_QPARITY_ERR_SMASK
),

335  
FLAG_ENTRY0
("PcicRetryMemUncErr",

336 
CCE_ERR_STATUS_PCIC_RETRY_MEM_UNC_ERR_SMASK
),

337  
FLAG_ENTRY0
("PcicRetrySotMemUncErr",

338 
CCE_ERR_STATUS_PCIC_RETRY_SOT_MEM_UNC_ERR_SMASK
),

339  
FLAG_ENTRY0
("PcicPostHdQUncErr",

340 
CCE_ERR_STATUS_PCIC_POST_HD_QUNC_ERR_SMASK
),

341  
FLAG_ENTRY0
("PcicPostDatQUncErr",

342 
CCE_ERR_STATUS_PCIC_POST_DAT_QUNC_ERR_SMASK
),

343  
FLAG_ENTRY0
("PcicCplHdQUncErr",

344 
CCE_ERR_STATUS_PCIC_CPL_HD_QUNC_ERR_SMASK
),

345  
FLAG_ENTRY0
("PcicCplDatQUncErr",

346 
CCE_ERR_STATUS_PCIC_CPL_DAT_QUNC_ERR_SMASK
),

347  
FLAG_ENTRY0
("PcicTransmitFrontParityErr",

348 
CCE_ERR_STATUS_PCIC_TRANSMIT_FRONT_PARITY_ERR_SMASK
),

349  
FLAG_ENTRY0
("PcicTransmitBackParityErr",

350 
CCE_ERR_STATUS_PCIC_TRANSMIT_BACK_PARITY_ERR_SMASK
),

351  
FLAG_ENTRY0
("PcicReceiveParityErr",

352 
CCE_ERR_STATUS_PCIC_RECEIVE_PARITY_ERR_SMASK
),

353  
FLAG_ENTRY0
("CceTrgtCplTimeoutErr",

354 
CCE_ERR_STATUS_CCE_TRGT_CPL_TIMEOUT_ERR_SMASK
),

355  
FLAG_ENTRY0
("LATriggered",

356 
CCE_ERR_STATUS_LA_TRIGGERED_SMASK
),

357  
FLAG_ENTRY0
("CceSegReadBadAddrErr",

358 
CCE_ERR_STATUS_CCE_SEG_READ_BAD_ADDR_ERR_SMASK
),

359  
FLAG_ENTRY0
("CceSegWriteBadAddrErr",

360 
CCE_ERR_STATUS_CCE_SEG_WRITE_BAD_ADDR_ERR_SMASK
),

361  
FLAG_ENTRY0
("CceRcplAsyncFifoParityErr",

362 
CCE_ERR_STATUS_CCE_RCPL_ASYNC_FIFO_PARITY_ERR_SMASK
),

363  
FLAG_ENTRY0
("CceRxdmaConvFifoParityErr",

364 
CCE_ERR_STATUS_CCE_RXDMA_CONV_FIFO_PARITY_ERR_SMASK
),

365  
FLAG_ENTRY0
("CceMsixTableCorErr",

366 
CCE_ERR_STATUS_CCE_MSIX_TABLE_COR_ERR_SMASK
),

367  
FLAG_ENTRY0
("CceMsixTableUncErr",

368 
CCE_ERR_STATUS_CCE_MSIX_TABLE_UNC_ERR_SMASK
),

369  
FLAG_ENTRY0
("CceIntMapCorErr",

370 
CCE_ERR_STATUS_CCE_INT_MAP_COR_ERR_SMASK
),

371  
FLAG_ENTRY0
("CceIntMapUncErr",

372 
CCE_ERR_STATUS_CCE_INT_MAP_UNC_ERR_SMASK
),

373  
FLAG_ENTRY0
("CceMsixCsrParityErr",

374 
CCE_ERR_STATUS_CCE_MSIX_CSR_PARITY_ERR_SMASK
),

381 
	#MES
(
‹xt
è
MISC_ERR_STATUS_MISC_
##‹xt##
_ERR_SMASK


	)

382 
æag_bË
 
	gmisc_”r_¡©us_æags
[] = {

383  
FLAG_ENTRY0
("CSR_PARITY", 
MES
(
CSR_PARITY
)),

384  
FLAG_ENTRY0
("CSR_READ_BAD_ADDR", 
MES
(
CSR_READ_BAD_ADDR
)),

385  
FLAG_ENTRY0
("CSR_WRITE_BAD_ADDR", 
MES
(
CSR_WRITE_BAD_ADDR
)),

386  
FLAG_ENTRY0
("SBUS_WRITE_FAILED", 
MES
(
SBUS_WRITE_FAILED
)),

387  
FLAG_ENTRY0
("KEY_MISMATCH", 
MES
(
KEY_MISMATCH
)),

388  
FLAG_ENTRY0
("FW_AUTH_FAILED", 
MES
(
FW_AUTH_FAILED
)),

389  
FLAG_ENTRY0
("EFUSE_CSR_PARITY", 
MES
(
EFUSE_CSR_PARITY
)),

390  
FLAG_ENTRY0
("EFUSE_READ_BAD_ADDR", 
MES
(
EFUSE_READ_BAD_ADDR
)),

391  
FLAG_ENTRY0
("EFUSE_WRITE", 
MES
(
EFUSE_WRITE
)),

392  
FLAG_ENTRY0
("EFUSE_DONE_PARITY", 
MES
(
EFUSE_DONE_PARITY
)),

393  
FLAG_ENTRY0
("INVALID_EEP_CMD", 
MES
(
INVALID_EEP_CMD
)),

394  
FLAG_ENTRY0
("MBIST_FAIL", 
MES
(
MBIST_FAIL
)),

395  
FLAG_ENTRY0
("PLL_LOCK_FAIL", 
MES
(
PLL_LOCK_FAIL
))

401 
æag_bË
 
	gpio_”r_¡©us_æags
[] = {

402  
FLAG_ENTRY
("PioWriteBadCtxt",

403 
SEC_WRITE_DROPPED
,

404 
SEND_PIO_ERR_STATUS_PIO_WRITE_BAD_CTXT_ERR_SMASK
),

405  
FLAG_ENTRY
("PioWriteAddrParity",

406 
SEC_SPC_FREEZE
,

407 
SEND_PIO_ERR_STATUS_PIO_WRITE_ADDR_PARITY_ERR_SMASK
),

408  
FLAG_ENTRY
("PioCsrParity",

409 
SEC_SPC_FREEZE
,

410 
SEND_PIO_ERR_STATUS_PIO_CSR_PARITY_ERR_SMASK
),

411  
FLAG_ENTRY
("PioSbMemFifo0",

412 
SEC_SPC_FREEZE
,

413 
SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO0_ERR_SMASK
),

414  
FLAG_ENTRY
("PioSbMemFifo1",

415 
SEC_SPC_FREEZE
,

416 
SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO1_ERR_SMASK
),

417  
FLAG_ENTRY
("PioPccFifoParity",

418 
SEC_SPC_FREEZE
,

419 
SEND_PIO_ERR_STATUS_PIO_PCC_FIFO_PARITY_ERR_SMASK
),

420  
FLAG_ENTRY
("PioPecFifoParity",

421 
SEC_SPC_FREEZE
,

422 
SEND_PIO_ERR_STATUS_PIO_PEC_FIFO_PARITY_ERR_SMASK
),

423  
FLAG_ENTRY
("PioSbrdctlCrrelParity",

424 
SEC_SPC_FREEZE
,

425 
SEND_PIO_ERR_STATUS_PIO_SBRDCTL_CRREL_PARITY_ERR_SMASK
),

426  
FLAG_ENTRY
("PioSbrdctrlCrrelFifoParity",

427 
SEC_SPC_FREEZE
,

428 
SEND_PIO_ERR_STATUS_PIO_SBRDCTRL_CRREL_FIFO_PARITY_ERR_SMASK
),

429  
FLAG_ENTRY
("PioPktEvictFifoParityErr",

430 
SEC_SPC_FREEZE
,

431 
SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_FIFO_PARITY_ERR_SMASK
),

432  
FLAG_ENTRY
("PioSmPktResetParity",

433 
SEC_SPC_FREEZE
,

434 
SEND_PIO_ERR_STATUS_PIO_SM_PKT_RESET_PARITY_ERR_SMASK
),

435  
FLAG_ENTRY
("PioVlLenMemBank0Unc",

436 
SEC_SPC_FREEZE
,

437 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK0_UNC_ERR_SMASK
),

438  
FLAG_ENTRY
("PioVlLenMemBank1Unc",

439 
SEC_SPC_FREEZE
,

440 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK1_UNC_ERR_SMASK
),

441  
FLAG_ENTRY
("PioVlLenMemBank0Cor",

443 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK0_COR_ERR_SMASK
),

444  
FLAG_ENTRY
("PioVlLenMemBank1Cor",

446 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK1_COR_ERR_SMASK
),

447  
FLAG_ENTRY
("PioCreditRetFifoParity",

448 
SEC_SPC_FREEZE
,

449 
SEND_PIO_ERR_STATUS_PIO_CREDIT_RET_FIFO_PARITY_ERR_SMASK
),

450  
FLAG_ENTRY
("PioPpmcPblFifo",

451 
SEC_SPC_FREEZE
,

452 
SEND_PIO_ERR_STATUS_PIO_PPMC_PBL_FIFO_ERR_SMASK
),

453  
FLAG_ENTRY
("PioInitSmIn",

455 
SEND_PIO_ERR_STATUS_PIO_INIT_SM_IN_ERR_SMASK
),

456  
FLAG_ENTRY
("PioPktEvictSmOrArbSm",

457 
SEC_SPC_FREEZE
,

458 
SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_SM_OR_ARB_SM_ERR_SMASK
),

459  
FLAG_ENTRY
("PioHostAddrMemUnc",

460 
SEC_SPC_FREEZE
,

461 
SEND_PIO_ERR_STATUS_PIO_HOST_ADDR_MEM_UNC_ERR_SMASK
),

462  
FLAG_ENTRY
("PioHostAddrMemCor",

464 
SEND_PIO_ERR_STATUS_PIO_HOST_ADDR_MEM_COR_ERR_SMASK
),

465  
FLAG_ENTRY
("PioWriteDataParity",

466 
SEC_SPC_FREEZE
,

467 
SEND_PIO_ERR_STATUS_PIO_WRITE_DATA_PARITY_ERR_SMASK
),

468  
FLAG_ENTRY
("PioStateMachine",

469 
SEC_SPC_FREEZE
,

470 
SEND_PIO_ERR_STATUS_PIO_STATE_MACHINE_ERR_SMASK
),

471  
FLAG_ENTRY
("PioWriteQwValidParity",

472 
SEC_WRITE_DROPPED
 | 
SEC_SPC_FREEZE
,

473 
SEND_PIO_ERR_STATUS_PIO_WRITE_QW_VALID_PARITY_ERR_SMASK
),

474  
FLAG_ENTRY
("PioBlockQwCountParity",

475 
SEC_WRITE_DROPPED
 | 
SEC_SPC_FREEZE
,

476 
SEND_PIO_ERR_STATUS_PIO_BLOCK_QW_COUNT_PARITY_ERR_SMASK
),

477  
FLAG_ENTRY
("PioVlfVlLenParity",

478 
SEC_SPC_FREEZE
,

479 
SEND_PIO_ERR_STATUS_PIO_VLF_VL_LEN_PARITY_ERR_SMASK
),

480  
FLAG_ENTRY
("PioVlfSopParity",

481 
SEC_SPC_FREEZE
,

482 
SEND_PIO_ERR_STATUS_PIO_VLF_SOP_PARITY_ERR_SMASK
),

483  
FLAG_ENTRY
("PioVlFifoParity",

484 
SEC_SPC_FREEZE
,

485 
SEND_PIO_ERR_STATUS_PIO_VL_FIFO_PARITY_ERR_SMASK
),

486  
FLAG_ENTRY
("PioPpmcBqcMemParity",

487 
SEC_SPC_FREEZE
,

488 
SEND_PIO_ERR_STATUS_PIO_PPMC_BQC_MEM_PARITY_ERR_SMASK
),

489  
FLAG_ENTRY
("PioPpmcSopLen",

490 
SEC_SPC_FREEZE
,

491 
SEND_PIO_ERR_STATUS_PIO_PPMC_SOP_LEN_ERR_SMASK
),

493  
FLAG_ENTRY
("PioCurrentFreeCntParity",

494 
SEC_SPC_FREEZE
,

495 
SEND_PIO_ERR_STATUS_PIO_CURRENT_FREE_CNT_PARITY_ERR_SMASK
),

496  
FLAG_ENTRY
("PioLastReturnedCntParity",

497 
SEC_SPC_FREEZE
,

498 
SEND_PIO_ERR_STATUS_PIO_LAST_RETURNED_CNT_PARITY_ERR_SMASK
),

499  
FLAG_ENTRY
("PioPccSopHeadParity",

500 
SEC_SPC_FREEZE
,

501 
SEND_PIO_ERR_STATUS_PIO_PCC_SOP_HEAD_PARITY_ERR_SMASK
),

502  
FLAG_ENTRY
("PioPecSopHeadParityErr",

503 
SEC_SPC_FREEZE
,

504 
SEND_PIO_ERR_STATUS_PIO_PEC_SOP_HEAD_PARITY_ERR_SMASK
),

509 
	#ALL_PIO_FREEZE_ERR
 \

510 (
SEND_PIO_ERR_STATUS_PIO_WRITE_ADDR_PARITY_ERR_SMASK
 \

511 | 
SEND_PIO_ERR_STATUS_PIO_CSR_PARITY_ERR_SMASK
 \

512 | 
SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO0_ERR_SMASK
 \

513 | 
SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO1_ERR_SMASK
 \

514 | 
SEND_PIO_ERR_STATUS_PIO_PCC_FIFO_PARITY_ERR_SMASK
 \

515 | 
SEND_PIO_ERR_STATUS_PIO_PEC_FIFO_PARITY_ERR_SMASK
 \

516 | 
SEND_PIO_ERR_STATUS_PIO_SBRDCTL_CRREL_PARITY_ERR_SMASK
 \

517 | 
SEND_PIO_ERR_STATUS_PIO_SBRDCTRL_CRREL_FIFO_PARITY_ERR_SMASK
 \

518 | 
SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_FIFO_PARITY_ERR_SMASK
 \

519 | 
SEND_PIO_ERR_STATUS_PIO_SM_PKT_RESET_PARITY_ERR_SMASK
 \

520 | 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK0_UNC_ERR_SMASK
 \

521 | 
SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK1_UNC_ERR_SMASK
 \

522 | 
SEND_PIO_ERR_STATUS_PIO_CREDIT_RET_FIFO_PARITY_ERR_SMASK
 \

523 | 
SEND_PIO_ERR_STATUS_PIO_PPMC_PBL_FIFO_ERR_SMASK
 \

524 | 
SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_SM_OR_ARB_SM_ERR_SMASK
 \

525 | 
SEND_PIO_ERR_STATUS_PIO_HOST_ADDR_MEM_UNC_ERR_SMASK
 \

526 | 
SEND_PIO_ERR_STATUS_PIO_WRITE_DATA_PARITY_ERR_SMASK
 \

527 | 
SEND_PIO_ERR_STATUS_PIO_STATE_MACHINE_ERR_SMASK
 \

528 | 
SEND_PIO_ERR_STATUS_PIO_WRITE_QW_VALID_PARITY_ERR_SMASK
 \

529 | 
SEND_PIO_ERR_STATUS_PIO_BLOCK_QW_COUNT_PARITY_ERR_SMASK
 \

530 | 
SEND_PIO_ERR_STATUS_PIO_VLF_VL_LEN_PARITY_ERR_SMASK
 \

531 | 
SEND_PIO_ERR_STATUS_PIO_VLF_SOP_PARITY_ERR_SMASK
 \

532 | 
SEND_PIO_ERR_STATUS_PIO_VL_FIFO_PARITY_ERR_SMASK
 \

533 | 
SEND_PIO_ERR_STATUS_PIO_PPMC_BQC_MEM_PARITY_ERR_SMASK
 \

534 | 
SEND_PIO_ERR_STATUS_PIO_PPMC_SOP_LEN_ERR_SMASK
 \

535 | 
SEND_PIO_ERR_STATUS_PIO_CURRENT_FREE_CNT_PARITY_ERR_SMASK
 \

536 | 
SEND_PIO_ERR_STATUS_PIO_LAST_RETURNED_CNT_PARITY_ERR_SMASK
 \

537 | 
SEND_PIO_ERR_STATUS_PIO_PCC_SOP_HEAD_PARITY_ERR_SMASK
 \

538 | 
SEND_PIO_ERR_STATUS_PIO_PEC_SOP_HEAD_PARITY_ERR_SMASK
)

	)

543 
æag_bË
 
	gsdma_”r_¡©us_æags
[] = {

544  
FLAG_ENTRY0
("SDmaRpyTagErr",

545 
SEND_DMA_ERR_STATUS_SDMA_RPY_TAG_ERR_SMASK
),

546  
FLAG_ENTRY0
("SDmaCsrParityErr",

547 
SEND_DMA_ERR_STATUS_SDMA_CSR_PARITY_ERR_SMASK
),

548  
FLAG_ENTRY0
("SDmaPcieReqTrackingUncErr",

549 
SEND_DMA_ERR_STATUS_SDMA_PCIE_REQ_TRACKING_UNC_ERR_SMASK
),

550  
FLAG_ENTRY0
("SDmaPcieReqTrackingCorErr",

551 
SEND_DMA_ERR_STATUS_SDMA_PCIE_REQ_TRACKING_COR_ERR_SMASK
),

556 
	#ALL_SDMA_FREEZE_ERR
 \

557 (
SEND_DMA_ERR_STATUS_SDMA_RPY_TAG_ERR_SMASK
 \

558 | 
SEND_DMA_ERR_STATUS_SDMA_CSR_PARITY_ERR_SMASK
 \

559 | 
SEND_DMA_ERR_STATUS_SDMA_PCIE_REQ_TRACKING_UNC_ERR_SMASK
)

	)

562 
	#PORT_DISCARD_EGRESS_ERRS
 \

563 (
SEND_EGRESS_ERR_INFO_TOO_LONG_IB_PACKET_ERR_SMASK
 \

564 | 
SEND_EGRESS_ERR_INFO_VL_MAPPING_ERR_SMASK
 \

565 | 
SEND_EGRESS_ERR_INFO_VL_ERR_SMASK
)

	)

570 
	#SEES
(
‹xt
è
SEND_EGRESS_ERR_STATUS_
##‹xt##
_ERR_SMASK


	)

571 
æag_bË
 
	geg»ss_”r_¡©us_æags
[] = {

572  
FLAG_ENTRY0
("TxPktIÁegr™yMemCÜE¼", 
SEES
(
TX_PKT_INTEGRITY_MEM_COR
)),

573  
FLAG_ENTRY0
("TxPktIÁegr™yMemUncE¼", 
SEES
(
TX_PKT_INTEGRITY_MEM_UNC
)),

575  
FLAG_ENTRY0
("TxEgressFifoUnderrunOrParityErr",

576 
SEES
(
TX_EGRESS_FIFO_UNDERRUN_OR_PARITY
)),

577  
FLAG_ENTRY0
("TxLškdownE¼", 
SEES
(
TX_LINKDOWN
)),

578  
FLAG_ENTRY0
("TxIncÜ»ùLškS‹E¼", 
SEES
(
TX_INCORRECT_LINK_STATE
)),

580  
FLAG_ENTRY0
("TxPioLaunchIntfParityErr",

581 
SEES
(
TX_PIO_LAUNCH_INTF_PARITY
)),

582  
FLAG_ENTRY0
("TxSdmaLaunchIntfParityErr",

583 
SEES
(
TX_SDMA_LAUNCH_INTF_PARITY
)),

585  
FLAG_ENTRY0
("TxSbrdCtlStateMachineParityErr",

586 
SEES
(
TX_SBRD_CTL_STATE_MACHINE_PARITY
)),

587  
FLAG_ENTRY0
("TxIÎeg®VLE¼", 
SEES
(
TX_ILLEGAL_VL
)),

588  
FLAG_ENTRY0
("TxLaunchC¤P¬™yE¼", 
SEES
(
TX_LAUNCH_CSR_PARITY
)),

589  
FLAG_ENTRY0
("TxSbrdCŽC¤P¬™yE¼", 
SEES
(
TX_SBRD_CTL_CSR_PARITY
)),

590  
FLAG_ENTRY0
("TxCÚfigP¬™yE¼", 
SEES
(
TX_CONFIG_PARITY
)),

591  
FLAG_ENTRY0
("TxSdma0DisallowedPacketErr",

592 
SEES
(
TX_SDMA0_DISALLOWED_PACKET
)),

593  
FLAG_ENTRY0
("TxSdma1DisallowedPacketErr",

594 
SEES
(
TX_SDMA1_DISALLOWED_PACKET
)),

595  
FLAG_ENTRY0
("TxSdma2DisallowedPacketErr",

596 
SEES
(
TX_SDMA2_DISALLOWED_PACKET
)),

597  
FLAG_ENTRY0
("TxSdma3DisallowedPacketErr",

598 
SEES
(
TX_SDMA3_DISALLOWED_PACKET
)),

599  
FLAG_ENTRY0
("TxSdma4DisallowedPacketErr",

600 
SEES
(
TX_SDMA4_DISALLOWED_PACKET
)),

601  
FLAG_ENTRY0
("TxSdma5DisallowedPacketErr",

602 
SEES
(
TX_SDMA5_DISALLOWED_PACKET
)),

603  
FLAG_ENTRY0
("TxSdma6DisallowedPacketErr",

604 
SEES
(
TX_SDMA6_DISALLOWED_PACKET
)),

605  
FLAG_ENTRY0
("TxSdma7DisallowedPacketErr",

606 
SEES
(
TX_SDMA7_DISALLOWED_PACKET
)),

607  
FLAG_ENTRY0
("TxSdma8DisallowedPacketErr",

608 
SEES
(
TX_SDMA8_DISALLOWED_PACKET
)),

609  
FLAG_ENTRY0
("TxSdma9DisallowedPacketErr",

610 
SEES
(
TX_SDMA9_DISALLOWED_PACKET
)),

611  
FLAG_ENTRY0
("TxSdma10DisallowedPacketErr",

612 
SEES
(
TX_SDMA10_DISALLOWED_PACKET
)),

613  
FLAG_ENTRY0
("TxSdma11DisallowedPacketErr",

614 
SEES
(
TX_SDMA11_DISALLOWED_PACKET
)),

615  
FLAG_ENTRY0
("TxSdma12DisallowedPacketErr",

616 
SEES
(
TX_SDMA12_DISALLOWED_PACKET
)),

617  
FLAG_ENTRY0
("TxSdma13DisallowedPacketErr",

618 
SEES
(
TX_SDMA13_DISALLOWED_PACKET
)),

619  
FLAG_ENTRY0
("TxSdma14DisallowedPacketErr",

620 
SEES
(
TX_SDMA14_DISALLOWED_PACKET
)),

621  
FLAG_ENTRY0
("TxSdma15DisallowedPacketErr",

622 
SEES
(
TX_SDMA15_DISALLOWED_PACKET
)),

623  
FLAG_ENTRY0
("TxLaunchFifo0UncOrParityErr",

624 
SEES
(
TX_LAUNCH_FIFO0_UNC_OR_PARITY
)),

625  
FLAG_ENTRY0
("TxLaunchFifo1UncOrParityErr",

626 
SEES
(
TX_LAUNCH_FIFO1_UNC_OR_PARITY
)),

627  
FLAG_ENTRY0
("TxLaunchFifo2UncOrParityErr",

628 
SEES
(
TX_LAUNCH_FIFO2_UNC_OR_PARITY
)),

629  
FLAG_ENTRY0
("TxLaunchFifo3UncOrParityErr",

630 
SEES
(
TX_LAUNCH_FIFO3_UNC_OR_PARITY
)),

631  
FLAG_ENTRY0
("TxLaunchFifo4UncOrParityErr",

632 
SEES
(
TX_LAUNCH_FIFO4_UNC_OR_PARITY
)),

633  
FLAG_ENTRY0
("TxLaunchFifo5UncOrParityErr",

634 
SEES
(
TX_LAUNCH_FIFO5_UNC_OR_PARITY
)),

635  
FLAG_ENTRY0
("TxLaunchFifo6UncOrParityErr",

636 
SEES
(
TX_LAUNCH_FIFO6_UNC_OR_PARITY
)),

637  
FLAG_ENTRY0
("TxLaunchFifo7UncOrParityErr",

638 
SEES
(
TX_LAUNCH_FIFO7_UNC_OR_PARITY
)),

639  
FLAG_ENTRY0
("TxLaunchFifo8UncOrParityErr",

640 
SEES
(
TX_LAUNCH_FIFO8_UNC_OR_PARITY
)),

641  
FLAG_ENTRY0
("TxC»d™R‘uºP¬™yE¼", 
SEES
(
TX_CREDIT_RETURN_PARITY
)),

642  
FLAG_ENTRY0
("TxSbHdrUncE¼", 
SEES
(
TX_SB_HDR_UNC
)),

643  
FLAG_ENTRY0
("TxR—dSdmaMemÜyUncE¼", 
SEES
(
TX_READ_SDMA_MEMORY_UNC
)),

644  
FLAG_ENTRY0
("TxR—dPioMemÜyUncE¼", 
SEES
(
TX_READ_PIO_MEMORY_UNC
)),

645  
FLAG_ENTRY0
("TxEg»ssFifoUncE¼", 
SEES
(
TX_EGRESS_FIFO_UNC
)),

646  
FLAG_ENTRY0
("TxHücIn£¹iÚE¼", 
SEES
(
TX_HCRC_INSERTION
)),

647  
FLAG_ENTRY0
("TxC»d™R‘uºVLE¼", 
SEES
(
TX_CREDIT_RETURN_VL
)),

648  
FLAG_ENTRY0
("TxLaunchFifo0CÜE¼", 
SEES
(
TX_LAUNCH_FIFO0_COR
)),

649  
FLAG_ENTRY0
("TxLaunchFifo1CÜE¼", 
SEES
(
TX_LAUNCH_FIFO1_COR
)),

650  
FLAG_ENTRY0
("TxLaunchFifo2CÜE¼", 
SEES
(
TX_LAUNCH_FIFO2_COR
)),

651  
FLAG_ENTRY0
("TxLaunchFifo3CÜE¼", 
SEES
(
TX_LAUNCH_FIFO3_COR
)),

652  
FLAG_ENTRY0
("TxLaunchFifo4CÜE¼", 
SEES
(
TX_LAUNCH_FIFO4_COR
)),

653  
FLAG_ENTRY0
("TxLaunchFifo5CÜE¼", 
SEES
(
TX_LAUNCH_FIFO5_COR
)),

654  
FLAG_ENTRY0
("TxLaunchFifo6CÜE¼", 
SEES
(
TX_LAUNCH_FIFO6_COR
)),

655  
FLAG_ENTRY0
("TxLaunchFifo7CÜE¼", 
SEES
(
TX_LAUNCH_FIFO7_COR
)),

656  
FLAG_ENTRY0
("TxLaunchFifo8CÜE¼", 
SEES
(
TX_LAUNCH_FIFO8_COR
)),

657  
FLAG_ENTRY0
("TxC»d™Ov”runE¼", 
SEES
(
TX_CREDIT_OVERRUN
)),

658  
FLAG_ENTRY0
("TxSbHdrCÜE¼", 
SEES
(
TX_SB_HDR_COR
)),

659  
FLAG_ENTRY0
("TxR—dSdmaMemÜyCÜE¼", 
SEES
(
TX_READ_SDMA_MEMORY_COR
)),

660  
FLAG_ENTRY0
("TxR—dPioMemÜyCÜE¼", 
SEES
(
TX_READ_PIO_MEMORY_COR
)),

661  
FLAG_ENTRY0
("TxEg»ssFifoCÜE¼", 
SEES
(
TX_EGRESS_FIFO_COR
)),

662  
FLAG_ENTRY0
("TxReadSdmaMemoryCsrUncErr",

663 
SEES
(
TX_READ_SDMA_MEMORY_CSR_UNC
)),

664  
FLAG_ENTRY0
("TxReadPioMemoryCsrUncErr",

665 
SEES
(
TX_READ_PIO_MEMORY_CSR_UNC
)),

671 
	#SEEI
(
‹xt
è
SEND_EGRESS_ERR_INFO_
##‹xt##
_ERR_SMASK


	)

672 
æag_bË
 
	geg»ss_”r_šfo_æags
[] = {

673  
FLAG_ENTRY0
("Reserved", 0ull),

674  
FLAG_ENTRY0
("VLE¼", 
SEEI
(
VL
)),

675  
FLAG_ENTRY0
("JobKeyE¼", 
SEEI
(
JOB_KEY
)),

676  
FLAG_ENTRY0
("JobKeyE¼", 
SEEI
(
JOB_KEY
)),

677  
FLAG_ENTRY0
("P¬t™iÚKeyE¼", 
SEEI
(
PARTITION_KEY
)),

678  
FLAG_ENTRY0
("SLIDE¼", 
SEEI
(
SLID
)),

679  
FLAG_ENTRY0
("OpcodeE¼", 
SEEI
(
OPCODE
)),

680  
FLAG_ENTRY0
("VLM­pšgE¼", 
SEEI
(
VL_MAPPING
)),

681  
FLAG_ENTRY0
("RawE¼", 
SEEI
(
RAW
)),

682  
FLAG_ENTRY0
("RawIPv6E¼", 
SEEI
(
RAW_IPV6
)),

683  
FLAG_ENTRY0
("GRHE¼", 
SEEI
(
GRH
)),

684  
FLAG_ENTRY0
("By·ssE¼", 
SEEI
(
BYPASS
)),

685  
FLAG_ENTRY0
("KDETHPack‘sE¼", 
SEEI
(
KDETH_PACKETS
)),

686  
FLAG_ENTRY0
("NÚKDETHPack‘sE¼", 
SEEI
(
NON_KDETH_PACKETS
)),

687  
FLAG_ENTRY0
("TooSm®lIBPack‘sE¼", 
SEEI
(
TOO_SMALL_IB_PACKETS
)),

688  
FLAG_ENTRY0
("TooSm®lBy·ssPack‘sE¼", 
SEEI
(
TOO_SMALL_BYPASS_PACKETS
)),

689  
FLAG_ENTRY0
("PbcTe¡E¼", 
SEEI
(
PBC_TEST
)),

690  
FLAG_ENTRY0
("BadPktL’E¼", 
SEEI
(
BAD_PKT_LEN
)),

691  
FLAG_ENTRY0
("TooLÚgIBPack‘E¼", 
SEEI
(
TOO_LONG_IB_PACKET
)),

692  
FLAG_ENTRY0
("TooLÚgBy·ssPack‘sE¼", 
SEEI
(
TOO_LONG_BYPASS_PACKETS
)),

693  
FLAG_ENTRY0
("PbcSticR©eCÚŒÞE¼", 
SEEI
(
PBC_STATIC_RATE_CONTROL
)),

694  
FLAG_ENTRY0
("By·ssBadPktL’E¼", 
SEEI
(
BAD_PKT_LEN
)),

698 
	#ALL_TXE_EGRESS_FREEZE_ERR
 \

699 (
	`SEES
(
TX_EGRESS_FIFO_UNDERRUN_OR_PARITY
) \

700 | 
	`SEES
(
TX_PIO_LAUNCH_INTF_PARITY
) \

701 | 
	`SEES
(
TX_SDMA_LAUNCH_INTF_PARITY
) \

702 | 
	`SEES
(
TX_SBRD_CTL_STATE_MACHINE_PARITY
) \

703 | 
	`SEES
(
TX_LAUNCH_CSR_PARITY
) \

704 | 
	`SEES
(
TX_SBRD_CTL_CSR_PARITY
) \

705 | 
	`SEES
(
TX_CONFIG_PARITY
) \

706 | 
	`SEES
(
TX_LAUNCH_FIFO0_UNC_OR_PARITY
) \

707 | 
	`SEES
(
TX_LAUNCH_FIFO1_UNC_OR_PARITY
) \

708 | 
	`SEES
(
TX_LAUNCH_FIFO2_UNC_OR_PARITY
) \

709 | 
	`SEES
(
TX_LAUNCH_FIFO3_UNC_OR_PARITY
) \

710 | 
	`SEES
(
TX_LAUNCH_FIFO4_UNC_OR_PARITY
) \

711 | 
	`SEES
(
TX_LAUNCH_FIFO5_UNC_OR_PARITY
) \

712 | 
	`SEES
(
TX_LAUNCH_FIFO6_UNC_OR_PARITY
) \

713 | 
	`SEES
(
TX_LAUNCH_FIFO7_UNC_OR_PARITY
) \

714 | 
	`SEES
(
TX_LAUNCH_FIFO8_UNC_OR_PARITY
) \

715 | 
	`SEES
(
TX_CREDIT_RETURN_PARITY
))

	)

720 
	#SES
(
Çme
è
SEND_ERR_STATUS_SEND_
##Çme##
_ERR_SMASK


	)

721 
æag_bË
 
	g£nd_”r_¡©us_æags
[] = {

722  
FLAG_ENTRY0
("S’dC¤P¬™yE¼", 
SES
(
CSR_PARITY
)),

723  
FLAG_ENTRY0
("S’dC¤R—dBadAddrE¼", 
SES
(
CSR_READ_BAD_ADDR
)),

724  
FLAG_ENTRY0
("S’dC¤Wr™eBadAddrE¼", 
SES
(
CSR_WRITE_BAD_ADDR
))

730 
æag_bË
 
	gsc_”r_¡©us_æags
[] = {

731  
FLAG_ENTRY
("InconsistentSop",

732 
SEC_PACKET_DROPPED
 | 
SEC_SC_HALTED
,

733 
SEND_CTXT_ERR_STATUS_PIO_INCONSISTENT_SOP_ERR_SMASK
),

734  
FLAG_ENTRY
("DisallowedPacket",

735 
SEC_PACKET_DROPPED
 | 
SEC_SC_HALTED
,

736 
SEND_CTXT_ERR_STATUS_PIO_DISALLOWED_PACKET_ERR_SMASK
),

737  
FLAG_ENTRY
("WriteCrossesBoundary",

738 
SEC_WRITE_DROPPED
 | 
SEC_SC_HALTED
,

739 
SEND_CTXT_ERR_STATUS_PIO_WRITE_CROSSES_BOUNDARY_ERR_SMASK
),

740  
FLAG_ENTRY
("WriteOverflow",

741 
SEC_WRITE_DROPPED
 | 
SEC_SC_HALTED
,

742 
SEND_CTXT_ERR_STATUS_PIO_WRITE_OVERFLOW_ERR_SMASK
),

743  
FLAG_ENTRY
("WriteOutOfBounds",

744 
SEC_WRITE_DROPPED
 | 
SEC_SC_HALTED
,

745 
SEND_CTXT_ERR_STATUS_PIO_WRITE_OUT_OF_BOUNDS_ERR_SMASK
),

752 
	#RXES
(
Çme
è
RCV_ERR_STATUS_RX_
##Çme##
_ERR_SMASK


	)

753 
æag_bË
 
	grxe_”r_¡©us_æags
[] = {

754  
FLAG_ENTRY0
("RxDmaC¤CÜE¼", 
RXES
(
DMA_CSR_COR
)),

755  
FLAG_ENTRY0
("RxDcIÁfP¬™yE¼", 
RXES
(
DC_INTF_PARITY
)),

756  
FLAG_ENTRY0
("RxRcvHdrUncE¼", 
RXES
(
RCV_HDR_UNC
)),

757  
FLAG_ENTRY0
("RxRcvHdrCÜE¼", 
RXES
(
RCV_HDR_COR
)),

758  
FLAG_ENTRY0
("RxRcvD©aUncE¼", 
RXES
(
RCV_DATA_UNC
)),

759  
FLAG_ENTRY0
("RxRcvD©aCÜE¼", 
RXES
(
RCV_DATA_COR
)),

760  
FLAG_ENTRY0
("RxRcvQpM­TabËUncE¼", 
RXES
(
RCV_QP_MAP_TABLE_UNC
)),

761  
FLAG_ENTRY0
("RxRcvQpM­TabËCÜE¼", 
RXES
(
RCV_QP_MAP_TABLE_COR
)),

762  
FLAG_ENTRY0
("RxRcvC¤P¬™yE¼", 
RXES
(
RCV_CSR_PARITY
)),

763  
FLAG_ENTRY0
("RxDcSÝEÝP¬™yE¼", 
RXES
(
DC_SOP_EOP_PARITY
)),

764  
FLAG_ENTRY0
("RxDmaFÏgUncE¼", 
RXES
(
DMA_FLAG_UNC
)),

765  
FLAG_ENTRY0
("RxDmaFÏgCÜE¼", 
RXES
(
DMA_FLAG_COR
)),

766  
FLAG_ENTRY0
("RxRcvFsmEncodšgE¼", 
RXES
(
RCV_FSM_ENCODING
)),

767  
FLAG_ENTRY0
("RxRbufF»eLi¡UncE¼", 
RXES
(
RBUF_FREE_LIST_UNC
)),

768  
FLAG_ENTRY0
("RxRbufF»eLi¡CÜE¼", 
RXES
(
RBUF_FREE_LIST_COR
)),

769  
FLAG_ENTRY0
("RxRbufLookupDesRegUncE¼", 
RXES
(
RBUF_LOOKUP_DES_REG_UNC
)),

770  
FLAG_ENTRY0
("RxRbufLookupDesRegUncCorErr",

771 
RXES
(
RBUF_LOOKUP_DES_REG_UNC_COR
)),

772  
FLAG_ENTRY0
("RxRbufLookupDesUncE¼", 
RXES
(
RBUF_LOOKUP_DES_UNC
)),

773  
FLAG_ENTRY0
("RxRbufLookupDesCÜE¼", 
RXES
(
RBUF_LOOKUP_DES_COR
)),

774  
FLAG_ENTRY0
("RxRbufBlockListReadUncErr",

775 
RXES
(
RBUF_BLOCK_LIST_READ_UNC
)),

776  
FLAG_ENTRY0
("RxRbufBlockListReadCorErr",

777 
RXES
(
RBUF_BLOCK_LIST_READ_COR
)),

778  
FLAG_ENTRY0
("RxRbufCsrQHeadBufNumParityErr",

779 
RXES
(
RBUF_CSR_QHEAD_BUF_NUM_PARITY
)),

780  
FLAG_ENTRY0
("RxRbufCsrQEntCntParityErr",

781 
RXES
(
RBUF_CSR_QENT_CNT_PARITY
)),

782  
FLAG_ENTRY0
("RxRbufCsrQNextBufParityErr",

783 
RXES
(
RBUF_CSR_QNEXT_BUF_PARITY
)),

784  
FLAG_ENTRY0
("RxRbufCsrQVldBitParityErr",

785 
RXES
(
RBUF_CSR_QVLD_BIT_PARITY
)),

786  
FLAG_ENTRY0
("RxRbufC¤QHdPŒP¬™yE¼", 
RXES
(
RBUF_CSR_QHD_PTR_PARITY
)),

787  
FLAG_ENTRY0
("RxRbufC¤QTlPŒP¬™yE¼", 
RXES
(
RBUF_CSR_QTL_PTR_PARITY
)),

788  
FLAG_ENTRY0
("RxRbufCsrQNumOfPktParityErr",

789 
RXES
(
RBUF_CSR_QNUM_OF_PKT_PARITY
)),

790  
FLAG_ENTRY0
("RxRbufC¤QEOPDWP¬™yE¼", 
RXES
(
RBUF_CSR_QEOPDW_PARITY
)),

791  
FLAG_ENTRY0
("RxRbufCtxIdP¬™yE¼", 
RXES
(
RBUF_CTX_ID_PARITY
)),

792  
FLAG_ENTRY0
("RxRBufBadLookupE¼", 
RXES
(
RBUF_BAD_LOOKUP
)),

793  
FLAG_ENTRY0
("RxRbufFuÎE¼", 
RXES
(
RBUF_FULL
)),

794  
FLAG_ENTRY0
("RxRbufEm±yE¼", 
RXES
(
RBUF_EMPTY
)),

795  
FLAG_ENTRY0
("RxRbufFlRdAddrP¬™yE¼", 
RXES
(
RBUF_FL_RD_ADDR_PARITY
)),

796  
FLAG_ENTRY0
("RxRbufFlWrAddrP¬™yE¼", 
RXES
(
RBUF_FL_WR_ADDR_PARITY
)),

797  
FLAG_ENTRY0
("RxRbufFlInitdoneParityErr",

798 
RXES
(
RBUF_FL_INITDONE_PARITY
)),

799  
FLAG_ENTRY0
("RxRbufFlInitWrAddrParityErr",

800 
RXES
(
RBUF_FL_INIT_WR_ADDR_PARITY
)),

801  
FLAG_ENTRY0
("RxRbufNextF»eBufUncE¼", 
RXES
(
RBUF_NEXT_FREE_BUF_UNC
)),

802  
FLAG_ENTRY0
("RxRbufNextF»eBufCÜE¼", 
RXES
(
RBUF_NEXT_FREE_BUF_COR
)),

803  
FLAG_ENTRY0
("RxLookupDesP¬t1UncE¼", 
RXES
(
LOOKUP_DES_PART1_UNC
)),

804  
FLAG_ENTRY0
("RxLookupDesPart1UncCorErr",

805 
RXES
(
LOOKUP_DES_PART1_UNC_COR
)),

806  
FLAG_ENTRY0
("RxLookupDesPart2ParityErr",

807 
RXES
(
LOOKUP_DES_PART2_PARITY
)),

808  
FLAG_ENTRY0
("RxLookupRcvA¼ayUncE¼", 
RXES
(
LOOKUP_RCV_ARRAY_UNC
)),

809  
FLAG_ENTRY0
("RxLookupRcvA¼ayCÜE¼", 
RXES
(
LOOKUP_RCV_ARRAY_COR
)),

810  
FLAG_ENTRY0
("RxLookupC¤P¬™yE¼", 
RXES
(
LOOKUP_CSR_PARITY
)),

811  
FLAG_ENTRY0
("RxHqIÁrC¤P¬™yE¼", 
RXES
(
HQ_INTR_CSR_PARITY
)),

812  
FLAG_ENTRY0
("RxHqIÁrFsmE¼", 
RXES
(
HQ_INTR_FSM
)),

813  
FLAG_ENTRY0
("RxRbufDescP¬t1UncE¼", 
RXES
(
RBUF_DESC_PART1_UNC
)),

814  
FLAG_ENTRY0
("RxRbufDescP¬t1CÜE¼", 
RXES
(
RBUF_DESC_PART1_COR
)),

815  
FLAG_ENTRY0
("RxRbufDescP¬t2UncE¼", 
RXES
(
RBUF_DESC_PART2_UNC
)),

816  
FLAG_ENTRY0
("RxRbufDescP¬t2CÜE¼", 
RXES
(
RBUF_DESC_PART2_COR
)),

817  
FLAG_ENTRY0
("RxDmaHdrFifoRdUncE¼", 
RXES
(
DMA_HDR_FIFO_RD_UNC
)),

818  
FLAG_ENTRY0
("RxDmaHdrFifoRdCÜE¼", 
RXES
(
DMA_HDR_FIFO_RD_COR
)),

819  
FLAG_ENTRY0
("RxDmaD©aFifoRdUncE¼", 
RXES
(
DMA_DATA_FIFO_RD_UNC
)),

820  
FLAG_ENTRY0
("RxDmaD©aFifoRdCÜE¼", 
RXES
(
DMA_DATA_FIFO_RD_COR
)),

821  
FLAG_ENTRY0
("RxRbufD©aUncE¼", 
RXES
(
RBUF_DATA_UNC
)),

822  
FLAG_ENTRY0
("RxRbufD©aCÜE¼", 
RXES
(
RBUF_DATA_COR
)),

823  
FLAG_ENTRY0
("RxDmaC¤P¬™yE¼", 
RXES
(
DMA_CSR_PARITY
)),

824  
FLAG_ENTRY0
("RxDmaEqFsmEncodšgE¼", 
RXES
(
DMA_EQ_FSM_ENCODING
)),

825  
FLAG_ENTRY0
("RxDmaDqFsmEncodšgE¼", 
RXES
(
DMA_DQ_FSM_ENCODING
)),

826  
FLAG_ENTRY0
("RxDmaC¤UncE¼", 
RXES
(
DMA_CSR_UNC
)),

827  
FLAG_ENTRY0
("RxC¤R—dBadAddrE¼", 
RXES
(
CSR_READ_BAD_ADDR
)),

828  
FLAG_ENTRY0
("RxC¤Wr™eBadAddrE¼", 
RXES
(
CSR_WRITE_BAD_ADDR
)),

829  
FLAG_ENTRY0
("RxC¤P¬™yE¼", 
RXES
(
CSR_PARITY
))

833 
	#ALL_RXE_FREEZE_ERR
 \

834 (
RCV_ERR_STATUS_RX_RCV_QP_MAP_TABLE_UNC_ERR_SMASK
 \

835 | 
RCV_ERR_STATUS_RX_RCV_CSR_PARITY_ERR_SMASK
 \

836 | 
RCV_ERR_STATUS_RX_DMA_FLAG_UNC_ERR_SMASK
 \

837 | 
RCV_ERR_STATUS_RX_RCV_FSM_ENCODING_ERR_SMASK
 \

838 | 
RCV_ERR_STATUS_RX_RBUF_FREE_LIST_UNC_ERR_SMASK
 \

839 | 
RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_REG_UNC_ERR_SMASK
 \

840 | 
RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_REG_UNC_COR_ERR_SMASK
 \

841 | 
RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_UNC_ERR_SMASK
 \

842 | 
RCV_ERR_STATUS_RX_RBUF_BLOCK_LIST_READ_UNC_ERR_SMASK
 \

843 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QHEAD_BUF_NUM_PARITY_ERR_SMASK
 \

844 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QENT_CNT_PARITY_ERR_SMASK
 \

845 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QNEXT_BUF_PARITY_ERR_SMASK
 \

846 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QVLD_BIT_PARITY_ERR_SMASK
 \

847 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QHD_PTR_PARITY_ERR_SMASK
 \

848 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QTL_PTR_PARITY_ERR_SMASK
 \

849 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QNUM_OF_PKT_PARITY_ERR_SMASK
 \

850 | 
RCV_ERR_STATUS_RX_RBUF_CSR_QEOPDW_PARITY_ERR_SMASK
 \

851 | 
RCV_ERR_STATUS_RX_RBUF_CTX_ID_PARITY_ERR_SMASK
 \

852 | 
RCV_ERR_STATUS_RX_RBUF_BAD_LOOKUP_ERR_SMASK
 \

853 | 
RCV_ERR_STATUS_RX_RBUF_FULL_ERR_SMASK
 \

854 | 
RCV_ERR_STATUS_RX_RBUF_EMPTY_ERR_SMASK
 \

855 | 
RCV_ERR_STATUS_RX_RBUF_FL_RD_ADDR_PARITY_ERR_SMASK
 \

856 | 
RCV_ERR_STATUS_RX_RBUF_FL_WR_ADDR_PARITY_ERR_SMASK
 \

857 | 
RCV_ERR_STATUS_RX_RBUF_FL_INITDONE_PARITY_ERR_SMASK
 \

858 | 
RCV_ERR_STATUS_RX_RBUF_FL_INIT_WR_ADDR_PARITY_ERR_SMASK
 \

859 | 
RCV_ERR_STATUS_RX_RBUF_NEXT_FREE_BUF_UNC_ERR_SMASK
 \

860 | 
RCV_ERR_STATUS_RX_LOOKUP_DES_PART1_UNC_ERR_SMASK
 \

861 | 
RCV_ERR_STATUS_RX_LOOKUP_DES_PART1_UNC_COR_ERR_SMASK
 \

862 | 
RCV_ERR_STATUS_RX_LOOKUP_DES_PART2_PARITY_ERR_SMASK
 \

863 | 
RCV_ERR_STATUS_RX_LOOKUP_RCV_ARRAY_UNC_ERR_SMASK
 \

864 | 
RCV_ERR_STATUS_RX_LOOKUP_CSR_PARITY_ERR_SMASK
 \

865 | 
RCV_ERR_STATUS_RX_HQ_INTR_CSR_PARITY_ERR_SMASK
 \

866 | 
RCV_ERR_STATUS_RX_HQ_INTR_FSM_ERR_SMASK
 \

867 | 
RCV_ERR_STATUS_RX_RBUF_DESC_PART1_UNC_ERR_SMASK
 \

868 | 
RCV_ERR_STATUS_RX_RBUF_DESC_PART1_COR_ERR_SMASK
 \

869 | 
RCV_ERR_STATUS_RX_RBUF_DESC_PART2_UNC_ERR_SMASK
 \

870 | 
RCV_ERR_STATUS_RX_DMA_HDR_FIFO_RD_UNC_ERR_SMASK
 \

871 | 
RCV_ERR_STATUS_RX_DMA_DATA_FIFO_RD_UNC_ERR_SMASK
 \

872 | 
RCV_ERR_STATUS_RX_RBUF_DATA_UNC_ERR_SMASK
 \

873 | 
RCV_ERR_STATUS_RX_DMA_CSR_PARITY_ERR_SMASK
 \

874 | 
RCV_ERR_STATUS_RX_DMA_EQ_FSM_ENCODING_ERR_SMASK
 \

875 | 
RCV_ERR_STATUS_RX_DMA_DQ_FSM_ENCODING_ERR_SMASK
 \

876 | 
RCV_ERR_STATUS_RX_DMA_CSR_UNC_ERR_SMASK
 \

877 | 
RCV_ERR_STATUS_RX_CSR_PARITY_ERR_SMASK
)

	)

879 
	#RXE_FREEZE_ABORT_MASK
 \

880 (
RCV_ERR_STATUS_RX_DMA_CSR_UNC_ERR_SMASK
 | \

881 
RCV_ERR_STATUS_RX_DMA_HDR_FIFO_RD_UNC_ERR_SMASK
 | \

882 
RCV_ERR_STATUS_RX_DMA_DATA_FIFO_RD_UNC_ERR_SMASK
)

	)

887 
	#DCCE
(
Çme
è
DCC_ERR_FLG_
##Çme##
_SMASK


	)

888 
æag_bË
 
	gdcc_”r_æags
[] = {

889 
FLAG_ENTRY0
("bad_l2_”r", 
DCCE
(
BAD_L2_ERR
)),

890 
FLAG_ENTRY0
("bad_sc_”r", 
DCCE
(
BAD_SC_ERR
)),

891 
FLAG_ENTRY0
("bad_mid_ž_”r", 
DCCE
(
BAD_MID_TAIL_ERR
)),

892 
FLAG_ENTRY0
("bad_´“m±iÚ_”r", 
DCCE
(
BAD_PREEMPTION_ERR
)),

893 
FLAG_ENTRY0
("´“m±iÚ_”r", 
DCCE
(
PREEMPTION_ERR
)),

894 
FLAG_ENTRY0
("´“m±iÚvl15_”r", 
DCCE
(
PREEMPTIONVL15_ERR
)),

895 
FLAG_ENTRY0
("bad_vl_m¬k”_”r", 
DCCE
(
BAD_VL_MARKER_ERR
)),

896 
FLAG_ENTRY0
("bad_dlid_rg‘_”r", 
DCCE
(
BAD_DLID_TARGET_ERR
)),

897 
FLAG_ENTRY0
("bad_lv”_”r", 
DCCE
(
BAD_LVER_ERR
)),

898 
FLAG_ENTRY0
("uncÜ»ùabË_”r", 
DCCE
(
UNCORRECTABLE_ERR
)),

899 
FLAG_ENTRY0
("bad_üdt_ack_”r", 
DCCE
(
BAD_CRDT_ACK_ERR
)),

900 
FLAG_ENTRY0
("unsup_pkt_ty³", 
DCCE
(
UNSUP_PKT_TYPE
)),

901 
FLAG_ENTRY0
("bad_ù¾_æ™_”r", 
DCCE
(
BAD_CTRL_FLIT_ERR
)),

902 
FLAG_ENTRY0
("ev’t_úŒ_·r™y_”r", 
DCCE
(
EVENT_CNTR_PARITY_ERR
)),

903 
FLAG_ENTRY0
("ev’t_úŒ_rÞlov”_”r", 
DCCE
(
EVENT_CNTR_ROLLOVER_ERR
)),

904 
FLAG_ENTRY0
("lšk_”r", 
DCCE
(
LINK_ERR
)),

905 
FLAG_ENTRY0
("misc_úŒ_rÞlov”_”r", 
DCCE
(
MISC_CNTR_ROLLOVER_ERR
)),

906 
FLAG_ENTRY0
("bad_ù¾_di¡_”r", 
DCCE
(
BAD_CTRL_DIST_ERR
)),

907 
FLAG_ENTRY0
("bad_ž_di¡_”r", 
DCCE
(
BAD_TAIL_DIST_ERR
)),

908 
FLAG_ENTRY0
("bad_h—d_di¡_”r", 
DCCE
(
BAD_HEAD_DIST_ERR
)),

909 
FLAG_ENTRY0
("nÚvl15_¡©e_”r", 
DCCE
(
NONVL15_STATE_ERR
)),

910 
FLAG_ENTRY0
("vl15_muÉi_”r", 
DCCE
(
VL15_MULTI_ERR
)),

911 
FLAG_ENTRY0
("bad_pkt_Ëngth_”r", 
DCCE
(
BAD_PKT_LENGTH_ERR
)),

912 
FLAG_ENTRY0
("unsup_vl_”r", 
DCCE
(
UNSUP_VL_ERR
)),

913 
FLAG_ENTRY0
("³rm_nvl15_”r", 
DCCE
(
PERM_NVL15_ERR
)),

914 
FLAG_ENTRY0
("¦id_z”o_”r", 
DCCE
(
SLID_ZERO_ERR
)),

915 
FLAG_ENTRY0
("dlid_z”o_”r", 
DCCE
(
DLID_ZERO_ERR
)),

916 
FLAG_ENTRY0
("Ëngth_mtu_”r", 
DCCE
(
LENGTH_MTU_ERR
)),

917 
FLAG_ENTRY0
("rx_—¾y_drÝ_”r", 
DCCE
(
RX_EARLY_DROP_ERR
)),

918 
FLAG_ENTRY0
("Ï‹_shÜt_”r", 
DCCE
(
LATE_SHORT_ERR
)),

919 
FLAG_ENTRY0
("Ï‹_lÚg_”r", 
DCCE
(
LATE_LONG_ERR
)),

920 
FLAG_ENTRY0
("Ï‹_ebp_”r", 
DCCE
(
LATE_EBP_ERR
)),

921 
FLAG_ENTRY0
("åe_tx_fifo_ovæw_”r", 
DCCE
(
FPE_TX_FIFO_OVFLW_ERR
)),

922 
FLAG_ENTRY0
("åe_tx_fifo_unæw_”r", 
DCCE
(
FPE_TX_FIFO_UNFLW_ERR
)),

923 
FLAG_ENTRY0
("c¤_acûss_blocked_ho¡", 
DCCE
(
CSR_ACCESS_BLOCKED_HOST
)),

924 
FLAG_ENTRY0
("c¤_acûss_blocked_uc", 
DCCE
(
CSR_ACCESS_BLOCKED_UC
)),

925 
FLAG_ENTRY0
("tx_ù¾_·r™y_”r", 
DCCE
(
TX_CTRL_PARITY_ERR
)),

926 
FLAG_ENTRY0
("tx_ù¾_·r™y_mbe_”r", 
DCCE
(
TX_CTRL_PARITY_MBE_ERR
)),

927 
FLAG_ENTRY0
("tx_sc_·r™y_”r", 
DCCE
(
TX_SC_PARITY_ERR
)),

928 
FLAG_ENTRY0
("rx_ù¾_·r™y_mbe_”r", 
DCCE
(
RX_CTRL_PARITY_MBE_ERR
)),

929 
FLAG_ENTRY0
("c¤_·r™y_”r", 
DCCE
(
CSR_PARITY_ERR
)),

930 
FLAG_ENTRY0
("c¤_šv®_addr", 
DCCE
(
CSR_INVAL_ADDR
)),

931 
FLAG_ENTRY0
("tx_by‹_shá_·r™y_”r", 
DCCE
(
TX_BYTE_SHFT_PARITY_ERR
)),

932 
FLAG_ENTRY0
("rx_by‹_shá_·r™y_”r", 
DCCE
(
RX_BYTE_SHFT_PARITY_ERR
)),

933 
FLAG_ENTRY0
("fmcÚfig_”r", 
DCCE
(
FMCONFIG_ERR
)),

934 
FLAG_ENTRY0
("rcvpÜt_”r", 
DCCE
(
RCVPORT_ERR
)),

940 
	#LCBE
(
Çme
è
DC_LCB_ERR_FLG_
##Çme##
_SMASK


	)

941 
æag_bË
 
	glcb_”r_æags
[] = {

942  
FLAG_ENTRY0
("CSR_PARITY_ERR", 
LCBE
(
CSR_PARITY_ERR
)),

943  
FLAG_ENTRY0
("INVALID_CSR_ADDR", 
LCBE
(
INVALID_CSR_ADDR
)),

944  
FLAG_ENTRY0
("RST_FOR_FAILED_DESKEW", 
LCBE
(
RST_FOR_FAILED_DESKEW
)),

945  
FLAG_ENTRY0
("ALL_LNS_FAILED_REINIT_TEST",

946 
LCBE
(
ALL_LNS_FAILED_REINIT_TEST
)),

947  
FLAG_ENTRY0
("LOST_REINIT_STALL_OR_TOS", 
LCBE
(
LOST_REINIT_STALL_OR_TOS
)),

948  
FLAG_ENTRY0
("TX_LESS_THAN_FOUR_LNS", 
LCBE
(
TX_LESS_THAN_FOUR_LNS
)),

949  
FLAG_ENTRY0
("RX_LESS_THAN_FOUR_LNS", 
LCBE
(
RX_LESS_THAN_FOUR_LNS
)),

950  
FLAG_ENTRY0
("SEQ_CRC_ERR", 
LCBE
(
SEQ_CRC_ERR
)),

951  
FLAG_ENTRY0
("REINIT_FROM_PEER", 
LCBE
(
REINIT_FROM_PEER
)),

952  
FLAG_ENTRY0
("REINIT_FOR_LN_DEGRADE", 
LCBE
(
REINIT_FOR_LN_DEGRADE
)),

953  
FLAG_ENTRY0
("CRC_ERR_CNT_HIT_LIMIT", 
LCBE
(
CRC_ERR_CNT_HIT_LIMIT
)),

954  
FLAG_ENTRY0
("RCLK_STOPPED", 
LCBE
(
RCLK_STOPPED
)),

955  
FLAG_ENTRY0
("UNEXPECTED_REPLAY_MARKER", 
LCBE
(
UNEXPECTED_REPLAY_MARKER
)),

956  
FLAG_ENTRY0
("UNEXPECTED_ROUND_TRIP_MARKER",

957 
LCBE
(
UNEXPECTED_ROUND_TRIP_MARKER
)),

958  
FLAG_ENTRY0
("ILLEGAL_NULL_LTP", 
LCBE
(
ILLEGAL_NULL_LTP
)),

959  
FLAG_ENTRY0
("ILLEGAL_FLIT_ENCODING", 
LCBE
(
ILLEGAL_FLIT_ENCODING
)),

960  
FLAG_ENTRY0
("FLIT_INPUT_BUF_OFLW", 
LCBE
(
FLIT_INPUT_BUF_OFLW
)),

961  
FLAG_ENTRY0
("VL_ACK_INPUT_BUF_OFLW", 
LCBE
(
VL_ACK_INPUT_BUF_OFLW
)),

962  
FLAG_ENTRY0
("VL_ACK_INPUT_PARITY_ERR", 
LCBE
(
VL_ACK_INPUT_PARITY_ERR
)),

963  
FLAG_ENTRY0
("VL_ACK_INPUT_WRONG_CRC_MODE",

964 
LCBE
(
VL_ACK_INPUT_WRONG_CRC_MODE
)),

965  
FLAG_ENTRY0
("FLIT_INPUT_BUF_MBE", 
LCBE
(
FLIT_INPUT_BUF_MBE
)),

966  
FLAG_ENTRY0
("FLIT_INPUT_BUF_SBE", 
LCBE
(
FLIT_INPUT_BUF_SBE
)),

967  
FLAG_ENTRY0
("REPLAY_BUF_MBE", 
LCBE
(
REPLAY_BUF_MBE
)),

968  
FLAG_ENTRY0
("REPLAY_BUF_SBE", 
LCBE
(
REPLAY_BUF_SBE
)),

969  
FLAG_ENTRY0
("CREDIT_RETURN_FLIT_MBE", 
LCBE
(
CREDIT_RETURN_FLIT_MBE
)),

970  
FLAG_ENTRY0
("RST_FOR_LINK_TIMEOUT", 
LCBE
(
RST_FOR_LINK_TIMEOUT
)),

971  
FLAG_ENTRY0
("RST_FOR_INCOMPLT_RND_TRIP",

972 
LCBE
(
RST_FOR_INCOMPLT_RND_TRIP
)),

973  
FLAG_ENTRY0
("HOLD_REINIT", 
LCBE
(
HOLD_REINIT
)),

974  
FLAG_ENTRY0
("NEG_EDGE_LINK_TRANSFER_ACTIVE",

975 
LCBE
(
NEG_EDGE_LINK_TRANSFER_ACTIVE
)),

976  
FLAG_ENTRY0
("REDUNDANT_FLIT_PARITY_ERR",

977 
LCBE
(
REDUNDANT_FLIT_PARITY_ERR
))

983 
	#D8E
(
Çme
è
DC_DC8051_ERR_FLG_
##Çme##
_SMASK


	)

984 
æag_bË
 
	gdc8051_”r_æags
[] = {

985 
FLAG_ENTRY0
("SET_BY_8051", 
D8E
(
SET_BY_8051
)),

986 
FLAG_ENTRY0
("LOST_8051_HEART_BEAT", 
D8E
(
LOST_8051_HEART_BEAT
)),

987 
FLAG_ENTRY0
("CRAM_MBE", 
D8E
(
CRAM_MBE
)),

988 
FLAG_ENTRY0
("CRAM_SBE", 
D8E
(
CRAM_SBE
)),

989 
FLAG_ENTRY0
("DRAM_MBE", 
D8E
(
DRAM_MBE
)),

990 
FLAG_ENTRY0
("DRAM_SBE", 
D8E
(
DRAM_SBE
)),

991 
FLAG_ENTRY0
("IRAM_MBE", 
D8E
(
IRAM_MBE
)),

992 
FLAG_ENTRY0
("IRAM_SBE", 
D8E
(
IRAM_SBE
)),

993 
FLAG_ENTRY0
("UNMATCHED_SECURE_MSG_ACROSS_BCC_LANES",

994 
D8E
(
UNMATCHED_SECURE_MSG_ACROSS_BCC_LANES
)),

995 
FLAG_ENTRY0
("INVALID_CSR_ADDR", 
D8E
(
INVALID_CSR_ADDR
)),

1003 
æag_bË
 
	gdc8051_šfo_”r_æags
[] = {

1004 
FLAG_ENTRY0
("SpicØROM check fažed", 
SPICO_ROM_FAILED
),

1005 
FLAG_ENTRY0
("UnknowÀäam»ûived", 
UNKNOWN_FRAME
),

1006 
FLAG_ENTRY0
("T¬g‘ BER‚Ù m‘", 
TARGET_BER_NOT_MET
),

1007 
FLAG_ENTRY0
("Serdes internal†oopback failure",

1008 
FAILED_SERDES_INTERNAL_LOOPBACK
),

1009 
FLAG_ENTRY0
("Fažed S”De š™", 
FAILED_SERDES_INIT
),

1010 
FLAG_ENTRY0
("Fažed LNI(PÞlšg)", 
FAILED_LNI_POLLING
),

1011 
FLAG_ENTRY0
("Fažed LNI(Debounû)", 
FAILED_LNI_DEBOUNCE
),

1012 
FLAG_ENTRY0
("Fažed LNI(E¡bComm)", 
FAILED_LNI_ESTBCOMM
),

1013 
FLAG_ENTRY0
("Fažed LNI(O±Eq)", 
FAILED_LNI_OPTEQ
),

1014 
FLAG_ENTRY0
("Fažed LNI(V”ifyC­_1)", 
FAILED_LNI_VERIFY_CAP1
),

1015 
FLAG_ENTRY0
("Fažed LNI(V”ifyC­_2)", 
FAILED_LNI_VERIFY_CAP2
),

1016 
FLAG_ENTRY0
("Fažed LNI(CÚfigLT)", 
FAILED_LNI_CONFIGLT
),

1017 
FLAG_ENTRY0
("Ho¡ HªdshakTimeout", 
HOST_HANDSHAKE_TIMEOUT
),

1018 
FLAG_ENTRY0
("External Device Request Timeout",

1019 
EXTERNAL_DEVICE_REQ_TIMEOUT
),

1027 
æag_bË
 
	gdc8051_šfo_ho¡_msg_æags
[] = {

1028 
FLAG_ENTRY0
("Host„equest done", 0x0001),

1029 
FLAG_ENTRY0
("BC PWR_MGM message", 0x0002),

1030 
FLAG_ENTRY0
("BC SMA message", 0x0004),

1031 
FLAG_ENTRY0
("BC Unknown message (BCC)", 0x0008),

1032 
FLAG_ENTRY0
("BC Unknown message (LCB)", 0x0010),

1033 
FLAG_ENTRY0
("External device config„equest", 0x0020),

1034 
FLAG_ENTRY0
("VerifyCap‡ll frames„eceived", 0x0040),

1035 
FLAG_ENTRY0
("LinkUp‡chieved", 0x0080),

1036 
FLAG_ENTRY0
("Link going down", 0x0100),

1037 
FLAG_ENTRY0
("Link width downgraded", 0x0200),

1040 
u32
 
’coded_size
(u32 
size
);

1041 
u32
 
ch_to_Ýa_l¡©e
(
hfi1_devd©a
 *
dd
, u32 
ch_l¡©e
);

1042 
£t_physiÿl_lšk_¡©e
(
hfi1_devd©a
 *
dd
, 
u64
 
¡©e
);

1043 
»ad_vc_»mÙe_phy
(
hfi1_devd©a
 *
dd
, 
u8
 *
pow”_mªagem’t
,

1044 
u8
 *
cÚtšuous
);

1045 
»ad_vc_»mÙe_çbric
(
hfi1_devd©a
 *
dd
, 
u8
 *
vau
, u8 *
z
,

1046 
u8
 *
vcu
, 
u16
 *
vl15buf
, u8 *
üc_sizes
);

1047 
»ad_vc_»mÙe_lšk_width
(
hfi1_devd©a
 *
dd
,

1048 
u8
 *
»mÙe_tx_¿‹
, 
u16
 *
lšk_widths
);

1049 
»ad_vc_loÿl_lšk_mode
(
hfi1_devd©a
 *
dd
, 
u8
 *
misc_b™s
,

1050 
u8
 *
æag_b™s
, 
u16
 *
lšk_widths
);

1051 
»ad_»mÙe_deviû_id
(
hfi1_devd©a
 *
dd
, 
u16
 *
deviû_id
,

1052 
u8
 *
deviû_»v
);

1053 
»ad_mgmt_®lowed
(
hfi1_devd©a
 *
dd
, 
u8
 *
mgmt_®lowed
);

1054 
»ad_loÿl_Êi
(
hfi1_devd©a
 *
dd
, 
u8
 *
’abË_ÏÃ_rx
);

1055 
»ad_tx_£‰šgs
(
hfi1_devd©a
 *
dd
, 
u8
 *
’abË_ÏÃ_tx
,

1056 
u8
 *
tx_pÞ¬™y_šv”siÚ
,

1057 
u8
 *
rx_pÞ¬™y_šv”siÚ
, u8 *
max_¿‹
);

1058 
hªdË_sdma_’g_”r
(
hfi1_devd©a
 *
dd
,

1059 
cÚ‹xt
, 
u64
 
”r_¡©us
);

1060 
hªdË_qså_št
(
hfi1_devd©a
 *
dd
, 
u32
 
sourû
, 
u64
 
»g
);

1061 
hªdË_dcc_”r
(
hfi1_devd©a
 *
dd
,

1062 
cÚ‹xt
, 
u64
 
”r_¡©us
);

1063 
hªdË_lcb_”r
(
hfi1_devd©a
 *
dd
,

1064 
cÚ‹xt
, 
u64
 
”r_¡©us
);

1065 
hªdË_8051_š‹¼u±
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1066 
hªdË_cû_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1067 
hªdË_rxe_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1068 
hªdË_misc_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1069 
hªdË_pio_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1070 
hªdË_sdma_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1071 
hªdË_eg»ss_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1072 
hªdË_txe_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
);

1073 
£t_·¹™iÚ_keys
(
hfi1_µÜtd©a
 *
µd
);

1074 cÚ¡ *
lšk_¡©e_Çme
(
u32
 
¡©e
);

1075 cÚ¡ *
lšk_¡©e_»asÚ_Çme
(
hfi1_µÜtd©a
 *
µd
,

1076 
u32
 
¡©e
);

1077 
do_8051_commªd
(
hfi1_devd©a
 *
dd
, 
u32
 
ty³
, 
u64
 
š_d©a
,

1078 
u64
 *
out_d©a
);

1079 
»ad_idË_sma
(
hfi1_devd©a
 *
dd
, 
u64
 *
d©a
);

1080 
th”m®_š™
(
hfi1_devd©a
 *
dd
);

1082 
upd©e_¡©u¥
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
);

1083 
wa™_phys_lšk_ofæše_sub¡©es
(
hfi1_µÜtd©a
 *
µd
,

1084 
m£cs
);

1085 
wa™_logiÿl_lšk¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
,

1086 
m£cs
);

1087 
log_¡©e_Œªs™iÚ
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
);

1088 
log_physiÿl_¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
);

1089 
wa™_physiÿl_lšk¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
,

1090 
m£cs
);

1091 
wa™_phys_lšk_out_of_ofæše
(
hfi1_µÜtd©a
 *
µd
,

1092 
m£cs
);

1093 
»ad_¶ªÃd_down_»asÚ_code
(
hfi1_devd©a
 *
dd
, 
u8
 *
pd¼c
);

1094 
»ad_lšk_down_»asÚ
(
hfi1_devd©a
 *
dd
, 
u8
 *
ldr
);

1095 
hªdË_‹mp_”r
(
hfi1_devd©a
 *
dd
);

1096 
dc_shutdown
(
hfi1_devd©a
 *
dd
);

1097 
dc_¡¬t
(
hfi1_devd©a
 *
dd
);

1098 
qos_rmt_’Œ›s
(
hfi1_devd©a
 *
dd
, *
mp
,

1099 *
Å
);

1100 
þ—r_fuÎ_mgmt_pkey
(
hfi1_µÜtd©a
 *
µd
);

1101 
wa™_lšk_Œªsãr_aùive
(
hfi1_devd©a
 *
dd
, 
wa™_ms
);

1102 
þ—r_rsm_ruË
(
hfi1_devd©a
 *
dd
, 
u8
 
ruË_šdex
);

1103 
upd©e_xm™_couÁ”s
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
lšk_width
);

1111 
	s”r_»g_šfo
 {

1112 
u32
 
	m¡©us
;

1113 
u32
 
	mþ—r
;

1114 
u32
 
	mmask
;

1115 (*
	mhªdËr
)(
hfi1_devd©a
 *
	mdd
, 
u32
 
	msourû
, 
u64
 
	m»g
);

1116 cÚ¡ *
	mdesc
;

1119 
	#NUM_MISC_ERRS
 (
IS_GENERAL_ERR_END
 + 1 - 
IS_GENERAL_ERR_START
)

	)

1120 
	#NUM_DC_ERRS
 (
IS_DC_END
 + 1 - 
IS_DC_START
)

	)

1121 
	#NUM_VARIOUS
 (
IS_VARIOUS_END
 + 1 - 
IS_VARIOUS_START
)

	)

1127 
	#EE
(
»g
, 
hªdËr
, 
desc
) \

1128 { 
»g
##
_STATUS
,„eg##
_CLEAR
,„eg##
_MASK
, \

1129 
hªdËr
, 
desc
 }

	)

1130 
	#DC_EE1
(
»g
, 
hªdËr
, 
desc
) \

1131 { 
»g
##
_FLG
,„eg##
_FLG_CLR
,„eg##
_FLG_EN
, 
hªdËr
, 
desc
 }

	)

1132 
	#DC_EE2
(
»g
, 
hªdËr
, 
desc
) \

1133 { 
»g
##
_FLG
,„eg##
_CLR
,„eg##
_EN
, 
hªdËr
, 
desc
 }

	)

1139 cÚ¡ 
”r_»g_šfo
 
	gmisc_”rs
[
NUM_MISC_ERRS
] = {

1140  
EE
(
CCE_ERR
, 
hªdË_cû_”r
, "CceErr"),

1141  
EE
(
RCV_ERR
, 
hªdË_rxe_”r
, "RxeErr"),

1142  
EE
(
MISC_ERR
, 
hªdË_misc_”r
, "MiscErr"),

1143  { 0, 0, 0, 
NULL
 },

1144  
EE
(
SEND_PIO_ERR
, 
hªdË_pio_”r
, "PioErr"),

1145  
EE
(
SEND_DMA_ERR
, 
hªdË_sdma_”r
, "SDmaErr"),

1146  
EE
(
SEND_EGRESS_ERR
, 
hªdË_eg»ss_”r
, "EgressErr"),

1147  
EE
(
SEND_ERR
, 
hªdË_txe_”r
, "TxeErr")

1155 
	#TCRIT_INT_SOURCE
 4

	)

1161 cÚ¡ 
”r_»g_šfo
 
	gsdma_’g_”r
 =

1162 
EE
(
SEND_DMA_ENG_ERR
, 
hªdË_sdma_’g_”r
, "SDmaEngErr");

1164 cÚ¡ 
”r_»g_šfo
 
	gv¬ious_”r
[
NUM_VARIOUS
] = {

1165  { 0, 0, 0, 
NULL
 },

1166  { 0, 0, 0, 
NULL
 },

1167  
EE
(
ASIC_QSFP1
, 
hªdË_qså_št
, "QSFP1"),

1168  
EE
(
ASIC_QSFP2
, 
hªdË_qså_št
, "QSFP2"),

1169  { 0, 0, 0, 
NULL
 },

1179 
	#DCC_CFG_PORT_MTU_CAP_10240
 7

	)

1185 cÚ¡ 
”r_»g_šfo
 
	gdc_”rs
[
NUM_DC_ERRS
] = {

1186  
DC_EE1
(
DCC_ERR
, 
hªdË_dcc_”r
, "DCC Err"),

1187  
DC_EE2
(
DC_LCB_ERR
, 
hªdË_lcb_”r
, "LCB Err"),

1188  
DC_EE2
(
DC_DC8051_ERR
, 
hªdË_8051_š‹¼u±
, "DC8051 Interrupt"),

1193 
	súŒ_’Œy
 {

1197 *
	mÇme
;

1202 
u64
 
	mc¤
;

1207 
	moff£t
;

1212 
u8
 
	mæags
;

1217 
u64
 (*
rw_úŒ
)(cÚ¡ 
	múŒ_’Œy
 *, *
	mcÚ‹xt
, 
	mvl
,

1218 
	mmode
, 
u64
 
	md©a
);

1221 
	#C_RCV_HDR_OVF_FIRST
 
C_RCV_HDR_OVF_0


	)

1222 
	#C_RCV_HDR_OVF_LAST
 
C_RCV_HDR_OVF_159


	)

1224 
	#CNTR_ELEM
(
Çme
, 
c¤
, 
off£t
, 
æags
, 
acûssÜ
) \

1226 
Çme
, \

1227 
c¤
, \

1228 
off£t
, \

1229 
æags
, \

1230 
acûssÜ
 \

1231 }

	)

1234 
	#RXE32_PORT_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1235 
	`CNTR_ELEM
(#name, \

1236 (
couÁ”
 * 8 + 
RCV_COUNTER_ARRAY32
), \

1237 0, 
æags
 | 
CNTR_32BIT
, \

1238 
pÜt_acûss_u32_c¤
)

	)

1240 
	#RXE32_DEV_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1241 
	`CNTR_ELEM
(#name, \

1242 (
couÁ”
 * 8 + 
RCV_COUNTER_ARRAY32
), \

1243 0, 
æags
 | 
CNTR_32BIT
, \

1244 
dev_acûss_u32_c¤
)

	)

1247 
	#RXE64_PORT_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1248 
	`CNTR_ELEM
(#name, \

1249 (
couÁ”
 * 8 + 
RCV_COUNTER_ARRAY64
), \

1250 0, 
æags
, \

1251 
pÜt_acûss_u64_c¤
)

	)

1253 
	#RXE64_DEV_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1254 
	`CNTR_ELEM
(#name, \

1255 (
couÁ”
 * 8 + 
RCV_COUNTER_ARRAY64
), \

1256 0, 
æags
, \

1257 
dev_acûss_u64_c¤
)

	)

1259 
	#OVR_LBL
(
ùx
è
C_RCV_HDR_OVF_
 ## 
	)
ctx

1260 
	#OVR_ELM
(
ùx
) \

1261 
	`CNTR_ELEM
("RcvHdrOvr" #ctx, \

1262 (
RCV_HDR_OVFL_CNT
 + 
ùx
 * 0x100), \

1263 0, 
CNTR_NORMAL
, 
pÜt_acûss_u64_c¤
)

	)

1266 
	#TXE32_PORT_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1267 
	`CNTR_ELEM
(#name, \

1268 (
couÁ”
 * 8 + 
SEND_COUNTER_ARRAY32
), \

1269 0, 
æags
 | 
CNTR_32BIT
, \

1270 
pÜt_acûss_u32_c¤
)

	)

1273 
	#TXE64_PORT_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1274 
	`CNTR_ELEM
(#name, \

1275 (
couÁ”
 * 8 + 
SEND_COUNTER_ARRAY64
), \

1276 0, 
æags
, \

1277 
pÜt_acûss_u64_c¤
)

	)

1279 
	#TX64_DEV_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1280 
	`CNTR_ELEM
(#name,\

1281 
couÁ”
 * 8 + 
SEND_COUNTER_ARRAY64
, \

1283 
æags
, \

1284 
dev_acûss_u64_c¤
)

	)

1287 
	#CCE_PERF_DEV_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1288 
	`CNTR_ELEM
(#name, \

1289 (
couÁ”
 * 8 + 
CCE_COUNTER_ARRAY32
), \

1290 0, 
æags
 | 
CNTR_32BIT
, \

1291 
dev_acûss_u32_c¤
)

	)

1293 
	#CCE_INT_DEV_CNTR_ELEM
(
Çme
, 
couÁ”
, 
æags
) \

1294 
	`CNTR_ELEM
(#name, \

1295 (
couÁ”
 * 8 + 
CCE_INT_COUNTER_ARRAY32
), \

1296 0, 
æags
 | 
CNTR_32BIT
, \

1297 
dev_acûss_u32_c¤
)

	)

1300 
	#DC_PERF_CNTR
(
Çme
, 
couÁ”
, 
æags
) \

1301 
	`CNTR_ELEM
(#name, \

1302 
couÁ”
, \

1304 
æags
, \

1305 
dev_acûss_u64_c¤
)

	)

1307 
	#DC_PERF_CNTR_LCB
(
Çme
, 
couÁ”
, 
æags
) \

1308 
	`CNTR_ELEM
(#name, \

1309 
couÁ”
, \

1311 
æags
, \

1312 
dc_acûss_lcb_úŒ
)

	)

1315 
	#SW_IBP_CNTR
(
Çme
, 
úŒ
) \

1316 
	`CNTR_ELEM
(#name, \

1319 
CNTR_SYNTH
, \

1320 
acûss_ibp_
##
úŒ
)

	)

1330 
šlše
 
__iomem
 *
	$hfi1_addr_äom_off£t
(

1331 cÚ¡ 
hfi1_devd©a
 *
dd
,

1332 
u32
 
off£t
)

1334 ià(
off£t
 >ð
dd
->
ba£2_¡¬t
)

1335  
dd
->
k»gba£2
 + (
off£t
 - dd->
ba£2_¡¬t
);

1336  
dd
->
k»gba£1
 + 
off£t
;

1337 
	}
}

1347 
u64
 
	$»ad_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
u32
 
off£t
)

1349 ià(
dd
->
æags
 & 
HFI1_PRESENT
)

1350  
	`»adq
(
	`hfi1_addr_äom_off£t
(
dd
, 
off£t
));

1352 
	}
}

1360 
	$wr™e_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
u32
 
off£t
, 
u64
 
v®ue
)

1362 ià(
dd
->
æags
 & 
HFI1_PRESENT
) {

1363 
__iomem
 *
ba£
 = 
	`hfi1_addr_äom_off£t
(
dd
, 
off£t
);

1366 ià(
	`WARN_ON
(
off£t
 >ð
RCV_ARRAY
 && off£ˆ< 
dd
->
ba£2_¡¬t
))

1368 
	`wr™eq
(
v®ue
, 
ba£
);

1370 
	}
}

1380 
__iomem
 *
	$g‘_c¤_addr
(

1381 cÚ¡ 
hfi1_devd©a
 *
dd
,

1382 
u32
 
off£t
)

1384 ià(
dd
->
æags
 & 
HFI1_PRESENT
)

1385  
	`hfi1_addr_äom_off£t
(
dd
, 
off£t
);

1386  
NULL
;

1387 
	}
}

1389 
šlše
 
u64
 
	$»ad_wr™e_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
u32
 
c¤
,

1390 
mode
, 
u64
 
v®ue
)

1392 
u64
 
»t
;

1394 ià(
mode
 =ð
CNTR_MODE_R
) {

1395 
»t
 = 
	`»ad_c¤
(
dd
, 
c¤
);

1396 } ià(
mode
 =ð
CNTR_MODE_W
) {

1397 
	`wr™e_c¤
(
dd
, 
c¤
, 
v®ue
);

1398 
»t
 = 
v®ue
;

1400 
	`dd_dev_”r
(
dd
, "Invalid cntr„egister‡ccess mode");

1404 
	`hfi1_cdbg
(
CNTR
, "c¤ 0x%x v® 0x%Îx mod%d", 
c¤
, 
»t
, 
mode
);

1405  
»t
;

1406 
	}
}

1409 
u64
 
	$dev_acûss_u32_c¤
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1410 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1412 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1413 
u64
 
c¤
 = 
’Œy
->csr;

1415 ià(
’Œy
->
æags
 & 
CNTR_SDMA
) {

1416 ià(
vl
 =ð
CNTR_INVALID_VL
)

1418 
c¤
 +ð0x100 * 
vl
;

1420 ià(
vl
 !ð
CNTR_INVALID_VL
)

1423  
	`»ad_wr™e_c¤
(
dd
, 
c¤
, 
mode
, 
d©a
);

1424 
	}
}

1426 
u64
 
	$acûss_sde_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1427 *
cÚ‹xt
, 
idx
, 
mode
, 
u64
 
d©a
)

1429 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1431 ià(
dd
->
³r_sdma
 && 
idx
 < dd->
num_sdma
)

1432  
dd
->
³r_sdma
[
idx
].
”r_út
;

1434 
	}
}

1436 
u64
 
	$acûss_sde_št_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1437 *
cÚ‹xt
, 
idx
, 
mode
, 
u64
 
d©a
)

1439 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1441 ià(
dd
->
³r_sdma
 && 
idx
 < dd->
num_sdma
)

1442  
dd
->
³r_sdma
[
idx
].
sdma_št_út
;

1444 
	}
}

1446 
u64
 
	$acûss_sde_idË_št_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1447 *
cÚ‹xt
, 
idx
, 
mode
, 
u64
 
d©a
)

1449 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1451 ià(
dd
->
³r_sdma
 && 
idx
 < dd->
num_sdma
)

1452  
dd
->
³r_sdma
[
idx
].
idË_št_út
;

1454 
	}
}

1456 
u64
 
	$acûss_sde_´og»ss_št_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1457 *
cÚ‹xt
, 
idx
, 
mode
,

1458 
u64
 
d©a
)

1460 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1462 ià(
dd
->
³r_sdma
 && 
idx
 < dd->
num_sdma
)

1463  
dd
->
³r_sdma
[
idx
].
´og»ss_št_út
;

1465 
	}
}

1467 
u64
 
	$dev_acûss_u64_c¤
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, *
cÚ‹xt
,

1468 
vl
, 
mode
, 
u64
 
d©a
)

1470 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1472 
u64
 
v®
 = 0;

1473 
u64
 
c¤
 = 
’Œy
->csr;

1475 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

1476 ià(
vl
 =ð
CNTR_INVALID_VL
)

1478 
c¤
 +ð8 * 
vl
;

1480 ià(
vl
 !ð
CNTR_INVALID_VL
)

1484 
v®
 = 
	`»ad_wr™e_c¤
(
dd
, 
c¤
, 
mode
, 
d©a
);

1485  
v®
;

1486 
	}
}

1488 
u64
 
	$dc_acûss_lcb_úŒ
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, *
cÚ‹xt
,

1489 
vl
, 
mode
, 
u64
 
d©a
)

1491 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1492 
u32
 
c¤
 = 
’Œy
->csr;

1493 
»t
 = 0;

1495 ià(
vl
 !ð
CNTR_INVALID_VL
)

1497 ià(
mode
 =ð
CNTR_MODE_R
)

1498 
»t
 = 
	`»ad_lcb_c¤
(
dd
, 
c¤
, &
d©a
);

1499 ià(
mode
 =ð
CNTR_MODE_W
)

1500 
»t
 = 
	`wr™e_lcb_c¤
(
dd
, 
c¤
, 
d©a
);

1502 ià(
»t
) {

1503 
	`dd_dev_”r
(
dd
, "Could‚Ù‡cquœLCB fÜ couÁ” 0x%x", 
c¤
);

1507 
	`hfi1_cdbg
(
CNTR
, "c¤ 0x%x v® 0x%Îx mod%d", 
c¤
, 
d©a
, 
mode
);

1508  
d©a
;

1509 
	}
}

1512 
u64
 
	$pÜt_acûss_u32_c¤
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, *
cÚ‹xt
,

1513 
vl
, 
mode
, 
u64
 
d©a
)

1515 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1517 ià(
vl
 !ð
CNTR_INVALID_VL
)

1519  
	`»ad_wr™e_c¤
(
µd
->
dd
, 
’Œy
->
c¤
, 
mode
, 
d©a
);

1520 
	}
}

1522 
u64
 
	$pÜt_acûss_u64_c¤
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1523 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1525 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1526 
u64
 
v®
;

1527 
u64
 
c¤
 = 
’Œy
->csr;

1529 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

1530 ià(
vl
 =ð
CNTR_INVALID_VL
)

1532 
c¤
 +ð8 * 
vl
;

1534 ià(
vl
 !ð
CNTR_INVALID_VL
)

1537 
v®
 = 
	`»ad_wr™e_c¤
(
µd
->
dd
, 
c¤
, 
mode
, 
d©a
);

1538  
v®
;

1539 
	}
}

1542 
šlše
 
u64
 
	$»ad_wr™e_sw
(
hfi1_devd©a
 *
dd
, 
u64
 *
úŒ
, 
mode
,

1543 
u64
 
d©a
)

1545 
u64
 
»t
;

1547 ià(
mode
 =ð
CNTR_MODE_R
) {

1548 
»t
 = *
úŒ
;

1549 } ià(
mode
 =ð
CNTR_MODE_W
) {

1550 *
úŒ
 = 
d©a
;

1551 
»t
 = 
d©a
;

1553 
	`dd_dev_”r
(
dd
, "Invalid cntr sw‡ccess mode");

1557 
	`hfi1_cdbg
(
CNTR
, "v® 0x%Îx mod%d", 
»t
, 
mode
);

1559  
»t
;

1560 
	}
}

1562 
u64
 
	$acûss_sw_lšk_dn_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, *
cÚ‹xt
,

1563 
vl
, 
mode
, 
u64
 
d©a
)

1565 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1567 ià(
vl
 !ð
CNTR_INVALID_VL
)

1569  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
lšk_dowÃd
, 
mode
, 
d©a
);

1570 
	}
}

1572 
u64
 
	$acûss_sw_lšk_up_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, *
cÚ‹xt
,

1573 
vl
, 
mode
, 
u64
 
d©a
)

1575 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1577 ià(
vl
 !ð
CNTR_INVALID_VL
)

1579  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
lšk_up
, 
mode
, 
d©a
);

1580 
	}
}

1582 
u64
 
	$acûss_sw_unknown_äame_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1583 *
cÚ‹xt
, 
vl
, 
mode
,

1584 
u64
 
d©a
)

1586 
hfi1_µÜtd©a
 *
µd
 = (hfi1_µÜtd©¨*)
cÚ‹xt
;

1588 ià(
vl
 !ð
CNTR_INVALID_VL
)

1590  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
unknown_äame_couÁ
, 
mode
, 
d©a
);

1591 
	}
}

1593 
u64
 
	$acûss_sw_xm™_disÿrds
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1594 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1596 
hfi1_µÜtd©a
 *
µd
 = (hfi1_µÜtd©¨*)
cÚ‹xt
;

1597 
u64
 
z”o
 = 0;

1598 
u64
 *
couÁ”
;

1600 ià(
vl
 =ð
CNTR_INVALID_VL
)

1601 
couÁ”
 = &
µd
->
pÜt_xm™_disÿrds
;

1602 ià(
vl
 >ð0 && vÈ< 
C_VL_COUNT
)

1603 
couÁ”
 = &
µd
->
pÜt_xm™_disÿrds_vl
[
vl
];

1605 
couÁ”
 = &
z”o
;

1607  
	`»ad_wr™e_sw
(
µd
->
dd
, 
couÁ”
, 
mode
, 
d©a
);

1608 
	}
}

1610 
u64
 
	$acûss_xm™_cÚ¡¿št_”rs
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1611 *
cÚ‹xt
, 
vl
, 
mode
,

1612 
u64
 
d©a
)

1614 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1616 ià(
vl
 !ð
CNTR_INVALID_VL
)

1619  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
pÜt_xm™_cÚ¡¿št_”rÜs
,

1620 
mode
, 
d©a
);

1621 
	}
}

1623 
u64
 
	$acûss_rcv_cÚ¡¿št_”rs
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1624 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1626 
hfi1_µÜtd©a
 *
µd
 = 
cÚ‹xt
;

1628 ià(
vl
 !ð
CNTR_INVALID_VL
)

1631  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
pÜt_rcv_cÚ¡¿št_”rÜs
,

1632 
mode
, 
d©a
);

1633 
	}
}

1635 
u64
 
	$g‘_®l_ýu_tÙ®
(
u64
 
__³rýu
 *
úŒ
)

1637 
ýu
;

1638 
u64
 
couÁ”
 = 0;

1640 
	`fÜ_—ch_possibË_ýu
(
ýu
)

1641 
couÁ”
 +ð*
	`³r_ýu_±r
(
úŒ
, 
ýu
);

1642  
couÁ”
;

1643 
	}
}

1645 
u64
 
	$»ad_wr™e_ýu
(
hfi1_devd©a
 *
dd
, 
u64
 *
z_v®
,

1646 
u64
 
__³rýu
 *
úŒ
,

1647 
vl
, 
mode
, 
u64
 
d©a
)

1649 
u64
 
»t
 = 0;

1651 ià(
vl
 !ð
CNTR_INVALID_VL
)

1654 ià(
mode
 =ð
CNTR_MODE_R
) {

1655 
»t
 = 
	`g‘_®l_ýu_tÙ®
(
úŒ
è- *
z_v®
;

1656 } ià(
mode
 =ð
CNTR_MODE_W
) {

1658 ià(
d©a
 == 0)

1659 *
z_v®
 = 
	`g‘_®l_ýu_tÙ®
(
úŒ
);

1661 
	`dd_dev_”r
(
dd
, "Per CPU cntrs can only be zeroed");

1663 
	`dd_dev_”r
(
dd
, "Invalid cntr sw cpu‡ccess mode");

1667  
»t
;

1668 
	}
}

1670 
u64
 
	$acûss_sw_ýu_šŒ
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1671 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1673 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1675  
	`»ad_wr™e_ýu
(
dd
, &dd->
z_št_couÁ”
, dd->
št_couÁ”
, 
vl
,

1676 
mode
, 
d©a
);

1677 
	}
}

1679 
u64
 
	$acûss_sw_ýu_rcv_lim™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1680 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1682 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1684  
	`»ad_wr™e_ýu
(
dd
, &dd->
z_rcv_lim™
, dd->
rcv_lim™
, 
vl
,

1685 
mode
, 
d©a
);

1686 
	}
}

1688 
u64
 
	$acûss_sw_pio_wa™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1689 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1691 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1693  
dd
->
v”bs_dev
.
n_piowa™
;

1694 
	}
}

1696 
u64
 
	$acûss_sw_pio_d¿š
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1697 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1699 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1701  
dd
->
v”bs_dev
.
n_piod¿š
;

1702 
	}
}

1704 
u64
 
	$acûss_sw_ùx0_£q_drÝ
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1705 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1707 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1709  
dd
->
ùx0_£q_drÝ
;

1710 
	}
}

1712 
u64
 
	$acûss_sw_vtx_wa™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1713 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1715 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1717  
dd
->
v”bs_dev
.
n_txwa™
;

1718 
	}
}

1720 
u64
 
	$acûss_sw_kmem_wa™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1721 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1723 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1725  
dd
->
v”bs_dev
.
n_kmem_wa™
;

1726 
	}
}

1728 
u64
 
	$acûss_sw_£nd_scheduË
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1729 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1731 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1733  
	`»ad_wr™e_ýu
(
dd
, &dd->
z_£nd_scheduË
, dd->
£nd_scheduË
, 
vl
,

1734 
mode
, 
d©a
);

1735 
	}
}

1738 
u64
 
	$acûss_misc_¶l_lock_çž_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1739 *
cÚ‹xt
, 
vl
, 
mode
,

1740 
u64
 
d©a
)

1742 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1744  
dd
->
misc_”r_¡©us_út
[12];

1745 
	}
}

1747 
u64
 
	$acûss_misc_mbi¡_çž_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1748 *
cÚ‹xt
, 
vl
, 
mode
,

1749 
u64
 
d©a
)

1751 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1753  
dd
->
misc_”r_¡©us_út
[11];

1754 
	}
}

1756 
u64
 
	$acûss_misc_šv®id_“p_cmd_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1757 *
cÚ‹xt
, 
vl
, 
mode
,

1758 
u64
 
d©a
)

1760 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1762  
dd
->
misc_”r_¡©us_út
[10];

1763 
	}
}

1765 
u64
 
	$acûss_misc_efu£_dÚe_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1766 *
cÚ‹xt
, 
vl
,

1767 
mode
, 
u64
 
d©a
)

1769 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1771  
dd
->
misc_”r_¡©us_út
[9];

1772 
	}
}

1774 
u64
 
	$acûss_misc_efu£_wr™e_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1775 *
cÚ‹xt
, 
vl
, 
mode
,

1776 
u64
 
d©a
)

1778 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1780  
dd
->
misc_”r_¡©us_út
[8];

1781 
	}
}

1783 
u64
 
	$acûss_misc_efu£_»ad_bad_addr_”r_út
(

1784 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1785 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1787 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1789  
dd
->
misc_”r_¡©us_út
[7];

1790 
	}
}

1792 
u64
 
	$acûss_misc_efu£_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1793 *
cÚ‹xt
, 
vl
,

1794 
mode
, 
u64
 
d©a
)

1796 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1798  
dd
->
misc_”r_¡©us_út
[6];

1799 
	}
}

1801 
u64
 
	$acûss_misc_fw_auth_çžed_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1802 *
cÚ‹xt
, 
vl
, 
mode
,

1803 
u64
 
d©a
)

1805 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1807  
dd
->
misc_”r_¡©us_út
[5];

1808 
	}
}

1810 
u64
 
	$acûss_misc_key_mism©ch_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1811 *
cÚ‹xt
, 
vl
, 
mode
,

1812 
u64
 
d©a
)

1814 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1816  
dd
->
misc_”r_¡©us_út
[4];

1817 
	}
}

1819 
u64
 
	$acûss_misc_sbus_wr™e_çžed_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1820 *
cÚ‹xt
, 
vl
,

1821 
mode
, 
u64
 
d©a
)

1823 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1825  
dd
->
misc_”r_¡©us_út
[3];

1826 
	}
}

1828 
u64
 
	$acûss_misc_c¤_wr™e_bad_addr_”r_út
(

1829 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1830 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1832 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1834  
dd
->
misc_”r_¡©us_út
[2];

1835 
	}
}

1837 
u64
 
	$acûss_misc_c¤_»ad_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1838 *
cÚ‹xt
, 
vl
,

1839 
mode
, 
u64
 
d©a
)

1841 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1843  
dd
->
misc_”r_¡©us_út
[1];

1844 
	}
}

1846 
u64
 
	$acûss_misc_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1847 *
cÚ‹xt
, 
vl
, 
mode
,

1848 
u64
 
d©a
)

1850 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1852  
dd
->
misc_”r_¡©us_út
[0];

1853 
	}
}

1859 
u64
 
	$acûss_sw_cû_”r_¡©us_agg»g©ed_út
(

1860 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1861 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1863 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1865  
dd
->
sw_cû_”r_¡©us_agg»g©e
;

1866 
	}
}

1872 
u64
 
	$acûss_cû_msix_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1873 *
cÚ‹xt
, 
vl
, 
mode
,

1874 
u64
 
d©a
)

1876 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1878  
dd
->
cû_”r_¡©us_út
[40];

1879 
	}
}

1881 
u64
 
	$acûss_cû_št_m­_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1882 *
cÚ‹xt
, 
vl
, 
mode
,

1883 
u64
 
d©a
)

1885 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1887  
dd
->
cû_”r_¡©us_út
[39];

1888 
	}
}

1890 
u64
 
	$acûss_cû_št_m­_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1891 *
cÚ‹xt
, 
vl
, 
mode
,

1892 
u64
 
d©a
)

1894 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1896  
dd
->
cû_”r_¡©us_út
[38];

1897 
	}
}

1899 
u64
 
	$acûss_cû_msix_bË_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1900 *
cÚ‹xt
, 
vl
, 
mode
,

1901 
u64
 
d©a
)

1903 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1905  
dd
->
cû_”r_¡©us_út
[37];

1906 
	}
}

1908 
u64
 
	$acûss_cû_msix_bË_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1909 *
cÚ‹xt
, 
vl
, 
mode
,

1910 
u64
 
d©a
)

1912 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1914  
dd
->
cû_”r_¡©us_út
[36];

1915 
	}
}

1917 
u64
 
	$acûss_cû_rxdma_cÚv_fifo_·r™y_”r_út
(

1918 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1919 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1921 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1923  
dd
->
cû_”r_¡©us_út
[35];

1924 
	}
}

1926 
u64
 
	$acûss_cû_rýl_async_fifo_·r™y_”r_út
(

1927 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1928 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1930 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1932  
dd
->
cû_”r_¡©us_út
[34];

1933 
	}
}

1935 
u64
 
	$acûss_cû_£g_wr™e_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1936 *
cÚ‹xt
, 
vl
,

1937 
mode
, 
u64
 
d©a
)

1939 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1941  
dd
->
cû_”r_¡©us_út
[33];

1942 
	}
}

1944 
u64
 
	$acûss_cû_£g_»ad_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1945 *
cÚ‹xt
, 
vl
, 
mode
,

1946 
u64
 
d©a
)

1948 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1950  
dd
->
cû_”r_¡©us_út
[32];

1951 
	}
}

1953 
u64
 
	$acûss_Ï_Œigg”ed_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1954 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1956 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1958  
dd
->
cû_”r_¡©us_út
[31];

1959 
	}
}

1961 
u64
 
	$acûss_cû_Œgt_ýl_timeout_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1962 *
cÚ‹xt
, 
vl
, 
mode
,

1963 
u64
 
d©a
)

1965 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1967  
dd
->
cû_”r_¡©us_út
[30];

1968 
	}
}

1970 
u64
 
	$acûss_pcic_»ûive_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1971 *
cÚ‹xt
, 
vl
, 
mode
,

1972 
u64
 
d©a
)

1974 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1976  
dd
->
cû_”r_¡©us_út
[29];

1977 
	}
}

1979 
u64
 
	$acûss_pcic_Œªsm™_back_·r™y_”r_út
(

1980 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1981 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1983 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1985  
dd
->
cû_”r_¡©us_út
[28];

1986 
	}
}

1988 
u64
 
	$acûss_pcic_Œªsm™_äÚt_·r™y_”r_út
(

1989 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1990 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1992 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

1994  
dd
->
cû_”r_¡©us_út
[27];

1995 
	}
}

1997 
u64
 
	$acûss_pcic_ýl_d©_q_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1998 *
cÚ‹xt
, 
vl
, 
mode
,

1999 
u64
 
d©a
)

2001 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2003  
dd
->
cû_”r_¡©us_út
[26];

2004 
	}
}

2006 
u64
 
	$acûss_pcic_ýl_hd_q_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2007 *
cÚ‹xt
, 
vl
, 
mode
,

2008 
u64
 
d©a
)

2010 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2012  
dd
->
cû_”r_¡©us_út
[25];

2013 
	}
}

2015 
u64
 
	$acûss_pcic_po¡_d©_q_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2016 *
cÚ‹xt
, 
vl
, 
mode
,

2017 
u64
 
d©a
)

2019 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2021  
dd
->
cû_”r_¡©us_út
[24];

2022 
	}
}

2024 
u64
 
	$acûss_pcic_po¡_hd_q_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2025 *
cÚ‹xt
, 
vl
, 
mode
,

2026 
u64
 
d©a
)

2028 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2030  
dd
->
cû_”r_¡©us_út
[23];

2031 
	}
}

2033 
u64
 
	$acûss_pcic_»Œy_sÙ_mem_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2034 *
cÚ‹xt
, 
vl
,

2035 
mode
, 
u64
 
d©a
)

2037 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2039  
dd
->
cû_”r_¡©us_út
[22];

2040 
	}
}

2042 
u64
 
	$acûss_pcic_»Œy_mem_unc_”r
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2043 *
cÚ‹xt
, 
vl
, 
mode
,

2044 
u64
 
d©a
)

2046 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2048  
dd
->
cû_”r_¡©us_út
[21];

2049 
	}
}

2051 
u64
 
	$acûss_pcic_n_po¡_d©_q_·r™y_”r_út
(

2052 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2053 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2055 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2057  
dd
->
cû_”r_¡©us_út
[20];

2058 
	}
}

2060 
u64
 
	$acûss_pcic_n_po¡_h_q_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2061 *
cÚ‹xt
, 
vl
,

2062 
mode
, 
u64
 
d©a
)

2064 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2066  
dd
->
cû_”r_¡©us_út
[19];

2067 
	}
}

2069 
u64
 
	$acûss_pcic_ýl_d©_q_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2070 *
cÚ‹xt
, 
vl
, 
mode
,

2071 
u64
 
d©a
)

2073 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2075  
dd
->
cû_”r_¡©us_út
[18];

2076 
	}
}

2078 
u64
 
	$acûss_pcic_ýl_hd_q_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2079 *
cÚ‹xt
, 
vl
, 
mode
,

2080 
u64
 
d©a
)

2082 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2084  
dd
->
cû_”r_¡©us_út
[17];

2085 
	}
}

2087 
u64
 
	$acûss_pcic_po¡_d©_q_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2088 *
cÚ‹xt
, 
vl
, 
mode
,

2089 
u64
 
d©a
)

2091 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2093  
dd
->
cû_”r_¡©us_út
[16];

2094 
	}
}

2096 
u64
 
	$acûss_pcic_po¡_hd_q_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2097 *
cÚ‹xt
, 
vl
, 
mode
,

2098 
u64
 
d©a
)

2100 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2102  
dd
->
cû_”r_¡©us_út
[15];

2103 
	}
}

2105 
u64
 
	$acûss_pcic_»Œy_sÙ_mem_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2106 *
cÚ‹xt
, 
vl
,

2107 
mode
, 
u64
 
d©a
)

2109 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2111  
dd
->
cû_”r_¡©us_út
[14];

2112 
	}
}

2114 
u64
 
	$acûss_pcic_»Œy_mem_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2115 *
cÚ‹xt
, 
vl
, 
mode
,

2116 
u64
 
d©a
)

2118 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2120  
dd
->
cû_”r_¡©us_út
[13];

2121 
	}
}

2123 
u64
 
	$acûss_cû_þi1_async_fifo_dbg_·r™y_”r_út
(

2124 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2125 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2127 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2129  
dd
->
cû_”r_¡©us_út
[12];

2130 
	}
}

2132 
u64
 
	$acûss_cû_þi1_async_fifo_rxdma_·r™y_”r_út
(

2133 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2134 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2136 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2138  
dd
->
cû_”r_¡©us_út
[11];

2139 
	}
}

2141 
u64
 
	$acûss_cû_þi1_async_fifo_sdma_hd_·r™y_”r_út
(

2142 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2143 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2145 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2147  
dd
->
cû_”r_¡©us_út
[10];

2148 
	}
}

2150 
u64
 
	$acûss_cû_þ1_async_fifo_pio_üdt_·r™y_”r_út
(

2151 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2152 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2154 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2156  
dd
->
cû_”r_¡©us_út
[9];

2157 
	}
}

2159 
u64
 
	$acûss_cû_þi2_async_fifo_·r™y_”r_út
(

2160 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2161 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2163 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2165  
dd
->
cû_”r_¡©us_út
[8];

2166 
	}
}

2168 
u64
 
	$acûss_cû_c¤_cfg_bus_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2169 *
cÚ‹xt
, 
vl
,

2170 
mode
, 
u64
 
d©a
)

2172 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2174  
dd
->
cû_”r_¡©us_út
[7];

2175 
	}
}

2177 
u64
 
	$acûss_cû_þi0_async_fifo_·r™y_”r_út
(

2178 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2179 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2181 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2183  
dd
->
cû_”r_¡©us_út
[6];

2184 
	}
}

2186 
u64
 
	$acûss_cû_r¥d_d©a_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2187 *
cÚ‹xt
, 
vl
, 
mode
,

2188 
u64
 
d©a
)

2190 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2192  
dd
->
cû_”r_¡©us_út
[5];

2193 
	}
}

2195 
u64
 
	$acûss_cû_Œgt_acûss_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2196 *
cÚ‹xt
, 
vl
, 
mode
,

2197 
u64
 
d©a
)

2199 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2201  
dd
->
cû_”r_¡©us_út
[4];

2202 
	}
}

2204 
u64
 
	$acûss_cû_Œgt_async_fifo_·r™y_”r_út
(

2205 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2206 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2208 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2210  
dd
->
cû_”r_¡©us_út
[3];

2211 
	}
}

2213 
u64
 
	$acûss_cû_c¤_wr™e_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2214 *
cÚ‹xt
, 
vl
,

2215 
mode
, 
u64
 
d©a
)

2217 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2219  
dd
->
cû_”r_¡©us_út
[2];

2220 
	}
}

2222 
u64
 
	$acûss_cû_c¤_»ad_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2223 *
cÚ‹xt
, 
vl
,

2224 
mode
, 
u64
 
d©a
)

2226 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2228  
dd
->
cû_”r_¡©us_út
[1];

2229 
	}
}

2231 
u64
 
	$acûss_ccs_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2232 *
cÚ‹xt
, 
vl
, 
mode
,

2233 
u64
 
d©a
)

2235 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2237  
dd
->
cû_”r_¡©us_út
[0];

2238 
	}
}

2244 
u64
 
	$acûss_rx_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2245 *
cÚ‹xt
, 
vl
, 
mode
,

2246 
u64
 
d©a
)

2248 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2250  
dd
->
rcv_”r_¡©us_út
[63];

2251 
	}
}

2253 
u64
 
	$acûss_rx_c¤_wr™e_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2254 *
cÚ‹xt
, 
vl
,

2255 
mode
, 
u64
 
d©a
)

2257 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2259  
dd
->
rcv_”r_¡©us_út
[62];

2260 
	}
}

2262 
u64
 
	$acûss_rx_c¤_»ad_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2263 *
cÚ‹xt
, 
vl
, 
mode
,

2264 
u64
 
d©a
)

2266 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2268  
dd
->
rcv_”r_¡©us_út
[61];

2269 
	}
}

2271 
u64
 
	$acûss_rx_dma_c¤_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2272 *
cÚ‹xt
, 
vl
, 
mode
,

2273 
u64
 
d©a
)

2275 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2277  
dd
->
rcv_”r_¡©us_út
[60];

2278 
	}
}

2280 
u64
 
	$acûss_rx_dma_dq_fsm_’codšg_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2281 *
cÚ‹xt
, 
vl
,

2282 
mode
, 
u64
 
d©a
)

2284 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2286  
dd
->
rcv_”r_¡©us_út
[59];

2287 
	}
}

2289 
u64
 
	$acûss_rx_dma_eq_fsm_’codšg_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2290 *
cÚ‹xt
, 
vl
,

2291 
mode
, 
u64
 
d©a
)

2293 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2295  
dd
->
rcv_”r_¡©us_út
[58];

2296 
	}
}

2298 
u64
 
	$acûss_rx_dma_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2299 *
cÚ‹xt
, 
vl
, 
mode
,

2300 
u64
 
d©a
)

2302 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2304  
dd
->
rcv_”r_¡©us_út
[57];

2305 
	}
}

2307 
u64
 
	$acûss_rx_rbuf_d©a_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2308 *
cÚ‹xt
, 
vl
, 
mode
,

2309 
u64
 
d©a
)

2311 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2313  
dd
->
rcv_”r_¡©us_út
[56];

2314 
	}
}

2316 
u64
 
	$acûss_rx_rbuf_d©a_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2317 *
cÚ‹xt
, 
vl
, 
mode
,

2318 
u64
 
d©a
)

2320 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2322  
dd
->
rcv_”r_¡©us_út
[55];

2323 
	}
}

2325 
u64
 
	$acûss_rx_dma_d©a_fifo_rd_cÜ_”r_út
(

2326 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2327 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2329 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2331  
dd
->
rcv_”r_¡©us_út
[54];

2332 
	}
}

2334 
u64
 
	$acûss_rx_dma_d©a_fifo_rd_unc_”r_út
(

2335 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2336 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2338 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2340  
dd
->
rcv_”r_¡©us_út
[53];

2341 
	}
}

2343 
u64
 
	$acûss_rx_dma_hdr_fifo_rd_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2344 *
cÚ‹xt
, 
vl
,

2345 
mode
, 
u64
 
d©a
)

2347 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2349  
dd
->
rcv_”r_¡©us_út
[52];

2350 
	}
}

2352 
u64
 
	$acûss_rx_dma_hdr_fifo_rd_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2353 *
cÚ‹xt
, 
vl
,

2354 
mode
, 
u64
 
d©a
)

2356 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2358  
dd
->
rcv_”r_¡©us_út
[51];

2359 
	}
}

2361 
u64
 
	$acûss_rx_rbuf_desc_·¹2_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2362 *
cÚ‹xt
, 
vl
,

2363 
mode
, 
u64
 
d©a
)

2365 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2367  
dd
->
rcv_”r_¡©us_út
[50];

2368 
	}
}

2370 
u64
 
	$acûss_rx_rbuf_desc_·¹2_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2371 *
cÚ‹xt
, 
vl
,

2372 
mode
, 
u64
 
d©a
)

2374 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2376  
dd
->
rcv_”r_¡©us_út
[49];

2377 
	}
}

2379 
u64
 
	$acûss_rx_rbuf_desc_·¹1_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2380 *
cÚ‹xt
, 
vl
,

2381 
mode
, 
u64
 
d©a
)

2383 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2385  
dd
->
rcv_”r_¡©us_út
[48];

2386 
	}
}

2388 
u64
 
	$acûss_rx_rbuf_desc_·¹1_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2389 *
cÚ‹xt
, 
vl
,

2390 
mode
, 
u64
 
d©a
)

2392 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2394  
dd
->
rcv_”r_¡©us_út
[47];

2395 
	}
}

2397 
u64
 
	$acûss_rx_hq_šŒ_fsm_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2398 *
cÚ‹xt
, 
vl
, 
mode
,

2399 
u64
 
d©a
)

2401 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2403  
dd
->
rcv_”r_¡©us_út
[46];

2404 
	}
}

2406 
u64
 
	$acûss_rx_hq_šŒ_c¤_·r™y_”r_út
(

2407 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2408 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2410 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2412  
dd
->
rcv_”r_¡©us_út
[45];

2413 
	}
}

2415 
u64
 
	$acûss_rx_lookup_c¤_·r™y_”r_út
(

2416 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2417 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2419 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2421  
dd
->
rcv_”r_¡©us_út
[44];

2422 
	}
}

2424 
u64
 
	$acûss_rx_lookup_rcv_¬¿y_cÜ_”r_út
(

2425 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2426 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2428 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2430  
dd
->
rcv_”r_¡©us_út
[43];

2431 
	}
}

2433 
u64
 
	$acûss_rx_lookup_rcv_¬¿y_unc_”r_út
(

2434 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2435 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2437 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2439  
dd
->
rcv_”r_¡©us_út
[42];

2440 
	}
}

2442 
u64
 
	$acûss_rx_lookup_des_·¹2_·r™y_”r_út
(

2443 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2444 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2446 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2448  
dd
->
rcv_”r_¡©us_út
[41];

2449 
	}
}

2451 
u64
 
	$acûss_rx_lookup_des_·¹1_unc_cÜ_”r_út
(

2452 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2453 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2455 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2457  
dd
->
rcv_”r_¡©us_út
[40];

2458 
	}
}

2460 
u64
 
	$acûss_rx_lookup_des_·¹1_unc_”r_út
(

2461 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2462 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2464 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2466  
dd
->
rcv_”r_¡©us_út
[39];

2467 
	}
}

2469 
u64
 
	$acûss_rx_rbuf_Ãxt_ä“_buf_cÜ_”r_út
(

2470 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2471 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2473 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2475  
dd
->
rcv_”r_¡©us_út
[38];

2476 
	}
}

2478 
u64
 
	$acûss_rx_rbuf_Ãxt_ä“_buf_unc_”r_út
(

2479 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2480 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2482 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2484  
dd
->
rcv_”r_¡©us_út
[37];

2485 
	}
}

2487 
u64
 
	$acûss_rbuf_æ_š™_wr_addr_·r™y_”r_út
(

2488 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2489 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2491 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2493  
dd
->
rcv_”r_¡©us_út
[36];

2494 
	}
}

2496 
u64
 
	$acûss_rx_rbuf_æ_š™dÚe_·r™y_”r_út
(

2497 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2498 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2500 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2502  
dd
->
rcv_”r_¡©us_út
[35];

2503 
	}
}

2505 
u64
 
	$acûss_rx_rbuf_æ_wr™e_addr_·r™y_”r_út
(

2506 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2507 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2509 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2511  
dd
->
rcv_”r_¡©us_út
[34];

2512 
	}
}

2514 
u64
 
	$acûss_rx_rbuf_æ_rd_addr_·r™y_”r_út
(

2515 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2516 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2518 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2520  
dd
->
rcv_”r_¡©us_út
[33];

2521 
	}
}

2523 
u64
 
	$acûss_rx_rbuf_em±y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2524 *
cÚ‹xt
, 
vl
, 
mode
,

2525 
u64
 
d©a
)

2527 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2529  
dd
->
rcv_”r_¡©us_út
[32];

2530 
	}
}

2532 
u64
 
	$acûss_rx_rbuf_fuÎ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2533 *
cÚ‹xt
, 
vl
, 
mode
,

2534 
u64
 
d©a
)

2536 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2538  
dd
->
rcv_”r_¡©us_út
[31];

2539 
	}
}

2541 
u64
 
	$acûss_rbuf_bad_lookup_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2542 *
cÚ‹xt
, 
vl
, 
mode
,

2543 
u64
 
d©a
)

2545 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2547  
dd
->
rcv_”r_¡©us_út
[30];

2548 
	}
}

2550 
u64
 
	$acûss_rbuf_ùx_id_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2551 *
cÚ‹xt
, 
vl
, 
mode
,

2552 
u64
 
d©a
)

2554 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2556  
dd
->
rcv_”r_¡©us_út
[29];

2557 
	}
}

2559 
u64
 
	$acûss_rbuf_c¤_qeÝdw_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2560 *
cÚ‹xt
, 
vl
,

2561 
mode
, 
u64
 
d©a
)

2563 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2565  
dd
->
rcv_”r_¡©us_út
[28];

2566 
	}
}

2568 
u64
 
	$acûss_rx_rbuf_c¤_q_num_of_pkt_·r™y_”r_út
(

2569 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2570 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2572 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2574  
dd
->
rcv_”r_¡©us_út
[27];

2575 
	}
}

2577 
u64
 
	$acûss_rx_rbuf_c¤_q_t1_±r_·r™y_”r_út
(

2578 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2579 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2581 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2583  
dd
->
rcv_”r_¡©us_út
[26];

2584 
	}
}

2586 
u64
 
	$acûss_rx_rbuf_c¤_q_hd_±r_·r™y_”r_út
(

2587 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2588 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2590 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2592  
dd
->
rcv_”r_¡©us_út
[25];

2593 
	}
}

2595 
u64
 
	$acûss_rx_rbuf_c¤_q_vld_b™_·r™y_”r_út
(

2596 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2597 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2599 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2601  
dd
->
rcv_”r_¡©us_út
[24];

2602 
	}
}

2604 
u64
 
	$acûss_rx_rbuf_c¤_q_Ãxt_buf_·r™y_”r_út
(

2605 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2606 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2608 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2610  
dd
->
rcv_”r_¡©us_út
[23];

2611 
	}
}

2613 
u64
 
	$acûss_rx_rbuf_c¤_q_’t_út_·r™y_”r_út
(

2614 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2615 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2617 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2619  
dd
->
rcv_”r_¡©us_út
[22];

2620 
	}
}

2622 
u64
 
	$acûss_rx_rbuf_c¤_q_h—d_buf_num_·r™y_”r_út
(

2623 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2624 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2626 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2628  
dd
->
rcv_”r_¡©us_út
[21];

2629 
	}
}

2631 
u64
 
	$acûss_rx_rbuf_block_li¡_»ad_cÜ_”r_út
(

2632 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2633 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2635 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2637  
dd
->
rcv_”r_¡©us_út
[20];

2638 
	}
}

2640 
u64
 
	$acûss_rx_rbuf_block_li¡_»ad_unc_”r_út
(

2641 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2642 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2644 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2646  
dd
->
rcv_”r_¡©us_út
[19];

2647 
	}
}

2649 
u64
 
	$acûss_rx_rbuf_lookup_des_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2650 *
cÚ‹xt
, 
vl
,

2651 
mode
, 
u64
 
d©a
)

2653 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2655  
dd
->
rcv_”r_¡©us_út
[18];

2656 
	}
}

2658 
u64
 
	$acûss_rx_rbuf_lookup_des_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2659 *
cÚ‹xt
, 
vl
,

2660 
mode
, 
u64
 
d©a
)

2662 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2664  
dd
->
rcv_”r_¡©us_út
[17];

2665 
	}
}

2667 
u64
 
	$acûss_rx_rbuf_lookup_des_»g_unc_cÜ_”r_út
(

2668 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2669 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2671 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2673  
dd
->
rcv_”r_¡©us_út
[16];

2674 
	}
}

2676 
u64
 
	$acûss_rx_rbuf_lookup_des_»g_unc_”r_út
(

2677 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2678 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2680 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2682  
dd
->
rcv_”r_¡©us_út
[15];

2683 
	}
}

2685 
u64
 
	$acûss_rx_rbuf_ä“_li¡_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2686 *
cÚ‹xt
, 
vl
,

2687 
mode
, 
u64
 
d©a
)

2689 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2691  
dd
->
rcv_”r_¡©us_út
[14];

2692 
	}
}

2694 
u64
 
	$acûss_rx_rbuf_ä“_li¡_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2695 *
cÚ‹xt
, 
vl
,

2696 
mode
, 
u64
 
d©a
)

2698 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2700  
dd
->
rcv_”r_¡©us_út
[13];

2701 
	}
}

2703 
u64
 
	$acûss_rx_rcv_fsm_’codšg_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2704 *
cÚ‹xt
, 
vl
, 
mode
,

2705 
u64
 
d©a
)

2707 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2709  
dd
->
rcv_”r_¡©us_út
[12];

2710 
	}
}

2712 
u64
 
	$acûss_rx_dma_æag_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2713 *
cÚ‹xt
, 
vl
, 
mode
,

2714 
u64
 
d©a
)

2716 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2718  
dd
->
rcv_”r_¡©us_út
[11];

2719 
	}
}

2721 
u64
 
	$acûss_rx_dma_æag_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2722 *
cÚ‹xt
, 
vl
, 
mode
,

2723 
u64
 
d©a
)

2725 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2727  
dd
->
rcv_”r_¡©us_út
[10];

2728 
	}
}

2730 
u64
 
	$acûss_rx_dc_sÝ_eÝ_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2731 *
cÚ‹xt
, 
vl
, 
mode
,

2732 
u64
 
d©a
)

2734 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2736  
dd
->
rcv_”r_¡©us_út
[9];

2737 
	}
}

2739 
u64
 
	$acûss_rx_rcv_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2740 *
cÚ‹xt
, 
vl
, 
mode
,

2741 
u64
 
d©a
)

2743 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2745  
dd
->
rcv_”r_¡©us_út
[8];

2746 
	}
}

2748 
u64
 
	$acûss_rx_rcv_qp_m­_bË_cÜ_”r_út
(

2749 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2750 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2752 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2754  
dd
->
rcv_”r_¡©us_út
[7];

2755 
	}
}

2757 
u64
 
	$acûss_rx_rcv_qp_m­_bË_unc_”r_út
(

2758 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2759 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2761 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2763  
dd
->
rcv_”r_¡©us_út
[6];

2764 
	}
}

2766 
u64
 
	$acûss_rx_rcv_d©a_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2767 *
cÚ‹xt
, 
vl
, 
mode
,

2768 
u64
 
d©a
)

2770 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2772  
dd
->
rcv_”r_¡©us_út
[5];

2773 
	}
}

2775 
u64
 
	$acûss_rx_rcv_d©a_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2776 *
cÚ‹xt
, 
vl
, 
mode
,

2777 
u64
 
d©a
)

2779 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2781  
dd
->
rcv_”r_¡©us_út
[4];

2782 
	}
}

2784 
u64
 
	$acûss_rx_rcv_hdr_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2785 *
cÚ‹xt
, 
vl
, 
mode
,

2786 
u64
 
d©a
)

2788 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2790  
dd
->
rcv_”r_¡©us_út
[3];

2791 
	}
}

2793 
u64
 
	$acûss_rx_rcv_hdr_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2794 *
cÚ‹xt
, 
vl
, 
mode
,

2795 
u64
 
d©a
)

2797 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2799  
dd
->
rcv_”r_¡©us_út
[2];

2800 
	}
}

2802 
u64
 
	$acûss_rx_dc_štf_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2803 *
cÚ‹xt
, 
vl
, 
mode
,

2804 
u64
 
d©a
)

2806 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2808  
dd
->
rcv_”r_¡©us_út
[1];

2809 
	}
}

2811 
u64
 
	$acûss_rx_dma_c¤_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2812 *
cÚ‹xt
, 
vl
, 
mode
,

2813 
u64
 
d©a
)

2815 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2817  
dd
->
rcv_”r_¡©us_út
[0];

2818 
	}
}

2824 
u64
 
	$acûss_pio_³c_sÝ_h—d_·r™y_”r_út
(

2825 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2826 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2828 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2830  
dd
->
£nd_pio_”r_¡©us_út
[35];

2831 
	}
}

2833 
u64
 
	$acûss_pio_pcc_sÝ_h—d_·r™y_”r_út
(

2834 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2835 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2837 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2839  
dd
->
£nd_pio_”r_¡©us_út
[34];

2840 
	}
}

2842 
u64
 
	$acûss_pio_Ï¡_»tuºed_út_·r™y_”r_út
(

2843 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2844 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2846 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2848  
dd
->
£nd_pio_”r_¡©us_út
[33];

2849 
	}
}

2851 
u64
 
	$acûss_pio_cu¼’t_ä“_út_·r™y_”r_út
(

2852 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2853 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2855 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2857  
dd
->
£nd_pio_”r_¡©us_út
[32];

2858 
	}
}

2860 
u64
 
	$acûss_pio_»£rved_31_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2861 *
cÚ‹xt
, 
vl
, 
mode
,

2862 
u64
 
d©a
)

2864 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2866  
dd
->
£nd_pio_”r_¡©us_út
[31];

2867 
	}
}

2869 
u64
 
	$acûss_pio_»£rved_30_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2870 *
cÚ‹xt
, 
vl
, 
mode
,

2871 
u64
 
d©a
)

2873 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2875  
dd
->
£nd_pio_”r_¡©us_út
[30];

2876 
	}
}

2878 
u64
 
	$acûss_pio_µmc_sÝ_Ën_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2879 *
cÚ‹xt
, 
vl
, 
mode
,

2880 
u64
 
d©a
)

2882 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2884  
dd
->
£nd_pio_”r_¡©us_út
[29];

2885 
	}
}

2887 
u64
 
	$acûss_pio_µmc_bqc_mem_·r™y_”r_út
(

2888 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2889 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2891 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2893  
dd
->
£nd_pio_”r_¡©us_út
[28];

2894 
	}
}

2896 
u64
 
	$acûss_pio_vl_fifo_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2897 *
cÚ‹xt
, 
vl
, 
mode
,

2898 
u64
 
d©a
)

2900 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2902  
dd
->
£nd_pio_”r_¡©us_út
[27];

2903 
	}
}

2905 
u64
 
	$acûss_pio_vlf_sÝ_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2906 *
cÚ‹xt
, 
vl
, 
mode
,

2907 
u64
 
d©a
)

2909 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2911  
dd
->
£nd_pio_”r_¡©us_út
[26];

2912 
	}
}

2914 
u64
 
	$acûss_pio_vlf_v1_Ën_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2915 *
cÚ‹xt
, 
vl
,

2916 
mode
, 
u64
 
d©a
)

2918 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2920  
dd
->
£nd_pio_”r_¡©us_út
[25];

2921 
	}
}

2923 
u64
 
	$acûss_pio_block_qw_couÁ_·r™y_”r_út
(

2924 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2925 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2927 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2929  
dd
->
£nd_pio_”r_¡©us_út
[24];

2930 
	}
}

2932 
u64
 
	$acûss_pio_wr™e_qw_v®id_·r™y_”r_út
(

2933 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2934 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2936 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2938  
dd
->
£nd_pio_”r_¡©us_út
[23];

2939 
	}
}

2941 
u64
 
	$acûss_pio_¡©e_machše_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2942 *
cÚ‹xt
, 
vl
, 
mode
,

2943 
u64
 
d©a
)

2945 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2947  
dd
->
£nd_pio_”r_¡©us_út
[22];

2948 
	}
}

2950 
u64
 
	$acûss_pio_wr™e_d©a_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2951 *
cÚ‹xt
, 
vl
,

2952 
mode
, 
u64
 
d©a
)

2954 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2956  
dd
->
£nd_pio_”r_¡©us_út
[21];

2957 
	}
}

2959 
u64
 
	$acûss_pio_ho¡_addr_mem_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2960 *
cÚ‹xt
, 
vl
,

2961 
mode
, 
u64
 
d©a
)

2963 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2965  
dd
->
£nd_pio_”r_¡©us_út
[20];

2966 
	}
}

2968 
u64
 
	$acûss_pio_ho¡_addr_mem_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2969 *
cÚ‹xt
, 
vl
,

2970 
mode
, 
u64
 
d©a
)

2972 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2974  
dd
->
£nd_pio_”r_¡©us_út
[19];

2975 
	}
}

2977 
u64
 
	$acûss_pio_pkt_eviù_sm_Ü_¬b_sm_”r_út
(

2978 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2979 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

2981 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2983  
dd
->
£nd_pio_”r_¡©us_út
[18];

2984 
	}
}

2986 
u64
 
	$acûss_pio_š™_sm_š_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2987 *
cÚ‹xt
, 
vl
, 
mode
,

2988 
u64
 
d©a
)

2990 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

2992  
dd
->
£nd_pio_”r_¡©us_út
[17];

2993 
	}
}

2995 
u64
 
	$acûss_pio_µmc_pbl_fifo_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

2996 *
cÚ‹xt
, 
vl
, 
mode
,

2997 
u64
 
d©a
)

2999 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3001  
dd
->
£nd_pio_”r_¡©us_út
[16];

3002 
	}
}

3004 
u64
 
	$acûss_pio_üed™_»t_fifo_·r™y_”r_út
(

3005 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3006 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3008 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3010  
dd
->
£nd_pio_”r_¡©us_út
[15];

3011 
	}
}

3013 
u64
 
	$acûss_pio_v1_Ën_mem_bªk1_cÜ_”r_út
(

3014 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3015 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3017 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3019  
dd
->
£nd_pio_”r_¡©us_út
[14];

3020 
	}
}

3022 
u64
 
	$acûss_pio_v1_Ën_mem_bªk0_cÜ_”r_út
(

3023 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3024 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3026 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3028  
dd
->
£nd_pio_”r_¡©us_út
[13];

3029 
	}
}

3031 
u64
 
	$acûss_pio_v1_Ën_mem_bªk1_unc_”r_út
(

3032 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3033 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3035 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3037  
dd
->
£nd_pio_”r_¡©us_út
[12];

3038 
	}
}

3040 
u64
 
	$acûss_pio_v1_Ën_mem_bªk0_unc_”r_út
(

3041 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3042 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3044 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3046  
dd
->
£nd_pio_”r_¡©us_út
[11];

3047 
	}
}

3049 
u64
 
	$acûss_pio_sm_pkt_»£t_·r™y_”r_út
(

3050 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3051 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3053 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3055  
dd
->
£nd_pio_”r_¡©us_út
[10];

3056 
	}
}

3058 
u64
 
	$acûss_pio_pkt_eviù_fifo_·r™y_”r_út
(

3059 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3060 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3062 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3064  
dd
->
£nd_pio_”r_¡©us_út
[9];

3065 
	}
}

3067 
u64
 
	$acûss_pio_sbrdù¾_ü»l_fifo_·r™y_”r_út
(

3068 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3069 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3071 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3073  
dd
->
£nd_pio_”r_¡©us_út
[8];

3074 
	}
}

3076 
u64
 
	$acûss_pio_sbrdùl_ü»l_·r™y_”r_út
(

3077 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3078 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3080 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3082  
dd
->
£nd_pio_”r_¡©us_út
[7];

3083 
	}
}

3085 
u64
 
	$acûss_pio_³c_fifo_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3086 *
cÚ‹xt
, 
vl
, 
mode
,

3087 
u64
 
d©a
)

3089 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3091  
dd
->
£nd_pio_”r_¡©us_út
[6];

3092 
	}
}

3094 
u64
 
	$acûss_pio_pcc_fifo_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3095 *
cÚ‹xt
, 
vl
, 
mode
,

3096 
u64
 
d©a
)

3098 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3100  
dd
->
£nd_pio_”r_¡©us_út
[5];

3101 
	}
}

3103 
u64
 
	$acûss_pio_sb_mem_fifo1_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3104 *
cÚ‹xt
, 
vl
, 
mode
,

3105 
u64
 
d©a
)

3107 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3109  
dd
->
£nd_pio_”r_¡©us_út
[4];

3110 
	}
}

3112 
u64
 
	$acûss_pio_sb_mem_fifo0_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3113 *
cÚ‹xt
, 
vl
, 
mode
,

3114 
u64
 
d©a
)

3116 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3118  
dd
->
£nd_pio_”r_¡©us_út
[3];

3119 
	}
}

3121 
u64
 
	$acûss_pio_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3122 *
cÚ‹xt
, 
vl
, 
mode
,

3123 
u64
 
d©a
)

3125 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3127  
dd
->
£nd_pio_”r_¡©us_út
[2];

3128 
	}
}

3130 
u64
 
	$acûss_pio_wr™e_addr_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3131 *
cÚ‹xt
, 
vl
,

3132 
mode
, 
u64
 
d©a
)

3134 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3136  
dd
->
£nd_pio_”r_¡©us_út
[1];

3137 
	}
}

3139 
u64
 
	$acûss_pio_wr™e_bad_ùxt_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3140 *
cÚ‹xt
, 
vl
, 
mode
,

3141 
u64
 
d©a
)

3143 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3145  
dd
->
£nd_pio_”r_¡©us_út
[0];

3146 
	}
}

3152 
u64
 
	$acûss_sdma_pc›_»q_Œackšg_cÜ_”r_út
(

3153 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3154 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3156 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3158  
dd
->
£nd_dma_”r_¡©us_út
[3];

3159 
	}
}

3161 
u64
 
	$acûss_sdma_pc›_»q_Œackšg_unc_”r_út
(

3162 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3163 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3165 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3167  
dd
->
£nd_dma_”r_¡©us_út
[2];

3168 
	}
}

3170 
u64
 
	$acûss_sdma_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3171 *
cÚ‹xt
, 
vl
, 
mode
,

3172 
u64
 
d©a
)

3174 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3176  
dd
->
£nd_dma_”r_¡©us_út
[1];

3177 
	}
}

3179 
u64
 
	$acûss_sdma_½y_g_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3180 *
cÚ‹xt
, 
vl
, 
mode
,

3181 
u64
 
d©a
)

3183 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3185  
dd
->
£nd_dma_”r_¡©us_út
[0];

3186 
	}
}

3192 
u64
 
	$acûss_tx_»ad_pio_memÜy_c¤_unc_”r_út
(

3193 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3194 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3196 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3198  
dd
->
£nd_eg»ss_”r_¡©us_út
[63];

3199 
	}
}

3201 
u64
 
	$acûss_tx_»ad_sdma_memÜy_c¤_”r_út
(

3202 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3203 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3205 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3207  
dd
->
£nd_eg»ss_”r_¡©us_út
[62];

3208 
	}
}

3210 
u64
 
	$acûss_tx_eg»ss_fifo_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3211 *
cÚ‹xt
, 
vl
, 
mode
,

3212 
u64
 
d©a
)

3214 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3216  
dd
->
£nd_eg»ss_”r_¡©us_út
[61];

3217 
	}
}

3219 
u64
 
	$acûss_tx_»ad_pio_memÜy_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3220 *
cÚ‹xt
, 
vl
,

3221 
mode
, 
u64
 
d©a
)

3223 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3225  
dd
->
£nd_eg»ss_”r_¡©us_út
[60];

3226 
	}
}

3228 
u64
 
	$acûss_tx_»ad_sdma_memÜy_cÜ_”r_út
(

3229 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3230 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3232 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3234  
dd
->
£nd_eg»ss_”r_¡©us_út
[59];

3235 
	}
}

3237 
u64
 
	$acûss_tx_sb_hdr_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3238 *
cÚ‹xt
, 
vl
, 
mode
,

3239 
u64
 
d©a
)

3241 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3243  
dd
->
£nd_eg»ss_”r_¡©us_út
[58];

3244 
	}
}

3246 
u64
 
	$acûss_tx_üed™_ov”run_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3247 *
cÚ‹xt
, 
vl
, 
mode
,

3248 
u64
 
d©a
)

3250 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3252  
dd
->
£nd_eg»ss_”r_¡©us_út
[57];

3253 
	}
}

3255 
u64
 
	$acûss_tx_Ïunch_fifo8_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3256 *
cÚ‹xt
, 
vl
, 
mode
,

3257 
u64
 
d©a
)

3259 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3261  
dd
->
£nd_eg»ss_”r_¡©us_út
[56];

3262 
	}
}

3264 
u64
 
	$acûss_tx_Ïunch_fifo7_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3265 *
cÚ‹xt
, 
vl
, 
mode
,

3266 
u64
 
d©a
)

3268 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3270  
dd
->
£nd_eg»ss_”r_¡©us_út
[55];

3271 
	}
}

3273 
u64
 
	$acûss_tx_Ïunch_fifo6_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3274 *
cÚ‹xt
, 
vl
, 
mode
,

3275 
u64
 
d©a
)

3277 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3279  
dd
->
£nd_eg»ss_”r_¡©us_út
[54];

3280 
	}
}

3282 
u64
 
	$acûss_tx_Ïunch_fifo5_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3283 *
cÚ‹xt
, 
vl
, 
mode
,

3284 
u64
 
d©a
)

3286 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3288  
dd
->
£nd_eg»ss_”r_¡©us_út
[53];

3289 
	}
}

3291 
u64
 
	$acûss_tx_Ïunch_fifo4_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3292 *
cÚ‹xt
, 
vl
, 
mode
,

3293 
u64
 
d©a
)

3295 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3297  
dd
->
£nd_eg»ss_”r_¡©us_út
[52];

3298 
	}
}

3300 
u64
 
	$acûss_tx_Ïunch_fifo3_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3301 *
cÚ‹xt
, 
vl
, 
mode
,

3302 
u64
 
d©a
)

3304 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3306  
dd
->
£nd_eg»ss_”r_¡©us_út
[51];

3307 
	}
}

3309 
u64
 
	$acûss_tx_Ïunch_fifo2_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3310 *
cÚ‹xt
, 
vl
, 
mode
,

3311 
u64
 
d©a
)

3313 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3315  
dd
->
£nd_eg»ss_”r_¡©us_út
[50];

3316 
	}
}

3318 
u64
 
	$acûss_tx_Ïunch_fifo1_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3319 *
cÚ‹xt
, 
vl
, 
mode
,

3320 
u64
 
d©a
)

3322 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3324  
dd
->
£nd_eg»ss_”r_¡©us_út
[49];

3325 
	}
}

3327 
u64
 
	$acûss_tx_Ïunch_fifo0_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3328 *
cÚ‹xt
, 
vl
, 
mode
,

3329 
u64
 
d©a
)

3331 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3333  
dd
->
£nd_eg»ss_”r_¡©us_út
[48];

3334 
	}
}

3336 
u64
 
	$acûss_tx_üed™_»tuº_vl_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3337 *
cÚ‹xt
, 
vl
, 
mode
,

3338 
u64
 
d©a
)

3340 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3342  
dd
->
£nd_eg»ss_”r_¡©us_út
[47];

3343 
	}
}

3345 
u64
 
	$acûss_tx_hüc_š£¹iÚ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3346 *
cÚ‹xt
, 
vl
, 
mode
,

3347 
u64
 
d©a
)

3349 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3351  
dd
->
£nd_eg»ss_”r_¡©us_út
[46];

3352 
	}
}

3354 
u64
 
	$acûss_tx_eg»ss_fifo_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3355 *
cÚ‹xt
, 
vl
, 
mode
,

3356 
u64
 
d©a
)

3358 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3360  
dd
->
£nd_eg»ss_”r_¡©us_út
[45];

3361 
	}
}

3363 
u64
 
	$acûss_tx_»ad_pio_memÜy_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3364 *
cÚ‹xt
, 
vl
,

3365 
mode
, 
u64
 
d©a
)

3367 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3369  
dd
->
£nd_eg»ss_”r_¡©us_út
[44];

3370 
	}
}

3372 
u64
 
	$acûss_tx_»ad_sdma_memÜy_unc_”r_út
(

3373 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3374 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3376 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3378  
dd
->
£nd_eg»ss_”r_¡©us_út
[43];

3379 
	}
}

3381 
u64
 
	$acûss_tx_sb_hdr_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3382 *
cÚ‹xt
, 
vl
, 
mode
,

3383 
u64
 
d©a
)

3385 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3387  
dd
->
£nd_eg»ss_”r_¡©us_út
[42];

3388 
	}
}

3390 
u64
 
	$acûss_tx_üed™_»tuº_·¹iy_”r_út
(

3391 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3392 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3394 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3396  
dd
->
£nd_eg»ss_”r_¡©us_út
[41];

3397 
	}
}

3399 
u64
 
	$acûss_tx_Ïunch_fifo8_unc_Ü_·r™y_”r_út
(

3400 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3401 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3403 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3405  
dd
->
£nd_eg»ss_”r_¡©us_út
[40];

3406 
	}
}

3408 
u64
 
	$acûss_tx_Ïunch_fifo7_unc_Ü_·r™y_”r_út
(

3409 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3410 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3412 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3414  
dd
->
£nd_eg»ss_”r_¡©us_út
[39];

3415 
	}
}

3417 
u64
 
	$acûss_tx_Ïunch_fifo6_unc_Ü_·r™y_”r_út
(

3418 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3419 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3421 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3423  
dd
->
£nd_eg»ss_”r_¡©us_út
[38];

3424 
	}
}

3426 
u64
 
	$acûss_tx_Ïunch_fifo5_unc_Ü_·r™y_”r_út
(

3427 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3428 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3430 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3432  
dd
->
£nd_eg»ss_”r_¡©us_út
[37];

3433 
	}
}

3435 
u64
 
	$acûss_tx_Ïunch_fifo4_unc_Ü_·r™y_”r_út
(

3436 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3437 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3439 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3441  
dd
->
£nd_eg»ss_”r_¡©us_út
[36];

3442 
	}
}

3444 
u64
 
	$acûss_tx_Ïunch_fifo3_unc_Ü_·r™y_”r_út
(

3445 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3446 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3448 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3450  
dd
->
£nd_eg»ss_”r_¡©us_út
[35];

3451 
	}
}

3453 
u64
 
	$acûss_tx_Ïunch_fifo2_unc_Ü_·r™y_”r_út
(

3454 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3455 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3457 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3459  
dd
->
£nd_eg»ss_”r_¡©us_út
[34];

3460 
	}
}

3462 
u64
 
	$acûss_tx_Ïunch_fifo1_unc_Ü_·r™y_”r_út
(

3463 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3464 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3466 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3468  
dd
->
£nd_eg»ss_”r_¡©us_út
[33];

3469 
	}
}

3471 
u64
 
	$acûss_tx_Ïunch_fifo0_unc_Ü_·r™y_”r_út
(

3472 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3473 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3475 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3477  
dd
->
£nd_eg»ss_”r_¡©us_út
[32];

3478 
	}
}

3480 
u64
 
	$acûss_tx_sdma15_di§Îowed_·ck‘_”r_út
(

3481 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3482 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3484 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3486  
dd
->
£nd_eg»ss_”r_¡©us_út
[31];

3487 
	}
}

3489 
u64
 
	$acûss_tx_sdma14_di§Îowed_·ck‘_”r_út
(

3490 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3491 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3493 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3495  
dd
->
£nd_eg»ss_”r_¡©us_út
[30];

3496 
	}
}

3498 
u64
 
	$acûss_tx_sdma13_di§Îowed_·ck‘_”r_út
(

3499 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3500 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3502 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3504  
dd
->
£nd_eg»ss_”r_¡©us_út
[29];

3505 
	}
}

3507 
u64
 
	$acûss_tx_sdma12_di§Îowed_·ck‘_”r_út
(

3508 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3509 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3511 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3513  
dd
->
£nd_eg»ss_”r_¡©us_út
[28];

3514 
	}
}

3516 
u64
 
	$acûss_tx_sdma11_di§Îowed_·ck‘_”r_út
(

3517 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3518 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3520 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3522  
dd
->
£nd_eg»ss_”r_¡©us_út
[27];

3523 
	}
}

3525 
u64
 
	$acûss_tx_sdma10_di§Îowed_·ck‘_”r_út
(

3526 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3527 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3529 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3531  
dd
->
£nd_eg»ss_”r_¡©us_út
[26];

3532 
	}
}

3534 
u64
 
	$acûss_tx_sdma9_di§Îowed_·ck‘_”r_út
(

3535 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3536 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3538 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3540  
dd
->
£nd_eg»ss_”r_¡©us_út
[25];

3541 
	}
}

3543 
u64
 
	$acûss_tx_sdma8_di§Îowed_·ck‘_”r_út
(

3544 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3545 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3547 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3549  
dd
->
£nd_eg»ss_”r_¡©us_út
[24];

3550 
	}
}

3552 
u64
 
	$acûss_tx_sdma7_di§Îowed_·ck‘_”r_út
(

3553 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3554 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3556 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3558  
dd
->
£nd_eg»ss_”r_¡©us_út
[23];

3559 
	}
}

3561 
u64
 
	$acûss_tx_sdma6_di§Îowed_·ck‘_”r_út
(

3562 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3563 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3565 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3567  
dd
->
£nd_eg»ss_”r_¡©us_út
[22];

3568 
	}
}

3570 
u64
 
	$acûss_tx_sdma5_di§Îowed_·ck‘_”r_út
(

3571 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3572 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3574 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3576  
dd
->
£nd_eg»ss_”r_¡©us_út
[21];

3577 
	}
}

3579 
u64
 
	$acûss_tx_sdma4_di§Îowed_·ck‘_”r_út
(

3580 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3581 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3583 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3585  
dd
->
£nd_eg»ss_”r_¡©us_út
[20];

3586 
	}
}

3588 
u64
 
	$acûss_tx_sdma3_di§Îowed_·ck‘_”r_út
(

3589 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3590 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3592 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3594  
dd
->
£nd_eg»ss_”r_¡©us_út
[19];

3595 
	}
}

3597 
u64
 
	$acûss_tx_sdma2_di§Îowed_·ck‘_”r_út
(

3598 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3599 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3601 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3603  
dd
->
£nd_eg»ss_”r_¡©us_út
[18];

3604 
	}
}

3606 
u64
 
	$acûss_tx_sdma1_di§Îowed_·ck‘_”r_út
(

3607 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3608 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3610 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3612  
dd
->
£nd_eg»ss_”r_¡©us_út
[17];

3613 
	}
}

3615 
u64
 
	$acûss_tx_sdma0_di§Îowed_·ck‘_”r_út
(

3616 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3617 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3619 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3621  
dd
->
£nd_eg»ss_”r_¡©us_út
[16];

3622 
	}
}

3624 
u64
 
	$acûss_tx_cÚfig_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3625 *
cÚ‹xt
, 
vl
, 
mode
,

3626 
u64
 
d©a
)

3628 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3630  
dd
->
£nd_eg»ss_”r_¡©us_út
[15];

3631 
	}
}

3633 
u64
 
	$acûss_tx_sbrd_ùl_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3634 *
cÚ‹xt
, 
vl
,

3635 
mode
, 
u64
 
d©a
)

3637 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3639  
dd
->
£nd_eg»ss_”r_¡©us_út
[14];

3640 
	}
}

3642 
u64
 
	$acûss_tx_Ïunch_c¤_·r™y_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3643 *
cÚ‹xt
, 
vl
, 
mode
,

3644 
u64
 
d©a
)

3646 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3648  
dd
->
£nd_eg»ss_”r_¡©us_út
[13];

3649 
	}
}

3651 
u64
 
	$acûss_tx_žËg®_vl_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3652 *
cÚ‹xt
, 
vl
, 
mode
,

3653 
u64
 
d©a
)

3655 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3657  
dd
->
£nd_eg»ss_”r_¡©us_út
[12];

3658 
	}
}

3660 
u64
 
	$acûss_tx_sbrd_ùl_¡©e_machše_·r™y_”r_út
(

3661 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3662 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3664 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3666  
dd
->
£nd_eg»ss_”r_¡©us_út
[11];

3667 
	}
}

3669 
u64
 
	$acûss_eg»ss_»£rved_10_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3670 *
cÚ‹xt
, 
vl
, 
mode
,

3671 
u64
 
d©a
)

3673 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3675  
dd
->
£nd_eg»ss_”r_¡©us_út
[10];

3676 
	}
}

3678 
u64
 
	$acûss_eg»ss_»£rved_9_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3679 *
cÚ‹xt
, 
vl
, 
mode
,

3680 
u64
 
d©a
)

3682 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3684  
dd
->
£nd_eg»ss_”r_¡©us_út
[9];

3685 
	}
}

3687 
u64
 
	$acûss_tx_sdma_Ïunch_štf_·r™y_”r_út
(

3688 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3689 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3691 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3693  
dd
->
£nd_eg»ss_”r_¡©us_út
[8];

3694 
	}
}

3696 
u64
 
	$acûss_tx_pio_Ïunch_štf_·r™y_”r_út
(

3697 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3698 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3700 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3702  
dd
->
£nd_eg»ss_”r_¡©us_út
[7];

3703 
	}
}

3705 
u64
 
	$acûss_eg»ss_»£rved_6_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3706 *
cÚ‹xt
, 
vl
, 
mode
,

3707 
u64
 
d©a
)

3709 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3711  
dd
->
£nd_eg»ss_”r_¡©us_út
[6];

3712 
	}
}

3714 
u64
 
	$acûss_tx_šcÜ»ù_lšk_¡©e_”r_út
(

3715 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3716 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3718 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3720  
dd
->
£nd_eg»ss_”r_¡©us_út
[5];

3721 
	}
}

3723 
u64
 
	$acûss_tx_lškdown_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3724 *
cÚ‹xt
, 
vl
, 
mode
,

3725 
u64
 
d©a
)

3727 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3729  
dd
->
£nd_eg»ss_”r_¡©us_út
[4];

3730 
	}
}

3732 
u64
 
	$acûss_tx_eg»ss_fifi_und”run_Ü_·r™y_”r_út
(

3733 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3734 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3736 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3738  
dd
->
£nd_eg»ss_”r_¡©us_út
[3];

3739 
	}
}

3741 
u64
 
	$acûss_eg»ss_»£rved_2_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3742 *
cÚ‹xt
, 
vl
, 
mode
,

3743 
u64
 
d©a
)

3745 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3747  
dd
->
£nd_eg»ss_”r_¡©us_út
[2];

3748 
	}
}

3750 
u64
 
	$acûss_tx_pkt_š‹gr™y_mem_unc_”r_út
(

3751 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3752 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3754 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3756  
dd
->
£nd_eg»ss_”r_¡©us_út
[1];

3757 
	}
}

3759 
u64
 
	$acûss_tx_pkt_š‹gr™y_mem_cÜ_”r_út
(

3760 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3761 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3763 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3765  
dd
->
£nd_eg»ss_”r_¡©us_út
[0];

3766 
	}
}

3772 
u64
 
	$acûss_£nd_c¤_wr™e_bad_addr_”r_út
(

3773 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3774 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3776 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3778  
dd
->
£nd_”r_¡©us_út
[2];

3779 
	}
}

3781 
u64
 
	$acûss_£nd_c¤_»ad_bad_addr_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3782 *
cÚ‹xt
, 
vl
,

3783 
mode
, 
u64
 
d©a
)

3785 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3787  
dd
->
£nd_”r_¡©us_út
[1];

3788 
	}
}

3790 
u64
 
	$acûss_£nd_c¤_·r™y_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3791 *
cÚ‹xt
, 
vl
, 
mode
,

3792 
u64
 
d©a
)

3794 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3796  
dd
->
£nd_”r_¡©us_út
[0];

3797 
	}
}

3803 
u64
 
	$acûss_pio_wr™e_out_of_bounds_”r_út
(

3804 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3805 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3807 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3809  
dd
->
sw_ùxt_”r_¡©us_út
[4];

3810 
	}
}

3812 
u64
 
	$acûss_pio_wr™e_ov”æow_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3813 *
cÚ‹xt
, 
vl
, 
mode
,

3814 
u64
 
d©a
)

3816 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3818  
dd
->
sw_ùxt_”r_¡©us_út
[3];

3819 
	}
}

3821 
u64
 
	$acûss_pio_wr™e_üos£s_bound¬y_”r_út
(

3822 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3823 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3825 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3827  
dd
->
sw_ùxt_”r_¡©us_út
[2];

3828 
	}
}

3830 
u64
 
	$acûss_pio_di§Îowed_·ck‘_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3831 *
cÚ‹xt
, 
vl
,

3832 
mode
, 
u64
 
d©a
)

3834 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3836  
dd
->
sw_ùxt_”r_¡©us_út
[1];

3837 
	}
}

3839 
u64
 
	$acûss_pio_šcÚsi¡’t_sÝ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3840 *
cÚ‹xt
, 
vl
, 
mode
,

3841 
u64
 
d©a
)

3843 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3845  
dd
->
sw_ùxt_”r_¡©us_út
[0];

3846 
	}
}

3852 
u64
 
	$acûss_sdma_h—d”_»que¡_fifo_cÜ_”r_út
(

3853 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3854 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3856 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3858  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[23];

3859 
	}
}

3861 
u64
 
	$acûss_sdma_h—d”_¡Üage_cÜ_”r_út
(

3862 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3863 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3865 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3867  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[22];

3868 
	}
}

3870 
u64
 
	$acûss_sdma_·ck‘_Œackšg_cÜ_”r_út
(

3871 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3872 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3874 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3876  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[21];

3877 
	}
}

3879 
u64
 
	$acûss_sdma_as£mbly_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3880 *
cÚ‹xt
, 
vl
, 
mode
,

3881 
u64
 
d©a
)

3883 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3885  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[20];

3886 
	}
}

3888 
u64
 
	$acûss_sdma_desc_bË_cÜ_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3889 *
cÚ‹xt
, 
vl
, 
mode
,

3890 
u64
 
d©a
)

3892 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3894  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[19];

3895 
	}
}

3897 
u64
 
	$acûss_sdma_h—d”_»que¡_fifo_unc_”r_út
(

3898 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3899 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3901 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3903  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[18];

3904 
	}
}

3906 
u64
 
	$acûss_sdma_h—d”_¡Üage_unc_”r_út
(

3907 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3908 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3910 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3912  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[17];

3913 
	}
}

3915 
u64
 
	$acûss_sdma_·ck‘_Œackšg_unc_”r_út
(

3916 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3917 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3919 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3921  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[16];

3922 
	}
}

3924 
u64
 
	$acûss_sdma_as£mbly_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3925 *
cÚ‹xt
, 
vl
, 
mode
,

3926 
u64
 
d©a
)

3928 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3930  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[15];

3931 
	}
}

3933 
u64
 
	$acûss_sdma_desc_bË_unc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3934 *
cÚ‹xt
, 
vl
, 
mode
,

3935 
u64
 
d©a
)

3937 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3939  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[14];

3940 
	}
}

3942 
u64
 
	$acûss_sdma_timeout_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3943 *
cÚ‹xt
, 
vl
, 
mode
,

3944 
u64
 
d©a
)

3946 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3948  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[13];

3949 
	}
}

3951 
u64
 
	$acûss_sdma_h—d”_Ëngth_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3952 *
cÚ‹xt
, 
vl
, 
mode
,

3953 
u64
 
d©a
)

3955 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3957  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[12];

3958 
	}
}

3960 
u64
 
	$acûss_sdma_h—d”_add»ss_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3961 *
cÚ‹xt
, 
vl
, 
mode
,

3962 
u64
 
d©a
)

3964 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3966  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[11];

3967 
	}
}

3969 
u64
 
	$acûss_sdma_h—d”_£Ëù_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3970 *
cÚ‹xt
, 
vl
, 
mode
,

3971 
u64
 
d©a
)

3973 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3975  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[10];

3976 
	}
}

3978 
u64
 
	$acûss_sdma_»£rved_9_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3979 *
cÚ‹xt
, 
vl
, 
mode
,

3980 
u64
 
d©a
)

3982 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3984  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[9];

3985 
	}
}

3987 
u64
 
	$acûss_sdma_·ck‘_desc_ov”æow_”r_út
(

3988 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3989 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

3991 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

3993  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[8];

3994 
	}
}

3996 
u64
 
	$acûss_sdma_Ëngth_mism©ch_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

3997 *
cÚ‹xt
, 
vl
,

3998 
mode
, 
u64
 
d©a
)

4000 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4002  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[7];

4003 
	}
}

4005 
u64
 
	$acûss_sdma_h®t_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4006 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

4008 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4010  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[6];

4011 
	}
}

4013 
u64
 
	$acûss_sdma_mem_»ad_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4014 *
cÚ‹xt
, 
vl
, 
mode
,

4015 
u64
 
d©a
)

4017 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4019  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[5];

4020 
	}
}

4022 
u64
 
	$acûss_sdma_fœ¡_desc_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4023 *
cÚ‹xt
, 
vl
, 
mode
,

4024 
u64
 
d©a
)

4026 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4028  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[4];

4029 
	}
}

4031 
u64
 
	$acûss_sdma_ž_out_of_bounds_”r_út
(

4032 cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4033 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

4035 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4037  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[3];

4038 
	}
}

4040 
u64
 
	$acûss_sdma_too_lÚg_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4041 *
cÚ‹xt
, 
vl
, 
mode
,

4042 
u64
 
d©a
)

4044 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4046  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[2];

4047 
	}
}

4049 
u64
 
	$acûss_sdma_g’_mism©ch_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4050 *
cÚ‹xt
, 
vl
, 
mode
,

4051 
u64
 
d©a
)

4053 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4055  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[1];

4056 
	}
}

4058 
u64
 
	$acûss_sdma_wrÚg_dw_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4059 *
cÚ‹xt
, 
vl
, 
mode
,

4060 
u64
 
d©a
)

4062 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4064  
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[0];

4065 
	}
}

4067 
u64
 
	$acûss_dc_rcv_”r_út
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

4068 *
cÚ‹xt
, 
vl
, 
mode
,

4069 
u64
 
d©a
)

4071 
hfi1_devd©a
 *
dd
 = (hfi1_devd©¨*)
cÚ‹xt
;

4073 
u64
 
v®
 = 0;

4074 
u64
 
c¤
 = 
’Œy
->csr;

4076 
v®
 = 
	`»ad_wr™e_c¤
(
dd
, 
c¤
, 
mode
, 
d©a
);

4077 ià(
mode
 =ð
CNTR_MODE_R
) {

4078 
v®
 = v® > 
CNTR_MAX
 - 
dd
->
sw_rcv_by·ss_·ck‘_”rÜs
 ?

4079 
CNTR_MAX
 : 
v®
 + 
dd
->
sw_rcv_by·ss_·ck‘_”rÜs
;

4080 } ià(
mode
 =ð
CNTR_MODE_W
) {

4081 
dd
->
sw_rcv_by·ss_·ck‘_”rÜs
 = 0;

4083 
	`dd_dev_”r
(
dd
, "Invalid cntr„egister‡ccess mode");

4086  
v®
;

4087 
	}
}

4089 
	#def_acûss_sw_ýu
(
úŒ
) \

4090 
u64
 
acûss_sw_ýu_
##
	`úŒ
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, \

4091 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
) \

4093 
hfi1_µÜtd©a
 *
µd
 = (hfi1_µÜtd©¨*)
cÚ‹xt
; \

4094  
	`»ad_wr™e_ýu
(
µd
->
dd
, &µd->
ibpÜt_d©a
.
rvp
.
z_
 ##
úŒ
, \

4095 
µd
->
ibpÜt_d©a
.
rvp
.
úŒ
, 
vl
, \

4096 
mode
, 
d©a
); \

4097 }

	)

4099 
def_acûss_sw_ýu
(
rc_acks
);

4100 
def_acûss_sw_ýu
(
rc_qacks
);

4101 
def_acûss_sw_ýu
(
rc_d–ayed_comp
);

4103 
	#def_acûss_ibp_couÁ”
(
úŒ
) \

4104 
u64
 
acûss_ibp_
##
	`úŒ
(cÚ¡ 
úŒ_’Œy
 *
’Œy
, \

4105 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
) \

4107 
hfi1_µÜtd©a
 *
µd
 = (hfi1_µÜtd©¨*)
cÚ‹xt
; \

4109 ià(
vl
 !ð
CNTR_INVALID_VL
) \

4112  
	`»ad_wr™e_sw
(
µd
->
dd
, &µd->
ibpÜt_d©a
.
rvp
.
n_
 ##
úŒ
, \

4113 
mode
, 
d©a
); \

4114 }

	)

4116 
def_acûss_ibp_couÁ”
(
loÝ_pkts
);

4117 
def_acûss_ibp_couÁ”
(
rc_»£nds
);

4118 
def_acûss_ibp_couÁ”
(
ºr_Çks
);

4119 
def_acûss_ibp_couÁ”
(
Ùh”_Çks
);

4120 
def_acûss_ibp_couÁ”
(
rc_timeouts
);

4121 
def_acûss_ibp_couÁ”
(
pkt_drÝs
);

4122 
def_acûss_ibp_couÁ”
(
dmawa™
);

4123 
def_acûss_ibp_couÁ”
(
rc_£qÇk
);

4124 
def_acûss_ibp_couÁ”
(
rc_du´eq
);

4125 
def_acûss_ibp_couÁ”
(
rdma_£q
);

4126 
def_acûss_ibp_couÁ”
(
uÇligÃd
);

4127 
def_acûss_ibp_couÁ”
(
£q_Çks
);

4129 
úŒ_’Œy
 
	gdev_úŒs
[
DEV_CNTR_LAST
] = {

4130 [
C_RCV_OVF
] = 
RXE32_DEV_CNTR_ELEM
(
RcvOv”æow
, 
RCV_BUF_OVFL_CNT
, 
CNTR_SYNTH
),

4131 [
C_RX_LEN_ERR
] = 
RXE32_DEV_CNTR_ELEM
(
RxL’E¼
, 
RCV_LENGTH_ERR_CNT
, 
CNTR_SYNTH
),

4132 [
C_RX_SHORT_ERR
] = 
RXE32_DEV_CNTR_ELEM
(
RxShrE¼
, 
RCV_SHORT_ERR_CNT
, 
CNTR_SYNTH
),

4133 [
C_RX_ICRC_ERR
] = 
RXE32_DEV_CNTR_ELEM
(
RxICrcE¼
, 
RCV_ICRC_ERR_CNT
, 
CNTR_SYNTH
),

4134 [
C_RX_EBP
] = 
RXE32_DEV_CNTR_ELEM
(
RxEbpCÁ
, 
RCV_EBP_CNT
, 
CNTR_SYNTH
),

4135 [
C_RX_TID_FULL
] = 
RXE32_DEV_CNTR_ELEM
(
RxTIDFuÎEr
, 
RCV_TID_FULL_ERR_CNT
,

4136 
CNTR_NORMAL
),

4137 [
C_RX_TID_INVALID
] = 
RXE32_DEV_CNTR_ELEM
(
RxTIDInv®id
, 
RCV_TID_VALID_ERR_CNT
,

4138 
CNTR_NORMAL
),

4139 [
C_RX_TID_FLGMS
] = 
RXE32_DEV_CNTR_ELEM
(
RxTidFLGMs
,

4140 
RCV_TID_FLOW_GEN_MISMATCH_CNT
,

4141 
CNTR_NORMAL
),

4142 [
C_RX_CTX_EGRS
] = 
RXE32_DEV_CNTR_ELEM
(
RxCtxEgrS
, 
RCV_CONTEXT_EGR_STALL
,

4143 
CNTR_NORMAL
),

4144 [
C_RCV_TID_FLSMS
] = 
RXE32_DEV_CNTR_ELEM
(
RxTidFLSMs
,

4145 
RCV_TID_FLOW_SEQ_MISMATCH_CNT
, 
CNTR_NORMAL
),

4146 [
C_CCE_PCI_CR_ST
] = 
CCE_PERF_DEV_CNTR_ELEM
(
CûPciCrSt
,

4147 
CCE_PCIE_POSTED_CRDT_STALL_CNT
, 
CNTR_NORMAL
),

4148 [
C_CCE_PCI_TR_ST
] = 
CCE_PERF_DEV_CNTR_ELEM
(
CûPciTrSt
, 
CCE_PCIE_TRGT_STALL_CNT
,

4149 
CNTR_NORMAL
),

4150 [
C_CCE_PIO_WR_ST
] = 
CCE_PERF_DEV_CNTR_ELEM
(
CûPioWrSt
, 
CCE_PIO_WR_STALL_CNT
,

4151 
CNTR_NORMAL
),

4152 [
C_CCE_ERR_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûE¼IÁ
, 
CCE_ERR_INT_CNT
,

4153 
CNTR_NORMAL
),

4154 [
C_CCE_SDMA_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûSdmaIÁ
, 
CCE_SDMA_INT_CNT
,

4155 
CNTR_NORMAL
),

4156 [
C_CCE_MISC_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûMiscIÁ
, 
CCE_MISC_INT_CNT
,

4157 
CNTR_NORMAL
),

4158 [
C_CCE_RCV_AV_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûRcvAvIÁ
, 
CCE_RCV_AVAIL_INT_CNT
,

4159 
CNTR_NORMAL
),

4160 [
C_CCE_RCV_URG_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûRcvUrgIÁ
,

4161 
CCE_RCV_URGENT_INT_CNT
, 
CNTR_NORMAL
),

4162 [
C_CCE_SEND_CR_INT
] = 
CCE_INT_DEV_CNTR_ELEM
(
CûSndCrIÁ
,

4163 
CCE_SEND_CREDIT_INT_CNT
, 
CNTR_NORMAL
),

4164 [
C_DC_UNC_ERR
] = 
DC_PERF_CNTR
(
DcUnùblE¼
, 
DCC_ERR_UNCORRECTABLE_CNT
,

4165 
CNTR_SYNTH
),

4166 [
C_DC_RCV_ERR
] = 
CNTR_ELEM
("DcRecvE¼", 
DCC_ERR_PORTRCV_ERR_CNT
, 0, 
CNTR_SYNTH
,

4167 
acûss_dc_rcv_”r_út
),

4168 [
C_DC_FM_CFG_ERR
] = 
DC_PERF_CNTR
(
DcFmCfgE¼
, 
DCC_ERR_FMCONFIG_ERR_CNT
,

4169 
CNTR_SYNTH
),

4170 [
C_DC_RMT_PHY_ERR
] = 
DC_PERF_CNTR
(
DcRmtPhyE¼
, 
DCC_ERR_RCVREMOTE_PHY_ERR_CNT
,

4171 
CNTR_SYNTH
),

4172 [
C_DC_DROPPED_PKT
] = 
DC_PERF_CNTR
(
DcDrÝ³dPkt
, 
DCC_ERR_DROPPED_PKT_CNT
,

4173 
CNTR_SYNTH
),

4174 [
C_DC_MC_XMIT_PKTS
] = 
DC_PERF_CNTR
(
DcMcXm™Pkts
,

4175 
DCC_PRF_PORT_XMIT_MULTICAST_CNT
, 
CNTR_SYNTH
),

4176 [
C_DC_MC_RCV_PKTS
] = 
DC_PERF_CNTR
(
DcMcRcvPkts
,

4177 
DCC_PRF_PORT_RCV_MULTICAST_PKT_CNT
,

4178 
CNTR_SYNTH
),

4179 [
C_DC_XMIT_CERR
] = 
DC_PERF_CNTR
(
DcXm™CÜr
,

4180 
DCC_PRF_PORT_XMIT_CORRECTABLE_CNT
, 
CNTR_SYNTH
),

4181 [
C_DC_RCV_CERR
] = 
DC_PERF_CNTR
(
DcRcvCÜrCÁ
, 
DCC_PRF_PORT_RCV_CORRECTABLE_CNT
,

4182 
CNTR_SYNTH
),

4183 [
C_DC_RCV_FCC
] = 
DC_PERF_CNTR
(
DcRxFCÁl
, 
DCC_PRF_RX_FLOW_CRTL_CNT
,

4184 
CNTR_SYNTH
),

4185 [
C_DC_XMIT_FCC
] = 
DC_PERF_CNTR
(
DcXm™FCÁl
, 
DCC_PRF_TX_FLOW_CRTL_CNT
,

4186 
CNTR_SYNTH
),

4187 [
C_DC_XMIT_FLITS
] = 
DC_PERF_CNTR
(
DcXm™Fl™s
, 
DCC_PRF_PORT_XMIT_DATA_CNT
,

4188 
CNTR_SYNTH
),

4189 [
C_DC_RCV_FLITS
] = 
DC_PERF_CNTR
(
DcRcvFl™s
, 
DCC_PRF_PORT_RCV_DATA_CNT
,

4190 
CNTR_SYNTH
),

4191 [
C_DC_XMIT_PKTS
] = 
DC_PERF_CNTR
(
DcXm™Pkts
, 
DCC_PRF_PORT_XMIT_PKTS_CNT
,

4192 
CNTR_SYNTH
),

4193 [
C_DC_RCV_PKTS
] = 
DC_PERF_CNTR
(
DcRcvPkts
, 
DCC_PRF_PORT_RCV_PKTS_CNT
,

4194 
CNTR_SYNTH
),

4195 [
C_DC_RX_FLIT_VL
] = 
DC_PERF_CNTR
(
DcRxFl™Vl
, 
DCC_PRF_PORT_VL_RCV_DATA_CNT
,

4196 
CNTR_SYNTH
 | 
CNTR_VL
),

4197 [
C_DC_RX_PKT_VL
] = 
DC_PERF_CNTR
(
DcRxPktVl
, 
DCC_PRF_PORT_VL_RCV_PKTS_CNT
,

4198 
CNTR_SYNTH
 | 
CNTR_VL
),

4199 [
C_DC_RCV_FCN
] = 
DC_PERF_CNTR
(
DcRcvFú
, 
DCC_PRF_PORT_RCV_FECN_CNT
, 
CNTR_SYNTH
),

4200 [
C_DC_RCV_FCN_VL
] = 
DC_PERF_CNTR
(
DcRcvFúVl
, 
DCC_PRF_PORT_VL_RCV_FECN_CNT
,

4201 
CNTR_SYNTH
 | 
CNTR_VL
),

4202 [
C_DC_RCV_BCN
] = 
DC_PERF_CNTR
(
DcRcvBú
, 
DCC_PRF_PORT_RCV_BECN_CNT
, 
CNTR_SYNTH
),

4203 [
C_DC_RCV_BCN_VL
] = 
DC_PERF_CNTR
(
DcRcvBúVl
, 
DCC_PRF_PORT_VL_RCV_BECN_CNT
,

4204 
CNTR_SYNTH
 | 
CNTR_VL
),

4205 [
C_DC_RCV_BBL
] = 
DC_PERF_CNTR
(
DcRcvBbl
, 
DCC_PRF_PORT_RCV_BUBBLE_CNT
,

4206 
CNTR_SYNTH
),

4207 [
C_DC_RCV_BBL_VL
] = 
DC_PERF_CNTR
(
DcRcvBblVl
, 
DCC_PRF_PORT_VL_RCV_BUBBLE_CNT
,

4208 
CNTR_SYNTH
 | 
CNTR_VL
),

4209 [
C_DC_MARK_FECN
] = 
DC_PERF_CNTR
(
DcM¬kFú
, 
DCC_PRF_PORT_MARK_FECN_CNT
,

4210 
CNTR_SYNTH
),

4211 [
C_DC_MARK_FECN_VL
] = 
DC_PERF_CNTR
(
DcM¬kFúVl
, 
DCC_PRF_PORT_VL_MARK_FECN_CNT
,

4212 
CNTR_SYNTH
 | 
CNTR_VL
),

4213 [
C_DC_TOTAL_CRC
] =

4214 
DC_PERF_CNTR_LCB
(
DcTÙCrc
, 
DC_LCB_ERR_INFO_TOTAL_CRC_ERR
,

4215 
CNTR_SYNTH
),

4216 [
C_DC_CRC_LN0
] = 
DC_PERF_CNTR_LCB
(
DcCrcLn0
, 
DC_LCB_ERR_INFO_CRC_ERR_LN0
,

4217 
CNTR_SYNTH
),

4218 [
C_DC_CRC_LN1
] = 
DC_PERF_CNTR_LCB
(
DcCrcLn1
, 
DC_LCB_ERR_INFO_CRC_ERR_LN1
,

4219 
CNTR_SYNTH
),

4220 [
C_DC_CRC_LN2
] = 
DC_PERF_CNTR_LCB
(
DcCrcLn2
, 
DC_LCB_ERR_INFO_CRC_ERR_LN2
,

4221 
CNTR_SYNTH
),

4222 [
C_DC_CRC_LN3
] = 
DC_PERF_CNTR_LCB
(
DcCrcLn3
, 
DC_LCB_ERR_INFO_CRC_ERR_LN3
,

4223 
CNTR_SYNTH
),

4224 [
C_DC_CRC_MULT_LN
] =

4225 
DC_PERF_CNTR_LCB
(
DcMuÉLn
, 
DC_LCB_ERR_INFO_CRC_ERR_MULTI_LN
,

4226 
CNTR_SYNTH
),

4227 [
C_DC_TX_REPLAY
] = 
DC_PERF_CNTR_LCB
(
DcTxR•Ïy
, 
DC_LCB_ERR_INFO_TX_REPLAY_CNT
,

4228 
CNTR_SYNTH
),

4229 [
C_DC_RX_REPLAY
] = 
DC_PERF_CNTR_LCB
(
DcRxR•Ïy
, 
DC_LCB_ERR_INFO_RX_REPLAY_CNT
,

4230 
CNTR_SYNTH
),

4231 [
C_DC_SEQ_CRC_CNT
] =

4232 
DC_PERF_CNTR_LCB
(
DcLškSeqCrc
, 
DC_LCB_ERR_INFO_SEQ_CRC_CNT
,

4233 
CNTR_SYNTH
),

4234 [
C_DC_ESC0_ONLY_CNT
] =

4235 
DC_PERF_CNTR_LCB
(
DcEsc0
, 
DC_LCB_ERR_INFO_ESCAPE_0_ONLY_CNT
,

4236 
CNTR_SYNTH
),

4237 [
C_DC_ESC0_PLUS1_CNT
] =

4238 
DC_PERF_CNTR_LCB
(
DcEsc1
, 
DC_LCB_ERR_INFO_ESCAPE_0_PLUS1_CNT
,

4239 
CNTR_SYNTH
),

4240 [
C_DC_ESC0_PLUS2_CNT
] =

4241 
DC_PERF_CNTR_LCB
(
DcEsc0Plus2
, 
DC_LCB_ERR_INFO_ESCAPE_0_PLUS2_CNT
,

4242 
CNTR_SYNTH
),

4243 [
C_DC_REINIT_FROM_PEER_CNT
] =

4244 
DC_PERF_CNTR_LCB
(
DcReš™P“r
, 
DC_LCB_ERR_INFO_REINIT_FROM_PEER_CNT
,

4245 
CNTR_SYNTH
),

4246 [
C_DC_SBE_CNT
] = 
DC_PERF_CNTR_LCB
(
DcSbe
, 
DC_LCB_ERR_INFO_SBE_CNT
,

4247 
CNTR_SYNTH
),

4248 [
C_DC_MISC_FLG_CNT
] =

4249 
DC_PERF_CNTR_LCB
(
DcMiscFlg
, 
DC_LCB_ERR_INFO_MISC_FLG_CNT
,

4250 
CNTR_SYNTH
),

4251 [
C_DC_PRF_GOOD_LTP_CNT
] =

4252 
DC_PERF_CNTR_LCB
(
DcGoodLTP
, 
DC_LCB_PRF_GOOD_LTP_CNT
, 
CNTR_SYNTH
),

4253 [
C_DC_PRF_ACCEPTED_LTP_CNT
] =

4254 
DC_PERF_CNTR_LCB
(
DcAccLTP
, 
DC_LCB_PRF_ACCEPTED_LTP_CNT
,

4255 
CNTR_SYNTH
),

4256 [
C_DC_PRF_RX_FLIT_CNT
] =

4257 
DC_PERF_CNTR_LCB
(
DcPrfRxFl™
, 
DC_LCB_PRF_RX_FLIT_CNT
, 
CNTR_SYNTH
),

4258 [
C_DC_PRF_TX_FLIT_CNT
] =

4259 
DC_PERF_CNTR_LCB
(
DcPrfTxFl™
, 
DC_LCB_PRF_TX_FLIT_CNT
, 
CNTR_SYNTH
),

4260 [
C_DC_PRF_CLK_CNTR
] =

4261 
DC_PERF_CNTR_LCB
(
DcPrfClk
, 
DC_LCB_PRF_CLK_CNTR
, 
CNTR_SYNTH
),

4262 [
C_DC_PG_DBG_FLIT_CRDTS_CNT
] =

4263 
DC_PERF_CNTR_LCB
(
DcFÉCrdts
, 
DC_LCB_PG_DBG_FLIT_CRDTS_CNT
, 
CNTR_SYNTH
),

4264 [
C_DC_PG_STS_PAUSE_COMPLETE_CNT
] =

4265 
DC_PERF_CNTR_LCB
(
DcPau£Comp
, 
DC_LCB_PG_STS_PAUSE_COMPLETE_CNT
,

4266 
CNTR_SYNTH
),

4267 [
C_DC_PG_STS_TX_SBE_CNT
] =

4268 
DC_PERF_CNTR_LCB
(
DcStsTxSbe
, 
DC_LCB_PG_STS_TX_SBE_CNT
, 
CNTR_SYNTH
),

4269 [
C_DC_PG_STS_TX_MBE_CNT
] =

4270 
DC_PERF_CNTR_LCB
(
DcStsTxMbe
, 
DC_LCB_PG_STS_TX_MBE_CNT
,

4271 
CNTR_SYNTH
),

4272 [
C_SW_CPU_INTR
] = 
CNTR_ELEM
("IÁr", 0, 0, 
CNTR_NORMAL
,

4273 
acûss_sw_ýu_šŒ
),

4274 [
C_SW_CPU_RCV_LIM
] = 
CNTR_ELEM
("RcvLim™", 0, 0, 
CNTR_NORMAL
,

4275 
acûss_sw_ýu_rcv_lim™
),

4276 [
C_SW_CTX0_SEQ_DROP
] = 
CNTR_ELEM
("SeqDrÝ0", 0, 0, 
CNTR_NORMAL
,

4277 
acûss_sw_ùx0_£q_drÝ
),

4278 [
C_SW_VTX_WAIT
] = 
CNTR_ELEM
("vTxWa™", 0, 0, 
CNTR_NORMAL
,

4279 
acûss_sw_vtx_wa™
),

4280 [
C_SW_PIO_WAIT
] = 
CNTR_ELEM
("PioWa™", 0, 0, 
CNTR_NORMAL
,

4281 
acûss_sw_pio_wa™
),

4282 [
C_SW_PIO_DRAIN
] = 
CNTR_ELEM
("PioD¿š", 0, 0, 
CNTR_NORMAL
,

4283 
acûss_sw_pio_d¿š
),

4284 [
C_SW_KMEM_WAIT
] = 
CNTR_ELEM
("KmemWa™", 0, 0, 
CNTR_NORMAL
,

4285 
acûss_sw_kmem_wa™
),

4286 [
C_SW_TID_WAIT
] = 
CNTR_ELEM
("TidWa™", 0, 0, 
CNTR_NORMAL
,

4287 
hfi1_acûss_sw_tid_wa™
),

4288 [
C_SW_SEND_SCHED
] = 
CNTR_ELEM
("S’dSched", 0, 0, 
CNTR_NORMAL
,

4289 
acûss_sw_£nd_scheduË
),

4290 [
C_SDMA_DESC_FETCHED_CNT
] = 
CNTR_ELEM
("SDEDscFdCn",

4291 
SEND_DMA_DESC_FETCHED_CNT
, 0,

4292 
CNTR_NORMAL
 | 
CNTR_32BIT
 | 
CNTR_SDMA
,

4293 
dev_acûss_u32_c¤
),

4294 [
C_SDMA_INT_CNT
] = 
CNTR_ELEM
("SDMAInt", 0, 0,

4295 
CNTR_NORMAL
 | 
CNTR_32BIT
 | 
CNTR_SDMA
,

4296 
acûss_sde_št_út
),

4297 [
C_SDMA_ERR_CNT
] = 
CNTR_ELEM
("SDMAErrCt", 0, 0,

4298 
CNTR_NORMAL
 | 
CNTR_32BIT
 | 
CNTR_SDMA
,

4299 
acûss_sde_”r_út
),

4300 [
C_SDMA_IDLE_INT_CNT
] = 
CNTR_ELEM
("SDMAIdInt", 0, 0,

4301 
CNTR_NORMAL
 | 
CNTR_32BIT
 | 
CNTR_SDMA
,

4302 
acûss_sde_idË_št_út
),

4303 [
C_SDMA_PROGRESS_INT_CNT
] = 
CNTR_ELEM
("SDMAPrIntCn", 0, 0,

4304 
CNTR_NORMAL
 | 
CNTR_32BIT
 | 
CNTR_SDMA
,

4305 
acûss_sde_´og»ss_št_út
),

4307 [
C_MISC_PLL_LOCK_FAIL_ERR
] = 
CNTR_ELEM
("MISC_PLL_LOCK_FAIL_ERR", 0, 0,

4308 
CNTR_NORMAL
,

4309 
acûss_misc_¶l_lock_çž_”r_út
),

4310 [
C_MISC_MBIST_FAIL_ERR
] = 
CNTR_ELEM
("MISC_MBIST_FAIL_ERR", 0, 0,

4311 
CNTR_NORMAL
,

4312 
acûss_misc_mbi¡_çž_”r_út
),

4313 [
C_MISC_INVALID_EEP_CMD_ERR
] = 
CNTR_ELEM
("MISC_INVALID_EEP_CMD_ERR", 0, 0,

4314 
CNTR_NORMAL
,

4315 
acûss_misc_šv®id_“p_cmd_”r_út
),

4316 [
C_MISC_EFUSE_DONE_PARITY_ERR
] = 
CNTR_ELEM
("MISC_EFUSE_DONE_PARITY_ERR", 0, 0,

4317 
CNTR_NORMAL
,

4318 
acûss_misc_efu£_dÚe_·r™y_”r_út
),

4319 [
C_MISC_EFUSE_WRITE_ERR
] = 
CNTR_ELEM
("MISC_EFUSE_WRITE_ERR", 0, 0,

4320 
CNTR_NORMAL
,

4321 
acûss_misc_efu£_wr™e_”r_út
),

4322 [
C_MISC_EFUSE_READ_BAD_ADDR_ERR
] = 
CNTR_ELEM
("MISC_EFUSE_READ_BAD_ADDR_ERR", 0,

4323 0, 
CNTR_NORMAL
,

4324 
acûss_misc_efu£_»ad_bad_addr_”r_út
),

4325 [
C_MISC_EFUSE_CSR_PARITY_ERR
] = 
CNTR_ELEM
("MISC_EFUSE_CSR_PARITY_ERR", 0, 0,

4326 
CNTR_NORMAL
,

4327 
acûss_misc_efu£_c¤_·r™y_”r_út
),

4328 [
C_MISC_FW_AUTH_FAILED_ERR
] = 
CNTR_ELEM
("MISC_FW_AUTH_FAILED_ERR", 0, 0,

4329 
CNTR_NORMAL
,

4330 
acûss_misc_fw_auth_çžed_”r_út
),

4331 [
C_MISC_KEY_MISMATCH_ERR
] = 
CNTR_ELEM
("MISC_KEY_MISMATCH_ERR", 0, 0,

4332 
CNTR_NORMAL
,

4333 
acûss_misc_key_mism©ch_”r_út
),

4334 [
C_MISC_SBUS_WRITE_FAILED_ERR
] = 
CNTR_ELEM
("MISC_SBUS_WRITE_FAILED_ERR", 0, 0,

4335 
CNTR_NORMAL
,

4336 
acûss_misc_sbus_wr™e_çžed_”r_út
),

4337 [
C_MISC_CSR_WRITE_BAD_ADDR_ERR
] = 
CNTR_ELEM
("MISC_CSR_WRITE_BAD_ADDR_ERR", 0, 0,

4338 
CNTR_NORMAL
,

4339 
acûss_misc_c¤_wr™e_bad_addr_”r_út
),

4340 [
C_MISC_CSR_READ_BAD_ADDR_ERR
] = 
CNTR_ELEM
("MISC_CSR_READ_BAD_ADDR_ERR", 0, 0,

4341 
CNTR_NORMAL
,

4342 
acûss_misc_c¤_»ad_bad_addr_”r_út
),

4343 [
C_MISC_CSR_PARITY_ERR
] = 
CNTR_ELEM
("MISC_CSR_PARITY_ERR", 0, 0,

4344 
CNTR_NORMAL
,

4345 
acûss_misc_c¤_·r™y_”r_út
),

4347 [
C_CCE_ERR_STATUS_AGGREGATED_CNT
] = 
CNTR_ELEM
("CceErrStatusAggregatedCnt", 0, 0,

4348 
CNTR_NORMAL
,

4349 
acûss_sw_cû_”r_¡©us_agg»g©ed_út
),

4350 [
C_CCE_MSIX_CSR_PARITY_ERR
] = 
CNTR_ELEM
("CceMsixCsrParityErr", 0, 0,

4351 
CNTR_NORMAL
,

4352 
acûss_cû_msix_c¤_·r™y_”r_út
),

4353 [
C_CCE_INT_MAP_UNC_ERR
] = 
CNTR_ELEM
("CceIntMapUncErr", 0, 0,

4354 
CNTR_NORMAL
,

4355 
acûss_cû_št_m­_unc_”r_út
),

4356 [
C_CCE_INT_MAP_COR_ERR
] = 
CNTR_ELEM
("CceIntMapCorErr", 0, 0,

4357 
CNTR_NORMAL
,

4358 
acûss_cû_št_m­_cÜ_”r_út
),

4359 [
C_CCE_MSIX_TABLE_UNC_ERR
] = 
CNTR_ELEM
("CceMsixTableUncErr", 0, 0,

4360 
CNTR_NORMAL
,

4361 
acûss_cû_msix_bË_unc_”r_út
),

4362 [
C_CCE_MSIX_TABLE_COR_ERR
] = 
CNTR_ELEM
("CceMsixTableCorErr", 0, 0,

4363 
CNTR_NORMAL
,

4364 
acûss_cû_msix_bË_cÜ_”r_út
),

4365 [
C_CCE_RXDMA_CONV_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("CceRxdmaConvFifoParityErr", 0,

4366 0, 
CNTR_NORMAL
,

4367 
acûss_cû_rxdma_cÚv_fifo_·r™y_”r_út
),

4368 [
C_CCE_RCPL_ASYNC_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("CceRcplAsyncFifoParityErr", 0,

4369 0, 
CNTR_NORMAL
,

4370 
acûss_cû_rýl_async_fifo_·r™y_”r_út
),

4371 [
C_CCE_SEG_WRITE_BAD_ADDR_ERR
] = 
CNTR_ELEM
("CceSegWriteBadAddrErr", 0, 0,

4372 
CNTR_NORMAL
,

4373 
acûss_cû_£g_wr™e_bad_addr_”r_út
),

4374 [
C_CCE_SEG_READ_BAD_ADDR_ERR
] = 
CNTR_ELEM
("CceSegReadBadAddrErr", 0, 0,

4375 
CNTR_NORMAL
,

4376 
acûss_cû_£g_»ad_bad_addr_”r_út
),

4377 [
C_LA_TRIGGERED
] = 
CNTR_ELEM
("Cce LATriggered", 0, 0,

4378 
CNTR_NORMAL
,

4379 
acûss_Ï_Œigg”ed_út
),

4380 [
C_CCE_TRGT_CPL_TIMEOUT_ERR
] = 
CNTR_ELEM
("CceTrgtCplTimeoutErr", 0, 0,

4381 
CNTR_NORMAL
,

4382 
acûss_cû_Œgt_ýl_timeout_”r_út
),

4383 [
C_PCIC_RECEIVE_PARITY_ERR
] = 
CNTR_ELEM
("PcicReceiveParityErr", 0, 0,

4384 
CNTR_NORMAL
,

4385 
acûss_pcic_»ûive_·r™y_”r_út
),

4386 [
C_PCIC_TRANSMIT_BACK_PARITY_ERR
] = 
CNTR_ELEM
("PcicTransmitBackParityErr", 0, 0,

4387 
CNTR_NORMAL
,

4388 
acûss_pcic_Œªsm™_back_·r™y_”r_út
),

4389 [
C_PCIC_TRANSMIT_FRONT_PARITY_ERR
] = 
CNTR_ELEM
("PcicTransmitFrontParityErr", 0,

4390 0, 
CNTR_NORMAL
,

4391 
acûss_pcic_Œªsm™_äÚt_·r™y_”r_út
),

4392 [
C_PCIC_CPL_DAT_Q_UNC_ERR
] = 
CNTR_ELEM
("PcicCplDatQUncErr", 0, 0,

4393 
CNTR_NORMAL
,

4394 
acûss_pcic_ýl_d©_q_unc_”r_út
),

4395 [
C_PCIC_CPL_HD_Q_UNC_ERR
] = 
CNTR_ELEM
("PcicCplHdQUncErr", 0, 0,

4396 
CNTR_NORMAL
,

4397 
acûss_pcic_ýl_hd_q_unc_”r_út
),

4398 [
C_PCIC_POST_DAT_Q_UNC_ERR
] = 
CNTR_ELEM
("PcicPostDatQUncErr", 0, 0,

4399 
CNTR_NORMAL
,

4400 
acûss_pcic_po¡_d©_q_unc_”r_út
),

4401 [
C_PCIC_POST_HD_Q_UNC_ERR
] = 
CNTR_ELEM
("PcicPostHdQUncErr", 0, 0,

4402 
CNTR_NORMAL
,

4403 
acûss_pcic_po¡_hd_q_unc_”r_út
),

4404 [
C_PCIC_RETRY_SOT_MEM_UNC_ERR
] = 
CNTR_ELEM
("PcicRetrySotMemUncErr", 0, 0,

4405 
CNTR_NORMAL
,

4406 
acûss_pcic_»Œy_sÙ_mem_unc_”r_út
),

4407 [
C_PCIC_RETRY_MEM_UNC_ERR
] = 
CNTR_ELEM
("PcicRetryMemUncErr", 0, 0,

4408 
CNTR_NORMAL
,

4409 
acûss_pcic_»Œy_mem_unc_”r
),

4410 [
C_PCIC_N_POST_DAT_Q_PARITY_ERR
] = 
CNTR_ELEM
("PcicNPostDatQParityErr", 0, 0,

4411 
CNTR_NORMAL
,

4412 
acûss_pcic_n_po¡_d©_q_·r™y_”r_út
),

4413 [
C_PCIC_N_POST_H_Q_PARITY_ERR
] = 
CNTR_ELEM
("PcicNPostHQParityErr", 0, 0,

4414 
CNTR_NORMAL
,

4415 
acûss_pcic_n_po¡_h_q_·r™y_”r_út
),

4416 [
C_PCIC_CPL_DAT_Q_COR_ERR
] = 
CNTR_ELEM
("PcicCplDatQCorErr", 0, 0,

4417 
CNTR_NORMAL
,

4418 
acûss_pcic_ýl_d©_q_cÜ_”r_út
),

4419 [
C_PCIC_CPL_HD_Q_COR_ERR
] = 
CNTR_ELEM
("PcicCplHdQCorErr", 0, 0,

4420 
CNTR_NORMAL
,

4421 
acûss_pcic_ýl_hd_q_cÜ_”r_út
),

4422 [
C_PCIC_POST_DAT_Q_COR_ERR
] = 
CNTR_ELEM
("PcicPostDatQCorErr", 0, 0,

4423 
CNTR_NORMAL
,

4424 
acûss_pcic_po¡_d©_q_cÜ_”r_út
),

4425 [
C_PCIC_POST_HD_Q_COR_ERR
] = 
CNTR_ELEM
("PcicPostHdQCorErr", 0, 0,

4426 
CNTR_NORMAL
,

4427 
acûss_pcic_po¡_hd_q_cÜ_”r_út
),

4428 [
C_PCIC_RETRY_SOT_MEM_COR_ERR
] = 
CNTR_ELEM
("PcicRetrySotMemCorErr", 0, 0,

4429 
CNTR_NORMAL
,

4430 
acûss_pcic_»Œy_sÙ_mem_cÜ_”r_út
),

4431 [
C_PCIC_RETRY_MEM_COR_ERR
] = 
CNTR_ELEM
("PcicRetryMemCorErr", 0, 0,

4432 
CNTR_NORMAL
,

4433 
acûss_pcic_»Œy_mem_cÜ_”r_út
),

4434 [
C_CCE_CLI1_ASYNC_FIFO_DBG_PARITY_ERR
] = 
CNTR_ELEM
(

4436 
CNTR_NORMAL
,

4437 
acûss_cû_þi1_async_fifo_dbg_·r™y_”r_út
),

4438 [
C_CCE_CLI1_ASYNC_FIFO_RXDMA_PARITY_ERR
] = 
CNTR_ELEM
(

4440 
CNTR_NORMAL
,

4441 
acûss_cû_þi1_async_fifo_rxdma_·r™y_”r_út


4443 [
C_CCE_CLI1_ASYNC_FIFO_SDMA_HD_PARITY_ERR
] = 
CNTR_ELEM
(

4445 
CNTR_NORMAL
,

4446 
acûss_cû_þi1_async_fifo_sdma_hd_·r™y_”r_út
),

4447 [
C_CCE_CLI1_ASYNC_FIFO_PIO_CRDT_PARITY_ERR
] = 
CNTR_ELEM
(

4449 
CNTR_NORMAL
,

4450 
acûss_cû_þ1_async_fifo_pio_üdt_·r™y_”r_út
),

4451 [
C_CCE_CLI2_ASYNC_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("CceCli2AsyncFifoParityErr", 0,

4452 0, 
CNTR_NORMAL
,

4453 
acûss_cû_þi2_async_fifo_·r™y_”r_út
),

4454 [
C_CCE_CSR_CFG_BUS_PARITY_ERR
] = 
CNTR_ELEM
("CceCsrCfgBusParityErr", 0, 0,

4455 
CNTR_NORMAL
,

4456 
acûss_cû_c¤_cfg_bus_·r™y_”r_út
),

4457 [
C_CCE_CLI0_ASYNC_FIFO_PARTIY_ERR
] = 
CNTR_ELEM
("CceCli0AsyncFifoParityErr", 0,

4458 0, 
CNTR_NORMAL
,

4459 
acûss_cû_þi0_async_fifo_·r™y_”r_út
),

4460 [
C_CCE_RSPD_DATA_PARITY_ERR
] = 
CNTR_ELEM
("CceRspdDataParityErr", 0, 0,

4461 
CNTR_NORMAL
,

4462 
acûss_cû_r¥d_d©a_·r™y_”r_út
),

4463 [
C_CCE_TRGT_ACCESS_ERR
] = 
CNTR_ELEM
("CceTrgtAccessErr", 0, 0,

4464 
CNTR_NORMAL
,

4465 
acûss_cû_Œgt_acûss_”r_út
),

4466 [
C_CCE_TRGT_ASYNC_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("CceTrgtAsyncFifoParityErr", 0,

4467 0, 
CNTR_NORMAL
,

4468 
acûss_cû_Œgt_async_fifo_·r™y_”r_út
),

4469 [
C_CCE_CSR_WRITE_BAD_ADDR_ERR
] = 
CNTR_ELEM
("CceCsrWriteBadAddrErr", 0, 0,

4470 
CNTR_NORMAL
,

4471 
acûss_cû_c¤_wr™e_bad_addr_”r_út
),

4472 [
C_CCE_CSR_READ_BAD_ADDR_ERR
] = 
CNTR_ELEM
("CceCsrReadBadAddrErr", 0, 0,

4473 
CNTR_NORMAL
,

4474 
acûss_cû_c¤_»ad_bad_addr_”r_út
),

4475 [
C_CCE_CSR_PARITY_ERR
] = 
CNTR_ELEM
("CceCsrParityErr", 0, 0,

4476 
CNTR_NORMAL
,

4477 
acûss_ccs_c¤_·r™y_”r_út
),

4480 [
C_RX_CSR_PARITY_ERR
] = 
CNTR_ELEM
("RxCsrParityErr", 0, 0,

4481 
CNTR_NORMAL
,

4482 
acûss_rx_c¤_·r™y_”r_út
),

4483 [
C_RX_CSR_WRITE_BAD_ADDR_ERR
] = 
CNTR_ELEM
("RxCsrWriteBadAddrErr", 0, 0,

4484 
CNTR_NORMAL
,

4485 
acûss_rx_c¤_wr™e_bad_addr_”r_út
),

4486 [
C_RX_CSR_READ_BAD_ADDR_ERR
] = 
CNTR_ELEM
("RxCsrReadBadAddrErr", 0, 0,

4487 
CNTR_NORMAL
,

4488 
acûss_rx_c¤_»ad_bad_addr_”r_út
),

4489 [
C_RX_DMA_CSR_UNC_ERR
] = 
CNTR_ELEM
("RxDmaCsrUncErr", 0, 0,

4490 
CNTR_NORMAL
,

4491 
acûss_rx_dma_c¤_unc_”r_út
),

4492 [
C_RX_DMA_DQ_FSM_ENCODING_ERR
] = 
CNTR_ELEM
("RxDmaDqFsmEncodingErr", 0, 0,

4493 
CNTR_NORMAL
,

4494 
acûss_rx_dma_dq_fsm_’codšg_”r_út
),

4495 [
C_RX_DMA_EQ_FSM_ENCODING_ERR
] = 
CNTR_ELEM
("RxDmaEqFsmEncodingErr", 0, 0,

4496 
CNTR_NORMAL
,

4497 
acûss_rx_dma_eq_fsm_’codšg_”r_út
),

4498 [
C_RX_DMA_CSR_PARITY_ERR
] = 
CNTR_ELEM
("RxDmaCsrParityErr", 0, 0,

4499 
CNTR_NORMAL
,

4500 
acûss_rx_dma_c¤_·r™y_”r_út
),

4501 [
C_RX_RBUF_DATA_COR_ERR
] = 
CNTR_ELEM
("RxRbufDataCorErr", 0, 0,

4502 
CNTR_NORMAL
,

4503 
acûss_rx_rbuf_d©a_cÜ_”r_út
),

4504 [
C_RX_RBUF_DATA_UNC_ERR
] = 
CNTR_ELEM
("RxRbufDataUncErr", 0, 0,

4505 
CNTR_NORMAL
,

4506 
acûss_rx_rbuf_d©a_unc_”r_út
),

4507 [
C_RX_DMA_DATA_FIFO_RD_COR_ERR
] = 
CNTR_ELEM
("RxDmaDataFifoRdCorErr", 0, 0,

4508 
CNTR_NORMAL
,

4509 
acûss_rx_dma_d©a_fifo_rd_cÜ_”r_út
),

4510 [
C_RX_DMA_DATA_FIFO_RD_UNC_ERR
] = 
CNTR_ELEM
("RxDmaDataFifoRdUncErr", 0, 0,

4511 
CNTR_NORMAL
,

4512 
acûss_rx_dma_d©a_fifo_rd_unc_”r_út
),

4513 [
C_RX_DMA_HDR_FIFO_RD_COR_ERR
] = 
CNTR_ELEM
("RxDmaHdrFifoRdCorErr", 0, 0,

4514 
CNTR_NORMAL
,

4515 
acûss_rx_dma_hdr_fifo_rd_cÜ_”r_út
),

4516 [
C_RX_DMA_HDR_FIFO_RD_UNC_ERR
] = 
CNTR_ELEM
("RxDmaHdrFifoRdUncErr", 0, 0,

4517 
CNTR_NORMAL
,

4518 
acûss_rx_dma_hdr_fifo_rd_unc_”r_út
),

4519 [
C_RX_RBUF_DESC_PART2_COR_ERR
] = 
CNTR_ELEM
("RxRbufDescPart2CorErr", 0, 0,

4520 
CNTR_NORMAL
,

4521 
acûss_rx_rbuf_desc_·¹2_cÜ_”r_út
),

4522 [
C_RX_RBUF_DESC_PART2_UNC_ERR
] = 
CNTR_ELEM
("RxRbufDescPart2UncErr", 0, 0,

4523 
CNTR_NORMAL
,

4524 
acûss_rx_rbuf_desc_·¹2_unc_”r_út
),

4525 [
C_RX_RBUF_DESC_PART1_COR_ERR
] = 
CNTR_ELEM
("RxRbufDescPart1CorErr", 0, 0,

4526 
CNTR_NORMAL
,

4527 
acûss_rx_rbuf_desc_·¹1_cÜ_”r_út
),

4528 [
C_RX_RBUF_DESC_PART1_UNC_ERR
] = 
CNTR_ELEM
("RxRbufDescPart1UncErr", 0, 0,

4529 
CNTR_NORMAL
,

4530 
acûss_rx_rbuf_desc_·¹1_unc_”r_út
),

4531 [
C_RX_HQ_INTR_FSM_ERR
] = 
CNTR_ELEM
("RxHqIntrFsmErr", 0, 0,

4532 
CNTR_NORMAL
,

4533 
acûss_rx_hq_šŒ_fsm_”r_út
),

4534 [
C_RX_HQ_INTR_CSR_PARITY_ERR
] = 
CNTR_ELEM
("RxHqIntrCsrParityErr", 0, 0,

4535 
CNTR_NORMAL
,

4536 
acûss_rx_hq_šŒ_c¤_·r™y_”r_út
),

4537 [
C_RX_LOOKUP_CSR_PARITY_ERR
] = 
CNTR_ELEM
("RxLookupCsrParityErr", 0, 0,

4538 
CNTR_NORMAL
,

4539 
acûss_rx_lookup_c¤_·r™y_”r_út
),

4540 [
C_RX_LOOKUP_RCV_ARRAY_COR_ERR
] = 
CNTR_ELEM
("RxLookupRcvArrayCorErr", 0, 0,

4541 
CNTR_NORMAL
,

4542 
acûss_rx_lookup_rcv_¬¿y_cÜ_”r_út
),

4543 [
C_RX_LOOKUP_RCV_ARRAY_UNC_ERR
] = 
CNTR_ELEM
("RxLookupRcvArrayUncErr", 0, 0,

4544 
CNTR_NORMAL
,

4545 
acûss_rx_lookup_rcv_¬¿y_unc_”r_út
),

4546 [
C_RX_LOOKUP_DES_PART2_PARITY_ERR
] = 
CNTR_ELEM
("RxLookupDesPart2ParityErr", 0,

4547 0, 
CNTR_NORMAL
,

4548 
acûss_rx_lookup_des_·¹2_·r™y_”r_út
),

4549 [
C_RX_LOOKUP_DES_PART1_UNC_COR_ERR
] = 
CNTR_ELEM
("RxLookupDesPart1UncCorErr", 0,

4550 0, 
CNTR_NORMAL
,

4551 
acûss_rx_lookup_des_·¹1_unc_cÜ_”r_út
),

4552 [
C_RX_LOOKUP_DES_PART1_UNC_ERR
] = 
CNTR_ELEM
("RxLookupDesPart1UncErr", 0, 0,

4553 
CNTR_NORMAL
,

4554 
acûss_rx_lookup_des_·¹1_unc_”r_út
),

4555 [
C_RX_RBUF_NEXT_FREE_BUF_COR_ERR
] = 
CNTR_ELEM
("RxRbufNextFreeBufCorErr", 0, 0,

4556 
CNTR_NORMAL
,

4557 
acûss_rx_rbuf_Ãxt_ä“_buf_cÜ_”r_út
),

4558 [
C_RX_RBUF_NEXT_FREE_BUF_UNC_ERR
] = 
CNTR_ELEM
("RxRbufNextFreeBufUncErr", 0, 0,

4559 
CNTR_NORMAL
,

4560 
acûss_rx_rbuf_Ãxt_ä“_buf_unc_”r_út
),

4561 [
C_RX_RBUF_FL_INIT_WR_ADDR_PARITY_ERR
] = 
CNTR_ELEM
(

4563 
CNTR_NORMAL
,

4564 
acûss_rbuf_æ_š™_wr_addr_·r™y_”r_út
),

4565 [
C_RX_RBUF_FL_INITDONE_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufFlInitdoneParityErr", 0,

4566 0, 
CNTR_NORMAL
,

4567 
acûss_rx_rbuf_æ_š™dÚe_·r™y_”r_út
),

4568 [
C_RX_RBUF_FL_WRITE_ADDR_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufFlWrAddrParityErr", 0,

4569 0, 
CNTR_NORMAL
,

4570 
acûss_rx_rbuf_æ_wr™e_addr_·r™y_”r_út
),

4571 [
C_RX_RBUF_FL_RD_ADDR_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufFlRdAddrParityErr", 0, 0,

4572 
CNTR_NORMAL
,

4573 
acûss_rx_rbuf_æ_rd_addr_·r™y_”r_út
),

4574 [
C_RX_RBUF_EMPTY_ERR
] = 
CNTR_ELEM
("RxRbufEmptyErr", 0, 0,

4575 
CNTR_NORMAL
,

4576 
acûss_rx_rbuf_em±y_”r_út
),

4577 [
C_RX_RBUF_FULL_ERR
] = 
CNTR_ELEM
("RxRbufFullErr", 0, 0,

4578 
CNTR_NORMAL
,

4579 
acûss_rx_rbuf_fuÎ_”r_út
),

4580 [
C_RX_RBUF_BAD_LOOKUP_ERR
] = 
CNTR_ELEM
("RxRBufBadLookupErr", 0, 0,

4581 
CNTR_NORMAL
,

4582 
acûss_rbuf_bad_lookup_”r_út
),

4583 [
C_RX_RBUF_CTX_ID_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCtxIdParityErr", 0, 0,

4584 
CNTR_NORMAL
,

4585 
acûss_rbuf_ùx_id_·r™y_”r_út
),

4586 [
C_RX_RBUF_CSR_QEOPDW_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCsrQEOPDWParityErr", 0, 0,

4587 
CNTR_NORMAL
,

4588 
acûss_rbuf_c¤_qeÝdw_·r™y_”r_út
),

4589 [
C_RX_RBUF_CSR_Q_NUM_OF_PKT_PARITY_ERR
] = 
CNTR_ELEM
(

4591 
CNTR_NORMAL
,

4592 
acûss_rx_rbuf_c¤_q_num_of_pkt_·r™y_”r_út
),

4593 [
C_RX_RBUF_CSR_Q_T1_PTR_PARITY_ERR
] = 
CNTR_ELEM
(

4595 
CNTR_NORMAL
,

4596 
acûss_rx_rbuf_c¤_q_t1_±r_·r™y_”r_út
),

4597 [
C_RX_RBUF_CSR_Q_HD_PTR_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCsrQHdPtrParityErr", 0,

4598 0, 
CNTR_NORMAL
,

4599 
acûss_rx_rbuf_c¤_q_hd_±r_·r™y_”r_út
),

4600 [
C_RX_RBUF_CSR_Q_VLD_BIT_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCsrQVldBitParityErr", 0,

4601 0, 
CNTR_NORMAL
,

4602 
acûss_rx_rbuf_c¤_q_vld_b™_·r™y_”r_út
),

4603 [
C_RX_RBUF_CSR_Q_NEXT_BUF_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCsrQNextBufParityErr",

4604 0, 0, 
CNTR_NORMAL
,

4605 
acûss_rx_rbuf_c¤_q_Ãxt_buf_·r™y_”r_út
),

4606 [
C_RX_RBUF_CSR_Q_ENT_CNT_PARITY_ERR
] = 
CNTR_ELEM
("RxRbufCsrQEntCntParityErr", 0,

4607 0, 
CNTR_NORMAL
,

4608 
acûss_rx_rbuf_c¤_q_’t_út_·r™y_”r_út
),

4609 [
C_RX_RBUF_CSR_Q_HEAD_BUF_NUM_PARITY_ERR
] = 
CNTR_ELEM
(

4611 
CNTR_NORMAL
,

4612 
acûss_rx_rbuf_c¤_q_h—d_buf_num_·r™y_”r_út
),

4613 [
C_RX_RBUF_BLOCK_LIST_READ_COR_ERR
] = 
CNTR_ELEM
("RxRbufBlockListReadCorErr", 0,

4614 0, 
CNTR_NORMAL
,

4615 
acûss_rx_rbuf_block_li¡_»ad_cÜ_”r_út
),

4616 [
C_RX_RBUF_BLOCK_LIST_READ_UNC_ERR
] = 
CNTR_ELEM
("RxRbufBlockListReadUncErr", 0,

4617 0, 
CNTR_NORMAL
,

4618 
acûss_rx_rbuf_block_li¡_»ad_unc_”r_út
),

4619 [
C_RX_RBUF_LOOKUP_DES_COR_ERR
] = 
CNTR_ELEM
("RxRbufLookupDesCorErr", 0, 0,

4620 
CNTR_NORMAL
,

4621 
acûss_rx_rbuf_lookup_des_cÜ_”r_út
),

4622 [
C_RX_RBUF_LOOKUP_DES_UNC_ERR
] = 
CNTR_ELEM
("RxRbufLookupDesUncErr", 0, 0,

4623 
CNTR_NORMAL
,

4624 
acûss_rx_rbuf_lookup_des_unc_”r_út
),

4625 [
C_RX_RBUF_LOOKUP_DES_REG_UNC_COR_ERR
] = 
CNTR_ELEM
(

4627 
CNTR_NORMAL
,

4628 
acûss_rx_rbuf_lookup_des_»g_unc_cÜ_”r_út
),

4629 [
C_RX_RBUF_LOOKUP_DES_REG_UNC_ERR
] = 
CNTR_ELEM
("RxRbufLookupDesRegUncErr", 0, 0,

4630 
CNTR_NORMAL
,

4631 
acûss_rx_rbuf_lookup_des_»g_unc_”r_út
),

4632 [
C_RX_RBUF_FREE_LIST_COR_ERR
] = 
CNTR_ELEM
("RxRbufFreeListCorErr", 0, 0,

4633 
CNTR_NORMAL
,

4634 
acûss_rx_rbuf_ä“_li¡_cÜ_”r_út
),

4635 [
C_RX_RBUF_FREE_LIST_UNC_ERR
] = 
CNTR_ELEM
("RxRbufFreeListUncErr", 0, 0,

4636 
CNTR_NORMAL
,

4637 
acûss_rx_rbuf_ä“_li¡_unc_”r_út
),

4638 [
C_RX_RCV_FSM_ENCODING_ERR
] = 
CNTR_ELEM
("RxRcvFsmEncodingErr", 0, 0,

4639 
CNTR_NORMAL
,

4640 
acûss_rx_rcv_fsm_’codšg_”r_út
),

4641 [
C_RX_DMA_FLAG_COR_ERR
] = 
CNTR_ELEM
("RxDmaFlagCorErr", 0, 0,

4642 
CNTR_NORMAL
,

4643 
acûss_rx_dma_æag_cÜ_”r_út
),

4644 [
C_RX_DMA_FLAG_UNC_ERR
] = 
CNTR_ELEM
("RxDmaFlagUncErr", 0, 0,

4645 
CNTR_NORMAL
,

4646 
acûss_rx_dma_æag_unc_”r_út
),

4647 [
C_RX_DC_SOP_EOP_PARITY_ERR
] = 
CNTR_ELEM
("RxDcSopEopParityErr", 0, 0,

4648 
CNTR_NORMAL
,

4649 
acûss_rx_dc_sÝ_eÝ_·r™y_”r_út
),

4650 [
C_RX_RCV_CSR_PARITY_ERR
] = 
CNTR_ELEM
("RxRcvCsrParityErr", 0, 0,

4651 
CNTR_NORMAL
,

4652 
acûss_rx_rcv_c¤_·r™y_”r_út
),

4653 [
C_RX_RCV_QP_MAP_TABLE_COR_ERR
] = 
CNTR_ELEM
("RxRcvQpMapTableCorErr", 0, 0,

4654 
CNTR_NORMAL
,

4655 
acûss_rx_rcv_qp_m­_bË_cÜ_”r_út
),

4656 [
C_RX_RCV_QP_MAP_TABLE_UNC_ERR
] = 
CNTR_ELEM
("RxRcvQpMapTableUncErr", 0, 0,

4657 
CNTR_NORMAL
,

4658 
acûss_rx_rcv_qp_m­_bË_unc_”r_út
),

4659 [
C_RX_RCV_DATA_COR_ERR
] = 
CNTR_ELEM
("RxRcvDataCorErr", 0, 0,

4660 
CNTR_NORMAL
,

4661 
acûss_rx_rcv_d©a_cÜ_”r_út
),

4662 [
C_RX_RCV_DATA_UNC_ERR
] = 
CNTR_ELEM
("RxRcvDataUncErr", 0, 0,

4663 
CNTR_NORMAL
,

4664 
acûss_rx_rcv_d©a_unc_”r_út
),

4665 [
C_RX_RCV_HDR_COR_ERR
] = 
CNTR_ELEM
("RxRcvHdrCorErr", 0, 0,

4666 
CNTR_NORMAL
,

4667 
acûss_rx_rcv_hdr_cÜ_”r_út
),

4668 [
C_RX_RCV_HDR_UNC_ERR
] = 
CNTR_ELEM
("RxRcvHdrUncErr", 0, 0,

4669 
CNTR_NORMAL
,

4670 
acûss_rx_rcv_hdr_unc_”r_út
),

4671 [
C_RX_DC_INTF_PARITY_ERR
] = 
CNTR_ELEM
("RxDcIntfParityErr", 0, 0,

4672 
CNTR_NORMAL
,

4673 
acûss_rx_dc_štf_·r™y_”r_út
),

4674 [
C_RX_DMA_CSR_COR_ERR
] = 
CNTR_ELEM
("RxDmaCsrCorErr", 0, 0,

4675 
CNTR_NORMAL
,

4676 
acûss_rx_dma_c¤_cÜ_”r_út
),

4678 [
C_PIO_PEC_SOP_HEAD_PARITY_ERR
] = 
CNTR_ELEM
("PioPecSopHeadParityErr", 0, 0,

4679 
CNTR_NORMAL
,

4680 
acûss_pio_³c_sÝ_h—d_·r™y_”r_út
),

4681 [
C_PIO_PCC_SOP_HEAD_PARITY_ERR
] = 
CNTR_ELEM
("PioPccSopHeadParityErr", 0, 0,

4682 
CNTR_NORMAL
,

4683 
acûss_pio_pcc_sÝ_h—d_·r™y_”r_út
),

4684 [
C_PIO_LAST_RETURNED_CNT_PARITY_ERR
] = 
CNTR_ELEM
("PioLastReturnedCntParityErr",

4685 0, 0, 
CNTR_NORMAL
,

4686 
acûss_pio_Ï¡_»tuºed_út_·r™y_”r_út
),

4687 [
C_PIO_CURRENT_FREE_CNT_PARITY_ERR
] = 
CNTR_ELEM
("PioCurrentFreeCntParityErr", 0,

4688 0, 
CNTR_NORMAL
,

4689 
acûss_pio_cu¼’t_ä“_út_·r™y_”r_út
),

4690 [
C_PIO_RSVD_31_ERR
] = 
CNTR_ELEM
("Pio Reserved 31", 0, 0,

4691 
CNTR_NORMAL
,

4692 
acûss_pio_»£rved_31_”r_út
),

4693 [
C_PIO_RSVD_30_ERR
] = 
CNTR_ELEM
("Pio Reserved 30", 0, 0,

4694 
CNTR_NORMAL
,

4695 
acûss_pio_»£rved_30_”r_út
),

4696 [
C_PIO_PPMC_SOP_LEN_ERR
] = 
CNTR_ELEM
("PioPpmcSopLenErr", 0, 0,

4697 
CNTR_NORMAL
,

4698 
acûss_pio_µmc_sÝ_Ën_”r_út
),

4699 [
C_PIO_PPMC_BQC_MEM_PARITY_ERR
] = 
CNTR_ELEM
("PioPpmcBqcMemParityErr", 0, 0,

4700 
CNTR_NORMAL
,

4701 
acûss_pio_µmc_bqc_mem_·r™y_”r_út
),

4702 [
C_PIO_VL_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("PioVlFifoParityErr", 0, 0,

4703 
CNTR_NORMAL
,

4704 
acûss_pio_vl_fifo_·r™y_”r_út
),

4705 [
C_PIO_VLF_SOP_PARITY_ERR
] = 
CNTR_ELEM
("PioVlfSopParityErr", 0, 0,

4706 
CNTR_NORMAL
,

4707 
acûss_pio_vlf_sÝ_·r™y_”r_út
),

4708 [
C_PIO_VLF_V1_LEN_PARITY_ERR
] = 
CNTR_ELEM
("PioVlfVlLenParityErr", 0, 0,

4709 
CNTR_NORMAL
,

4710 
acûss_pio_vlf_v1_Ën_·r™y_”r_út
),

4711 [
C_PIO_BLOCK_QW_COUNT_PARITY_ERR
] = 
CNTR_ELEM
("PioBlockQwCountParityErr", 0, 0,

4712 
CNTR_NORMAL
,

4713 
acûss_pio_block_qw_couÁ_·r™y_”r_út
),

4714 [
C_PIO_WRITE_QW_VALID_PARITY_ERR
] = 
CNTR_ELEM
("PioWriteQwValidParityErr", 0, 0,

4715 
CNTR_NORMAL
,

4716 
acûss_pio_wr™e_qw_v®id_·r™y_”r_út
),

4717 [
C_PIO_STATE_MACHINE_ERR
] = 
CNTR_ELEM
("PioStateMachineErr", 0, 0,

4718 
CNTR_NORMAL
,

4719 
acûss_pio_¡©e_machše_”r_út
),

4720 [
C_PIO_WRITE_DATA_PARITY_ERR
] = 
CNTR_ELEM
("PioWriteDataParityErr", 0, 0,

4721 
CNTR_NORMAL
,

4722 
acûss_pio_wr™e_d©a_·r™y_”r_út
),

4723 [
C_PIO_HOST_ADDR_MEM_COR_ERR
] = 
CNTR_ELEM
("PioHostAddrMemCorErr", 0, 0,

4724 
CNTR_NORMAL
,

4725 
acûss_pio_ho¡_addr_mem_cÜ_”r_út
),

4726 [
C_PIO_HOST_ADDR_MEM_UNC_ERR
] = 
CNTR_ELEM
("PioHostAddrMemUncErr", 0, 0,

4727 
CNTR_NORMAL
,

4728 
acûss_pio_ho¡_addr_mem_unc_”r_út
),

4729 [
C_PIO_PKT_EVICT_SM_OR_ARM_SM_ERR
] = 
CNTR_ELEM
("PioPktEvictSmOrArbSmErr", 0, 0,

4730 
CNTR_NORMAL
,

4731 
acûss_pio_pkt_eviù_sm_Ü_¬b_sm_”r_út
),

4732 [
C_PIO_INIT_SM_IN_ERR
] = 
CNTR_ELEM
("PioInitSmInErr", 0, 0,

4733 
CNTR_NORMAL
,

4734 
acûss_pio_š™_sm_š_”r_út
),

4735 [
C_PIO_PPMC_PBL_FIFO_ERR
] = 
CNTR_ELEM
("PioPpmcPblFifoErr", 0, 0,

4736 
CNTR_NORMAL
,

4737 
acûss_pio_µmc_pbl_fifo_”r_út
),

4738 [
C_PIO_CREDIT_RET_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("PioCreditRetFifoParityErr", 0,

4739 0, 
CNTR_NORMAL
,

4740 
acûss_pio_üed™_»t_fifo_·r™y_”r_út
),

4741 [
C_PIO_V1_LEN_MEM_BANK1_COR_ERR
] = 
CNTR_ELEM
("PioVlLenMemBank1CorErr", 0, 0,

4742 
CNTR_NORMAL
,

4743 
acûss_pio_v1_Ën_mem_bªk1_cÜ_”r_út
),

4744 [
C_PIO_V1_LEN_MEM_BANK0_COR_ERR
] = 
CNTR_ELEM
("PioVlLenMemBank0CorErr", 0, 0,

4745 
CNTR_NORMAL
,

4746 
acûss_pio_v1_Ën_mem_bªk0_cÜ_”r_út
),

4747 [
C_PIO_V1_LEN_MEM_BANK1_UNC_ERR
] = 
CNTR_ELEM
("PioVlLenMemBank1UncErr", 0, 0,

4748 
CNTR_NORMAL
,

4749 
acûss_pio_v1_Ën_mem_bªk1_unc_”r_út
),

4750 [
C_PIO_V1_LEN_MEM_BANK0_UNC_ERR
] = 
CNTR_ELEM
("PioVlLenMemBank0UncErr", 0, 0,

4751 
CNTR_NORMAL
,

4752 
acûss_pio_v1_Ën_mem_bªk0_unc_”r_út
),

4753 [
C_PIO_SM_PKT_RESET_PARITY_ERR
] = 
CNTR_ELEM
("PioSmPktResetParityErr", 0, 0,

4754 
CNTR_NORMAL
,

4755 
acûss_pio_sm_pkt_»£t_·r™y_”r_út
),

4756 [
C_PIO_PKT_EVICT_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("PioPktEvictFifoParityErr", 0, 0,

4757 
CNTR_NORMAL
,

4758 
acûss_pio_pkt_eviù_fifo_·r™y_”r_út
),

4759 [
C_PIO_SBRDCTRL_CRREL_FIFO_PARITY_ERR
] = 
CNTR_ELEM
(

4761 
CNTR_NORMAL
,

4762 
acûss_pio_sbrdù¾_ü»l_fifo_·r™y_”r_út
),

4763 [
C_PIO_SBRDCTL_CRREL_PARITY_ERR
] = 
CNTR_ELEM
("PioSbrdctlCrrelParityErr", 0, 0,

4764 
CNTR_NORMAL
,

4765 
acûss_pio_sbrdùl_ü»l_·r™y_”r_út
),

4766 [
C_PIO_PEC_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("PioPecFifoParityErr", 0, 0,

4767 
CNTR_NORMAL
,

4768 
acûss_pio_³c_fifo_·r™y_”r_út
),

4769 [
C_PIO_PCC_FIFO_PARITY_ERR
] = 
CNTR_ELEM
("PioPccFifoParityErr", 0, 0,

4770 
CNTR_NORMAL
,

4771 
acûss_pio_pcc_fifo_·r™y_”r_út
),

4772 [
C_PIO_SB_MEM_FIFO1_ERR
] = 
CNTR_ELEM
("PioSbMemFifo1Err", 0, 0,

4773 
CNTR_NORMAL
,

4774 
acûss_pio_sb_mem_fifo1_”r_út
),

4775 [
C_PIO_SB_MEM_FIFO0_ERR
] = 
CNTR_ELEM
("PioSbMemFifo0Err", 0, 0,

4776 
CNTR_NORMAL
,

4777 
acûss_pio_sb_mem_fifo0_”r_út
),

4778 [
C_PIO_CSR_PARITY_ERR
] = 
CNTR_ELEM
("PioCsrParityErr", 0, 0,

4779 
CNTR_NORMAL
,

4780 
acûss_pio_c¤_·r™y_”r_út
),

4781 [
C_PIO_WRITE_ADDR_PARITY_ERR
] = 
CNTR_ELEM
("PioWriteAddrParityErr", 0, 0,

4782 
CNTR_NORMAL
,

4783 
acûss_pio_wr™e_addr_·r™y_”r_út
),

4784 [
C_PIO_WRITE_BAD_CTXT_ERR
] = 
CNTR_ELEM
("PioWriteBadCtxtErr", 0, 0,

4785 
CNTR_NORMAL
,

4786 
acûss_pio_wr™e_bad_ùxt_”r_út
),

4788 [
C_SDMA_PCIE_REQ_TRACKING_COR_ERR
] = 
CNTR_ELEM
("SDmaPcieReqTrackingCorErr", 0,

4789 0, 
CNTR_NORMAL
,

4790 
acûss_sdma_pc›_»q_Œackšg_cÜ_”r_út
),

4791 [
C_SDMA_PCIE_REQ_TRACKING_UNC_ERR
] = 
CNTR_ELEM
("SDmaPcieReqTrackingUncErr", 0,

4792 0, 
CNTR_NORMAL
,

4793 
acûss_sdma_pc›_»q_Œackšg_unc_”r_út
),

4794 [
C_SDMA_CSR_PARITY_ERR
] = 
CNTR_ELEM
("SDmaCsrParityErr", 0, 0,

4795 
CNTR_NORMAL
,

4796 
acûss_sdma_c¤_·r™y_”r_út
),

4797 [
C_SDMA_RPY_TAG_ERR
] = 
CNTR_ELEM
("SDmaRpyTagErr", 0, 0,

4798 
CNTR_NORMAL
,

4799 
acûss_sdma_½y_g_”r_út
),

4801 [
C_TX_READ_PIO_MEMORY_CSR_UNC_ERR
] = 
CNTR_ELEM
("TxReadPioMemoryCsrUncErr", 0, 0,

4802 
CNTR_NORMAL
,

4803 
acûss_tx_»ad_pio_memÜy_c¤_unc_”r_út
),

4804 [
C_TX_READ_SDMA_MEMORY_CSR_UNC_ERR
] = 
CNTR_ELEM
("TxReadSdmaMemoryCsrUncErr", 0,

4805 0, 
CNTR_NORMAL
,

4806 
acûss_tx_»ad_sdma_memÜy_c¤_”r_út
),

4807 [
C_TX_EGRESS_FIFO_COR_ERR
] = 
CNTR_ELEM
("TxEgressFifoCorErr", 0, 0,

4808 
CNTR_NORMAL
,

4809 
acûss_tx_eg»ss_fifo_cÜ_”r_út
),

4810 [
C_TX_READ_PIO_MEMORY_COR_ERR
] = 
CNTR_ELEM
("TxReadPioMemoryCorErr", 0, 0,

4811 
CNTR_NORMAL
,

4812 
acûss_tx_»ad_pio_memÜy_cÜ_”r_út
),

4813 [
C_TX_READ_SDMA_MEMORY_COR_ERR
] = 
CNTR_ELEM
("TxReadSdmaMemoryCorErr", 0, 0,

4814 
CNTR_NORMAL
,

4815 
acûss_tx_»ad_sdma_memÜy_cÜ_”r_út
),

4816 [
C_TX_SB_HDR_COR_ERR
] = 
CNTR_ELEM
("TxSbHdrCorErr", 0, 0,

4817 
CNTR_NORMAL
,

4818 
acûss_tx_sb_hdr_cÜ_”r_út
),

4819 [
C_TX_CREDIT_OVERRUN_ERR
] = 
CNTR_ELEM
("TxCreditOverrunErr", 0, 0,

4820 
CNTR_NORMAL
,

4821 
acûss_tx_üed™_ov”run_”r_út
),

4822 [
C_TX_LAUNCH_FIFO8_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo8CorErr", 0, 0,

4823 
CNTR_NORMAL
,

4824 
acûss_tx_Ïunch_fifo8_cÜ_”r_út
),

4825 [
C_TX_LAUNCH_FIFO7_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo7CorErr", 0, 0,

4826 
CNTR_NORMAL
,

4827 
acûss_tx_Ïunch_fifo7_cÜ_”r_út
),

4828 [
C_TX_LAUNCH_FIFO6_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo6CorErr", 0, 0,

4829 
CNTR_NORMAL
,

4830 
acûss_tx_Ïunch_fifo6_cÜ_”r_út
),

4831 [
C_TX_LAUNCH_FIFO5_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo5CorErr", 0, 0,

4832 
CNTR_NORMAL
,

4833 
acûss_tx_Ïunch_fifo5_cÜ_”r_út
),

4834 [
C_TX_LAUNCH_FIFO4_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo4CorErr", 0, 0,

4835 
CNTR_NORMAL
,

4836 
acûss_tx_Ïunch_fifo4_cÜ_”r_út
),

4837 [
C_TX_LAUNCH_FIFO3_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo3CorErr", 0, 0,

4838 
CNTR_NORMAL
,

4839 
acûss_tx_Ïunch_fifo3_cÜ_”r_út
),

4840 [
C_TX_LAUNCH_FIFO2_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo2CorErr", 0, 0,

4841 
CNTR_NORMAL
,

4842 
acûss_tx_Ïunch_fifo2_cÜ_”r_út
),

4843 [
C_TX_LAUNCH_FIFO1_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo1CorErr", 0, 0,

4844 
CNTR_NORMAL
,

4845 
acûss_tx_Ïunch_fifo1_cÜ_”r_út
),

4846 [
C_TX_LAUNCH_FIFO0_COR_ERR
] = 
CNTR_ELEM
("TxLaunchFifo0CorErr", 0, 0,

4847 
CNTR_NORMAL
,

4848 
acûss_tx_Ïunch_fifo0_cÜ_”r_út
),

4849 [
C_TX_CREDIT_RETURN_VL_ERR
] = 
CNTR_ELEM
("TxCreditReturnVLErr", 0, 0,

4850 
CNTR_NORMAL
,

4851 
acûss_tx_üed™_»tuº_vl_”r_út
),

4852 [
C_TX_HCRC_INSERTION_ERR
] = 
CNTR_ELEM
("TxHcrcInsertionErr", 0, 0,

4853 
CNTR_NORMAL
,

4854 
acûss_tx_hüc_š£¹iÚ_”r_út
),

4855 [
C_TX_EGRESS_FIFI_UNC_ERR
] = 
CNTR_ELEM
("TxEgressFifoUncErr", 0, 0,

4856 
CNTR_NORMAL
,

4857 
acûss_tx_eg»ss_fifo_unc_”r_út
),

4858 [
C_TX_READ_PIO_MEMORY_UNC_ERR
] = 
CNTR_ELEM
("TxReadPioMemoryUncErr", 0, 0,

4859 
CNTR_NORMAL
,

4860 
acûss_tx_»ad_pio_memÜy_unc_”r_út
),

4861 [
C_TX_READ_SDMA_MEMORY_UNC_ERR
] = 
CNTR_ELEM
("TxReadSdmaMemoryUncErr", 0, 0,

4862 
CNTR_NORMAL
,

4863 
acûss_tx_»ad_sdma_memÜy_unc_”r_út
),

4864 [
C_TX_SB_HDR_UNC_ERR
] = 
CNTR_ELEM
("TxSbHdrUncErr", 0, 0,

4865 
CNTR_NORMAL
,

4866 
acûss_tx_sb_hdr_unc_”r_út
),

4867 [
C_TX_CREDIT_RETURN_PARITY_ERR
] = 
CNTR_ELEM
("TxCreditReturnParityErr", 0, 0,

4868 
CNTR_NORMAL
,

4869 
acûss_tx_üed™_»tuº_·¹iy_”r_út
),

4870 [
C_TX_LAUNCH_FIFO8_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo8UncOrParityErr",

4871 0, 0, 
CNTR_NORMAL
,

4872 
acûss_tx_Ïunch_fifo8_unc_Ü_·r™y_”r_út
),

4873 [
C_TX_LAUNCH_FIFO7_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo7UncOrParityErr",

4874 0, 0, 
CNTR_NORMAL
,

4875 
acûss_tx_Ïunch_fifo7_unc_Ü_·r™y_”r_út
),

4876 [
C_TX_LAUNCH_FIFO6_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo6UncOrParityErr",

4877 0, 0, 
CNTR_NORMAL
,

4878 
acûss_tx_Ïunch_fifo6_unc_Ü_·r™y_”r_út
),

4879 [
C_TX_LAUNCH_FIFO5_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo5UncOrParityErr",

4880 0, 0, 
CNTR_NORMAL
,

4881 
acûss_tx_Ïunch_fifo5_unc_Ü_·r™y_”r_út
),

4882 [
C_TX_LAUNCH_FIFO4_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo4UncOrParityErr",

4883 0, 0, 
CNTR_NORMAL
,

4884 
acûss_tx_Ïunch_fifo4_unc_Ü_·r™y_”r_út
),

4885 [
C_TX_LAUNCH_FIFO3_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo3UncOrParityErr",

4886 0, 0, 
CNTR_NORMAL
,

4887 
acûss_tx_Ïunch_fifo3_unc_Ü_·r™y_”r_út
),

4888 [
C_TX_LAUNCH_FIFO2_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo2UncOrParityErr",

4889 0, 0, 
CNTR_NORMAL
,

4890 
acûss_tx_Ïunch_fifo2_unc_Ü_·r™y_”r_út
),

4891 [
C_TX_LAUNCH_FIFO1_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo1UncOrParityErr",

4892 0, 0, 
CNTR_NORMAL
,

4893 
acûss_tx_Ïunch_fifo1_unc_Ü_·r™y_”r_út
),

4894 [
C_TX_LAUNCH_FIFO0_UNC_OR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchFifo0UncOrParityErr",

4895 0, 0, 
CNTR_NORMAL
,

4896 
acûss_tx_Ïunch_fifo0_unc_Ü_·r™y_”r_út
),

4897 [
C_TX_SDMA15_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma15DisallowedPacketErr",

4898 0, 0, 
CNTR_NORMAL
,

4899 
acûss_tx_sdma15_di§Îowed_·ck‘_”r_út
),

4900 [
C_TX_SDMA14_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma14DisallowedPacketErr",

4901 0, 0, 
CNTR_NORMAL
,

4902 
acûss_tx_sdma14_di§Îowed_·ck‘_”r_út
),

4903 [
C_TX_SDMA13_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma13DisallowedPacketErr",

4904 0, 0, 
CNTR_NORMAL
,

4905 
acûss_tx_sdma13_di§Îowed_·ck‘_”r_út
),

4906 [
C_TX_SDMA12_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma12DisallowedPacketErr",

4907 0, 0, 
CNTR_NORMAL
,

4908 
acûss_tx_sdma12_di§Îowed_·ck‘_”r_út
),

4909 [
C_TX_SDMA11_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma11DisallowedPacketErr",

4910 0, 0, 
CNTR_NORMAL
,

4911 
acûss_tx_sdma11_di§Îowed_·ck‘_”r_út
),

4912 [
C_TX_SDMA10_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma10DisallowedPacketErr",

4913 0, 0, 
CNTR_NORMAL
,

4914 
acûss_tx_sdma10_di§Îowed_·ck‘_”r_út
),

4915 [
C_TX_SDMA9_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma9DisallowedPacketErr",

4916 0, 0, 
CNTR_NORMAL
,

4917 
acûss_tx_sdma9_di§Îowed_·ck‘_”r_út
),

4918 [
C_TX_SDMA8_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma8DisallowedPacketErr",

4919 0, 0, 
CNTR_NORMAL
,

4920 
acûss_tx_sdma8_di§Îowed_·ck‘_”r_út
),

4921 [
C_TX_SDMA7_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma7DisallowedPacketErr",

4922 0, 0, 
CNTR_NORMAL
,

4923 
acûss_tx_sdma7_di§Îowed_·ck‘_”r_út
),

4924 [
C_TX_SDMA6_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma6DisallowedPacketErr",

4925 0, 0, 
CNTR_NORMAL
,

4926 
acûss_tx_sdma6_di§Îowed_·ck‘_”r_út
),

4927 [
C_TX_SDMA5_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma5DisallowedPacketErr",

4928 0, 0, 
CNTR_NORMAL
,

4929 
acûss_tx_sdma5_di§Îowed_·ck‘_”r_út
),

4930 [
C_TX_SDMA4_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma4DisallowedPacketErr",

4931 0, 0, 
CNTR_NORMAL
,

4932 
acûss_tx_sdma4_di§Îowed_·ck‘_”r_út
),

4933 [
C_TX_SDMA3_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma3DisallowedPacketErr",

4934 0, 0, 
CNTR_NORMAL
,

4935 
acûss_tx_sdma3_di§Îowed_·ck‘_”r_út
),

4936 [
C_TX_SDMA2_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma2DisallowedPacketErr",

4937 0, 0, 
CNTR_NORMAL
,

4938 
acûss_tx_sdma2_di§Îowed_·ck‘_”r_út
),

4939 [
C_TX_SDMA1_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma1DisallowedPacketErr",

4940 0, 0, 
CNTR_NORMAL
,

4941 
acûss_tx_sdma1_di§Îowed_·ck‘_”r_út
),

4942 [
C_TX_SDMA0_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("TxSdma0DisallowedPacketErr",

4943 0, 0, 
CNTR_NORMAL
,

4944 
acûss_tx_sdma0_di§Îowed_·ck‘_”r_út
),

4945 [
C_TX_CONFIG_PARITY_ERR
] = 
CNTR_ELEM
("TxConfigParityErr", 0, 0,

4946 
CNTR_NORMAL
,

4947 
acûss_tx_cÚfig_·r™y_”r_út
),

4948 [
C_TX_SBRD_CTL_CSR_PARITY_ERR
] = 
CNTR_ELEM
("TxSbrdCtlCsrParityErr", 0, 0,

4949 
CNTR_NORMAL
,

4950 
acûss_tx_sbrd_ùl_c¤_·r™y_”r_út
),

4951 [
C_TX_LAUNCH_CSR_PARITY_ERR
] = 
CNTR_ELEM
("TxLaunchCsrParityErr", 0, 0,

4952 
CNTR_NORMAL
,

4953 
acûss_tx_Ïunch_c¤_·r™y_”r_út
),

4954 [
C_TX_ILLEGAL_CL_ERR
] = 
CNTR_ELEM
("TxIllegalVLErr", 0, 0,

4955 
CNTR_NORMAL
,

4956 
acûss_tx_žËg®_vl_”r_út
),

4957 [
C_TX_SBRD_CTL_STATE_MACHINE_PARITY_ERR
] = 
CNTR_ELEM
(

4959 
CNTR_NORMAL
,

4960 
acûss_tx_sbrd_ùl_¡©e_machše_·r™y_”r_út
),

4961 [
C_TX_RESERVED_10
] = 
CNTR_ELEM
("Tx Egress Reserved 10", 0, 0,

4962 
CNTR_NORMAL
,

4963 
acûss_eg»ss_»£rved_10_”r_út
),

4964 [
C_TX_RESERVED_9
] = 
CNTR_ELEM
("Tx Egress Reserved 9", 0, 0,

4965 
CNTR_NORMAL
,

4966 
acûss_eg»ss_»£rved_9_”r_út
),

4967 [
C_TX_SDMA_LAUNCH_INTF_PARITY_ERR
] = 
CNTR_ELEM
("TxSdmaLaunchIntfParityErr",

4968 0, 0, 
CNTR_NORMAL
,

4969 
acûss_tx_sdma_Ïunch_štf_·r™y_”r_út
),

4970 [
C_TX_PIO_LAUNCH_INTF_PARITY_ERR
] = 
CNTR_ELEM
("TxPioLaunchIntfParityErr", 0, 0,

4971 
CNTR_NORMAL
,

4972 
acûss_tx_pio_Ïunch_štf_·r™y_”r_út
),

4973 [
C_TX_RESERVED_6
] = 
CNTR_ELEM
("Tx Egress Reserved 6", 0, 0,

4974 
CNTR_NORMAL
,

4975 
acûss_eg»ss_»£rved_6_”r_út
),

4976 [
C_TX_INCORRECT_LINK_STATE_ERR
] = 
CNTR_ELEM
("TxIncorrectLinkStateErr", 0, 0,

4977 
CNTR_NORMAL
,

4978 
acûss_tx_šcÜ»ù_lšk_¡©e_”r_út
),

4979 [
C_TX_LINK_DOWN_ERR
] = 
CNTR_ELEM
("TxLinkdownErr", 0, 0,

4980 
CNTR_NORMAL
,

4981 
acûss_tx_lškdown_”r_út
),

4982 [
C_TX_EGRESS_FIFO_UNDERRUN_OR_PARITY_ERR
] = 
CNTR_ELEM
(

4984 
CNTR_NORMAL
,

4985 
acûss_tx_eg»ss_fifi_und”run_Ü_·r™y_”r_út
),

4986 [
C_TX_RESERVED_2
] = 
CNTR_ELEM
("Tx Egress Reserved 2", 0, 0,

4987 
CNTR_NORMAL
,

4988 
acûss_eg»ss_»£rved_2_”r_út
),

4989 [
C_TX_PKT_INTEGRITY_MEM_UNC_ERR
] = 
CNTR_ELEM
("TxPktIntegrityMemUncErr", 0, 0,

4990 
CNTR_NORMAL
,

4991 
acûss_tx_pkt_š‹gr™y_mem_unc_”r_út
),

4992 [
C_TX_PKT_INTEGRITY_MEM_COR_ERR
] = 
CNTR_ELEM
("TxPktIntegrityMemCorErr", 0, 0,

4993 
CNTR_NORMAL
,

4994 
acûss_tx_pkt_š‹gr™y_mem_cÜ_”r_út
),

4996 [
C_SEND_CSR_WRITE_BAD_ADDR_ERR
] = 
CNTR_ELEM
("SendCsrWriteBadAddrErr", 0, 0,

4997 
CNTR_NORMAL
,

4998 
acûss_£nd_c¤_wr™e_bad_addr_”r_út
),

4999 [
C_SEND_CSR_READ_BAD_ADD_ERR
] = 
CNTR_ELEM
("SendCsrReadBadAddrErr", 0, 0,

5000 
CNTR_NORMAL
,

5001 
acûss_£nd_c¤_»ad_bad_addr_”r_út
),

5002 [
C_SEND_CSR_PARITY_ERR
] = 
CNTR_ELEM
("SendCsrParityErr", 0, 0,

5003 
CNTR_NORMAL
,

5004 
acûss_£nd_c¤_·r™y_út
),

5006 [
C_PIO_WRITE_OUT_OF_BOUNDS_ERR
] = 
CNTR_ELEM
("PioWriteOutOfBoundsErr", 0, 0,

5007 
CNTR_NORMAL
,

5008 
acûss_pio_wr™e_out_of_bounds_”r_út
),

5009 [
C_PIO_WRITE_OVERFLOW_ERR
] = 
CNTR_ELEM
("PioWriteOverflowErr", 0, 0,

5010 
CNTR_NORMAL
,

5011 
acûss_pio_wr™e_ov”æow_”r_út
),

5012 [
C_PIO_WRITE_CROSSES_BOUNDARY_ERR
] = 
CNTR_ELEM
("PioWriteCrossesBoundaryErr",

5013 0, 0, 
CNTR_NORMAL
,

5014 
acûss_pio_wr™e_üos£s_bound¬y_”r_út
),

5015 [
C_PIO_DISALLOWED_PACKET_ERR
] = 
CNTR_ELEM
("PioDisallowedPacketErr", 0, 0,

5016 
CNTR_NORMAL
,

5017 
acûss_pio_di§Îowed_·ck‘_”r_út
),

5018 [
C_PIO_INCONSISTENT_SOP_ERR
] = 
CNTR_ELEM
("PioInconsistentSopErr", 0, 0,

5019 
CNTR_NORMAL
,

5020 
acûss_pio_šcÚsi¡’t_sÝ_”r_út
),

5022 [
C_SDMA_HEADER_REQUEST_FIFO_COR_ERR
] = 
CNTR_ELEM
("SDmaHeaderRequestFifoCorErr",

5023 0, 0, 
CNTR_NORMAL
,

5024 
acûss_sdma_h—d”_»que¡_fifo_cÜ_”r_út
),

5025 [
C_SDMA_HEADER_STORAGE_COR_ERR
] = 
CNTR_ELEM
("SDmaHeaderStorageCorErr", 0, 0,

5026 
CNTR_NORMAL
,

5027 
acûss_sdma_h—d”_¡Üage_cÜ_”r_út
),

5028 [
C_SDMA_PACKET_TRACKING_COR_ERR
] = 
CNTR_ELEM
("SDmaPacketTrackingCorErr", 0, 0,

5029 
CNTR_NORMAL
,

5030 
acûss_sdma_·ck‘_Œackšg_cÜ_”r_út
),

5031 [
C_SDMA_ASSEMBLY_COR_ERR
] = 
CNTR_ELEM
("SDmaAssemblyCorErr", 0, 0,

5032 
CNTR_NORMAL
,

5033 
acûss_sdma_as£mbly_cÜ_”r_út
),

5034 [
C_SDMA_DESC_TABLE_COR_ERR
] = 
CNTR_ELEM
("SDmaDescTableCorErr", 0, 0,

5035 
CNTR_NORMAL
,

5036 
acûss_sdma_desc_bË_cÜ_”r_út
),

5037 [
C_SDMA_HEADER_REQUEST_FIFO_UNC_ERR
] = 
CNTR_ELEM
("SDmaHeaderRequestFifoUncErr",

5038 0, 0, 
CNTR_NORMAL
,

5039 
acûss_sdma_h—d”_»que¡_fifo_unc_”r_út
),

5040 [
C_SDMA_HEADER_STORAGE_UNC_ERR
] = 
CNTR_ELEM
("SDmaHeaderStorageUncErr", 0, 0,

5041 
CNTR_NORMAL
,

5042 
acûss_sdma_h—d”_¡Üage_unc_”r_út
),

5043 [
C_SDMA_PACKET_TRACKING_UNC_ERR
] = 
CNTR_ELEM
("SDmaPacketTrackingUncErr", 0, 0,

5044 
CNTR_NORMAL
,

5045 
acûss_sdma_·ck‘_Œackšg_unc_”r_út
),

5046 [
C_SDMA_ASSEMBLY_UNC_ERR
] = 
CNTR_ELEM
("SDmaAssemblyUncErr", 0, 0,

5047 
CNTR_NORMAL
,

5048 
acûss_sdma_as£mbly_unc_”r_út
),

5049 [
C_SDMA_DESC_TABLE_UNC_ERR
] = 
CNTR_ELEM
("SDmaDescTableUncErr", 0, 0,

5050 
CNTR_NORMAL
,

5051 
acûss_sdma_desc_bË_unc_”r_út
),

5052 [
C_SDMA_TIMEOUT_ERR
] = 
CNTR_ELEM
("SDmaTimeoutErr", 0, 0,

5053 
CNTR_NORMAL
,

5054 
acûss_sdma_timeout_”r_út
),

5055 [
C_SDMA_HEADER_LENGTH_ERR
] = 
CNTR_ELEM
("SDmaHeaderLengthErr", 0, 0,

5056 
CNTR_NORMAL
,

5057 
acûss_sdma_h—d”_Ëngth_”r_út
),

5058 [
C_SDMA_HEADER_ADDRESS_ERR
] = 
CNTR_ELEM
("SDmaHeaderAddressErr", 0, 0,

5059 
CNTR_NORMAL
,

5060 
acûss_sdma_h—d”_add»ss_”r_út
),

5061 [
C_SDMA_HEADER_SELECT_ERR
] = 
CNTR_ELEM
("SDmaHeaderSelectErr", 0, 0,

5062 
CNTR_NORMAL
,

5063 
acûss_sdma_h—d”_£Ëù_”r_út
),

5064 [
C_SMDA_RESERVED_9
] = 
CNTR_ELEM
("SDma Reserved 9", 0, 0,

5065 
CNTR_NORMAL
,

5066 
acûss_sdma_»£rved_9_”r_út
),

5067 [
C_SDMA_PACKET_DESC_OVERFLOW_ERR
] = 
CNTR_ELEM
("SDmaPacketDescOverflowErr", 0, 0,

5068 
CNTR_NORMAL
,

5069 
acûss_sdma_·ck‘_desc_ov”æow_”r_út
),

5070 [
C_SDMA_LENGTH_MISMATCH_ERR
] = 
CNTR_ELEM
("SDmaLengthMismatchErr", 0, 0,

5071 
CNTR_NORMAL
,

5072 
acûss_sdma_Ëngth_mism©ch_”r_út
),

5073 [
C_SDMA_HALT_ERR
] = 
CNTR_ELEM
("SDmaHaltErr", 0, 0,

5074 
CNTR_NORMAL
,

5075 
acûss_sdma_h®t_”r_út
),

5076 [
C_SDMA_MEM_READ_ERR
] = 
CNTR_ELEM
("SDmaMemReadErr", 0, 0,

5077 
CNTR_NORMAL
,

5078 
acûss_sdma_mem_»ad_”r_út
),

5079 [
C_SDMA_FIRST_DESC_ERR
] = 
CNTR_ELEM
("SDmaFirstDescErr", 0, 0,

5080 
CNTR_NORMAL
,

5081 
acûss_sdma_fœ¡_desc_”r_út
),

5082 [
C_SDMA_TAIL_OUT_OF_BOUNDS_ERR
] = 
CNTR_ELEM
("SDmaTailOutOfBoundsErr", 0, 0,

5083 
CNTR_NORMAL
,

5084 
acûss_sdma_ž_out_of_bounds_”r_út
),

5085 [
C_SDMA_TOO_LONG_ERR
] = 
CNTR_ELEM
("SDmaTooLongErr", 0, 0,

5086 
CNTR_NORMAL
,

5087 
acûss_sdma_too_lÚg_”r_út
),

5088 [
C_SDMA_GEN_MISMATCH_ERR
] = 
CNTR_ELEM
("SDmaGenMismatchErr", 0, 0,

5089 
CNTR_NORMAL
,

5090 
acûss_sdma_g’_mism©ch_”r_út
),

5091 [
C_SDMA_WRONG_DW_ERR
] = 
CNTR_ELEM
("SDmaWrongDwErr", 0, 0,

5092 
CNTR_NORMAL
,

5093 
acûss_sdma_wrÚg_dw_”r_út
),

5096 
úŒ_’Œy
 
	gpÜt_úŒs
[
PORT_CNTR_LAST
] = {

5097 [
C_TX_UNSUP_VL
] = 
TXE32_PORT_CNTR_ELEM
(
TxUnVLE¼
, 
SEND_UNSUP_VL_ERR_CNT
,

5098 
CNTR_NORMAL
),

5099 [
C_TX_INVAL_LEN
] = 
TXE32_PORT_CNTR_ELEM
(
TxInv®L’
, 
SEND_LEN_ERR_CNT
,

5100 
CNTR_NORMAL
),

5101 [
C_TX_MM_LEN_ERR
] = 
TXE32_PORT_CNTR_ELEM
(
TxMML’E¼
, 
SEND_MAX_MIN_LEN_ERR_CNT
,

5102 
CNTR_NORMAL
),

5103 [
C_TX_UNDERRUN
] = 
TXE32_PORT_CNTR_ELEM
(
TxUnd”run
, 
SEND_UNDERRUN_CNT
,

5104 
CNTR_NORMAL
),

5105 [
C_TX_FLOW_STALL
] = 
TXE32_PORT_CNTR_ELEM
(
TxFlowSÎ
, 
SEND_FLOW_STALL_CNT
,

5106 
CNTR_NORMAL
),

5107 [
C_TX_DROPPED
] = 
TXE32_PORT_CNTR_ELEM
(
TxDrÝ³d
, 
SEND_DROPPED_PKT_CNT
,

5108 
CNTR_NORMAL
),

5109 [
C_TX_HDR_ERR
] = 
TXE32_PORT_CNTR_ELEM
(
TxHdrE¼
, 
SEND_HEADERS_ERR_CNT
,

5110 
CNTR_NORMAL
),

5111 [
C_TX_PKT
] = 
TXE64_PORT_CNTR_ELEM
(
TxPkt
, 
SEND_DATA_PKT_CNT
, 
CNTR_NORMAL
),

5112 [
C_TX_WORDS
] = 
TXE64_PORT_CNTR_ELEM
(
TxWÜds
, 
SEND_DWORD_CNT
, 
CNTR_NORMAL
),

5113 [
C_TX_WAIT
] = 
TXE64_PORT_CNTR_ELEM
(
TxWa™
, 
SEND_WAIT_CNT
, 
CNTR_SYNTH
),

5114 [
C_TX_FLIT_VL
] = 
TXE64_PORT_CNTR_ELEM
(
TxFl™VL
, 
SEND_DATA_VL0_CNT
,

5115 
CNTR_SYNTH
 | 
CNTR_VL
),

5116 [
C_TX_PKT_VL
] = 
TXE64_PORT_CNTR_ELEM
(
TxPktVL
, 
SEND_DATA_PKT_VL0_CNT
,

5117 
CNTR_SYNTH
 | 
CNTR_VL
),

5118 [
C_TX_WAIT_VL
] = 
TXE64_PORT_CNTR_ELEM
(
TxWa™VL
, 
SEND_WAIT_VL0_CNT
,

5119 
CNTR_SYNTH
 | 
CNTR_VL
),

5120 [
C_RX_PKT
] = 
RXE64_PORT_CNTR_ELEM
(
RxPkt
, 
RCV_DATA_PKT_CNT
, 
CNTR_NORMAL
),

5121 [
C_RX_WORDS
] = 
RXE64_PORT_CNTR_ELEM
(
RxWÜds
, 
RCV_DWORD_CNT
, 
CNTR_NORMAL
),

5122 [
C_SW_LINK_DOWN
] = 
CNTR_ELEM
("SwLškDown", 0, 0, 
CNTR_SYNTH
 | 
CNTR_32BIT
,

5123 
acûss_sw_lšk_dn_út
),

5124 [
C_SW_LINK_UP
] = 
CNTR_ELEM
("SwLškUp", 0, 0, 
CNTR_SYNTH
 | 
CNTR_32BIT
,

5125 
acûss_sw_lšk_up_út
),

5126 [
C_SW_UNKNOWN_FRAME
] = 
CNTR_ELEM
("UnknownF¿me", 0, 0, 
CNTR_NORMAL
,

5127 
acûss_sw_unknown_äame_út
),

5128 [
C_SW_XMIT_DSCD
] = 
CNTR_ELEM
("Xm™Dscd", 0, 0, 
CNTR_SYNTH
 | 
CNTR_32BIT
,

5129 
acûss_sw_xm™_disÿrds
),

5130 [
C_SW_XMIT_DSCD_VL
] = 
CNTR_ELEM
("XmitDscdVl", 0, 0,

5131 
CNTR_SYNTH
 | 
CNTR_32BIT
 | 
CNTR_VL
,

5132 
acûss_sw_xm™_disÿrds
),

5133 [
C_SW_XMIT_CSTR_ERR
] = 
CNTR_ELEM
("Xm™C¡rE¼", 0, 0, 
CNTR_SYNTH
,

5134 
acûss_xm™_cÚ¡¿št_”rs
),

5135 [
C_SW_RCV_CSTR_ERR
] = 
CNTR_ELEM
("RcvC¡rE¼", 0, 0, 
CNTR_SYNTH
,

5136 
acûss_rcv_cÚ¡¿št_”rs
),

5137 [
C_SW_IBP_LOOP_PKTS
] = 
SW_IBP_CNTR
(
LoÝPkts
, 
loÝ_pkts
),

5138 [
C_SW_IBP_RC_RESENDS
] = 
SW_IBP_CNTR
(
RcRe£nd
, 
rc_»£nds
),

5139 [
C_SW_IBP_RNR_NAKS
] = 
SW_IBP_CNTR
(
RÄNak
, 
ºr_Çks
),

5140 [
C_SW_IBP_OTHER_NAKS
] = 
SW_IBP_CNTR
(
Oth”Nak
, 
Ùh”_Çks
),

5141 [
C_SW_IBP_RC_TIMEOUTS
] = 
SW_IBP_CNTR
(
RcTimeOut
, 
rc_timeouts
),

5142 [
C_SW_IBP_PKT_DROPS
] = 
SW_IBP_CNTR
(
PktDrÝ
, 
pkt_drÝs
),

5143 [
C_SW_IBP_DMA_WAIT
] = 
SW_IBP_CNTR
(
DmaWa™
, 
dmawa™
),

5144 [
C_SW_IBP_RC_SEQNAK
] = 
SW_IBP_CNTR
(
RcSeqNak
, 
rc_£qÇk
),

5145 [
C_SW_IBP_RC_DUPREQ
] = 
SW_IBP_CNTR
(
RcDupRew
, 
rc_du´eq
),

5146 [
C_SW_IBP_RDMA_SEQ
] = 
SW_IBP_CNTR
(
RdmaSeq
, 
rdma_£q
),

5147 [
C_SW_IBP_UNALIGNED
] = 
SW_IBP_CNTR
(
UÇligÃd
, 
uÇligÃd
),

5148 [
C_SW_IBP_SEQ_NAK
] = 
SW_IBP_CNTR
(
SeqNak
, 
£q_Çks
),

5149 [
C_SW_CPU_RC_ACKS
] = 
CNTR_ELEM
("RcAcks", 0, 0, 
CNTR_NORMAL
,

5150 
acûss_sw_ýu_rc_acks
),

5151 [
C_SW_CPU_RC_QACKS
] = 
CNTR_ELEM
("RcQacks", 0, 0, 
CNTR_NORMAL
,

5152 
acûss_sw_ýu_rc_qacks
),

5153 [
C_SW_CPU_RC_DELAYED_COMP
] = 
CNTR_ELEM
("RcD–ayComp", 0, 0, 
CNTR_NORMAL
,

5154 
acûss_sw_ýu_rc_d–ayed_comp
),

5155 [
OVR_LBL
(0)] = 
OVR_ELM
(0), [OVR_LBL(1)] = OVR_ELM(1),

5156 [
OVR_LBL
(2)] = 
OVR_ELM
(2), [OVR_LBL(3)] = OVR_ELM(3),

5157 [
OVR_LBL
(4)] = 
OVR_ELM
(4), [OVR_LBL(5)] = OVR_ELM(5),

5158 [
OVR_LBL
(6)] = 
OVR_ELM
(6), [OVR_LBL(7)] = OVR_ELM(7),

5159 [
OVR_LBL
(8)] = 
OVR_ELM
(8), [OVR_LBL(9)] = OVR_ELM(9),

5160 [
OVR_LBL
(10)] = 
OVR_ELM
(10), [OVR_LBL(11)] = OVR_ELM(11),

5161 [
OVR_LBL
(12)] = 
OVR_ELM
(12), [OVR_LBL(13)] = OVR_ELM(13),

5162 [
OVR_LBL
(14)] = 
OVR_ELM
(14), [OVR_LBL(15)] = OVR_ELM(15),

5163 [
OVR_LBL
(16)] = 
OVR_ELM
(16), [OVR_LBL(17)] = OVR_ELM(17),

5164 [
OVR_LBL
(18)] = 
OVR_ELM
(18), [OVR_LBL(19)] = OVR_ELM(19),

5165 [
OVR_LBL
(20)] = 
OVR_ELM
(20), [OVR_LBL(21)] = OVR_ELM(21),

5166 [
OVR_LBL
(22)] = 
OVR_ELM
(22), [OVR_LBL(23)] = OVR_ELM(23),

5167 [
OVR_LBL
(24)] = 
OVR_ELM
(24), [OVR_LBL(25)] = OVR_ELM(25),

5168 [
OVR_LBL
(26)] = 
OVR_ELM
(26), [OVR_LBL(27)] = OVR_ELM(27),

5169 [
OVR_LBL
(28)] = 
OVR_ELM
(28), [OVR_LBL(29)] = OVR_ELM(29),

5170 [
OVR_LBL
(30)] = 
OVR_ELM
(30), [OVR_LBL(31)] = OVR_ELM(31),

5171 [
OVR_LBL
(32)] = 
OVR_ELM
(32), [OVR_LBL(33)] = OVR_ELM(33),

5172 [
OVR_LBL
(34)] = 
OVR_ELM
(34), [OVR_LBL(35)] = OVR_ELM(35),

5173 [
OVR_LBL
(36)] = 
OVR_ELM
(36), [OVR_LBL(37)] = OVR_ELM(37),

5174 [
OVR_LBL
(38)] = 
OVR_ELM
(38), [OVR_LBL(39)] = OVR_ELM(39),

5175 [
OVR_LBL
(40)] = 
OVR_ELM
(40), [OVR_LBL(41)] = OVR_ELM(41),

5176 [
OVR_LBL
(42)] = 
OVR_ELM
(42), [OVR_LBL(43)] = OVR_ELM(43),

5177 [
OVR_LBL
(44)] = 
OVR_ELM
(44), [OVR_LBL(45)] = OVR_ELM(45),

5178 [
OVR_LBL
(46)] = 
OVR_ELM
(46), [OVR_LBL(47)] = OVR_ELM(47),

5179 [
OVR_LBL
(48)] = 
OVR_ELM
(48), [OVR_LBL(49)] = OVR_ELM(49),

5180 [
OVR_LBL
(50)] = 
OVR_ELM
(50), [OVR_LBL(51)] = OVR_ELM(51),

5181 [
OVR_LBL
(52)] = 
OVR_ELM
(52), [OVR_LBL(53)] = OVR_ELM(53),

5182 [
OVR_LBL
(54)] = 
OVR_ELM
(54), [OVR_LBL(55)] = OVR_ELM(55),

5183 [
OVR_LBL
(56)] = 
OVR_ELM
(56), [OVR_LBL(57)] = OVR_ELM(57),

5184 [
OVR_LBL
(58)] = 
OVR_ELM
(58), [OVR_LBL(59)] = OVR_ELM(59),

5185 [
OVR_LBL
(60)] = 
OVR_ELM
(60), [OVR_LBL(61)] = OVR_ELM(61),

5186 [
OVR_LBL
(62)] = 
OVR_ELM
(62), [OVR_LBL(63)] = OVR_ELM(63),

5187 [
OVR_LBL
(64)] = 
OVR_ELM
(64), [OVR_LBL(65)] = OVR_ELM(65),

5188 [
OVR_LBL
(66)] = 
OVR_ELM
(66), [OVR_LBL(67)] = OVR_ELM(67),

5189 [
OVR_LBL
(68)] = 
OVR_ELM
(68), [OVR_LBL(69)] = OVR_ELM(69),

5190 [
OVR_LBL
(70)] = 
OVR_ELM
(70), [OVR_LBL(71)] = OVR_ELM(71),

5191 [
OVR_LBL
(72)] = 
OVR_ELM
(72), [OVR_LBL(73)] = OVR_ELM(73),

5192 [
OVR_LBL
(74)] = 
OVR_ELM
(74), [OVR_LBL(75)] = OVR_ELM(75),

5193 [
OVR_LBL
(76)] = 
OVR_ELM
(76), [OVR_LBL(77)] = OVR_ELM(77),

5194 [
OVR_LBL
(78)] = 
OVR_ELM
(78), [OVR_LBL(79)] = OVR_ELM(79),

5195 [
OVR_LBL
(80)] = 
OVR_ELM
(80), [OVR_LBL(81)] = OVR_ELM(81),

5196 [
OVR_LBL
(82)] = 
OVR_ELM
(82), [OVR_LBL(83)] = OVR_ELM(83),

5197 [
OVR_LBL
(84)] = 
OVR_ELM
(84), [OVR_LBL(85)] = OVR_ELM(85),

5198 [
OVR_LBL
(86)] = 
OVR_ELM
(86), [OVR_LBL(87)] = OVR_ELM(87),

5199 [
OVR_LBL
(88)] = 
OVR_ELM
(88), [OVR_LBL(89)] = OVR_ELM(89),

5200 [
OVR_LBL
(90)] = 
OVR_ELM
(90), [OVR_LBL(91)] = OVR_ELM(91),

5201 [
OVR_LBL
(92)] = 
OVR_ELM
(92), [OVR_LBL(93)] = OVR_ELM(93),

5202 [
OVR_LBL
(94)] = 
OVR_ELM
(94), [OVR_LBL(95)] = OVR_ELM(95),

5203 [
OVR_LBL
(96)] = 
OVR_ELM
(96), [OVR_LBL(97)] = OVR_ELM(97),

5204 [
OVR_LBL
(98)] = 
OVR_ELM
(98), [OVR_LBL(99)] = OVR_ELM(99),

5205 [
OVR_LBL
(100)] = 
OVR_ELM
(100), [OVR_LBL(101)] = OVR_ELM(101),

5206 [
OVR_LBL
(102)] = 
OVR_ELM
(102), [OVR_LBL(103)] = OVR_ELM(103),

5207 [
OVR_LBL
(104)] = 
OVR_ELM
(104), [OVR_LBL(105)] = OVR_ELM(105),

5208 [
OVR_LBL
(106)] = 
OVR_ELM
(106), [OVR_LBL(107)] = OVR_ELM(107),

5209 [
OVR_LBL
(108)] = 
OVR_ELM
(108), [OVR_LBL(109)] = OVR_ELM(109),

5210 [
OVR_LBL
(110)] = 
OVR_ELM
(110), [OVR_LBL(111)] = OVR_ELM(111),

5211 [
OVR_LBL
(112)] = 
OVR_ELM
(112), [OVR_LBL(113)] = OVR_ELM(113),

5212 [
OVR_LBL
(114)] = 
OVR_ELM
(114), [OVR_LBL(115)] = OVR_ELM(115),

5213 [
OVR_LBL
(116)] = 
OVR_ELM
(116), [OVR_LBL(117)] = OVR_ELM(117),

5214 [
OVR_LBL
(118)] = 
OVR_ELM
(118), [OVR_LBL(119)] = OVR_ELM(119),

5215 [
OVR_LBL
(120)] = 
OVR_ELM
(120), [OVR_LBL(121)] = OVR_ELM(121),

5216 [
OVR_LBL
(122)] = 
OVR_ELM
(122), [OVR_LBL(123)] = OVR_ELM(123),

5217 [
OVR_LBL
(124)] = 
OVR_ELM
(124), [OVR_LBL(125)] = OVR_ELM(125),

5218 [
OVR_LBL
(126)] = 
OVR_ELM
(126), [OVR_LBL(127)] = OVR_ELM(127),

5219 [
OVR_LBL
(128)] = 
OVR_ELM
(128), [OVR_LBL(129)] = OVR_ELM(129),

5220 [
OVR_LBL
(130)] = 
OVR_ELM
(130), [OVR_LBL(131)] = OVR_ELM(131),

5221 [
OVR_LBL
(132)] = 
OVR_ELM
(132), [OVR_LBL(133)] = OVR_ELM(133),

5222 [
OVR_LBL
(134)] = 
OVR_ELM
(134), [OVR_LBL(135)] = OVR_ELM(135),

5223 [
OVR_LBL
(136)] = 
OVR_ELM
(136), [OVR_LBL(137)] = OVR_ELM(137),

5224 [
OVR_LBL
(138)] = 
OVR_ELM
(138), [OVR_LBL(139)] = OVR_ELM(139),

5225 [
OVR_LBL
(140)] = 
OVR_ELM
(140), [OVR_LBL(141)] = OVR_ELM(141),

5226 [
OVR_LBL
(142)] = 
OVR_ELM
(142), [OVR_LBL(143)] = OVR_ELM(143),

5227 [
OVR_LBL
(144)] = 
OVR_ELM
(144), [OVR_LBL(145)] = OVR_ELM(145),

5228 [
OVR_LBL
(146)] = 
OVR_ELM
(146), [OVR_LBL(147)] = OVR_ELM(147),

5229 [
OVR_LBL
(148)] = 
OVR_ELM
(148), [OVR_LBL(149)] = OVR_ELM(149),

5230 [
OVR_LBL
(150)] = 
OVR_ELM
(150), [OVR_LBL(151)] = OVR_ELM(151),

5231 [
OVR_LBL
(152)] = 
OVR_ELM
(152), [OVR_LBL(153)] = OVR_ELM(153),

5232 [
OVR_LBL
(154)] = 
OVR_ELM
(154), [OVR_LBL(155)] = OVR_ELM(155),

5233 [
OVR_LBL
(156)] = 
OVR_ELM
(156), [OVR_LBL(157)] = OVR_ELM(157),

5234 [
OVR_LBL
(158)] = 
OVR_ELM
(158), [OVR_LBL(159)] = OVR_ELM(159),

5240 
	$is_ax
(
hfi1_devd©a
 *
dd
)

5242 
u8
 
ch_»v_mšÜ
 =

5243 
dd
->
»visiÚ
 >> 
CCE_REVISION_CHIP_REV_MINOR_SHIFT


5244 & 
CCE_REVISION_CHIP_REV_MINOR_MASK
;

5245  (
ch_»v_mšÜ
 & 0xf0) == 0;

5246 
	}
}

5249 
	$is_bx
(
hfi1_devd©a
 *
dd
)

5251 
u8
 
ch_»v_mšÜ
 =

5252 
dd
->
»visiÚ
 >> 
CCE_REVISION_CHIP_REV_MINOR_SHIFT


5253 & 
CCE_REVISION_CHIP_REV_MINOR_MASK
;

5254  (
ch_»v_mšÜ
 & 0xF0) == 0x10;

5255 
	}
}

5258 
boÞ
 
	$is_urg_masked
(
hfi1_ùxtd©a
 *
rcd
)

5260 
u64
 
mask
;

5261 
u32
 
is
 = 
IS_RCVURGENT_START
 + 
rcd
->
ùxt
;

5262 
u8
 
b™
 = 
is
 % 64;

5264 
mask
 = 
	`»ad_c¤
(
rcd
->
dd
, 
CCE_INT_MASK
 + (8 * (
is
 / 64)));

5265  !(
mask
 & 
	`BIT_ULL
(
b™
));

5266 
	}
}

5274 
	$­³nd_¡r
(*
buf
, **
cu½
, *
ËÅ
, cÚ¡ *
s
)

5276 *
p
 = *
cu½
;

5277 
Ën
 = *
ËÅ
;

5278 
»suÉ
 = 0;

5279 
c
;

5282 ià(
p
 !ð
buf
) {

5283 ià(
Ën
 == 0) {

5284 
»suÉ
 = 1;

5285 
dÚe
;

5287 *
p
++ = ',';

5288 
Ën
--;

5292 (
c
 = *
s
++) != 0) {

5293 ià(
Ën
 == 0) {

5294 
»suÉ
 = 1;

5295 
dÚe
;

5297 *
p
++ = 
c
;

5298 
Ën
--;

5301 
dÚe
:

5303 *
cu½
 = 
p
;

5304 *
ËÅ
 = 
Ën
;

5306  
»suÉ
;

5307 
	}
}

5313 *
	$æag_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
,

5314 
æag_bË
 *
bË
, 
bË_size
)

5316 
exŒa
[32];

5317 *
p
 = 
buf
;

5318 
Ën
 = 
buf_Ën
;

5319 
no_room
 = 0;

5320 
i
;

5323 ià(
Ën
 < 2)

5326 
Ën
--;

5327 
i
 = 0; i < 
bË_size
; i++) {

5328 ià(
æags
 & 
bË
[
i
].
æag
) {

5329 
no_room
 = 
	`­³nd_¡r
(
buf
, &
p
, &
Ën
, 
bË
[
i
].
¡r
);

5330 ià(
no_room
)

5332 
æags
 &ð~
bË
[
i
].
æag
;

5337 ià(!
no_room
 && 
æags
) {

5338 
	`¢´štf
(
exŒa
, ÓxŒa), "b™ 0x%Îx", 
æags
);

5339 
no_room
 = 
	`­³nd_¡r
(
buf
, &
p
, &
Ën
, 
exŒa
);

5343 ià(
no_room
) {

5345 ià(
Ën
 == 0)

5346 --
p
;

5347 *
p
++ = '*';

5351 *
p
 = 0;

5352  
buf
;

5353 
	}
}

5356 cÚ¡ * cÚ¡ 
	gcû_misc_Çmes
[] = {

5370 *
	$is_misc_”r_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5372 ià(
sourû
 < 
	`ARRAY_SIZE
(
cû_misc_Çmes
))

5373 
	`¡ºýy
(
buf
, 
cû_misc_Çmes
[
sourû
], 
bsize
);

5375 
	`¢´štf
(
buf
, 
bsize
, "Reserved%u",

5376 
sourû
 + 
IS_GENERAL_ERR_START
);

5378  
buf
;

5379 
	}
}

5384 *
	$is_sdma_’g_”r_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5386 
	`¢´štf
(
buf
, 
bsize
, "SDmaEngE¼IÁ%u", 
sourû
);

5387  
buf
;

5388 
	}
}

5393 *
	$is_£ndùxt_”r_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5395 
	`¢´štf
(
buf
, 
bsize
, "S’dCtxtE¼IÁ%u", 
sourû
);

5396  
buf
;

5397 
	}
}

5399 cÚ¡ * cÚ¡ 
	gv¬ious_Çmes
[] = {

5410 *
	$is_v¬ious_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5412 ià(
sourû
 < 
	`ARRAY_SIZE
(
v¬ious_Çmes
))

5413 
	`¡ºýy
(
buf
, 
v¬ious_Çmes
[
sourû
], 
bsize
);

5415 
	`¢´štf
(
buf
, 
bsize
, "Re£rved%u", 
sourû
 + 
IS_VARIOUS_START
);

5416  
buf
;

5417 
	}
}

5422 *
	$is_dc_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5424 cÚ¡ * cÚ¡ 
dc_št_Çmes
[] = {

5431 ià(
sourû
 < 
	`ARRAY_SIZE
(
dc_št_Çmes
))

5432 
	`¢´štf
(
buf
, 
bsize
, "dc_%s_št", 
dc_št_Çmes
[
sourû
]);

5434 
	`¢´štf
(
buf
, 
bsize
, "DCIÁ%u", 
sourû
);

5435  
buf
;

5436 
	}
}

5438 cÚ¡ * cÚ¡ 
	gsdma_št_Çmes
[] = {

5447 *
	$is_sdma_’g_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5450 
wh©
 = 
sourû
 / 
TXE_NUM_SDMA_ENGINES
;

5452 
which
 = 
sourû
 % 
TXE_NUM_SDMA_ENGINES
;

5454 ià(
	`lik–y
(
wh©
 < 3))

5455 
	`¢´štf
(
buf
, 
bsize
, "%s%u", 
sdma_št_Çmes
[
wh©
], 
which
);

5457 
	`¢´štf
(
buf
, 
bsize
, "Inv®id SDMA iÁ”ru± %u", 
sourû
);

5458  
buf
;

5459 
	}
}

5464 *
	$is_rcv_avaž_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5466 
	`¢´štf
(
buf
, 
bsize
, "RcvAvažIÁ%u", 
sourû
);

5467  
buf
;

5468 
	}
}

5473 *
	$is_rcv_urg’t_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5475 
	`¢´štf
(
buf
, 
bsize
, "RcvUrg’tIÁ%u", 
sourû
);

5476  
buf
;

5477 
	}
}

5482 *
	$is_£nd_üed™_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5484 
	`¢´štf
(
buf
, 
bsize
, "S’dC»d™IÁ%u", 
sourû
);

5485  
buf
;

5486 
	}
}

5491 *
	$is_»£rved_Çme
(*
buf
, 
size_t
 
bsize
, 
sourû
)

5493 
	`¢´štf
(
buf
, 
bsize
, "Re£rved%u", 
sourû
 + 
IS_RESERVED_START
);

5494  
buf
;

5495 
	}
}

5497 *
	$cû_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5499  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5500 
cû_”r_¡©us_æags
,

5501 
	`ARRAY_SIZE
(
cû_”r_¡©us_æags
));

5502 
	}
}

5504 *
	$rxe_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5506  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5507 
rxe_”r_¡©us_æags
,

5508 
	`ARRAY_SIZE
(
rxe_”r_¡©us_æags
));

5509 
	}
}

5511 *
	$misc_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5513  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
misc_”r_¡©us_æags
,

5514 
	`ARRAY_SIZE
(
misc_”r_¡©us_æags
));

5515 
	}
}

5517 *
	$pio_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5519  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5520 
pio_”r_¡©us_æags
,

5521 
	`ARRAY_SIZE
(
pio_”r_¡©us_æags
));

5522 
	}
}

5524 *
	$sdma_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5526  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5527 
sdma_”r_¡©us_æags
,

5528 
	`ARRAY_SIZE
(
sdma_”r_¡©us_æags
));

5529 
	}
}

5531 *
	$eg»ss_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5533  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5534 
eg»ss_”r_¡©us_æags
,

5535 
	`ARRAY_SIZE
(
eg»ss_”r_¡©us_æags
));

5536 
	}
}

5538 *
	$eg»ss_”r_šfo_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5540  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5541 
eg»ss_”r_šfo_æags
,

5542 
	`ARRAY_SIZE
(
eg»ss_”r_šfo_æags
));

5543 
	}
}

5545 *
	$£nd_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5547  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5548 
£nd_”r_¡©us_æags
,

5549 
	`ARRAY_SIZE
(
£nd_”r_¡©us_æags
));

5550 
	}
}

5552 
	$hªdË_cû_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5554 
buf
[96];

5555 
i
 = 0;

5561 
	`dd_dev_šfo
(
dd
, "CCE Error: %s\n",

5562 
	`cû_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5564 ià((
»g
 & 
CCE_ERR_STATUS_CCE_CLI2_ASYNC_FIFO_PARITY_ERR_SMASK
) &&

5565 
	`is_ax
(
dd
è&& (dd->
icode
 !ð
ICODE_FUNCTIONAL_SIMULATOR
)) {

5568 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 
FREEZE_SELF
);

5571 
i
 = 0; i < 
NUM_CCE_ERR_STATUS_COUNTERS
; i++) {

5572 ià(
»g
 & (1uÎ << 
i
)) {

5573 
	`šü_úŒ64
(&
dd
->
cû_”r_¡©us_út
[
i
]);

5575 
	`šü_úŒ64
(&
dd
->
sw_cû_”r_¡©us_agg»g©e
);

5578 
	}
}

5584 
	#RCVERR_CHECK_TIME
 10

	)

5585 
	$upd©e_rcv”r_tim”
(
tim”_li¡
 *
t
)

5587 
hfi1_devd©a
 *
dd
 = 
	`äom_tim”
(dd, 
t
, 
rcv”r_tim”
);

5588 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

5589 
u32
 
cur_ovæ_út
 = 
	`»ad_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
);

5591 ià(
dd
->
rcv_ovæ_út
 < 
cur_ovæ_út
 &&

5592 
µd
->
pÜt_”rÜ_aùiÚ
 & 
OPA_PI_MASK_EX_BUFFER_OVERRUN
) {

5593 
	`dd_dev_šfo
(
dd
, "%s: PÜtE¼ÜAùiÚ bounû\n", 
__func__
);

5594 
	`£t_lšk_down_»asÚ
(

5595 
µd
, 
OPA_LINKDOWN_REASON_EXCESSIVE_BUFFER_OVERRUN
, 0,

5596 
OPA_LINKDOWN_REASON_EXCESSIVE_BUFFER_OVERRUN
);

5597 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_bounû_wÜk
);

5599 
dd
->
rcv_ovæ_út
 = (
u32
)
cur_ovæ_út
;

5601 
	`mod_tim”
(&
dd
->
rcv”r_tim”
, 
jiff›s
 + 
HZ
 * 
RCVERR_CHECK_TIME
);

5602 
	}
}

5604 
	$š™_rcv”r
(
hfi1_devd©a
 *
dd
)

5606 
	`tim”_£tup
(&
dd
->
rcv”r_tim”
, 
upd©e_rcv”r_tim”
, 0);

5608 
dd
->
rcv_ovæ_út
 = 0;

5609  
	`mod_tim”
(&
dd
->
rcv”r_tim”
, 
jiff›s
 + 
HZ
 * 
RCVERR_CHECK_TIME
);

5610 
	}
}

5612 
	$ä“_rcv”r
(
hfi1_devd©a
 *
dd
)

5614 ià(
dd
->
rcv”r_tim”
.
funùiÚ
)

5615 
	`d–_tim”_sync
(&
dd
->
rcv”r_tim”
);

5616 
	}
}

5618 
	$hªdË_rxe_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5620 
buf
[96];

5621 
i
 = 0;

5623 
	`dd_dev_šfo
(
dd
, "Receive Error: %s\n",

5624 
	`rxe_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5626 ià(
»g
 & 
ALL_RXE_FREEZE_ERR
) {

5627 
æags
 = 0;

5633 ià(
	`is_ax
(
dd
è&& (
»g
 & 
RXE_FREEZE_ABORT_MASK
))

5634 
æags
 = 
FREEZE_ABORT
;

5636 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 
æags
);

5639 
i
 = 0; i < 
NUM_RCV_ERR_STATUS_COUNTERS
; i++) {

5640 ià(
»g
 & (1uÎ << 
i
))

5641 
	`šü_úŒ64
(&
dd
->
rcv_”r_¡©us_út
[
i
]);

5643 
	}
}

5645 
	$hªdË_misc_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5647 
buf
[96];

5648 
i
 = 0;

5650 
	`dd_dev_šfo
(
dd
, "Misc Error: %s",

5651 
	`misc_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5652 
i
 = 0; i < 
NUM_MISC_ERR_STATUS_COUNTERS
; i++) {

5653 ià(
»g
 & (1uÎ << 
i
))

5654 
	`šü_úŒ64
(&
dd
->
misc_”r_¡©us_út
[
i
]);

5656 
	}
}

5658 
	$hªdË_pio_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5660 
buf
[96];

5661 
i
 = 0;

5663 
	`dd_dev_šfo
(
dd
, "PIO Error: %s\n",

5664 
	`pio_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5666 ià(
»g
 & 
ALL_PIO_FREEZE_ERR
)

5667 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 0);

5669 
i
 = 0; i < 
NUM_SEND_PIO_ERR_STATUS_COUNTERS
; i++) {

5670 ià(
»g
 & (1uÎ << 
i
))

5671 
	`šü_úŒ64
(&
dd
->
£nd_pio_”r_¡©us_út
[
i
]);

5673 
	}
}

5675 
	$hªdË_sdma_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5677 
buf
[96];

5678 
i
 = 0;

5680 
	`dd_dev_šfo
(
dd
, "SDMA Error: %s\n",

5681 
	`sdma_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5683 ià(
»g
 & 
ALL_SDMA_FREEZE_ERR
)

5684 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 0);

5686 
i
 = 0; i < 
NUM_SEND_DMA_ERR_STATUS_COUNTERS
; i++) {

5687 ià(
»g
 & (1uÎ << 
i
))

5688 
	`šü_úŒ64
(&
dd
->
£nd_dma_”r_¡©us_út
[
i
]);

5690 
	}
}

5692 
šlše
 
	$__couÁ_pÜt_disÿrds
(
hfi1_µÜtd©a
 *
µd
)

5694 
	`šü_úŒ64
(&
µd
->
pÜt_xm™_disÿrds
);

5695 
	}
}

5697 
	$couÁ_pÜt_šaùive
(
hfi1_devd©a
 *
dd
)

5699 
	`__couÁ_pÜt_disÿrds
(
dd
->
µÜt
);

5700 
	}
}

5711 
	$hªdË_£nd_eg»ss_”r_šfo
(
hfi1_devd©a
 *
dd
,

5712 
vl
)

5714 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

5715 
u64
 
¤c
 = 
	`»ad_c¤
(
dd
, 
SEND_EGRESS_ERR_SOURCE
);

5716 
u64
 
šfo
 = 
	`»ad_c¤
(
dd
, 
SEND_EGRESS_ERR_INFO
);

5717 
buf
[96];

5720 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_INFO
, 
šfo
);

5722 
	`dd_dev_šfo
(
dd
,

5724 
šfo
, 
	`eg»ss_”r_šfo_¡ršg
(
buf
, (buf), info), 
¤c
);

5727 ià(
šfo
 & 
PORT_DISCARD_EGRESS_ERRS
) {

5728 
weight
, 
i
;

5752 
weight
 = 
	`hweight64
(
šfo
 & 
PORT_DISCARD_EGRESS_ERRS
);

5753 
i
 = 0; i < 
weight
; i++) {

5754 
	`__couÁ_pÜt_disÿrds
(
µd
);

5755 ià(
vl
 >ð0 && vÈ< 
TXE_NUM_DATA_VL
)

5756 
	`šü_úŒ64
(&
µd
->
pÜt_xm™_disÿrds_vl
[
vl
]);

5757 ià(
vl
 == 15)

5758 
	`šü_úŒ64
(&
µd
->
pÜt_xm™_disÿrds_vl


5759 [
C_VL_15
]);

5762 
	}
}

5768 
šlše
 
	$pÜt_šaùive_”r
(
u64
 
po¢
)

5770  (
po¢
 >ð
	`SEES
(
TX_LINKDOWN
) &&

5771 
po¢
 <ð
	`SEES
(
TX_INCORRECT_LINK_STATE
));

5772 
	}
}

5778 
šlše
 
	$di§Îowed_pkt_”r
(
po¢
)

5780  (
po¢
 >ð
	`SEES
(
TX_SDMA0_DISALLOWED_PACKET
) &&

5781 
po¢
 <ð
	`SEES
(
TX_SDMA15_DISALLOWED_PACKET
));

5782 
	}
}

5789 
šlše
 
	$di§Îowed_pkt_’gše
(
po¢
)

5791  
po¢
 - 
	`SEES
(
TX_SDMA0_DISALLOWED_PACKET
);

5792 
	}
}

5798 
	$’gše_to_vl
(
hfi1_devd©a
 *
dd
, 
’gše
)

5800 
sdma_vl_m­
 *
m
;

5801 
vl
;

5804 ià(
’gše
 < 0 ||ƒngš>ð
TXE_NUM_SDMA_ENGINES
)

5807 
	`rcu_»ad_lock
();

5808 
m
 = 
	`rcu_d”eã»nû
(
dd
->
sdma_m­
);

5809 
vl
 = 
m
->
’gše_to_vl
[
’gše
];

5810 
	`rcu_»ad_uÆock
();

5812  
vl
;

5813 
	}
}

5819 
	$sc_to_vl
(
hfi1_devd©a
 *
dd
, 
sw_šdex
)

5821 
£nd_cÚ‹xt_šfo
 *
sci
;

5822 
£nd_cÚ‹xt
 *
sc
;

5823 
i
;

5825 
sci
 = &
dd
->
£nd_cÚ‹xts
[
sw_šdex
];

5828 ià((
sci
->
ty³
 !ð
SC_KERNEL
è&& (sci->ty³ !ð
SC_VL15
))

5831 
sc
 = 
sci
->sc;

5832 ià(!
sc
)

5834 ià(
dd
->
vld
[15].
sc
 == sc)

5836 
i
 = 0; i < 
num_vls
; i++)

5837 ià(
dd
->
vld
[
i
].
sc
 == sc)

5838  
i
;

5841 
	}
}

5843 
	$hªdË_eg»ss_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5845 
u64
 
»g_cÝy
 = 
»g
, 
hªdËd
 = 0;

5846 
buf
[96];

5847 
i
 = 0;

5849 ià(
»g
 & 
ALL_TXE_EGRESS_FREEZE_ERR
)

5850 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 0);

5851 ià(
	`is_ax
(
dd
) &&

5852 (
»g
 & 
SEND_EGRESS_ERR_STATUS_TX_CREDIT_RETURN_VL_ERR_SMASK
) &&

5853 (
dd
->
icode
 !ð
ICODE_FUNCTIONAL_SIMULATOR
))

5854 
	`¡¬t_ä“ze_hªdlšg
(
dd
->
µÜt
, 0);

5856 
»g_cÝy
) {

5857 
po¢
 = 
	`æs64
(
»g_cÝy
);

5859 
shiá
 = 
po¢
 - 1;

5860 
u64
 
mask
 = 1ULL << 
shiá
;

5862 ià(
	`pÜt_šaùive_”r
(
shiá
)) {

5863 
	`couÁ_pÜt_šaùive
(
dd
);

5864 
hªdËd
 |ð
mask
;

5865 } ià(
	`di§Îowed_pkt_”r
(
shiá
)) {

5866 
vl
 = 
	`’gše_to_vl
(
dd
, 
	`di§Îowed_pkt_’gše
(
shiá
));

5868 
	`hªdË_£nd_eg»ss_”r_šfo
(
dd
, 
vl
);

5869 
hªdËd
 |ð
mask
;

5871 
»g_cÝy
 &ð~
mask
;

5874 
»g
 &ð~
hªdËd
;

5876 ià(
»g
)

5877 
	`dd_dev_šfo
(
dd
, "Egress Error: %s\n",

5878 
	`eg»ss_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5880 
i
 = 0; i < 
NUM_SEND_EGRESS_ERR_STATUS_COUNTERS
; i++) {

5881 ià(
»g
 & (1uÎ << 
i
))

5882 
	`šü_úŒ64
(&
dd
->
£nd_eg»ss_”r_¡©us_út
[
i
]);

5884 
	}
}

5886 
	$hªdË_txe_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

5888 
buf
[96];

5889 
i
 = 0;

5891 
	`dd_dev_šfo
(
dd
, "Send Error: %s\n",

5892 
	`£nd_”r_¡©us_¡ršg
(
buf
, (buf), 
»g
));

5894 
i
 = 0; i < 
NUM_SEND_ERR_STATUS_COUNTERS
; i++) {

5895 ià(
»g
 & (1uÎ << 
i
))

5896 
	`šü_úŒ64
(&
dd
->
£nd_”r_¡©us_út
[
i
]);

5898 
	}
}

5904 
	#MAX_CLEAR_COUNT
 20

	)

5917 
	$š‹¼u±_þ—r_down
(
hfi1_devd©a
 *
dd
,

5918 
u32
 
cÚ‹xt
,

5919 cÚ¡ 
”r_»g_šfo
 *
”i
)

5921 
u64
 
»g
;

5922 
u32
 
couÁ
;

5925 
couÁ
 = 0;

5927 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
cÚ‹xt
, 
”i
->
¡©us
);

5928 ià(
»g
 == 0)

5930 
	`wr™e_kùxt_c¤
(
dd
, 
cÚ‹xt
, 
”i
->
þ—r
, 
»g
);

5931 ià(
	`lik–y
(
”i
->
hªdËr
))

5932 
”i
->
	`hªdËr
(
dd
, 
cÚ‹xt
, 
»g
);

5933 
couÁ
++;

5934 ià(
couÁ
 > 
MAX_CLEAR_COUNT
) {

5935 
u64
 
mask
;

5937 
	`dd_dev_”r
(
dd
, "Repeating %s bits 0x%llx - masking\n",

5938 
”i
->
desc
, 
»g
);

5943 
mask
 = 
	`»ad_kùxt_c¤
(
dd
, 
cÚ‹xt
, 
”i
->mask);

5944 
mask
 &ð~
»g
;

5945 
	`wr™e_kùxt_c¤
(
dd
, 
cÚ‹xt
, 
”i
->
mask
, mask);

5949 
	}
}

5954 
	$is_misc_”r_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

5956 cÚ¡ 
”r_»g_šfo
 *
”i
 = &
misc_”rs
[
sourû
];

5958 ià(
”i
->
hªdËr
) {

5959 
	`š‹¼u±_þ—r_down
(
dd
, 0, 
”i
);

5961 
	`dd_dev_”r
(
dd
, "Unexpected misc interrupt (%u) -„eserved\n",

5962 
sourû
);

5964 
	}
}

5966 *
	$£nd_cÚ‹xt_”r_¡©us_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

5968  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
,

5969 
sc_”r_¡©us_æags
,

5970 
	`ARRAY_SIZE
(
sc_”r_¡©us_æags
));

5971 
	}
}

5982 
	$is_£ndùxt_”r_št
(
hfi1_devd©a
 *
dd
,

5983 
hw_cÚ‹xt
)

5985 
£nd_cÚ‹xt_šfo
 *
sci
;

5986 
£nd_cÚ‹xt
 *
sc
;

5987 
æags
[96];

5988 
u64
 
¡©us
;

5989 
u32
 
sw_šdex
;

5990 
i
 = 0;

5991 
œq_æags
;

5993 
sw_šdex
 = 
dd
->
hw_to_sw
[
hw_cÚ‹xt
];

5994 ià(
sw_šdex
 >ð
dd
->
num_£nd_cÚ‹xts
) {

5995 
	`dd_dev_”r
(
dd
,

5997 
sw_šdex
, 
hw_cÚ‹xt
);

6000 
sci
 = &
dd
->
£nd_cÚ‹xts
[
sw_šdex
];

6001 
	`¥š_lock_œq§ve
(&
dd
->
sc_lock
, 
œq_æags
);

6002 
sc
 = 
sci
->sc;

6003 ià(!
sc
) {

6004 
	`dd_dev_”r
(
dd
, "%s: cÚ‹xˆ%u(%u):‚Øsc?\n", 
__func__
,

6005 
sw_šdex
, 
hw_cÚ‹xt
);

6006 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
œq_æags
);

6011 
	`sc_¡Ý
(
sc
, 
SCF_HALTED
);

6013 
¡©us
 = 
	`»ad_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
SEND_CTXT_ERR_STATUS
);

6015 
	`dd_dev_šfo
(
dd
, "S’d CÚ‹xˆ%u(%uèE¼Ü: %s\n", 
sw_šdex
, 
hw_cÚ‹xt
,

6016 
	`£nd_cÚ‹xt_”r_¡©us_¡ršg
(
æags
, (flags),

6017 
¡©us
));

6019 ià(
¡©us
 & 
SEND_CTXT_ERR_STATUS_PIO_DISALLOWED_PACKET_ERR_SMASK
)

6020 
	`hªdË_£nd_eg»ss_”r_šfo
(
dd
, 
	`sc_to_vl
(dd, 
sw_šdex
));

6026 ià(
sc
->
ty³
 !ð
SC_USER
)

6027 
	`queue_wÜk
(
dd
->
µÜt
->
hfi1_wq
, &
sc
->
h®t_wÜk
);

6028 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
œq_æags
);

6035 
i
 = 0; i < 
NUM_SEND_CTXT_ERR_STATUS_COUNTERS
; i++) {

6036 ià(
¡©us
 & (1uÎ << 
i
))

6037 
	`šü_úŒ64
(&
dd
->
sw_ùxt_”r_¡©us_út
[
i
]);

6039 
	}
}

6041 
	$hªdË_sdma_’g_”r
(
hfi1_devd©a
 *
dd
,

6042 
sourû
, 
u64
 
¡©us
)

6044 
sdma_’gše
 *
sde
;

6045 
i
 = 0;

6047 
sde
 = &
dd
->
³r_sdma
[
sourû
];

6048 #ifdeà
CONFIG_SDMA_VERBOSITY


6049 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%uè%s:%d %s()\n", sde->
this_idx
,

6050 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

6051 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) source: %u status 0x%llx\n",

6052 
sde
->
this_idx
, 
sourû
, ()
¡©us
);

6054 
sde
->
”r_út
++;

6055 
	`sdma_’gše_”rÜ
(
sde
, 
¡©us
);

6062 
i
 = 0; i < 
NUM_SEND_DMA_ENG_ERR_STATUS_COUNTERS
; i++) {

6063 ià(
¡©us
 & (1uÎ << 
i
))

6064 
	`šü_úŒ64
(&
dd
->
sw_£nd_dma_’g_”r_¡©us_út
[
i
]);

6066 
	}
}

6071 
	$is_sdma_’g_”r_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

6073 #ifdeà
CONFIG_SDMA_VERBOSITY


6074 
sdma_’gše
 *
sde
 = &
dd
->
³r_sdma
[
sourû
];

6076 
	`dd_dev_”r
(
dd
, "CONFIG SDMA(%uè%s:%d %s()\n", 
sde
->
this_idx
,

6077 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

6078 
	`dd_dev_”r
(
dd
, "CONFIG SDMA(%uèsourû: %u\n", 
sde
->
this_idx
,

6079 
sourû
);

6080 
	`sdma_dump¡©e
(
sde
);

6082 
	`š‹¼u±_þ—r_down
(
dd
, 
sourû
, &
sdma_’g_”r
);

6083 
	}
}

6088 
	$is_v¬ious_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

6090 cÚ¡ 
”r_»g_šfo
 *
”i
 = &
v¬ious_”r
[
sourû
];

6097 ià(
sourû
 =ð
TCRIT_INT_SOURCE
)

6098 
	`hªdË_‹mp_”r
(
dd
);

6099 ià(
”i
->
hªdËr
)

6100 
	`š‹¼u±_þ—r_down
(
dd
, 0, 
”i
);

6102 
	`dd_dev_šfo
(
dd
,

6104 
__func__
, 
sourû
);

6105 
	}
}

6107 
	$hªdË_qså_št
(
hfi1_devd©a
 *
dd
, 
u32
 
¤c_ùx
, 
u64
 
»g
)

6110 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

6111 
æags
;

6112 
u64
 
qså_št_mgmt
 = (u64)(
QSFP_HFI0_INT_N
 | 
QSFP_HFI0_MODPRST_N
);

6114 ià(
»g
 & 
QSFP_HFI0_MODPRST_N
) {

6115 ià(!
	`qså_mod_´e£Á
(
µd
)) {

6116 
	`dd_dev_šfo
(
dd
, "%s: QSFP module„emoved\n",

6117 
__func__
);

6119 
µd
->
driv”_lšk_»ady
 = 0;

6125 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

6130 
µd
->
qså_šfo
.
ÿche_v®id
 = 0;

6131 
µd
->
qså_šfo
.
»£t_Ãeded
 = 0;

6132 
µd
->
qså_šfo
.
lim™šg_aùive
 = 0;

6133 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
,

6134 
æags
);

6136 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_INVERT
 :

6137 
ASIC_QSFP1_INVERT
, 
qså_št_mgmt
);

6139 ià((
µd
->
ofæše_di§bËd_»asÚ
 >

6140 
	`HFI1_ODR_MASK
(

6141 
OPA_LINKDOWN_REASON_LOCAL_MEDIA_NOT_INSTALLED
)) ||

6142 (
µd
->
ofæše_di§bËd_»asÚ
 ==

6143 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
)))

6144 
µd
->
ofæše_di§bËd_»asÚ
 =

6145 
	`HFI1_ODR_MASK
(

6146 
OPA_LINKDOWN_REASON_LOCAL_MEDIA_NOT_INSTALLED
);

6148 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_POLL
) {

6155 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_down_wÜk
);

6158 
	`dd_dev_šfo
(
dd
, "%s: QSFP module inserted\n",

6159 
__func__
);

6161 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

6162 
µd
->
qså_šfo
.
ÿche_v®id
 = 0;

6163 
µd
->
qså_šfo
.
ÿche_»äesh_»quœed
 = 1;

6164 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
,

6165 
æags
);

6171 
qså_št_mgmt
 &ð~(
u64
)
QSFP_HFI0_MODPRST_N
;

6172 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_INVERT
 :

6173 
ASIC_QSFP1_INVERT
, 
qså_št_mgmt
);

6175 
µd
->
ofæše_di§bËd_»asÚ
 =

6176 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_TRANSIENT
);

6180 ià(
»g
 & 
QSFP_HFI0_INT_N
) {

6181 
	`dd_dev_šfo
(
dd
, "%s: Interrupt„eceived from QSFP module\n",

6182 
__func__
);

6183 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

6184 
µd
->
qså_šfo
.
check_š‹¼u±_æags
 = 1;

6185 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

6189 ià(
	`qså_mod_´e£Á
(
µd
))

6190 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
qså_šfo
.
qså_wÜk
);

6191 
	}
}

6193 
	$»que¡_ho¡_lcb_acûss
(
hfi1_devd©a
 *
dd
)

6195 
»t
;

6197 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_MISC
,

6198 (
u64
)
HCMD_MISC_REQUEST_LCB_ACCESS
 <<

6199 
LOAD_DATA_FIELD_ID_SHIFT
, 
NULL
);

6200 ià(
»t
 !ð
HCMD_SUCCESS
) {

6201 
	`dd_dev_”r
(
dd
, "%s: command failed withƒrror %d\n",

6202 
__func__
, 
»t
);

6204  
»t
 =ð
HCMD_SUCCESS
 ? 0 : -
EBUSY
;

6205 
	}
}

6207 
	$»que¡_8051_lcb_acûss
(
hfi1_devd©a
 *
dd
)

6209 
»t
;

6211 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_MISC
,

6212 (
u64
)
HCMD_MISC_GRANT_LCB_ACCESS
 <<

6213 
LOAD_DATA_FIELD_ID_SHIFT
, 
NULL
);

6214 ià(
»t
 !ð
HCMD_SUCCESS
) {

6215 
	`dd_dev_”r
(
dd
, "%s: command failed withƒrror %d\n",

6216 
__func__
, 
»t
);

6218  
»t
 =ð
HCMD_SUCCESS
 ? 0 : -
EBUSY
;

6219 
	}
}

6225 
šlše
 
	$£t_ho¡_lcb_acûss
(
hfi1_devd©a
 *
dd
)

6227 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_CSR_ACCESS_SEL
,

6228 
DC_DC8051_CFG_CSR_ACCESS_SEL_DCC_SMASK
 |

6229 
DC_DC8051_CFG_CSR_ACCESS_SEL_LCB_SMASK
);

6230 
	}
}

6236 
šlše
 
	$£t_8051_lcb_acûss
(
hfi1_devd©a
 *
dd
)

6238 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_CSR_ACCESS_SEL
,

6239 
DC_DC8051_CFG_CSR_ACCESS_SEL_DCC_SMASK
);

6240 
	}
}

6252 
	$acquœe_lcb_acûss
(
hfi1_devd©a
 *
dd
, 
¦“p_ok
)

6254 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

6255 
»t
 = 0;

6263 ià(
¦“p_ok
) {

6264 
	`mu‹x_lock
(&
µd
->
hls_lock
);

6266 !
	`mu‹x_Œylock
(&
µd
->
hls_lock
))

6267 
	`ud–ay
(1);

6271 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_DOWN
) {

6272 
	`dd_dev_šfo
(
dd
, "%s:†ink state %s‚ot up\n",

6273 
__func__
, 
	`lšk_¡©e_Çme
(
µd
->
ho¡_lšk_¡©e
));

6274 
»t
 = -
EBUSY
;

6275 
dÚe
;

6278 ià(
dd
->
lcb_acûss_couÁ
 == 0) {

6279 
»t
 = 
	`»que¡_ho¡_lcb_acûss
(
dd
);

6280 ià(
»t
) {

6281 
	`dd_dev_”r
(
dd
,

6283 
__func__
, 
»t
);

6284 
dÚe
;

6286 
	`£t_ho¡_lcb_acûss
(
dd
);

6288 
dd
->
lcb_acûss_couÁ
++;

6289 
dÚe
:

6290 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

6291  
»t
;

6292 
	}
}

6302 
	$»Ëa£_lcb_acûss
(
hfi1_devd©a
 *
dd
, 
¦“p_ok
)

6304 
»t
 = 0;

6311 ià(
¦“p_ok
) {

6312 
	`mu‹x_lock
(&
dd
->
µÜt
->
hls_lock
);

6314 !
	`mu‹x_Œylock
(&
dd
->
µÜt
->
hls_lock
))

6315 
	`ud–ay
(1);

6318 ià(
dd
->
lcb_acûss_couÁ
 == 0) {

6319 
	`dd_dev_”r
(
dd
, "%s: LCB‡ccess count is zero. Skipping.\n",

6320 
__func__
);

6321 
dÚe
;

6324 ià(
dd
->
lcb_acûss_couÁ
 == 1) {

6325 
	`£t_8051_lcb_acûss
(
dd
);

6326 
»t
 = 
	`»que¡_8051_lcb_acûss
(
dd
);

6327 ià(
»t
) {

6328 
	`dd_dev_”r
(
dd
,

6330 
__func__
, 
»t
);

6332 
	`£t_ho¡_lcb_acûss
(
dd
);

6333 
dÚe
;

6336 
dd
->
lcb_acûss_couÁ
--;

6337 
dÚe
:

6338 
	`mu‹x_uÆock
(&
dd
->
µÜt
->
hls_lock
);

6339  
»t
;

6340 
	}
}

6351 
	$š™_lcb_acûss
(
hfi1_devd©a
 *
dd
)

6353 
dd
->
lcb_acûss_couÁ
 = 0;

6354 
	}
}

6359 
	$h»q_»¥Ú£
(
hfi1_devd©a
 *
dd
, 
u8
 
»tuº_code
, 
u16
 
r¥_d©a
)

6361 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_0
,

6362 
DC_DC8051_CFG_EXT_DEV_0_COMPLETED_SMASK
 |

6363 (
u64
)
»tuº_code
 <<

6364 
DC_DC8051_CFG_EXT_DEV_0_RETURN_CODE_SHIFT
 |

6365 (
u64
)
r¥_d©a
 << 
DC_DC8051_CFG_EXT_DEV_0_RSP_DATA_SHIFT
);

6366 
	}
}

6371 
	$hªdË_8051_»que¡
(
hfi1_µÜtd©a
 *
µd
)

6373 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

6374 
u64
 
»g
;

6375 
u16
 
d©a
 = 0;

6376 
u8
 
ty³
;

6378 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_1
);

6379 ià((
»g
 & 
DC_DC8051_CFG_EXT_DEV_1_REQ_NEW_SMASK
) == 0)

6383 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_0
, 0);

6386 
ty³
 = (
»g
 >> 
DC_DC8051_CFG_EXT_DEV_1_REQ_TYPE_SHIFT
)

6387 & 
DC_DC8051_CFG_EXT_DEV_1_REQ_TYPE_MASK
;

6388 
d©a
 = (
»g
 >> 
DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_SHIFT
)

6389 & 
DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_MASK
;

6391 
ty³
) {

6392 
HREQ_LOAD_CONFIG
:

6393 
HREQ_SAVE_CONFIG
:

6394 
HREQ_READ_CONFIG
:

6395 
HREQ_SET_TX_EQ_ABS
:

6396 
HREQ_SET_TX_EQ_REL
:

6397 
HREQ_ENABLE
:

6398 
	`dd_dev_šfo
(
dd
, "8051„equest:„equest 0x%x‚ot supported\n",

6399 
ty³
);

6400 
	`h»q_»¥Ú£
(
dd
, 
HREQ_NOT_SUPPORTED
, 0);

6402 
HREQ_LCB_RESET
:

6404 
	`wr™e_c¤
(
dd
, 
DCC_CFG_RESET
, 
LCB_RX_FPE_TX_FPE_INTO_RESET
);

6406 ()
	`»ad_c¤
(
dd
, 
DCC_CFG_RESET
);

6408 
	`ud–ay
(1);

6410 
	`wr™e_c¤
(
dd
, 
DCC_CFG_RESET
, 
LCB_RX_FPE_TX_FPE_OUT_OF_RESET
);

6411 
	`h»q_»¥Ú£
(
dd
, 
HREQ_SUCCESS
, 0);

6414 
HREQ_CONFIG_DONE
:

6415 
	`h»q_»¥Ú£
(
dd
, 
HREQ_SUCCESS
, 0);

6418 
HREQ_INTERFACE_TEST
:

6419 
	`h»q_»¥Ú£
(
dd
, 
HREQ_SUCCESS
, 
d©a
);

6422 
	`dd_dev_”r
(
dd
, "8051„eque¡: unknowÀ»que¡ 0x%x\n", 
ty³
);

6423 
	`h»q_»¥Ú£
(
dd
, 
HREQ_NOT_SUPPORTED
, 0);

6426 
	}
}

6431 
	$£t_up_vau
(
hfi1_devd©a
 *
dd
, 
u8
 
vau
)

6433 
u64
 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
);

6436 
»g
 &ð~
SEND_CM_GLOBAL_CREDIT_AU_SMASK
;

6437 
»g
 |ð(
u64
)
vau
 << 
SEND_CM_GLOBAL_CREDIT_AU_SHIFT
;

6438 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 
»g
);

6439 
	}
}

6446 
	$£t_up_vl15
(
hfi1_devd©a
 *
dd
, 
u16
 
vl15buf
)

6448 
u64
 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
);

6451 
»g
 &ð~(
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SMASK
 |

6452 
SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SMASK
);

6458 
»g
 |ð(
u64
)
vl15buf
 << 
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SHIFT
;

6459 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 
»g
);

6465 ià(
	`uÆik–y
(
dd
->
hfi1_¢oÝ
.
mode_æag
 =ð
HFI1_PORT_SNOOP_MODE
)) {

6466 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL15
, (
u64
)(
vl15buf
 >> 1)

6467 << 
SEND_CM_CREDIT_VL15_DEDICATED_LIMIT_VL_SHIFT
);

6468 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL
, (
u64
)(
vl15buf
 >> 1)

6469 << 
SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SHIFT
);

6471 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL15
, (
u64
)
vl15buf


6472 << 
SEND_CM_CREDIT_VL15_DEDICATED_LIMIT_VL_SHIFT
);

6474 
	}
}

6480 
	$»£t_lšk_üed™s
(
hfi1_devd©a
 *
dd
)

6482 
i
;

6485 
i
 = 0; i < 
TXE_NUM_DATA_VL
; i++)

6486 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL
 + (8 * 
i
), 0);

6487 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL15
, 0);

6488 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 0);

6490 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_CM_RESET
);

6492 
dd
->
vl15buf_ÿched
 = 0;

6493 
	}
}

6496 
u32
 
	$vcu_to_cu
(
u8
 
vcu
)

6498  1 << 
vcu
;

6499 
	}
}

6502 
u8
 
	$cu_to_vcu
(
u32
 
cu
)

6504  
	`žog2
(
cu
);

6505 
	}
}

6508 
u32
 
	$vau_to_au
(
u8
 
vau
)

6510  8 * (1 << 
vau
);

6511 
	}
}

6513 
	$£t_lškup_deçuÉs
(
hfi1_µÜtd©a
 *
µd
)

6515 
µd
->
sm_Œ­_qp
 = 0x0;

6516 
µd
->
§_qp
 = 0x1;

6517 
	}
}

6522 
	$lcb_shutdown
(
hfi1_devd©a
 *
dd
, 
abÜt
)

6524 
u64
 
»g
;

6527 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_RUN
, 0);

6529 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
,

6530 1uÎ << 
DC_LCB_CFG_TX_FIFOS_RESET_VAL_SHIFT
);

6532 
dd
->
lcb_”r_’
 = 
	`»ad_c¤
(dd, 
DC_LCB_ERR_EN
);

6533 
»g
 = 
	`»ad_c¤
(
dd
, 
DCC_CFG_RESET
);

6534 
	`wr™e_c¤
(
dd
, 
DCC_CFG_RESET
, 
»g
 |

6535 
DCC_CFG_RESET_RESET_LCB
 | 
DCC_CFG_RESET_RESET_RX_FPE
);

6536 ()
	`»ad_c¤
(
dd
, 
DCC_CFG_RESET
);

6537 ià(!
abÜt
) {

6538 
	`ud–ay
(1);

6539 
	`wr™e_c¤
(
dd
, 
DCC_CFG_RESET
, 
»g
);

6540 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, dd->
lcb_”r_’
);

6542 
	}
}

6554 
	$_dc_shutdown
(
hfi1_devd©a
 *
dd
)

6556 
	`lockd•_as£¹_h–d
(&
dd
->
dc8051_lock
);

6558 ià(
dd
->
dc_shutdown
)

6561 
dd
->
dc_shutdown
 = 1;

6563 
	`lcb_shutdown
(
dd
, 1);

6569 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RST
, 0x1);

6570 
	}
}

6572 
	$dc_shutdown
(
hfi1_devd©a
 *
dd
)

6574 
	`mu‹x_lock
(&
dd
->
dc8051_lock
);

6575 
	`_dc_shutdown
(
dd
);

6576 
	`mu‹x_uÆock
(&
dd
->
dc8051_lock
);

6577 
	}
}

6585 
	$_dc_¡¬t
(
hfi1_devd©a
 *
dd
)

6587 
	`lockd•_as£¹_h–d
(&
dd
->
dc8051_lock
);

6589 ià(!
dd
->
dc_shutdown
)

6593 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RST
, 0ull);

6595 ià(
	`wa™_fm_»ady
(
dd
, 
TIMEOUT_8051_START
))

6596 
	`dd_dev_”r
(
dd
, "%s:imeout starting 8051 firmware\n",

6597 
__func__
);

6600 
	`wr™e_c¤
(
dd
, 
DCC_CFG_RESET
, 
LCB_RX_FPE_TX_FPE_OUT_OF_RESET
);

6602 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, dd->
lcb_”r_’
);

6603 
dd
->
dc_shutdown
 = 0;

6604 
	}
}

6606 
	$dc_¡¬t
(
hfi1_devd©a
 *
dd
)

6608 
	`mu‹x_lock
(&
dd
->
dc8051_lock
);

6609 
	`_dc_¡¬t
(
dd
);

6610 
	`mu‹x_uÆock
(&
dd
->
dc8051_lock
);

6611 
	}
}

6616 
	$adju¡_lcb_fÜ_åga_£rdes
(
hfi1_devd©a
 *
dd
)

6618 
u64
 
rx_¿dr
, 
tx_¿dr
;

6619 
u32
 
v”siÚ
;

6621 ià(
dd
->
icode
 !ð
ICODE_FPGA_EMULATION
)

6631 ià(
	`is_emuÏtÜ_s
(
dd
))

6635 
v”siÚ
 = 
	`emuÏtÜ_»v
(
dd
);

6636 ià(!
	`is_ax
(
dd
))

6637 
v”siÚ
 = 0x2d;

6639 ià(
v”siÚ
 <= 0x12) {

6647 
rx_¿dr
 =

6648 0xauÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT


6649 | 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT


6650 | 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
;

6655 
tx_¿dr
 = 6uÎ << 
DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
;

6656 } ià(
v”siÚ
 <= 0x18) {

6659 
rx_¿dr
 =

6660 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT


6661 | 0x8uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT


6662 | 0x8uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
;

6663 
tx_¿dr
 = 7uÎ << 
DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
;

6664 } ià(
v”siÚ
 == 0x19) {

6667 
rx_¿dr
 =

6668 0xAuÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT


6669 | 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT


6670 | 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
;

6671 
tx_¿dr
 = 3uÎ << 
DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
;

6672 } ià(
v”siÚ
 == 0x1a) {

6675 
rx_¿dr
 =

6676 0x9uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT


6677 | 0x8uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT


6678 | 0x8uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
;

6679 
tx_¿dr
 = 7uÎ << 
DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
;

6680 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LN_DCLK
, 1ull);

6684 
rx_¿dr
 =

6685 0x8uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT


6686 | 0x7uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT


6687 | 0x7uÎ << 
DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
;

6688 
tx_¿dr
 = 3uÎ << 
DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
;

6691 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_RX_FIFOS_RADR
, 
rx_¿dr
);

6693 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_IGNORE_LOST_RCLK
,

6694 
DC_LCB_CFG_IGNORE_LOST_RCLK_EN_SMASK
);

6695 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RADR
, 
tx_¿dr
);

6696 
	}
}

6703 
	$hªdË_sma_mes§ge
(
wÜk_¡ruù
 *
wÜk
)

6705 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

6706 
sma_mes§ge_wÜk
);

6707 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

6708 
u64
 
msg
;

6709 
»t
;

6715 
»t
 = 
	`»ad_idË_sma
(
dd
, &
msg
);

6716 ià(
»t
)

6718 
	`dd_dev_šfo
(
dd
, "%s: SMA mes§g0x%Îx\n", 
__func__
, 
msg
);

6722 
msg
 & 0xff) {

6723 
SMA_IDLE_ARM
:

6730 ià(
µd
->
ho¡_lšk_¡©e
 & (
HLS_UP_INIT
 | 
HLS_UP_ARMED
))

6731 
µd
->
ÃighbÜ_nÜm®
 = 1;

6733 
SMA_IDLE_ACTIVE
:

6740 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_UP_ARMED
 &&

6741 
µd
->
is_aùive_Ýtimize_’abËd
) {

6742 
µd
->
ÃighbÜ_nÜm®
 = 1;

6743 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ACTIVE
);

6744 ià(
»t
)

6745 
	`dd_dev_”r
(

6746 
dd
,

6748 
__func__
);

6752 
	`dd_dev_”r
(
dd
,

6754 
__func__
, 
msg
);

6757 
	}
}

6759 
	$adju¡_rcvù¾
(
hfi1_devd©a
 *
dd
, 
u64
 
add
, u64 
þ—r
)

6761 
u64
 
rcvù¾
;

6762 
æags
;

6764 
	`¥š_lock_œq§ve
(&
dd
->
rcvù¾_lock
, 
æags
);

6765 
rcvù¾
 = 
	`»ad_c¤
(
dd
, 
RCV_CTRL
);

6766 
rcvù¾
 |ð
add
;

6767 
rcvù¾
 &ð~
þ—r
;

6768 
	`wr™e_c¤
(
dd
, 
RCV_CTRL
, 
rcvù¾
);

6769 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
rcvù¾_lock
, 
æags
);

6770 
	}
}

6772 
šlše
 
	$add_rcvù¾
(
hfi1_devd©a
 *
dd
, 
u64
 
add
)

6774 
	`adju¡_rcvù¾
(
dd
, 
add
, 0);

6775 
	}
}

6777 
šlše
 
	$þ—r_rcvù¾
(
hfi1_devd©a
 *
dd
, 
u64
 
þ—r
)

6779 
	`adju¡_rcvù¾
(
dd
, 0, 
þ—r
);

6780 
	}
}

6785 
	$¡¬t_ä“ze_hªdlšg
(
hfi1_µÜtd©a
 *
µd
, 
æags
)

6787 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

6788 
£nd_cÚ‹xt
 *
sc
;

6789 
i
;

6790 
sc_æags
;

6792 ià(
æags
 & 
FREEZE_SELF
)

6793 
	`wr™e_c¤
(
dd
, 
CCE_CTRL
, 
CCE_CTRL_SPC_FREEZE_SMASK
);

6796 
dd
->
æags
 |ð
HFI1_FROZEN
;

6799 
	`sdma_ä“ze_nÙify
(
dd
, !!(
æags
 & 
FREEZE_LINK_DOWN
));

6801 
sc_æags
 = 
SCF_FROZEN
 | 
SCF_HALTED
 | (
æags
 & 
FREEZE_LINK_DOWN
 ?

6802 
SCF_LINK_DOWN
 : 0);

6804 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

6805 
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

6806 ià(
sc
 && (sc->
æags
 & 
SCF_ENABLED
))

6807 
	`sc_¡Ý
(
sc
, 
sc_æags
);

6811 
	`hfi1_£t_uev’t_b™s
(
µd
, 
_HFI1_EVENT_FROZEN_BIT
);

6813 ià(
æags
 & 
FREEZE_ABORT
) {

6814 
	`dd_dev_”r
(
dd
,

6819 
	`queue_wÜk
(
µd
->
hfi1_wq
, &µd->
ä“ze_wÜk
);

6820 
	}
}

6829 
	$wa™_fÜ_ä“ze_¡©us
(
hfi1_devd©a
 *
dd
, 
ä“ze
)

6831 
timeout
;

6832 
u64
 
»g
;

6834 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
FREEZE_STATUS_TIMEOUT
);

6836 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_STATUS
);

6837 ià(
ä“ze
) {

6839 ià((
»g
 & 
ALL_FROZE
) == ALL_FROZE)

6843 ià((
»g
 & 
ALL_FROZE
) == 0)

6847 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

6848 
	`dd_dev_”r
(
dd
,

6850 
ä“ze
 ? "" : "un", 
»g
 & 
ALL_FROZE
,

6851 
ä“ze
 ? 
ALL_FROZE
 : 0ull);

6854 
	`u¦“p_¿nge
(80, 120);

6856 
	}
}

6861 
	$rxe_ä“ze
(
hfi1_devd©a
 *
dd
)

6863 
i
;

6864 
hfi1_ùxtd©a
 *
rcd
;

6867 
	`þ—r_rcvù¾
(
dd
, 
RCV_CTRL_RCV_PORT_ENABLE_SMASK
);

6870 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

6871 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

6872 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_CTXT_DIS
, 
rcd
);

6873 
	`hfi1_rcd_put
(
rcd
);

6875 
	}
}

6883 
	$rxe_k”Ãl_unä“ze
(
hfi1_devd©a
 *
dd
)

6885 
u32
 
rcvmask
;

6886 
u16
 
i
;

6887 
hfi1_ùxtd©a
 *
rcd
;

6890 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

6891 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

6894 ià(!
rcd
 ||

6895 (
i
 >ð
dd
->
fœ¡_dyn_®loc_ùxt
 && !
rcd
->
is_vnic
)) {

6896 
	`hfi1_rcd_put
(
rcd
);

6899 
rcvmask
 = 
HFI1_RCVCTRL_CTXT_ENB
;

6901 
rcvmask
 |ð
	`hfi1_rcvhd¹až_kvaddr
(
rcd
) ?

6902 
HFI1_RCVCTRL_TAILUPD_ENB
 : 
HFI1_RCVCTRL_TAILUPD_DIS
;

6903 
	`hfi1_rcvù¾
(
dd
, 
rcvmask
, 
rcd
);

6904 
	`hfi1_rcd_put
(
rcd
);

6908 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_PORT_ENABLE_SMASK
);

6909 
	}
}

6916 
	$hªdË_ä“ze
(
wÜk_¡ruù
 *
wÜk
)

6918 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

6919 
ä“ze_wÜk
);

6920 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

6923 
	`wa™_fÜ_ä“ze_¡©us
(
dd
, 1);

6928 
	`pio_ä“ze
(
dd
);

6931 
	`sdma_ä“ze
(
dd
);

6936 
	`rxe_ä“ze
(
dd
);

6942 
	`wr™e_c¤
(
dd
, 
CCE_CTRL
, 
CCE_CTRL_SPC_UNFREEZE_SMASK
);

6943 
	`wa™_fÜ_ä“ze_¡©us
(
dd
, 0);

6945 ià(
	`is_ax
(
dd
)) {

6946 
	`wr™e_c¤
(
dd
, 
CCE_CTRL
, 
CCE_CTRL_SPC_FREEZE_SMASK
);

6947 
	`wa™_fÜ_ä“ze_¡©us
(
dd
, 1);

6948 
	`wr™e_c¤
(
dd
, 
CCE_CTRL
, 
CCE_CTRL_SPC_UNFREEZE_SMASK
);

6949 
	`wa™_fÜ_ä“ze_¡©us
(
dd
, 0);

6953 
	`pio_k”Ãl_unä“ze
(
dd
);

6956 
	`sdma_unä“ze
(
dd
);

6961 
	`rxe_k”Ãl_unä“ze
(
dd
);

6976 
dd
->
æags
 &ð~
HFI1_FROZEN
;

6977 
	`wake_up
(&
dd
->
ev’t_queue
);

6980 
	}
}

6991 
	$upd©e_xm™_couÁ”s
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
lšk_width
)

6993 
i
;

6994 
u16
 
tx_width
;

6995 
u16
 
lšk_¥“d
;

6997 
tx_width
 = 
	`tx_lšk_width
(
lšk_width
);

6998 
lšk_¥“d
 = 
	`g‘_lšk_¥“d
(
µd
->
lšk_¥“d_aùive
);

7004 
i
 = 0; i < 
C_VL_COUNT
 + 1; i++)

7005 
	`g‘_xm™_wa™_couÁ”s
(
µd
, 
tx_width
, 
lšk_¥“d
, 
i
);

7006 
	}
}

7013 
	$hªdË_lšk_up
(
wÜk_¡ruù
 *
wÜk
)

7015 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

7016 
lšk_up_wÜk
);

7017 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

7019 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_INIT
);

7022 
	`»ad_Ép_¹t
(
dd
);

7027 
	`þ—r_lškup_couÁ”s
(
dd
);

7031 
	`£t_lškup_deçuÉs
(
µd
);

7039 ià(!(
quick_lškup
 || 
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
))

7040 
	`£t_up_vl15
(
dd
, dd->
vl15buf_ÿched
);

7043 ià((
µd
->
lšk_¥“d_aùive
 &…pd->
lšk_¥“d_’abËd
) == 0) {

7045 
	`dd_dev_”r
(
dd
,

7047 
µd
->
lšk_¥“d_aùive
,…pd->
lšk_¥“d_’abËd
);

7048 
	`£t_lšk_down_»asÚ
(
µd
, 
OPA_LINKDOWN_REASON_SPEED_POLICY
, 0,

7049 
OPA_LINKDOWN_REASON_SPEED_POLICY
);

7050 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

7051 
	`¡¬t_lšk
(
µd
);

7053 
	}
}

7059 
	$»£t_ÃighbÜ_šfo
(
hfi1_µÜtd©a
 *
µd
)

7061 
µd
->
ÃighbÜ_guid
 = 0;

7062 
µd
->
ÃighbÜ_pÜt_numb”
 = 0;

7063 
µd
->
ÃighbÜ_ty³
 = 0;

7064 
µd
->
ÃighbÜ_fm_£cur™y
 = 0;

7065 
	}
}

7067 cÚ¡ * cÚ¡ 
	glšk_down_»asÚ_¡rs
[] = {

7068 [
OPA_LINKDOWN_REASON_NONE
] = "None",

7069 [
OPA_LINKDOWN_REASON_RCV_ERROR_0
] = "Receiveƒrror 0",

7070 [
OPA_LINKDOWN_REASON_BAD_PKT_LEN
] = "Bad…acket†ength",

7071 [
OPA_LINKDOWN_REASON_PKT_TOO_LONG
] = "Packetoo†ong",

7072 [
OPA_LINKDOWN_REASON_PKT_TOO_SHORT
] = "Packetoo short",

7073 [
OPA_LINKDOWN_REASON_BAD_SLID
] = "Bad SLID",

7074 [
OPA_LINKDOWN_REASON_BAD_DLID
] = "Bad DLID",

7075 [
OPA_LINKDOWN_REASON_BAD_L2
] = "Bad L2",

7076 [
OPA_LINKDOWN_REASON_BAD_SC
] = "Bad SC",

7077 [
OPA_LINKDOWN_REASON_RCV_ERROR_8
] = "Receiveƒrror 8",

7078 [
OPA_LINKDOWN_REASON_BAD_MID_TAIL
] = "Bad midail",

7079 [
OPA_LINKDOWN_REASON_RCV_ERROR_10
] = "Receiveƒrror 10",

7080 [
OPA_LINKDOWN_REASON_PREEMPT_ERROR
] = "Preemptƒrror",

7081 [
OPA_LINKDOWN_REASON_PREEMPT_VL15
] = "Preempt vl15",

7082 [
OPA_LINKDOWN_REASON_BAD_VL_MARKER
] = "Bad VL marker",

7083 [
OPA_LINKDOWN_REASON_RCV_ERROR_14
] = "Receiveƒrror 14",

7084 [
OPA_LINKDOWN_REASON_RCV_ERROR_15
] = "Receiveƒrror 15",

7085 [
OPA_LINKDOWN_REASON_BAD_HEAD_DIST
] = "Bad head distance",

7086 [
OPA_LINKDOWN_REASON_BAD_TAIL_DIST
] = "Badail distance",

7087 [
OPA_LINKDOWN_REASON_BAD_CTRL_DIST
] = "Bad control distance",

7088 [
OPA_LINKDOWN_REASON_BAD_CREDIT_ACK
] = "Bad credit‡ck",

7089 [
OPA_LINKDOWN_REASON_UNSUPPORTED_VL_MARKER
] = "Unsupported VL marker",

7090 [
OPA_LINKDOWN_REASON_BAD_PREEMPT
] = "Bad…reempt",

7091 [
OPA_LINKDOWN_REASON_BAD_CONTROL_FLIT
] = "Bad control flit",

7092 [
OPA_LINKDOWN_REASON_EXCEED_MULTICAST_LIMIT
] = "Exceed multicast†imit",

7093 [
OPA_LINKDOWN_REASON_RCV_ERROR_24
] = "Receiveƒrror 24",

7094 [
OPA_LINKDOWN_REASON_RCV_ERROR_25
] = "Receiveƒrror 25",

7095 [
OPA_LINKDOWN_REASON_RCV_ERROR_26
] = "Receiveƒrror 26",

7096 [
OPA_LINKDOWN_REASON_RCV_ERROR_27
] = "Receiveƒrror 27",

7097 [
OPA_LINKDOWN_REASON_RCV_ERROR_28
] = "Receiveƒrror 28",

7098 [
OPA_LINKDOWN_REASON_RCV_ERROR_29
] = "Receiveƒrror 29",

7099 [
OPA_LINKDOWN_REASON_RCV_ERROR_30
] = "Receiveƒrror 30",

7100 [
OPA_LINKDOWN_REASON_EXCESSIVE_BUFFER_OVERRUN
] =

7102 [
OPA_LINKDOWN_REASON_UNKNOWN
] = "Unknown",

7103 [
OPA_LINKDOWN_REASON_REBOOT
] = "Reboot",

7104 [
OPA_LINKDOWN_REASON_NEIGHBOR_UNKNOWN
] = "Neighbor unknown",

7105 [
OPA_LINKDOWN_REASON_FM_BOUNCE
] = "FM bounce",

7106 [
OPA_LINKDOWN_REASON_SPEED_POLICY
] = "Speed…olicy",

7107 [
OPA_LINKDOWN_REASON_WIDTH_POLICY
] = "Width…olicy",

7108 [
OPA_LINKDOWN_REASON_DISCONNECTED
] = "Disconnected",

7109 [
OPA_LINKDOWN_REASON_LOCAL_MEDIA_NOT_INSTALLED
] =

7111 [
OPA_LINKDOWN_REASON_NOT_INSTALLED
] = "Not installed",

7112 [
OPA_LINKDOWN_REASON_CHASSIS_CONFIG
] = "Chassis config",

7113 [
OPA_LINKDOWN_REASON_END_TO_END_NOT_INSTALLED
] =

7115 [
OPA_LINKDOWN_REASON_POWER_POLICY
] = "Power…olicy",

7116 [
OPA_LINKDOWN_REASON_LINKSPEED_POLICY
] = "Link speed…olicy",

7117 [
OPA_LINKDOWN_REASON_LINKWIDTH_POLICY
] = "Link width…olicy",

7118 [
OPA_LINKDOWN_REASON_SWITCH_MGMT
] = "Switch management",

7119 [
OPA_LINKDOWN_REASON_SMA_DISABLED
] = "SMA disabled",

7120 [
OPA_LINKDOWN_REASON_TRANSIENT
] = "Transient"

7124 cÚ¡ *
	$lšk_down_»asÚ_¡r
(
u8
 
»asÚ
)

7126 cÚ¡ *
¡r
 = 
NULL
;

7128 ià(
»asÚ
 < 
	`ARRAY_SIZE
(
lšk_down_»asÚ_¡rs
))

7129 
¡r
 = 
lšk_down_»asÚ_¡rs
[
»asÚ
];

7130 ià(!
¡r
)

7131 
¡r
 = "(invalid)";

7133  
¡r
;

7134 
	}
}

7141 
	$hªdË_lšk_down
(
wÜk_¡ruù
 *
wÜk
)

7143 
u8
 
lþ_»asÚ
, 
Ãigh_»asÚ
 = 0;

7144 
u8
 
lšk_down_»asÚ
;

7145 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

7146 
lšk_down_wÜk
);

7147 
was_up
;

7148 cÚ¡ 
ldr_¡r
[] = "Link down„eason: ";

7150 ià((
µd
->
ho¡_lšk_¡©e
 &

7151 (
HLS_DN_POLL
 | 
HLS_VERIFY_CAP
 | 
HLS_GOING_UP
)) &&

7152 
µd
->
pÜt_ty³
 =ð
PORT_TYPE_FIXED
)

7153 
µd
->
ofæše_di§bËd_»asÚ
 =

7154 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NOT_INSTALLED
);

7157 
was_up
 = !!(
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
);

7158 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

7159 
	`xchg
(&
µd
->
is_lšk_down_queued
, 0);

7161 ià(
was_up
) {

7162 
lþ_»asÚ
 = 0;

7164 
	`»ad_lšk_down_»asÚ
(
µd
->
dd
, &
lšk_down_»asÚ
);

7165 
lšk_down_»asÚ
) {

7166 
LDR_LINK_TRANSFER_ACTIVE_LOW
:

7168 
	`dd_dev_šfo
(
µd
->
dd
, "%sUnexpected†ink down\n",

7169 
ldr_¡r
);

7171 
LDR_RECEIVED_LINKDOWN_IDLE_MSG
:

7176 
	`»ad_¶ªÃd_down_»asÚ_code
(
µd
->
dd
, &
Ãigh_»asÚ
);

7177 
	`dd_dev_šfo
(
µd
->
dd
,

7179 
ldr_¡r
, 
Ãigh_»asÚ
,

7180 
	`lšk_down_»asÚ_¡r
(
Ãigh_»asÚ
));

7182 
LDR_RECEIVED_HOST_OFFLINE_REQ
:

7183 
	`dd_dev_šfo
(
µd
->
dd
,

7185 
ldr_¡r
);

7188 
	`dd_dev_šfo
(
µd
->
dd
, "%sUnknown„eason 0x%x\n",

7189 
ldr_¡r
, 
lšk_down_»asÚ
);

7197 ià(
Ãigh_»asÚ
 == 0)

7198 
lþ_»asÚ
 = 
OPA_LINKDOWN_REASON_NEIGHBOR_UNKNOWN
;

7201 
lþ_»asÚ
 = 
OPA_LINKDOWN_REASON_TRANSIENT
;

7204 
	`£t_lšk_down_»asÚ
(
µd
, 
lþ_»asÚ
, 
Ãigh_»asÚ
, 0);

7207 ià(
was_up
 && 
µd
->
loÿl_lšk_down_»asÚ
.
sma
 == 0 &&

7208 
µd
->
Ãigh_lšk_down_»asÚ
.
sma
 == 0) {

7209 
µd
->
loÿl_lšk_down_»asÚ
.
sma
 =

7210 
µd
->
loÿl_lšk_down_»asÚ
.
Ï‹¡
;

7211 
µd
->
Ãigh_lšk_down_»asÚ
.
sma
 =

7212 
µd
->
Ãigh_lšk_down_»asÚ
.
Ï‹¡
;

7215 
	`»£t_ÃighbÜ_šfo
(
µd
);

7218 
	`þ—r_rcvù¾
(
µd
->
dd
, 
RCV_CTRL_RCV_PORT_ENABLE_SMASK
);

7224 ià(
µd
->
pÜt_ty³
 =ð
PORT_TYPE_QSFP
 && !
	`qså_mod_´e£Á
(ppd))

7225 
	`dc_shutdown
(
µd
->
dd
);

7227 
	`¡¬t_lšk
(
µd
);

7228 
	}
}

7230 
	$hªdË_lšk_bounû
(
wÜk_¡ruù
 *
wÜk
)

7232 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

7233 
lšk_bounû_wÜk
);

7238 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
) {

7239 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

7240 
	`¡¬t_lšk
(
µd
);

7242 
	`dd_dev_šfo
(
µd
->
dd
, "%s:†ink‚ot up (%s),‚othingo do\n",

7243 
__func__
, 
	`lšk_¡©e_Çme
(
µd
->
ho¡_lšk_¡©e
));

7245 
	}
}

7251 
	$ÿp_to_pÜt_Ép
(
ÿp
)

7253 
pÜt_Ép
 = 
PORT_LTP_CRC_MODE_16
;

7255 ià(
ÿp
 & 
CAP_CRC_14B
)

7256 
pÜt_Ép
 |ð
PORT_LTP_CRC_MODE_14
;

7257 ià(
ÿp
 & 
CAP_CRC_48B
)

7258 
pÜt_Ép
 |ð
PORT_LTP_CRC_MODE_48
;

7259 ià(
ÿp
 & 
CAP_CRC_12B_16B_PER_LANE
)

7260 
pÜt_Ép
 |ð
PORT_LTP_CRC_MODE_PER_LANE
;

7262  
pÜt_Ép
;

7263 
	}
}

7268 
	$pÜt_Ép_to_ÿp
(
pÜt_Ép
)

7270 
ÿp_mask
 = 0;

7272 ià(
pÜt_Ép
 & 
PORT_LTP_CRC_MODE_14
)

7273 
ÿp_mask
 |ð
CAP_CRC_14B
;

7274 ià(
pÜt_Ép
 & 
PORT_LTP_CRC_MODE_48
)

7275 
ÿp_mask
 |ð
CAP_CRC_48B
;

7276 ià(
pÜt_Ép
 & 
PORT_LTP_CRC_MODE_PER_LANE
)

7277 
ÿp_mask
 |ð
CAP_CRC_12B_16B_PER_LANE
;

7279  
ÿp_mask
;

7280 
	}
}

7285 
	$lcb_to_pÜt_Ép
(
lcb_üc
)

7287 
pÜt_Ép
 = 0;

7289 ià(
lcb_üc
 =ð
LCB_CRC_12B_16B_PER_LANE
)

7290 
pÜt_Ép
 = 
PORT_LTP_CRC_MODE_PER_LANE
;

7291 ià(
lcb_üc
 =ð
LCB_CRC_48B
)

7292 
pÜt_Ép
 = 
PORT_LTP_CRC_MODE_48
;

7293 ià(
lcb_üc
 =ð
LCB_CRC_14B
)

7294 
pÜt_Ép
 = 
PORT_LTP_CRC_MODE_14
;

7296 
pÜt_Ép
 = 
PORT_LTP_CRC_MODE_16
;

7298  
pÜt_Ép
;

7299 
	}
}

7309 
	$add_fuÎ_mgmt_pkey
(
hfi1_µÜtd©a
 *
µd
)

7311 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

7314 ià(!((
µd
->
pkeys
[2] =ð0è|| (µd->pkeys[2] =ð
FULL_MGMT_P_KEY
)))

7315 
	`dd_dev_w¬n
(
dd
, "%s…key[2]‡lready seto 0x%x,„esetting ito 0x%x\n",

7316 
__func__
, 
µd
->
pkeys
[2], 
FULL_MGMT_P_KEY
);

7317 
µd
->
pkeys
[2] = 
FULL_MGMT_P_KEY
;

7318 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_PKEYS
, 0);

7319 
	`hfi1_ev’t_pkey_chªge
(
µd
->
dd
,…pd->
pÜt
);

7320 
	}
}

7322 
	$þ—r_fuÎ_mgmt_pkey
(
hfi1_µÜtd©a
 *
µd
)

7324 ià(
µd
->
pkeys
[2] != 0) {

7325 
µd
->
pkeys
[2] = 0;

7326 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_PKEYS
, 0);

7327 
	`hfi1_ev’t_pkey_chªge
(
µd
->
dd
,…pd->
pÜt
);

7329 
	}
}

7334 
u16
 
	$lšk_width_to_b™s
(
hfi1_devd©a
 *
dd
, 
u16
 
width
)

7336 
width
) {

7342 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
 || 
quick_lškup
)

7343  
OPA_LINK_WIDTH_4X
;

7345 1:  
OPA_LINK_WIDTH_1X
;

7346 2:  
OPA_LINK_WIDTH_2X
;

7347 3:  
OPA_LINK_WIDTH_3X
;

7349 
	`dd_dev_šfo
(
dd
, "%s: invalid width %d, using 4\n",

7350 
__func__
, 
width
);

7352 4:  
OPA_LINK_WIDTH_4X
;

7354 
	}
}

7359 cÚ¡ 
u8
 
	gb™_couÁs
[16] = {

7363 
šlše
 
u8
 
	$nibbË_to_couÁ
(
u8
 
nibbË
)

7365  
b™_couÁs
[
nibbË
 & 0xf];

7366 
	}
}

7376 
	$g‘_lšk_widths
(
hfi1_devd©a
 *
dd
, 
u16
 *
tx_width
,

7377 
u16
 *
rx_width
)

7379 
u16
 
tx
, 
rx
;

7380 
u8
 
’abË_ÏÃ_rx
;

7381 
u8
 
’abË_ÏÃ_tx
;

7382 
u8
 
tx_pÞ¬™y_šv”siÚ
;

7383 
u8
 
rx_pÞ¬™y_šv”siÚ
;

7384 
u8
 
max_¿‹
;

7387 
	`»ad_tx_£‰šgs
(
dd
, &
’abË_ÏÃ_tx
, &
tx_pÞ¬™y_šv”siÚ
,

7388 &
rx_pÞ¬™y_šv”siÚ
, &
max_¿‹
);

7389 
	`»ad_loÿl_Êi
(
dd
, &
’abË_ÏÃ_rx
);

7392 
tx
 = 
	`nibbË_to_couÁ
(
’abË_ÏÃ_tx
);

7393 
rx
 = 
	`nibbË_to_couÁ
(
’abË_ÏÃ_rx
);

7400 ià((
dd
->
icode
 =ð
ICODE_RTL_SILICON
) &&

7401 (
dd
->
dc8051_v”
 < 
	`dc8051_v”
(0, 19, 0))) {

7403 
max_¿‹
) {

7405 
dd
->
µÜt
[0].
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_12_5G
;

7408 
	`dd_dev_”r
(
dd
,

7410 
__func__
, ()
max_¿‹
);

7413 
dd
->
µÜt
[0].
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_25G
;

7418 
	`dd_dev_šfo
(
dd
,

7420 
’abË_ÏÃ_tx
, 
tx
, 
’abË_ÏÃ_rx
, 
rx
);

7421 *
tx_width
 = 
	`lšk_width_to_b™s
(
dd
, 
tx
);

7422 *
rx_width
 = 
	`lšk_width_to_b™s
(
dd
, 
rx
);

7423 
	}
}

7438 
	$g‘_lškup_widths
(
hfi1_devd©a
 *
dd
, 
u16
 *
tx_width
,

7439 
u16
 *
rx_width
)

7441 
u16
 
widths
, 
tx
, 
rx
;

7442 
u8
 
misc_b™s
, 
loÿl_æags
;

7443 
u16
 
aùive_tx
, 
aùive_rx
;

7445 
	`»ad_vc_loÿl_lšk_mode
(
dd
, &
misc_b™s
, &
loÿl_æags
, &
widths
);

7446 
tx
 = 
widths
 >> 12;

7447 
rx
 = (
widths
 >> 8) & 0xf;

7449 *
tx_width
 = 
	`lšk_width_to_b™s
(
dd
, 
tx
);

7450 *
rx_width
 = 
	`lšk_width_to_b™s
(
dd
, 
rx
);

7453 
	`g‘_lšk_widths
(
dd
, &
aùive_tx
, &
aùive_rx
);

7454 
	}
}

7464 
	$g‘_lškup_lšk_widths
(
hfi1_µÜtd©a
 *
µd
)

7466 
u16
 
tx_width
, 
rx_width
;

7469 
	`g‘_lškup_widths
(
µd
->
dd
, &
tx_width
, &
rx_width
);

7472 
µd
->
lšk_width_aùive
 = 
tx_width
;

7474 
µd
->
lšk_width_downg¿de_tx_aùive
 =…pd->
lšk_width_aùive
;

7475 
µd
->
lšk_width_downg¿de_rx_aùive
 =…pd->
lšk_width_aùive
;

7477 
µd
->
lšk_width_downg¿de_’abËd
 =…pd->
lšk_width_downg¿de_suµÜ‹d
;

7479 
µd
->
cu¼’t_eg»ss_¿‹
 = 
	`aùive_eg»ss_¿‹
(ppd);

7480 
	}
}

7487 
	$hªdË_v”ify_ÿp
(
wÜk_¡ruù
 *
wÜk
)

7489 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

7490 
lšk_vc_wÜk
);

7491 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

7492 
u64
 
»g
;

7493 
u8
 
pow”_mªagem’t
;

7494 
u8
 
cÚtšuous
;

7495 
u8
 
vcu
;

7496 
u8
 
vau
;

7497 
u8
 
z
;

7498 
u16
 
vl15buf
;

7499 
u16
 
lšk_widths
;

7500 
u16
 
üc_mask
;

7501 
u16
 
üc_v®
;

7502 
u16
 
deviû_id
;

7503 
u16
 
aùive_tx
, 
aùive_rx
;

7504 
u8
 
·¹Ãr_suµÜ‹d_üc
;

7505 
u8
 
»mÙe_tx_¿‹
;

7506 
u8
 
deviû_»v
;

7508 
	`£t_lšk_¡©e
(
µd
, 
HLS_VERIFY_CAP
);

7510 
	`lcb_shutdown
(
dd
, 0);

7511 
	`adju¡_lcb_fÜ_åga_£rdes
(
dd
);

7513 
	`»ad_vc_»mÙe_phy
(
dd
, &
pow”_mªagem’t
, &
cÚtšuous
);

7514 
	`»ad_vc_»mÙe_çbric
(
dd
, &
vau
, &
z
, &
vcu
, &
vl15buf
,

7515 &
·¹Ãr_suµÜ‹d_üc
);

7516 
	`»ad_vc_»mÙe_lšk_width
(
dd
, &
»mÙe_tx_¿‹
, &
lšk_widths
);

7517 
	`»ad_»mÙe_deviû_id
(
dd
, &
deviû_id
, &
deviû_»v
);

7522 
	`»ad_mgmt_®lowed
(
dd
, &
µd
->
mgmt_®lowed
);

7524 
	`g‘_lšk_widths
(
dd
, &
aùive_tx
, &
aùive_rx
);

7525 
	`dd_dev_šfo
(
dd
,

7527 ()
pow”_mªagem’t
, ()
cÚtšuous
);

7528 
	`dd_dev_šfo
(
dd
,

7530 ()
vau
, ()
z
, ()
vcu
, ()
vl15buf
,

7531 ()
·¹Ãr_suµÜ‹d_üc
);

7532 
	`dd_dev_šfo
(
dd
, "Peer Link Width:x„ate 0x%x, widths 0x%x\n",

7533 (
u32
)
»mÙe_tx_¿‹
, (u32)
lšk_widths
);

7534 
	`dd_dev_šfo
(
dd
, "Peer Device ID: 0x%04x, Revision 0x%02x\n",

7535 (
u32
)
deviû_id
, (u32)
deviû_»v
);

7545 ià(
vau
 == 0)

7546 
vau
 = 1;

7547 
	`£t_up_vau
(
dd
, 
vau
);

7553 
	`£t_up_vl15
(
dd
, 0);

7554 
dd
->
vl15buf_ÿched
 = 
vl15buf
;

7557 
üc_mask
 = 
µd
->
pÜt_üc_mode_’abËd
 & 
·¹Ãr_suµÜ‹d_üc
;

7560 ià(
üc_mask
 & 
CAP_CRC_14B
)

7561 
üc_v®
 = 
LCB_CRC_14B
;

7562 ià(
üc_mask
 & 
CAP_CRC_48B
)

7563 
üc_v®
 = 
LCB_CRC_48B
;

7564 ià(
üc_mask
 & 
CAP_CRC_12B_16B_PER_LANE
)

7565 
üc_v®
 = 
LCB_CRC_12B_16B_PER_LANE
;

7567 
üc_v®
 = 
LCB_CRC_16B
;

7569 
	`dd_dev_šfo
(
dd
, "Fš® LCB CRC mode: %d\n", ()
üc_v®
);

7570 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_CRC_MODE
,

7571 (
u64
)
üc_v®
 << 
DC_LCB_CFG_CRC_MODE_TX_VAL_SHIFT
);

7574 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_CTRL
);

7575 ià(
üc_v®
 =ð
LCB_CRC_14B
 && 
üc_14b_sidebªd
) {

7576 
	`wr™e_c¤
(
dd
, 
SEND_CM_CTRL
,

7577 
»g
 | 
SEND_CM_CTRL_FORCE_CREDIT_MODE_SMASK
);

7579 
	`wr™e_c¤
(
dd
, 
SEND_CM_CTRL
,

7580 
»g
 & ~
SEND_CM_CTRL_FORCE_CREDIT_MODE_SMASK
);

7583 
µd
->
lšk_¥“d_aùive
 = 0;

7584 ià(
dd
->
dc8051_v”
 < 
	`dc8051_v”
(0, 20, 0)) {

7586 
»mÙe_tx_¿‹
) {

7588 
µd
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_12_5G
;

7591 
µd
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_25G
;

7596 
u8
 
¿‹
 = 
»mÙe_tx_¿‹
 & 
µd
->
loÿl_tx_¿‹
;

7598 ià(
¿‹
 & 2)

7599 
µd
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_25G
;

7600 ià(
¿‹
 & 1)

7601 
µd
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_12_5G
;

7603 ià(
µd
->
lšk_¥“d_aùive
 == 0) {

7604 
	`dd_dev_”r
(
dd
, "%s: unexpected„emotex„ate %d, using 25Gb\n",

7605 
__func__
, ()
»mÙe_tx_¿‹
);

7606 
µd
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_25G
;

7616 
µd
->
pÜt_Ép_üc_mode
 = 
	`ÿp_to_pÜt_Ép
(
lšk_üc_mask
) << 8;

7618 
µd
->
pÜt_Ép_üc_mode
 |=

7619 
	`ÿp_to_pÜt_Ép
(
µd
->
pÜt_üc_mode_’abËd
) << 4;

7621 
µd
->
pÜt_Ép_üc_mode
 |ð
	`lcb_to_pÜt_Ép
(
üc_v®
);

7625 
	`assign_»mÙe_cm_au_bË
(
dd
, 
vcu
);

7636 ià(
	`is_ax
(
dd
)) {

7637 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_LCB_CFG_LINK_KILL_EN
);

7638 
»g
 |ð
DC_LCB_CFG_LINK_KILL_EN_REPLAY_BUF_MBE_SMASK


7639 | 
DC_LCB_CFG_LINK_KILL_EN_FLIT_INPUT_BUF_MBE_SMASK
;

7640 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LINK_KILL_EN
, 
»g
);

7644 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 0);

7647 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, 0);

7648 
	`£t_8051_lcb_acûss
(
dd
);

7650 ià(
µd
->
mgmt_®lowed
)

7651 
	`add_fuÎ_mgmt_pkey
(
µd
);

7654 
	`£t_lšk_¡©e
(
µd
, 
HLS_GOING_UP
);

7655 
	}
}

7672 
boÞ
 
	$­¶y_lšk_downg¿de_pÞicy
(
hfi1_µÜtd©a
 *
µd
,

7673 
boÞ
 
»äesh_widths
)

7675 
do_bounû
 = 0;

7676 
Œ›s
;

7677 
u16
 
lwde
;

7678 
u16
 
tx
, 
rx
;

7679 
boÞ
 
lšk_downg¿ded
 = 
»äesh_widths
;

7682 
Œ›s
 = 0;

7683 
»Œy
:

7684 
	`mu‹x_lock
(&
µd
->
hls_lock
);

7686 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_DOWN
) {

7688 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_GOING_UP
) {

7689 ià(++
Œ›s
 < 1000) {

7690 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

7691 
	`u¦“p_¿nge
(100, 120);

7692 
»Œy
;

7694 
	`dd_dev_”r
(
µd
->
dd
,

7696 
__func__
);

7698 
dÚe
;

7701 
lwde
 = 
µd
->
lšk_width_downg¿de_’abËd
;

7703 ià(
»äesh_widths
) {

7704 
	`g‘_lšk_widths
(
µd
->
dd
, &
tx
, &
rx
);

7705 
µd
->
lšk_width_downg¿de_tx_aùive
 = 
tx
;

7706 
µd
->
lšk_width_downg¿de_rx_aùive
 = 
rx
;

7709 ià(
µd
->
lšk_width_downg¿de_tx_aùive
 == 0 ||

7710 
µd
->
lšk_width_downg¿de_rx_aùive
 == 0) {

7712 
	`dd_dev_”r
(
µd
->
dd
, "Link downgrade is„eally‡†ink down, ignoring\n");

7713 
lšk_downg¿ded
 = 
çl£
;

7714 } ià(
lwde
 == 0) {

7718 ià((
µd
->
lšk_width_aùive
 !=

7719 
µd
->
lšk_width_downg¿de_tx_aùive
) ||

7720 (
µd
->
lšk_width_aùive
 !=

7721 
µd
->
lšk_width_downg¿de_rx_aùive
)) {

7722 
	`dd_dev_”r
(
µd
->
dd
,

7724 
	`dd_dev_”r
(
µd
->
dd
,

7726 
µd
->
lšk_width_aùive
,

7727 
µd
->
lšk_width_downg¿de_tx_aùive
,

7728 
µd
->
lšk_width_downg¿de_rx_aùive
);

7729 
do_bounû
 = 1;

7730 
lšk_downg¿ded
 = 
çl£
;

7732 } ià((
lwde
 & 
µd
->
lšk_width_downg¿de_tx_aùive
) == 0 ||

7733 (
lwde
 & 
µd
->
lšk_width_downg¿de_rx_aùive
) == 0) {

7735 
	`dd_dev_”r
(
µd
->
dd
,

7737 
	`dd_dev_”r
(
µd
->
dd
,

7739 
lwde
, 
µd
->
lšk_width_downg¿de_tx_aùive
,

7740 
µd
->
lšk_width_downg¿de_rx_aùive
);

7741 
do_bounû
 = 1;

7742 
lšk_downg¿ded
 = 
çl£
;

7745 
dÚe
:

7746 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

7748 ià(
do_bounû
) {

7749 
	`£t_lšk_down_»asÚ
(
µd
, 
OPA_LINKDOWN_REASON_WIDTH_POLICY
, 0,

7750 
OPA_LINKDOWN_REASON_WIDTH_POLICY
);

7751 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

7752 
	`¡¬t_lšk
(
µd
);

7755  
lšk_downg¿ded
;

7756 
	}
}

7763 
	$hªdË_lšk_downg¿de
(
wÜk_¡ruù
 *
wÜk
)

7765 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

7766 
lšk_downg¿de_wÜk
);

7768 
	`dd_dev_šfo
(
µd
->
dd
, "8051: Link width downgrade\n");

7769 ià(
	`­¶y_lšk_downg¿de_pÞicy
(
µd
, 
Œue
))

7770 
	`upd©e_xm™_couÁ”s
(
µd
,…pd->
lšk_width_downg¿de_tx_aùive
);

7771 
	}
}

7773 *
	$dcc_”r_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

7775  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
dcc_”r_æags
,

7776 
	`ARRAY_SIZE
(
dcc_”r_æags
));

7777 
	}
}

7779 *
	$lcb_”r_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

7781  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
lcb_”r_æags
,

7782 
	`ARRAY_SIZE
(
lcb_”r_æags
));

7783 
	}
}

7785 *
	$dc8051_”r_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

7787  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
dc8051_”r_æags
,

7788 
	`ARRAY_SIZE
(
dc8051_”r_æags
));

7789 
	}
}

7791 *
	$dc8051_šfo_”r_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

7793  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
dc8051_šfo_”r_æags
,

7794 
	`ARRAY_SIZE
(
dc8051_šfo_”r_æags
));

7795 
	}
}

7797 *
	$dc8051_šfo_ho¡_msg_¡ršg
(*
buf
, 
buf_Ën
, 
u64
 
æags
)

7799  
	`æag_¡ršg
(
buf
, 
buf_Ën
, 
æags
, 
dc8051_šfo_ho¡_msg_æags
,

7800 
	`ARRAY_SIZE
(
dc8051_šfo_ho¡_msg_æags
));

7801 
	}
}

7803 
	$hªdË_8051_š‹¼u±
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

7805 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

7806 
u64
 
šfo
, 
”r
, 
ho¡_msg
;

7807 
queue_lšk_down
 = 0;

7808 
buf
[96];

7811 ià(
»g
 & 
DC_DC8051_ERR_FLG_SET_BY_8051_SMASK
) {

7814 
šfo
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_DBG_ERR_INFO_SET_BY_8051
);

7815 
”r
 = (
šfo
 >> 
DC_DC8051_DBG_ERR_INFO_SET_BY_8051_ERROR_SHIFT
)

7816 & 
DC_DC8051_DBG_ERR_INFO_SET_BY_8051_ERROR_MASK
;

7817 
ho¡_msg
 = (
šfo
 >>

7818 
DC_DC8051_DBG_ERR_INFO_SET_BY_8051_HOST_MSG_SHIFT
)

7819 & 
DC_DC8051_DBG_ERR_INFO_SET_BY_8051_HOST_MSG_MASK
;

7824 ià(
”r
 & 
FAILED_LNI
) {

7831 ià(
µd
->
ho¡_lšk_¡©e


7832 & (
HLS_DN_POLL
 | 
HLS_VERIFY_CAP
 | 
HLS_GOING_UP
)) {

7833 
queue_lšk_down
 = 1;

7834 
	`dd_dev_šfo
(
dd
, "Linkƒrror: %s\n",

7835 
	`dc8051_šfo_”r_¡ršg
(
buf
,

7836 (
buf
),

7837 
”r
 &

7838 
FAILED_LNI
));

7840 
”r
 &ð~(
u64
)
FAILED_LNI
;

7843 ià(
”r
 & 
UNKNOWN_FRAME
) {

7844 
µd
->
unknown_äame_couÁ
++;

7845 
”r
 &ð~(
u64
)
UNKNOWN_FRAME
;

7847 ià(
”r
) {

7849 
	`dd_dev_”r
(
dd
, "8051 infoƒrror: %s\n",

7850 
	`dc8051_šfo_”r_¡ršg
(
buf
, (buf),

7851 
”r
));

7857 ià(
ho¡_msg
 & 
HOST_REQ_DONE
) {

7867 
ho¡_msg
 &ð~(
u64
)
HOST_REQ_DONE
;

7869 ià(
ho¡_msg
 & 
BC_SMA_MSG
) {

7870 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
sma_mes§ge_wÜk
);

7871 
ho¡_msg
 &ð~(
u64
)
BC_SMA_MSG
;

7873 ià(
ho¡_msg
 & 
LINKUP_ACHIEVED
) {

7874 
	`dd_dev_šfo
(
dd
, "8051: Link up\n");

7875 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_up_wÜk
);

7876 
ho¡_msg
 &ð~(
u64
)
LINKUP_ACHIEVED
;

7878 ià(
ho¡_msg
 & 
EXT_DEVICE_CFG_REQ
) {

7879 
	`hªdË_8051_»que¡
(
µd
);

7880 
ho¡_msg
 &ð~(
u64
)
EXT_DEVICE_CFG_REQ
;

7882 ià(
ho¡_msg
 & 
VERIFY_CAP_FRAME
) {

7883 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_vc_wÜk
);

7884 
ho¡_msg
 &ð~(
u64
)
VERIFY_CAP_FRAME
;

7886 ià(
ho¡_msg
 & 
LINK_GOING_DOWN
) {

7887 cÚ¡ *
exŒa
 = "";

7889 ià(
ho¡_msg
 & 
LINK_WIDTH_DOWNGRADED
) {

7890 
ho¡_msg
 &ð~(
u64
)
LINK_WIDTH_DOWNGRADED
;

7891 
exŒa
 = " (ignoring downgrade)";

7893 
	`dd_dev_šfo
(
dd
, "8051: Lšk down%s\n", 
exŒa
);

7894 
queue_lšk_down
 = 1;

7895 
ho¡_msg
 &ð~(
u64
)
LINK_GOING_DOWN
;

7897 ià(
ho¡_msg
 & 
LINK_WIDTH_DOWNGRADED
) {

7898 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_downg¿de_wÜk
);

7899 
ho¡_msg
 &ð~(
u64
)
LINK_WIDTH_DOWNGRADED
;

7901 ià(
ho¡_msg
) {

7903 
	`dd_dev_šfo
(
dd
, "8051 info host message: %s\n",

7904 
	`dc8051_šfo_ho¡_msg_¡ršg
(
buf
,

7905 (
buf
),

7906 
ho¡_msg
));

7909 
»g
 &ð~
DC_DC8051_ERR_FLG_SET_BY_8051_SMASK
;

7911 ià(
»g
 & 
DC_DC8051_ERR_FLG_LOST_8051_HEART_BEAT_SMASK
) {

7917 
	`dd_dev_”r
(
dd
, "Lost 8051 heartbeat\n");

7918 
	`wr™e_c¤
(
dd
, 
DC_DC8051_ERR_EN
,

7919 
	`»ad_c¤
(
dd
, 
DC_DC8051_ERR_EN
) &

7920 ~
DC_DC8051_ERR_EN_LOST_8051_HEART_BEAT_SMASK
);

7922 
»g
 &ð~
DC_DC8051_ERR_FLG_LOST_8051_HEART_BEAT_SMASK
;

7924 ià(
»g
) {

7926 
	`dd_dev_”r
(
dd
, "8051ƒrror: %s\n",

7927 
	`dc8051_”r_¡ršg
(
buf
, (buf), 
»g
));

7930 ià(
queue_lšk_down
) {

7936 ià((
µd
->
ho¡_lšk_¡©e
 &

7937 (
HLS_GOING_OFFLINE
 | 
HLS_LINK_COOLDOWN
)) ||

7938 
µd
->
lšk_’abËd
 == 0) {

7939 
	`dd_dev_šfo
(
dd
, "%s:‚ot queuing†ink down. host_link_state %x,†ink_enabled %x\n",

7940 
__func__
, 
µd
->
ho¡_lšk_¡©e
,

7941 
µd
->
lšk_’abËd
);

7943 ià(
	`xchg
(&
µd
->
is_lšk_down_queued
, 1) == 1)

7944 
	`dd_dev_šfo
(
dd
,

7946 
__func__
);

7948 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_down_wÜk
);

7951 
	}
}

7953 cÚ¡ * cÚ¡ 
	gfm_cÚfig_txt
[] = {

7973 cÚ¡ * cÚ¡ 
	gpÜt_rcv_txt
[] = {

7996 
	#OPA_LDR_FMCONFIG_OFFSET
 16

	)

7997 
	#OPA_LDR_PORTRCV_OFFSET
 0

	)

7998 
	$hªdË_dcc_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

8000 
u64
 
šfo
, 
hdr0
, 
hdr1
;

8001 cÚ¡ *
exŒa
;

8002 
buf
[96];

8003 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

8004 
u8
 
lþ_»asÚ
 = 0;

8005 
do_bounû
 = 0;

8007 ià(
»g
 & 
DCC_ERR_FLG_UNCORRECTABLE_ERR_SMASK
) {

8008 ià(!(
dd
->
”r_šfo_uncÜ»ùabË
 & 
OPA_EI_STATUS_SMASK
)) {

8009 
šfo
 = 
	`»ad_c¤
(
dd
, 
DCC_ERR_INFO_UNCORRECTABLE
);

8010 
dd
->
”r_šfo_uncÜ»ùabË
 = 
šfo
 & 
OPA_EI_CODE_SMASK
;

8012 
dd
->
”r_šfo_uncÜ»ùabË
 |ð
OPA_EI_STATUS_SMASK
;

8014 
»g
 &ð~
DCC_ERR_FLG_UNCORRECTABLE_ERR_SMASK
;

8017 ià(
»g
 & 
DCC_ERR_FLG_LINK_ERR_SMASK
) {

8018 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

8020 ià(
µd
->
lšk_dowÃd
 < (
u32
)
UINT_MAX
)

8021 
µd
->
lšk_dowÃd
++;

8022 
»g
 &ð~
DCC_ERR_FLG_LINK_ERR_SMASK
;

8025 ià(
»g
 & 
DCC_ERR_FLG_FMCONFIG_ERR_SMASK
) {

8026 
u8
 
»asÚ_v®id
 = 1;

8028 
šfo
 = 
	`»ad_c¤
(
dd
, 
DCC_ERR_INFO_FMCONFIG
);

8029 ià(!(
dd
->
”r_šfo_fmcÚfig
 & 
OPA_EI_STATUS_SMASK
)) {

8030 
dd
->
”r_šfo_fmcÚfig
 = 
šfo
 & 
OPA_EI_CODE_SMASK
;

8032 
dd
->
”r_šfo_fmcÚfig
 |ð
OPA_EI_STATUS_SMASK
;

8034 
šfo
) {

8042 
exŒa
 = 
fm_cÚfig_txt
[
šfo
];

8045 
exŒa
 = 
fm_cÚfig_txt
[
šfo
];

8046 ià(
µd
->
pÜt_”rÜ_aùiÚ
 &

8047 
OPA_PI_MASK_FM_CFG_UNSUPPORTED_VL_MARKER
) {

8048 
do_bounû
 = 1;

8053 
lþ_»asÚ
 =

8054 
OPA_LINKDOWN_REASON_UNSUPPORTED_VL_MARKER
;

8058 
»asÚ_v®id
 = 0;

8059 
	`¢´štf
(
buf
, (buf), "»£rved%Îd", 
šfo
);

8060 
exŒa
 = 
buf
;

8064 ià(
»asÚ_v®id
 && !
do_bounû
) {

8065 
do_bounû
 = 
µd
->
pÜt_”rÜ_aùiÚ
 &

8066 (1 << (
OPA_LDR_FMCONFIG_OFFSET
 + 
šfo
));

8067 
lþ_»asÚ
 = 
šfo
 + 
OPA_LINKDOWN_REASON_BAD_HEAD_DIST
;

8071 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "DCC Error: fmconfigƒrror: %s\n",

8072 
exŒa
);

8073 
»g
 &ð~
DCC_ERR_FLG_FMCONFIG_ERR_SMASK
;

8076 ià(
»g
 & 
DCC_ERR_FLG_RCVPORT_ERR_SMASK
) {

8077 
u8
 
»asÚ_v®id
 = 1;

8079 
šfo
 = 
	`»ad_c¤
(
dd
, 
DCC_ERR_INFO_PORTRCV
);

8080 
hdr0
 = 
	`»ad_c¤
(
dd
, 
DCC_ERR_INFO_PORTRCV_HDR0
);

8081 
hdr1
 = 
	`»ad_c¤
(
dd
, 
DCC_ERR_INFO_PORTRCV_HDR1
);

8082 ià(!(
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 &

8083 
OPA_EI_STATUS_SMASK
)) {

8084 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 =

8085 
šfo
 & 
OPA_EI_CODE_SMASK
;

8087 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 |=

8088 
OPA_EI_STATUS_SMASK
;

8093 
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™1
 = 
hdr0
;

8094 
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™2
 = 
hdr1
;

8096 
šfo
) {

8107 
exŒa
 = 
pÜt_rcv_txt
[
šfo
];

8110 
»asÚ_v®id
 = 0;

8111 
	`¢´štf
(
buf
, (buf), "»£rved%Îd", 
šfo
);

8112 
exŒa
 = 
buf
;

8116 ià(
»asÚ_v®id
 && !
do_bounû
) {

8117 
do_bounû
 = 
µd
->
pÜt_”rÜ_aùiÚ
 &

8118 (1 << (
OPA_LDR_PORTRCV_OFFSET
 + 
šfo
));

8119 
lþ_»asÚ
 = 
šfo
 + 
OPA_LINKDOWN_REASON_RCV_ERROR_0
;

8123 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "DCC Error: PortRcvƒrror: %s\n"

8125 
exŒa
, 
hdr0
, 
hdr1
);

8127 
»g
 &ð~
DCC_ERR_FLG_RCVPORT_ERR_SMASK
;

8130 ià(
»g
 & 
DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_UC_SMASK
) {

8132 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "8051‡ccesso LCB blocked\n");

8133 
»g
 &ð~
DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_UC_SMASK
;

8135 ià(
»g
 & 
DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_HOST_SMASK
) {

8137 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "host‡ccesso LCB blocked\n");

8138 
»g
 &ð~
DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_HOST_SMASK
;

8141 ià(
	`uÆik–y
(
	`hfi1_dbg_çuÉ_suµ»ss_”r
(&
dd
->
v”bs_dev
)))

8142 
»g
 &ð~
DCC_ERR_FLG_LATE_EBP_ERR_SMASK
;

8145 ià(
»g
)

8146 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "DCC Error: %s\n",

8147 
	`dcc_”r_¡ršg
(
buf
, (buf), 
»g
));

8149 ià(
lþ_»asÚ
 == 0)

8150 
lþ_»asÚ
 = 
OPA_LINKDOWN_REASON_UNKNOWN
;

8152 ià(
do_bounû
) {

8153 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "%s: PortErrorAction bounce\n",

8154 
__func__
);

8155 
	`£t_lšk_down_»asÚ
(
µd
, 
lþ_»asÚ
, 0,†cl_reason);

8156 
	`queue_wÜk
(
µd
->
lšk_wq
, &µd->
lšk_bounû_wÜk
);

8158 
	}
}

8160 
	$hªdË_lcb_”r
(
hfi1_devd©a
 *
dd
, 
u32
 
unu£d
, 
u64
 
»g
)

8162 
buf
[96];

8164 
	`dd_dev_šfo
(
dd
, "LCB Error: %s\n",

8165 
	`lcb_”r_¡ršg
(
buf
, (buf), 
»g
));

8166 
	}
}

8171 
	$is_dc_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8173 cÚ¡ 
”r_»g_šfo
 *
”i
 = &
dc_”rs
[
sourû
];

8175 ià(
”i
->
hªdËr
) {

8176 
	`š‹¼u±_þ—r_down
(
dd
, 0, 
”i
);

8177 } ià(
sourû
 == 3 ) {

8187 
	`dd_dev_”r
(
dd
, "Parityƒrror in DC LBM block\n");

8189 
	`dd_dev_”r
(
dd
, "Inv®id DC iÁ”ru± %u\n", 
sourû
);

8191 
	}
}

8196 
	$is_£nd_üed™_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8198 
	`sc_group_»Ëa£_upd©e
(
dd
, 
sourû
);

8199 
	}
}

8210 
	$is_sdma_’g_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8213 
wh©
 = 
sourû
 / 
TXE_NUM_SDMA_ENGINES
;

8215 
which
 = 
sourû
 % 
TXE_NUM_SDMA_ENGINES
;

8217 #ifdeà
CONFIG_SDMA_VERBOSITY


8218 
	`dd_dev_”r
(
dd
, "CONFIG SDMA(%uè%s:%d %s()\n", 
which
,

8219 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

8220 
	`sdma_dump¡©e
(&
dd
->
³r_sdma
[
which
]);

8223 ià(
	`lik–y
(
wh©
 < 3 && 
which
 < 
dd
->
num_sdma
)) {

8224 
	`sdma_’gše_š‹¼u±
(&
dd
->
³r_sdma
[
which
], 1uÎ << 
sourû
);

8227 
	`dd_dev_”r
(
dd
, "Inv®id SDMA iÁ”ru± 0x%x\n", 
sourû
);

8229 
	}
}

8241 
	$is_rcv_avaž_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8243 
hfi1_ùxtd©a
 *
rcd
;

8244 *
”r_d‘až
;

8246 ià(
	`lik–y
(
sourû
 < 
dd
->
num_rcv_cÚ‹xts
)) {

8247 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
sourû
);

8248 ià(
rcd
) {

8249 
	`hªdË_u£r_š‹¼u±
(
rcd
);

8250 
	`hfi1_rcd_put
(
rcd
);

8254 
”r_d‘až
 = "dataless";

8257 
”r_d‘až
 = "out of„ange";

8259 
	`dd_dev_”r
(
dd
, "unexpected %s„eceive‡vailable context interrupt %u\n",

8260 
”r_d‘až
, 
sourû
);

8261 
	}
}

8272 
	$is_rcv_urg’t_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8274 
hfi1_ùxtd©a
 *
rcd
;

8275 *
”r_d‘až
;

8277 ià(
	`lik–y
(
sourû
 < 
dd
->
num_rcv_cÚ‹xts
)) {

8278 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
sourû
);

8279 ià(
rcd
) {

8280 
	`hªdË_u£r_š‹¼u±
(
rcd
);

8281 
	`hfi1_rcd_put
(
rcd
);

8285 
”r_d‘až
 = "dataless";

8288 
”r_d‘až
 = "out of„ange";

8290 
	`dd_dev_”r
(
dd
, "unexpected %s„eceive urgent context interrupt %u\n",

8291 
”r_d‘až
, 
sourû
);

8292 
	}
}

8297 
	$is_»£rved_št
(
hfi1_devd©a
 *
dd
, 
sourû
)

8299 
Çme
[64];

8301 
	`dd_dev_”r
(
dd
, "unexpected %s interrupt\n",

8302 
	`is_»£rved_Çme
(
Çme
, Òame), 
sourû
));

8303 
	}
}

8305 cÚ¡ 
is_bË
 
	gis_bË
[] = {

8310 { 
IS_GENERAL_ERR_START
, 
IS_GENERAL_ERR_END
,

8311 
is_misc_”r_Çme
, 
is_misc_”r_št
 },

8312 { 
IS_SDMAENG_ERR_START
, 
IS_SDMAENG_ERR_END
,

8313 
is_sdma_’g_”r_Çme
, 
is_sdma_’g_”r_št
 },

8314 { 
IS_SENDCTXT_ERR_START
, 
IS_SENDCTXT_ERR_END
,

8315 
is_£ndùxt_”r_Çme
, 
is_£ndùxt_”r_št
 },

8316 { 
IS_SDMA_START
, 
IS_SDMA_IDLE_END
,

8317 
is_sdma_’g_Çme
, 
is_sdma_’g_št
 },

8318 { 
IS_VARIOUS_START
, 
IS_VARIOUS_END
,

8319 
is_v¬ious_Çme
, 
is_v¬ious_št
 },

8320 { 
IS_DC_START
, 
IS_DC_END
,

8321 
is_dc_Çme
, 
is_dc_št
 },

8322 { 
IS_RCVAVAIL_START
, 
IS_RCVAVAIL_END
,

8323 
is_rcv_avaž_Çme
, 
is_rcv_avaž_št
 },

8324 { 
IS_RCVURGENT_START
, 
IS_RCVURGENT_END
,

8325 
is_rcv_urg’t_Çme
, 
is_rcv_urg’t_št
 },

8326 { 
IS_SENDCREDIT_START
, 
IS_SENDCREDIT_END
,

8327 
is_£nd_üed™_Çme
, 
is_£nd_üed™_št
},

8328 { 
IS_RESERVED_START
, 
IS_RESERVED_END
,

8329 
is_»£rved_Çme
, 
is_»£rved_št
},

8336 
	$is_š‹¼u±
(
hfi1_devd©a
 *
dd
, 
sourû
)

8338 cÚ¡ 
is_bË
 *
’Œy
;

8341 
’Œy
 = &
is_bË
[0];ƒÁry->
is_Çme
;ƒntry++) {

8342 ià(
sourû
 <ð
’Œy
->
’d
) {

8343 
	`Œaû_hfi1_š‹¼u±
(
dd
, 
’Œy
, 
sourû
);

8344 
’Œy
->
	`is_št
(
dd
, 
sourû
 -ƒÁry->
¡¬t
);

8349 
	`dd_dev_”r
(
dd
, "šv®id iÁ”ru± sourû %u\n", 
sourû
);

8350 
	}
}

8361 
œq»tuº_t
 
	$g’”®_š‹¼u±
(
œq
, *
d©a
)

8363 
hfi1_devd©a
 *
dd
 = 
d©a
;

8364 
u64
 
»gs
[
CCE_NUM_INT_CSRS
];

8365 
u32
 
b™
;

8366 
i
;

8367 
œq»tuº_t
 
hªdËd
 = 
IRQ_NONE
;

8369 
	`this_ýu_šc
(*
dd
->
št_couÁ”
);

8372 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; i++) {

8373 ià(
dd
->
gi_mask
[
i
] == 0) {

8374 
»gs
[
i
] = 0;

8377 
»gs
[
i
] = 
	`»ad_c¤
(
dd
, 
CCE_INT_STATUS
 + (8 * i)) &

8378 
dd
->
gi_mask
[
i
];

8380 ià(
»gs
[
i
])

8381 
	`wr™e_c¤
(
dd
, 
CCE_INT_CLEAR
 + (8 * 
i
), 
»gs
[i]);

8385 
	`fÜ_—ch_£t_b™
(
b™
, (*)&
»gs
[0],

8386 
CCE_NUM_INT_CSRS
 * 64) {

8387 
	`is_š‹¼u±
(
dd
, 
b™
);

8388 
hªdËd
 = 
IRQ_HANDLED
;

8391  
hªdËd
;

8392 
	}
}

8394 
œq»tuº_t
 
	$sdma_š‹¼u±
(
œq
, *
d©a
)

8396 
sdma_’gše
 *
sde
 = 
d©a
;

8397 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

8398 
u64
 
¡©us
;

8400 #ifdeà
CONFIG_SDMA_VERBOSITY


8401 
	`dd_dev_”r
(
dd
, "CONFIG SDMA(%uè%s:%d %s()\n", 
sde
->
this_idx
,

8402 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

8403 
	`sdma_dump¡©e
(
sde
);

8406 
	`this_ýu_šc
(*
dd
->
št_couÁ”
);

8409 
¡©us
 = 
	`»ad_c¤
(
dd
,

8410 
CCE_INT_STATUS
 + (8 * (
IS_SDMA_START
 / 64)))

8411 & 
sde
->
imask
;

8412 ià(
	`lik–y
(
¡©us
)) {

8414 
	`wr™e_c¤
(
dd
,

8415 
CCE_INT_CLEAR
 + (8 * (
IS_SDMA_START
 / 64)),

8416 
¡©us
);

8419 
	`sdma_’gše_š‹¼u±
(
sde
, 
¡©us
);

8421 
	`dd_dev_šfo_¿‹lim™ed
(
dd
, "SDMAƒngine %u interrupt, but‚o status bits set\n",

8422 
sde
->
this_idx
);

8424  
IRQ_HANDLED
;

8425 
	}
}

8432 
šlše
 
	$þ—r_»cv_šŒ
(
hfi1_ùxtd©a
 *
rcd
)

8434 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

8435 
u32
 
addr
 = 
CCE_INT_CLEAR
 + (8 * 
rcd
->
œeg
);

8437 
	`wr™e_c¤
(
dd
, 
addr
, 
rcd
->
imask
);

8439 ()
	`»ad_c¤
(
dd
, 
addr
);

8440 
	}
}

8443 
	$fÜû_»cv_šŒ
(
hfi1_ùxtd©a
 *
rcd
)

8445 
	`wr™e_c¤
(
rcd
->
dd
, 
CCE_INT_FORCE
 + (8 *„cd->
œeg
),„cd->
imask
);

8446 
	}
}

8458 
šlše
 
	$check_·ck‘_´e£Á
(
hfi1_ùxtd©a
 *
rcd
)

8460 
u32
 
ž
;

8462 ià(
	`hfi1_·ck‘_´e£Á
(
rcd
))

8466 
ž
 = (
u32
)
	`»ad_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_HDR_TAIL
);

8467  
	`hfi1_rcd_h—d
(
rcd
è!ð
ž
;

8468 
	}
}

8475 
	$»ûive_š‹¼u±_commÚ
(
hfi1_ùxtd©a
 *
rcd
)

8477 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

8479 
	`Œaû_hfi1_»ûive_š‹¼u±
(
dd
, 
rcd
);

8480 
	`this_ýu_šc
(*
dd
->
št_couÁ”
);

8481 
	`a¥m_ùx_di§bË
(
rcd
);

8482 
	}
}

8491 
	$__hfi1_rcd_eoi_šŒ
(
hfi1_ùxtd©a
 *
rcd
)

8493 
	`þ—r_»cv_šŒ
(
rcd
);

8494 ià(
	`check_·ck‘_´e£Á
(
rcd
))

8495 
	`fÜû_»cv_šŒ
(
rcd
);

8496 
	}
}

8510 
	$hfi1_rcd_eoi_šŒ
(
hfi1_ùxtd©a
 *
rcd
)

8512 
æags
;

8514 
	`loÿl_œq_§ve
(
æags
);

8515 
	`__hfi1_rcd_eoi_šŒ
(
rcd
);

8516 
	`loÿl_œq_»¡Üe
(
æags
);

8517 
	}
}

8524 
	$hfi1_Ãtdev_rx_Çpi
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

8526 
hfi1_Ãtdev_rxq
 *
rxq
 = 
	`cÚš”_of
(
Çpi
,

8527 
hfi1_Ãtdev_rxq
, 
Çpi
);

8528 
hfi1_ùxtd©a
 *
rcd
 = 
rxq
->rcd;

8529 
wÜk_dÚe
 = 0;

8531 
wÜk_dÚe
 = 
rcd
->
	`do_š‹¼u±
Ôcd, 
budg‘
);

8533 ià(
wÜk_dÚe
 < 
budg‘
) {

8534 
	`Çpi_com¶‘e_dÚe
(
Çpi
, 
wÜk_dÚe
);

8535 
	`hfi1_rcd_eoi_šŒ
(
rcd
);

8538  
wÜk_dÚe
;

8539 
	}
}

8544 
œq»tuº_t
 
	$»ûive_cÚ‹xt_š‹¼u±_Çpi
(
œq
, *
d©a
)

8546 
hfi1_ùxtd©a
 *
rcd
 = 
d©a
;

8548 
	`»ûive_š‹¼u±_commÚ
(
rcd
);

8550 ià(
	`lik–y
(
rcd
->
Çpi
)) {

8551 ià(
	`lik–y
(
	`Çpi_scheduË_´•
(
rcd
->
Çpi
)))

8552 
	`__Çpi_scheduË_œqoff
(
rcd
->
Çpi
);

8554 
	`__hfi1_rcd_eoi_šŒ
(
rcd
);

8556 
	`WARN_ONCE
(1, "Napi IRQ handler without‚api set up ctxt=%d\n",

8557 
rcd
->
ùxt
);

8558 
	`__hfi1_rcd_eoi_šŒ
(
rcd
);

8561  
IRQ_HANDLED
;

8562 
	}
}

8572 
œq»tuº_t
 
	$»ûive_cÚ‹xt_š‹¼u±
(
œq
, *
d©a
)

8574 
hfi1_ùxtd©a
 *
rcd
 = 
d©a
;

8575 
di¥os™iÚ
;

8577 
	`»ûive_š‹¼u±_commÚ
(
rcd
);

8580 
di¥os™iÚ
 = 
rcd
->
	`do_š‹¼u±
(rcd, 0);

8587 ià(
di¥os™iÚ
 =ð
RCV_PKT_LIMIT
)

8588  
IRQ_WAKE_THREAD
;

8590 
	`__hfi1_rcd_eoi_šŒ
(
rcd
);

8591  
IRQ_HANDLED
;

8592 
	}
}

8598 
œq»tuº_t
 
	$»ûive_cÚ‹xt_th»ad
(
œq
, *
d©a
)

8600 
hfi1_ùxtd©a
 *
rcd
 = 
d©a
;

8603 ()
rcd
->
	`do_š‹¼u±
(rcd, 1);

8605 
	`hfi1_rcd_eoi_šŒ
(
rcd
);

8607  
IRQ_HANDLED
;

8608 
	}
}

8612 
u32
 
	$»ad_physiÿl_¡©e
(
hfi1_devd©a
 *
dd
)

8614 
u64
 
»g
;

8616 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_CUR_STATE
);

8617  (
»g
 >> 
DC_DC8051_STS_CUR_STATE_PORT_SHIFT
)

8618 & 
DC_DC8051_STS_CUR_STATE_PORT_MASK
;

8619 
	}
}

8621 
u32
 
	$»ad_logiÿl_¡©e
(
hfi1_devd©a
 *
dd
)

8623 
u64
 
»g
;

8625 
»g
 = 
	`»ad_c¤
(
dd
, 
DCC_CFG_PORT_CONFIG
);

8626  (
»g
 >> 
DCC_CFG_PORT_CONFIG_LINK_STATE_SHIFT
)

8627 & 
DCC_CFG_PORT_CONFIG_LINK_STATE_MASK
;

8628 
	}
}

8630 
	$£t_logiÿl_¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 
ch_l¡©e
)

8632 
u64
 
»g
;

8634 
»g
 = 
	`»ad_c¤
(
dd
, 
DCC_CFG_PORT_CONFIG
);

8636 
»g
 &ð~
DCC_CFG_PORT_CONFIG_LINK_STATE_SMASK
;

8637 
»g
 |ð(
u64
)
ch_l¡©e
 << 
DCC_CFG_PORT_CONFIG_LINK_STATE_SHIFT
;

8638 
	`wr™e_c¤
(
dd
, 
DCC_CFG_PORT_CONFIG
, 
»g
);

8639 
	}
}

8644 
	$»ad_lcb_vŸ_8051
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, 
u64
 *
d©a
)

8646 
u32
 
»gno
;

8647 
»t
;

8649 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
) {

8650 ià(
	`acquœe_lcb_acûss
(
dd
, 0) == 0) {

8651 *
d©a
 = 
	`»ad_c¤
(
dd
, 
addr
);

8652 
	`»Ëa£_lcb_acûss
(
dd
, 0);

8655  -
EBUSY
;

8659 
»gno
 = (
addr
 - 
DC_LCB_CFG_RUN
) >> 3;

8660 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_READ_LCB_CSR
, 
»gno
, 
d©a
);

8661 ià(
»t
 !ð
HCMD_SUCCESS
)

8662  -
EBUSY
;

8664 
	}
}

8671 
	slcb_d©um
 {

8672 
u32
 
	moff
;

8673 
u64
 
	mv®
;

8676 
lcb_d©um
 
	glcb_ÿche
[] = {

8677 { 
DC_LCB_ERR_INFO_RX_REPLAY_CNT
, 0},

8678 { 
DC_LCB_ERR_INFO_SEQ_CRC_CNT
, 0 },

8679 { 
DC_LCB_ERR_INFO_REINIT_FROM_PEER_CNT
, 0 },

8682 
	$upd©e_lcb_ÿche
(
hfi1_devd©a
 *
dd
)

8684 
i
;

8685 
»t
;

8686 
u64
 
v®
;

8688 
i
 = 0; i < 
	`ARRAY_SIZE
(
lcb_ÿche
); i++) {

8689 
»t
 = 
	`»ad_lcb_c¤
(
dd
, 
lcb_ÿche
[
i
].
off
, &
v®
);

8692 ià(
	`lik–y
(
»t
 !ð-
EBUSY
))

8693 
lcb_ÿche
[
i
].
v®
 = val;

8695 
	}
}

8697 
	$»ad_lcb_ÿche
(
u32
 
off
, 
u64
 *
v®
)

8699 
i
;

8701 
i
 = 0; i < 
	`ARRAY_SIZE
(
lcb_ÿche
); i++) {

8702 ià(
lcb_ÿche
[
i
].
off
 == off) {

8703 *
v®
 = 
lcb_ÿche
[
i
].val;

8708 
	`´_w¬n
("% bad off£ˆ0x%x\n", 
__func__
, 
off
);

8710 
	}
}

8716 
	$»ad_lcb_c¤
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, 
u64
 *
d©a
)

8718 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

8721 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
)

8722  
	`»ad_lcb_vŸ_8051
(
dd
, 
addr
, 
d©a
);

8724 ià(
µd
->
ho¡_lšk_¡©e
 & (
HLS_GOING_UP
 | 
HLS_GOING_OFFLINE
)) {

8725 ià(
	`»ad_lcb_ÿche
(
addr
, 
d©a
))

8726  -
EBUSY
;

8731 *
d©a
 = 
	`»ad_c¤
(
dd
, 
addr
);

8733 
	}
}

8738 
	$wr™e_lcb_vŸ_8051
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, 
u64
 
d©a
)

8740 
u32
 
»gno
;

8741 
»t
;

8743 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
 ||

8744 (
dd
->
dc8051_v”
 < 
	`dc8051_v”
(0, 20, 0))) {

8745 ià(
	`acquœe_lcb_acûss
(
dd
, 0) == 0) {

8746 
	`wr™e_c¤
(
dd
, 
addr
, 
d©a
);

8747 
	`»Ëa£_lcb_acûss
(
dd
, 0);

8750  -
EBUSY
;

8754 
»gno
 = (
addr
 - 
DC_LCB_CFG_RUN
) >> 3;

8755 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_WRITE_LCB_CSR
, 
»gno
, &
d©a
);

8756 ià(
»t
 !ð
HCMD_SUCCESS
)

8757  -
EBUSY
;

8759 
	}
}

8765 
	$wr™e_lcb_c¤
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, 
u64
 
d©a
)

8767 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

8770 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
)

8771  
	`wr™e_lcb_vŸ_8051
(
dd
, 
addr
, 
d©a
);

8773 ià(
µd
->
ho¡_lšk_¡©e
 & (
HLS_GOING_UP
 | 
HLS_GOING_OFFLINE
))

8774  -
EBUSY
;

8776 
	`wr™e_c¤
(
dd
, 
addr
, 
d©a
);

8778 
	}
}

8785 
	$do_8051_commªd
(

8786 
hfi1_devd©a
 *
dd
,

8787 
u32
 
ty³
,

8788 
u64
 
š_d©a
,

8789 
u64
 *
out_d©a
)

8791 
u64
 
»g
, 
com¶‘ed
;

8792 
»tuº_code
;

8793 
timeout
;

8795 
	`hfi1_cdbg
(
DC8051
, "ty³ %d, d©¨0x%012Îx", 
ty³
, 
š_d©a
);

8797 
	`mu‹x_lock
(&
dd
->
dc8051_lock
);

8800 ià(
dd
->
dc_shutdown
) {

8801 
»tuº_code
 = -
ENODEV
;

8802 
çž
;

8815 ià(
dd
->
dc8051_timed_out
) {

8816 ià(
dd
->
dc8051_timed_out
 > 1) {

8817 
	`dd_dev_”r
(
dd
,

8819 
ty³
);

8820 
»tuº_code
 = -
ENXIO
;

8821 
çž
;

8823 
	`_dc_shutdown
(
dd
);

8824 
	`_dc_¡¬t
(
dd
);

8843 ià(
ty³
 =ð
HCMD_WRITE_LCB_CSR
) {

8844 
š_d©a
 |ð((*
out_d©a
) & 0xffffffffffull) << 8;

8846 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_0
);

8847 
»g
 &ð
DC_DC8051_CFG_EXT_DEV_0_COMPLETED_SMASK
;

8848 
»g
 |ð((((*
out_d©a
) >> 40) & 0xff) <<

8849 
DC_DC8051_CFG_EXT_DEV_0_RETURN_CODE_SHIFT
)

8850 | ((((*
out_d©a
) >> 48) & 0xffff) <<

8851 
DC_DC8051_CFG_EXT_DEV_0_RSP_DATA_SHIFT
);

8852 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_0
, 
»g
);

8859 
»g
 = ((
u64
)
ty³
 & 
DC_DC8051_CFG_HOST_CMD_0_REQ_TYPE_MASK
)

8860 << 
DC_DC8051_CFG_HOST_CMD_0_REQ_TYPE_SHIFT


8861 | (
š_d©a
 & 
DC_DC8051_CFG_HOST_CMD_0_REQ_DATA_MASK
)

8862 << 
DC_DC8051_CFG_HOST_CMD_0_REQ_DATA_SHIFT
;

8863 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_HOST_CMD_0
, 
»g
);

8864 
»g
 |ð
DC_DC8051_CFG_HOST_CMD_0_REQ_NEW_SMASK
;

8865 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_HOST_CMD_0
, 
»g
);

8868 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
DC8051_COMMAND_TIMEOUT
);

8870 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_HOST_CMD_1
);

8871 
com¶‘ed
 = 
»g
 & 
DC_DC8051_CFG_HOST_CMD_1_COMPLETED_SMASK
;

8872 ià(
com¶‘ed
)

8874 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

8875 
dd
->
dc8051_timed_out
++;

8876 
	`dd_dev_”r
(
dd
, "8051 ho¡ commªd %uimeout\n", 
ty³
);

8877 ià(
out_d©a
)

8878 *
out_d©a
 = 0;

8879 
»tuº_code
 = -
ETIMEDOUT
;

8880 
çž
;

8882 
	`ud–ay
(2);

8885 ià(
out_d©a
) {

8886 *
out_d©a
 = (
»g
 >> 
DC_DC8051_CFG_HOST_CMD_1_RSP_DATA_SHIFT
)

8887 & 
DC_DC8051_CFG_HOST_CMD_1_RSP_DATA_MASK
;

8888 ià(
ty³
 =ð
HCMD_READ_LCB_CSR
) {

8890 *
out_d©a
 |ð(
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_EXT_DEV_1
)

8891 & 
DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_SMASK
)

8893 - 
DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_SHIFT
);

8896 
»tuº_code
 = (
»g
 >> 
DC_DC8051_CFG_HOST_CMD_1_RETURN_CODE_SHIFT
)

8897 & 
DC_DC8051_CFG_HOST_CMD_1_RETURN_CODE_MASK
;

8898 
dd
->
dc8051_timed_out
 = 0;

8902 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_HOST_CMD_0
, 0);

8904 
çž
:

8905 
	`mu‹x_uÆock
(&
dd
->
dc8051_lock
);

8906  
»tuº_code
;

8907 
	}
}

8909 
	$£t_physiÿl_lšk_¡©e
(
hfi1_devd©a
 *
dd
, 
u64
 
¡©e
)

8911  
	`do_8051_commªd
(
dd
, 
HCMD_CHANGE_PHY_STATE
, 
¡©e
, 
NULL
);

8912 
	}
}

8914 
	$lßd_8051_cÚfig
(
hfi1_devd©a
 *
dd
, 
u8
 
f›ld_id
,

8915 
u8
 
ÏÃ_id
, 
u32
 
cÚfig_d©a
)

8917 
u64
 
d©a
;

8918 
»t
;

8920 
d©a
 = (
u64
)
f›ld_id
 << 
LOAD_DATA_FIELD_ID_SHIFT


8921 | (
u64
)
ÏÃ_id
 << 
LOAD_DATA_LANE_ID_SHIFT


8922 | (
u64
)
cÚfig_d©a
 << 
LOAD_DATA_DATA_SHIFT
;

8923 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_LOAD_CONFIG_DATA
, 
d©a
, 
NULL
);

8924 ià(
»t
 !ð
HCMD_SUCCESS
) {

8925 
	`dd_dev_”r
(
dd
,

8927 ()
f›ld_id
, ()
ÏÃ_id
, 
»t
);

8929  
»t
;

8930 
	}
}

8937 
	$»ad_8051_cÚfig
(
hfi1_devd©a
 *
dd
, 
u8
 
f›ld_id
, u8 
ÏÃ_id
,

8938 
u32
 *
»suÉ
)

8940 
u64
 
big_d©a
;

8941 
u32
 
addr
;

8942 
»t
;

8945 ià(
ÏÃ_id
 < 4)

8946 
addr
 = (4 * 
NUM_GENERAL_FIELDS
)

8947 + (
ÏÃ_id
 * 4 * 
NUM_LANE_FIELDS
);

8949 
addr
 = 0;

8950 
addr
 +ð
f›ld_id
 * 4;

8953 
»t
 = 
	`»ad_8051_d©a
(
dd
, 
addr
, 8, &
big_d©a
);

8955 ià(
»t
 == 0) {

8957 ià(
addr
 & 0x4)

8958 *
»suÉ
 = (
u32
)(
big_d©a
 >> 32);

8960 *
»suÉ
 = (
u32
)
big_d©a
;

8962 *
»suÉ
 = 0;

8963 
	`dd_dev_”r
(
dd
, "%s: direct„ead failed,†ane %d, field %d!\n",

8964 
__func__
, 
ÏÃ_id
, 
f›ld_id
);

8967  
»t
;

8968 
	}
}

8970 
	$wr™e_vc_loÿl_phy
(
hfi1_devd©a
 *
dd
, 
u8
 
pow”_mªagem’t
,

8971 
u8
 
cÚtšuous
)

8973 
u32
 
äame
;

8975 
äame
 = 
cÚtšuous
 << 
CONTINIOUS_REMOTE_UPDATE_SUPPORT_SHIFT


8976 | 
pow”_mªagem’t
 << 
POWER_MANAGEMENT_SHIFT
;

8977  
	`lßd_8051_cÚfig
(
dd
, 
VERIFY_CAP_LOCAL_PHY
,

8978 
GENERAL_CONFIG
, 
äame
);

8979 
	}
}

8981 
	$wr™e_vc_loÿl_çbric
(
hfi1_devd©a
 *
dd
, 
u8
 
vau
, u8 
z
, u8 
vcu
,

8982 
u16
 
vl15buf
, 
u8
 
üc_sizes
)

8984 
u32
 
äame
;

8986 
äame
 = (
u32
)
vau
 << 
VAU_SHIFT


8987 | (
u32
)
z
 << 
Z_SHIFT


8988 | (
u32
)
vcu
 << 
VCU_SHIFT


8989 | (
u32
)
vl15buf
 << 
VL15BUF_SHIFT


8990 | (
u32
)
üc_sizes
 << 
CRC_SIZES_SHIFT
;

8991  
	`lßd_8051_cÚfig
(
dd
, 
VERIFY_CAP_LOCAL_FABRIC
,

8992 
GENERAL_CONFIG
, 
äame
);

8993 
	}
}

8995 
	$»ad_vc_loÿl_lšk_mode
(
hfi1_devd©a
 *
dd
, 
u8
 *
misc_b™s
,

8996 
u8
 *
æag_b™s
, 
u16
 *
lšk_widths
)

8998 
u32
 
äame
;

9000 
	`»ad_8051_cÚfig
(
dd
, 
VERIFY_CAP_LOCAL_LINK_MODE
, 
GENERAL_CONFIG
,

9001 &
äame
);

9002 *
misc_b™s
 = (
äame
 >> 
MISC_CONFIG_BITS_SHIFT
è& 
MISC_CONFIG_BITS_MASK
;

9003 *
æag_b™s
 = (
äame
 >> 
LOCAL_FLAG_BITS_SHIFT
è& 
LOCAL_FLAG_BITS_MASK
;

9004 *
lšk_widths
 = (
äame
 >> 
LINK_WIDTH_SHIFT
è& 
LINK_WIDTH_MASK
;

9005 
	}
}

9007 
	$wr™e_vc_loÿl_lšk_mode
(
hfi1_devd©a
 *
dd
,

9008 
u8
 
misc_b™s
,

9009 
u8
 
æag_b™s
,

9010 
u16
 
lšk_widths
)

9012 
u32
 
äame
;

9014 
äame
 = (
u32
)
misc_b™s
 << 
MISC_CONFIG_BITS_SHIFT


9015 | (
u32
)
æag_b™s
 << 
LOCAL_FLAG_BITS_SHIFT


9016 | (
u32
)
lšk_widths
 << 
LINK_WIDTH_SHIFT
;

9017  
	`lßd_8051_cÚfig
(
dd
, 
VERIFY_CAP_LOCAL_LINK_MODE
, 
GENERAL_CONFIG
,

9018 
äame
);

9019 
	}
}

9021 
	$wr™e_loÿl_deviû_id
(
hfi1_devd©a
 *
dd
, 
u16
 
deviû_id
,

9022 
u8
 
deviû_»v
)

9024 
u32
 
äame
;

9026 
äame
 = ((
u32
)
deviû_id
 << 
LOCAL_DEVICE_ID_SHIFT
)

9027 | ((
u32
)
deviû_»v
 << 
LOCAL_DEVICE_REV_SHIFT
);

9028  
	`lßd_8051_cÚfig
(
dd
, 
LOCAL_DEVICE_ID
, 
GENERAL_CONFIG
, 
äame
);

9029 
	}
}

9031 
	$»ad_»mÙe_deviû_id
(
hfi1_devd©a
 *
dd
, 
u16
 *
deviû_id
,

9032 
u8
 *
deviû_»v
)

9034 
u32
 
äame
;

9036 
	`»ad_8051_cÚfig
(
dd
, 
REMOTE_DEVICE_ID
, 
GENERAL_CONFIG
, &
äame
);

9037 *
deviû_id
 = (
äame
 >> 
REMOTE_DEVICE_ID_SHIFT
è& 
REMOTE_DEVICE_ID_MASK
;

9038 *
deviû_»v
 = (
äame
 >> 
REMOTE_DEVICE_REV_SHIFT
)

9039 & 
REMOTE_DEVICE_REV_MASK
;

9040 
	}
}

9042 
	$wr™e_ho¡_š‹rçû_v”siÚ
(
hfi1_devd©a
 *
dd
, 
u8
 
v”siÚ
)

9044 
u32
 
äame
;

9045 
u32
 
mask
;

9047 
mask
 = (
HOST_INTERFACE_VERSION_MASK
 << 
HOST_INTERFACE_VERSION_SHIFT
);

9048 
	`»ad_8051_cÚfig
(
dd
, 
RESERVED_REGISTERS
, 
GENERAL_CONFIG
, &
äame
);

9050 
äame
 &ð~
mask
;

9051 
äame
 |ð((
u32
)
v”siÚ
 << 
HOST_INTERFACE_VERSION_SHIFT
);

9052  
	`lßd_8051_cÚfig
(
dd
, 
RESERVED_REGISTERS
, 
GENERAL_CONFIG
,

9053 
äame
);

9054 
	}
}

9056 
	$»ad_misc_¡©us
(
hfi1_devd©a
 *
dd
, 
u8
 *
v”_majÜ
, u8 *
v”_mšÜ
,

9057 
u8
 *
v”_·tch
)

9059 
u32
 
äame
;

9061 
	`»ad_8051_cÚfig
(
dd
, 
MISC_STATUS
, 
GENERAL_CONFIG
, &
äame
);

9062 *
v”_majÜ
 = (
äame
 >> 
STS_FM_VERSION_MAJOR_SHIFT
) &

9063 
STS_FM_VERSION_MAJOR_MASK
;

9064 *
v”_mšÜ
 = (
äame
 >> 
STS_FM_VERSION_MINOR_SHIFT
) &

9065 
STS_FM_VERSION_MINOR_MASK
;

9067 
	`»ad_8051_cÚfig
(
dd
, 
VERSION_PATCH
, 
GENERAL_CONFIG
, &
äame
);

9068 *
v”_·tch
 = (
äame
 >> 
STS_FM_VERSION_PATCH_SHIFT
) &

9069 
STS_FM_VERSION_PATCH_MASK
;

9070 
	}
}

9072 
	$»ad_vc_»mÙe_phy
(
hfi1_devd©a
 *
dd
, 
u8
 *
pow”_mªagem’t
,

9073 
u8
 *
cÚtšuous
)

9075 
u32
 
äame
;

9077 
	`»ad_8051_cÚfig
(
dd
, 
VERIFY_CAP_REMOTE_PHY
, 
GENERAL_CONFIG
, &
äame
);

9078 *
pow”_mªagem’t
 = (
äame
 >> 
POWER_MANAGEMENT_SHIFT
)

9079 & 
POWER_MANAGEMENT_MASK
;

9080 *
cÚtšuous
 = (
äame
 >> 
CONTINIOUS_REMOTE_UPDATE_SUPPORT_SHIFT
)

9081 & 
CONTINIOUS_REMOTE_UPDATE_SUPPORT_MASK
;

9082 
	}
}

9084 
	$»ad_vc_»mÙe_çbric
(
hfi1_devd©a
 *
dd
, 
u8
 *
vau
, u8 *
z
,

9085 
u8
 *
vcu
, 
u16
 *
vl15buf
, u8 *
üc_sizes
)

9087 
u32
 
äame
;

9089 
	`»ad_8051_cÚfig
(
dd
, 
VERIFY_CAP_REMOTE_FABRIC
, 
GENERAL_CONFIG
, &
äame
);

9090 *
vau
 = (
äame
 >> 
VAU_SHIFT
è& 
VAU_MASK
;

9091 *
z
 = (
äame
 >> 
Z_SHIFT
è& 
Z_MASK
;

9092 *
vcu
 = (
äame
 >> 
VCU_SHIFT
è& 
VCU_MASK
;

9093 *
vl15buf
 = (
äame
 >> 
VL15BUF_SHIFT
è& 
VL15BUF_MASK
;

9094 *
üc_sizes
 = (
äame
 >> 
CRC_SIZES_SHIFT
è& 
CRC_SIZES_MASK
;

9095 
	}
}

9097 
	$»ad_vc_»mÙe_lšk_width
(
hfi1_devd©a
 *
dd
,

9098 
u8
 *
»mÙe_tx_¿‹
,

9099 
u16
 *
lšk_widths
)

9101 
u32
 
äame
;

9103 
	`»ad_8051_cÚfig
(
dd
, 
VERIFY_CAP_REMOTE_LINK_WIDTH
, 
GENERAL_CONFIG
,

9104 &
äame
);

9105 *
»mÙe_tx_¿‹
 = (
äame
 >> 
REMOTE_TX_RATE_SHIFT
)

9106 & 
REMOTE_TX_RATE_MASK
;

9107 *
lšk_widths
 = (
äame
 >> 
LINK_WIDTH_SHIFT
è& 
LINK_WIDTH_MASK
;

9108 
	}
}

9110 
	$»ad_loÿl_Êi
(
hfi1_devd©a
 *
dd
, 
u8
 *
’abË_ÏÃ_rx
)

9112 
u32
 
äame
;

9114 
	`»ad_8051_cÚfig
(
dd
, 
LOCAL_LNI_INFO
, 
GENERAL_CONFIG
, &
äame
);

9115 *
’abË_ÏÃ_rx
 = (
äame
 >> 
ENABLE_LANE_RX_SHIFT
è& 
ENABLE_LANE_RX_MASK
;

9116 
	}
}

9118 
	$»ad_mgmt_®lowed
(
hfi1_devd©a
 *
dd
, 
u8
 *
mgmt_®lowed
)

9120 
u32
 
äame
;

9122 
	`»ad_8051_cÚfig
(
dd
, 
REMOTE_LNI_INFO
, 
GENERAL_CONFIG
, &
äame
);

9123 *
mgmt_®lowed
 = (
äame
 >> 
MGMT_ALLOWED_SHIFT
è& 
MGMT_ALLOWED_MASK
;

9124 
	}
}

9126 
	$»ad_Ï¡_loÿl_¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 *
Îs
)

9128 
	`»ad_8051_cÚfig
(
dd
, 
LAST_LOCAL_STATE_COMPLETE
, 
GENERAL_CONFIG
, 
Îs
);

9129 
	}
}

9131 
	$»ad_Ï¡_»mÙe_¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 *
Ìs
)

9133 
	`»ad_8051_cÚfig
(
dd
, 
LAST_REMOTE_STATE_COMPLETE
, 
GENERAL_CONFIG
, 
Ìs
);

9134 
	}
}

9136 
	$hfi1_»ad_lšk_qu®™y
(
hfi1_devd©a
 *
dd
, 
u8
 *
lšk_qu®™y
)

9138 
u32
 
äame
;

9139 
»t
;

9141 *
lšk_qu®™y
 = 0;

9142 ià(
dd
->
µÜt
->
ho¡_lšk_¡©e
 & 
HLS_UP
) {

9143 
»t
 = 
	`»ad_8051_cÚfig
(
dd
, 
LINK_QUALITY_INFO
, 
GENERAL_CONFIG
,

9144 &
äame
);

9145 ià(
»t
 == 0)

9146 *
lšk_qu®™y
 = (
äame
 >> 
LINK_QUALITY_SHIFT
)

9147 & 
LINK_QUALITY_MASK
;

9149 
	}
}

9151 
	$»ad_¶ªÃd_down_»asÚ_code
(
hfi1_devd©a
 *
dd
, 
u8
 *
pd¼c
)

9153 
u32
 
äame
;

9155 
	`»ad_8051_cÚfig
(
dd
, 
LINK_QUALITY_INFO
, 
GENERAL_CONFIG
, &
äame
);

9156 *
pd¼c
 = (
äame
 >> 
DOWN_REMOTE_REASON_SHIFT
è& 
DOWN_REMOTE_REASON_MASK
;

9157 
	}
}

9159 
	$»ad_lšk_down_»asÚ
(
hfi1_devd©a
 *
dd
, 
u8
 *
ldr
)

9161 
u32
 
äame
;

9163 
	`»ad_8051_cÚfig
(
dd
, 
LINK_DOWN_REASON
, 
GENERAL_CONFIG
, &
äame
);

9164 *
ldr
 = (
äame
 & 0xff);

9165 
	}
}

9167 
	$»ad_tx_£‰šgs
(
hfi1_devd©a
 *
dd
,

9168 
u8
 *
’abË_ÏÃ_tx
,

9169 
u8
 *
tx_pÞ¬™y_šv”siÚ
,

9170 
u8
 *
rx_pÞ¬™y_šv”siÚ
,

9171 
u8
 *
max_¿‹
)

9173 
u32
 
äame
;

9174 
»t
;

9176 
»t
 = 
	`»ad_8051_cÚfig
(
dd
, 
TX_SETTINGS
, 
GENERAL_CONFIG
, &
äame
);

9177 *
’abË_ÏÃ_tx
 = (
äame
 >> 
ENABLE_LANE_TX_SHIFT
)

9178 & 
ENABLE_LANE_TX_MASK
;

9179 *
tx_pÞ¬™y_šv”siÚ
 = (
äame
 >> 
TX_POLARITY_INVERSION_SHIFT
)

9180 & 
TX_POLARITY_INVERSION_MASK
;

9181 *
rx_pÞ¬™y_šv”siÚ
 = (
äame
 >> 
RX_POLARITY_INVERSION_SHIFT
)

9182 & 
RX_POLARITY_INVERSION_MASK
;

9183 *
max_¿‹
 = (
äame
 >> 
MAX_RATE_SHIFT
è& 
MAX_RATE_MASK
;

9184  
»t
;

9185 
	}
}

9187 
	$wr™e_tx_£‰šgs
(
hfi1_devd©a
 *
dd
,

9188 
u8
 
’abË_ÏÃ_tx
,

9189 
u8
 
tx_pÞ¬™y_šv”siÚ
,

9190 
u8
 
rx_pÞ¬™y_šv”siÚ
,

9191 
u8
 
max_¿‹
)

9193 
u32
 
äame
;

9196 
äame
 = 
’abË_ÏÃ_tx
 << 
ENABLE_LANE_TX_SHIFT


9197 | 
tx_pÞ¬™y_šv”siÚ
 << 
TX_POLARITY_INVERSION_SHIFT


9198 | 
rx_pÞ¬™y_šv”siÚ
 << 
RX_POLARITY_INVERSION_SHIFT


9199 | 
max_¿‹
 << 
MAX_RATE_SHIFT
;

9200  
	`lßd_8051_cÚfig
(
dd
, 
TX_SETTINGS
, 
GENERAL_CONFIG
, 
äame
);

9201 
	}
}

9208 
	$»ad_idË_mes§ge
(
hfi1_devd©a
 *
dd
, 
u64
 
ty³
, u64 *
d©a_out
)

9210 
»t
;

9212 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_READ_LCB_IDLE_MSG
, 
ty³
, 
d©a_out
);

9213 ià(
»t
 !ð
HCMD_SUCCESS
) {

9214 
	`dd_dev_”r
(
dd
, "read idle message:ype %d,ƒrr %d\n",

9215 (
u32
)
ty³
, 
»t
);

9216  -
EINVAL
;

9218 
	`dd_dev_šfo
(
dd
, "%s:„—d idË mes§g0x%Îx\n", 
__func__
, *
d©a_out
);

9220 *
d©a_out
 >>ð
IDLE_PAYLOAD_SHIFT
;

9222 
	}
}

9230 
	$»ad_idË_sma
(
hfi1_devd©a
 *
dd
, 
u64
 *
d©a
)

9232  
	`»ad_idË_mes§ge
(
dd
, (
u64
)
IDLE_SMA
 << 
IDLE_MSG_TYPE_SHIFT
,

9233 
d©a
);

9234 
	}
}

9241 
	$£nd_idË_mes§ge
(
hfi1_devd©a
 *
dd
, 
u64
 
d©a
)

9243 
»t
;

9245 
	`dd_dev_šfo
(
dd
, "%s: s’dšg idË mes§g0x%Îx\n", 
__func__
, 
d©a
);

9246 
»t
 = 
	`do_8051_commªd
(
dd
, 
HCMD_SEND_LCB_IDLE_MSG
, 
d©a
, 
NULL
);

9247 ià(
»t
 !ð
HCMD_SUCCESS
) {

9248 
	`dd_dev_”r
(
dd
, "send idle message: data 0x%llx,ƒrr %d\n",

9249 
d©a
, 
»t
);

9250  -
EINVAL
;

9253 
	}
}

9260 
	$£nd_idË_sma
(
hfi1_devd©a
 *
dd
, 
u64
 
mes§ge
)

9262 
u64
 
d©a
;

9264 
d©a
 = ((
mes§ge
 & 
IDLE_PAYLOAD_MASK
è<< 
IDLE_PAYLOAD_SHIFT
) |

9265 ((
u64
)
IDLE_SMA
 << 
IDLE_MSG_TYPE_SHIFT
);

9266  
	`£nd_idË_mes§ge
(
dd
, 
d©a
);

9267 
	}
}

9275 
	$do_quick_lškup
(
hfi1_devd©a
 *
dd
)

9277 
»t
;

9279 
	`lcb_shutdown
(
dd
, 0);

9281 ià(
loÝback
) {

9284 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LOOPBACK
,

9285 
IB_PACKET_TYPE
 << 
DC_LCB_CFG_LOOPBACK_VAL_SHIFT
);

9286 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LANE_WIDTH
, 0);

9291 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 0);

9294 ià(
loÝback
 && 
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
) {

9296 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_RUN
,

9297 1uÎ << 
DC_LCB_CFG_RUN_EN_SHIFT
);

9299 
»t
 = 
	`wa™_lšk_Œªsãr_aùive
(
dd
, 10);

9300 ià(
»t
)

9301  
»t
;

9303 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_ALLOW_LINK_UP
,

9304 1uÎ << 
DC_LCB_CFG_ALLOW_LINK_UP_VAL_SHIFT
);

9307 ià(!
loÝback
) {

9315 
	`dd_dev_”r
(
dd
,

9317 
	`m¦“p
(5000);

9318 
	`dd_dev_”r
(
dd
, "Continuing with quick†inkup\n");

9321 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, 0);

9322 
	`£t_8051_lcb_acûss
(
dd
);

9329 
»t
 = 
	`£t_physiÿl_lšk_¡©e
(
dd
, 
PLS_QUICK_LINKUP
);

9330 ià(
»t
 !ð
HCMD_SUCCESS
) {

9331 
	`dd_dev_”r
(
dd
,

9333 
__func__
, 
»t
);

9335 
	`£t_ho¡_lcb_acûss
(
dd
);

9336 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, ~0ull);

9338 ià(
»t
 >= 0)

9339 
»t
 = -
EINVAL
;

9340  
»t
;

9344 
	}
}

9349 
	$š™_loÝback
(
hfi1_devd©a
 *
dd
)

9351 
	`dd_dev_šfo
(
dd
, "Entering†oopback mode\n");

9354 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_MODE
,

9355 (
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_MODE
è| 
DISABLE_SELF_GUID_CHECK
));

9363 ià((
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
) &&

9364 (
loÝback
 =ð
LOOPBACK_SERDES
 ||†oÝback =ð
LOOPBACK_LCB
 ||

9365 
loÝback
 =ð
LOOPBACK_CABLE
)) {

9366 
loÝback
 = 
LOOPBACK_LCB
;

9367 
quick_lškup
 = 1;

9374 ià(
loÝback
 =ð
LOOPBACK_SERDES
)

9378 ià(
loÝback
 =ð
LOOPBACK_LCB
) {

9379 
quick_lškup
 = 1;

9382 ià(
dd
->
icode
 =ð
ICODE_FPGA_EMULATION
) {

9383 
	`dd_dev_”r
(
dd
,

9385  -
EINVAL
;

9391 ià(
loÝback
 =ð
LOOPBACK_CABLE
)

9394 
	`dd_dev_”r
(
dd
, "Inv®id†oÝback mod%d\n", 
loÝback
);

9395  -
EINVAL
;

9396 
	}
}

9402 
u16
 
	$Ýa_to_vc_lšk_widths
(
u16
 
Ýa_widths
)

9404 
i
;

9405 
u16
 
»suÉ
 = 0;

9407 cÚ¡ 
	slšk_b™s
 {

9408 
u16
 
äom
;

9409 
u16
 
to
;

9410 } 
Ýa_lšk_xÏ‹
[] = {

9411 { 
OPA_LINK_WIDTH_1X
, 1 << (1 - 1) },

9412 { 
OPA_LINK_WIDTH_2X
, 1 << (2 - 1) },

9413 { 
OPA_LINK_WIDTH_3X
, 1 << (3 - 1) },

9414 { 
OPA_LINK_WIDTH_4X
, 1 << (4 - 1) },

9417 
i
 = 0; i < 
	`ARRAY_SIZE
(
Ýa_lšk_xÏ‹
); i++) {

9418 ià(
Ýa_widths
 & 
Ýa_lšk_xÏ‹
[
i
].
äom
)

9419 
»suÉ
 |ð
Ýa_lšk_xÏ‹
[
i
].
to
;

9421  
»suÉ
;

9422 
	}
}

9427 
	$£t_loÿl_lšk_©Œibu‹s
(
hfi1_µÜtd©a
 *
µd
)

9429 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9430 
u8
 
’abË_ÏÃ_tx
;

9431 
u8
 
tx_pÞ¬™y_šv”siÚ
;

9432 
u8
 
rx_pÞ¬™y_šv”siÚ
;

9433 
»t
;

9434 
u32
 
misc_b™s
 = 0;

9436 
	`çbric_£rdes_»£t
(
dd
);

9439 
»t
 = 
	`»ad_tx_£‰šgs
(
dd
, &
’abË_ÏÃ_tx
, &
tx_pÞ¬™y_šv”siÚ
,

9440 &
rx_pÞ¬™y_šv”siÚ
, &
µd
->
loÿl_tx_¿‹
);

9441 ià(
»t
)

9442 
£t_loÿl_lšk_©Œibu‹s_çž
;

9444 ià(
dd
->
dc8051_v”
 < 
	`dc8051_v”
(0, 20, 0)) {

9446 ià(
µd
->
lšk_¥“d_’abËd
 & 
OPA_LINK_SPEED_25G
)

9447 
µd
->
loÿl_tx_¿‹
 = 1;

9449 
µd
->
loÿl_tx_¿‹
 = 0;

9452 
µd
->
loÿl_tx_¿‹
 = 0;

9453 ià(
µd
->
lšk_¥“d_’abËd
 & 
OPA_LINK_SPEED_25G
)

9454 
µd
->
loÿl_tx_¿‹
 |= 2;

9455 ià(
µd
->
lšk_¥“d_’abËd
 & 
OPA_LINK_SPEED_12_5G
)

9456 
µd
->
loÿl_tx_¿‹
 |= 1;

9459 
’abË_ÏÃ_tx
 = 0xF;

9460 
»t
 = 
	`wr™e_tx_£‰šgs
(
dd
, 
’abË_ÏÃ_tx
, 
tx_pÞ¬™y_šv”siÚ
,

9461 
rx_pÞ¬™y_šv”siÚ
, 
µd
->
loÿl_tx_¿‹
);

9462 ià(
»t
 !ð
HCMD_SUCCESS
)

9463 
£t_loÿl_lšk_©Œibu‹s_çž
;

9465 
»t
 = 
	`wr™e_ho¡_š‹rçû_v”siÚ
(
dd
, 
HOST_INTERFACE_VERSION
);

9466 ià(
»t
 !ð
HCMD_SUCCESS
) {

9467 
	`dd_dev_”r
(
dd
,

9469 
»t
);

9470 
£t_loÿl_lšk_©Œibu‹s_çž
;

9476 
»t
 = 
	`wr™e_vc_loÿl_phy
(
dd
,

9479 ià(
»t
 !ð
HCMD_SUCCESS
)

9480 
£t_loÿl_lšk_©Œibu‹s_çž
;

9483 
»t
 = 
	`wr™e_vc_loÿl_çbric
(
dd
, dd->
vau
, 1, dd->
vcu
, dd->
vl15_š™
,

9484 
µd
->
pÜt_üc_mode_’abËd
);

9485 ià(
»t
 !ð
HCMD_SUCCESS
)

9486 
£t_loÿl_lšk_©Œibu‹s_çž
;

9492 ià(
loÝback
 =ð
LOOPBACK_SERDES
)

9493 
misc_b™s
 |ð1 << 
LOOPBACK_SERDES_CONFIG_BIT_MASK_SHIFT
;

9500 ià(
dd
->
dc8051_v”
 >ð
	`dc8051_v”
(1, 25, 0))

9501 
misc_b™s
 |ð1 << 
EXT_CFG_LCB_RESET_SUPPORTED_SHIFT
;

9503 
»t
 = 
	`wr™e_vc_loÿl_lšk_mode
(
dd
, 
misc_b™s
, 0,

9504 
	`Ýa_to_vc_lšk_widths
(

9505 
µd
->
lšk_width_’abËd
));

9506 ià(
»t
 !ð
HCMD_SUCCESS
)

9507 
£t_loÿl_lšk_©Œibu‹s_çž
;

9510 
»t
 = 
	`wr™e_loÿl_deviû_id
(
dd
, dd->
pcidev
->
deviû
, dd->
mš»v
);

9511 ià(
»t
 =ð
HCMD_SUCCESS
)

9514 
£t_loÿl_lšk_©Œibu‹s_çž
:

9515 
	`dd_dev_”r
(
dd
,

9517 
»t
);

9518  
»t
;

9519 
	}
}

9526 
	$¡¬t_lšk
(
hfi1_µÜtd©a
 *
µd
)

9532 
	`tuÃ_£rdes
(
µd
);

9534 ià(!
µd
->
driv”_lšk_»ady
) {

9535 
	`dd_dev_šfo
(
µd
->
dd
,

9537 
__func__
);

9546 
	`þ—r_fuÎ_mgmt_pkey
(
µd
);

9548  
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_POLL
);

9549 
	}
}

9551 
	$wa™_fÜ_qså_š™
(
hfi1_µÜtd©a
 *
µd
)

9553 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9554 
u64
 
mask
;

9555 
timeout
;

9565 
	`m¦“p
(500);

9570 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(2000);

9572 
mask
 = 
	`»ad_c¤
(
dd
, dd->
hfi1_id
 ?

9573 
ASIC_QSFP2_IN
 : 
ASIC_QSFP1_IN
);

9574 ià(!(
mask
 & 
QSFP_HFI0_INT_N
))

9576 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

9577 
	`dd_dev_šfo
(
dd
, "%s: No IntN detected,„eset complete\n",

9578 
__func__
);

9581 
	`ud–ay
(2);

9583 
	}
}

9585 
	$£t_qså_št_n
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
’abË
)

9587 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9588 
u64
 
mask
;

9590 
mask
 = 
	`»ad_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_MASK
 : 
ASIC_QSFP1_MASK
);

9591 ià(
’abË
) {

9596 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_CLEAR
 : 
ASIC_QSFP1_CLEAR
,

9597 
QSFP_HFI0_INT_N
);

9598 
mask
 |ð(
u64
)
QSFP_HFI0_INT_N
;

9600 
mask
 &ð~(
u64
)
QSFP_HFI0_INT_N
;

9602 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_MASK
 : 
ASIC_QSFP1_MASK
, 
mask
);

9603 
	}
}

9605 
	$»£t_qså
(
hfi1_µÜtd©a
 *
µd
)

9607 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9608 
u64
 
mask
, 
qså_mask
;

9611 
	`£t_qså_št_n
(
µd
, 0);

9614 
mask
 = (
u64
)
QSFP_HFI0_RESET_N
;

9616 
qså_mask
 = 
	`»ad_c¤
(
dd
,

9617 
dd
->
hfi1_id
 ? 
ASIC_QSFP2_OUT
 : 
ASIC_QSFP1_OUT
);

9618 
qså_mask
 &ð~
mask
;

9619 
	`wr™e_c¤
(
dd
,

9620 
dd
->
hfi1_id
 ? 
ASIC_QSFP2_OUT
 : 
ASIC_QSFP1_OUT
, 
qså_mask
);

9622 
	`ud–ay
(10);

9624 
qså_mask
 |ð
mask
;

9625 
	`wr™e_c¤
(
dd
,

9626 
dd
->
hfi1_id
 ? 
ASIC_QSFP2_OUT
 : 
ASIC_QSFP1_OUT
, 
qså_mask
);

9628 
	`wa™_fÜ_qså_š™
(
µd
);

9634 
	`£t_qså_št_n
(
µd
, 1);

9641  
	`£t_qså_tx
(
µd
, 0);

9642 
	}
}

9644 
	$hªdË_qså_”rÜ_cÚd™iÚs
(
hfi1_µÜtd©a
 *
µd
,

9645 
u8
 *
qså_š‹¼u±_¡©us
)

9647 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9649 ià((
qså_š‹¼u±_¡©us
[0] & 
QSFP_HIGH_TEMP_ALARM
) ||

9650 (
qså_š‹¼u±_¡©us
[0] & 
QSFP_HIGH_TEMP_WARNING
))

9651 
	`dd_dev_”r
(
dd
, "%s: QSFP cableemperatureoo high\n",

9652 
__func__
);

9654 ià((
qså_š‹¼u±_¡©us
[0] & 
QSFP_LOW_TEMP_ALARM
) ||

9655 (
qså_š‹¼u±_¡©us
[0] & 
QSFP_LOW_TEMP_WARNING
))

9656 
	`dd_dev_”r
(
dd
, "%s: QSFP cableemperatureoo†ow\n",

9657 
__func__
);

9662 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_DOWN
)

9665 ià((
qså_š‹¼u±_¡©us
[1] & 
QSFP_HIGH_VCC_ALARM
) ||

9666 (
qså_š‹¼u±_¡©us
[1] & 
QSFP_HIGH_VCC_WARNING
))

9667 
	`dd_dev_”r
(
dd
, "%s: QSFP supply voltageoo high\n",

9668 
__func__
);

9670 ià((
qså_š‹¼u±_¡©us
[1] & 
QSFP_LOW_VCC_ALARM
) ||

9671 (
qså_š‹¼u±_¡©us
[1] & 
QSFP_LOW_VCC_WARNING
))

9672 
	`dd_dev_”r
(
dd
, "%s: QSFP supply voltageoo†ow\n",

9673 
__func__
);

9677 ià((
qså_š‹¼u±_¡©us
[3] & 
QSFP_HIGH_POWER_ALARM
) ||

9678 (
qså_š‹¼u±_¡©us
[3] & 
QSFP_HIGH_POWER_WARNING
))

9679 
	`dd_dev_”r
(
dd
, "%s: Cable RX channel 1/2…oweroo high\n",

9680 
__func__
);

9682 ià((
qså_š‹¼u±_¡©us
[3] & 
QSFP_LOW_POWER_ALARM
) ||

9683 (
qså_š‹¼u±_¡©us
[3] & 
QSFP_LOW_POWER_WARNING
))

9684 
	`dd_dev_”r
(
dd
, "%s: Cable RX channel 1/2…oweroo†ow\n",

9685 
__func__
);

9687 ià((
qså_š‹¼u±_¡©us
[4] & 
QSFP_HIGH_POWER_ALARM
) ||

9688 (
qså_š‹¼u±_¡©us
[4] & 
QSFP_HIGH_POWER_WARNING
))

9689 
	`dd_dev_”r
(
dd
, "%s: Cable RX channel 3/4…oweroo high\n",

9690 
__func__
);

9692 ià((
qså_š‹¼u±_¡©us
[4] & 
QSFP_LOW_POWER_ALARM
) ||

9693 (
qså_š‹¼u±_¡©us
[4] & 
QSFP_LOW_POWER_WARNING
))

9694 
	`dd_dev_”r
(
dd
, "%s: Cable RX channel 3/4…oweroo†ow\n",

9695 
__func__
);

9697 ià((
qså_š‹¼u±_¡©us
[5] & 
QSFP_HIGH_BIAS_ALARM
) ||

9698 (
qså_š‹¼u±_¡©us
[5] & 
QSFP_HIGH_BIAS_WARNING
))

9699 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 1/2 biasoo high\n",

9700 
__func__
);

9702 ià((
qså_š‹¼u±_¡©us
[5] & 
QSFP_LOW_BIAS_ALARM
) ||

9703 (
qså_š‹¼u±_¡©us
[5] & 
QSFP_LOW_BIAS_WARNING
))

9704 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 1/2 biasoo†ow\n",

9705 
__func__
);

9707 ià((
qså_š‹¼u±_¡©us
[6] & 
QSFP_HIGH_BIAS_ALARM
) ||

9708 (
qså_š‹¼u±_¡©us
[6] & 
QSFP_HIGH_BIAS_WARNING
))

9709 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 3/4 biasoo high\n",

9710 
__func__
);

9712 ià((
qså_š‹¼u±_¡©us
[6] & 
QSFP_LOW_BIAS_ALARM
) ||

9713 (
qså_š‹¼u±_¡©us
[6] & 
QSFP_LOW_BIAS_WARNING
))

9714 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 3/4 biasoo†ow\n",

9715 
__func__
);

9717 ià((
qså_š‹¼u±_¡©us
[7] & 
QSFP_HIGH_POWER_ALARM
) ||

9718 (
qså_š‹¼u±_¡©us
[7] & 
QSFP_HIGH_POWER_WARNING
))

9719 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 1/2…oweroo high\n",

9720 
__func__
);

9722 ià((
qså_š‹¼u±_¡©us
[7] & 
QSFP_LOW_POWER_ALARM
) ||

9723 (
qså_š‹¼u±_¡©us
[7] & 
QSFP_LOW_POWER_WARNING
))

9724 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 1/2…oweroo†ow\n",

9725 
__func__
);

9727 ià((
qså_š‹¼u±_¡©us
[8] & 
QSFP_HIGH_POWER_ALARM
) ||

9728 (
qså_š‹¼u±_¡©us
[8] & 
QSFP_HIGH_POWER_WARNING
))

9729 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 3/4…oweroo high\n",

9730 
__func__
);

9732 ià((
qså_š‹¼u±_¡©us
[8] & 
QSFP_LOW_POWER_ALARM
) ||

9733 (
qså_š‹¼u±_¡©us
[8] & 
QSFP_LOW_POWER_WARNING
))

9734 
	`dd_dev_”r
(
dd
, "%s: Cable TX channel 3/4…oweroo†ow\n",

9735 
__func__
);

9741 
	}
}

9744 
	$qså_ev’t
(
wÜk_¡ruù
 *
wÜk
)

9746 
qså_d©a
 *
qd
;

9747 
hfi1_µÜtd©a
 *
µd
;

9748 
hfi1_devd©a
 *
dd
;

9750 
qd
 = 
	`cÚš”_of
(
wÜk
, 
qså_d©a
, 
qså_wÜk
);

9751 
µd
 = 
qd
->ppd;

9752 
dd
 = 
µd
->dd;

9755 ià(!
	`qså_mod_´e£Á
(
µd
))

9758 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_DISABLE
) {

9759 
	`dd_dev_šfo
(
µd
->
dd
,

9761 
__func__
);

9769 
	`dc_¡¬t
(
dd
);

9771 ià(
qd
->
ÿche_»äesh_»quœed
) {

9772 
	`£t_qså_št_n
(
µd
, 0);

9774 
	`wa™_fÜ_qså_š™
(
µd
);

9780 
	`£t_qså_št_n
(
µd
, 1);

9782 
	`¡¬t_lšk
(
µd
);

9785 ià(
qd
->
check_š‹¼u±_æags
) {

9786 
u8
 
qså_š‹¼u±_¡©us
[16] = {0,};

9788 ià(
	`Úe_qså_»ad
(
µd
, 
dd
->
hfi1_id
, 6,

9789 &
qså_š‹¼u±_¡©us
[0], 16) != 16) {

9790 
	`dd_dev_šfo
(
dd
,

9792 
__func__
);

9794 
æags
;

9796 
	`hªdË_qså_”rÜ_cÚd™iÚs
(

9797 
µd
, 
qså_š‹¼u±_¡©us
);

9798 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

9799 
µd
->
qså_šfo
.
check_š‹¼u±_æags
 = 0;

9800 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
,

9801 
æags
);

9804 
	}
}

9806 
	$š™_qså_št
(
hfi1_devd©a
 *
dd
)

9808 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

9809 
u64
 
qså_mask
;

9811 
qså_mask
 = (
u64
)(
QSFP_HFI0_INT_N
 | 
QSFP_HFI0_MODPRST_N
);

9813 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_CLEAR
 : 
ASIC_QSFP1_CLEAR
,

9814 
qså_mask
);

9815 
	`wr™e_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_MASK
 : 
ASIC_QSFP1_MASK
,

9816 
qså_mask
);

9818 
	`£t_qså_št_n
(
µd
, 0);

9821 ià(
	`qså_mod_´e£Á
(
µd
))

9822 
qså_mask
 &ð~(
u64
)
QSFP_HFI0_MODPRST_N
;

9823 
	`wr™e_c¤
(
dd
,

9824 
dd
->
hfi1_id
 ? 
ASIC_QSFP2_INVERT
 : 
ASIC_QSFP1_INVERT
,

9825 
qså_mask
);

9828 ià(!
dd
->
hfi1_id
)

9829 
	`£t_šŒ_b™s
(
dd
, 
QSFP1_INT
, QSFP1_INT, 
Œue
);

9831 
	`£t_šŒ_b™s
(
dd
, 
QSFP2_INT
, QSFP2_INT, 
Œue
);

9832 
	}
}

9837 
	$š™_lcb
(
hfi1_devd©a
 *
dd
)

9840 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
)

9846 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 0x01);

9847 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LANE_WIDTH
, 0x00);

9848 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_REINIT_AS_SLAVE
, 0x00);

9849 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_CNT_FOR_SKIP_STALL
, 0x110);

9850 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_CLK_CNTR
, 0x08);

9851 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LOOPBACK
, 0x02);

9852 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 0x00);

9853 
	}
}

9859 
	$‹¡_qså_»ad
(
hfi1_µÜtd©a
 *
µd
)

9861 
»t
;

9862 
u8
 
¡©us
;

9868 ià(
µd
->
pÜt_ty³
 !ð
PORT_TYPE_QSFP
 || !
	`qså_mod_´e£Á
(ppd))

9872 
»t
 = 
	`Úe_qså_»ad
(
µd
,…pd->
dd
->
hfi1_id
, 2, &
¡©us
, 1);

9873 ià(
»t
 < 0)

9874  
»t
;

9875 ià(
»t
 != 1)

9876  -
EIO
;

9879 
	}
}

9887 
	#MAX_QSFP_RETRIES
 20

	)

9888 
	#QSFP_RETRY_WAIT
 500

	)

9894 
	$Œy_¡¬t_lšk
(
hfi1_µÜtd©a
 *
µd
)

9896 ià(
	`‹¡_qså_»ad
(
µd
)) {

9898 ià(
µd
->
qså_»Œy_couÁ
 >ð
MAX_QSFP_RETRIES
) {

9899 
	`dd_dev_”r
(
µd
->
dd
, "QSFP‚ot„esponding, giving up\n");

9902 
	`dd_dev_šfo
(
µd
->
dd
,

9904 ()
µd
->
qså_»Œy_couÁ
);

9905 
µd
->
qså_»Œy_couÁ
++;

9906 
	`queue_d–ayed_wÜk
(
µd
->
lšk_wq
, &µd->
¡¬t_lšk_wÜk
,

9907 
	`m£cs_to_jiff›s
(
QSFP_RETRY_WAIT
));

9910 
µd
->
qså_»Œy_couÁ
 = 0;

9912 
	`¡¬t_lšk
(
µd
);

9913 
	}
}

9918 
	$hªdË_¡¬t_lšk
(
wÜk_¡ruù
 *
wÜk
)

9920 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

9921 
¡¬t_lšk_wÜk
.
wÜk
);

9922 
	`Œy_¡¬t_lšk
(
µd
);

9923 
	}
}

9925 
	$bršgup_£rdes
(
hfi1_µÜtd©a
 *
µd
)

9927 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9928 
u64
 
guid
;

9929 
»t
;

9931 ià(
	`HFI1_CAP_IS_KSET
(
EXTENDED_PSN
))

9932 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_EXTENDED_PSN_ENABLE_SMASK
);

9934 
guid
 = 
µd
->
guids
[
HFI1_PORT_GUID_INDEX
];

9935 ià(!
guid
) {

9936 ià(
dd
->
ba£_guid
)

9937 
guid
 = 
dd
->
ba£_guid
 + 
µd
->
pÜt
 - 1;

9938 
µd
->
guids
[
HFI1_PORT_GUID_INDEX
] = 
guid
;

9942 
µd
->
lškš™_»asÚ
 = 
OPA_LINKINIT_REASON_LINKUP
;

9945 
	`š™_lcb
(
dd
);

9947 ià(
loÝback
) {

9948 
»t
 = 
	`š™_loÝback
(
dd
);

9949 ià(
»t
 < 0)

9950  
»t
;

9953 
	`g‘_pÜt_ty³
(
µd
);

9954 ià(
µd
->
pÜt_ty³
 =ð
PORT_TYPE_QSFP
) {

9955 
	`£t_qså_št_n
(
µd
, 0);

9956 
	`wa™_fÜ_qså_š™
(
µd
);

9957 
	`£t_qså_št_n
(
µd
, 1);

9960 
	`Œy_¡¬t_lšk
(
µd
);

9962 
	}
}

9964 
	$hfi1_qu›t_£rdes
(
hfi1_µÜtd©a
 *
µd
)

9966 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

9975 
µd
->
driv”_lšk_»ady
 = 0;

9976 
µd
->
lšk_’abËd
 = 0;

9978 
µd
->
qså_»Œy_couÁ
 = 
MAX_QSFP_RETRIES
;

9979 
	`æush_d–ayed_wÜk
(&
µd
->
¡¬t_lšk_wÜk
);

9980 
	`ÿnûl_d–ayed_wÜk_sync
(&
µd
->
¡¬t_lšk_wÜk
);

9982 
µd
->
ofæše_di§bËd_»asÚ
 =

9983 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_REBOOT
);

9984 
	`£t_lšk_down_»asÚ
(
µd
, 
OPA_LINKDOWN_REASON_REBOOT
, 0,

9985 
OPA_LINKDOWN_REASON_REBOOT
);

9986 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

9989 
	`þ—r_rcvù¾
(
dd
, 
RCV_CTRL_RCV_PORT_ENABLE_SMASK
);

9990 
	`ÿnûl_wÜk_sync
(&
µd
->
ä“ze_wÜk
);

9991 
	}
}

9993 
šlše
 
	$š™_ýu_couÁ”s
(
hfi1_devd©a
 *
dd
)

9995 
hfi1_µÜtd©a
 *
µd
;

9996 
i
;

9998 
µd
 = (
hfi1_µÜtd©a
 *)(
dd
 + 1);

9999 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

10000 
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
 = 
NULL
;

10001 
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
 = 
NULL
;

10002 
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
 = 
	`®loc_³rýu
(
u64
);

10003 
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
 = 
	`®loc_³rýu
(
u64
);

10004 
µd
->
ibpÜt_d©a
.
rvp
.
rc_d–ayed_comp
 = 
	`®loc_³rýu
(
u64
);

10005 ià(!
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
 ||

10006 !
µd
->
ibpÜt_d©a
.
rvp
.
rc_d–ayed_comp
 ||

10007 !
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
)

10008  -
ENOMEM
;

10012 
	}
}

10017 
	$hfi1_put_tid
(
hfi1_devd©a
 *
dd
, 
u32
 
šdex
,

10018 
u32
 
ty³
, 
·
, 
u16
 
Üd”
)

10020 
u64
 
»g
;

10022 ià(!(
dd
->
æags
 & 
HFI1_PRESENT
))

10023 
dÚe
;

10025 ià(
ty³
 =ð
PT_INVALID
 ||y³ =ð
PT_INVALID_FLUSH
) {

10026 
·
 = 0;

10027 
Üd”
 = 0;

10028 } ià(
ty³
 > 
PT_INVALID
) {

10029 
	`dd_dev_”r
(
dd
,

10031 
ty³
, 
šdex
);

10032 
dÚe
;

10034 
	`Œaû_hfi1_put_tid
(
dd
, 
šdex
, 
ty³
, 
·
, 
Üd”
);

10036 
	#RT_ADDR_SHIFT
 12

	)

10037 
»g
 = 
RCV_ARRAY_RT_WRITE_ENABLE_SMASK


10038 | (
u64
)
Üd”
 << 
RCV_ARRAY_RT_BUF_SIZE_SHIFT


10039 | ((
·
 >> 
RT_ADDR_SHIFT
è& 
RCV_ARRAY_RT_ADDR_MASK
)

10040 << 
RCV_ARRAY_RT_ADDR_SHIFT
;

10041 
	`Œaû_hfi1_wr™e_rcv¬¿y
(
dd
->
rcv¬¿y_wc
 + (
šdex
 * 8), 
»g
);

10042 
	`wr™eq
(
»g
, 
dd
->
rcv¬¿y_wc
 + (
šdex
 * 8));

10044 ià(
ty³
 =ð
PT_EAGER
 ||y³ =ð
PT_INVALID_FLUSH
 || (
šdex
 & 3) == 3)

10050 
	`æush_wc
();

10051 
dÚe
:

10053 
	}
}

10055 
	$hfi1_þ—r_tids
(
hfi1_ùxtd©a
 *
rcd
)

10057 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

10058 
u32
 
i
;

10061 
i
 = 
rcd
->
—g”_ba£
; i <„cd->eager_base +

10062 
rcd
->
egrbufs
.
®loûd
; 
i
++)

10063 
	`hfi1_put_tid
(
dd
, 
i
, 
PT_INVALID
, 0, 0);

10065 
i
 = 
rcd
->
ex³ùed_ba£
;

10066 
i
 < 
rcd
->
ex³ùed_ba£
 +„cd->
ex³ùed_couÁ
; i++)

10067 
	`hfi1_put_tid
(
dd
, 
i
, 
PT_INVALID
, 0, 0);

10068 
	}
}

10070 cÚ¡ * cÚ¡ 
	gib_cfg_Çme_¡ršgs
[] = {

10095 cÚ¡ *
	$ib_cfg_Çme
(
which
)

10097 ià(
which
 < 0 || which >ð
	`ARRAY_SIZE
(
ib_cfg_Çme_¡ršgs
))

10099  
ib_cfg_Çme_¡ršgs
[
which
];

10100 
	}
}

10102 
	$hfi1_g‘_ib_cfg
(
hfi1_µÜtd©a
 *
µd
, 
which
)

10104 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10105 
v®
 = 0;

10107 
which
) {

10108 
HFI1_IB_CFG_LWID_ENB
:

10109 
v®
 = 
µd
->
lšk_width_’abËd
;

10111 
HFI1_IB_CFG_LWID
:

10112 
v®
 = 
µd
->
lšk_width_aùive
;

10114 
HFI1_IB_CFG_SPD_ENB
:

10115 
v®
 = 
µd
->
lšk_¥“d_’abËd
;

10117 
HFI1_IB_CFG_SPD
:

10118 
v®
 = 
µd
->
lšk_¥“d_aùive
;

10121 
HFI1_IB_CFG_RXPOL_ENB
:

10122 
HFI1_IB_CFG_LREV_ENB
:

10123 
HFI1_IB_CFG_LINKLATENCY
:

10124 
unim¶em’‹d
;

10126 
HFI1_IB_CFG_OP_VLS
:

10127 
v®
 = 
µd
->
aùu®_vls_Ý”©iÚ®
;

10129 
HFI1_IB_CFG_VL_HIGH_CAP
:

10130 
v®
 = 
VL_ARB_HIGH_PRIO_TABLE_SIZE
;

10132 
HFI1_IB_CFG_VL_LOW_CAP
:

10133 
v®
 = 
VL_ARB_LOW_PRIO_TABLE_SIZE
;

10135 
HFI1_IB_CFG_OVERRUN_THRESH
:

10136 
v®
 = 
µd
->
ov”run_th»shÞd
;

10138 
HFI1_IB_CFG_PHYERR_THRESH
:

10139 
v®
 = 
µd
->
phy_”rÜ_th»shÞd
;

10141 
HFI1_IB_CFG_LINKDEFAULT
:

10142 
v®
 = 
HLS_DEFAULT
;

10145 
HFI1_IB_CFG_HRTBT
:

10146 
HFI1_IB_CFG_PMA_TICKS
:

10148 
unim¶em’‹d
:

10149 ià(
	`HFI1_CAP_IS_KSET
(
PRINT_UNIMPL
))

10150 
	`dd_dev_šfo
(

10151 
dd
,

10153 
__func__
,

10154 
	`ib_cfg_Çme
(
which
));

10158  
v®
;

10159 
	}
}

10164 
	#MAX_MAD_PACKET
 2048

	)

10175 
u32
 
	$Ìh_max_h—d”_by‹s
(
hfi1_devd©a
 *
dd
)

10187  (
	`g‘_hdrq’tsize
(
dd
->
rcd
[0]) - 2 + 1 ) << 2;

10188 
	}
}

10201 
	$£t_£nd_Ëngth
(
hfi1_µÜtd©a
 *
µd
)

10203 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10204 
u32
 
max_hb
 = 
	`Ìh_max_h—d”_by‹s
(
dd
), 
dcmtu
;

10205 
u32
 
maxvlmtu
 = 
dd
->
vld
[15].
mtu
;

10206 
u64
 
Ën1
 = 0, 
Ën2
 = (((
dd
->
vld
[15].
mtu
 + 
max_hb
) >> 2)

10207 & 
SEND_LEN_CHECK1_LEN_VL15_MASK
) <<

10208 
SEND_LEN_CHECK1_LEN_VL15_SHIFT
;

10209 
i
, 
j
;

10210 
u32
 
th»s
;

10212 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++) {

10213 ià(
dd
->
vld
[
i
].
mtu
 > 
maxvlmtu
)

10214 
maxvlmtu
 = 
dd
->
vld
[
i
].
mtu
;

10215 ià(
i
 <= 3)

10216 
Ën1
 |ð(((
dd
->
vld
[
i
].
mtu
 + 
max_hb
) >> 2)

10217 & 
SEND_LEN_CHECK0_LEN_VL0_MASK
) <<

10218 ((
i
 % 4è* 
SEND_LEN_CHECK0_LEN_VL1_SHIFT
);

10220 
Ën2
 |ð(((
dd
->
vld
[
i
].
mtu
 + 
max_hb
) >> 2)

10221 & 
SEND_LEN_CHECK1_LEN_VL4_MASK
) <<

10222 ((
i
 % 4è* 
SEND_LEN_CHECK1_LEN_VL5_SHIFT
);

10224 
	`wr™e_c¤
(
dd
, 
SEND_LEN_CHECK0
, 
Ën1
);

10225 
	`wr™e_c¤
(
dd
, 
SEND_LEN_CHECK1
, 
Ën2
);

10228 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++) {

10229 
th»s
 = 
	`mš
(
	`sc_³rûÁ_to_th»shÞd
(
dd
->
vld
[
i
].
sc
, 50),

10230 
	`sc_mtu_to_th»shÞd
(
dd
->
vld
[
i
].
sc
,

10231 
dd
->
vld
[
i
].
mtu
,

10232 
	`g‘_hdrq’tsize
(
dd
->
rcd
[0])));

10233 
j
 = 0; j < 
INIT_SC_PER_VL
; j++)

10234 
	`sc_£t_ü_th»shÞd
(

10235 
	`pio_£Ëù_£nd_cÚ‹xt_vl
(
dd
, 
j
, 
i
),

10236 
th»s
);

10238 
th»s
 = 
	`mš
(
	`sc_³rûÁ_to_th»shÞd
(
dd
->
vld
[15].
sc
, 50),

10239 
	`sc_mtu_to_th»shÞd
(
dd
->
vld
[15].
sc
,

10240 
dd
->
vld
[15].
mtu
,

10241 
dd
->
rcd
[0]->
rcvhdrq’tsize
));

10242 
	`sc_£t_ü_th»shÞd
(
dd
->
vld
[15].
sc
, 
th»s
);

10245 
dcmtu
 = 
maxvlmtu
 =ð10240 ? 
DCC_CFG_PORT_MTU_CAP_10240
 :

10246 (
	`žog2
(
maxvlmtu
 >> 8) + 1);

10247 
Ën1
 = 
	`»ad_c¤
(
µd
->
dd
, 
DCC_CFG_PORT_CONFIG
);

10248 
Ën1
 &ð~
DCC_CFG_PORT_CONFIG_MTU_CAP_SMASK
;

10249 
Ën1
 |ð((
u64
)
dcmtu
 & 
DCC_CFG_PORT_CONFIG_MTU_CAP_MASK
) <<

10250 
DCC_CFG_PORT_CONFIG_MTU_CAP_SHIFT
;

10251 
	`wr™e_c¤
(
µd
->
dd
, 
DCC_CFG_PORT_CONFIG
, 
Ën1
);

10252 
	}
}

10254 
	$£t_lidlmc
(
hfi1_µÜtd©a
 *
µd
)

10256 
i
;

10257 
u64
 
¤eg
 = 0;

10258 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10259 
u32
 
mask
 = ~((1U << 
µd
->
lmc
) - 1);

10260 
u64
 
c1
 = 
	`»ad_c¤
(
µd
->
dd
, 
DCC_CFG_PORT_CONFIG1
);

10261 
u32
 
lid
;

10267 
lid
 = (
µd
->lid >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) ? 0 :…pd->lid;

10268 ià(
dd
->
hfi1_¢oÝ
.
mode_æag
)

10269 
	`dd_dev_šfo
(
dd
, "Set†id/lmc while snooping");

10271 
c1
 &ð~(
DCC_CFG_PORT_CONFIG1_TARGET_DLID_SMASK


10272 | 
DCC_CFG_PORT_CONFIG1_DLID_MASK_SMASK
);

10273 
c1
 |ð((
lid
 & 
DCC_CFG_PORT_CONFIG1_TARGET_DLID_MASK
)

10274 << 
DCC_CFG_PORT_CONFIG1_TARGET_DLID_SHIFT
) |

10275 ((
mask
 & 
DCC_CFG_PORT_CONFIG1_DLID_MASK_MASK
)

10276 << 
DCC_CFG_PORT_CONFIG1_DLID_MASK_SHIFT
);

10277 
	`wr™e_c¤
(
µd
->
dd
, 
DCC_CFG_PORT_CONFIG1
, 
c1
);

10282 
¤eg
 = ((
mask
 & 
SEND_CTXT_CHECK_SLID_MASK_MASK
) <<

10283 
SEND_CTXT_CHECK_SLID_MASK_SHIFT
) |

10284 (((
lid
 & 
mask
è& 
SEND_CTXT_CHECK_SLID_VALUE_MASK
) <<

10285 
SEND_CTXT_CHECK_SLID_VALUE_SHIFT
);

10287 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++) {

10288 
	`hfi1_cdbg
(
LINKVERB
, "SendContext[%d].SLID_CHECK = 0x%x",

10289 
i
, (
u32
)
¤eg
);

10290 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_SLID
, 
¤eg
);

10294 
	`sdma_upd©e_lmc
(
dd
, 
mask
, 
lid
);

10295 
	}
}

10297 cÚ¡ *
	$¡©e_com¶‘ed_¡ršg
(
u32
 
com¶‘ed
)

10299 cÚ¡ * cÚ¡ 
¡©e_com¶‘ed
[] = {

10305 ià(
com¶‘ed
 < 
	`ARRAY_SIZE
(
¡©e_com¶‘ed
))

10306  
¡©e_com¶‘ed
[
com¶‘ed
];

10309 
	}
}

10311 cÚ¡ 
	g®l_ÏÃs_d—d_timeout_expœed
[] =

10313 cÚ¡ 
	gtx_out_of_pÞicy
[] =

10315 cÚ¡ 
	gno_¡©e_com¶‘e
[] =

10317 cÚ¡ * cÚ¡ 
	g¡©e_com¶‘e_»asÚs
[] = {

10328 [0x14] = 
no_¡©e_com¶‘e
,

10333 [0x17] = 
tx_out_of_pÞicy
,

10334 [0x20] = 
®l_ÏÃs_d—d_timeout_expœed
,

10337 [0x22] = 
no_¡©e_com¶‘e
,

10340 [0x24] = 
tx_out_of_pÞicy
,

10341 [0x30] = 
®l_ÏÃs_d—d_timeout_expœed
,

10344 [0x32] = 
no_¡©e_com¶‘e
,

10347 [0x34] = 
tx_out_of_pÞicy
,

10354 cÚ¡ *
	$¡©e_com¶‘e_»asÚ_code_¡ršg
(
hfi1_µÜtd©a
 *
µd
,

10355 
u32
 
code
)

10357 cÚ¡ *
¡r
 = 
NULL
;

10359 ià(
code
 < 
	`ARRAY_SIZE
(
¡©e_com¶‘e_»asÚs
))

10360 
¡r
 = 
¡©e_com¶‘e_»asÚs
[
code
];

10362 ià(
¡r
)

10363  
¡r
;

10365 
	}
}

10368 
	$decode_¡©e_com¶‘e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
äame
,

10369 cÚ¡ *
´efix
)

10371 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10372 
u32
 
sucûss
;

10373 
u32
 
¡©e
;

10374 
u32
 
»asÚ
;

10375 
u32
 
ÏÃs
;

10385 
sucûss
 = 
äame
 & 0x1;

10386 
¡©e
 = (
äame
 >> 1) & 0x7;

10387 
»asÚ
 = (
äame
 >> 8) & 0xff;

10388 
ÏÃs
 = (
äame
 >> 16) & 0xffff;

10390 
	`dd_dev_”r
(
dd
, "Last %s LNI state complete frame 0x%08x:\n",

10391 
´efix
, 
äame
);

10392 
	`dd_dev_”r
(
dd
, "†ast„eported state state: %s (0x%x)\n",

10393 
	`¡©e_com¶‘ed_¡ršg
(
¡©e
), state);

10394 
	`dd_dev_”r
(
dd
, " state successfully completed: %s\n",

10395 
sucûss
 ? "yes" : "no");

10396 
	`dd_dev_”r
(
dd
, " fail„eason 0x%x: %s\n",

10397 
»asÚ
, 
	`¡©e_com¶‘e_»asÚ_code_¡ršg
(
µd
,„eason));

10398 
	`dd_dev_”r
(
dd
, "…assšg†ªmask: 0x%x", 
ÏÃs
);

10399 
	}
}

10406 
	$check_Êi_¡©es
(
hfi1_µÜtd©a
 *
µd
)

10408 
u32
 
Ï¡_loÿl_¡©e
;

10409 
u32
 
Ï¡_»mÙe_¡©e
;

10411 
	`»ad_Ï¡_loÿl_¡©e
(
µd
->
dd
, &
Ï¡_loÿl_¡©e
);

10412 
	`»ad_Ï¡_»mÙe_¡©e
(
µd
->
dd
, &
Ï¡_»mÙe_¡©e
);

10419 ià(
Ï¡_loÿl_¡©e
 =ð0 && 
Ï¡_»mÙe_¡©e
 == 0)

10422 
	`decode_¡©e_com¶‘e
(
µd
, 
Ï¡_loÿl_¡©e
, "transmitted");

10423 
	`decode_¡©e_com¶‘e
(
µd
, 
Ï¡_»mÙe_¡©e
, "received");

10424 
	}
}

10427 
	$wa™_lšk_Œªsãr_aùive
(
hfi1_devd©a
 *
dd
, 
wa™_ms
)

10429 
u64
 
»g
;

10430 
timeout
;

10433 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
wa™_ms
);

10435 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_LCB_STS_LINK_TRANSFER_ACTIVE
);

10436 ià(
»g
)

10438 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

10439 
	`dd_dev_”r
(
dd
,

10441  -
ETIMEDOUT
;

10443 
	`ud–ay
(2);

10446 
	}
}

10449 
	$fÜû_logiÿl_lšk_¡©e_down
(
hfi1_µÜtd©a
 *
µd
)

10451 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10456 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 1);

10457 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_IGNORE_LOST_RCLK
,

10458 
DC_LCB_CFG_IGNORE_LOST_RCLK_EN_SMASK
);

10460 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LANE_WIDTH
, 0);

10461 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_REINIT_AS_SLAVE
, 0);

10462 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_CNT_FOR_SKIP_STALL
, 0x110);

10463 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_LOOPBACK
, 0x2);

10465 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 0);

10466 ()
	`»ad_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
);

10467 
	`ud–ay
(3);

10468 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_ALLOW_LINK_UP
, 1);

10469 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_RUN
, 1uÎ << 
DC_LCB_CFG_RUN_EN_SHIFT
);

10471 
	`wa™_lšk_Œªsãr_aùive
(
dd
, 100);

10476 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_TX_FIFOS_RESET
, 1);

10477 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_ALLOW_LINK_UP
, 0);

10478 
	`wr™e_c¤
(
dd
, 
DC_LCB_CFG_IGNORE_LOST_RCLK
, 0);

10480 
	`dd_dev_šfo
(
µd
->
dd
, "logical state forcedo LINK_DOWN\n");

10481 
	}
}

10491 
	$gÙo_ofæše
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
»m_»asÚ
)

10493 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10494 
u32
 
´evious_¡©e
;

10495 
ofæše_¡©e_»t
;

10496 
»t
;

10498 
	`upd©e_lcb_ÿche
(
dd
);

10500 
´evious_¡©e
 = 
µd
->
ho¡_lšk_¡©e
;

10501 
µd
->
ho¡_lšk_¡©e
 = 
HLS_GOING_OFFLINE
;

10504 
»t
 = 
	`£t_physiÿl_lšk_¡©e
(
dd
, (
»m_»asÚ
 << 8è| 
PLS_OFFLINE
);

10506 ià(
»t
 !ð
HCMD_SUCCESS
) {

10507 
	`dd_dev_”r
(
dd
,

10509 
»t
);

10510  -
EINVAL
;

10512 ià(
µd
->
ofæše_di§bËd_»asÚ
 ==

10513 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
))

10514 
µd
->
ofæše_di§bËd_»asÚ
 =

10515 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_TRANSIENT
);

10517 
ofæše_¡©e_»t
 = 
	`wa™_phys_lšk_ofæše_sub¡©es
(
µd
, 10000);

10518 ià(
ofæše_¡©e_»t
 < 0)

10519  
ofæše_¡©e_»t
;

10522 ià(
µd
->
pÜt_ty³
 =ð
PORT_TYPE_QSFP
 &&

10523 
µd
->
qså_šfo
.
lim™šg_aùive
 &&

10524 
	`qså_mod_´e£Á
(
µd
)) {

10525 
»t
;

10527 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
	`qså_»sourû
(dd), 
QSFP_WAIT
);

10528 ià(
»t
 == 0) {

10529 
	`£t_qså_tx
(
µd
, 0);

10530 
	`»Ëa£_ch_»sourû
(
dd
, 
	`qså_»sourû
(dd));

10533 
	`dd_dev_”r
(
dd
,

10542 ià(
ofæše_¡©e_»t
 !ð
PLS_OFFLINE_QUIET
) {

10543 
»t
 = 
	`wa™_physiÿl_lšk¡©e
(
µd
, 
PLS_OFFLINE
, 30000);

10544 ià(
»t
 < 0)

10545  
»t
;

10552 
	`£t_ho¡_lcb_acûss
(
dd
);

10553 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_EN
, ~0ull);

10556 
»t
 = 
	`wa™_logiÿl_lšk¡©e
(
µd
, 
IB_PORT_DOWN
, 1000);

10557 ià(
»t
)

10558 
	`fÜû_logiÿl_lšk_¡©e_down
(
µd
);

10560 
µd
->
ho¡_lšk_¡©e
 = 
HLS_LINK_COOLDOWN
;

10561 
	`upd©e_¡©u¥
(
µd
, 
IB_PORT_DOWN
);

10572 
»t
 = 
	`wa™_fm_»ady
(
dd
, 7000);

10573 ià(
»t
) {

10574 
	`dd_dev_”r
(
dd
,

10577 
µd
->
ho¡_lšk_¡©e
 = 
HLS_DN_OFFLINE
;

10578  
»t
;

10587 
µd
->
ho¡_lšk_¡©e
 = 
HLS_DN_OFFLINE
;

10588 ià(
´evious_¡©e
 & 
HLS_UP
) {

10590 
	`hªdË_lškup_chªge
(
dd
, 0);

10591 } ià(
´evious_¡©e


10592 & (
HLS_DN_POLL
 | 
HLS_VERIFY_CAP
 | 
HLS_GOING_UP
)) {

10594 
	`check_Êi_¡©es
(
µd
);

10597 
µd
->
qså_šfo
.
»£t_Ãeded
 = 0;

10601 
µd
->
lšk_width_aùive
 = 0;

10602 
µd
->
lšk_width_downg¿de_tx_aùive
 = 0;

10603 
µd
->
lšk_width_downg¿de_rx_aùive
 = 0;

10604 
µd
->
cu¼’t_eg»ss_¿‹
 = 0;

10606 
	}
}

10609 cÚ¡ *
	$lšk_¡©e_Çme
(
u32
 
¡©e
)

10611 cÚ¡ *
Çme
;

10612 
n
 = 
	`žog2
(
¡©e
);

10613 cÚ¡ * cÚ¡ 
Çmes
[] = {

10614 [
__HLS_UP_INIT_BP
] = "INIT",

10615 [
__HLS_UP_ARMED_BP
] = "ARMED",

10616 [
__HLS_UP_ACTIVE_BP
] = "ACTIVE",

10617 [
__HLS_DN_DOWNDEF_BP
] = "DOWNDEF",

10618 [
__HLS_DN_POLL_BP
] = "POLL",

10619 [
__HLS_DN_DISABLE_BP
] = "DISABLE",

10620 [
__HLS_DN_OFFLINE_BP
] = "OFFLINE",

10621 [
__HLS_VERIFY_CAP_BP
] = "VERIFY_CAP",

10622 [
__HLS_GOING_UP_BP
] = "GOING_UP",

10623 [
__HLS_GOING_OFFLINE_BP
] = "GOING_OFFLINE",

10624 [
__HLS_LINK_COOLDOWN_BP
] = "LINK_COOLDOWN"

10627 
Çme
 = 
n
 < 
	`ARRAY_SIZE
(
Çmes
è?‚ames[n] : 
NULL
;

10628  
Çme
 ?‚ame : "unknown";

10629 
	}
}

10632 cÚ¡ *
	$lšk_¡©e_»asÚ_Çme
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
)

10634 ià(
¡©e
 =ð
HLS_UP_INIT
) {

10635 
µd
->
lškš™_»asÚ
) {

10636 
OPA_LINKINIT_REASON_LINKUP
:

10638 
OPA_LINKINIT_REASON_FLAPPING
:

10640 
OPA_LINKINIT_OUTSIDE_POLICY
:

10642 
OPA_LINKINIT_QUARANTINED
:

10644 
OPA_LINKINIT_INSUFIC_CAPABILITY
:

10651 
	}
}

10658 
u32
 
	$driv”_p¡©e
(
hfi1_µÜtd©a
 *
µd
)

10660 
µd
->
ho¡_lšk_¡©e
) {

10661 
HLS_UP_INIT
:

10662 
HLS_UP_ARMED
:

10663 
HLS_UP_ACTIVE
:

10664  
IB_PORTPHYSSTATE_LINKUP
;

10665 
HLS_DN_POLL
:

10666  
IB_PORTPHYSSTATE_POLLING
;

10667 
HLS_DN_DISABLE
:

10668  
IB_PORTPHYSSTATE_DISABLED
;

10669 
HLS_DN_OFFLINE
:

10670  
OPA_PORTPHYSSTATE_OFFLINE
;

10671 
HLS_VERIFY_CAP
:

10672  
IB_PORTPHYSSTATE_TRAINING
;

10673 
HLS_GOING_UP
:

10674  
IB_PORTPHYSSTATE_TRAINING
;

10675 
HLS_GOING_OFFLINE
:

10676  
OPA_PORTPHYSSTATE_OFFLINE
;

10677 
HLS_LINK_COOLDOWN
:

10678  
OPA_PORTPHYSSTATE_OFFLINE
;

10679 
HLS_DN_DOWNDEF
:

10681 
	`dd_dev_”r
(
µd
->
dd
, "invalid host_link_state 0x%x\n",

10682 
µd
->
ho¡_lšk_¡©e
);

10685 
	}
}

10692 
u32
 
	$driv”_l¡©e
(
hfi1_µÜtd©a
 *
µd
)

10694 ià(
µd
->
ho¡_lšk_¡©e
 && (µd->ho¡_lšk_¡©& 
HLS_DOWN
))

10695  
IB_PORT_DOWN
;

10697 
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
) {

10698 
HLS_UP_INIT
:

10699  
IB_PORT_INIT
;

10700 
HLS_UP_ARMED
:

10701  
IB_PORT_ARMED
;

10702 
HLS_UP_ACTIVE
:

10703  
IB_PORT_ACTIVE
;

10705 
	`dd_dev_”r
(
µd
->
dd
, "invalid host_link_state 0x%x\n",

10706 
µd
->
ho¡_lšk_¡©e
);

10709 
	}
}

10711 
	$£t_lšk_down_»asÚ
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
lþ_»asÚ
,

10712 
u8
 
Ãigh_»asÚ
, u8 
»m_»asÚ
)

10714 ià(
µd
->
loÿl_lšk_down_»asÚ
.
Ï‹¡
 == 0 &&

10715 
µd
->
Ãigh_lšk_down_»asÚ
.
Ï‹¡
 == 0) {

10716 
µd
->
loÿl_lšk_down_»asÚ
.
Ï‹¡
 = 
lþ_»asÚ
;

10717 
µd
->
Ãigh_lšk_down_»asÚ
.
Ï‹¡
 = 
Ãigh_»asÚ
;

10718 
µd
->
»mÙe_lšk_down_»asÚ
 = 
»m_»asÚ
;

10720 
	}
}

10729 
šlše
 
boÞ
 
	$d©a_vls_Ý”©iÚ®
(
hfi1_µÜtd©a
 *
µd
)

10731 
i
;

10732 
u64
 
»g
;

10734 ià(!
µd
->
aùu®_vls_Ý”©iÚ®
)

10735  
çl£
;

10737 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++) {

10738 
»g
 = 
	`»ad_c¤
(
µd
->
dd
, 
SEND_CM_CREDIT_VL
 + (8 * 
i
));

10739 ià((
»g
 && !
µd
->
dd
->
vld
[
i
].
mtu
) ||

10740 (!
»g
 && 
µd
->
dd
->
vld
[
i
].
mtu
))

10741  
çl£
;

10744  
Œue
;

10745 
	}
}

10755 
	$£t_lšk_¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
)

10757 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

10758 
ib_ev’t
 
ev’t
 = {.
deviû
 = 
NULL
};

10759 
»t1
, 
»t
 = 0;

10760 
Üig_Ãw_¡©e
, 
pÞl_bounû
;

10762 
	`mu‹x_lock
(&
µd
->
hls_lock
);

10764 
Üig_Ãw_¡©e
 = 
¡©e
;

10765 ià(
¡©e
 =ð
HLS_DN_DOWNDEF
)

10766 
¡©e
 = 
HLS_DEFAULT
;

10769 
pÞl_bounû
 = 
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_POLL
 &&

10770 
¡©e
 =ð
HLS_DN_POLL
;

10772 
	`dd_dev_šfo
(
dd
, "%s: cu¼’ˆ%s,‚ew % %s%s\n", 
__func__
,

10773 
	`lšk_¡©e_Çme
(
µd
->
ho¡_lšk_¡©e
),

10774 
	`lšk_¡©e_Çme
(
Üig_Ãw_¡©e
),

10775 
pÞl_bounû
 ? "(bounce) " : "",

10776 
	`lšk_¡©e_»asÚ_Çme
(
µd
, 
¡©e
));

10783 ià(!(
¡©e
 & (
HLS_UP_ARMED
 | 
HLS_UP_ACTIVE
)))

10784 
µd
->
is_sm_cÚfig_¡¬‹d
 = 0;

10790 ià(
µd
->
ho¡_lšk_¡©e
 =ð
¡©e
 && !
pÞl_bounû
)

10791 
dÚe
;

10793 
¡©e
) {

10794 
HLS_UP_INIT
:

10795 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_POLL
 &&

10796 (
quick_lškup
 || 
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
)) {

10805 } ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_GOING_UP
) {

10806 
uÃx³ùed
;

10814 
»t
 = 
	`wa™_physiÿl_lšk¡©e
(
µd
, 
PLS_LINKUP
, 1000);

10815 ià(
»t
) {

10816 
	`dd_dev_”r
(
dd
,

10818 
__func__
);

10822 
»t
 = 
	`wa™_logiÿl_lšk¡©e
(
µd
, 
IB_PORT_INIT
, 1000);

10823 ià(
»t
) {

10824 
	`dd_dev_”r
(
dd
,

10826 
__func__
);

10831 ià(
µd
->
lškš™_»asÚ
 >ð
OPA_LINKINIT_REASON_CLEAR
)

10832 
µd
->
lškš™_»asÚ
 =

10833 
OPA_LINKINIT_REASON_LINKUP
;

10836 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_PORT_ENABLE_SMASK
);

10838 
	`hªdË_lškup_chªge
(
dd
, 1);

10839 
	`pio_k”Ãl_lškup
(
dd
);

10846 
	`upd©e_xm™_couÁ”s
(
µd
,…pd->
lšk_width_aùive
);

10848 
µd
->
ho¡_lšk_¡©e
 = 
HLS_UP_INIT
;

10849 
	`upd©e_¡©u¥
(
µd
, 
IB_PORT_INIT
);

10851 
HLS_UP_ARMED
:

10852 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_UP_INIT
)

10853 
uÃx³ùed
;

10855 ià(!
	`d©a_vls_Ý”©iÚ®
(
µd
)) {

10856 
	`dd_dev_”r
(
dd
,

10858 
__func__
);

10859 
»t
 = -
EINVAL
;

10863 
	`£t_logiÿl_¡©e
(
dd
, 
LSTATE_ARMED
);

10864 
»t
 = 
	`wa™_logiÿl_lšk¡©e
(
µd
, 
IB_PORT_ARMED
, 1000);

10865 ià(
»t
) {

10866 
	`dd_dev_”r
(
dd
,

10868 
__func__
);

10871 
µd
->
ho¡_lšk_¡©e
 = 
HLS_UP_ARMED
;

10872 
	`upd©e_¡©u¥
(
µd
, 
IB_PORT_ARMED
);

10878 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
)

10879 
µd
->
ÃighbÜ_nÜm®
 = 1;

10881 
HLS_UP_ACTIVE
:

10882 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_UP_ARMED
)

10883 
uÃx³ùed
;

10885 
	`£t_logiÿl_¡©e
(
dd
, 
LSTATE_ACTIVE
);

10886 
»t
 = 
	`wa™_logiÿl_lšk¡©e
(
µd
, 
IB_PORT_ACTIVE
, 1000);

10887 ià(
»t
) {

10888 
	`dd_dev_”r
(
dd
,

10890 
__func__
);

10893 
	`sdma_®l_ruÂšg
(
dd
);

10894 
µd
->
ho¡_lšk_¡©e
 = 
HLS_UP_ACTIVE
;

10895 
	`upd©e_¡©u¥
(
µd
, 
IB_PORT_ACTIVE
);

10898 
ev’t
.
deviû
 = &
dd
->
v”bs_dev
.
rdi
.
ibdev
;

10899 
ev’t
.
–em’t
.
pÜt_num
 = 
µd
->
pÜt
;

10900 
ev’t
.ev’ˆð
IB_EVENT_PORT_ACTIVE
;

10903 
HLS_DN_POLL
:

10904 ià((
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_DISABLE
 ||

10905 
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_OFFLINE
) &&

10906 
dd
->
dc_shutdown
)

10907 
	`dc_¡¬t
(
dd
);

10909 
	`wr™e_c¤
(
dd
, 
DCC_CFG_LED_CNTRL
, 0);

10911 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_DN_OFFLINE
) {

10912 
u8
 
tmp
 = 
µd
->
lšk_’abËd
;

10914 
»t
 = 
	`gÙo_ofæše
(
µd
,…pd->
»mÙe_lšk_down_»asÚ
);

10915 ià(
»t
) {

10916 
µd
->
lšk_’abËd
 = 
tmp
;

10919 
µd
->
»mÙe_lšk_down_»asÚ
 = 0;

10921 ià(
µd
->
driv”_lšk_»ady
)

10922 
µd
->
lšk_’abËd
 = 1;

10925 
	`£t_®l_¦ow·th
(
µd
->
dd
);

10926 
»t
 = 
	`£t_loÿl_lšk_©Œibu‹s
(
µd
);

10927 ià(
»t
)

10930 
µd
->
pÜt_”rÜ_aùiÚ
 = 0;

10932 ià(
quick_lškup
) {

10934 
»t
 = 
	`do_quick_lškup
(
dd
);

10936 
»t1
 = 
	`£t_physiÿl_lšk_¡©e
(
dd
, 
PLS_POLLING
);

10937 ià(!
»t1
)

10938 
»t1
 = 
	`wa™_phys_lšk_out_of_ofæše
(
µd
,

10940 ià(
»t1
 !ð
HCMD_SUCCESS
) {

10941 
	`dd_dev_”r
(
dd
,

10943 
»t1
);

10944 
»t
 = -
EINVAL
;

10954 
µd
->
ho¡_lšk_¡©e
 = 
HLS_DN_POLL
;

10955 
µd
->
ofæše_di§bËd_»asÚ
 =

10956 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
);

10961 ià(
»t
)

10962 
	`gÙo_ofæše
(
µd
, 0);

10964 
	`log_physiÿl_¡©e
(
µd
, 
PLS_POLLING
);

10966 
HLS_DN_DISABLE
:

10968 
µd
->
lšk_’abËd
 = 0;

10973 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_DN_OFFLINE
) {

10974 
»t
 = 
	`gÙo_ofæše
(
µd
,…pd->
»mÙe_lšk_down_»asÚ
);

10975 ià(
»t
)

10977 
µd
->
»mÙe_lšk_down_»asÚ
 = 0;

10980 ià(!
dd
->
dc_shutdown
) {

10981 
»t1
 = 
	`£t_physiÿl_lšk_¡©e
(
dd
, 
PLS_DISABLED
);

10982 ià(
»t1
 !ð
HCMD_SUCCESS
) {

10983 
	`dd_dev_”r
(
dd
,

10985 
»t1
);

10986 
»t
 = -
EINVAL
;

10989 
»t
 = 
	`wa™_physiÿl_lšk¡©e
(
µd
, 
PLS_DISABLED
, 10000);

10990 ià(
»t
) {

10991 
	`dd_dev_”r
(
dd
,

10993 
__func__
);

10996 
	`dc_shutdown
(
dd
);

10998 
µd
->
ho¡_lšk_¡©e
 = 
HLS_DN_DISABLE
;

11000 
HLS_DN_OFFLINE
:

11001 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_DN_DISABLE
)

11002 
	`dc_¡¬t
(
dd
);

11005 
»t
 = 
	`gÙo_ofæše
(
µd
,…pd->
»mÙe_lšk_down_»asÚ
);

11006 ià(!
»t
)

11007 
µd
->
»mÙe_lšk_down_»asÚ
 = 0;

11009 
HLS_VERIFY_CAP
:

11010 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_DN_POLL
)

11011 
uÃx³ùed
;

11012 
µd
->
ho¡_lšk_¡©e
 = 
HLS_VERIFY_CAP
;

11013 
	`log_physiÿl_¡©e
(
µd
, 
PLS_CONFIGPHY_VERIFYCAP
);

11015 
HLS_GOING_UP
:

11016 ià(
µd
->
ho¡_lšk_¡©e
 !ð
HLS_VERIFY_CAP
)

11017 
uÃx³ùed
;

11019 
»t1
 = 
	`£t_physiÿl_lšk_¡©e
(
dd
, 
PLS_LINKUP
);

11020 ià(
»t1
 !ð
HCMD_SUCCESS
) {

11021 
	`dd_dev_”r
(
dd
,

11023 
»t1
);

11024 
»t
 = -
EINVAL
;

11027 
µd
->
ho¡_lšk_¡©e
 = 
HLS_GOING_UP
;

11030 
HLS_GOING_OFFLINE
:

11031 
HLS_LINK_COOLDOWN
:

11033 
	`dd_dev_šfo
(
dd
, "%s: state 0x%x:‚ot supported\n",

11034 
__func__
, 
¡©e
);

11035 
»t
 = -
EINVAL
;

11039 
dÚe
;

11041 
uÃx³ùed
:

11042 
	`dd_dev_”r
(
dd
, "%s: unexpected stateransition from %so %s\n",

11043 
__func__
, 
	`lšk_¡©e_Çme
(
µd
->
ho¡_lšk_¡©e
),

11044 
	`lšk_¡©e_Çme
(
¡©e
));

11045 
»t
 = -
EINVAL
;

11047 
dÚe
:

11048 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

11050 ià(
ev’t
.
deviû
)

11051 
	`ib_di¥©ch_ev’t
(&
ev’t
);

11053  
»t
;

11054 
	}
}

11056 
	$hfi1_£t_ib_cfg
(
hfi1_µÜtd©a
 *
µd
, 
which
, 
u32
 
v®
)

11058 
u64
 
»g
;

11059 
»t
 = 0;

11061 
which
) {

11062 
HFI1_IB_CFG_LIDLMC
:

11063 
	`£t_lidlmc
(
µd
);

11065 
HFI1_IB_CFG_VL_HIGH_LIMIT
:

11070 
v®
 *= 4096 / 64;

11071 
»g
 = ((
u64
)
v®
 & 
SEND_HIGH_PRIORITY_LIMIT_LIMIT_MASK
)

11072 << 
SEND_HIGH_PRIORITY_LIMIT_LIMIT_SHIFT
;

11073 
	`wr™e_c¤
(
µd
->
dd
, 
SEND_HIGH_PRIORITY_LIMIT
, 
»g
);

11075 
HFI1_IB_CFG_LINKDEFAULT
:

11077 ià(
v®
 !ð
HLS_DN_POLL
)

11078 
»t
 = -
EINVAL
;

11080 
HFI1_IB_CFG_OP_VLS
:

11081 ià(
µd
->
vls_Ý”©iÚ®
 !ð
v®
) {

11082 
µd
->
vls_Ý”©iÚ®
 = 
v®
;

11083 ià(!
µd
->
pÜt
)

11084 
»t
 = -
EINVAL
;

11095 
HFI1_IB_CFG_LWID_ENB
:

11096 
µd
->
lšk_width_’abËd
 = 
v®
 &…pd->
lšk_width_suµÜ‹d
;

11098 
HFI1_IB_CFG_LWID_DG_ENB
:

11099 
µd
->
lšk_width_downg¿de_’abËd
 =

11100 
v®
 & 
µd
->
lšk_width_downg¿de_suµÜ‹d
;

11102 
HFI1_IB_CFG_SPD_ENB
:

11103 
µd
->
lšk_¥“d_’abËd
 = 
v®
 &…pd->
lšk_¥“d_suµÜ‹d
;

11105 
HFI1_IB_CFG_OVERRUN_THRESH
:

11110 
µd
->
ov”run_th»shÞd
 = 
v®
;

11112 
HFI1_IB_CFG_PHYERR_THRESH
:

11117 
µd
->
phy_”rÜ_th»shÞd
 = 
v®
;

11120 
HFI1_IB_CFG_MTU
:

11121 
	`£t_£nd_Ëngth
(
µd
);

11124 
HFI1_IB_CFG_PKEYS
:

11125 ià(
	`HFI1_CAP_IS_KSET
(
PKEY_CHECK
))

11126 
	`£t_·¹™iÚ_keys
(
µd
);

11130 ià(
	`HFI1_CAP_IS_KSET
(
PRINT_UNIMPL
))

11131 
	`dd_dev_šfo
(
µd
->
dd
,

11133 
__func__
, 
	`ib_cfg_Çme
(
which
), 
v®
);

11136  
»t
;

11137 
	}
}

11140 
	$š™_vl_¬b_ÿches
(
hfi1_µÜtd©a
 *
µd
)

11142 
i
;

11144 
	`BUILD_BUG_ON
(
VL_ARB_TABLE_SIZE
 !=

11145 
VL_ARB_LOW_PRIO_TABLE_SIZE
);

11146 
	`BUILD_BUG_ON
(
VL_ARB_TABLE_SIZE
 !=

11147 
VL_ARB_HIGH_PRIO_TABLE_SIZE
);

11159 
i
 = 0; i < 
MAX_PRIO_TABLE
; i++)

11160 
	`¥š_lock_š™
(&
µd
->
vl_¬b_ÿche
[
i
].
lock
);

11161 
	}
}

11169 
šlše
 
vl_¬b_ÿche
 *

11170 
	$vl_¬b_lock_ÿche
(
hfi1_µÜtd©a
 *
µd
, 
idx
)

11172 ià(
idx
 !ð
LO_PRIO_TABLE
 && idx !ð
HI_PRIO_TABLE
)

11173  
NULL
;

11174 
	`¥š_lock
(&
µd
->
vl_¬b_ÿche
[
idx
].
lock
);

11175  &
µd
->
vl_¬b_ÿche
[
idx
];

11176 
	}
}

11178 
šlše
 
	$vl_¬b_uÆock_ÿche
(
hfi1_µÜtd©a
 *
µd
, 
idx
)

11180 
	`¥š_uÆock
(&
µd
->
vl_¬b_ÿche
[
idx
].
lock
);

11181 
	}
}

11183 
	$vl_¬b_g‘_ÿche
(
vl_¬b_ÿche
 *
ÿche
,

11184 
ib_vl_weight_–em
 *
vl
)

11186 
	`memýy
(
vl
, 
ÿche
->
bË
, 
VL_ARB_TABLE_SIZE
 * (*vl));

11187 
	}
}

11189 
	$vl_¬b_£t_ÿche
(
vl_¬b_ÿche
 *
ÿche
,

11190 
ib_vl_weight_–em
 *
vl
)

11192 
	`memýy
(
ÿche
->
bË
, 
vl
, 
VL_ARB_TABLE_SIZE
 * (*vl));

11193 
	}
}

11195 
	$vl_¬b_m©ch_ÿche
(
vl_¬b_ÿche
 *
ÿche
,

11196 
ib_vl_weight_–em
 *
vl
)

11198  !
	`memcmp
(
ÿche
->
bË
, 
vl
, 
VL_ARB_TABLE_SIZE
 * (*vl));

11199 
	}
}

11203 
	$£t_vl_weights
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
,

11204 
u32
 
size
, 
ib_vl_weight_–em
 *
vl
)

11206 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

11207 
u64
 
»g
;

11208 
i
, 
is_up
 = 0;

11209 
d¿š
, 
»t
 = 0;

11211 
	`mu‹x_lock
(&
µd
->
hls_lock
);

11213 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_UP
)

11214 
is_up
 = 1;

11216 
d¿š
 = !
	`is_ax
(
dd
è&& 
is_up
;

11218 ià(
d¿š
)

11225 
»t
 = 
	`¡Ý_d¿š_d©a_vls
(
dd
);

11227 ià(
»t
) {

11228 
	`dd_dev_”r
(

11229 
dd
,

11231 
__func__
);

11232 
”r
;

11235 
i
 = 0; i < 
size
; i++, 
vl
++) {

11240 
»g
 = (((
u64
)
vl
->vÈ& 
SEND_LOW_PRIORITY_LIST_VL_MASK
)

11241 << 
SEND_LOW_PRIORITY_LIST_VL_SHIFT
)

11242 | (((
u64
)
vl
->
weight


11243 & 
SEND_LOW_PRIORITY_LIST_WEIGHT_MASK
)

11244 << 
SEND_LOW_PRIORITY_LIST_WEIGHT_SHIFT
);

11245 
	`wr™e_c¤
(
dd
, 
rg‘
 + (
i
 * 8), 
»g
);

11247 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_GLOBAL_VLARB_ENABLE
);

11249 ià(
d¿š
)

11250 
	`Ý’_fžl_d©a_vls
(
dd
);

11252 
”r
:

11253 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

11255  
»t
;

11256 
	}
}

11261 
	$»ad_Úe_cm_vl
(
hfi1_devd©a
 *
dd
, 
u32
 
c¤
,

11262 
vl_lim™
 *
vÎ
)

11264 
u64
 
»g
 = 
	`»ad_c¤
(
dd
, 
c¤
);

11266 
vÎ
->
dediÿ‹d
 = 
	`ýu_to_be16
(

11267 (
»g
 >> 
SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SHIFT
)

11268 & 
SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_MASK
);

11269 
vÎ
->
sh¬ed
 = 
	`ýu_to_be16
(

11270 (
»g
 >> 
SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_SHIFT
)

11271 & 
SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_MASK
);

11272 
	}
}

11277 
	$g‘_bufãr_cÚŒÞ
(
hfi1_devd©a
 *
dd
,

11278 
bufãr_cÚŒÞ
 *
bc
, 
u16
 *
ov”®l_lim™
)

11280 
u64
 
»g
;

11281 
i
;

11284 
	`mem£t
(
bc
, 0, (*bc));

11287 
i
 = 0; i < 
TXE_NUM_DATA_VL
; i++)

11288 
	`»ad_Úe_cm_vl
(
dd
, 
SEND_CM_CREDIT_VL
 + (8 * 
i
), &
bc
->
vl
[i]);

11291 
	`»ad_Úe_cm_vl
(
dd
, 
SEND_CM_CREDIT_VL15
, &
bc
->
vl
[15]);

11293 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
);

11294 
bc
->
ov”®l_sh¬ed_lim™
 = 
	`ýu_to_be16
(

11295 (
»g
 >> 
SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SHIFT
)

11296 & 
SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_MASK
);

11297 ià(
ov”®l_lim™
)

11298 *
ov”®l_lim™
 = (
»g


11299 >> 
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SHIFT
)

11300 & 
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_MASK
;

11301  (
bufãr_cÚŒÞ
);

11302 
	}
}

11304 
	$g‘_sc2vÊt
(
hfi1_devd©a
 *
dd
, 
sc2vÊt
 *
dp
)

11306 
u64
 
»g
;

11307 
i
;

11310 
»g
 = 
	`»ad_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_15_0
);

11311 
i
 = 0; i < (
u64
); i++) {

11312 
u8
 
by‹
 = *(((u8 *)&
»g
è+ 
i
);

11314 
dp
->
vÊt
[2 * 
i
] = 
by‹
 & 0xf;

11315 
dp
->
vÊt
[(2 * 
i
è+ 1] = (
by‹
 & 0xf0) >> 4;

11318 
»g
 = 
	`»ad_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_31_16
);

11319 
i
 = 0; i < (
u64
); i++) {

11320 
u8
 
by‹
 = *(((u8 *)&
»g
è+ 
i
);

11322 
dp
->
vÊt
[16 + (2 * 
i
)] = 
by‹
 & 0xf;

11323 
dp
->
vÊt
[16 + (2 * 
i
è+ 1] = (
by‹
 & 0xf0) >> 4;

11325  (
sc2vÊt
);

11326 
	}
}

11328 
	$g‘_vÏrb_´“m±
(
hfi1_devd©a
 *
dd
, 
u32
 
ÃËms
,

11329 
ib_vl_weight_–em
 *
vl
)

11331 
i
;

11333 
i
 = 0; i < 
ÃËms
; i++, 
vl
++) {

11334 
vl
->vl = 0xf;

11335 
vl
->
weight
 = 0;

11337 
	}
}

11339 
	$£t_sc2vÊt
(
hfi1_devd©a
 *
dd
, 
sc2vÊt
 *
dp
)

11341 
	`wr™e_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_15_0
,

11342 
	`DC_SC_VL_VAL
(15
_0
,

11343 0, 
dp
->
vÊt
[0] & 0xf,

11344 1, 
dp
->
vÊt
[1] & 0xf,

11345 2, 
dp
->
vÊt
[2] & 0xf,

11346 3, 
dp
->
vÊt
[3] & 0xf,

11347 4, 
dp
->
vÊt
[4] & 0xf,

11348 5, 
dp
->
vÊt
[5] & 0xf,

11349 6, 
dp
->
vÊt
[6] & 0xf,

11350 7, 
dp
->
vÊt
[7] & 0xf,

11351 8, 
dp
->
vÊt
[8] & 0xf,

11352 9, 
dp
->
vÊt
[9] & 0xf,

11353 10, 
dp
->
vÊt
[10] & 0xf,

11354 11, 
dp
->
vÊt
[11] & 0xf,

11355 12, 
dp
->
vÊt
[12] & 0xf,

11356 13, 
dp
->
vÊt
[13] & 0xf,

11357 14, 
dp
->
vÊt
[14] & 0xf,

11358 15, 
dp
->
vÊt
[15] & 0xf));

11359 
	`wr™e_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_31_16
,

11360 
	`DC_SC_VL_VAL
(31
_16
,

11361 16, 
dp
->
vÊt
[16] & 0xf,

11362 17, 
dp
->
vÊt
[17] & 0xf,

11363 18, 
dp
->
vÊt
[18] & 0xf,

11364 19, 
dp
->
vÊt
[19] & 0xf,

11365 20, 
dp
->
vÊt
[20] & 0xf,

11366 21, 
dp
->
vÊt
[21] & 0xf,

11367 22, 
dp
->
vÊt
[22] & 0xf,

11368 23, 
dp
->
vÊt
[23] & 0xf,

11369 24, 
dp
->
vÊt
[24] & 0xf,

11370 25, 
dp
->
vÊt
[25] & 0xf,

11371 26, 
dp
->
vÊt
[26] & 0xf,

11372 27, 
dp
->
vÊt
[27] & 0xf,

11373 28, 
dp
->
vÊt
[28] & 0xf,

11374 29, 
dp
->
vÊt
[29] & 0xf,

11375 30, 
dp
->
vÊt
[30] & 0xf,

11376 31, 
dp
->
vÊt
[31] & 0xf));

11377 
	}
}

11379 
	$nÚz”o_msg
(
hfi1_devd©a
 *
dd
, 
idx
, cÚ¡ *
wh©
,

11380 
u16
 
lim™
)

11382 ià(
lim™
 != 0)

11383 
	`dd_dev_šfo
(
dd
, "Invalid %s†imit %d on VL %d, ignoring\n",

11384 
wh©
, ()
lim™
, 
idx
);

11385 
	}
}

11388 
	$£t_glob®_sh¬ed
(
hfi1_devd©a
 *
dd
, 
u16
 
lim™
)

11390 
u64
 
»g
;

11392 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
);

11393 
»g
 &ð~
SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SMASK
;

11394 
»g
 |ð(
u64
)
lim™
 << 
SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SHIFT
;

11395 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 
»g
);

11396 
	}
}

11399 
	$£t_glob®_lim™
(
hfi1_devd©a
 *
dd
, 
u16
 
lim™
)

11401 
u64
 
»g
;

11403 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
);

11404 
»g
 &ð~
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SMASK
;

11405 
»g
 |ð(
u64
)
lim™
 << 
SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SHIFT
;

11406 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 
»g
);

11407 
	}
}

11410 
	$£t_vl_sh¬ed
(
hfi1_devd©a
 *
dd
, 
vl
, 
u16
 
lim™
)

11412 
u64
 
»g
;

11413 
u32
 
addr
;

11415 ià(
vl
 < 
TXE_NUM_DATA_VL
)

11416 
addr
 = 
SEND_CM_CREDIT_VL
 + (8 * 
vl
);

11418 
addr
 = 
SEND_CM_CREDIT_VL15
;

11420 
»g
 = 
	`»ad_c¤
(
dd
, 
addr
);

11421 
»g
 &ð~
SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_SMASK
;

11422 
»g
 |ð(
u64
)
lim™
 << 
SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_SHIFT
;

11423 
	`wr™e_c¤
(
dd
, 
addr
, 
»g
);

11424 
	}
}

11427 
	$£t_vl_dediÿ‹d
(
hfi1_devd©a
 *
dd
, 
vl
, 
u16
 
lim™
)

11429 
u64
 
»g
;

11430 
u32
 
addr
;

11432 ià(
vl
 < 
TXE_NUM_DATA_VL
)

11433 
addr
 = 
SEND_CM_CREDIT_VL
 + (8 * 
vl
);

11435 
addr
 = 
SEND_CM_CREDIT_VL15
;

11437 
»g
 = 
	`»ad_c¤
(
dd
, 
addr
);

11438 
»g
 &ð~
SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SMASK
;

11439 
»g
 |ð(
u64
)
lim™
 << 
SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SHIFT
;

11440 
	`wr™e_c¤
(
dd
, 
addr
, 
»g
);

11441 
	}
}

11444 
	$wa™_fÜ_vl_¡©us_þ—r
(
hfi1_devd©a
 *
dd
, 
u64
 
mask
,

11445 cÚ¡ *
which
)

11447 
timeout
;

11448 
u64
 
»g
;

11450 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
VL_STATUS_CLEAR_TIMEOUT
);

11452 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CM_CREDIT_USED_STATUS
è& 
mask
;

11454 ià(
»g
 == 0)

11456 ià(
	`time_aá”
(
jiff›s
, 
timeout
))

11458 
	`ud–ay
(1);

11461 
	`dd_dev_”r
(
dd
,

11463 
which
, 
VL_STATUS_CLEAR_TIMEOUT
, 
mask
, 
»g
);

11468 
	`dd_dev_”r
(
dd
,

11470 
	}
}

11496 
	$£t_bufãr_cÚŒÞ
(
hfi1_µÜtd©a
 *
µd
,

11497 
bufãr_cÚŒÞ
 *
Ãw_bc
)

11499 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

11500 
u64
 
chªgšg_mask
, 
ld_mask
, 
¡©_mask
;

11501 
chªge_couÁ
;

11502 
i
, 
u£_®l_mask
;

11503 
this_sh¬ed_chªgšg
;

11504 
vl_couÁ
 = 0, 
»t
;

11509 
ªy_sh¬ed_lim™_chªgšg
;

11510 
bufãr_cÚŒÞ
 
cur_bc
;

11511 
u8
 
chªgšg
[
OPA_MAX_VLS
];

11512 
u8
 
low”šg_dediÿ‹d
[
OPA_MAX_VLS
];

11513 
u16
 
cur_tÙ®
;

11514 
u32
 
Ãw_tÙ®
 = 0;

11515 cÚ¡ 
u64
 
®l_mask
 =

11516 
SEND_CM_CREDIT_USED_STATUS_VL0_RETURN_CREDIT_STATUS_SMASK


11517 | 
SEND_CM_CREDIT_USED_STATUS_VL1_RETURN_CREDIT_STATUS_SMASK


11518 | 
SEND_CM_CREDIT_USED_STATUS_VL2_RETURN_CREDIT_STATUS_SMASK


11519 | 
SEND_CM_CREDIT_USED_STATUS_VL3_RETURN_CREDIT_STATUS_SMASK


11520 | 
SEND_CM_CREDIT_USED_STATUS_VL4_RETURN_CREDIT_STATUS_SMASK


11521 | 
SEND_CM_CREDIT_USED_STATUS_VL5_RETURN_CREDIT_STATUS_SMASK


11522 | 
SEND_CM_CREDIT_USED_STATUS_VL6_RETURN_CREDIT_STATUS_SMASK


11523 | 
SEND_CM_CREDIT_USED_STATUS_VL7_RETURN_CREDIT_STATUS_SMASK


11524 | 
SEND_CM_CREDIT_USED_STATUS_VL15_RETURN_CREDIT_STATUS_SMASK
;

11526 
	#v®id_vl
(
idx
è((idxè< 
TXE_NUM_DATA_VL
 || (idxè=ð15)

	)

11527 
	#NUM_USABLE_VLS
 16

	)

11530 
i
 = 0; i < 
OPA_MAX_VLS
; i++) {

11531 ià(
	`v®id_vl
(
i
)) {

11532 
Ãw_tÙ®
 +ð
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
);

11535 
	`nÚz”o_msg
(
dd
, 
i
, "dedicated",

11536 
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
));

11537 
	`nÚz”o_msg
(
dd
, 
i
, "shared",

11538 
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
sh¬ed
));

11539 
Ãw_bc
->
vl
[
i
].
dediÿ‹d
 = 0;

11540 
Ãw_bc
->
vl
[
i
].
sh¬ed
 = 0;

11542 
Ãw_tÙ®
 +ð
	`be16_to_ýu
(
Ãw_bc
->
ov”®l_sh¬ed_lim™
);

11545 
	`g‘_bufãr_cÚŒÞ
(
dd
, &
cur_bc
, &
cur_tÙ®
);

11550 
	`mem£t
(
chªgšg
, 0, (changing));

11551 
	`mem£t
(
low”šg_dediÿ‹d
, 0, (lowering_dedicated));

11556 
¡©_mask
 =

11557 
SEND_CM_CREDIT_USED_STATUS_VL0_RETURN_CREDIT_STATUS_SMASK
;

11558 
chªgšg_mask
 = 0;

11559 
ld_mask
 = 0;

11560 
chªge_couÁ
 = 0;

11561 
ªy_sh¬ed_lim™_chªgšg
 = 0;

11562 
i
 = 0; i < 
NUM_USABLE_VLS
; i++, 
¡©_mask
 <<= 1) {

11563 ià(!
	`v®id_vl
(
i
))

11565 
this_sh¬ed_chªgšg
 = 
Ãw_bc
->
vl
[
i
].
sh¬ed


11566 !ð
cur_bc
.
vl
[
i
].
sh¬ed
;

11567 ià(
this_sh¬ed_chªgšg
)

11568 
ªy_sh¬ed_lim™_chªgšg
 = 1;

11569 ià(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
 !ð
cur_bc
.vl[i].dedicated ||

11570 
this_sh¬ed_chªgšg
) {

11571 
chªgšg
[
i
] = 1;

11572 
chªgšg_mask
 |ð
¡©_mask
;

11573 
chªge_couÁ
++;

11575 ià(
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
) <

11576 
	`be16_to_ýu
(
cur_bc
.
vl
[
i
].
dediÿ‹d
)) {

11577 
low”šg_dediÿ‹d
[
i
] = 1;

11578 
ld_mask
 |ð
¡©_mask
;

11583 ià(
Ãw_tÙ®
 > 
cur_tÙ®
)

11584 
	`£t_glob®_lim™
(
dd
, 
Ãw_tÙ®
);

11589 
u£_®l_mask
 = 0;

11590 ià((
	`be16_to_ýu
(
Ãw_bc
->
ov”®l_sh¬ed_lim™
) <

11591 
	`be16_to_ýu
(
cur_bc
.
ov”®l_sh¬ed_lim™
)) ||

11592 (
	`is_ax
(
dd
è&& 
ªy_sh¬ed_lim™_chªgšg
)) {

11593 
	`£t_glob®_sh¬ed
(
dd
, 0);

11594 
cur_bc
.
ov”®l_sh¬ed_lim™
 = 0;

11595 
u£_®l_mask
 = 1;

11598 
i
 = 0; i < 
NUM_USABLE_VLS
; i++) {

11599 ià(!
	`v®id_vl
(
i
))

11602 ià(
chªgšg
[
i
]) {

11603 
	`£t_vl_sh¬ed
(
dd
, 
i
, 0);

11604 
cur_bc
.
vl
[
i
].
sh¬ed
 = 0;

11608 
	`wa™_fÜ_vl_¡©us_þ—r
(
dd
, 
u£_®l_mask
 ? 
®l_mask
 : 
chªgšg_mask
,

11611 ià(
chªge_couÁ
 > 0) {

11612 
i
 = 0; i < 
NUM_USABLE_VLS
; i++) {

11613 ià(!
	`v®id_vl
(
i
))

11616 ià(
low”šg_dediÿ‹d
[
i
]) {

11617 
	`£t_vl_dediÿ‹d
(
dd
, 
i
,

11618 
	`be16_to_ýu
(
Ãw_bc
->

11619 
vl
[
i
].
dediÿ‹d
));

11620 
cur_bc
.
vl
[
i
].
dediÿ‹d
 =

11621 
Ãw_bc
->
vl
[
i
].
dediÿ‹d
;

11625 
	`wa™_fÜ_vl_¡©us_þ—r
(
dd
, 
ld_mask
, "dedicated");

11628 
i
 = 0; i < 
NUM_USABLE_VLS
; i++) {

11629 ià(!
	`v®id_vl
(
i
))

11632 ià(
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
) >

11633 
	`be16_to_ýu
(
cur_bc
.
vl
[
i
].
dediÿ‹d
))

11634 
	`£t_vl_dediÿ‹d
(
dd
, 
i
,

11635 
	`be16_to_ýu
(
Ãw_bc
->

11636 
vl
[
i
].
dediÿ‹d
));

11641 
i
 = 0; i < 
NUM_USABLE_VLS
; i++) {

11642 ià(!
	`v®id_vl
(
i
))

11645 ià(
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
sh¬ed
) >

11646 
	`be16_to_ýu
(
cur_bc
.
vl
[
i
].
sh¬ed
))

11647 
	`£t_vl_sh¬ed
(
dd
, 
i
, 
	`be16_to_ýu
(
Ãw_bc
->
vl
[i].
sh¬ed
));

11651 ià(
	`be16_to_ýu
(
Ãw_bc
->
ov”®l_sh¬ed_lim™
) >

11652 
	`be16_to_ýu
(
cur_bc
.
ov”®l_sh¬ed_lim™
))

11653 
	`£t_glob®_sh¬ed
(
dd
,

11654 
	`be16_to_ýu
(
Ãw_bc
->
ov”®l_sh¬ed_lim™
));

11657 ià(
Ãw_tÙ®
 < 
cur_tÙ®
)

11658 
	`£t_glob®_lim™
(
dd
, 
Ãw_tÙ®
);

11664 ià(
chªge_couÁ
 > 0) {

11665 
i
 = 0; i < 
TXE_NUM_DATA_VL
; i++)

11666 ià(
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
dediÿ‹d
) > 0 ||

11667 
	`be16_to_ýu
(
Ãw_bc
->
vl
[
i
].
sh¬ed
) > 0)

11668 
vl_couÁ
++;

11669 
µd
->
aùu®_vls_Ý”©iÚ®
 = 
vl_couÁ
;

11670 
»t
 = 
	`sdma_m­_š™
(
dd
, 
µd
->
pÜt
 - 1, 
vl_couÁ
 ?

11671 
µd
->
aùu®_vls_Ý”©iÚ®
 :

11672 
µd
->
vls_Ý”©iÚ®
,

11673 
NULL
);

11674 ià(
»t
 == 0)

11675 
»t
 = 
	`pio_m­_š™
(
dd
, 
µd
->
pÜt
 - 1, 
vl_couÁ
 ?

11676 
µd
->
aùu®_vls_Ý”©iÚ®
 :

11677 
µd
->
vls_Ý”©iÚ®
, 
NULL
);

11678 ià(
»t
)

11679  
»t
;

11682 
	}
}

11689 
	$fm_g‘_bË
(
hfi1_µÜtd©a
 *
µd
, 
which
, *
t
)

11692 
size
;

11693 
vl_¬b_ÿche
 *
vlc
;

11695 
which
) {

11696 
FM_TBL_VL_HIGH_ARB
:

11697 
size
 = 256;

11702 
vlc
 = 
	`vl_¬b_lock_ÿche
(
µd
, 
HI_PRIO_TABLE
);

11703 
	`vl_¬b_g‘_ÿche
(
vlc
, 
t
);

11704 
	`vl_¬b_uÆock_ÿche
(
µd
, 
HI_PRIO_TABLE
);

11706 
FM_TBL_VL_LOW_ARB
:

11707 
size
 = 256;

11712 
vlc
 = 
	`vl_¬b_lock_ÿche
(
µd
, 
LO_PRIO_TABLE
);

11713 
	`vl_¬b_g‘_ÿche
(
vlc
, 
t
);

11714 
	`vl_¬b_uÆock_ÿche
(
µd
, 
LO_PRIO_TABLE
);

11716 
FM_TBL_BUFFER_CONTROL
:

11717 
size
 = 
	`g‘_bufãr_cÚŒÞ
(
µd
->
dd
, 
t
, 
NULL
);

11719 
FM_TBL_SC2VLNT
:

11720 
size
 = 
	`g‘_sc2vÊt
(
µd
->
dd
, 
t
);

11722 
FM_TBL_VL_PREEMPT_ELEMS
:

11723 
size
 = 256;

11725 
	`g‘_vÏrb_´“m±
(
µd
->
dd
, 
OPA_MAX_VLS
, 
t
);

11727 
FM_TBL_VL_PREEMPT_MATRIX
:

11728 
size
 = 256;

11735  -
EINVAL
;

11737  
size
;

11738 
	}
}

11743 
	$fm_£t_bË
(
hfi1_µÜtd©a
 *
µd
, 
which
, *
t
)

11745 
»t
 = 0;

11746 
vl_¬b_ÿche
 *
vlc
;

11748 
which
) {

11749 
FM_TBL_VL_HIGH_ARB
:

11750 
vlc
 = 
	`vl_¬b_lock_ÿche
(
µd
, 
HI_PRIO_TABLE
);

11751 ià(
	`vl_¬b_m©ch_ÿche
(
vlc
, 
t
)) {

11752 
	`vl_¬b_uÆock_ÿche
(
µd
, 
HI_PRIO_TABLE
);

11755 
	`vl_¬b_£t_ÿche
(
vlc
, 
t
);

11756 
	`vl_¬b_uÆock_ÿche
(
µd
, 
HI_PRIO_TABLE
);

11757 
»t
 = 
	`£t_vl_weights
(
µd
, 
SEND_HIGH_PRIORITY_LIST
,

11758 
VL_ARB_HIGH_PRIO_TABLE_SIZE
, 
t
);

11760 
FM_TBL_VL_LOW_ARB
:

11761 
vlc
 = 
	`vl_¬b_lock_ÿche
(
µd
, 
LO_PRIO_TABLE
);

11762 ià(
	`vl_¬b_m©ch_ÿche
(
vlc
, 
t
)) {

11763 
	`vl_¬b_uÆock_ÿche
(
µd
, 
LO_PRIO_TABLE
);

11766 
	`vl_¬b_£t_ÿche
(
vlc
, 
t
);

11767 
	`vl_¬b_uÆock_ÿche
(
µd
, 
LO_PRIO_TABLE
);

11768 
»t
 = 
	`£t_vl_weights
(
µd
, 
SEND_LOW_PRIORITY_LIST
,

11769 
VL_ARB_LOW_PRIO_TABLE_SIZE
, 
t
);

11771 
FM_TBL_BUFFER_CONTROL
:

11772 
»t
 = 
	`£t_bufãr_cÚŒÞ
(
µd
, 
t
);

11774 
FM_TBL_SC2VLNT
:

11775 
	`£t_sc2vÊt
(
µd
->
dd
, 
t
);

11778 
»t
 = -
EINVAL
;

11780  
»t
;

11781 
	}
}

11788 
	$di§bË_d©a_vls
(
hfi1_devd©a
 *
dd
)

11790 ià(
	`is_ax
(
dd
))

11793 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_DATA_VL_DISABLE
);

11796 
	}
}

11806 
	$Ý’_fžl_d©a_vls
(
hfi1_devd©a
 *
dd
)

11808 ià(
	`is_ax
(
dd
))

11811 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_DATA_VL_ENABLE
);

11814 
	}
}

11821 
	$d¿š_d©a_vls
(
hfi1_devd©a
 *
dd
)

11823 
	`sc_wa™
(
dd
);

11824 
	`sdma_wa™
(
dd
);

11825 
	`·u£_fÜ_üed™_»tuº
(
dd
);

11826 
	}
}

11838 
	$¡Ý_d¿š_d©a_vls
(
hfi1_devd©a
 *
dd
)

11840 
»t
;

11842 
»t
 = 
	`di§bË_d©a_vls
(
dd
);

11843 ià(
»t
 == 0)

11844 
	`d¿š_d©a_vls
(
dd
);

11846  
»t
;

11847 
	}
}

11853 
u32
 
	$ns_to_cþock
(
hfi1_devd©a
 *
dd
, 
u32
 
ns
)

11855 
u32
 
cþocks
;

11857 ià(
dd
->
icode
 =ð
ICODE_FPGA_EMULATION
)

11858 
cþocks
 = (
ns
 * 1000è/ 
FPGA_CCLOCK_PS
;

11860 
cþocks
 = (
ns
 * 1000è/ 
ASIC_CCLOCK_PS
;

11861 ià(
ns
 && !
cþocks
)

11862 
cþocks
 = 1;

11863  
cþocks
;

11864 
	}
}

11870 
u32
 
	$cþock_to_ns
(
hfi1_devd©a
 *
dd
, 
u32
 
cþocks
)

11872 
u32
 
ns
;

11874 ià(
dd
->
icode
 =ð
ICODE_FPGA_EMULATION
)

11875 
ns
 = (
cþocks
 * 
FPGA_CCLOCK_PS
) / 1000;

11877 
ns
 = (
cþocks
 * 
ASIC_CCLOCK_PS
) / 1000;

11878 ià(
cþocks
 && !
ns
)

11879 
ns
 = 1;

11880  
ns
;

11881 
	}
}

11889 
	$adju¡_rcv_timeout
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
Åkts
)

11891 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

11892 
u32
 
timeout
 = 
rcd
->
rcvavaž_timeout
;

11903 ià(
Åkts
 < 
rcv_šŒ_couÁ
) {

11908 ià(
timeout
 < 2)

11910 
timeout
 >>= 1;

11916 ià(
timeout
 >ð
dd
->
rcv_šŒ_timeout_c¤
)

11918 
timeout
 = 
	`mš
Ñimeouˆ<< 1, 
dd
->
rcv_šŒ_timeout_c¤
);

11921 
rcd
->
rcvavaž_timeout
 = 
timeout
;

11926 
	`wr™e_kùxt_c¤
(
dd
, 
rcd
->
ùxt
, 
RCV_AVAIL_TIME_OUT
,

11927 (
u64
)
timeout
 <<

11928 
RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_SHIFT
);

11929 
	}
}

11931 
	$upd©e_u¤h—d
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
hd
, u32 
updegr
, u32 
egrhd
,

11932 
u32
 
šŒ_adju¡
, u32 
Åkts
)

11934 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

11935 
u64
 
»g
;

11936 
u32
 
ùxt
 = 
rcd
->ctxt;

11942 ià(
šŒ_adju¡
)

11943 
	`adju¡_rcv_timeout
(
rcd
, 
Åkts
);

11944 ià(
updegr
) {

11945 
»g
 = (
egrhd
 & 
RCV_EGR_INDEX_HEAD_HEAD_MASK
)

11946 << 
RCV_EGR_INDEX_HEAD_HEAD_SHIFT
;

11947 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_EGR_INDEX_HEAD
, 
»g
);

11949 
»g
 = ((
u64
)
rcv_šŒ_couÁ
 << 
RCV_HDR_HEAD_COUNTER_SHIFT
) |

11950 (((
u64
)
hd
 & 
RCV_HDR_HEAD_HEAD_MASK
)

11951 << 
RCV_HDR_HEAD_HEAD_SHIFT
);

11952 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
, 
»g
);

11953 
	}
}

11955 
u32
 
	$hdrqem±y
(
hfi1_ùxtd©a
 *
rcd
)

11957 
u32
 
h—d
, 
ž
;

11959 
h—d
 = (
	`»ad_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_HDR_HEAD
)

11960 & 
RCV_HDR_HEAD_HEAD_SMASK
è>> 
RCV_HDR_HEAD_HEAD_SHIFT
;

11962 ià(
rcd
->
rcvhd¹až_kvaddr
)

11963 
ž
 = 
	`g‘_rcvhd¹až
(
rcd
);

11965 
ž
 = 
	`»ad_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_HDR_TAIL
);

11967  
h—d
 =ð
ž
;

11968 
	}
}

11989 
u32
 
	$’coded_size
(
u32
 
size
)

11991 
size
) {

12004 
	}
}

12014 
u8
 
	$’code_rcv_h—d”_’Œy_size
(
u8
 
size
)

12017 ià(
size
 == 2)

12019 ià(
size
 == 16)

12021 ià(
size
 == 32)

12024 
	}
}

12031 
	$hfi1_v®id©e_rcvhdrút
(
hfi1_devd©a
 *
dd
, 
ušt
 
theút
)

12033 ià(
theút
 <ð
HFI1_MIN_HDRQ_EGRBUF_CNT
) {

12034 
	`dd_dev_”r
(
dd
, "Receive header queue countoo small\n");

12035  -
EINVAL
;

12038 ià(
theút
 > 
HFI1_MAX_HDRQ_EGRBUF_CNT
) {

12039 
	`dd_dev_”r
(
dd
,

12041 
HFI1_MAX_HDRQ_EGRBUF_CNT
);

12042  -
EINVAL
;

12045 ià(
theút
 % 
HDRQ_INCREMENT
) {

12046 
	`dd_dev_”r
(
dd
, "Receive header queue count %d must be divisible by %lu\n",

12047 
theút
, 
HDRQ_INCREMENT
);

12048  -
EINVAL
;

12052 
	}
}

12061 
	$£t_hdrq_»gs
(
hfi1_devd©a
 *
dd
, 
u8
 
ùxt
, u8 
’tsize
, 
u16
 
hdrút
)

12063 
u64
 
»g
;

12065 
»g
 = (((
u64
)
hdrút
 >> 
HDRQ_SIZE_SHIFT
è& 
RCV_HDR_CNT_CNT_MASK
)

12066 << 
RCV_HDR_CNT_CNT_SHIFT
;

12067 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_CNT
, 
»g
);

12068 
»g
 = ((
u64
)
	`’code_rcv_h—d”_’Œy_size
(
’tsize
)

12069 & 
RCV_HDR_ENT_SIZE_ENT_SIZE_MASK
)

12070 << 
RCV_HDR_ENT_SIZE_ENT_SIZE_SHIFT
;

12071 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_ENT_SIZE
, 
»g
);

12072 
»g
 = ((
u64
)
DEFAULT_RCVHDRSIZE
 & 
RCV_HDR_SIZE_HDR_SIZE_MASK
)

12073 << 
RCV_HDR_SIZE_HDR_SIZE_SHIFT
;

12074 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_SIZE
, 
»g
);

12080 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_TAIL_ADDR
,

12081 
dd
->
rcvhd¹až_dummy_dma
);

12082 
	}
}

12084 
	$hfi1_rcvù¾
(
hfi1_devd©a
 *
dd
, 
Ý
,

12085 
hfi1_ùxtd©a
 *
rcd
)

12087 
u64
 
rcvù¾
, 
»g
;

12088 
did_’abË
 = 0;

12089 
u16
 
ùxt
;

12091 ià(!
rcd
)

12094 
ùxt
 = 
rcd
->ctxt;

12096 
	`hfi1_cdbg
(
RCVCTRL
, "ùxˆ%d o°0x%x", 
ùxt
, 
Ý
);

12098 
rcvù¾
 = 
	`»ad_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_CTXT_CTRL
);

12100 ià((
Ý
 & 
HFI1_RCVCTRL_CTXT_ENB
) &&

12101 !(
rcvù¾
 & 
RCV_CTXT_CTRL_ENABLE_SMASK
)) {

12103 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_ADDR
,

12104 
rcd
->
rcvhdrq_dma
);

12105 ià(
rcd
->
rcvhd¹až_kvaddr
)

12106 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_TAIL_ADDR
,

12107 
rcd
->
rcvhdrqžaddr_dma
);

12108 
	`hfi1_£t_£q_út
(
rcd
, 1);

12111 
	`hfi1_£t_rcd_h—d
(
rcd
, 0);

12119 
	`mem£t
(
rcd
->
rcvhdrq
, 0, 
	`rcvhdrq_size
(rcd));

12122 
rcd
->
rcvavaž_timeout
 = 
dd
->
rcv_šŒ_timeout_c¤
;

12125 
rcvù¾
 |ð
RCV_CTXT_CTRL_ENABLE_SMASK
;

12128 
rcvù¾
 &ð~
RCV_CTXT_CTRL_EGR_BUF_SIZE_SMASK
;

12129 
rcvù¾
 |ð((
u64
)
	`’coded_size
(
rcd
->
egrbufs
.
rcvtid_size
)

12130 & 
RCV_CTXT_CTRL_EGR_BUF_SIZE_MASK
)

12131 << 
RCV_CTXT_CTRL_EGR_BUF_SIZE_SHIFT
;

12134 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
, 0);

12135 
did_’abË
 = 1;

12138 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_EGR_INDEX_HEAD
, 0);

12141 
»g
 = (((
u64
)(
rcd
->
egrbufs
.
®loûd
 >> 
RCV_SHIFT
)

12142 & 
RCV_EGR_CTRL_EGR_CNT_MASK
)

12143 << 
RCV_EGR_CTRL_EGR_CNT_SHIFT
) |

12144 (((
rcd
->
—g”_ba£
 >> 
RCV_SHIFT
)

12145 & 
RCV_EGR_CTRL_EGR_BASE_INDEX_MASK
)

12146 << 
RCV_EGR_CTRL_EGR_BASE_INDEX_SHIFT
);

12147 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_EGR_CTRL
, 
»g
);

12155 
»g
 = (((
rcd
->
ex³ùed_couÁ
 >> 
RCV_SHIFT
)

12156 & 
RCV_TID_CTRL_TID_PAIR_CNT_MASK
)

12157 << 
RCV_TID_CTRL_TID_PAIR_CNT_SHIFT
) |

12158 (((
rcd
->
ex³ùed_ba£
 >> 
RCV_SHIFT
)

12159 & 
RCV_TID_CTRL_TID_BASE_INDEX_MASK
)

12160 << 
RCV_TID_CTRL_TID_BASE_INDEX_SHIFT
);

12161 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_TID_CTRL
, 
»g
);

12162 ià(
ùxt
 =ð
HFI1_CTRL_CTXT
)

12163 
	`wr™e_c¤
(
dd
, 
RCV_VL15
, 
HFI1_CTRL_CTXT
);

12165 ià(
Ý
 & 
HFI1_RCVCTRL_CTXT_DIS
) {

12166 
	`wr™e_c¤
(
dd
, 
RCV_VL15
, 0);

12172 ià(
dd
->
rcvhd¹až_dummy_dma
) {

12173 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_TAIL_ADDR
,

12174 
dd
->
rcvhd¹až_dummy_dma
);

12176 
rcvù¾
 |ð
RCV_CTXT_CTRL_TAIL_UPD_SMASK
;

12179 
rcvù¾
 &ð~
RCV_CTXT_CTRL_ENABLE_SMASK
;

12181 ià(
Ý
 & 
HFI1_RCVCTRL_INTRAVAIL_ENB
) {

12182 
	`£t_šŒ_b™s
(
dd
, 
IS_RCVAVAIL_START
 + 
rcd
->
ùxt
,

12183 
IS_RCVAVAIL_START
 + 
rcd
->
ùxt
, 
Œue
);

12184 
rcvù¾
 |ð
RCV_CTXT_CTRL_INTR_AVAIL_SMASK
;

12186 ià(
Ý
 & 
HFI1_RCVCTRL_INTRAVAIL_DIS
) {

12187 
	`£t_šŒ_b™s
(
dd
, 
IS_RCVAVAIL_START
 + 
rcd
->
ùxt
,

12188 
IS_RCVAVAIL_START
 + 
rcd
->
ùxt
, 
çl£
);

12189 
rcvù¾
 &ð~
RCV_CTXT_CTRL_INTR_AVAIL_SMASK
;

12191 ià((
Ý
 & 
HFI1_RCVCTRL_TAILUPD_ENB
è&& 
rcd
->
rcvhd¹až_kvaddr
)

12192 
rcvù¾
 |ð
RCV_CTXT_CTRL_TAIL_UPD_SMASK
;

12193 ià(
Ý
 & 
HFI1_RCVCTRL_TAILUPD_DIS
) {

12195 ià(!(
Ý
 & 
HFI1_RCVCTRL_CTXT_DIS
))

12196 
rcvù¾
 &ð~
RCV_CTXT_CTRL_TAIL_UPD_SMASK
;

12198 ià(
Ý
 & 
HFI1_RCVCTRL_TIDFLOW_ENB
)

12199 
rcvù¾
 |ð
RCV_CTXT_CTRL_TID_FLOW_ENABLE_SMASK
;

12200 ià(
Ý
 & 
HFI1_RCVCTRL_TIDFLOW_DIS
)

12201 
rcvù¾
 &ð~
RCV_CTXT_CTRL_TID_FLOW_ENABLE_SMASK
;

12202 ià(
Ý
 & 
HFI1_RCVCTRL_ONE_PKT_EGR_ENB
) {

12207 
rcvù¾
 &ð~
RCV_CTXT_CTRL_EGR_BUF_SIZE_SMASK
;

12208 
rcvù¾
 |ð
RCV_CTXT_CTRL_ONE_PACKET_PER_EGR_BUFFER_SMASK
;

12210 ià(
Ý
 & 
HFI1_RCVCTRL_ONE_PKT_EGR_DIS
)

12211 
rcvù¾
 &ð~
RCV_CTXT_CTRL_ONE_PACKET_PER_EGR_BUFFER_SMASK
;

12212 ià(
Ý
 & 
HFI1_RCVCTRL_NO_RHQ_DROP_ENB
)

12213 
rcvù¾
 |ð
RCV_CTXT_CTRL_DONT_DROP_RHQ_FULL_SMASK
;

12214 ià(
Ý
 & 
HFI1_RCVCTRL_NO_RHQ_DROP_DIS
)

12215 
rcvù¾
 &ð~
RCV_CTXT_CTRL_DONT_DROP_RHQ_FULL_SMASK
;

12216 ià(
Ý
 & 
HFI1_RCVCTRL_NO_EGR_DROP_ENB
)

12217 
rcvù¾
 |ð
RCV_CTXT_CTRL_DONT_DROP_EGR_FULL_SMASK
;

12218 ià(
Ý
 & 
HFI1_RCVCTRL_NO_EGR_DROP_DIS
)

12219 
rcvù¾
 &ð~
RCV_CTXT_CTRL_DONT_DROP_EGR_FULL_SMASK
;

12220 ià(
Ý
 & 
HFI1_RCVCTRL_URGENT_ENB
)

12221 
	`£t_šŒ_b™s
(
dd
, 
IS_RCVURGENT_START
 + 
rcd
->
ùxt
,

12222 
IS_RCVURGENT_START
 + 
rcd
->
ùxt
, 
Œue
);

12223 ià(
Ý
 & 
HFI1_RCVCTRL_URGENT_DIS
)

12224 
	`£t_šŒ_b™s
(
dd
, 
IS_RCVURGENT_START
 + 
rcd
->
ùxt
,

12225 
IS_RCVURGENT_START
 + 
rcd
->
ùxt
, 
çl£
);

12227 
	`hfi1_cdbg
(
RCVCTRL
, "ùxˆ%d„cvù¾ 0x%Îx\n", 
ùxt
, 
rcvù¾
);

12228 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_CTXT_CTRL
, 
rcvù¾
);

12231 ià(
did_’abË
 &&

12232 (
rcvù¾
 & 
RCV_CTXT_CTRL_DONT_DROP_RHQ_FULL_SMASK
)) {

12233 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_CTXT_STATUS
);

12234 ià(
»g
 != 0) {

12235 
	`dd_dev_šfo
(
dd
, "ctxt %d status %lld (blocked)\n",

12236 
ùxt
, 
»g
);

12237 
	`»ad_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
);

12238 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
, 0x10);

12239 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
, 0x00);

12240 
	`»ad_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
);

12241 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_CTXT_STATUS
);

12242 
	`dd_dev_šfo
(
dd
, "ctxt %d status %lld (%s blocked)\n",

12243 
ùxt
, 
»g
,„eg == 0 ? "not" : "still");

12247 ià(
did_’abË
) {

12253 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_AVAIL_TIME_OUT
,

12254 (
u64
)
rcd
->
rcvavaž_timeout
 <<

12255 
RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_SHIFT
);

12258 
»g
 = (
u64
)
rcv_šŒ_couÁ
 << 
RCV_HDR_HEAD_COUNTER_SHIFT
;

12259 
	`wr™e_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_HEAD
, 
»g
);

12262 ià(
Ý
 & (
HFI1_RCVCTRL_TAILUPD_DIS
 | 
HFI1_RCVCTRL_CTXT_DIS
))

12268 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
RCV_HDR_TAIL_ADDR
,

12269 
dd
->
rcvhd¹až_dummy_dma
);

12270 
	}
}

12272 
u32
 
	$hfi1_»ad_úŒs
(
hfi1_devd©a
 *
dd
, **
Çm•
, 
u64
 **
úŒp
)

12274 
»t
;

12275 
u64
 
v®
 = 0;

12277 ià(
Çm•
) {

12278 
»t
 = 
dd
->
úŒÇme¦’
;

12279 *
Çm•
 = 
dd
->
úŒÇmes
;

12281 cÚ¡ 
úŒ_’Œy
 *
’Œy
;

12282 
i
, 
j
;

12284 
»t
 = (
dd
->
ndevúŒs
è* (
u64
);

12287 *
úŒp
 = 
dd
->
úŒs
;

12292 
i
 = 0; i < 
DEV_CNTR_LAST
; i++) {

12293 
’Œy
 = &
dev_úŒs
[
i
];

12294 
	`hfi1_cdbg
(
CNTR
, "»adšg %s", 
’Œy
->
Çme
);

12295 ià(
’Œy
->
æags
 & 
CNTR_DISABLED
) {

12297 
	`hfi1_cdbg
(
CNTR
, "\tDisabled\n");

12299 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

12300 
	`hfi1_cdbg
(
CNTR
, "\tPer VL\n");

12301 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12302 
v®
 = 
’Œy
->
	`rw_úŒ
(entry,

12303 
dd
, 
j
,

12304 
CNTR_MODE_R
,

12306 
	`hfi1_cdbg
(

12307 
CNTR
,

12309 
v®
, 
j
);

12310 
dd
->
úŒs
[
’Œy
->
off£t
 + 
j
] =

12311 
v®
;

12313 } ià(
’Œy
->
æags
 & 
CNTR_SDMA
) {

12314 
	`hfi1_cdbg
(
CNTR
,

12316 
j
 = 0; j < 
	`ch_sdma_’gšes
(
dd
);

12317 
j
++) {

12318 
v®
 =

12319 
’Œy
->
	`rw_úŒ
ÓÁry, 
dd
, 
j
,

12320 
CNTR_MODE_R
, 0);

12321 
	`hfi1_cdbg
(
CNTR
,

12323 
v®
, 
j
);

12324 
dd
->
úŒs
[
’Œy
->
off£t
 + 
j
] =

12325 
v®
;

12328 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
dd
,

12329 
CNTR_INVALID_VL
,

12330 
CNTR_MODE_R
, 0);

12331 
dd
->
úŒs
[
’Œy
->
off£t
] = 
v®
;

12332 
	`hfi1_cdbg
(
CNTR
, "\tR—d 0x%Îx", 
v®
);

12337  
»t
;

12338 
	}
}

12343 
u32
 
	$hfi1_»ad_pÜtúŒs
(
hfi1_µÜtd©a
 *
µd
, **
Çm•
, 
u64
 **
úŒp
)

12345 
»t
;

12346 
u64
 
v®
 = 0;

12348 ià(
Çm•
) {

12349 
»t
 = 
µd
->
dd
->
pÜtúŒÇme¦’
;

12350 *
Çm•
 = 
µd
->
dd
->
pÜtúŒÇmes
;

12352 cÚ¡ 
úŒ_’Œy
 *
’Œy
;

12353 
i
, 
j
;

12355 
»t
 = 
µd
->
dd
->
ÅÜtúŒs
 * (
u64
);

12356 *
úŒp
 = 
µd
->
úŒs
;

12358 
i
 = 0; i < 
PORT_CNTR_LAST
; i++) {

12359 
’Œy
 = &
pÜt_úŒs
[
i
];

12360 
	`hfi1_cdbg
(
CNTR
, "»adšg %s", 
’Œy
->
Çme
);

12361 ià(
’Œy
->
æags
 & 
CNTR_DISABLED
) {

12363 
	`hfi1_cdbg
(
CNTR
, "\tDisabled\n");

12367 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

12368 
	`hfi1_cdbg
(
CNTR
, "\tPer VL");

12369 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12370 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
µd
, 
j
,

12371 
CNTR_MODE_R
,

12373 
	`hfi1_cdbg
(

12374 
CNTR
,

12376 
v®
, 
j
);

12377 
µd
->
úŒs
[
’Œy
->
off£t
 + 
j
] = 
v®
;

12380 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
µd
,

12381 
CNTR_INVALID_VL
,

12382 
CNTR_MODE_R
,

12384 
µd
->
úŒs
[
’Œy
->
off£t
] = 
v®
;

12385 
	`hfi1_cdbg
(
CNTR
, "\tR—d 0x%Îx", 
v®
);

12389  
»t
;

12390 
	}
}

12392 
	$ä“_úŒs
(
hfi1_devd©a
 *
dd
)

12394 
hfi1_µÜtd©a
 *
µd
;

12395 
i
;

12397 ià(
dd
->
syÁh_¡©s_tim”
.
funùiÚ
)

12398 
	`d–_tim”_sync
(&
dd
->
syÁh_¡©s_tim”
);

12399 
µd
 = (
hfi1_µÜtd©a
 *)(
dd
 + 1);

12400 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

12401 
	`kä“
(
µd
->
úŒs
);

12402 
	`kä“
(
µd
->
súŒs
);

12403 
	`ä“_³rýu
(
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
);

12404 
	`ä“_³rýu
(
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
);

12405 
	`ä“_³rýu
(
µd
->
ibpÜt_d©a
.
rvp
.
rc_d–ayed_comp
);

12406 
µd
->
úŒs
 = 
NULL
;

12407 
µd
->
súŒs
 = 
NULL
;

12408 
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
 = 
NULL
;

12409 
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
 = 
NULL
;

12410 
µd
->
ibpÜt_d©a
.
rvp
.
rc_d–ayed_comp
 = 
NULL
;

12412 
	`kä“
(
dd
->
pÜtúŒÇmes
);

12413 
dd
->
pÜtúŒÇmes
 = 
NULL
;

12414 
	`kä“
(
dd
->
úŒs
);

12415 
dd
->
úŒs
 = 
NULL
;

12416 
	`kä“
(
dd
->
súŒs
);

12417 
dd
->
súŒs
 = 
NULL
;

12418 
	`kä“
(
dd
->
úŒÇmes
);

12419 
dd
->
úŒÇmes
 = 
NULL
;

12420 ià(
dd
->
upd©e_úŒ_wq
) {

12421 
	`de¡roy_wÜkqueue
(
dd
->
upd©e_úŒ_wq
);

12422 
dd
->
upd©e_úŒ_wq
 = 
NULL
;

12424 
	}
}

12426 
u64
 
	$»ad_dev_pÜt_úŒ
(
hfi1_devd©a
 *
dd
, 
úŒ_’Œy
 *
’Œy
,

12427 
u64
 *
psv®
, *
cÚ‹xt
, 
vl
)

12429 
u64
 
v®
;

12430 
u64
 
sv®
 = *
psv®
;

12432 ià(
’Œy
->
æags
 & 
CNTR_DISABLED
) {

12433 
	`dd_dev_”r
(
dd
, "CouÁ” % nÙƒÇbËd", 
’Œy
->
Çme
);

12437 
	`hfi1_cdbg
(
CNTR
, "úŒ: % vÈ%d…sv® 0x%Îx", 
’Œy
->
Çme
, 
vl
, *
psv®
);

12439 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
cÚ‹xt
, 
vl
, 
CNTR_MODE_R
, 0);

12442 ià(
’Œy
->
æags
 & 
CNTR_SYNTH
) {

12443 ià(
sv®
 =ð
CNTR_MAX
) {

12445  
CNTR_MAX
;

12448 ià(
’Œy
->
æags
 & 
CNTR_32BIT
) {

12450 
u64
 
uµ”
 = 
sv®
 >> 32;

12451 
u64
 
low”
 = (
sv®
 << 32) >> 32;

12453 ià(
low”
 > 
v®
) {

12454 ià(
uµ”
 =ð
CNTR_32BIT_MAX
)

12455 
v®
 = 
CNTR_MAX
;

12457 
uµ”
++;

12460 ià(
v®
 !ð
CNTR_MAX
)

12461 
v®
 = (
uµ”
 << 32) | val;

12465 ià((
v®
 < 
sv®
è|| (v® > 
CNTR_MAX
))

12466 
v®
 = 
CNTR_MAX
;

12470 *
psv®
 = 
v®
;

12472 
	`hfi1_cdbg
(
CNTR
, "\tNew v®=0x%Îx", 
v®
);

12474  
v®
;

12475 
	}
}

12477 
u64
 
	$wr™e_dev_pÜt_úŒ
(
hfi1_devd©a
 *
dd
,

12478 
úŒ_’Œy
 *
’Œy
,

12479 
u64
 *
psv®
, *
cÚ‹xt
, 
vl
, u64 
d©a
)

12481 
u64
 
v®
;

12483 ià(
’Œy
->
æags
 & 
CNTR_DISABLED
) {

12484 
	`dd_dev_”r
(
dd
, "CouÁ” % nÙƒÇbËd", 
’Œy
->
Çme
);

12488 
	`hfi1_cdbg
(
CNTR
, "úŒ: % vÈ%d…sv® 0x%Îx", 
’Œy
->
Çme
, 
vl
, *
psv®
);

12490 ià(
’Œy
->
æags
 & 
CNTR_SYNTH
) {

12491 *
psv®
 = 
d©a
;

12492 ià(
’Œy
->
æags
 & 
CNTR_32BIT
) {

12493 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
cÚ‹xt
, 
vl
, 
CNTR_MODE_W
,

12494 (
d©a
 << 32) >> 32);

12495 
v®
 = 
d©a
;

12497 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
cÚ‹xt
, 
vl
, 
CNTR_MODE_W
,

12498 
d©a
);

12501 
v®
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
cÚ‹xt
, 
vl
, 
CNTR_MODE_W
, 
d©a
);

12504 *
psv®
 = 
v®
;

12506 
	`hfi1_cdbg
(
CNTR
, "\tNew v®=0x%Îx", 
v®
);

12508  
v®
;

12509 
	}
}

12511 
u64
 
	$»ad_dev_úŒ
(
hfi1_devd©a
 *
dd
, 
šdex
, 
vl
)

12513 
úŒ_’Œy
 *
’Œy
;

12514 
u64
 *
sv®
;

12516 
’Œy
 = &
dev_úŒs
[
šdex
];

12517 
sv®
 = 
dd
->
súŒs
 + 
’Œy
->
off£t
;

12519 ià(
vl
 !ð
CNTR_INVALID_VL
)

12520 
sv®
 +ð
vl
;

12522  
	`»ad_dev_pÜt_úŒ
(
dd
, 
’Œy
, 
sv®
, dd, 
vl
);

12523 
	}
}

12525 
u64
 
	$wr™e_dev_úŒ
(
hfi1_devd©a
 *
dd
, 
šdex
, 
vl
, 
u64
 
d©a
)

12527 
úŒ_’Œy
 *
’Œy
;

12528 
u64
 *
sv®
;

12530 
’Œy
 = &
dev_úŒs
[
šdex
];

12531 
sv®
 = 
dd
->
súŒs
 + 
’Œy
->
off£t
;

12533 ià(
vl
 !ð
CNTR_INVALID_VL
)

12534 
sv®
 +ð
vl
;

12536  
	`wr™e_dev_pÜt_úŒ
(
dd
, 
’Œy
, 
sv®
, dd, 
vl
, 
d©a
);

12537 
	}
}

12539 
u64
 
	$»ad_pÜt_úŒ
(
hfi1_µÜtd©a
 *
µd
, 
šdex
, 
vl
)

12541 
úŒ_’Œy
 *
’Œy
;

12542 
u64
 *
sv®
;

12544 
’Œy
 = &
pÜt_úŒs
[
šdex
];

12545 
sv®
 = 
µd
->
súŒs
 + 
’Œy
->
off£t
;

12547 ià(
vl
 !ð
CNTR_INVALID_VL
)

12548 
sv®
 +ð
vl
;

12550 ià((
šdex
 >ð
C_RCV_HDR_OVF_FIRST
 + 
µd
->
dd
->
num_rcv_cÚ‹xts
) &&

12551 (
šdex
 <ð
C_RCV_HDR_OVF_LAST
)) {

12556  
	`»ad_dev_pÜt_úŒ
(
µd
->
dd
, 
’Œy
, 
sv®
,…pd, 
vl
);

12557 
	}
}

12559 
u64
 
	$wr™e_pÜt_úŒ
(
hfi1_µÜtd©a
 *
µd
, 
šdex
, 
vl
, 
u64
 
d©a
)

12561 
úŒ_’Œy
 *
’Œy
;

12562 
u64
 *
sv®
;

12564 
’Œy
 = &
pÜt_úŒs
[
šdex
];

12565 
sv®
 = 
µd
->
súŒs
 + 
’Œy
->
off£t
;

12567 ià(
vl
 !ð
CNTR_INVALID_VL
)

12568 
sv®
 +ð
vl
;

12570 ià((
šdex
 >ð
C_RCV_HDR_OVF_FIRST
 + 
µd
->
dd
->
num_rcv_cÚ‹xts
) &&

12571 (
šdex
 <ð
C_RCV_HDR_OVF_LAST
)) {

12576  
	`wr™e_dev_pÜt_úŒ
(
µd
->
dd
, 
’Œy
, 
sv®
,…pd, 
vl
, 
d©a
);

12577 
	}
}

12579 
	$do_upd©e_syÁh_tim”
(
wÜk_¡ruù
 *
wÜk
)

12581 
u64
 
cur_tx
;

12582 
u64
 
cur_rx
;

12583 
u64
 
tÙ®_æ™s
;

12584 
u8
 
upd©e
 = 0;

12585 
i
, 
j
, 
vl
;

12586 
hfi1_µÜtd©a
 *
µd
;

12587 
úŒ_’Œy
 *
’Œy
;

12588 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
wÜk
, hfi1_devdata,

12589 
upd©e_úŒ_wÜk
);

12597 
’Œy
 = &
dev_úŒs
[
C_DC_RCV_FLITS
];

12598 
cur_rx
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
dd
, 
CNTR_INVALID_VL
, 
CNTR_MODE_R
, 0);

12600 
’Œy
 = &
dev_úŒs
[
C_DC_XMIT_FLITS
];

12601 
cur_tx
 = 
’Œy
->
	`rw_úŒ
ÓÁry, 
dd
, 
CNTR_INVALID_VL
, 
CNTR_MODE_R
, 0);

12603 
	`hfi1_cdbg
(

12604 
CNTR
,

12606 
dd
->
un™
, 
cur_tx
, 
cur_rx
, dd->
Ï¡_tx
, dd->
Ï¡_rx
);

12608 ià((
cur_tx
 < 
dd
->
Ï¡_tx
è|| (
cur_rx
 < dd->
Ï¡_rx
)) {

12613 
upd©e
 = 1;

12614 
	`hfi1_cdbg
(
CNTR
, "[%d] Tripwire counter„olled, updating",

12615 
dd
->
un™
);

12617 
tÙ®_æ™s
 = (
cur_tx
 - 
dd
->
Ï¡_tx
è+ (
cur_rx
 - dd->
Ï¡_rx
);

12618 
	`hfi1_cdbg
(
CNTR
,

12619 "[%d]Ù® fl™ 0x%Îx†im™ 0x%Îx\n", 
dd
->
un™
,

12620 
tÙ®_æ™s
, (
u64
)
CNTR_32BIT_MAX
);

12621 ià(
tÙ®_æ™s
 >ð
CNTR_32BIT_MAX
) {

12622 
	`hfi1_cdbg
(
CNTR
, "[%d] 32bit†imit hit, updating",

12623 
dd
->
un™
);

12624 
upd©e
 = 1;

12628 ià(
upd©e
) {

12629 
	`hfi1_cdbg
(
CNTR
, "[%d] Upd©šg dd‡nd…pd couÁ”s", 
dd
->
un™
);

12630 
i
 = 0; i < 
DEV_CNTR_LAST
; i++) {

12631 
’Œy
 = &
dev_úŒs
[
i
];

12632 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

12633 
vl
 = 0; vÈ< 
C_VL_COUNT
; vl++)

12634 
	`»ad_dev_úŒ
(
dd
, 
i
, 
vl
);

12636 
	`»ad_dev_úŒ
(
dd
, 
i
, 
CNTR_INVALID_VL
);

12639 
µd
 = (
hfi1_µÜtd©a
 *)(
dd
 + 1);

12640 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

12641 
j
 = 0; j < 
PORT_CNTR_LAST
; j++) {

12642 
’Œy
 = &
pÜt_úŒs
[
j
];

12643 ià(
’Œy
->
æags
 & 
CNTR_VL
) {

12644 
vl
 = 0; vÈ< 
C_VL_COUNT
; vl++)

12645 
	`»ad_pÜt_úŒ
(
µd
, 
j
, 
vl
);

12647 
	`»ad_pÜt_úŒ
(
µd
, 
j
, 
CNTR_INVALID_VL
);

12658 
’Œy
 = &
dev_úŒs
[
C_DC_XMIT_FLITS
];

12659 
dd
->
Ï¡_tx
 = 
’Œy
->
	`rw_úŒ
ÓÁry, dd, 
CNTR_INVALID_VL
,

12660 
CNTR_MODE_R
, 0);

12662 
’Œy
 = &
dev_úŒs
[
C_DC_RCV_FLITS
];

12663 
dd
->
Ï¡_rx
 = 
’Œy
->
	`rw_úŒ
ÓÁry, dd, 
CNTR_INVALID_VL
,

12664 
CNTR_MODE_R
, 0);

12666 
	`hfi1_cdbg
(
CNTR
, "[%d] setting†astx/rxo 0x%llx 0x%llx",

12667 
dd
->
un™
, dd->
Ï¡_tx
, dd->
Ï¡_rx
);

12670 
	`hfi1_cdbg
(
CNTR
, "[%d] NØupd©Ãûs§ry", 
dd
->
un™
);

12672 
	}
}

12674 
	$upd©e_syÁh_tim”
(
tim”_li¡
 *
t
)

12676 
hfi1_devd©a
 *
dd
 = 
	`äom_tim”
(dd, 
t
, 
syÁh_¡©s_tim”
);

12678 
	`queue_wÜk
(
dd
->
upd©e_úŒ_wq
, &dd->
upd©e_úŒ_wÜk
);

12679 
	`mod_tim”
(&
dd
->
syÁh_¡©s_tim”
, 
jiff›s
 + 
HZ
 * 
SYNTH_CNT_TIME
);

12680 
	}
}

12682 
	#C_MAX_NAME
 16

	)

12683 
	$š™_úŒs
(
hfi1_devd©a
 *
dd
)

12685 
i
, 
rcv_ùxts
, 
j
;

12686 
size_t
 
sz
;

12687 *
p
;

12688 
Çme
[
C_MAX_NAME
];

12689 
hfi1_µÜtd©a
 *
µd
;

12690 cÚ¡ *
b™_ty³_32
 = ",32";

12691 cÚ¡ 
b™_ty³_32_sz
 = 
	`¡¾’
(
b™_ty³_32
);

12692 
u32
 
sdma_’gšes
 = 
	`ch_sdma_’gšes
(
dd
);

12695 
	`tim”_£tup
(&
dd
->
syÁh_¡©s_tim”
, 
upd©e_syÁh_tim”
, 0);

12702 
dd
->
ndevúŒs
 = 0;

12703 
sz
 = 0;

12705 
i
 = 0; i < 
DEV_CNTR_LAST
; i++) {

12706 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_DISABLED
) {

12707 
	`hfi1_dbg_—¾y
("\tSkpšg %s\n", 
dev_úŒs
[
i
].
Çme
);

12711 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_VL
) {

12712 
dev_úŒs
[
i
].
off£t
 = 
dd
->
ndevúŒs
;

12713 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12714 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12715 
dev_úŒs
[
i
].
Çme
, 
	`vl_äom_idx
(
j
));

12716 
sz
 +ð
	`¡¾’
(
Çme
);

12718 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
)

12719 
sz
 +ð
b™_ty³_32_sz
;

12720 
sz
++;

12721 
dd
->
ndevúŒs
++;

12723 } ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_SDMA
) {

12724 
dev_úŒs
[
i
].
off£t
 = 
dd
->
ndevúŒs
;

12725 
j
 = 0; j < 
sdma_’gšes
; j++) {

12726 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12727 
dev_úŒs
[
i
].
Çme
, 
j
);

12728 
sz
 +ð
	`¡¾’
(
Çme
);

12730 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
)

12731 
sz
 +ð
b™_ty³_32_sz
;

12732 
sz
++;

12733 
dd
->
ndevúŒs
++;

12737 
sz
 +ð
	`¡¾’
(
dev_úŒs
[
i
].
Çme
) + 1;

12739 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
)

12740 
sz
 +ð
b™_ty³_32_sz
;

12741 
dev_úŒs
[
i
].
off£t
 = 
dd
->
ndevúŒs
;

12742 
dd
->
ndevúŒs
++;

12747 
dd
->
úŒs
 = 
	`kÿÎoc
(dd->
ndevúŒs
 + 
num_driv”_úŒs
, (
u64
),

12748 
GFP_KERNEL
);

12749 ià(!
dd
->
úŒs
)

12750 
baž
;

12752 
dd
->
súŒs
 = 
	`kÿÎoc
(dd->
ndevúŒs
, (
u64
), 
GFP_KERNEL
);

12753 ià(!
dd
->
súŒs
)

12754 
baž
;

12757 
dd
->
úŒÇme¦’
 = 
sz
;

12758 
dd
->
úŒÇmes
 = 
	`km®loc
(
sz
, 
GFP_KERNEL
);

12759 ià(!
dd
->
úŒÇmes
)

12760 
baž
;

12763 
p
 = 
dd
->
úŒÇmes
, 
i
 = 0; i < 
DEV_CNTR_LAST
; i++) {

12764 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_DISABLED
) {

12766 } ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_VL
) {

12767 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12768 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12769 
dev_úŒs
[
i
].
Çme
,

12770 
	`vl_äom_idx
(
j
));

12771 
	`memýy
(
p
, 
Çme
, 
	`¡¾’
(name));

12772 
p
 +ð
	`¡¾’
(
Çme
);

12775 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
) {

12776 
	`memýy
(
p
, 
b™_ty³_32
, 
b™_ty³_32_sz
);

12777 
p
 +ð
b™_ty³_32_sz
;

12780 *
p
++ = '\n';

12782 } ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_SDMA
) {

12783 
j
 = 0; j < 
sdma_’gšes
; j++) {

12784 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12785 
dev_úŒs
[
i
].
Çme
, 
j
);

12786 
	`memýy
(
p
, 
Çme
, 
	`¡¾’
(name));

12787 
p
 +ð
	`¡¾’
(
Çme
);

12790 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
) {

12791 
	`memýy
(
p
, 
b™_ty³_32
, 
b™_ty³_32_sz
);

12792 
p
 +ð
b™_ty³_32_sz
;

12795 *
p
++ = '\n';

12798 
	`memýy
(
p
, 
dev_úŒs
[
i
].
Çme
, 
	`¡¾’
(dev_cntrs[i].name));

12799 
p
 +ð
	`¡¾’
(
dev_úŒs
[
i
].
Çme
);

12802 ià(
dev_úŒs
[
i
].
æags
 & 
CNTR_32BIT
) {

12803 
	`memýy
(
p
, 
b™_ty³_32
, 
b™_ty³_32_sz
);

12804 
p
 +ð
b™_ty³_32_sz
;

12807 *
p
++ = '\n';

12820 
rcv_ùxts
 = 
dd
->
num_rcv_cÚ‹xts
;

12821 
i
 = 
C_RCV_HDR_OVF_FIRST
 + 
rcv_ùxts
;

12822 
i
 <ð
C_RCV_HDR_OVF_LAST
; i++) {

12823 
pÜt_úŒs
[
i
].
æags
 |ð
CNTR_DISABLED
;

12827 
sz
 = 0;

12828 
dd
->
ÅÜtúŒs
 = 0;

12829 
i
 = 0; i < 
PORT_CNTR_LAST
; i++) {

12830 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_DISABLED
) {

12831 
	`hfi1_dbg_—¾y
("\tSkpšg %s\n", 
pÜt_úŒs
[
i
].
Çme
);

12835 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_VL
) {

12836 
pÜt_úŒs
[
i
].
off£t
 = 
dd
->
ÅÜtúŒs
;

12837 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12838 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12839 
pÜt_úŒs
[
i
].
Çme
, 
	`vl_äom_idx
(
j
));

12840 
sz
 +ð
	`¡¾’
(
Çme
);

12842 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_32BIT
)

12843 
sz
 +ð
b™_ty³_32_sz
;

12844 
sz
++;

12845 
dd
->
ÅÜtúŒs
++;

12849 
sz
 +ð
	`¡¾’
(
pÜt_úŒs
[
i
].
Çme
) + 1;

12851 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_32BIT
)

12852 
sz
 +ð
b™_ty³_32_sz
;

12853 
pÜt_úŒs
[
i
].
off£t
 = 
dd
->
ÅÜtúŒs
;

12854 
dd
->
ÅÜtúŒs
++;

12859 
dd
->
pÜtúŒÇme¦’
 = 
sz
;

12860 
dd
->
pÜtúŒÇmes
 = 
	`km®loc
(
sz
, 
GFP_KERNEL
);

12861 ià(!
dd
->
pÜtúŒÇmes
)

12862 
baž
;

12865 
p
 = 
dd
->
pÜtúŒÇmes
, 
i
 = 0; i < 
PORT_CNTR_LAST
; i++) {

12866 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_DISABLED
)

12869 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_VL
) {

12870 
j
 = 0; j < 
C_VL_COUNT
; j++) {

12871 
	`¢´štf
(
Çme
, 
C_MAX_NAME
, "%s%d",

12872 
pÜt_úŒs
[
i
].
Çme
, 
	`vl_äom_idx
(
j
));

12873 
	`memýy
(
p
, 
Çme
, 
	`¡¾’
(name));

12874 
p
 +ð
	`¡¾’
(
Çme
);

12877 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_32BIT
) {

12878 
	`memýy
(
p
, 
b™_ty³_32
, 
b™_ty³_32_sz
);

12879 
p
 +ð
b™_ty³_32_sz
;

12882 *
p
++ = '\n';

12885 
	`memýy
(
p
, 
pÜt_úŒs
[
i
].
Çme
,

12886 
	`¡¾’
(
pÜt_úŒs
[
i
].
Çme
));

12887 
p
 +ð
	`¡¾’
(
pÜt_úŒs
[
i
].
Çme
);

12890 ià(
pÜt_úŒs
[
i
].
æags
 & 
CNTR_32BIT
) {

12891 
	`memýy
(
p
, 
b™_ty³_32
, 
b™_ty³_32_sz
);

12892 
p
 +ð
b™_ty³_32_sz
;

12895 *
p
++ = '\n';

12900 
µd
 = (
hfi1_µÜtd©a
 *)(
dd
 + 1);

12901 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

12902 
µd
->
úŒs
 = 
	`kÿÎoc
(
dd
->
ÅÜtúŒs
, (
u64
), 
GFP_KERNEL
);

12903 ià(!
µd
->
úŒs
)

12904 
baž
;

12906 
µd
->
súŒs
 = 
	`kÿÎoc
(
dd
->
ÅÜtúŒs
, (
u64
), 
GFP_KERNEL
);

12907 ià(!
µd
->
súŒs
)

12908 
baž
;

12912 ià(
	`š™_ýu_couÁ”s
(
dd
))

12913 
baž
;

12915 
dd
->
upd©e_úŒ_wq
 = 
	`®loc_Üd”ed_wÜkqueue
("hfi1_update_cntr_%d",

12916 
WQ_MEM_RECLAIM
, 
dd
->
un™
);

12917 ià(!
dd
->
upd©e_úŒ_wq
)

12918 
baž
;

12920 
	`INIT_WORK
(&
dd
->
upd©e_úŒ_wÜk
, 
do_upd©e_syÁh_tim”
);

12922 
	`mod_tim”
(&
dd
->
syÁh_¡©s_tim”
, 
jiff›s
 + 
HZ
 * 
SYNTH_CNT_TIME
);

12924 
baž
:

12925 
	`ä“_úŒs
(
dd
);

12926  -
ENOMEM
;

12927 
	}
}

12929 
u32
 
	$ch_to_Ýa_l¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 
ch_l¡©e
)

12931 
ch_l¡©e
) {

12933 
	`dd_dev_”r
(
dd
,

12935 
ch_l¡©e
);

12937 
LSTATE_DOWN
:

12938  
IB_PORT_DOWN
;

12939 
LSTATE_INIT
:

12940  
IB_PORT_INIT
;

12941 
LSTATE_ARMED
:

12942  
IB_PORT_ARMED
;

12943 
LSTATE_ACTIVE
:

12944  
IB_PORT_ACTIVE
;

12946 
	}
}

12948 
u32
 
	$ch_to_Ýa_p¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 
ch_p¡©e
)

12951 
ch_p¡©e
 & 0xf0) {

12953 
	`dd_dev_”r
(
dd
, "Unexpected chip…hysical state of 0x%x\n",

12954 
ch_p¡©e
);

12956 
PLS_DISABLED
:

12957  
IB_PORTPHYSSTATE_DISABLED
;

12958 
PLS_OFFLINE
:

12959  
OPA_PORTPHYSSTATE_OFFLINE
;

12960 
PLS_POLLING
:

12961  
IB_PORTPHYSSTATE_POLLING
;

12962 
PLS_CONFIGPHY
:

12963  
IB_PORTPHYSSTATE_TRAINING
;

12964 
PLS_LINKUP
:

12965  
IB_PORTPHYSSTATE_LINKUP
;

12966 
PLS_PHYTEST
:

12967  
IB_PORTPHYSSTATE_PHY_TEST
;

12969 
	}
}

12972 cÚ¡ *
	$Ýa_l¡©e_Çme
(
u32
 
l¡©e
)

12974 cÚ¡ * cÚ¡ 
pÜt_logiÿl_Çmes
[] = {

12982 ià(
l¡©e
 < 
	`ARRAY_SIZE
(
pÜt_logiÿl_Çmes
))

12983  
pÜt_logiÿl_Çmes
[
l¡©e
];

12985 
	}
}

12988 cÚ¡ *
	$Ýa_p¡©e_Çme
(
u32
 
p¡©e
)

12990 cÚ¡ * cÚ¡ 
pÜt_physiÿl_Çmes
[] = {

13004 ià(
p¡©e
 < 
	`ARRAY_SIZE
(
pÜt_physiÿl_Çmes
))

13005  
pÜt_physiÿl_Çmes
[
p¡©e
];

13007 
	}
}

13020 
	$upd©e_¡©u¥
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
)

13030 ià(
µd
->
¡©u¥
) {

13031 
¡©e
) {

13032 
IB_PORT_DOWN
:

13033 
IB_PORT_INIT
:

13034 *
µd
->
¡©u¥
 &ð~(
HFI1_STATUS_IB_CONF
 |

13035 
HFI1_STATUS_IB_READY
);

13037 
IB_PORT_ARMED
:

13038 *
µd
->
¡©u¥
 |ð
HFI1_STATUS_IB_CONF
;

13040 
IB_PORT_ACTIVE
:

13041 *
µd
->
¡©u¥
 |ð
HFI1_STATUS_IB_READY
;

13045 
	`dd_dev_šfo
(
µd
->
dd
, "logical state changedo %s (0x%x)\n",

13046 
	`Ýa_l¡©e_Çme
(
¡©e
), state);

13047 
	}
}

13059 
	$wa™_logiÿl_lšk¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
,

13060 
m£cs
)

13062 
timeout
;

13063 
u32
 
Ãw_¡©e
;

13065 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
m£cs
);

13067 
Ãw_¡©e
 = 
	`ch_to_Ýa_l¡©e
(
µd
->
dd
,

13068 
	`»ad_logiÿl_¡©e
(
µd
->
dd
));

13069 ià(
Ãw_¡©e
 =ð
¡©e
)

13071 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

13072 
	`dd_dev_”r
(
µd
->
dd
,

13074 
¡©e
);

13075  -
ETIMEDOUT
;

13077 
	`m¦“p
(20);

13081 
	}
}

13083 
	$log_¡©e_Œªs™iÚ
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
)

13085 
u32
 
ib_p¡©e
 = 
	`ch_to_Ýa_p¡©e
(
µd
->
dd
, 
¡©e
);

13087 
	`dd_dev_šfo
(
µd
->
dd
,

13089 
	`Ýa_p¡©e_Çme
(
ib_p¡©e
), ib_p¡©e, 
¡©e
);

13090 
	}
}

13096 
	$log_physiÿl_¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
)

13098 
u32
 
»ad_¡©e
 = 
	`»ad_physiÿl_¡©e
(
µd
->
dd
);

13100 ià(
»ad_¡©e
 =ð
¡©e
) {

13101 
	`log_¡©e_Œªs™iÚ
(
µd
, 
¡©e
);

13103 
	`dd_dev_”r
(
µd
->
dd
,

13105 
¡©e
, 
»ad_¡©e
);

13107 
	}
}

13118 
	$wa™_physiÿl_lšk¡©e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¡©e
,

13119 
m£cs
)

13121 
u32
 
»ad_¡©e
;

13122 
timeout
;

13124 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
m£cs
);

13126 
»ad_¡©e
 = 
	`»ad_physiÿl_¡©e
(
µd
->
dd
);

13127 ià(
»ad_¡©e
 =ð
¡©e
)

13129 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

13130 
	`dd_dev_”r
(
µd
->
dd
,

13132 
¡©e
);

13133  -
ETIMEDOUT
;

13135 
	`u¦“p_¿nge
(1950, 2050);

13138 
	`log_¡©e_Œªs™iÚ
(
µd
, 
¡©e
);

13140 
	}
}

13151 
	$wa™_phys_lšk_ofæše_sub¡©es
(
hfi1_µÜtd©a
 *
µd
,

13152 
m£cs
)

13154 
u32
 
»ad_¡©e
;

13155 
timeout
;

13157 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
m£cs
);

13159 
»ad_¡©e
 = 
	`»ad_physiÿl_¡©e
(
µd
->
dd
);

13160 ià((
»ad_¡©e
 & 0xF0è=ð
PLS_OFFLINE
)

13162 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

13163 
	`dd_dev_”r
(
µd
->
dd
,

13165 
»ad_¡©e
, 
m£cs
);

13166  -
ETIMEDOUT
;

13168 
	`u¦“p_¿nge
(1950, 2050);

13171 
	`log_¡©e_Œªs™iÚ
(
µd
, 
»ad_¡©e
);

13172  
»ad_¡©e
;

13173 
	}
}

13184 
	$wa™_phys_lšk_out_of_ofæše
(
hfi1_µÜtd©a
 *
µd
,

13185 
m£cs
)

13187 
u32
 
»ad_¡©e
;

13188 
timeout
;

13190 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
m£cs
);

13192 
»ad_¡©e
 = 
	`»ad_physiÿl_¡©e
(
µd
->
dd
);

13193 ià((
»ad_¡©e
 & 0xF0è!ð
PLS_OFFLINE
)

13195 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

13196 
	`dd_dev_”r
(
µd
->
dd
,

13198 
»ad_¡©e
, 
m£cs
);

13199  -
ETIMEDOUT
;

13201 
	`u¦“p_¿nge
(1950, 2050);

13204 
	`log_¡©e_Œªs™iÚ
(
µd
, 
»ad_¡©e
);

13205  
»ad_¡©e
;

13206 
	}
}

13208 
	#CLEAR_STATIC_RATE_CONTROL_SMASK
(
r
) \

13209 (
r
 &ð~
SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK
)

	)

13211 
	#SET_STATIC_RATE_CONTROL_SMASK
(
r
) \

13212 (
r
 |ð
SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK
)

	)

13214 
	$hfi1_š™_ùxt
(
£nd_cÚ‹xt
 *
sc
)

13216 ià(
sc
) {

13217 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

13218 
u64
 
»g
;

13219 
u8
 
£t
 = (
sc
->
ty³
 =ð
SC_USER
 ?

13220 
	`HFI1_CAP_IS_USET
(
STATIC_RATE_CTRL
) :

13221 
	`HFI1_CAP_IS_KSET
(
STATIC_RATE_CTRL
));

13222 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
,

13223 
SEND_CTXT_CHECK_ENABLE
);

13224 ià(
£t
)

13225 
	`CLEAR_STATIC_RATE_CONTROL_SMASK
(
»g
);

13227 
	`SET_STATIC_RATE_CONTROL_SMASK
(
»g
);

13228 
	`wr™e_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
,

13229 
SEND_CTXT_CHECK_ENABLE
, 
»g
);

13231 
	}
}

13233 
	$hfi1_‹mp£n£_rd
(
hfi1_devd©a
 *
dd
, 
hfi1_‹mp
 *
‹mp
)

13235 
»t
 = 0;

13236 
u64
 
»g
;

13238 ià(
dd
->
icode
 !ð
ICODE_RTL_SILICON
) {

13239 ià(
	`HFI1_CAP_IS_KSET
(
PRINT_UNIMPL
))

13240 
	`dd_dev_šfo
(
dd
, "%s:empsense‚ot supported by HW\n",

13241 
__func__
);

13242  -
EINVAL
;

13244 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_THERM
);

13245 
‹mp
->
cu¼
 = ((
»g
 >> 
ASIC_STS_THERM_CURR_TEMP_SHIFT
) &

13246 
ASIC_STS_THERM_CURR_TEMP_MASK
);

13247 
‹mp
->
lo_lim
 = ((
»g
 >> 
ASIC_STS_THERM_LO_TEMP_SHIFT
) &

13248 
ASIC_STS_THERM_LO_TEMP_MASK
);

13249 
‹mp
->
hi_lim
 = ((
»g
 >> 
ASIC_STS_THERM_HI_TEMP_SHIFT
) &

13250 
ASIC_STS_THERM_HI_TEMP_MASK
);

13251 
‹mp
->
ü™_lim
 = ((
»g
 >> 
ASIC_STS_THERM_CRIT_TEMP_SHIFT
) &

13252 
ASIC_STS_THERM_CRIT_TEMP_MASK
);

13254 
‹mp
->
Œigg”s
 = (
u8
)((
»g
 >> 
ASIC_STS_THERM_LOW_SHIFT
) & 0x7);

13256  
»t
;

13257 
	}
}

13269 
	$»ad_mod_wr™e
(
hfi1_devd©a
 *
dd
, 
u16
 
¤c
, 
u64
 
b™s
,

13270 
boÞ
 
£t
)

13272 
u64
 
»g
;

13273 
u16
 
idx
 = 
¤c
 / 
BITS_PER_REGISTER
;

13275 
	`¥š_lock
(&
dd
->
œq_¤c_lock
);

13276 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_MASK
 + (8 * 
idx
));

13277 ià(
£t
)

13278 
»g
 |ð
b™s
;

13280 
»g
 &ð~
b™s
;

13281 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
 + (8 * 
idx
), 
»g
);

13282 
	`¥š_uÆock
(&
dd
->
œq_¤c_lock
);

13283 
	}
}

13294 
	$£t_šŒ_b™s
(
hfi1_devd©a
 *
dd
, 
u16
 
fœ¡
, u16 
Ï¡
, 
boÞ
 
£t
)

13296 
u64
 
b™s
 = 0;

13297 
u64
 
b™
;

13298 
u16
 
¤c
;

13300 ià(
fœ¡
 > 
NUM_INTERRUPT_SOURCES
 || 
Ï¡
 > NUM_INTERRUPT_SOURCES)

13301  -
EINVAL
;

13303 ià(
Ï¡
 < 
fœ¡
)

13304  -
ERANGE
;

13306 
¤c
 = 
fœ¡
; srø<ð
Ï¡
; src++) {

13307 
b™
 = 
¤c
 % 
BITS_PER_REGISTER
;

13309 ià(!
b™
 && 
b™s
) {

13310 
	`»ad_mod_wr™e
(
dd
, 
¤c
 - 1, 
b™s
, 
£t
);

13311 
b™s
 = 0;

13313 
b™s
 |ð
	`BIT_ULL
(
b™
);

13315 
	`»ad_mod_wr™e
(
dd
, 
Ï¡
, 
b™s
, 
£t
);

13318 
	}
}

13323 
	$þ—r_®l_š‹¼u±s
(
hfi1_devd©a
 *
dd
)

13325 
i
;

13327 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; i++)

13328 
	`wr™e_c¤
(
dd
, 
CCE_INT_CLEAR
 + (8 * 
i
), ~(
u64
)0);

13330 
	`wr™e_c¤
(
dd
, 
CCE_ERR_CLEAR
, ~(
u64
)0);

13331 
	`wr™e_c¤
(
dd
, 
MISC_ERR_CLEAR
, ~(
u64
)0);

13332 
	`wr™e_c¤
(
dd
, 
RCV_ERR_CLEAR
, ~(
u64
)0);

13333 
	`wr™e_c¤
(
dd
, 
SEND_ERR_CLEAR
, ~(
u64
)0);

13334 
	`wr™e_c¤
(
dd
, 
SEND_PIO_ERR_CLEAR
, ~(
u64
)0);

13335 
	`wr™e_c¤
(
dd
, 
SEND_DMA_ERR_CLEAR
, ~(
u64
)0);

13336 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_CLEAR
, ~(
u64
)0);

13337 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++)

13338 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_ERR_CLEAR
, ~(
u64
)0);

13339 
i
 = 0; i < 
	`ch_sdma_’gšes
(
dd
); i++)

13340 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_ENG_ERR_CLEAR
, ~(
u64
)0);

13342 
	`wr™e_c¤
(
dd
, 
DCC_ERR_FLG_CLR
, ~(
u64
)0);

13343 
	`wr™e_c¤
(
dd
, 
DC_LCB_ERR_CLR
, ~(
u64
)0);

13344 
	`wr™e_c¤
(
dd
, 
DC_DC8051_ERR_CLR
, ~(
u64
)0);

13345 
	}
}

13351 
	$»m­_šŒ
(
hfi1_devd©a
 *
dd
, 
i¤c
, 
msix_šŒ
)

13353 
u64
 
»g
;

13354 
m
, 
n
;

13357 
m
 = 
i¤c
 / 64;

13358 
n
 = 
i¤c
 % 64;

13359 ià(
	`lik–y
(
m
 < 
CCE_NUM_INT_CSRS
)) {

13360 
dd
->
gi_mask
[
m
] &ð~((
u64
)1 << 
n
);

13362 
	`dd_dev_”r
(
dd
, "remap interruptƒrr\n");

13367 
m
 = 
i¤c
 / 8;

13368 
n
 = 
i¤c
 % 8;

13369 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_MAP
 + (8 * 
m
));

13370 
»g
 &ð~((
u64
)0xfà<< (8 * 
n
));

13371 
»g
 |ð((
u64
)
msix_šŒ
 & 0xffè<< (8 * 
n
);

13372 
	`wr™e_c¤
(
dd
, 
CCE_INT_MAP
 + (8 * 
m
), 
»g
);

13373 
	}
}

13375 
	$»m­_sdma_š‹¼u±s
(
hfi1_devd©a
 *
dd
, 
’gše
, 
msix_šŒ
)

13384 
	`»m­_šŒ
(
dd
, 
IS_SDMA_START
 + 
’gše
, 
msix_šŒ
);

13385 
	`»m­_šŒ
(
dd
, 
IS_SDMA_PROGRESS_START
 + 
’gše
, 
msix_šŒ
);

13386 
	`»m­_šŒ
(
dd
, 
IS_SDMA_IDLE_START
 + 
’gše
, 
msix_šŒ
);

13387 
	}
}

13393 
	$»£t_š‹¼u±s
(
hfi1_devd©a
 *
dd
)

13395 
i
;

13398 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; i++)

13399 
dd
->
gi_mask
[
i
] = ~(
u64
)0;

13402 
i
 = 0; i < 
CCE_NUM_INT_MAP_CSRS
; i++)

13403 
	`wr™e_c¤
(
dd
, 
CCE_INT_MAP
 + (8 * 
i
), 0);

13404 
	}
}

13411 
	$£t_up_š‹¼u±s
(
hfi1_devd©a
 *
dd
)

13413 
»t
;

13416 
	`£t_šŒ_b™s
(
dd
, 
IS_FIRST_SOURCE
, 
IS_LAST_SOURCE
, 
çl£
);

13419 
	`þ—r_®l_š‹¼u±s
(
dd
);

13422 
	`»£t_š‹¼u±s
(
dd
);

13425 
»t
 = 
	`msix_š™Ÿlize
(
dd
);

13426 ià(
»t
)

13427  
»t
;

13429 
»t
 = 
	`msix_»que¡_œqs
(
dd
);

13430 ià(
»t
)

13431 
	`msix_þ—n_up_š‹¼u±s
(
dd
);

13433  
»t
;

13434 
	}
}

13447 
	$£t_up_cÚ‹xt_v¬ŸbËs
(
hfi1_devd©a
 *
dd
)

13449 
num_k”Ãl_cÚ‹xts
;

13450 
u16
 
num_Ãtdev_cÚ‹xts
 = 
HFI1_NUM_NETDEV_CTXT
;

13451 
tÙ®_cÚ‹xts
;

13452 
»t
;

13453 
ngroups
;

13454 
rmt_couÁ
;

13455 
u£r_rmt_»duûd
;

13456 
u32
 
n_u¤_ùxts
;

13457 
u32
 
£nd_cÚ‹xts
 = 
	`ch_£nd_cÚ‹xts
(
dd
);

13458 
u32
 
rcv_cÚ‹xts
 = 
	`ch_rcv_cÚ‹xts
(
dd
);

13467 ià(
n_krcvqs
)

13473 
num_k”Ãl_cÚ‹xts
 = 
n_krcvqs
 + 1;

13475 
num_k”Ãl_cÚ‹xts
 = 
DEFAULT_KRCVQS
 + 1;

13480 ià(
num_k”Ãl_cÚ‹xts
 > (
£nd_cÚ‹xts
 - 
num_vls
 - 1)) {

13481 
	`dd_dev_”r
(
dd
,

13483 
£nd_cÚ‹xts
 - 
num_vls
 - 1,

13484 
num_k”Ãl_cÚ‹xts
);

13485 
num_k”Ãl_cÚ‹xts
 = 
£nd_cÚ‹xts
 - 
num_vls
 - 1;

13489 ià((
num_k”Ãl_cÚ‹xts
 + 
num_Ãtdev_cÚ‹xts
è> 
rcv_cÚ‹xts
) {

13490 
	`dd_dev_”r
(
dd
, "No„eceive contexts‡vailable for VNIC\n");

13491 
num_Ãtdev_cÚ‹xts
 = 0;

13493 
tÙ®_cÚ‹xts
 = 
num_k”Ãl_cÚ‹xts
 + 
num_Ãtdev_cÚ‹xts
;

13500 ià(
num_u£r_cÚ‹xts
 < 0)

13501 
n_u¤_ùxts
 = 
	`ýumask_weight
(&
node_affš™y
.
»®_ýu_mask
);

13503 
n_u¤_ùxts
 = 
num_u£r_cÚ‹xts
;

13507 ià(
tÙ®_cÚ‹xts
 + 
n_u¤_ùxts
 > 
rcv_cÚ‹xts
) {

13508 
	`dd_dev_”r
(
dd
,

13510 
rcv_cÚ‹xts
 - 
tÙ®_cÚ‹xts
,

13511 
n_u¤_ùxts
);

13513 
n_u¤_ùxts
 = 
rcv_cÚ‹xts
 - 
tÙ®_cÚ‹xts
;

13528 
rmt_couÁ
 = 
	`qos_rmt_’Œ›s
(
dd
, 
NULL
, NULLè+ (
num_Ãtdev_cÚ‹xts
 * 2);

13529 ià(
	`HFI1_CAP_IS_KSET
(
TID_RDMA
))

13530 
rmt_couÁ
 +ð
num_k”Ãl_cÚ‹xts
 - 1;

13531 ià(
rmt_couÁ
 + 
n_u¤_ùxts
 > 
NUM_MAP_ENTRIES
) {

13532 
u£r_rmt_»duûd
 = 
NUM_MAP_ENTRIES
 - 
rmt_couÁ
;

13533 
	`dd_dev_”r
(
dd
,

13535 
n_u¤_ùxts
,

13536 
u£r_rmt_»duûd
);

13538 
n_u¤_ùxts
 = 
u£r_rmt_»duûd
;

13541 
tÙ®_cÚ‹xts
 +ð
n_u¤_ùxts
;

13544 
dd
->
num_rcv_cÚ‹xts
 = 
tÙ®_cÚ‹xts
;

13545 
dd
->
n_krcv_queues
 = 
num_k”Ãl_cÚ‹xts
;

13546 
dd
->
fœ¡_dyn_®loc_ùxt
 = 
num_k”Ãl_cÚ‹xts
;

13547 
dd
->
num_Ãtdev_cÚ‹xts
 =‚um_netdev_contexts;

13548 
dd
->
num_u£r_cÚ‹xts
 = 
n_u¤_ùxts
;

13549 
dd
->
ä“ùxts
 = 
n_u¤_ùxts
;

13550 
	`dd_dev_šfo
(
dd
,

13552 
rcv_cÚ‹xts
,

13553 ()
dd
->
num_rcv_cÚ‹xts
,

13554 ()
dd
->
n_krcv_queues
,

13555 
dd
->
num_Ãtdev_cÚ‹xts
,

13556 
dd
->
num_u£r_cÚ‹xts
);

13569 
dd
->
rcv_’Œ›s
.
group_size
 = 
RCV_INCREMENT
;

13570 
ngroups
 = 
	`ch_rcv_¬¿y_couÁ
(
dd
è/ dd->
rcv_’Œ›s
.
group_size
;

13571 
dd
->
rcv_’Œ›s
.
ngroups
 =‚group / dd->
num_rcv_cÚ‹xts
;

13572 
dd
->
rcv_’Œ›s
.
nùxt_exŒa
 = 
ngroups
 -

13573 (
dd
->
num_rcv_cÚ‹xts
 * dd->
rcv_’Œ›s
.
ngroups
);

13574 
	`dd_dev_šfo
(
dd
, "RcvArray groups %u, ctxtsƒxtra %u\n",

13575 
dd
->
rcv_’Œ›s
.
ngroups
,

13576 
dd
->
rcv_’Œ›s
.
nùxt_exŒa
);

13577 ià(
dd
->
rcv_’Œ›s
.
ngroups
 * dd->rcv_’Œ›s.
group_size
 >

13578 
MAX_EAGER_ENTRIES
 * 2) {

13579 
dd
->
rcv_’Œ›s
.
ngroups
 = (
MAX_EAGER_ENTRIES
 * 2) /

13580 
dd
->
rcv_’Œ›s
.
group_size
;

13581 
	`dd_dev_šfo
(
dd
,

13583 
dd
->
rcv_’Œ›s
.
ngroups
);

13584 
dd
->
rcv_’Œ›s
.
nùxt_exŒa
 = 0;

13589 
»t
 = 
	`š™_sc_poÞs_ªd_sizes
(
dd
);

13590 ià(
»t
 >= 0) {

13591 
dd
->
num_£nd_cÚ‹xts
 = 
»t
;

13592 
	`dd_dev_šfo
(

13593 
dd
,

13595 
£nd_cÚ‹xts
,

13596 
dd
->
num_£nd_cÚ‹xts
,

13597 
dd
->
sc_sizes
[
SC_KERNEL
].
couÁ
,

13598 
dd
->
sc_sizes
[
SC_ACK
].
couÁ
,

13599 
dd
->
sc_sizes
[
SC_USER
].
couÁ
,

13600 
dd
->
sc_sizes
[
SC_VL15
].
couÁ
);

13601 
»t
 = 0;

13604  
»t
;

13605 
	}
}

13612 
	$£t_·¹™iÚ_keys
(
hfi1_µÜtd©a
 *
µd
)

13614 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

13615 
u64
 
»g
 = 0;

13616 
i
;

13618 
	`dd_dev_šfo
(
dd
, "Setting…artition keys\n");

13619 
i
 = 0; i < 
	`hfi1_g‘_Åkeys
(
dd
); i++) {

13620 
»g
 |ð(
µd
->
pkeys
[
i
] &

13621 
RCV_PARTITION_KEY_PARTITION_KEY_A_MASK
) <<

13622 ((
i
 % 4) *

13623 
RCV_PARTITION_KEY_PARTITION_KEY_B_SHIFT
);

13625 ià((
i
 % 4) == 3) {

13626 
	`wr™e_c¤
(
dd
, 
RCV_PARTITION_KEY
 +

13627 ((
i
 - 3è* 2), 
»g
);

13628 
»g
 = 0;

13633 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_PARTITION_KEY_ENABLE_SMASK
);

13634 
	}
}

13644 
	$wr™e_unš™Ÿlized_c¤s_ªd_memÜ›s
(
hfi1_devd©a
 *
dd
)

13646 
i
, 
j
;

13649 
i
 = 0; i < 
CCE_NUM_INT_MAP_CSRS
; i++)

13650 
	`wr™e_c¤
(
dd
, 
CCE_INT_MAP
 + (8 * 
i
), 0);

13653 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++)

13654 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CREDIT_RETURN_ADDR
, 0);

13666 
i
 = 0; i < 
	`ch_rcv_cÚ‹xts
(
dd
); i++) {

13667 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_ADDR
, 0);

13668 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_TAIL_ADDR
, 0);

13669 
j
 = 0; j < 
RXE_NUM_TID_FLOWS
; j++)

13670 
	`wr™e_uùxt_c¤
(
dd
, 
i
, 
RCV_TID_FLOW_TABLE
 + (8 * 
j
), 0);

13674 
i
 = 0; i < 
	`ch_rcv_¬¿y_couÁ
(
dd
); i++)

13675 
	`hfi1_put_tid
(
dd
, 
i
, 
PT_INVALID_FLUSH
, 0, 0);

13678 
i
 = 0; i < 32; i++)

13679 
	`wr™e_c¤
(
dd
, 
RCV_QP_MAP_TABLE
 + (8 * 
i
), 0);

13680 
	}
}

13685 
	$þ—r_cû_¡©us
(
hfi1_devd©a
 *
dd
, 
u64
 
¡©us_b™s
,

13686 
u64
 
ù¾_b™s
)

13688 
timeout
;

13689 
u64
 
»g
;

13692 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_STATUS
);

13693 ià((
»g
 & 
¡©us_b™s
) == 0)

13697 
	`wr™e_c¤
(
dd
, 
CCE_CTRL
, 
ù¾_b™s
);

13700 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
CCE_STATUS_TIMEOUT
);

13702 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_STATUS
);

13703 ià((
»g
 & 
¡©us_b™s
) == 0)

13705 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

13706 
	`dd_dev_”r
(
dd
,

13708 
¡©us_b™s
, 
»g
 & status_bits);

13711 
	`ud–ay
(1);

13713 
	}
}

13716 
	$»£t_cû_c¤s
(
hfi1_devd©a
 *
dd
)

13718 
i
;

13724 
	`þ—r_cû_¡©us
(
dd
, 
ALL_FROZE
, 
CCE_CTRL_SPC_UNFREEZE_SMASK
);

13725 
	`þ—r_cû_¡©us
(
dd
, 
ALL_TXE_PAUSE
, 
CCE_CTRL_TXE_RESUME_SMASK
);

13726 
	`þ—r_cû_¡©us
(
dd
, 
ALL_RXE_PAUSE
, 
CCE_CTRL_RXE_RESUME_SMASK
);

13727 
i
 = 0; i < 
CCE_NUM_SCRATCH
; i++)

13728 
	`wr™e_c¤
(
dd
, 
CCE_SCRATCH
 + (8 * 
i
), 0);

13730 
	`wr™e_c¤
(
dd
, 
CCE_ERR_MASK
, 0);

13731 
	`wr™e_c¤
(
dd
, 
CCE_ERR_CLEAR
, ~0ull);

13733 
i
 = 0; i < 
CCE_NUM_32_BIT_COUNTERS
; i++)

13734 
	`wr™e_c¤
(
dd
, 
CCE_COUNTER_ARRAY32
 + (8 * 
i
), 0);

13735 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 
CCE_DC_CTRL_RESETCSR
);

13737 
i
 = 0; i < 
CCE_NUM_MSIX_VECTORS
; i++) {

13738 
	`wr™e_c¤
(
dd
, 
CCE_MSIX_TABLE_LOWER
 + (8 * 
i
), 0);

13739 
	`wr™e_c¤
(
dd
, 
CCE_MSIX_TABLE_UPPER
 + (8 * 
i
),

13740 
CCE_MSIX_TABLE_UPPER_RESETCSR
);

13742 
i
 = 0; i < 
CCE_NUM_MSIX_PBAS
; i++) {

13744 
	`wr™e_c¤
(
dd
, 
CCE_MSIX_INT_GRANTED
, ~0ull);

13745 
	`wr™e_c¤
(
dd
, 
CCE_MSIX_VEC_CLR_WITHOUT_INT
, ~0ull);

13747 
i
 = 0; i < 
CCE_NUM_INT_MAP_CSRS
; i++)

13748 
	`wr™e_c¤
(
dd
, 
CCE_INT_MAP
, 0);

13749 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; i++) {

13751 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
 + (8 * 
i
), 0);

13752 
	`wr™e_c¤
(
dd
, 
CCE_INT_CLEAR
 + (8 * 
i
), ~0ull);

13756 
i
 = 0; i < 
CCE_NUM_32_BIT_INT_COUNTERS
; i++)

13757 
	`wr™e_c¤
(
dd
, 
CCE_INT_COUNTER_ARRAY32
 + (8 * 
i
), 0);

13758 
	}
}

13761 
	$»£t_misc_c¤s
(
hfi1_devd©a
 *
dd
)

13763 
i
;

13765 
i
 = 0; i < 32; i++) {

13766 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_R2
 + (8 * 
i
), 0);

13767 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_SIGNATURE
 + (8 * 
i
), 0);

13768 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_MODULUS
 + (8 * 
i
), 0);

13775 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_CMD
, 1);

13776 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_MU
, 0);

13777 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 0);

13783 
	`wr™e_c¤
(
dd
, 
MISC_ERR_MASK
, 0);

13784 
	`wr™e_c¤
(
dd
, 
MISC_ERR_CLEAR
, ~0ull);

13786 
	}
}

13789 
	$»£t_txe_c¤s
(
hfi1_devd©a
 *
dd
)

13791 
i
;

13796 
	`wr™e_c¤
(
dd
, 
SEND_CTRL
, 0);

13797 
	`__cm_»£t
(
dd
, 0);

13802 
	`wr™e_c¤
(
dd
, 
SEND_HIGH_PRIORITY_LIMIT
, 0);

13803 
	`pio_»£t_®l
(
dd
);

13805 
	`wr™e_c¤
(
dd
, 
SEND_PIO_ERR_MASK
, 0);

13806 
	`wr™e_c¤
(
dd
, 
SEND_PIO_ERR_CLEAR
, ~0ull);

13809 
	`wr™e_c¤
(
dd
, 
SEND_DMA_ERR_MASK
, 0);

13810 
	`wr™e_c¤
(
dd
, 
SEND_DMA_ERR_CLEAR
, ~0ull);

13813 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_MASK
, 0);

13814 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_CLEAR
, ~0ull);

13816 
	`wr™e_c¤
(
dd
, 
SEND_BTH_QP
, 0);

13817 
	`wr™e_c¤
(
dd
, 
SEND_STATIC_RATE_CONTROL
, 0);

13818 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT0
, 0);

13819 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT1
, 0);

13820 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT2
, 0);

13821 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT3
, 0);

13822 
	`wr™e_c¤
(
dd
, 
SEND_LEN_CHECK0
, 0);

13823 
	`wr™e_c¤
(
dd
, 
SEND_LEN_CHECK1
, 0);

13825 
	`wr™e_c¤
(
dd
, 
SEND_ERR_MASK
, 0);

13826 
	`wr™e_c¤
(
dd
, 
SEND_ERR_CLEAR
, ~0ull);

13828 
i
 = 0; i < 
VL_ARB_LOW_PRIO_TABLE_SIZE
; i++)

13829 
	`wr™e_c¤
(
dd
, 
SEND_LOW_PRIORITY_LIST
 + (8 * 
i
), 0);

13830 
i
 = 0; i < 
VL_ARB_HIGH_PRIO_TABLE_SIZE
; i++)

13831 
	`wr™e_c¤
(
dd
, 
SEND_HIGH_PRIORITY_LIST
 + (8 * 
i
), 0);

13832 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
è/ 
NUM_CONTEXTS_PER_SET
; i++)

13833 
	`wr™e_c¤
(
dd
, 
SEND_CONTEXT_SET_CTRL
 + (8 * 
i
), 0);

13834 
i
 = 0; i < 
TXE_NUM_32_BIT_COUNTER
; i++)

13835 
	`wr™e_c¤
(
dd
, 
SEND_COUNTER_ARRAY32
 + (8 * 
i
), 0);

13836 
i
 = 0; i < 
TXE_NUM_64_BIT_COUNTER
; i++)

13837 
	`wr™e_c¤
(
dd
, 
SEND_COUNTER_ARRAY64
 + (8 * 
i
), 0);

13838 
	`wr™e_c¤
(
dd
, 
SEND_CM_CTRL
, 
SEND_CM_CTRL_RESETCSR
);

13839 
	`wr™e_c¤
(
dd
, 
SEND_CM_GLOBAL_CREDIT
, 
SEND_CM_GLOBAL_CREDIT_RESETCSR
);

13841 
	`wr™e_c¤
(
dd
, 
SEND_CM_TIMER_CTRL
, 0);

13842 
	`wr™e_c¤
(
dd
, 
SEND_CM_LOCAL_AU_TABLE0_TO3
, 0);

13843 
	`wr™e_c¤
(
dd
, 
SEND_CM_LOCAL_AU_TABLE4_TO7
, 0);

13844 
	`wr™e_c¤
(
dd
, 
SEND_CM_REMOTE_AU_TABLE0_TO3
, 0);

13845 
	`wr™e_c¤
(
dd
, 
SEND_CM_REMOTE_AU_TABLE4_TO7
, 0);

13846 
i
 = 0; i < 
TXE_NUM_DATA_VL
; i++)

13847 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL
 + (8 * 
i
), 0);

13848 
	`wr™e_c¤
(
dd
, 
SEND_CM_CREDIT_VL15
, 0);

13853 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_INFO
, ~0ull);

13860 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++) {

13861 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CTRL
, 0);

13862 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CREDIT_CTRL
, 0);

13863 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CREDIT_RETURN_ADDR
, 0);

13864 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CREDIT_FORCE
, 0);

13865 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_ERR_MASK
, 0);

13866 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_ERR_CLEAR
, ~0ull);

13867 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_ENABLE
, 0);

13868 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_VL
, 0);

13869 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_JOB_KEY
, 0);

13870 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_PARTITION_KEY
, 0);

13871 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_SLID
, 0);

13872 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CHECK_OPCODE
, 0);

13878 
i
 = 0; i < 
	`ch_sdma_’gšes
(
dd
); i++) {

13879 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CTRL
, 0);

13881 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_BASE_ADDR
, 0);

13882 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_LEN_GEN
, 0);

13883 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_TAIL
, 0);

13885 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_HEAD_ADDR
, 0);

13886 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_PRIORITY_THLD
, 0);

13888 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_RELOAD_CNT
, 0);

13889 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_DESC_CNT
, 0);

13892 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_ENG_ERR_MASK
, 0);

13893 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_ENG_ERR_CLEAR
, ~0ull);

13895 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_ENABLE
, 0);

13896 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_VL
, 0);

13897 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_JOB_KEY
, 0);

13898 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_PARTITION_KEY
, 0);

13899 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_SLID
, 0);

13900 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CHECK_OPCODE
, 0);

13901 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_MEMORY
, 0);

13903 
	}
}

13909 
	$š™_rbufs
(
hfi1_devd©a
 *
dd
)

13911 
u64
 
»g
;

13912 
couÁ
;

13918 
couÁ
 = 0;

13920 
»g
 = 
	`»ad_c¤
(
dd
, 
RCV_STATUS
);

13921 ià((
»g
 & (
RCV_STATUS_RX_RBUF_PKT_PENDING_SMASK


13922 | 
RCV_STATUS_RX_PKT_IN_PROGRESS_SMASK
)) == 0)

13931 ià(
couÁ
++ > 500) {

13932 
	`dd_dev_”r
(
dd
,

13934 
__func__
, 
»g
);

13937 
	`ud–ay
(2);

13941 
	`wr™e_c¤
(
dd
, 
RCV_CTRL
, 
RCV_CTRL_RX_RBUF_INIT_SMASK
);

13949 
	`»ad_c¤
(
dd
, 
RCV_CTRL
);

13952 
couÁ
 = 0;

13955 
	`ud–ay
(2);

13956 
»g
 = 
	`»ad_c¤
(
dd
, 
RCV_STATUS
);

13957 ià(
»g
 & (
RCV_STATUS_RX_RBUF_INIT_DONE_SMASK
))

13961 ià(
couÁ
++ > 50) {

13962 
	`dd_dev_”r
(
dd
,

13964 
__func__
);

13968 
	}
}

13971 
	$»£t_rxe_c¤s
(
hfi1_devd©a
 *
dd
)

13973 
i
, 
j
;

13978 
	`wr™e_c¤
(
dd
, 
RCV_CTRL
, 0);

13979 
	`š™_rbufs
(
dd
);

13984 
	`wr™e_c¤
(
dd
, 
RCV_BTH_QP
, 0);

13985 
	`wr™e_c¤
(
dd
, 
RCV_MULTICAST
, 0);

13986 
	`wr™e_c¤
(
dd
, 
RCV_BYPASS
, 0);

13987 
	`wr™e_c¤
(
dd
, 
RCV_VL15
, 0);

13989 
	`wr™e_c¤
(
dd
, 
RCV_ERR_INFO
,

13990 
RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SMASK
);

13992 
	`wr™e_c¤
(
dd
, 
RCV_ERR_MASK
, 0);

13993 
	`wr™e_c¤
(
dd
, 
RCV_ERR_CLEAR
, ~0ull);

13995 
i
 = 0; i < 32; i++)

13996 
	`wr™e_c¤
(
dd
, 
RCV_QP_MAP_TABLE
 + (8 * 
i
), 0);

13997 
i
 = 0; i < 4; i++)

13998 
	`wr™e_c¤
(
dd
, 
RCV_PARTITION_KEY
 + (8 * 
i
), 0);

13999 
i
 = 0; i < 
RXE_NUM_32_BIT_COUNTERS
; i++)

14000 
	`wr™e_c¤
(
dd
, 
RCV_COUNTER_ARRAY32
 + (8 * 
i
), 0);

14001 
i
 = 0; i < 
RXE_NUM_64_BIT_COUNTERS
; i++)

14002 
	`wr™e_c¤
(
dd
, 
RCV_COUNTER_ARRAY64
 + (8 * 
i
), 0);

14003 
i
 = 0; i < 
RXE_NUM_RSM_INSTANCES
; i++)

14004 
	`þ—r_rsm_ruË
(
dd
, 
i
);

14005 
i
 = 0; i < 32; i++)

14006 
	`wr™e_c¤
(
dd
, 
RCV_RSM_MAP_TABLE
 + (8 * 
i
), 0);

14011 
i
 = 0; i < 
	`ch_rcv_cÚ‹xts
(
dd
); i++) {

14013 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_CTXT_CTRL
, 0);

14015 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_EGR_CTRL
, 0);

14016 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_TID_CTRL
, 0);

14017 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_KEY_CTRL
, 0);

14018 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_ADDR
, 0);

14019 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_CNT
, 0);

14020 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_ENT_SIZE
, 0);

14021 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_SIZE
, 0);

14022 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_TAIL_ADDR
, 0);

14023 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_AVAIL_TIME_OUT
, 0);

14024 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
RCV_HDR_OVFL_CNT
, 0);

14028 
	`wr™e_uùxt_c¤
(
dd
, 
i
, 
RCV_HDR_HEAD
, 0);

14030 
	`wr™e_uùxt_c¤
(
dd
, 
i
, 
RCV_EGR_INDEX_HEAD
, 0);

14032 
j
 = 0; j < 
RXE_NUM_TID_FLOWS
; j++) {

14033 
	`wr™e_uùxt_c¤
(
dd
, 
i
,

14034 
RCV_TID_FLOW_TABLE
 + (8 * 
j
), 0);

14037 
	}
}

14050 
	$š™_sc2vl_bËs
(
hfi1_devd©a
 *
dd
)

14052 
i
;

14056 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT0
, 
	`SC2VL_VAL
(

14062 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT1
, 
	`SC2VL_VAL
(

14068 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT2
, 
	`SC2VL_VAL
(

14074 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT3
, 
	`SC2VL_VAL
(

14082 
	`wr™e_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_15_0
, 
	`DC_SC_VL_VAL
(

14083 15
_0
,

14086 
	`wr™e_c¤
(
dd
, 
DCC_CFG_SC_VL_TABLE_31_16
, 
	`DC_SC_VL_VAL
(

14087 31
_16
,

14092 
i
 = 0; i < 32; i++) {

14093 ià(
i
 < 8 || i == 15)

14094 *((
u8
 *)(
dd
->
sc2vl
è+ 
i
) = (u8)i;

14096 *((
u8
 *)(
dd
->
sc2vl
è+ 
i
) = 0;

14098 
	}
}

14109 
	$š™_ch
(
hfi1_devd©a
 *
dd
)

14111 
i
;

14112 
»t
 = 0;

14126 
	`wr™e_c¤
(
dd
, 
SEND_CTRL
, 0);

14127 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++)

14128 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_CTRL
, 0);

14129 
i
 = 0; i < 
	`ch_sdma_’gšes
(
dd
); i++)

14130 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_CTRL
, 0);

14132 
	`wr™e_c¤
(
dd
, 
RCV_CTRL
, 0);

14133 
i
 = 0; i < 
	`ch_rcv_cÚ‹xts
(
dd
); i++)

14134 
	`wr™e_c¤
(
dd
, 
RCV_CTXT_CTRL
, 0);

14136 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; i++)

14137 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
 + (8 * 
i
), 0ull);

14145 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 
CCE_DC_CTRL_DC_RESET_SMASK
);

14146 ()
	`»ad_c¤
(
dd
, 
CCE_DC_CTRL
);

14148 ià(
u£_ær
) {

14154 
	`dd_dev_šfo
(
dd
, "Resetting CSRs with FLR\n");

14157 
	`pc›_ær
(
dd
->
pcidev
);

14160 
»t
 = 
	`»¡Üe_pci_v¬ŸbËs
(
dd
);

14161 ià(
»t
) {

14162 
	`dd_dev_”r
(
dd
, "%s: Could‚ot„estore PCI variables\n",

14163 
__func__
);

14164  
»t
;

14167 ià(
	`is_ax
(
dd
)) {

14168 
	`dd_dev_šfo
(
dd
, "Resetting CSRs with FLR\n");

14169 
	`pc›_ær
(
dd
->
pcidev
);

14170 
»t
 = 
	`»¡Üe_pci_v¬ŸbËs
(
dd
);

14171 ià(
»t
) {

14172 
	`dd_dev_”r
(
dd
, "%s: Could‚ot„estore PCI variables\n",

14173 
__func__
);

14174  
»t
;

14178 
	`dd_dev_šfo
(
dd
, "Resetting CSRs with writes\n");

14179 
	`»£t_cû_c¤s
(
dd
);

14180 
	`»£t_txe_c¤s
(
dd
);

14181 
	`»£t_rxe_c¤s
(
dd
);

14182 
	`»£t_misc_c¤s
(
dd
);

14185 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 0);

14188 
	`£‹xŽed
(
dd
, 0);

14200 
	`wr™e_c¤
(
dd
, 
ASIC_QSFP1_OUT
, 0x1f);

14201 
	`wr™e_c¤
(
dd
, 
ASIC_QSFP2_OUT
, 0x1f);

14202 
	`š™_ch_»sourûs
(
dd
);

14203  
»t
;

14204 
	}
}

14206 
	$š™_—¾y_v¬ŸbËs
(
hfi1_devd©a
 *
dd
)

14208 
i
;

14211 
dd
->
vau
 = 
CM_VAU
;

14212 
dd
->
lšk_üed™s
 = 
CM_GLOBAL_CREDITS
;

14213 ià(
	`is_ax
(
dd
))

14214 
dd
->
lšk_üed™s
--;

14215 
dd
->
vcu
 = 
	`cu_to_vcu
(
hfi1_cu
);

14217 
dd
->
vl15_š™
 = (8 * (2048 + 128)è/ 
	`vau_to_au
(dd->
vau
);

14218 ià(
dd
->
vl15_š™
 > dd->
lšk_üed™s
)

14219 
dd
->
vl15_š™
 = dd->
lšk_üed™s
;

14221 
	`wr™e_unš™Ÿlized_c¤s_ªd_memÜ›s
(
dd
);

14223 ià(
	`HFI1_CAP_IS_KSET
(
PKEY_CHECK
))

14224 
i
 = 0; i < 
dd
->
num_µÜts
; i++) {

14225 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[
i
];

14227 
	`£t_·¹™iÚ_keys
(
µd
);

14229 
	`š™_sc2vl_bËs
(
dd
);

14230 
	}
}

14232 
	$š™_kd‘h_qp
(
hfi1_devd©a
 *
dd
)

14234 
	`wr™e_c¤
(
dd
, 
SEND_BTH_QP
,

14235 (
RVT_KDETH_QP_PREFIX
 & 
SEND_BTH_QP_KDETH_QP_MASK
) <<

14236 
SEND_BTH_QP_KDETH_QP_SHIFT
);

14238 
	`wr™e_c¤
(
dd
, 
RCV_BTH_QP
,

14239 (
RVT_KDETH_QP_PREFIX
 & 
RCV_BTH_QP_KDETH_QP_MASK
) <<

14240 
RCV_BTH_QP_KDETH_QP_SHIFT
);

14241 
	}
}

14248 
u8
 
	$hfi1_g‘_qp_m­
(
hfi1_devd©a
 *
dd
, 
u8
 
idx
)

14250 
u64
 
»g
 = 
	`»ad_c¤
(
dd
, 
RCV_QP_MAP_TABLE
 + (
idx
 / 8) * 8);

14252 
»g
 >>ð(
idx
 % 8) * 8;

14253  
»g
;

14254 
	}
}

14273 
	$š™_qpm­_bË
(
hfi1_devd©a
 *
dd
,

14274 
u32
 
fœ¡_ùxt
,

14275 
u32
 
Ï¡_ùxt
)

14277 
u64
 
»g
 = 0;

14278 
u64
 
»gno
 = 
RCV_QP_MAP_TABLE
;

14279 
i
;

14280 
u64
 
ùxt
 = 
fœ¡_ùxt
;

14282 
i
 = 0; i < 256; i++) {

14283 
»g
 |ð
ùxt
 << (8 * (
i
 % 8));

14284 
ùxt
++;

14285 ià(
ùxt
 > 
Ï¡_ùxt
)

14286 
ùxt
 = 
fœ¡_ùxt
;

14287 ià(
i
 % 8 == 7) {

14288 
	`wr™e_c¤
(
dd
, 
»gno
, 
»g
);

14289 
»g
 = 0;

14290 
»gno
 += 8;

14294 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_QP_MAP_ENABLE_SMASK


14295 | 
RCV_CTRL_RCV_BYPASS_ENABLE_SMASK
);

14296 
	}
}

14298 
	srsm_m­_bË
 {

14299 
u64
 
	mm­
[
NUM_MAP_REGS
];

14300 
	mu£d
;

14303 
	srsm_ruË_d©a
 {

14304 
u8
 
	moff£t
;

14305 
u8
 
	mpkt_ty³
;

14306 
u32
 
	mf›ld1_off
;

14307 
u32
 
	mf›ld2_off
;

14308 
u32
 
	mšdex1_off
;

14309 
u32
 
	mšdex1_width
;

14310 
u32
 
	mšdex2_off
;

14311 
u32
 
	mšdex2_width
;

14312 
u32
 
	mmask1
;

14313 
u32
 
	mv®ue1
;

14314 
u32
 
	mmask2
;

14315 
u32
 
	mv®ue2
;

14322 
rsm_m­_bË
 *
	$®loc_rsm_m­_bË
(
hfi1_devd©a
 *
dd
)

14324 
rsm_m­_bË
 *
rmt
;

14325 
u8
 
rxcÚ‹xt
 = 
	`is_ax
(
dd
) ? 0 : 0xff;

14327 
rmt
 = 
	`km®loc
((*rmt), 
GFP_KERNEL
);

14328 ià(
rmt
) {

14329 
	`mem£t
(
rmt
->
m­
, 
rxcÚ‹xt
, (rmt->map));

14330 
rmt
->
u£d
 = 0;

14333  
rmt
;

14334 
	}
}

14340 
	$com¶‘e_rsm_m­_bË
(
hfi1_devd©a
 *
dd
,

14341 
rsm_m­_bË
 *
rmt
)

14343 
i
;

14345 ià(
rmt
) {

14347 
i
 = 0; i < 
NUM_MAP_REGS
; i++)

14348 
	`wr™e_c¤
(
dd
, 
RCV_RSM_MAP_TABLE
 + (8 * 
i
), 
rmt
->
m­
[i]);

14351 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_RSM_ENABLE_SMASK
);

14353 
	}
}

14359 
boÞ
 
	$has_rsm_ruË
(
hfi1_devd©a
 *
dd
, 
u8
 
ruË_šdex
)

14361  
	`»ad_c¤
(
dd
, 
RCV_RSM_CFG
 + (8 * 
ruË_šdex
)) != 0;

14362 
	}
}

14367 
	$add_rsm_ruË
(
hfi1_devd©a
 *
dd
, 
u8
 
ruË_šdex
,

14368 
rsm_ruË_d©a
 *
¼d
)

14370 
	`wr™e_c¤
(
dd
, 
RCV_RSM_CFG
 + (8 * 
ruË_šdex
),

14371 (
u64
)
¼d
->
off£t
 << 
RCV_RSM_CFG_OFFSET_SHIFT
 |

14372 1uÎ << 
ruË_šdex
 |

14373 (
u64
)
¼d
->
pkt_ty³
 << 
RCV_RSM_CFG_PACKET_TYPE_SHIFT
);

14374 
	`wr™e_c¤
(
dd
, 
RCV_RSM_SELECT
 + (8 * 
ruË_šdex
),

14375 (
u64
)
¼d
->
f›ld1_off
 << 
RCV_RSM_SELECT_FIELD1_OFFSET_SHIFT
 |

14376 (
u64
)
¼d
->
f›ld2_off
 << 
RCV_RSM_SELECT_FIELD2_OFFSET_SHIFT
 |

14377 (
u64
)
¼d
->
šdex1_off
 << 
RCV_RSM_SELECT_INDEX1_OFFSET_SHIFT
 |

14378 (
u64
)
¼d
->
šdex1_width
 << 
RCV_RSM_SELECT_INDEX1_WIDTH_SHIFT
 |

14379 (
u64
)
¼d
->
šdex2_off
 << 
RCV_RSM_SELECT_INDEX2_OFFSET_SHIFT
 |

14380 (
u64
)
¼d
->
šdex2_width
 << 
RCV_RSM_SELECT_INDEX2_WIDTH_SHIFT
);

14381 
	`wr™e_c¤
(
dd
, 
RCV_RSM_MATCH
 + (8 * 
ruË_šdex
),

14382 (
u64
)
¼d
->
mask1
 << 
RCV_RSM_MATCH_MASK1_SHIFT
 |

14383 (
u64
)
¼d
->
v®ue1
 << 
RCV_RSM_MATCH_VALUE1_SHIFT
 |

14384 (
u64
)
¼d
->
mask2
 << 
RCV_RSM_MATCH_MASK2_SHIFT
 |

14385 (
u64
)
¼d
->
v®ue2
 << 
RCV_RSM_MATCH_VALUE2_SHIFT
);

14386 
	}
}

14391 
	$þ—r_rsm_ruË
(
hfi1_devd©a
 *
dd
, 
u8
 
ruË_šdex
)

14393 
	`wr™e_c¤
(
dd
, 
RCV_RSM_CFG
 + (8 * 
ruË_šdex
), 0);

14394 
	`wr™e_c¤
(
dd
, 
RCV_RSM_SELECT
 + (8 * 
ruË_šdex
), 0);

14395 
	`wr™e_c¤
(
dd
, 
RCV_RSM_MATCH
 + (8 * 
ruË_šdex
), 0);

14396 
	}
}

14399 
	$qos_rmt_’Œ›s
(
hfi1_devd©a
 *
dd
, *
mp
,

14400 *
Å
)

14402 
i
;

14403 
m
, 
n
;

14404 
u8
 
max_by_vl
 = 0;

14407 ià(
dd
->
n_krcv_queues
 <ð
MIN_KERNEL_KCTXTS
 ||

14408 
num_vls
 == 1 ||

14409 
krcvqs£t
 <= 1)

14410 
no_qos
;

14413 
i
 = 0; i < 
	`mš_t
(, 
num_vls
, 
krcvqs£t
); i++)

14414 ià(
krcvqs
[
i
] > 
max_by_vl
)

14415 
max_by_vl
 = 
krcvqs
[
i
];

14416 ià(
max_by_vl
 > 32)

14417 
no_qos
;

14418 
m
 = 
	`žog2
(
	`__roundup_pow_of_two
(
max_by_vl
));

14421 
n
 = 
	`žog2
(
	`__roundup_pow_of_two
(
num_vls
));

14424 ià((
m
 + 
n
) > 7)

14425 
no_qos
;

14427 ià(
mp
)

14428 *
mp
 = 
m
;

14429 ià(
Å
)

14430 *
Å
 = 
n
;

14432  1 << (
m
 + 
n
);

14434 
no_qos
:

14435 ià(
mp
)

14436 *
mp
 = 0;

14437 ià(
Å
)

14438 *
Å
 = 0;

14440 
	}
}

14456 
	$š™_qos
(
hfi1_devd©a
 *
dd
, 
rsm_m­_bË
 *
rmt
)

14458 
rsm_ruË_d©a
 
¼d
;

14459 
q²s_³r_vl
, 
ùxt
, 
i
, 
q²
, 
n
 = 1, 
m
;

14460 
rmt_’Œ›s
;

14461 
u64
 
»g
;

14463 ià(!
rmt
)

14464 
baž
;

14465 
rmt_’Œ›s
 = 
	`qos_rmt_’Œ›s
(
dd
, &
m
, &
n
);

14466 ià(
rmt_’Œ›s
 == 0)

14467 
baž
;

14468 
q²s_³r_vl
 = 1 << 
m
;

14471 
rmt_’Œ›s
 = 1 << (
m
 + 
n
);

14472 ià(
rmt
->
u£d
 + 
rmt_’Œ›s
 >ð
NUM_MAP_ENTRIES
)

14473 
baž
;

14476 
i
 = 0, 
ùxt
 = 
FIRST_KERNEL_KCTXT
; i < 
num_vls
; i++) {

14477 
tùxt
;

14479 
q²
 = 0, 
tùxt
 = 
ùxt
;

14480 
krcvqs
[
i
] && 
q²
 < 
q²s_³r_vl
; qpn++) {

14481 
idx
, 
»goff
, 
»gidx
;

14484 
idx
 = 
rmt
->
u£d
 + ((
q²
 << 
n
è^ 
i
);

14485 
»goff
 = (
idx
 % 8) * 8;

14486 
»gidx
 = 
idx
 / 8;

14488 
»g
 = 
rmt
->
m­
[
»gidx
];

14489 
»g
 &ð~(
RCV_RSM_MAP_TABLE_RCV_CONTEXT_A_MASK


14490 << 
»goff
);

14491 
»g
 |ð(
u64
)(
tùxt
++è<< 
»goff
;

14492 
rmt
->
m­
[
»gidx
] = 
»g
;

14493 ià(
tùxt
 =ð
ùxt
 + 
krcvqs
[
i
])

14494 
tùxt
 = 
ùxt
;

14496 
ùxt
 +ð
krcvqs
[
i
];

14499 
¼d
.
off£t
 = 
rmt
->
u£d
;

14500 
¼d
.
pkt_ty³
 = 2;

14501 
¼d
.
f›ld1_off
 = 
LRH_BTH_MATCH_OFFSET
;

14502 
¼d
.
f›ld2_off
 = 
LRH_SC_MATCH_OFFSET
;

14503 
¼d
.
šdex1_off
 = 
LRH_SC_SELECT_OFFSET
;

14504 
¼d
.
šdex1_width
 = 
n
;

14505 
¼d
.
šdex2_off
 = 
QPN_SELECT_OFFSET
;

14506 
¼d
.
šdex2_width
 = 
m
 + 
n
;

14507 
¼d
.
mask1
 = 
LRH_BTH_MASK
;

14508 
¼d
.
v®ue1
 = 
LRH_BTH_VALUE
;

14509 
¼d
.
mask2
 = 
LRH_SC_MASK
;

14510 
¼d
.
v®ue2
 = 
LRH_SC_VALUE
;

14513 
	`add_rsm_ruË
(
dd
, 
RSM_INS_VERBS
, &
¼d
);

14516 
rmt
->
u£d
 +ð
rmt_’Œ›s
;

14518 
	`š™_qpm­_bË
(
dd
, 
HFI1_CTRL_CTXT
, HFI1_CTRL_CTXT);

14519 
dd
->
qos_shiá
 = 
n
 + 1;

14521 
baž
:

14522 
dd
->
qos_shiá
 = 1;

14523 
	`š™_qpm­_bË
(
dd
, 
FIRST_KERNEL_KCTXT
, dd->
n_krcv_queues
 - 1);

14524 
	}
}

14526 
	$š™_ãú_hªdlšg
(
hfi1_devd©a
 *
dd
,

14527 
rsm_m­_bË
 *
rmt
)

14529 
rsm_ruË_d©a
 
¼d
;

14530 
u64
 
»g
;

14531 
i
, 
idx
, 
»goff
, 
»gidx
, 
¡¬t
;

14532 
u8
 
off£t
;

14533 
u32
 
tÙ®_út
;

14535 ià(
	`HFI1_CAP_IS_KSET
(
TID_RDMA
))

14537 
¡¬t
 = 1;

14539 
¡¬t
 = 
dd
->
fœ¡_dyn_®loc_ùxt
;

14541 
tÙ®_út
 = 
dd
->
num_rcv_cÚ‹xts
 - 
¡¬t
;

14544 ià(
rmt
->
u£d
 + 
tÙ®_út
 >ð
NUM_MAP_ENTRIES
) {

14545 
	`dd_dev_”r
(
dd
, "FECN handling disabled -oo many contexts‡llocated\n");

14559 
off£t
 = (
u8
)(
NUM_MAP_ENTRIES
 + 
rmt
->
u£d
 - 
¡¬t
);

14561 
i
 = 
¡¬t
, 
idx
 = 
rmt
->
u£d
; i < 
dd
->
num_rcv_cÚ‹xts
;

14562 
i
++, 
idx
++) {

14564 
»goff
 = (
idx
 % 8) * 8;

14565 
»gidx
 = 
idx
 / 8;

14566 
»g
 = 
rmt
->
m­
[
»gidx
];

14567 
»g
 &ð~(
RCV_RSM_MAP_TABLE_RCV_CONTEXT_A_MASK
 << 
»goff
);

14568 
»g
 |ð(
u64
)
i
 << 
»goff
;

14569 
rmt
->
m­
[
»gidx
] = 
»g
;

14581 
¼d
.
off£t
 = offset;

14582 
¼d
.
pkt_ty³
 = 0;

14583 
¼d
.
f›ld1_off
 = 95;

14584 
¼d
.
f›ld2_off
 = 133;

14585 
¼d
.
šdex1_off
 = 64;

14586 
¼d
.
šdex1_width
 = 8;

14587 
¼d
.
šdex2_off
 = 0;

14588 
¼d
.
šdex2_width
 = 0;

14589 
¼d
.
mask1
 = 1;

14590 
¼d
.
v®ue1
 = 1;

14591 
¼d
.
mask2
 = 1;

14592 
¼d
.
v®ue2
 = 1;

14595 
	`add_rsm_ruË
(
dd
, 
RSM_INS_FECN
, &
¼d
);

14597 
rmt
->
u£d
 +ð
tÙ®_út
;

14598 
	}
}

14600 
šlše
 
boÞ
 
	$hfi1_is_rmt_fuÎ
(
¡¬t
, 
¥¬e
)

14602  (
¡¬t
 + 
¥¬e
è> 
NUM_MAP_ENTRIES
;

14603 
	}
}

14605 
boÞ
 
	$hfi1_Ãtdev_upd©e_rmt
(
hfi1_devd©a
 *
dd
)

14607 
u8
 
i
, 
j
;

14608 
u8
 
ùx_id
 = 0;

14609 
u64
 
»g
;

14610 
u32
 
»goff
;

14611 
rmt_¡¬t
 = 
	`hfi1_Ãtdev_g‘_ä“_rmt_idx
(
dd
);

14612 
ùxt_couÁ
 = 
	`hfi1_Ãtdev_ùxt_couÁ
(
dd
);

14615 ià(
	`has_rsm_ruË
(
dd
, 
RSM_INS_VNIC
è|| has_rsm_ruË(dd, 
RSM_INS_AIP
)) {

14616 
	`dd_dev_šfo
(
dd
, "Contexts‡re‡lready mapped in RMT\n");

14617  
Œue
;

14620 ià(
	`hfi1_is_rmt_fuÎ
(
rmt_¡¬t
, 
NUM_NETDEV_MAP_ENTRIES
)) {

14621 
	`dd_dev_”r
(
dd
, "Notƒnought RMTƒntries used = %d\n",

14622 
rmt_¡¬t
);

14623  
çl£
;

14626 
	`dev_dbg
(&(
dd
)->
pcidev
->
dev
, "RMT start = %d,ƒnd %d\n",

14627 
rmt_¡¬t
,

14628 
rmt_¡¬t
 + 
NUM_NETDEV_MAP_ENTRIES
);

14631 
»goff
 = 
RCV_RSM_MAP_TABLE
 + (
rmt_¡¬t
 / 8) * 8;

14632 
»g
 = 
	`»ad_c¤
(
dd
, 
»goff
);

14633 
i
 = 0; i < 
NUM_NETDEV_MAP_ENTRIES
; i++) {

14635 
j
 = (
rmt_¡¬t
 + 
i
) % 8;

14636 
»g
 &ð~(0xfælu << (
j
 * 8));

14637 
»g
 |ð(
u64
)
	`hfi1_Ãtdev_g‘_ùxt
(
dd
, 
ùx_id
++)->
ùxt
 << (
j
 * 8);

14639 
ùx_id
 %ð
ùxt_couÁ
;

14641 ià(
j
 =ð7 || ((
i
 + 1è=ð
NUM_NETDEV_MAP_ENTRIES
)) {

14642 
	`dev_dbg
(&(
dd
)->
pcidev
->
dev
,

14644 
»goff
 - 
RCV_RSM_MAP_TABLE
, 
»g
);

14646 
	`wr™e_c¤
(
dd
, 
»goff
, 
»g
);

14647 
»goff
 += 8;

14648 ià(
i
 < (
NUM_NETDEV_MAP_ENTRIES
 - 1))

14649 
»g
 = 
	`»ad_c¤
(
dd
, 
»goff
);

14653  
Œue
;

14654 
	}
}

14656 
	$hfi1_’abË_rsm_ruË
(
hfi1_devd©a
 *
dd
,

14657 
ruË
, 
rsm_ruË_d©a
 *
¼d
)

14659 ià(!
	`hfi1_Ãtdev_upd©e_rmt
(
dd
)) {

14660 
	`dd_dev_”r
(
dd
, "FažedØupd©RMT fÜ RSM%d„uË\n", 
ruË
);

14664 
	`add_rsm_ruË
(
dd
, 
ruË
, 
¼d
);

14665 
	`add_rcvù¾
(
dd
, 
RCV_CTRL_RCV_RSM_ENABLE_SMASK
);

14666 
	}
}

14668 
	$hfi1_š™_a_rsm
(
hfi1_devd©a
 *
dd
)

14674 #ifdeà
©omic_ãtch_šc


14675 ià(
	`©omic_ãtch_šc
(&
dd
->
oib_rsm_u¤_num
) == 0) {

14677 ià((
	`©omic_šc_»tuº
(&
dd
->
oib_rsm_u¤_num
) - 1) == 0) {

14679 
rmt_¡¬t
 = 
	`hfi1_Ãtdev_g‘_ä“_rmt_idx
(
dd
);

14680 
rsm_ruË_d©a
 
¼d
 = {

14681 .
off£t
 = 
rmt_¡¬t
,

14682 .
pkt_ty³
 = 
IB_PACKET_TYPE
,

14683 .
f›ld1_off
 = 
LRH_BTH_MATCH_OFFSET
,

14684 .
mask1
 = 
LRH_BTH_MASK
,

14685 .
v®ue1
 = 
LRH_BTH_VALUE
,

14686 .
f›ld2_off
 = 
BTH_DESTQP_MATCH_OFFSET
,

14687 .
mask2
 = 
BTH_DESTQP_MASK
,

14688 .
v®ue2
 = 
BTH_DESTQP_VALUE
,

14689 .
šdex1_off
 = 
DETH_AIP_SQPN_SELECT_OFFSET
 +

14690 
	`žog2
(
NUM_NETDEV_MAP_ENTRIES
),

14691 .
šdex1_width
 = 
	`žog2
(
NUM_NETDEV_MAP_ENTRIES
),

14692 .
šdex2_off
 = 
DETH_AIP_SQPN_SELECT_OFFSET
,

14693 .
šdex2_width
 = 
	`žog2
(
NUM_NETDEV_MAP_ENTRIES
)

14696 
	`hfi1_’abË_rsm_ruË
(
dd
, 
RSM_INS_AIP
, &
¼d
);

14698 
	}
}

14701 
	$hfi1_š™_vnic_rsm
(
hfi1_devd©a
 *
dd
)

14703 
rmt_¡¬t
 = 
	`hfi1_Ãtdev_g‘_ä“_rmt_idx
(
dd
);

14704 
rsm_ruË_d©a
 
¼d
 = {

14706 .
off£t
 = 
rmt_¡¬t
,

14707 .
pkt_ty³
 = 4,

14709 .
f›ld1_off
 = 
L2_TYPE_MATCH_OFFSET
,

14710 .
mask1
 = 
L2_TYPE_MASK
,

14711 .
v®ue1
 = 
L2_16B_VALUE
,

14713 .
f›ld2_off
 = 
L4_TYPE_MATCH_OFFSET
,

14714 .
mask2
 = 
L4_16B_TYPE_MASK
,

14715 .
v®ue2
 = 
L4_16B_ETH_VALUE
,

14717 .
šdex1_off
 = 
L4_16B_HDR_VESWID_OFFSET
,

14718 .
šdex1_width
 = 
	`žog2
(
NUM_NETDEV_MAP_ENTRIES
),

14719 .
šdex2_off
 = 
L2_16B_ENTROPY_OFFSET
,

14720 .
šdex2_width
 = 
	`žog2
(
NUM_NETDEV_MAP_ENTRIES
)

14723 
	`hfi1_’abË_rsm_ruË
(
dd
, 
RSM_INS_VNIC
, &
¼d
);

14724 
	}
}

14726 
	$hfi1_deš™_vnic_rsm
(
hfi1_devd©a
 *
dd
)

14728 
	`þ—r_rsm_ruË
(
dd
, 
RSM_INS_VNIC
);

14729 
	}
}

14731 
	$hfi1_deš™_a_rsm
(
hfi1_devd©a
 *
dd
)

14734 ià(
	`©omic_ãtch_add_uÆess
(&
dd
->
oib_rsm_u¤_num
, -1, 0) == 1)

14735 
	`þ—r_rsm_ruË
(
dd
, 
RSM_INS_AIP
);

14736 
	}
}

14738 
	$š™_rxe
(
hfi1_devd©a
 *
dd
)

14740 
rsm_m­_bË
 *
rmt
;

14741 
u64
 
v®
;

14744 
	`wr™e_c¤
(
dd
, 
RCV_ERR_MASK
, ~0ull);

14746 
rmt
 = 
	`®loc_rsm_m­_bË
(
dd
);

14747 ià(!
rmt
)

14748  -
ENOMEM
;

14751 
	`š™_qos
(
dd
, 
rmt
);

14752 
	`š™_ãú_hªdlšg
(
dd
, 
rmt
);

14753 
	`com¶‘e_rsm_m­_bË
(
dd
, 
rmt
) ;

14755 
	`hfi1_Ãtdev_£t_ä“_rmt_idx
(
dd
, 
rmt
->
u£d
);

14756 
	`kä“
(
rmt
);

14771 
v®
 = 
	`»ad_c¤
(
dd
, 
RCV_BYPASS
);

14772 
v®
 &ð~
RCV_BYPASS_HDR_SIZE_SMASK
;

14773 
v®
 |ð((4uÎ & 
RCV_BYPASS_HDR_SIZE_MASK
) <<

14774 
RCV_BYPASS_HDR_SIZE_SHIFT
);

14775 
	`wr™e_c¤
(
dd
, 
RCV_BYPASS
, 
v®
);

14777 
	}
}

14779 
	$š™_Ùh”
(
hfi1_devd©a
 *
dd
)

14782 
	`wr™e_c¤
(
dd
, 
CCE_ERR_MASK
, ~0ull);

14784 
	`wr™e_c¤
(
dd
, 
MISC_ERR_MASK
, 
DRIVER_MISC_MASK
);

14786 
	`wr™e_c¤
(
dd
, 
DCC_ERR_FLG_EN
, ~0ull);

14787 
	`wr™e_c¤
(
dd
, 
DC_DC8051_ERR_EN
, ~0ull);

14788 
	}
}

14798 
	$assign_cm_au_bË
(
hfi1_devd©a
 *
dd
, 
u32
 
cu
,

14799 
u32
 
c¤0to3
, u32 
c¤4to7
)

14801 
	`wr™e_c¤
(
dd
, 
c¤0to3
,

14802 0uÎ << 
SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE0_SHIFT
 |

14803 1uÎ << 
SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE1_SHIFT
 |

14804 2uÎ * 
cu
 <<

14805 
SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE2_SHIFT
 |

14806 4uÎ * 
cu
 <<

14807 
SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE3_SHIFT
);

14808 
	`wr™e_c¤
(
dd
, 
c¤4to7
,

14809 8uÎ * 
cu
 <<

14810 
SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE4_SHIFT
 |

14811 16uÎ * 
cu
 <<

14812 
SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE5_SHIFT
 |

14813 32uÎ * 
cu
 <<

14814 
SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE6_SHIFT
 |

14815 64uÎ * 
cu
 <<

14816 
SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE7_SHIFT
);

14817 
	}
}

14819 
	$assign_loÿl_cm_au_bË
(
hfi1_devd©a
 *
dd
, 
u8
 
vcu
)

14821 
	`assign_cm_au_bË
(
dd
, 
	`vcu_to_cu
(
vcu
), 
SEND_CM_LOCAL_AU_TABLE0_TO3
,

14822 
SEND_CM_LOCAL_AU_TABLE4_TO7
);

14823 
	}
}

14825 
	$assign_»mÙe_cm_au_bË
(
hfi1_devd©a
 *
dd
, 
u8
 
vcu
)

14827 
	`assign_cm_au_bË
(
dd
, 
	`vcu_to_cu
(
vcu
), 
SEND_CM_REMOTE_AU_TABLE0_TO3
,

14828 
SEND_CM_REMOTE_AU_TABLE4_TO7
);

14829 
	}
}

14831 
	$š™_txe
(
hfi1_devd©a
 *
dd
)

14833 
i
;

14836 
	`wr™e_c¤
(
dd
, 
SEND_PIO_ERR_MASK
, ~0ull);

14837 
	`wr™e_c¤
(
dd
, 
SEND_DMA_ERR_MASK
, ~0ull);

14838 
	`wr™e_c¤
(
dd
, 
SEND_ERR_MASK
, ~0ull);

14839 
	`wr™e_c¤
(
dd
, 
SEND_EGRESS_ERR_MASK
, ~0ull);

14842 
i
 = 0; i < 
	`ch_£nd_cÚ‹xts
(
dd
); i++)

14843 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_CTXT_ERR_MASK
, ~0ull);

14844 
i
 = 0; i < 
	`ch_sdma_’gšes
(
dd
); i++)

14845 
	`wr™e_kùxt_c¤
(
dd
, 
i
, 
SEND_DMA_ENG_ERR_MASK
, ~0ull);

14848 
	`assign_loÿl_cm_au_bË
(
dd
, dd->
vcu
);

14854 ià(
dd
->
icode
 !ð
ICODE_FUNCTIONAL_SIMULATOR
)

14855 
	`wr™e_c¤
(
dd
, 
SEND_CM_TIMER_CTRL
, 
HFI1_CREDIT_RETURN_RATE
);

14856 
	}
}

14858 
	$hfi1_£t_ùxt_jkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
,

14859 
u16
 
jkey
)

14861 
u8
 
hw_ùxt
;

14862 
u64
 
»g
;

14864 ià(!
rcd
 || !rcd->
sc
)

14865  -
EINVAL
;

14867 
hw_ùxt
 = 
rcd
->
sc
->
hw_cÚ‹xt
;

14868 
»g
 = 
SEND_CTXT_CHECK_JOB_KEY_MASK_SMASK
 |

14869 ((
jkey
 & 
SEND_CTXT_CHECK_JOB_KEY_VALUE_MASK
) <<

14870 
SEND_CTXT_CHECK_JOB_KEY_VALUE_SHIFT
);

14877 ià(!
rcd
->
£cur™y
) {

14878 ià(
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
ALLOW_PERM_JKEY
))

14879 
»g
 |ð
SEND_CTXT_CHECK_JOB_KEY_ALLOW_PERMISSIVE_SMASK
;

14882 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_JOB_KEY
, 
»g
);

14886 ià(!
	`is_ax
(
dd
)) {

14887 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
);

14888 
»g
 |ð
SEND_CTXT_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
;

14889 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
, 
»g
);

14893 
»g
 = 
RCV_KEY_CTRL_JOB_KEY_ENABLE_SMASK
 |

14894 ((
jkey
 & 
RCV_KEY_CTRL_JOB_KEY_VALUE_MASK
) <<

14895 
RCV_KEY_CTRL_JOB_KEY_VALUE_SHIFT
);

14896 
	`wr™e_kùxt_c¤
(
dd
, 
rcd
->
ùxt
, 
RCV_KEY_CTRL
, 
»g
);

14899 
	}
}

14901 
	$hfi1_þ—r_ùxt_jkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
)

14903 
u8
 
hw_ùxt
;

14904 
u64
 
»g
;

14906 ià(!
rcd
 || !rcd->
sc
)

14907  -
EINVAL
;

14909 
hw_ùxt
 = 
rcd
->
sc
->
hw_cÚ‹xt
;

14910 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_JOB_KEY
, 0);

14916 ià(!
	`is_ax
(
dd
)) {

14917 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
);

14918 
»g
 &ð~
SEND_CTXT_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
;

14919 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
, 
»g
);

14922 
	`wr™e_kùxt_c¤
(
dd
, 
rcd
->
ùxt
, 
RCV_KEY_CTRL
, 0);

14925 
	}
}

14927 
	$hfi1_£t_ùxt_pkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
,

14928 
u16
 
pkey
)

14930 
u8
 
hw_ùxt
;

14931 
u64
 
»g
;

14933 ià(!
rcd
 || !rcd->
sc
)

14934  -
EINVAL
;

14936 
hw_ùxt
 = 
rcd
->
sc
->
hw_cÚ‹xt
;

14937 
»g
 = ((
u64
)
pkey
 & 
SEND_CTXT_CHECK_PARTITION_KEY_VALUE_MASK
) <<

14938 
SEND_CTXT_CHECK_PARTITION_KEY_VALUE_SHIFT
;

14939 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_PARTITION_KEY
, 
»g
);

14940 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
);

14941 
»g
 |ð
SEND_CTXT_CHECK_ENABLE_CHECK_PARTITION_KEY_SMASK
;

14942 
»g
 &ð~
SEND_CTXT_CHECK_ENABLE_DISALLOW_KDETH_PACKETS_SMASK
;

14943 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
, 
»g
);

14946 
	}
}

14948 
	$hfi1_þ—r_ùxt_pkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
ùxt
)

14950 
u8
 
hw_ùxt
;

14951 
u64
 
»g
;

14953 ià(!
ùxt
 || !ùxt->
sc
)

14954  -
EINVAL
;

14956 
hw_ùxt
 = 
ùxt
->
sc
->
hw_cÚ‹xt
;

14957 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
);

14958 
»g
 &ð~
SEND_CTXT_CHECK_ENABLE_CHECK_PARTITION_KEY_SMASK
;

14959 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_ENABLE
, 
»g
);

14960 
	`wr™e_kùxt_c¤
(
dd
, 
hw_ùxt
, 
SEND_CTXT_CHECK_PARTITION_KEY
, 0);

14963 
	}
}

14969 
	$hfi1_¡¬t_þ—nup
(
hfi1_devd©a
 *
dd
)

14971 
	`a¥m_ex™
(
dd
);

14972 
	`ä“_úŒs
(
dd
);

14973 
	`ä“_rcv”r
(
dd
);

14974 
	`fšish_ch_»sourûs
(
dd
);

14975 
	}
}

14977 
	#HFI_BASE_GUID
(
dev
) \

14978 ((
dev
)->
ba£_guid
 & ~(1ULL << 
GUID_HFI_INDEX_SHIFT
))

	)

14985 
	$š™_asic_d©a
(
hfi1_devd©a
 *
dd
)

14987 
æags
;

14988 
hfi1_devd©a
 *
tmp
, *
³”
 = 
NULL
;

14989 
hfi1_asic_d©a
 *
asic_d©a
;

14990 
»t
 = 0;

14993 
asic_d©a
 = 
	`kz®loc
((*
dd
->asic_d©a), 
GFP_KERNEL
);

14994 ià(!
asic_d©a
)

14995  -
ENOMEM
;

14997 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

14999 
	`li¡_fÜ_—ch_’Œy
(
tmp
, &
hfi1_dev_li¡
, 
li¡
) {

15000 ià((
	`HFI_BASE_GUID
(
dd
è=ðHFI_BASE_GUID(
tmp
)) &&

15001 
dd
->
un™
 !ð
tmp
->unit) {

15002 
³”
 = 
tmp
;

15007 ià(
³”
) {

15009 
dd
->
asic_d©a
 = 
³”
->asic_data;

15010 
	`kä“
(
asic_d©a
);

15012 
dd
->
asic_d©a
 =‡sic_data;

15013 
	`mu‹x_š™
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

15015 
dd
->
asic_d©a
->
dds
[dd->
hfi1_id
] = dd;

15016 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

15019 ià(!
³”
)

15020 
»t
 = 
	`£t_up_i2c
(
dd
, dd->
asic_d©a
);

15022  
»t
;

15023 
	}
}

15031 
	$obš_bßrdÇme
(
hfi1_devd©a
 *
dd
)

15034 cÚ¡ 
g’”ic
[] =

15036 
size
;

15037 
»t
;

15039 
»t
 = 
	`»ad_hfi1_efi_v¬
(
dd
, "desütiÚ", &
size
,

15040 (**)&
dd
->
bßrdÇme
);

15041 ià(
»t
) {

15042 
	`dd_dev_šfo
(
dd
, "Board description‚ot found\n");

15044 
dd
->
bßrdÇme
 = 
	`k¡rdup
(
g’”ic
, 
GFP_KERNEL
);

15045 ià(!
dd
->
bßrdÇme
)

15046  -
ENOMEM
;

15049 
	}
}

15059 
	$check_št_»gi¡”s
(
hfi1_devd©a
 *
dd
)

15061 
u64
 
»g
;

15062 
u64
 
®l_b™s
 = ~(u64)0;

15063 
u64
 
mask
;

15066 
mask
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_MASK
);

15067 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
, 0ull);

15068 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_MASK
);

15069 ià(
»g
)

15070 
”r_ex™
;

15073 
	`wr™e_c¤
(
dd
, 
CCE_INT_CLEAR
, 
®l_b™s
);

15074 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_STATUS
);

15075 ià(
»g
)

15076 
”r_ex™
;

15079 
	`wr™e_c¤
(
dd
, 
CCE_INT_FORCE
, 
®l_b™s
);

15080 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_INT_STATUS
);

15081 ià(
»g
 !ð
®l_b™s
)

15082 
”r_ex™
;

15085 
	`wr™e_c¤
(
dd
, 
CCE_INT_CLEAR
, 
®l_b™s
);

15086 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
, 
mask
);

15089 
”r_ex™
:

15090 
	`wr™e_c¤
(
dd
, 
CCE_INT_MASK
, 
mask
);

15091 
	`dd_dev_”r
(
dd
, "Interrupt„egisters‚ot…roperly mapped by VMM\n");

15092  -
EINVAL
;

15093 
	}
}

15103 
	$hfi1_š™_dd
(
hfi1_devd©a
 *
dd
)

15105 
pci_dev
 *
pdev
 = 
dd
->
pcidev
;

15106 
hfi1_µÜtd©a
 *
µd
;

15107 
u64
 
»g
;

15108 
i
, 
»t
;

15109 cÚ¡ * cÚ¡ 
šames
[] = {

15115 
pci_dev
 *
·»Á
 = 
pdev
->
bus
->
£lf
;

15116 
u32
 
sdma_’gšes
 = 
	`ch_sdma_’gšes
(
dd
);

15118 
µd
 = 
dd
->
µÜt
;

15119 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

15120 
vl
;

15122 
»t
 = 
	`hfi1_š™_µÜtd©a
(
pdev
, 
µd
, 
dd
, 0, 1);

15123 ià(
»t
)

15124 
baž_ä“
;

15126 
µd
->
lšk_width_suµÜ‹d
 =

15127 
OPA_LINK_WIDTH_1X
 | 
OPA_LINK_WIDTH_2X
 |

15128 
OPA_LINK_WIDTH_3X
 | 
OPA_LINK_WIDTH_4X
;

15129 
µd
->
lšk_width_downg¿de_suµÜ‹d
 =

15130 
µd
->
lšk_width_suµÜ‹d
;

15132 
µd
->
lšk_width_’abËd
 = 
OPA_LINK_WIDTH_4X
;

15133 
µd
->
lšk_width_downg¿de_’abËd
 =

15134 
µd
->
lšk_width_downg¿de_suµÜ‹d
;

15138 ià(
num_vls
 < 
HFI1_MIN_VLS_SUPPORTED
 ||

15139 
num_vls
 > 
HFI1_MAX_VLS_SUPPORTED
) {

15140 
	`dd_dev_”r
(
dd
, "Invalid‚um_vls %u, using %u VLs\n",

15141 
num_vls
, 
HFI1_MAX_VLS_SUPPORTED
);

15142 
num_vls
 = 
HFI1_MAX_VLS_SUPPORTED
;

15144 
µd
->
vls_suµÜ‹d
 = 
num_vls
;

15145 
µd
->
vls_Ý”©iÚ®
 =…pd->
vls_suµÜ‹d
;

15147 
vl
 = 0; vÈ< 
num_vls
; vl++)

15148 
dd
->
vld
[
vl
].
mtu
 = 
hfi1_max_mtu
;

15149 
dd
->
vld
[15].
mtu
 = 
MAX_MAD_PACKET
;

15154 
µd
->
ov”run_th»shÞd
 = 0x4;

15155 
µd
->
phy_”rÜ_th»shÞd
 = 0xf;

15156 
µd
->
pÜt_üc_mode_’abËd
 = 
lšk_üc_mask
;

15158 
µd
->
pÜt_Ép_üc_mode
 = 
	`ÿp_to_pÜt_Ép
(
lšk_üc_mask
) << 8;

15160 
µd
->
pÜt_Ép_üc_mode
 |ð
	`ÿp_to_pÜt_Ép
(
lšk_üc_mask
) << 4;

15162 
µd
->
ho¡_lšk_¡©e
 = 
HLS_DN_OFFLINE
;

15163 
	`š™_vl_¬b_ÿches
(
µd
);

15171 
»t
 = 
	`hfi1_pc›_ddš™
(
dd
, 
pdev
);

15172 ià(
»t
 < 0)

15173 
baž_ä“
;

15176 
»t
 = 
	`§ve_pci_v¬ŸbËs
(
dd
);

15177 ià(
»t
 < 0)

15178 
baž_þ—nup
;

15180 
dd
->
maj»v
 = (dd->
»visiÚ
 >> 
CCE_REVISION_CHIP_REV_MAJOR_SHIFT
)

15181 & 
CCE_REVISION_CHIP_REV_MAJOR_MASK
;

15182 
dd
->
mš»v
 = (dd->
»visiÚ
 >> 
CCE_REVISION_CHIP_REV_MINOR_SHIFT
)

15183 & 
CCE_REVISION_CHIP_REV_MINOR_MASK
;

15190 ià(!
·»Á
) {

15191 
»t
 = 
	`check_št_»gi¡”s
(
dd
);

15192 ià(
»t
)

15193 
baž_þ—nup
;

15200 
»g
 = 
	`»ad_c¤
(
dd
, 
CCE_REVISION2
);

15201 
dd
->
hfi1_id
 = (
»g
 >> 
CCE_REVISION2_HFI_ID_SHIFT
)

15202 & 
CCE_REVISION2_HFI_ID_MASK
;

15204 
dd
->
icode
 = 
»g
 >> 
CCE_REVISION2_IMPL_CODE_SHIFT
;

15205 
dd
->
œev
 = 
»g
 >> 
CCE_REVISION2_IMPL_REVISION_SHIFT
;

15206 
	`dd_dev_šfo
(
dd
, "Implementation: %s,„evision 0x%x\n",

15207 
dd
->
icode
 < 
	`ARRAY_SIZE
(
šames
) ?

15208 
šames
[
dd
->
icode
] : "unknown", ()dd->
œev
);

15211 
dd
->
µÜt
->
lšk_¥“d_suµÜ‹d
 = 
OPA_LINK_SPEED_25G
;

15213 
dd
->
µÜt
->
lšk_¥“d_’abËd
 = dd->µÜt->
lšk_¥“d_suµÜ‹d
;

15215 
dd
->
µÜt
->
lšk_¥“d_aùive
 = 
OPA_LINK_SPEED_25G
;

15218 
µd
 = 
dd
->
µÜt
;

15219 ià(
dd
->
icode
 =ð
ICODE_FPGA_EMULATION
 && 
	`is_emuÏtÜ_p
(dd)) {

15220 
µd
->
lšk_width_suµÜ‹d
 =

15221 
µd
->
lšk_width_’abËd
 =

15222 
µd
->
lšk_width_downg¿de_suµÜ‹d
 =

15223 
µd
->
lšk_width_downg¿de_’abËd
 =

15224 
OPA_LINK_WIDTH_1X
;

15227 ià(
	`HFI1_CAP_IS_KSET
(
SDMA
è&& 
num_vls
 > 
sdma_’gšes
) {

15228 
	`dd_dev_”r
(
dd
, "num_vls %uoo†arge, using %u VLs\n",

15229 
num_vls
, 
sdma_’gšes
);

15230 
num_vls
 = 
sdma_’gšes
;

15231 
µd
->
vls_suµÜ‹d
 = 
sdma_’gšes
;

15232 
µd
->
vls_Ý”©iÚ®
 =…pd->
vls_suµÜ‹d
;

15243 
dd
->
rcv_šŒ_timeout_c¤
 = 
	`ns_to_cþock
(dd, 
rcv_šŒ_timeout
) / 64;

15244 ià(
dd
->
rcv_šŒ_timeout_c¤
 >

15245 
RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_MASK
)

15246 
dd
->
rcv_šŒ_timeout_c¤
 =

15247 
RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_MASK
;

15248 ià(
dd
->
rcv_šŒ_timeout_c¤
 =ð0 && 
rcv_šŒ_timeout
)

15249 
dd
->
rcv_šŒ_timeout_c¤
 = 1;

15252 
	`»ad_guid
(
dd
);

15255 
»t
 = 
	`š™_asic_d©a
(
dd
);

15256 ià(
»t
)

15257 
baž_þ—nup
;

15260 
»t
 = 
	`š™_ch
(
dd
);

15261 ià(
»t
)

15262 
baž_þ—nup
;

15265 
»t
 = 
	`pc›_¥“ds
(
dd
);

15266 ià(
»t
)

15267 
baž_þ—nup
;

15270 
»t
 = 
	`•rom_š™
(
dd
);

15271 ià(
»t
)

15272 
baž_ä“_rcv”r
;

15275 
	`g‘_¶©fÜm_cÚfig
(
dd
);

15278 
»t
 = 
	`hfi1_fœmw¬e_š™
(
dd
);

15279 ià(
»t
)

15280 
baž_þ—nup
;

15294 
»t
 = 
	`do_pc›_g’3_Œªs™iÚ
(
dd
);

15295 ià(
»t
)

15296 
baž_þ—nup
;

15302 
	`tuÃ_pc›_ÿps
(
dd
);

15305 
	`š™_—¾y_v¬ŸbËs
(
dd
);

15307 
	`·r£_¶©fÜm_cÚfig
(
dd
);

15309 
»t
 = 
	`obš_bßrdÇme
(
dd
);

15310 ià(
»t
)

15311 
baž_þ—nup
;

15313 
	`¢´štf
(
dd
->
bßrdv”siÚ
, 
BOARD_VERS_MAX
,

15315 
HFI1_CHIP_VERS_MAJ
, 
HFI1_CHIP_VERS_MIN
,

15316 (
u32
)
dd
->
maj»v
,

15317 (
u32
)
dd
->
mš»v
,

15318 (
dd
->
»visiÚ
 >> 
CCE_REVISION_SW_SHIFT
)

15319 & 
CCE_REVISION_SW_MASK
);

15322 ià(
	`hfi1_Ãtdev_®loc
(
dd
))

15323 
baž_þ—nup
;

15324 
»t
 = 
	`£t_up_cÚ‹xt_v¬ŸbËs
(
dd
);

15325 ià(
»t
)

15326 
baž_þ—nup
;

15329 
»t
 = 
	`š™_rxe
(
dd
);

15330 ià(
»t
)

15331 
baž_þ—nup
;

15334 
	`š™_txe
(
dd
);

15336 
	`š™_Ùh”
(
dd
);

15338 
	`š™_kd‘h_qp
(
dd
);

15340 
»t
 = 
	`hfi1_dev_affš™y_š™
(
dd
);

15341 ià(
»t
)

15342 
baž_þ—nup
;

15345 
»t
 = 
	`š™_£nd_cÚ‹xts
(
dd
);

15346 ià(
»t
)

15347 
baž_þ—nup
;

15349 
»t
 = 
	`hfi1_ü—‹_kùxts
(
dd
);

15350 ià(
»t
)

15351 
baž_þ—nup
;

15357 
	`a¥m_š™
(
dd
);

15359 
»t
 = 
	`š™_³rvl_scs
(
dd
);

15360 ià(
»t
)

15361 
baž_þ—nup
;

15364 
i
 = 0; i < 
dd
->
num_µÜts
; ++i) {

15365 
»t
 = 
	`sdma_š™
(
dd
, 
i
);

15366 ià(
»t
)

15367 
baž_þ—nup
;

15371 
»t
 = 
	`£t_up_š‹¼u±s
(
dd
);

15372 ià(
»t
)

15373 
baž_þ—nup
;

15375 
»t
 = 
	`hfi1_comp_veùÜs_£t_up
(
dd
);

15376 ià(
»t
)

15377 
baž_þ—r_šŒ
;

15380 
	`š™_lcb_acûss
(
dd
);

15387 
	`¢´štf
(
dd
->
£rŸl
, 
SERIAL_MAX
, "0x%08llx\n",

15388 (
dd
->
ba£_guid
 & 0xFFFFFF) |

15389 ((
dd
->
ba£_guid
 >> 11) & 0xF000000));

15391 
dd
->
oui1
 = dd->
ba£_guid
 >> 56 & 0xFF;

15392 
dd
->
oui2
 = dd->
ba£_guid
 >> 48 & 0xFF;

15393 
dd
->
oui3
 = dd->
ba£_guid
 >> 40 & 0xFF;

15395 
»t
 = 
	`lßd_fœmw¬e
(
dd
);

15396 ià(
»t
)

15397 
baž_þ—r_šŒ
;

15399 
	`th”m®_š™
(
dd
);

15401 
»t
 = 
	`š™_úŒs
(
dd
);

15402 ià(
»t
)

15403 
baž_þ—r_šŒ
;

15405 
»t
 = 
	`š™_rcv”r
(
dd
);

15406 ià(
»t
)

15407 
baž_ä“_úŒs
;

15409 
	`š™_com¶‘iÚ
(&
dd
->
u£r_comp
);

15412 
	`©omic_£t
(&
dd
->
u£r_»fcouÁ
, 1);

15414 
baž
;

15416 
baž_ä“_rcv”r
:

15417 
	`ä“_rcv”r
(
dd
);

15418 
baž_ä“_úŒs
:

15419 
	`ä“_úŒs
(
dd
);

15420 
baž_þ—r_šŒ
:

15421 
	`hfi1_comp_veùÜs_þ—n_up
(
dd
);

15422 
	`msix_þ—n_up_š‹¼u±s
(
dd
);

15423 
baž_þ—nup
:

15424 
	`hfi1_Ãtdev_ä“
(
dd
);

15425 
	`hfi1_pc›_ddþ—nup
(
dd
);

15426 
baž_ä“
:

15427 
	`hfi1_ä“_devd©a
(
dd
);

15428 
baž
:

15429  
»t
;

15430 
	}
}

15432 
u16
 
	$d–ay_cyþes
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
desœed_eg»ss_¿‹
,

15433 
u32
 
dw_Ën
)

15435 
u32
 
d–_cyþes
;

15436 
u32
 
cu¼’t_eg»ss_¿‹
 = 
µd
->current_egress_rate;

15439 ià(
desœed_eg»ss_¿‹
 == -1)

15442 ià(
desœed_eg»ss_¿‹
 >ð
cu¼’t_eg»ss_¿‹
)

15445 
d–_cyþes
 = 
	`eg»ss_cyþes
(
dw_Ën
 * 4, 
desœed_eg»ss_¿‹
) -

15446 
	`eg»ss_cyþes
(
dw_Ën
 * 4, 
cu¼’t_eg»ss_¿‹
);

15448  (
u16
)
d–_cyþes
;

15449 
	}
}

15465 
u64
 
	$ü—‹_pbc
(
hfi1_µÜtd©a
 *
µd
, 
u64
 
æags
, 
¤©e_mbs
, 
u32
 
vl
,

15466 
u32
 
dw_Ën
)

15468 
u64
 
pbc
, 
d–ay
 = 0;

15470 ià(
	`uÆik–y
(
¤©e_mbs
))

15471 
d–ay
 = 
	`d–ay_cyþes
(
µd
, 
¤©e_mbs
, 
dw_Ën
);

15473 
pbc
 = 
æags


15474 | (
d–ay
 << 
PBC_STATIC_RATE_CONTROL_COUNT_SHIFT
)

15475 | ((
u64
)
PBC_IHCRC_NONE
 << 
PBC_INSERT_HCRC_SHIFT
)

15476 | (
vl
 & 
PBC_VL_MASK
è<< 
PBC_VL_SHIFT


15477 | (
dw_Ën
 & 
PBC_LENGTH_DWS_MASK
)

15478 << 
PBC_LENGTH_DWS_SHIFT
;

15480  
pbc
;

15481 
	}
}

15483 
	#SBUS_THERMAL
 0x4f

	)

15484 
	#SBUS_THERM_MONITOR_MODE
 0x1

	)

15486 
	#THERM_FAILURE
(
dev
, 
»t
, 
»asÚ
) \

15487 
	`dd_dev_”r
((
dd
), \

15489 (
»asÚ
), (
»t
))

	)

15501 
	$th”m®_š™
(
hfi1_devd©a
 *
dd
)

15503 
»t
 = 0;

15505 ià(
dd
->
icode
 !ð
ICODE_RTL_SILICON
 ||

15506 
	`check_ch_»sourû
(
dd
, 
CR_THERM_INIT
, 
NULL
))

15507  
»t
;

15509 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_SBUS
, 
SBUS_TIMEOUT
);

15510 ià(
»t
) {

15511 
	`THERM_FAILURE
(
dd
, 
»t
, "Acquire SBus");

15512  
»t
;

15515 
	`dd_dev_šfo
(
dd
, "Initializinghermal sensor\n");

15517 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_THERM_POLL_EN
, 0x0);

15518 
	`m¦“p
(100);

15521 
»t
 = 
	`sbus_»que¡_¦ow
(
dd
, 
SBUS_THERMAL
, 0x0,

15522 
RESET_SBUS_RECEIVER
, 0);

15523 ià(
»t
) {

15524 
	`THERM_FAILURE
(
dd
, 
»t
, "Bus Reset");

15525 
dÚe
;

15528 
»t
 = 
	`sbus_»que¡_¦ow
(
dd
, 
SBUS_THERMAL
, 0x0,

15529 
WRITE_SBUS_RECEIVER
, 0x1);

15530 ià(
»t
) {

15531 
	`THERM_FAILURE
(
dd
, 
»t
, "Therm Block Reset");

15532 
dÚe
;

15535 
»t
 = 
	`sbus_»que¡_¦ow
(
dd
, 
SBUS_THERMAL
, 0x1,

15536 
WRITE_SBUS_RECEIVER
, 0x32);

15537 ià(
»t
) {

15538 
	`THERM_FAILURE
(
dd
, 
»t
, "Write Clock Div");

15539 
dÚe
;

15542 
»t
 = 
	`sbus_»que¡_¦ow
(
dd
, 
SBUS_THERMAL
, 0x3,

15543 
WRITE_SBUS_RECEIVER
,

15544 
SBUS_THERM_MONITOR_MODE
);

15545 ià(
»t
) {

15546 
	`THERM_FAILURE
(
dd
, 
»t
, "Write Mode Sel");

15547 
dÚe
;

15550 
»t
 = 
	`sbus_»que¡_¦ow
(
dd
, 
SBUS_THERMAL
, 0x0,

15551 
WRITE_SBUS_RECEIVER
, 0x2);

15552 ià(
»t
) {

15553 
	`THERM_FAILURE
(
dd
, 
»t
, "Write Reset Deassert");

15554 
dÚe
;

15557 
	`m¦“p
(22);

15560 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_THERM_POLL_EN
, 0x1);

15563 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_THERM_INIT
, 0);

15564 ià(
»t
)

15565 
	`THERM_FAILURE
(
dd
, 
»t
, "Unableo sethermal init flag");

15567 
dÚe
:

15568 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_SBUS
);

15569  
»t
;

15570 
	}
}

15572 
	$hªdË_‹mp_”r
(
hfi1_devd©a
 *
dd
)

15574 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[0];

15580 
	`dd_dev_em”g
(
dd
,

15582 
dd
->
æags
 |ð
HFI1_FORCED_FREEZE
;

15583 
	`¡¬t_ä“ze_hªdlšg
(
µd
, 
FREEZE_SELF
 | 
FREEZE_ABORT
);

15595 
µd
->
driv”_lšk_»ady
 = 0;

15596 
µd
->
lšk_’abËd
 = 0;

15597 
	`£t_physiÿl_lšk_¡©e
(
dd
, (
OPA_LINKDOWN_REASON_SMA_DISABLED
 << 8) |

15598 
PLS_OFFLINE
);

15603 
	`dc_shutdown
(
dd
);

15604 
	}
}

	@chip.h

1 #iâdeà
_CHIP_H


2 
	#_CHIP_H


	)

55 
	#BITS_PER_REGISTER
 (
BITS_PER_BYTE
 * (
u64
))

	)

56 
	#NUM_INTERRUPT_SOURCES
 768

	)

57 
	#RXE_NUM_CONTEXTS
 160

	)

58 
	#RXE_PER_CONTEXT_SIZE
 0x1000

	)

59 
	#RXE_NUM_TID_FLOWS
 32

	)

60 
	#RXE_NUM_DATA_VL
 8

	)

61 
	#TXE_NUM_CONTEXTS
 160

	)

62 
	#TXE_NUM_SDMA_ENGINES
 16

	)

63 
	#NUM_CONTEXTS_PER_SET
 8

	)

64 
	#VL_ARB_HIGH_PRIO_TABLE_SIZE
 16

	)

65 
	#VL_ARB_LOW_PRIO_TABLE_SIZE
 16

	)

66 
	#VL_ARB_TABLE_SIZE
 16

	)

67 
	#TXE_NUM_32_BIT_COUNTER
 7

	)

68 
	#TXE_NUM_64_BIT_COUNTER
 30

	)

69 
	#TXE_NUM_DATA_VL
 8

	)

70 
	#TXE_PIO_SIZE
 (32 * 0x100000è

	)

71 
	#PIO_BLOCK_SIZE
 64

	)

72 
	#SDMA_BLOCK_SIZE
 64

	)

73 
	#RCV_BUF_BLOCK_SIZE
 64

	)

74 
	#PIO_CMASK
 0x7fà

	)

75 
	#MAX_EAGER_ENTRIES
 2048

	)

76 
	#MAX_TID_PAIR_ENTRIES
 1024

	)

81 
	#CM_VAU
 3

	)

83 
	#CM_GLOBAL_CREDITS
 0x880

	)

85 
	#MAX_PKEY_VALUES
 16

	)

87 
	~"ch_»gi¡”s.h
"

89 
	#RXE_PER_CONTEXT_USER
 (
RXE
 + 
RXE_PER_CONTEXT_OFFSET
)

	)

90 
	#TXE_PIO_SEND
 (
TXE
 + 
TXE_PIO_SEND_OFFSET
)

	)

93 
	#PBC_INTR
 
	`BIT_ULL
(31)

	)

94 
	#PBC_DC_INFO_SHIFT
 (30)

	)

95 
	#PBC_DC_INFO
 
	`BIT_ULL
(
PBC_DC_INFO_SHIFT
)

	)

96 
	#PBC_TEST_EBP
 
	`BIT_ULL
(29)

	)

97 
	#PBC_PACKET_BYPASS
 
	`BIT_ULL
(28)

	)

98 
	#PBC_CREDIT_RETURN
 
	`BIT_ULL
(25)

	)

99 
	#PBC_INSERT_BYPASS_ICRC
 
	`BIT_ULL
(24)

	)

100 
	#PBC_TEST_BAD_ICRC
 
	`BIT_ULL
(23)

	)

101 
	#PBC_FECN
 
	`BIT_ULL
(22)

	)

104 
	#PBC_IHCRC_LKDETH
 0x0

	)

105 
	#PBC_IHCRC_GKDETH
 0x1

	)

106 
	#PBC_IHCRC_NONE
 0x2

	)

109 
	#PBC_STATIC_RATE_CONTROL_COUNT_SHIFT
 32

	)

110 
	#PBC_STATIC_RATE_CONTROL_COUNT_MASK
 0xffffuÎ

	)

111 
	#PBC_STATIC_RATE_CONTROL_COUNT_SMASK
 \

112 (
PBC_STATIC_RATE_CONTROL_COUNT_MASK
 << \

113 
PBC_STATIC_RATE_CONTROL_COUNT_SHIFT
)

	)

115 
	#PBC_INSERT_HCRC_SHIFT
 26

	)

116 
	#PBC_INSERT_HCRC_MASK
 0x3uÎ

	)

117 
	#PBC_INSERT_HCRC_SMASK
 \

118 (
PBC_INSERT_HCRC_MASK
 << 
PBC_INSERT_HCRC_SHIFT
)

	)

120 
	#PBC_VL_SHIFT
 12

	)

121 
	#PBC_VL_MASK
 0xfuÎ

	)

122 
	#PBC_VL_SMASK
 (
PBC_VL_MASK
 << 
PBC_VL_SHIFT
)

	)

124 
	#PBC_LENGTH_DWS_SHIFT
 0

	)

125 
	#PBC_LENGTH_DWS_MASK
 0xfffuÎ

	)

126 
	#PBC_LENGTH_DWS_SMASK
 \

127 (
PBC_LENGTH_DWS_MASK
 << 
PBC_LENGTH_DWS_SHIFT
)

	)

130 
	#CR_COUNTER_SHIFT
 0

	)

131 
	#CR_COUNTER_MASK
 0x7ffuÎ

	)

132 
	#CR_COUNTER_SMASK
 (
CR_COUNTER_MASK
 << 
CR_COUNTER_SHIFT
)

	)

134 
	#CR_STATUS_SHIFT
 11

	)

135 
	#CR_STATUS_MASK
 0x1uÎ

	)

136 
	#CR_STATUS_SMASK
 (
CR_STATUS_MASK
 << 
CR_STATUS_SHIFT
)

	)

138 
	#CR_CREDIT_RETURN_DUE_TO_PBC_SHIFT
 12

	)

139 
	#CR_CREDIT_RETURN_DUE_TO_PBC_MASK
 0x1uÎ

	)

140 
	#CR_CREDIT_RETURN_DUE_TO_PBC_SMASK
 \

141 (
CR_CREDIT_RETURN_DUE_TO_PBC_MASK
 << \

142 
CR_CREDIT_RETURN_DUE_TO_PBC_SHIFT
)

	)

144 
	#CR_CREDIT_RETURN_DUE_TO_THRESHOLD_SHIFT
 13

	)

145 
	#CR_CREDIT_RETURN_DUE_TO_THRESHOLD_MASK
 0x1uÎ

	)

146 
	#CR_CREDIT_RETURN_DUE_TO_THRESHOLD_SMASK
 \

147 (
CR_CREDIT_RETURN_DUE_TO_THRESHOLD_MASK
 << \

148 
CR_CREDIT_RETURN_DUE_TO_THRESHOLD_SHIFT
)

	)

150 
	#CR_CREDIT_RETURN_DUE_TO_ERR_SHIFT
 14

	)

151 
	#CR_CREDIT_RETURN_DUE_TO_ERR_MASK
 0x1uÎ

	)

152 
	#CR_CREDIT_RETURN_DUE_TO_ERR_SMASK
 \

153 (
CR_CREDIT_RETURN_DUE_TO_ERR_MASK
 << \

154 
CR_CREDIT_RETURN_DUE_TO_ERR_SHIFT
)

	)

156 
	#CR_CREDIT_RETURN_DUE_TO_FORCE_SHIFT
 15

	)

157 
	#CR_CREDIT_RETURN_DUE_TO_FORCE_MASK
 0x1uÎ

	)

158 
	#CR_CREDIT_RETURN_DUE_TO_FORCE_SMASK
 \

159 (
CR_CREDIT_RETURN_DUE_TO_FORCE_MASK
 << \

160 
CR_CREDIT_RETURN_DUE_TO_FORCE_SHIFT
)

	)

163 
	#CCE_ERR_INT
 0

	)

164 
	#RXE_ERR_INT
 1

	)

165 
	#MISC_ERR_INT
 2

	)

166 
	#PIO_ERR_INT
 4

	)

167 
	#SDMA_ERR_INT
 5

	)

168 
	#EGRESS_ERR_INT
 6

	)

169 
	#TXE_ERR_INT
 7

	)

170 
	#PBC_INT
 240

	)

171 
	#GPIO_ASSERT_INT
 241

	)

172 
	#QSFP1_INT
 242

	)

173 
	#QSFP2_INT
 243

	)

174 
	#TCRIT_INT
 244

	)

177 
	#IS_FIRST_SOURCE
 
CCE_ERR_INT


	)

178 
	#IS_GENERAL_ERR_START
 0

	)

179 
	#IS_SDMAENG_ERR_START
 16

	)

180 
	#IS_SENDCTXT_ERR_START
 32

	)

181 
	#IS_SDMA_START
 192

	)

182 
	#IS_SDMA_PROGRESS_START
 208

	)

183 
	#IS_SDMA_IDLE_START
 224

	)

184 
	#IS_VARIOUS_START
 240

	)

185 
	#IS_DC_START
 248

	)

186 
	#IS_RCVAVAIL_START
 256

	)

187 
	#IS_RCVURGENT_START
 416

	)

188 
	#IS_SENDCREDIT_START
 576

	)

189 
	#IS_RESERVED_START
 736

	)

190 
	#IS_LAST_SOURCE
 767

	)

193 
	#IS_GENERAL_ERR_END
 7

	)

194 
	#IS_SDMAENG_ERR_END
 31

	)

195 
	#IS_SENDCTXT_ERR_END
 191

	)

196 
	#IS_SDMA_END
 207

	)

197 
	#IS_SDMA_PROGRESS_END
 223

	)

198 
	#IS_SDMA_IDLE_END
 239

	)

199 
	#IS_VARIOUS_END
 244

	)

200 
	#IS_DC_END
 255

	)

201 
	#IS_RCVAVAIL_END
 415

	)

202 
	#IS_RCVURGENT_END
 575

	)

203 
	#IS_SENDCREDIT_END
 735

	)

204 
	#IS_RESERVED_END
 
IS_LAST_SOURCE


	)

207 
	#LSTATE_DOWN
 0x1

	)

208 
	#LSTATE_INIT
 0x2

	)

209 
	#LSTATE_ARMED
 0x3

	)

210 
	#LSTATE_ACTIVE
 0x4

	)

213 
	#LCB_RX_FPE_TX_FPE_INTO_RESET
 (
DCC_CFG_RESET_RESET_LCB
 | \

214 
DCC_CFG_RESET_RESET_TX_FPE
 | \

215 
DCC_CFG_RESET_RESET_RX_FPE
 | \

216 
DCC_CFG_RESET_ENABLE_CCLK_BCC
)

	)

219 
	#LCB_RX_FPE_TX_FPE_OUT_OF_RESET
 
DCC_CFG_RESET_ENABLE_CCLK_BCC


	)

222 
	#PLS_DISABLED
 0x30

	)

223 
	#PLS_OFFLINE
 0x90

	)

224 
	#PLS_OFFLINE_QUIET
 0x90

	)

225 
	#PLS_OFFLINE_PLANNED_DOWN_INFORM
 0x91

	)

226 
	#PLS_OFFLINE_READY_TO_QUIET_LT
 0x92

	)

227 
	#PLS_OFFLINE_REPORT_FAILURE
 0x93

	)

228 
	#PLS_OFFLINE_READY_TO_QUIET_BCC
 0x94

	)

229 
	#PLS_OFFLINE_QUIET_DURATION
 0x95

	)

230 
	#PLS_POLLING
 0x20

	)

231 
	#PLS_POLLING_QUIET
 0x20

	)

232 
	#PLS_POLLING_ACTIVE
 0x21

	)

233 
	#PLS_CONFIGPHY
 0x40

	)

234 
	#PLS_CONFIGPHY_DEBOUCE
 0x40

	)

235 
	#PLS_CONFIGPHY_ESTCOMM
 0x41

	)

236 
	#PLS_CONFIGPHY_ESTCOMM_TXRX_HUNT
 0x42

	)

237 
	#PLS_CONFIGPHY_ESTCOMM_LOCAL_COMPLETE
 0x43

	)

238 
	#PLS_CONFIGPHY_OPTEQ
 0x44

	)

239 
	#PLS_CONFIGPHY_OPTEQ_OPTIMIZING
 0x44

	)

240 
	#PLS_CONFIGPHY_OPTEQ_LOCAL_COMPLETE
 0x45

	)

241 
	#PLS_CONFIGPHY_VERIFYCAP
 0x46

	)

242 
	#PLS_CONFIGPHY_VERIFYCAP_EXCHANGE
 0x46

	)

243 
	#PLS_CONFIGPHY_VERIFYCAP_LOCAL_COMPLETE
 0x47

	)

244 
	#PLS_CONFIGLT
 0x48

	)

245 
	#PLS_CONFIGLT_CONFIGURE
 0x48

	)

246 
	#PLS_CONFIGLT_LINK_TRANSFER_ACTIVE
 0x49

	)

247 
	#PLS_LINKUP
 0x50

	)

248 
	#PLS_PHYTEST
 0xB0

	)

249 
	#PLS_INTERNAL_SERDES_LOOPBACK
 0xe1

	)

250 
	#PLS_QUICK_LINKUP
 0xe2

	)

253 
	#HCMD_LOAD_CONFIG_DATA
 0x01

	)

254 
	#HCMD_READ_CONFIG_DATA
 0x02

	)

255 
	#HCMD_CHANGE_PHY_STATE
 0x03

	)

256 
	#HCMD_SEND_LCB_IDLE_MSG
 0x04

	)

257 
	#HCMD_MISC
 0x05

	)

258 
	#HCMD_READ_LCB_IDLE_MSG
 0x06

	)

259 
	#HCMD_READ_LCB_CSR
 0x07

	)

260 
	#HCMD_WRITE_LCB_CSR
 0x08

	)

261 
	#HCMD_INTERFACE_TEST
 0xff

	)

264 
	#HCMD_SUCCESS
 2

	)

267 
	#SPICO_ROM_FAILED
 
	`BIT
(0)

	)

268 
	#UNKNOWN_FRAME
 
	`BIT
(1)

	)

269 
	#TARGET_BER_NOT_MET
 
	`BIT
(2)

	)

270 
	#FAILED_SERDES_INTERNAL_LOOPBACK
 
	`BIT
(3)

	)

271 
	#FAILED_SERDES_INIT
 
	`BIT
(4)

	)

272 
	#FAILED_LNI_POLLING
 
	`BIT
(5)

	)

273 
	#FAILED_LNI_DEBOUNCE
 
	`BIT
(6)

	)

274 
	#FAILED_LNI_ESTBCOMM
 
	`BIT
(7)

	)

275 
	#FAILED_LNI_OPTEQ
 
	`BIT
(8)

	)

276 
	#FAILED_LNI_VERIFY_CAP1
 
	`BIT
(9)

	)

277 
	#FAILED_LNI_VERIFY_CAP2
 
	`BIT
(10)

	)

278 
	#FAILED_LNI_CONFIGLT
 
	`BIT
(11)

	)

279 
	#HOST_HANDSHAKE_TIMEOUT
 
	`BIT
(12)

	)

280 
	#EXTERNAL_DEVICE_REQ_TIMEOUT
 
	`BIT
(13)

	)

282 
	#FAILED_LNI
 (
FAILED_LNI_POLLING
 | 
FAILED_LNI_DEBOUNCE
 \

283 | 
FAILED_LNI_ESTBCOMM
 | 
FAILED_LNI_OPTEQ
 \

284 | 
FAILED_LNI_VERIFY_CAP1
 \

285 | 
FAILED_LNI_VERIFY_CAP2
 \

286 | 
FAILED_LNI_CONFIGLT
 | 
HOST_HANDSHAKE_TIMEOUT
 \

287 | 
EXTERNAL_DEVICE_REQ_TIMEOUT
)

	)

290 
	#HOST_REQ_DONE
 
	`BIT
(0)

	)

291 
	#BC_PWR_MGM_MSG
 
	`BIT
(1)

	)

292 
	#BC_SMA_MSG
 
	`BIT
(2)

	)

293 
	#BC_BCC_UNKNOWN_MSG
 
	`BIT
(3)

	)

294 
	#BC_IDLE_UNKNOWN_MSG
 
	`BIT
(4)

	)

295 
	#EXT_DEVICE_CFG_REQ
 
	`BIT
(5)

	)

296 
	#VERIFY_CAP_FRAME
 
	`BIT
(6)

	)

297 
	#LINKUP_ACHIEVED
 
	`BIT
(7)

	)

298 
	#LINK_GOING_DOWN
 
	`BIT
(8)

	)

299 
	#LINK_WIDTH_DOWNGRADED
 
	`BIT
(9)

	)

302 
	#HREQ_LOAD_CONFIG
 0x01

	)

303 
	#HREQ_SAVE_CONFIG
 0x02

	)

304 
	#HREQ_READ_CONFIG
 0x03

	)

305 
	#HREQ_SET_TX_EQ_ABS
 0x04

	)

306 
	#HREQ_SET_TX_EQ_REL
 0x05

	)

307 
	#HREQ_ENABLE
 0x06

	)

308 
	#HREQ_LCB_RESET
 0x07

	)

309 
	#HREQ_CONFIG_DONE
 0xã

	)

310 
	#HREQ_INTERFACE_TEST
 0xff

	)

313 
	#HREQ_INVALID
 0x01

	)

314 
	#HREQ_SUCCESS
 0x02

	)

315 
	#HREQ_NOT_SUPPORTED
 0x03

	)

316 
	#HREQ_FEATURE_NOT_SUPPORTED
 0x04

	)

317 
	#HREQ_REQUEST_REJECTED
 0xã

	)

318 
	#HREQ_EXECUTION_ONGOING
 0xff

	)

321 
	#HCMD_MISC_REQUEST_LCB_ACCESS
 0x1

	)

322 
	#HCMD_MISC_GRANT_LCB_ACCESS
 0x2

	)

325 
	#IDLE_PHYSICAL_LINK_MGMT
 0x1

	)

326 
	#IDLE_CRU
 0x2

	)

327 
	#IDLE_SMA
 0x3

	)

328 
	#IDLE_POWER_MGMT
 0x4

	)

331 
	#IDLE_PAYLOAD_MASK
 0xffffffffffuÎ

	)

332 
	#IDLE_PAYLOAD_SHIFT
 8

	)

333 
	#IDLE_MSG_TYPE_MASK
 0xf

	)

334 
	#IDLE_MSG_TYPE_SHIFT
 0

	)

337 
	#READ_IDLE_MSG_TYPE_MASK
 0xf

	)

338 
	#READ_IDLE_MSG_TYPE_SHIFT
 0

	)

341 
	#SMA_IDLE_ARM
 1

	)

342 
	#SMA_IDLE_ACTIVE
 2

	)

345 
	#DISABLE_SELF_GUID_CHECK
 0x2

	)

348 
	#BAD_L2_ERR
 0x6

	)

357 
	#MIN_EAGER_BUFFER
 (4 * 1024)

	)

358 
	#MAX_EAGER_BUFFER
 (256 * 1024)

	)

359 
	#MAX_EAGER_BUFFER_TOTAL
 (64 * (1 << 20)è

	)

360 
	#MAX_EXPECTED_BUFFER
 (2048 * 1024)

	)

361 
	#HFI1_MIN_HDRQ_EGRBUF_CNT
 32

	)

362 
	#HFI1_MAX_HDRQ_EGRBUF_CNT
 16352

	)

368 
	#RCV_SHIFT
 3

	)

369 
	#RCV_INCREMENT
 
	`BIT
(
RCV_SHIFT
)

	)

375 
	#HDRQ_SIZE_SHIFT
 5

	)

376 
	#HDRQ_INCREMENT
 
	`BIT
(
HDRQ_SIZE_SHIFT
)

	)

381 
	#FREEZE_ABORT
 0x01

	)

382 
	#FREEZE_SELF
 0x02

	)

383 
	#FREEZE_LINK_DOWN
 0x04

	)

388 
	#ICODE_RTL_SILICON
 0x00

	)

389 
	#ICODE_RTL_VCS_SIMULATION
 0x01

	)

390 
	#ICODE_FPGA_EMULATION
 0x02

	)

391 
	#ICODE_FUNCTIONAL_SIMULATOR
 0x03

	)

396 
	#DC8051_DATA_MEM_SIZE
 0x1000

	)

401 
	#NUM_GENERAL_FIELDS
 0x17

	)

402 
	#NUM_LANE_FIELDS
 0x8

	)

405 
	#LINK_OPTIMIZATION_SETTINGS
 0x00

	)

406 
	#LINK_TUNING_PARAMETERS
 0x02

	)

407 
	#DC_HOST_COMM_SETTINGS
 0x03

	)

408 
	#TX_SETTINGS
 0x06

	)

409 
	#VERIFY_CAP_LOCAL_PHY
 0x07

	)

410 
	#VERIFY_CAP_LOCAL_FABRIC
 0x08

	)

411 
	#VERIFY_CAP_LOCAL_LINK_MODE
 0x09

	)

412 
	#LOCAL_DEVICE_ID
 0x0a

	)

413 
	#RESERVED_REGISTERS
 0x0b

	)

414 
	#LOCAL_LNI_INFO
 0x0c

	)

415 
	#REMOTE_LNI_INFO
 0x0d

	)

416 
	#MISC_STATUS
 0x0e

	)

417 
	#VERIFY_CAP_REMOTE_PHY
 0x0f

	)

418 
	#VERIFY_CAP_REMOTE_FABRIC
 0x10

	)

419 
	#VERIFY_CAP_REMOTE_LINK_WIDTH
 0x11

	)

420 
	#LAST_LOCAL_STATE_COMPLETE
 0x12

	)

421 
	#LAST_REMOTE_STATE_COMPLETE
 0x13

	)

422 
	#LINK_QUALITY_INFO
 0x14

	)

423 
	#REMOTE_DEVICE_ID
 0x15

	)

424 
	#LINK_DOWN_REASON
 0x16

	)

425 
	#VERSION_PATCH
 0x16

	)

428 
	#TX_EQ_SETTINGS
 0x00

	)

429 
	#CHANNEL_LOSS_SETTINGS
 0x05

	)

432 
	#GENERAL_CONFIG
 4

	)

435 
	#TUNING_METHOD_SHIFT
 24

	)

438 
	#ENABLE_EXT_DEV_CONFIG_SHIFT
 24

	)

441 
	#LOAD_DATA_FIELD_ID_SHIFT
 40

	)

442 
	#LOAD_DATA_FIELD_ID_MASK
 0xfuÎ

	)

443 
	#LOAD_DATA_LANE_ID_SHIFT
 32

	)

444 
	#LOAD_DATA_LANE_ID_MASK
 0xfuÎ

	)

445 
	#LOAD_DATA_DATA_SHIFT
 0x0

	)

446 
	#LOAD_DATA_DATA_MASK
 0xffffffffuÎ

	)

449 
	#READ_DATA_FIELD_ID_SHIFT
 40

	)

450 
	#READ_DATA_FIELD_ID_MASK
 0xffuÎ

	)

451 
	#READ_DATA_LANE_ID_SHIFT
 32

	)

452 
	#READ_DATA_LANE_ID_MASK
 0xffuÎ

	)

453 
	#READ_DATA_DATA_SHIFT
 0x0

	)

454 
	#READ_DATA_DATA_MASK
 0xffffffffuÎ

	)

457 
	#ENABLE_LANE_TX_SHIFT
 0

	)

458 
	#ENABLE_LANE_TX_MASK
 0xff

	)

459 
	#TX_POLARITY_INVERSION_SHIFT
 8

	)

460 
	#TX_POLARITY_INVERSION_MASK
 0xff

	)

461 
	#RX_POLARITY_INVERSION_SHIFT
 16

	)

462 
	#RX_POLARITY_INVERSION_MASK
 0xff

	)

463 
	#MAX_RATE_SHIFT
 24

	)

464 
	#MAX_RATE_MASK
 0xff

	)

467 
	#CONTINIOUS_REMOTE_UPDATE_SUPPORT_SHIFT
 0x4

	)

468 
	#CONTINIOUS_REMOTE_UPDATE_SUPPORT_MASK
 0x1

	)

469 
	#POWER_MANAGEMENT_SHIFT
 0x0

	)

470 
	#POWER_MANAGEMENT_MASK
 0xf

	)

473 
	#SPICO_FW_VERSION
 0x7

	)

476 
	#SPICO_ROM_VERSION_SHIFT
 0

	)

477 
	#SPICO_ROM_VERSION_MASK
 0xffff

	)

478 
	#SPICO_ROM_PROD_ID_SHIFT
 16

	)

479 
	#SPICO_ROM_PROD_ID_MASK
 0xffff

	)

482 
	#VAU_SHIFT
 0

	)

483 
	#VAU_MASK
 0x0007

	)

484 
	#Z_SHIFT
 3

	)

485 
	#Z_MASK
 0x0001

	)

486 
	#VCU_SHIFT
 4

	)

487 
	#VCU_MASK
 0x0007

	)

488 
	#VL15BUF_SHIFT
 8

	)

489 
	#VL15BUF_MASK
 0x0fff

	)

490 
	#CRC_SIZES_SHIFT
 20

	)

491 
	#CRC_SIZES_MASK
 0x7

	)

494 
	#LINK_WIDTH_SHIFT
 0

	)

495 
	#LINK_WIDTH_MASK
 0xfffà

	)

496 
	#LOCAL_FLAG_BITS_SHIFT
 16

	)

497 
	#LOCAL_FLAG_BITS_MASK
 0xff

	)

498 
	#MISC_CONFIG_BITS_SHIFT
 24

	)

499 
	#MISC_CONFIG_BITS_MASK
 0xff

	)

502 
	#REMOTE_TX_RATE_SHIFT
 16

	)

503 
	#REMOTE_TX_RATE_MASK
 0xff

	)

506 
	#LOCAL_DEVICE_REV_SHIFT
 0

	)

507 
	#LOCAL_DEVICE_REV_MASK
 0xff

	)

508 
	#LOCAL_DEVICE_ID_SHIFT
 8

	)

509 
	#LOCAL_DEVICE_ID_MASK
 0xffff

	)

512 
	#REMOTE_DEVICE_REV_SHIFT
 0

	)

513 
	#REMOTE_DEVICE_REV_MASK
 0xff

	)

514 
	#REMOTE_DEVICE_ID_SHIFT
 8

	)

515 
	#REMOTE_DEVICE_ID_MASK
 0xffff

	)

518 
	#ENABLE_LANE_RX_SHIFT
 16

	)

519 
	#ENABLE_LANE_RX_MASK
 0xff

	)

522 
	#MGMT_ALLOWED_SHIFT
 23

	)

523 
	#MGMT_ALLOWED_MASK
 0x1

	)

526 
	#LINK_QUALITY_SHIFT
 24

	)

527 
	#LINK_QUALITY_MASK
 0x7

	)

533 
	#DOWN_REMOTE_REASON_SHIFT
 16

	)

534 
	#DOWN_REMOTE_REASON_MASK
 0xff

	)

536 
	#HOST_INTERFACE_VERSION
 1

	)

537 
	#HOST_INTERFACE_VERSION_SHIFT
 16

	)

538 
	#HOST_INTERFACE_VERSION_MASK
 0xff

	)

541 
	#PWRM_BER_CONTROL
 0x1

	)

542 
	#PWRM_BANDWIDTH_CONTROL
 0x2

	)

545 
	#LDR_LINK_TRANSFER_ACTIVE_LOW
 0xa

	)

546 
	#LDR_RECEIVED_LINKDOWN_IDLE_MSG
 0xb

	)

547 
	#LDR_RECEIVED_HOST_OFFLINE_REQ
 0xc

	)

551 
	mCAP_CRC_14B
 = (1 << 0),

552 
	mCAP_CRC_48B
 = (1 << 1),

553 
	mCAP_CRC_12B_16B_PER_LANE
 = (1 << 2)

556 
	#SUPPORTED_CRCS
 (
CAP_CRC_14B
 | 
CAP_CRC_48B
)

	)

559 
	#STS_FM_VERSION_MINOR_SHIFT
 16

	)

560 
	#STS_FM_VERSION_MINOR_MASK
 0xff

	)

561 
	#STS_FM_VERSION_MAJOR_SHIFT
 24

	)

562 
	#STS_FM_VERSION_MAJOR_MASK
 0xff

	)

563 
	#STS_FM_VERSION_PATCH_SHIFT
 24

	)

564 
	#STS_FM_VERSION_PATCH_MASK
 0xff

	)

567 
	#LCB_CRC_16B
 0x0

	)

568 
	#LCB_CRC_14B
 0x1

	)

569 
	#LCB_CRC_48B
 0x2

	)

570 
	#LCB_CRC_12B_16B_PER_LANE
 0x3

	)

577 
	mPORT_LTP_CRC_MODE_NONE
 = 0,

578 
	mPORT_LTP_CRC_MODE_14
 = 1,

579 
	mPORT_LTP_CRC_MODE_16
 = 2,

580 
	mPORT_LTP_CRC_MODE_48
 = 4,

582 
	mPORT_LTP_CRC_MODE_PER_LANE
 = 8

587 
	#LINK_RESTART_DELAY
 1000

	)

588 
	#TIMEOUT_8051_START
 5000

	)

589 
	#DC8051_COMMAND_TIMEOUT
 1000

	)

590 
	#FREEZE_STATUS_TIMEOUT
 20

	)

591 
	#VL_STATUS_CLEAR_TIMEOUT
 5000

	)

592 
	#CCE_STATUS_TIMEOUT
 10

	)

595 
	#ASIC_CCLOCK_PS
 1242

	)

596 
	#FPGA_CCLOCK_PS
 30300

	)

602 
	#DRIVER_MISC_MASK
 \

603 (~(
MISC_ERR_STATUS_MISC_FW_AUTH_FAILED_ERR_SMASK
 \

604 | 
MISC_ERR_STATUS_MISC_KEY_MISMATCH_ERR_SMASK
))

	)

607 
	#LOOPBACK_NONE
 0

	)

608 
	#LOOPBACK_SERDES
 1

	)

609 
	#LOOPBACK_LCB
 2

	)

610 
	#LOOPBACK_CABLE
 3

	)

613 
	#LOOPBACK_SERDES_CONFIG_BIT_MASK_SHIFT
 0

	)

614 
	#EXT_CFG_LCB_RESET_SUPPORTED_SHIFT
 3

	)

617 
	#GUID_HFI_INDEX_SHIFT
 39

	)

618 
	#HFI_ASIC_GUID
(
guid
è((guidè& ~(1ULL << 
GUID_HFI_INDEX_SHIFT
))

	)

621 
u64
 
»ad_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
u32
 
off£t
);

622 
wr™e_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
u32
 
off£t
, 
u64
 
v®ue
);

629 
šlše
 
u64
 
	$»ad_kùxt_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
ùxt
,

630 
u32
 
off£t0
)

633  
	`»ad_c¤
(
dd
, 
off£t0
 + (0x100 * 
ùxt
));

634 
	}
}

636 
šlše
 
	$wr™e_kùxt_c¤
(
hfi1_devd©a
 *
dd
, 
ùxt
,

637 
u32
 
off£t0
, 
u64
 
v®ue
)

640 
	`wr™e_c¤
(
dd
, 
off£t0
 + (0x100 * 
ùxt
), 
v®ue
);

641 
	}
}

643 
»ad_lcb_c¤
(
hfi1_devd©a
 *
dd
, 
u32
 
off£t
, 
u64
 *
d©a
);

644 
wr™e_lcb_c¤
(
hfi1_devd©a
 *
dd
, 
u32
 
off£t
, 
u64
 
d©a
);

646 
__iomem
 *
g‘_c¤_addr
(

647 cÚ¡ 
hfi1_devd©a
 *
dd
,

648 
u32
 
off£t
);

650 
šlše
 
__iomem
 *
	$g‘_kùxt_c¤_addr
(

651 cÚ¡ 
hfi1_devd©a
 *
dd
,

652 
ùxt
,

653 
u32
 
off£t0
)

655  
	`g‘_c¤_addr
(
dd
, 
off£t0
 + (0x100 * 
ùxt
));

656 
	}
}

664 
šlše
 
u64
 
	$»ad_uùxt_c¤
(cÚ¡ 
hfi1_devd©a
 *
dd
, 
ùxt
,

665 
u32
 
off£t0
)

668  
	`»ad_c¤
(
dd
, 
off£t0
 + (0x1000 * 
ùxt
));

669 
	}
}

671 
šlše
 
	$wr™e_uùxt_c¤
(
hfi1_devd©a
 *
dd
, 
ùxt
,

672 
u32
 
off£t0
, 
u64
 
v®ue
)

675 
	`wr™e_c¤
(
dd
, 
off£t0
 + (0x1000 * 
ùxt
), 
v®ue
);

676 
	}
}

678 
šlše
 
u32
 
	$ch_rcv_cÚ‹xts
(
hfi1_devd©a
 *
dd
)

680  
	`»ad_c¤
(
dd
, 
RCV_CONTEXTS
);

681 
	}
}

683 
šlše
 
u32
 
	$ch_£nd_cÚ‹xts
(
hfi1_devd©a
 *
dd
)

685  
	`»ad_c¤
(
dd
, 
SEND_CONTEXTS
);

686 
	}
}

688 
šlše
 
u32
 
	$ch_sdma_’gšes
(
hfi1_devd©a
 *
dd
)

690  
	`»ad_c¤
(
dd
, 
SEND_DMA_ENGINES
);

691 
	}
}

693 
šlše
 
u32
 
	$ch_pio_mem_size
(
hfi1_devd©a
 *
dd
)

695  
	`»ad_c¤
(
dd
, 
SEND_PIO_MEM_SIZE
);

696 
	}
}

698 
šlše
 
u32
 
	$ch_sdma_mem_size
(
hfi1_devd©a
 *
dd
)

700  
	`»ad_c¤
(
dd
, 
SEND_DMA_MEM_SIZE
);

701 
	}
}

703 
šlše
 
u32
 
	$ch_rcv_¬¿y_couÁ
(
hfi1_devd©a
 *
dd
)

705  
	`»ad_c¤
(
dd
, 
RCV_ARRAY_CNT
);

706 
	}
}

708 
u8
 
’code_rcv_h—d”_’Œy_size
(u8 
size
);

709 
hfi1_v®id©e_rcvhdrút
(
hfi1_devd©a
 *
dd
, 
ušt
 
theút
);

710 
£t_hdrq_»gs
(
hfi1_devd©a
 *
dd
, 
u8
 
ùxt
, u8 
’tsize
, 
u16
 
hdrút
);

712 
u64
 
ü—‹_pbc
(
hfi1_µÜtd©a
 *
µd
, u64 
æags
, 
¤©e_mbs
, 
u32
 
vl
,

713 
u32
 
dw_Ën
);

716 
	#SBUS_MASTER_BROADCAST
 0xfd

	)

717 
	#NUM_PCIE_SERDES
 16

	)

718 cÚ¡ 
u8
 
pc›_£rdes_brßdÿ¡
[];

719 cÚ¡ 
u8
 
pc›_pcs_addrs
[2][
NUM_PCIE_SERDES
];

722 
	#RESET_SBUS_RECEIVER
 0x20

	)

723 
	#WRITE_SBUS_RECEIVER
 0x21

	)

724 
	#READ_SBUS_RECEIVER
 0x22

	)

725 
sbus_»que¡
(
hfi1_devd©a
 *
dd
,

726 
u8
 
»ûiv”_addr
, u8 
d©a_addr
, u8 
commªd
, 
u32
 
d©a_š
);

727 
sbus_»que¡_¦ow
(
hfi1_devd©a
 *
dd
,

728 
u8
 
»ûiv”_addr
, u8 
d©a_addr
, u8 
commªd
, 
u32
 
d©a_š
);

729 
£t_sbus_ç¡_mode
(
hfi1_devd©a
 *
dd
);

730 
þ—r_sbus_ç¡_mode
(
hfi1_devd©a
 *
dd
);

731 
hfi1_fœmw¬e_š™
(
hfi1_devd©a
 *
dd
);

732 
lßd_pc›_fœmw¬e
(
hfi1_devd©a
 *
dd
);

733 
lßd_fœmw¬e
(
hfi1_devd©a
 *
dd
);

734 
di¥o£_fœmw¬e
();

735 
acquœe_hw_mu‹x
(
hfi1_devd©a
 *
dd
);

736 
»Ëa£_hw_mu‹x
(
hfi1_devd©a
 *
dd
);

746 
	#CR_SBUS
 0x01

	)

747 
	#CR_EPROM
 0x02

	)

748 
	#CR_I2C1
 0x04

	)

749 
	#CR_I2C2
 0x08

	)

750 
	#CR_DYN_SHIFT
 8

	)

751 
	#CR_DYN_MASK
 ((1uÎ << 
CR_DYN_SHIFT
è- 1)

	)

758 
	#CR_THERM_INIT
 0x010000

	)

760 
acquœe_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
, u32 
mswa™
);

761 
»Ëa£_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
);

762 
boÞ
 
check_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
,

763 cÚ¡ *
func
);

764 
š™_ch_»sourûs
(
hfi1_devd©a
 *
dd
);

765 
fšish_ch_»sourûs
(
hfi1_devd©a
 *
dd
);

768 
	#SBUS_TIMEOUT
 4000

	)

771 
	#QSFP_WAIT
 20000

	)

773 
çbric_£rdes_»£t
(
hfi1_devd©a
 *
dd
);

774 
»ad_8051_d©a
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, u32 
Ën
, 
u64
 *
»suÉ
);

777 
»ad_misc_¡©us
(
hfi1_devd©a
 *
dd
, 
u8
 *
v”_majÜ
, u8 *
v”_mšÜ
,

778 
u8
 *
v”_·tch
);

779 
wr™e_ho¡_š‹rçû_v”siÚ
(
hfi1_devd©a
 *
dd
, 
u8
 
v”siÚ
);

780 
»ad_guid
(
hfi1_devd©a
 *
dd
);

781 
wa™_fm_»ady
(
hfi1_devd©a
 *
dd
, 
u32
 
m¡imeout
);

782 
£t_lšk_down_»asÚ
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
lþ_»asÚ
,

783 
u8
 
Ãigh_»asÚ
, u8 
»m_»asÚ
);

784 
£t_lšk_¡©e
(
hfi1_µÜtd©a
 *, 
u32
 
¡©e
);

785 
pÜt_Ép_to_ÿp
(
pÜt_Ép
);

786 
hªdË_v”ify_ÿp
(
wÜk_¡ruù
 *
wÜk
);

787 
hªdË_ä“ze
(
wÜk_¡ruù
 *
wÜk
);

788 
hªdË_lšk_up
(
wÜk_¡ruù
 *
wÜk
);

789 
hªdË_lšk_down
(
wÜk_¡ruù
 *
wÜk
);

790 
hªdË_lšk_downg¿de
(
wÜk_¡ruù
 *
wÜk
);

791 
hªdË_lšk_bounû
(
wÜk_¡ruù
 *
wÜk
);

792 
hªdË_¡¬t_lšk
(
wÜk_¡ruù
 *
wÜk
);

793 
hªdË_sma_mes§ge
(
wÜk_¡ruù
 *
wÜk
);

794 
»£t_qså
(
hfi1_µÜtd©a
 *
µd
);

795 
qså_ev’t
(
wÜk_¡ruù
 *
wÜk
);

796 
¡¬t_ä“ze_hªdlšg
(
hfi1_µÜtd©a
 *
µd
, 
æags
);

797 
£nd_idË_sma
(
hfi1_devd©a
 *
dd
, 
u64
 
mes§ge
);

798 
lßd_8051_cÚfig
(
hfi1_devd©a
 *, 
u8
, u8, 
u32
);

799 
»ad_8051_cÚfig
(
hfi1_devd©a
 *, 
u8
, u8, 
u32
 *);

800 
¡¬t_lšk
(
hfi1_µÜtd©a
 *
µd
);

801 
bršgup_£rdes
(
hfi1_µÜtd©a
 *
µd
);

802 
£t_šŒ_¡©e
(
hfi1_devd©a
 *
dd
, 
u32
 
’abË
);

803 
boÞ
 
­¶y_lšk_downg¿de_pÞicy
(
hfi1_µÜtd©a
 *
µd
,

804 
boÞ
 
»äesh_widths
);

805 
upd©e_u¤h—d
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
hd
, u32 
updegr
, u32 
egrhd
,

806 
u32
 
šŒ_adju¡
, u32 
Åkts
);

807 
¡Ý_d¿š_d©a_vls
(
hfi1_devd©a
 *
dd
);

808 
Ý’_fžl_d©a_vls
(
hfi1_devd©a
 *
dd
);

809 
u32
 
ns_to_cþock
(
hfi1_devd©a
 *
dd
, u32 
ns
);

810 
u32
 
cþock_to_ns
(
hfi1_devd©a
 *
dd
, u32 
cþock
);

811 
g‘_lškup_lšk_widths
(
hfi1_µÜtd©a
 *
µd
);

812 
»ad_Ép_¹t
(
hfi1_devd©a
 *
dd
);

813 
þ—r_lškup_couÁ”s
(
hfi1_devd©a
 *
dd
);

814 
u32
 
hdrqem±y
(
hfi1_ùxtd©a
 *
rcd
);

815 
is_ax
(
hfi1_devd©a
 *
dd
);

816 
is_bx
(
hfi1_devd©a
 *
dd
);

817 
boÞ
 
is_urg_masked
(
hfi1_ùxtd©a
 *
rcd
);

818 
u32
 
»ad_physiÿl_¡©e
(
hfi1_devd©a
 *
dd
);

819 
u32
 
ch_to_Ýa_p¡©e
(
hfi1_devd©a
 *
dd
, u32 
ch_p¡©e
);

820 cÚ¡ *
Ýa_l¡©e_Çme
(
u32
 
l¡©e
);

821 cÚ¡ *
Ýa_p¡©e_Çme
(
u32
 
p¡©e
);

822 
u32
 
driv”_p¡©e
(
hfi1_µÜtd©a
 *
µd
);

823 
u32
 
driv”_l¡©e
(
hfi1_µÜtd©a
 *
µd
);

825 
acquœe_lcb_acûss
(
hfi1_devd©a
 *
dd
, 
¦“p_ok
);

826 
»Ëa£_lcb_acûss
(
hfi1_devd©a
 *
dd
, 
¦“p_ok
);

827 
	#LCB_START
 
DC_LCB_CSRS


	)

828 
	#LCB_END
 
DC_8051_CSRS


	)

829 
šlše
 
	$is_lcb_off£t
(
u32
 
off£t
)

831  (
off£t
 >ð
LCB_START
 && off£ˆ< 
LCB_END
);

832 
	}
}

834 
ušt
 
num_vls
;

836 
ušt
 
di§bË_š‹gr™y
;

837 
u64
 
»ad_dev_úŒ
(
hfi1_devd©a
 *
dd
, 
šdex
, 
vl
);

838 
u64
 
wr™e_dev_úŒ
(
hfi1_devd©a
 *
dd
, 
šdex
, 
vl
, u64 
d©a
);

839 
u64
 
»ad_pÜt_úŒ
(
hfi1_µÜtd©a
 *
µd
, 
šdex
, 
vl
);

840 
u64
 
wr™e_pÜt_úŒ
(
hfi1_µÜtd©a
 *
µd
, 
šdex
, 
vl
, u64 
d©a
);

841 
u32
 
»ad_logiÿl_¡©e
(
hfi1_devd©a
 *
dd
);

842 
fÜû_»cv_šŒ
(
hfi1_ùxtd©a
 *
rcd
);

846 
	mC_VL_0
 = 0,

847 
	mC_VL_1
,

848 
	mC_VL_2
,

849 
	mC_VL_3
,

850 
	mC_VL_4
,

851 
	mC_VL_5
,

852 
	mC_VL_6
,

853 
	mC_VL_7
,

854 
	mC_VL_15
,

855 
	mC_VL_COUNT


858 
šlše
 
	$vl_äom_idx
(
idx
)

860  (
idx
 =ð
C_VL_15
 ? 15 : idx);

861 
	}
}

863 
šlše
 
	$idx_äom_vl
(
vl
)

865  (
vl
 =ð15 ? 
C_VL_15
 : vl);

866 
	}
}

870 
	mC_RCV_OVF
 = 0,

871 
	mC_RX_LEN_ERR
,

872 
	mC_RX_SHORT_ERR
,

873 
	mC_RX_ICRC_ERR
,

874 
	mC_RX_EBP
,

875 
	mC_RX_TID_FULL
,

876 
	mC_RX_TID_INVALID
,

877 
	mC_RX_TID_FLGMS
,

878 
	mC_RX_CTX_EGRS
,

879 
	mC_RCV_TID_FLSMS
,

880 
	mC_CCE_PCI_CR_ST
,

881 
	mC_CCE_PCI_TR_ST
,

882 
	mC_CCE_PIO_WR_ST
,

883 
	mC_CCE_ERR_INT
,

884 
	mC_CCE_SDMA_INT
,

885 
	mC_CCE_MISC_INT
,

886 
	mC_CCE_RCV_AV_INT
,

887 
	mC_CCE_RCV_URG_INT
,

888 
	mC_CCE_SEND_CR_INT
,

889 
	mC_DC_UNC_ERR
,

890 
	mC_DC_RCV_ERR
,

891 
	mC_DC_FM_CFG_ERR
,

892 
	mC_DC_RMT_PHY_ERR
,

893 
	mC_DC_DROPPED_PKT
,

894 
	mC_DC_MC_XMIT_PKTS
,

895 
	mC_DC_MC_RCV_PKTS
,

896 
	mC_DC_XMIT_CERR
,

897 
	mC_DC_RCV_CERR
,

898 
	mC_DC_RCV_FCC
,

899 
	mC_DC_XMIT_FCC
,

900 
	mC_DC_XMIT_FLITS
,

901 
	mC_DC_RCV_FLITS
,

902 
	mC_DC_XMIT_PKTS
,

903 
	mC_DC_RCV_PKTS
,

904 
	mC_DC_RX_FLIT_VL
,

905 
	mC_DC_RX_PKT_VL
,

906 
	mC_DC_RCV_FCN
,

907 
	mC_DC_RCV_FCN_VL
,

908 
	mC_DC_RCV_BCN
,

909 
	mC_DC_RCV_BCN_VL
,

910 
	mC_DC_RCV_BBL
,

911 
	mC_DC_RCV_BBL_VL
,

912 
	mC_DC_MARK_FECN
,

913 
	mC_DC_MARK_FECN_VL
,

914 
	mC_DC_TOTAL_CRC
,

915 
	mC_DC_CRC_LN0
,

916 
	mC_DC_CRC_LN1
,

917 
	mC_DC_CRC_LN2
,

918 
	mC_DC_CRC_LN3
,

919 
	mC_DC_CRC_MULT_LN
,

920 
	mC_DC_TX_REPLAY
,

921 
	mC_DC_RX_REPLAY
,

922 
	mC_DC_SEQ_CRC_CNT
,

923 
	mC_DC_ESC0_ONLY_CNT
,

924 
	mC_DC_ESC0_PLUS1_CNT
,

925 
	mC_DC_ESC0_PLUS2_CNT
,

926 
	mC_DC_REINIT_FROM_PEER_CNT
,

927 
	mC_DC_SBE_CNT
,

928 
	mC_DC_MISC_FLG_CNT
,

929 
	mC_DC_PRF_GOOD_LTP_CNT
,

930 
	mC_DC_PRF_ACCEPTED_LTP_CNT
,

931 
	mC_DC_PRF_RX_FLIT_CNT
,

932 
	mC_DC_PRF_TX_FLIT_CNT
,

933 
	mC_DC_PRF_CLK_CNTR
,

934 
	mC_DC_PG_DBG_FLIT_CRDTS_CNT
,

935 
	mC_DC_PG_STS_PAUSE_COMPLETE_CNT
,

936 
	mC_DC_PG_STS_TX_SBE_CNT
,

937 
	mC_DC_PG_STS_TX_MBE_CNT
,

938 
	mC_SW_CPU_INTR
,

939 
	mC_SW_CPU_RCV_LIM
,

940 
	mC_SW_CTX0_SEQ_DROP
,

941 
	mC_SW_VTX_WAIT
,

942 
	mC_SW_PIO_WAIT
,

943 
	mC_SW_PIO_DRAIN
,

944 
	mC_SW_KMEM_WAIT
,

945 
	mC_SW_TID_WAIT
,

946 
	mC_SW_SEND_SCHED
,

947 
	mC_SDMA_DESC_FETCHED_CNT
,

948 
	mC_SDMA_INT_CNT
,

949 
	mC_SDMA_ERR_CNT
,

950 
	mC_SDMA_IDLE_INT_CNT
,

951 
	mC_SDMA_PROGRESS_INT_CNT
,

953 
	mC_MISC_PLL_LOCK_FAIL_ERR
,

954 
	mC_MISC_MBIST_FAIL_ERR
,

955 
	mC_MISC_INVALID_EEP_CMD_ERR
,

956 
	mC_MISC_EFUSE_DONE_PARITY_ERR
,

957 
	mC_MISC_EFUSE_WRITE_ERR
,

958 
	mC_MISC_EFUSE_READ_BAD_ADDR_ERR
,

959 
	mC_MISC_EFUSE_CSR_PARITY_ERR
,

960 
	mC_MISC_FW_AUTH_FAILED_ERR
,

961 
	mC_MISC_KEY_MISMATCH_ERR
,

962 
	mC_MISC_SBUS_WRITE_FAILED_ERR
,

963 
	mC_MISC_CSR_WRITE_BAD_ADDR_ERR
,

964 
	mC_MISC_CSR_READ_BAD_ADDR_ERR
,

965 
	mC_MISC_CSR_PARITY_ERR
,

972 
	mC_CCE_ERR_STATUS_AGGREGATED_CNT
,

973 
	mC_CCE_MSIX_CSR_PARITY_ERR
,

974 
	mC_CCE_INT_MAP_UNC_ERR
,

975 
	mC_CCE_INT_MAP_COR_ERR
,

976 
	mC_CCE_MSIX_TABLE_UNC_ERR
,

977 
	mC_CCE_MSIX_TABLE_COR_ERR
,

978 
	mC_CCE_RXDMA_CONV_FIFO_PARITY_ERR
,

979 
	mC_CCE_RCPL_ASYNC_FIFO_PARITY_ERR
,

980 
	mC_CCE_SEG_WRITE_BAD_ADDR_ERR
,

981 
	mC_CCE_SEG_READ_BAD_ADDR_ERR
,

982 
	mC_LA_TRIGGERED
,

983 
	mC_CCE_TRGT_CPL_TIMEOUT_ERR
,

984 
	mC_PCIC_RECEIVE_PARITY_ERR
,

985 
	mC_PCIC_TRANSMIT_BACK_PARITY_ERR
,

986 
	mC_PCIC_TRANSMIT_FRONT_PARITY_ERR
,

987 
	mC_PCIC_CPL_DAT_Q_UNC_ERR
,

988 
	mC_PCIC_CPL_HD_Q_UNC_ERR
,

989 
	mC_PCIC_POST_DAT_Q_UNC_ERR
,

990 
	mC_PCIC_POST_HD_Q_UNC_ERR
,

991 
	mC_PCIC_RETRY_SOT_MEM_UNC_ERR
,

992 
	mC_PCIC_RETRY_MEM_UNC_ERR
,

993 
	mC_PCIC_N_POST_DAT_Q_PARITY_ERR
,

994 
	mC_PCIC_N_POST_H_Q_PARITY_ERR
,

995 
	mC_PCIC_CPL_DAT_Q_COR_ERR
,

996 
	mC_PCIC_CPL_HD_Q_COR_ERR
,

997 
	mC_PCIC_POST_DAT_Q_COR_ERR
,

998 
	mC_PCIC_POST_HD_Q_COR_ERR
,

999 
	mC_PCIC_RETRY_SOT_MEM_COR_ERR
,

1000 
	mC_PCIC_RETRY_MEM_COR_ERR
,

1001 
	mC_CCE_CLI1_ASYNC_FIFO_DBG_PARITY_ERR
,

1002 
	mC_CCE_CLI1_ASYNC_FIFO_RXDMA_PARITY_ERR
,

1003 
	mC_CCE_CLI1_ASYNC_FIFO_SDMA_HD_PARITY_ERR
,

1004 
	mC_CCE_CLI1_ASYNC_FIFO_PIO_CRDT_PARITY_ERR
,

1005 
	mC_CCE_CLI2_ASYNC_FIFO_PARITY_ERR
,

1006 
	mC_CCE_CSR_CFG_BUS_PARITY_ERR
,

1007 
	mC_CCE_CLI0_ASYNC_FIFO_PARTIY_ERR
,

1008 
	mC_CCE_RSPD_DATA_PARITY_ERR
,

1009 
	mC_CCE_TRGT_ACCESS_ERR
,

1010 
	mC_CCE_TRGT_ASYNC_FIFO_PARITY_ERR
,

1011 
	mC_CCE_CSR_WRITE_BAD_ADDR_ERR
,

1012 
	mC_CCE_CSR_READ_BAD_ADDR_ERR
,

1013 
	mC_CCE_CSR_PARITY_ERR
,

1015 
	mC_RX_CSR_PARITY_ERR
,

1016 
	mC_RX_CSR_WRITE_BAD_ADDR_ERR
,

1017 
	mC_RX_CSR_READ_BAD_ADDR_ERR
,

1018 
	mC_RX_DMA_CSR_UNC_ERR
,

1019 
	mC_RX_DMA_DQ_FSM_ENCODING_ERR
,

1020 
	mC_RX_DMA_EQ_FSM_ENCODING_ERR
,

1021 
	mC_RX_DMA_CSR_PARITY_ERR
,

1022 
	mC_RX_RBUF_DATA_COR_ERR
,

1023 
	mC_RX_RBUF_DATA_UNC_ERR
,

1024 
	mC_RX_DMA_DATA_FIFO_RD_COR_ERR
,

1025 
	mC_RX_DMA_DATA_FIFO_RD_UNC_ERR
,

1026 
	mC_RX_DMA_HDR_FIFO_RD_COR_ERR
,

1027 
	mC_RX_DMA_HDR_FIFO_RD_UNC_ERR
,

1028 
	mC_RX_RBUF_DESC_PART2_COR_ERR
,

1029 
	mC_RX_RBUF_DESC_PART2_UNC_ERR
,

1030 
	mC_RX_RBUF_DESC_PART1_COR_ERR
,

1031 
	mC_RX_RBUF_DESC_PART1_UNC_ERR
,

1032 
	mC_RX_HQ_INTR_FSM_ERR
,

1033 
	mC_RX_HQ_INTR_CSR_PARITY_ERR
,

1034 
	mC_RX_LOOKUP_CSR_PARITY_ERR
,

1035 
	mC_RX_LOOKUP_RCV_ARRAY_COR_ERR
,

1036 
	mC_RX_LOOKUP_RCV_ARRAY_UNC_ERR
,

1037 
	mC_RX_LOOKUP_DES_PART2_PARITY_ERR
,

1038 
	mC_RX_LOOKUP_DES_PART1_UNC_COR_ERR
,

1039 
	mC_RX_LOOKUP_DES_PART1_UNC_ERR
,

1040 
	mC_RX_RBUF_NEXT_FREE_BUF_COR_ERR
,

1041 
	mC_RX_RBUF_NEXT_FREE_BUF_UNC_ERR
,

1042 
	mC_RX_RBUF_FL_INIT_WR_ADDR_PARITY_ERR
,

1043 
	mC_RX_RBUF_FL_INITDONE_PARITY_ERR
,

1044 
	mC_RX_RBUF_FL_WRITE_ADDR_PARITY_ERR
,

1045 
	mC_RX_RBUF_FL_RD_ADDR_PARITY_ERR
,

1046 
	mC_RX_RBUF_EMPTY_ERR
,

1047 
	mC_RX_RBUF_FULL_ERR
,

1048 
	mC_RX_RBUF_BAD_LOOKUP_ERR
,

1049 
	mC_RX_RBUF_CTX_ID_PARITY_ERR
,

1050 
	mC_RX_RBUF_CSR_QEOPDW_PARITY_ERR
,

1051 
	mC_RX_RBUF_CSR_Q_NUM_OF_PKT_PARITY_ERR
,

1052 
	mC_RX_RBUF_CSR_Q_T1_PTR_PARITY_ERR
,

1053 
	mC_RX_RBUF_CSR_Q_HD_PTR_PARITY_ERR
,

1054 
	mC_RX_RBUF_CSR_Q_VLD_BIT_PARITY_ERR
,

1055 
	mC_RX_RBUF_CSR_Q_NEXT_BUF_PARITY_ERR
,

1056 
	mC_RX_RBUF_CSR_Q_ENT_CNT_PARITY_ERR
,

1057 
	mC_RX_RBUF_CSR_Q_HEAD_BUF_NUM_PARITY_ERR
,

1058 
	mC_RX_RBUF_BLOCK_LIST_READ_COR_ERR
,

1059 
	mC_RX_RBUF_BLOCK_LIST_READ_UNC_ERR
,

1060 
	mC_RX_RBUF_LOOKUP_DES_COR_ERR
,

1061 
	mC_RX_RBUF_LOOKUP_DES_UNC_ERR
,

1062 
	mC_RX_RBUF_LOOKUP_DES_REG_UNC_COR_ERR
,

1063 
	mC_RX_RBUF_LOOKUP_DES_REG_UNC_ERR
,

1064 
	mC_RX_RBUF_FREE_LIST_COR_ERR
,

1065 
	mC_RX_RBUF_FREE_LIST_UNC_ERR
,

1066 
	mC_RX_RCV_FSM_ENCODING_ERR
,

1067 
	mC_RX_DMA_FLAG_COR_ERR
,

1068 
	mC_RX_DMA_FLAG_UNC_ERR
,

1069 
	mC_RX_DC_SOP_EOP_PARITY_ERR
,

1070 
	mC_RX_RCV_CSR_PARITY_ERR
,

1071 
	mC_RX_RCV_QP_MAP_TABLE_COR_ERR
,

1072 
	mC_RX_RCV_QP_MAP_TABLE_UNC_ERR
,

1073 
	mC_RX_RCV_DATA_COR_ERR
,

1074 
	mC_RX_RCV_DATA_UNC_ERR
,

1075 
	mC_RX_RCV_HDR_COR_ERR
,

1076 
	mC_RX_RCV_HDR_UNC_ERR
,

1077 
	mC_RX_DC_INTF_PARITY_ERR
,

1078 
	mC_RX_DMA_CSR_COR_ERR
,

1080 
	mC_PIO_PEC_SOP_HEAD_PARITY_ERR
,

1081 
	mC_PIO_PCC_SOP_HEAD_PARITY_ERR
,

1082 
	mC_PIO_LAST_RETURNED_CNT_PARITY_ERR
,

1083 
	mC_PIO_CURRENT_FREE_CNT_PARITY_ERR
,

1084 
	mC_PIO_RSVD_31_ERR
,

1085 
	mC_PIO_RSVD_30_ERR
,

1086 
	mC_PIO_PPMC_SOP_LEN_ERR
,

1087 
	mC_PIO_PPMC_BQC_MEM_PARITY_ERR
,

1088 
	mC_PIO_VL_FIFO_PARITY_ERR
,

1089 
	mC_PIO_VLF_SOP_PARITY_ERR
,

1090 
	mC_PIO_VLF_V1_LEN_PARITY_ERR
,

1091 
	mC_PIO_BLOCK_QW_COUNT_PARITY_ERR
,

1092 
	mC_PIO_WRITE_QW_VALID_PARITY_ERR
,

1093 
	mC_PIO_STATE_MACHINE_ERR
,

1094 
	mC_PIO_WRITE_DATA_PARITY_ERR
,

1095 
	mC_PIO_HOST_ADDR_MEM_COR_ERR
,

1096 
	mC_PIO_HOST_ADDR_MEM_UNC_ERR
,

1097 
	mC_PIO_PKT_EVICT_SM_OR_ARM_SM_ERR
,

1098 
	mC_PIO_INIT_SM_IN_ERR
,

1099 
	mC_PIO_PPMC_PBL_FIFO_ERR
,

1100 
	mC_PIO_CREDIT_RET_FIFO_PARITY_ERR
,

1101 
	mC_PIO_V1_LEN_MEM_BANK1_COR_ERR
,

1102 
	mC_PIO_V1_LEN_MEM_BANK0_COR_ERR
,

1103 
	mC_PIO_V1_LEN_MEM_BANK1_UNC_ERR
,

1104 
	mC_PIO_V1_LEN_MEM_BANK0_UNC_ERR
,

1105 
	mC_PIO_SM_PKT_RESET_PARITY_ERR
,

1106 
	mC_PIO_PKT_EVICT_FIFO_PARITY_ERR
,

1107 
	mC_PIO_SBRDCTRL_CRREL_FIFO_PARITY_ERR
,

1108 
	mC_PIO_SBRDCTL_CRREL_PARITY_ERR
,

1109 
	mC_PIO_PEC_FIFO_PARITY_ERR
,

1110 
	mC_PIO_PCC_FIFO_PARITY_ERR
,

1111 
	mC_PIO_SB_MEM_FIFO1_ERR
,

1112 
	mC_PIO_SB_MEM_FIFO0_ERR
,

1113 
	mC_PIO_CSR_PARITY_ERR
,

1114 
	mC_PIO_WRITE_ADDR_PARITY_ERR
,

1115 
	mC_PIO_WRITE_BAD_CTXT_ERR
,

1117 
	mC_SDMA_PCIE_REQ_TRACKING_COR_ERR
,

1118 
	mC_SDMA_PCIE_REQ_TRACKING_UNC_ERR
,

1119 
	mC_SDMA_CSR_PARITY_ERR
,

1120 
	mC_SDMA_RPY_TAG_ERR
,

1122 
	mC_TX_READ_PIO_MEMORY_CSR_UNC_ERR
,

1123 
	mC_TX_READ_SDMA_MEMORY_CSR_UNC_ERR
,

1124 
	mC_TX_EGRESS_FIFO_COR_ERR
,

1125 
	mC_TX_READ_PIO_MEMORY_COR_ERR
,

1126 
	mC_TX_READ_SDMA_MEMORY_COR_ERR
,

1127 
	mC_TX_SB_HDR_COR_ERR
,

1128 
	mC_TX_CREDIT_OVERRUN_ERR
,

1129 
	mC_TX_LAUNCH_FIFO8_COR_ERR
,

1130 
	mC_TX_LAUNCH_FIFO7_COR_ERR
,

1131 
	mC_TX_LAUNCH_FIFO6_COR_ERR
,

1132 
	mC_TX_LAUNCH_FIFO5_COR_ERR
,

1133 
	mC_TX_LAUNCH_FIFO4_COR_ERR
,

1134 
	mC_TX_LAUNCH_FIFO3_COR_ERR
,

1135 
	mC_TX_LAUNCH_FIFO2_COR_ERR
,

1136 
	mC_TX_LAUNCH_FIFO1_COR_ERR
,

1137 
	mC_TX_LAUNCH_FIFO0_COR_ERR
,

1138 
	mC_TX_CREDIT_RETURN_VL_ERR
,

1139 
	mC_TX_HCRC_INSERTION_ERR
,

1140 
	mC_TX_EGRESS_FIFI_UNC_ERR
,

1141 
	mC_TX_READ_PIO_MEMORY_UNC_ERR
,

1142 
	mC_TX_READ_SDMA_MEMORY_UNC_ERR
,

1143 
	mC_TX_SB_HDR_UNC_ERR
,

1144 
	mC_TX_CREDIT_RETURN_PARITY_ERR
,

1145 
	mC_TX_LAUNCH_FIFO8_UNC_OR_PARITY_ERR
,

1146 
	mC_TX_LAUNCH_FIFO7_UNC_OR_PARITY_ERR
,

1147 
	mC_TX_LAUNCH_FIFO6_UNC_OR_PARITY_ERR
,

1148 
	mC_TX_LAUNCH_FIFO5_UNC_OR_PARITY_ERR
,

1149 
	mC_TX_LAUNCH_FIFO4_UNC_OR_PARITY_ERR
,

1150 
	mC_TX_LAUNCH_FIFO3_UNC_OR_PARITY_ERR
,

1151 
	mC_TX_LAUNCH_FIFO2_UNC_OR_PARITY_ERR
,

1152 
	mC_TX_LAUNCH_FIFO1_UNC_OR_PARITY_ERR
,

1153 
	mC_TX_LAUNCH_FIFO0_UNC_OR_PARITY_ERR
,

1154 
	mC_TX_SDMA15_DISALLOWED_PACKET_ERR
,

1155 
	mC_TX_SDMA14_DISALLOWED_PACKET_ERR
,

1156 
	mC_TX_SDMA13_DISALLOWED_PACKET_ERR
,

1157 
	mC_TX_SDMA12_DISALLOWED_PACKET_ERR
,

1158 
	mC_TX_SDMA11_DISALLOWED_PACKET_ERR
,

1159 
	mC_TX_SDMA10_DISALLOWED_PACKET_ERR
,

1160 
	mC_TX_SDMA9_DISALLOWED_PACKET_ERR
,

1161 
	mC_TX_SDMA8_DISALLOWED_PACKET_ERR
,

1162 
	mC_TX_SDMA7_DISALLOWED_PACKET_ERR
,

1163 
	mC_TX_SDMA6_DISALLOWED_PACKET_ERR
,

1164 
	mC_TX_SDMA5_DISALLOWED_PACKET_ERR
,

1165 
	mC_TX_SDMA4_DISALLOWED_PACKET_ERR
,

1166 
	mC_TX_SDMA3_DISALLOWED_PACKET_ERR
,

1167 
	mC_TX_SDMA2_DISALLOWED_PACKET_ERR
,

1168 
	mC_TX_SDMA1_DISALLOWED_PACKET_ERR
,

1169 
	mC_TX_SDMA0_DISALLOWED_PACKET_ERR
,

1170 
	mC_TX_CONFIG_PARITY_ERR
,

1171 
	mC_TX_SBRD_CTL_CSR_PARITY_ERR
,

1172 
	mC_TX_LAUNCH_CSR_PARITY_ERR
,

1173 
	mC_TX_ILLEGAL_CL_ERR
,

1174 
	mC_TX_SBRD_CTL_STATE_MACHINE_PARITY_ERR
,

1175 
	mC_TX_RESERVED_10
,

1176 
	mC_TX_RESERVED_9
,

1177 
	mC_TX_SDMA_LAUNCH_INTF_PARITY_ERR
,

1178 
	mC_TX_PIO_LAUNCH_INTF_PARITY_ERR
,

1179 
	mC_TX_RESERVED_6
,

1180 
	mC_TX_INCORRECT_LINK_STATE_ERR
,

1181 
	mC_TX_LINK_DOWN_ERR
,

1182 
	mC_TX_EGRESS_FIFO_UNDERRUN_OR_PARITY_ERR
,

1183 
	mC_TX_RESERVED_2
,

1184 
	mC_TX_PKT_INTEGRITY_MEM_UNC_ERR
,

1185 
	mC_TX_PKT_INTEGRITY_MEM_COR_ERR
,

1187 
	mC_SEND_CSR_WRITE_BAD_ADDR_ERR
,

1188 
	mC_SEND_CSR_READ_BAD_ADD_ERR
,

1189 
	mC_SEND_CSR_PARITY_ERR
,

1191 
	mC_PIO_WRITE_OUT_OF_BOUNDS_ERR
,

1192 
	mC_PIO_WRITE_OVERFLOW_ERR
,

1193 
	mC_PIO_WRITE_CROSSES_BOUNDARY_ERR
,

1194 
	mC_PIO_DISALLOWED_PACKET_ERR
,

1195 
	mC_PIO_INCONSISTENT_SOP_ERR
,

1197 
	mC_SDMA_HEADER_REQUEST_FIFO_COR_ERR
,

1198 
	mC_SDMA_HEADER_STORAGE_COR_ERR
,

1199 
	mC_SDMA_PACKET_TRACKING_COR_ERR
,

1200 
	mC_SDMA_ASSEMBLY_COR_ERR
,

1201 
	mC_SDMA_DESC_TABLE_COR_ERR
,

1202 
	mC_SDMA_HEADER_REQUEST_FIFO_UNC_ERR
,

1203 
	mC_SDMA_HEADER_STORAGE_UNC_ERR
,

1204 
	mC_SDMA_PACKET_TRACKING_UNC_ERR
,

1205 
	mC_SDMA_ASSEMBLY_UNC_ERR
,

1206 
	mC_SDMA_DESC_TABLE_UNC_ERR
,

1207 
	mC_SDMA_TIMEOUT_ERR
,

1208 
	mC_SDMA_HEADER_LENGTH_ERR
,

1209 
	mC_SDMA_HEADER_ADDRESS_ERR
,

1210 
	mC_SDMA_HEADER_SELECT_ERR
,

1211 
	mC_SMDA_RESERVED_9
,

1212 
	mC_SDMA_PACKET_DESC_OVERFLOW_ERR
,

1213 
	mC_SDMA_LENGTH_MISMATCH_ERR
,

1214 
	mC_SDMA_HALT_ERR
,

1215 
	mC_SDMA_MEM_READ_ERR
,

1216 
	mC_SDMA_FIRST_DESC_ERR
,

1217 
	mC_SDMA_TAIL_OUT_OF_BOUNDS_ERR
,

1218 
	mC_SDMA_TOO_LONG_ERR
,

1219 
	mC_SDMA_GEN_MISMATCH_ERR
,

1220 
	mC_SDMA_WRONG_DW_ERR
,

1221 
	mDEV_CNTR_LAST


1226 
	mC_TX_UNSUP_VL
 = 0,

1227 
	mC_TX_INVAL_LEN
,

1228 
	mC_TX_MM_LEN_ERR
,

1229 
	mC_TX_UNDERRUN
,

1230 
	mC_TX_FLOW_STALL
,

1231 
	mC_TX_DROPPED
,

1232 
	mC_TX_HDR_ERR
,

1233 
	mC_TX_PKT
,

1234 
	mC_TX_WORDS
,

1235 
	mC_TX_WAIT
,

1236 
	mC_TX_FLIT_VL
,

1237 
	mC_TX_PKT_VL
,

1238 
	mC_TX_WAIT_VL
,

1239 
	mC_RX_PKT
,

1240 
	mC_RX_WORDS
,

1241 
	mC_SW_LINK_DOWN
,

1242 
	mC_SW_LINK_UP
,

1243 
	mC_SW_UNKNOWN_FRAME
,

1244 
	mC_SW_XMIT_DSCD
,

1245 
	mC_SW_XMIT_DSCD_VL
,

1246 
	mC_SW_XMIT_CSTR_ERR
,

1247 
	mC_SW_RCV_CSTR_ERR
,

1248 
	mC_SW_IBP_LOOP_PKTS
,

1249 
	mC_SW_IBP_RC_RESENDS
,

1250 
	mC_SW_IBP_RNR_NAKS
,

1251 
	mC_SW_IBP_OTHER_NAKS
,

1252 
	mC_SW_IBP_RC_TIMEOUTS
,

1253 
	mC_SW_IBP_PKT_DROPS
,

1254 
	mC_SW_IBP_DMA_WAIT
,

1255 
	mC_SW_IBP_RC_SEQNAK
,

1256 
	mC_SW_IBP_RC_DUPREQ
,

1257 
	mC_SW_IBP_RDMA_SEQ
,

1258 
	mC_SW_IBP_UNALIGNED
,

1259 
	mC_SW_IBP_SEQ_NAK
,

1260 
	mC_SW_CPU_RC_ACKS
,

1261 
	mC_SW_CPU_RC_QACKS
,

1262 
	mC_SW_CPU_RC_DELAYED_COMP
,

1263 
	mC_RCV_HDR_OVF_0
,

1264 
	mC_RCV_HDR_OVF_1
,

1265 
	mC_RCV_HDR_OVF_2
,

1266 
	mC_RCV_HDR_OVF_3
,

1267 
	mC_RCV_HDR_OVF_4
,

1268 
	mC_RCV_HDR_OVF_5
,

1269 
	mC_RCV_HDR_OVF_6
,

1270 
	mC_RCV_HDR_OVF_7
,

1271 
	mC_RCV_HDR_OVF_8
,

1272 
	mC_RCV_HDR_OVF_9
,

1273 
	mC_RCV_HDR_OVF_10
,

1274 
	mC_RCV_HDR_OVF_11
,

1275 
	mC_RCV_HDR_OVF_12
,

1276 
	mC_RCV_HDR_OVF_13
,

1277 
	mC_RCV_HDR_OVF_14
,

1278 
	mC_RCV_HDR_OVF_15
,

1279 
	mC_RCV_HDR_OVF_16
,

1280 
	mC_RCV_HDR_OVF_17
,

1281 
	mC_RCV_HDR_OVF_18
,

1282 
	mC_RCV_HDR_OVF_19
,

1283 
	mC_RCV_HDR_OVF_20
,

1284 
	mC_RCV_HDR_OVF_21
,

1285 
	mC_RCV_HDR_OVF_22
,

1286 
	mC_RCV_HDR_OVF_23
,

1287 
	mC_RCV_HDR_OVF_24
,

1288 
	mC_RCV_HDR_OVF_25
,

1289 
	mC_RCV_HDR_OVF_26
,

1290 
	mC_RCV_HDR_OVF_27
,

1291 
	mC_RCV_HDR_OVF_28
,

1292 
	mC_RCV_HDR_OVF_29
,

1293 
	mC_RCV_HDR_OVF_30
,

1294 
	mC_RCV_HDR_OVF_31
,

1295 
	mC_RCV_HDR_OVF_32
,

1296 
	mC_RCV_HDR_OVF_33
,

1297 
	mC_RCV_HDR_OVF_34
,

1298 
	mC_RCV_HDR_OVF_35
,

1299 
	mC_RCV_HDR_OVF_36
,

1300 
	mC_RCV_HDR_OVF_37
,

1301 
	mC_RCV_HDR_OVF_38
,

1302 
	mC_RCV_HDR_OVF_39
,

1303 
	mC_RCV_HDR_OVF_40
,

1304 
	mC_RCV_HDR_OVF_41
,

1305 
	mC_RCV_HDR_OVF_42
,

1306 
	mC_RCV_HDR_OVF_43
,

1307 
	mC_RCV_HDR_OVF_44
,

1308 
	mC_RCV_HDR_OVF_45
,

1309 
	mC_RCV_HDR_OVF_46
,

1310 
	mC_RCV_HDR_OVF_47
,

1311 
	mC_RCV_HDR_OVF_48
,

1312 
	mC_RCV_HDR_OVF_49
,

1313 
	mC_RCV_HDR_OVF_50
,

1314 
	mC_RCV_HDR_OVF_51
,

1315 
	mC_RCV_HDR_OVF_52
,

1316 
	mC_RCV_HDR_OVF_53
,

1317 
	mC_RCV_HDR_OVF_54
,

1318 
	mC_RCV_HDR_OVF_55
,

1319 
	mC_RCV_HDR_OVF_56
,

1320 
	mC_RCV_HDR_OVF_57
,

1321 
	mC_RCV_HDR_OVF_58
,

1322 
	mC_RCV_HDR_OVF_59
,

1323 
	mC_RCV_HDR_OVF_60
,

1324 
	mC_RCV_HDR_OVF_61
,

1325 
	mC_RCV_HDR_OVF_62
,

1326 
	mC_RCV_HDR_OVF_63
,

1327 
	mC_RCV_HDR_OVF_64
,

1328 
	mC_RCV_HDR_OVF_65
,

1329 
	mC_RCV_HDR_OVF_66
,

1330 
	mC_RCV_HDR_OVF_67
,

1331 
	mC_RCV_HDR_OVF_68
,

1332 
	mC_RCV_HDR_OVF_69
,

1333 
	mC_RCV_HDR_OVF_70
,

1334 
	mC_RCV_HDR_OVF_71
,

1335 
	mC_RCV_HDR_OVF_72
,

1336 
	mC_RCV_HDR_OVF_73
,

1337 
	mC_RCV_HDR_OVF_74
,

1338 
	mC_RCV_HDR_OVF_75
,

1339 
	mC_RCV_HDR_OVF_76
,

1340 
	mC_RCV_HDR_OVF_77
,

1341 
	mC_RCV_HDR_OVF_78
,

1342 
	mC_RCV_HDR_OVF_79
,

1343 
	mC_RCV_HDR_OVF_80
,

1344 
	mC_RCV_HDR_OVF_81
,

1345 
	mC_RCV_HDR_OVF_82
,

1346 
	mC_RCV_HDR_OVF_83
,

1347 
	mC_RCV_HDR_OVF_84
,

1348 
	mC_RCV_HDR_OVF_85
,

1349 
	mC_RCV_HDR_OVF_86
,

1350 
	mC_RCV_HDR_OVF_87
,

1351 
	mC_RCV_HDR_OVF_88
,

1352 
	mC_RCV_HDR_OVF_89
,

1353 
	mC_RCV_HDR_OVF_90
,

1354 
	mC_RCV_HDR_OVF_91
,

1355 
	mC_RCV_HDR_OVF_92
,

1356 
	mC_RCV_HDR_OVF_93
,

1357 
	mC_RCV_HDR_OVF_94
,

1358 
	mC_RCV_HDR_OVF_95
,

1359 
	mC_RCV_HDR_OVF_96
,

1360 
	mC_RCV_HDR_OVF_97
,

1361 
	mC_RCV_HDR_OVF_98
,

1362 
	mC_RCV_HDR_OVF_99
,

1363 
	mC_RCV_HDR_OVF_100
,

1364 
	mC_RCV_HDR_OVF_101
,

1365 
	mC_RCV_HDR_OVF_102
,

1366 
	mC_RCV_HDR_OVF_103
,

1367 
	mC_RCV_HDR_OVF_104
,

1368 
	mC_RCV_HDR_OVF_105
,

1369 
	mC_RCV_HDR_OVF_106
,

1370 
	mC_RCV_HDR_OVF_107
,

1371 
	mC_RCV_HDR_OVF_108
,

1372 
	mC_RCV_HDR_OVF_109
,

1373 
	mC_RCV_HDR_OVF_110
,

1374 
	mC_RCV_HDR_OVF_111
,

1375 
	mC_RCV_HDR_OVF_112
,

1376 
	mC_RCV_HDR_OVF_113
,

1377 
	mC_RCV_HDR_OVF_114
,

1378 
	mC_RCV_HDR_OVF_115
,

1379 
	mC_RCV_HDR_OVF_116
,

1380 
	mC_RCV_HDR_OVF_117
,

1381 
	mC_RCV_HDR_OVF_118
,

1382 
	mC_RCV_HDR_OVF_119
,

1383 
	mC_RCV_HDR_OVF_120
,

1384 
	mC_RCV_HDR_OVF_121
,

1385 
	mC_RCV_HDR_OVF_122
,

1386 
	mC_RCV_HDR_OVF_123
,

1387 
	mC_RCV_HDR_OVF_124
,

1388 
	mC_RCV_HDR_OVF_125
,

1389 
	mC_RCV_HDR_OVF_126
,

1390 
	mC_RCV_HDR_OVF_127
,

1391 
	mC_RCV_HDR_OVF_128
,

1392 
	mC_RCV_HDR_OVF_129
,

1393 
	mC_RCV_HDR_OVF_130
,

1394 
	mC_RCV_HDR_OVF_131
,

1395 
	mC_RCV_HDR_OVF_132
,

1396 
	mC_RCV_HDR_OVF_133
,

1397 
	mC_RCV_HDR_OVF_134
,

1398 
	mC_RCV_HDR_OVF_135
,

1399 
	mC_RCV_HDR_OVF_136
,

1400 
	mC_RCV_HDR_OVF_137
,

1401 
	mC_RCV_HDR_OVF_138
,

1402 
	mC_RCV_HDR_OVF_139
,

1403 
	mC_RCV_HDR_OVF_140
,

1404 
	mC_RCV_HDR_OVF_141
,

1405 
	mC_RCV_HDR_OVF_142
,

1406 
	mC_RCV_HDR_OVF_143
,

1407 
	mC_RCV_HDR_OVF_144
,

1408 
	mC_RCV_HDR_OVF_145
,

1409 
	mC_RCV_HDR_OVF_146
,

1410 
	mC_RCV_HDR_OVF_147
,

1411 
	mC_RCV_HDR_OVF_148
,

1412 
	mC_RCV_HDR_OVF_149
,

1413 
	mC_RCV_HDR_OVF_150
,

1414 
	mC_RCV_HDR_OVF_151
,

1415 
	mC_RCV_HDR_OVF_152
,

1416 
	mC_RCV_HDR_OVF_153
,

1417 
	mC_RCV_HDR_OVF_154
,

1418 
	mC_RCV_HDR_OVF_155
,

1419 
	mC_RCV_HDR_OVF_156
,

1420 
	mC_RCV_HDR_OVF_157
,

1421 
	mC_RCV_HDR_OVF_158
,

1422 
	mC_RCV_HDR_OVF_159
,

1423 
	mPORT_CNTR_LAST


1426 
u64
 
g‘_®l_ýu_tÙ®
(u64 
__³rýu
 *
úŒ
);

1427 
hfi1_¡¬t_þ—nup
(
hfi1_devd©a
 *
dd
);

1428 
hfi1_þ—r_tids
(
hfi1_ùxtd©a
 *
rcd
);

1429 
hfi1_š™_ùxt
(
£nd_cÚ‹xt
 *
sc
);

1430 
hfi1_put_tid
(
hfi1_devd©a
 *
dd
, 
u32
 
šdex
,

1431 
u32
 
ty³
, 
·
, 
u16
 
Üd”
);

1432 
hfi1_qu›t_£rdes
(
hfi1_µÜtd©a
 *
µd
);

1433 
hfi1_rcvù¾
(
hfi1_devd©a
 *
dd
, 
Ý
,

1434 
hfi1_ùxtd©a
 *
rcd
);

1435 
u32
 
hfi1_»ad_úŒs
(
hfi1_devd©a
 *
dd
, **
Çm•
, 
u64
 **
úŒp
);

1436 
u32
 
hfi1_»ad_pÜtúŒs
(
hfi1_µÜtd©a
 *
µd
, **
Çm•
, 
u64
 **
úŒp
);

1437 
hfi1_g‘_ib_cfg
(
hfi1_µÜtd©a
 *
µd
, 
which
);

1438 
hfi1_£t_ib_cfg
(
hfi1_µÜtd©a
 *
µd
, 
which
, 
u32
 
v®
);

1439 
hfi1_£t_ùxt_jkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
,

1440 
u16
 
jkey
);

1441 
hfi1_þ—r_ùxt_jkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
ùxt
);

1442 
hfi1_£t_ùxt_pkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
ùxt
,

1443 
u16
 
pkey
);

1444 
hfi1_þ—r_ùxt_pkey
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
ùxt
);

1445 
hfi1_»ad_lšk_qu®™y
(
hfi1_devd©a
 *
dd
, 
u8
 *
lšk_qu®™y
);

1446 
hfi1_š™_vnic_rsm
(
hfi1_devd©a
 *
dd
);

1447 
hfi1_deš™_vnic_rsm
(
hfi1_devd©a
 *
dd
);

1449 
hfi1_š™_a_rsm
(
hfi1_devd©a
 *
dd
);

1450 
hfi1_deš™_a_rsm
(
hfi1_devd©a
 *
dd
);

1451 
œq»tuº_t
 
g’”®_š‹¼u±
(
œq
, *
d©a
);

1452 
œq»tuº_t
 
sdma_š‹¼u±
(
œq
, *
d©a
);

1453 
œq»tuº_t
 
»ûive_cÚ‹xt_š‹¼u±
(
œq
, *
d©a
);

1454 
œq»tuº_t
 
»ûive_cÚ‹xt_th»ad
(
œq
, *
d©a
);

1455 
œq»tuº_t
 
»ûive_cÚ‹xt_š‹¼u±_Çpi
(
œq
, *
d©a
);

1457 
£t_šŒ_b™s
(
hfi1_devd©a
 *
dd
, 
u16
 
fœ¡
, u16 
Ï¡
, 
boÞ
 
£t
);

1458 
š™_qså_št
(
hfi1_devd©a
 *
dd
);

1459 
þ—r_®l_š‹¼u±s
(
hfi1_devd©a
 *
dd
);

1460 
»m­_šŒ
(
hfi1_devd©a
 *
dd
, 
i¤c
, 
msix_šŒ
);

1461 
»m­_sdma_š‹¼u±s
(
hfi1_devd©a
 *
dd
, 
’gše
, 
msix_šŒ
);

1462 
»£t_š‹¼u±s
(
hfi1_devd©a
 *
dd
);

1463 
u8
 
hfi1_g‘_qp_m­
(
hfi1_devd©a
 *
dd
, u8 
idx
);

1471 
	sis_bË
 {

1472 
	m¡¬t
;

1473 
	m’d
;

1475 *(*
	mis_Çme
)(*
	mÇme
, 
size_t
 
	msize
, 
	msourû
);

1477 (*
	mis_št
)(
hfi1_devd©a
 *
	mdd
, 
	msourû
);

	@chip_registers.h

1 #iâdeà
DEF_CHIP_REG


2 
	#DEF_CHIP_REG


	)

51 
	#CORE
 0x000000000000

	)

52 
	#CCE
 (
CORE
 + 0x000000000000)

	)

53 
	#ASIC
 (
CORE
 + 0x000000400000)

	)

54 
	#MISC
 (
CORE
 + 0x000000500000)

	)

55 
	#DC_TOP_CSRS
 (
CORE
 + 0x000000600000)

	)

56 
	#CHIP_DEBUG
 (
CORE
 + 0x000000700000)

	)

57 
	#RXE
 (
CORE
 + 0x000001000000)

	)

58 
	#TXE
 (
CORE
 + 0x000001800000)

	)

59 
	#DCC_CSRS
 (
DC_TOP_CSRS
 + 0x000000000000)

	)

60 
	#DC_LCB_CSRS
 (
DC_TOP_CSRS
 + 0x000000001000)

	)

61 
	#DC_8051_CSRS
 (
DC_TOP_CSRS
 + 0x000000002000)

	)

62 
	#PCIE
 0

	)

64 
	#ASIC_NUM_SCRATCH
 4

	)

65 
	#CCE_ERR_INT_CNT
 0

	)

66 
	#CCE_MISC_INT_CNT
 2

	)

67 
	#CCE_NUM_32_BIT_COUNTERS
 3

	)

68 
	#CCE_NUM_32_BIT_INT_COUNTERS
 6

	)

69 
	#CCE_NUM_INT_CSRS
 12

	)

70 
	#CCE_NUM_INT_MAP_CSRS
 96

	)

71 
	#CCE_NUM_MSIX_PBAS
 4

	)

72 
	#CCE_NUM_MSIX_VECTORS
 256

	)

73 
	#CCE_NUM_SCRATCH
 4

	)

74 
	#CCE_PCIE_POSTED_CRDT_STALL_CNT
 2

	)

75 
	#CCE_PCIE_TRGT_STALL_CNT
 0

	)

76 
	#CCE_PIO_WR_STALL_CNT
 1

	)

77 
	#CCE_RCV_AVAIL_INT_CNT
 3

	)

78 
	#CCE_RCV_URGENT_INT_CNT
 4

	)

79 
	#CCE_SDMA_INT_CNT
 1

	)

80 
	#CCE_SEND_CREDIT_INT_CNT
 5

	)

81 
	#DCC_CFG_LED_CNTRL
 (
DCC_CSRS
 + 0x000000000040)

	)

82 
	#DCC_CFG_LED_CNTRL_LED_CNTRL_SMASK
 0x10uÎ

	)

83 
	#DCC_CFG_LED_CNTRL_LED_SW_BLINK_RATE_SHIFT
 0

	)

84 
	#DCC_CFG_LED_CNTRL_LED_SW_BLINK_RATE_SMASK
 0xFuÎ

	)

85 
	#DCC_CFG_PORT_CONFIG
 (
DCC_CSRS
 + 0x000000000008)

	)

86 
	#DCC_CFG_PORT_CONFIG1
 (
DCC_CSRS
 + 0x000000000010)

	)

87 
	#DCC_CFG_PORT_CONFIG1_DLID_MASK_MASK
 0xFFFFuÎ

	)

88 
	#DCC_CFG_PORT_CONFIG1_DLID_MASK_SHIFT
 16

	)

89 
	#DCC_CFG_PORT_CONFIG1_DLID_MASK_SMASK
 0xFFFF0000uÎ

	)

90 
	#DCC_CFG_PORT_CONFIG1_TARGET_DLID_MASK
 0xFFFFuÎ

	)

91 
	#DCC_CFG_PORT_CONFIG1_TARGET_DLID_SHIFT
 0

	)

92 
	#DCC_CFG_PORT_CONFIG1_TARGET_DLID_SMASK
 0xFFFFuÎ

	)

93 
	#DCC_CFG_PORT_CONFIG_LINK_STATE_MASK
 0x7uÎ

	)

94 
	#DCC_CFG_PORT_CONFIG_LINK_STATE_SHIFT
 48

	)

95 
	#DCC_CFG_PORT_CONFIG_LINK_STATE_SMASK
 0x7000000000000uÎ

	)

96 
	#DCC_CFG_PORT_CONFIG_MTU_CAP_MASK
 0x7uÎ

	)

97 
	#DCC_CFG_PORT_CONFIG_MTU_CAP_SHIFT
 32

	)

98 
	#DCC_CFG_PORT_CONFIG_MTU_CAP_SMASK
 0x700000000uÎ

	)

99 
	#DCC_CFG_RESET
 (
DCC_CSRS
 + 0x000000000000)

	)

100 
	#DCC_CFG_RESET_RESET_LCB
 
	`BIT_ULL
(0)

	)

101 
	#DCC_CFG_RESET_RESET_TX_FPE
 
	`BIT_ULL
(1)

	)

102 
	#DCC_CFG_RESET_RESET_RX_FPE
 
	`BIT_ULL
(2)

	)

103 
	#DCC_CFG_RESET_RESET_8051
 
	`BIT_ULL
(3)

	)

104 
	#DCC_CFG_RESET_ENABLE_CCLK_BCC
 
	`BIT_ULL
(4)

	)

105 
	#DCC_CFG_SC_VL_TABLE_15_0
 (
DCC_CSRS
 + 0x000000000028)

	)

106 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY0_SHIFT
 0

	)

107 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY10_SHIFT
 40

	)

108 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY11_SHIFT
 44

	)

109 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY12_SHIFT
 48

	)

110 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY13_SHIFT
 52

	)

111 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY14_SHIFT
 56

	)

112 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY15_SHIFT
 60

	)

113 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY1_SHIFT
 4

	)

114 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY2_SHIFT
 8

	)

115 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY3_SHIFT
 12

	)

116 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY4_SHIFT
 16

	)

117 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY5_SHIFT
 20

	)

118 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY6_SHIFT
 24

	)

119 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY7_SHIFT
 28

	)

120 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY8_SHIFT
 32

	)

121 
	#DCC_CFG_SC_VL_TABLE_15_0_ENTRY9_SHIFT
 36

	)

122 
	#DCC_CFG_SC_VL_TABLE_31_16
 (
DCC_CSRS
 + 0x000000000030)

	)

123 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY16_SHIFT
 0

	)

124 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY17_SHIFT
 4

	)

125 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY18_SHIFT
 8

	)

126 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY19_SHIFT
 12

	)

127 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY20_SHIFT
 16

	)

128 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY21_SHIFT
 20

	)

129 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY22_SHIFT
 24

	)

130 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY23_SHIFT
 28

	)

131 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY24_SHIFT
 32

	)

132 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY25_SHIFT
 36

	)

133 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY26_SHIFT
 40

	)

134 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY27_SHIFT
 44

	)

135 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY28_SHIFT
 48

	)

136 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY29_SHIFT
 52

	)

137 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY30_SHIFT
 56

	)

138 
	#DCC_CFG_SC_VL_TABLE_31_16_ENTRY31_SHIFT
 60

	)

139 
	#DCC_ERR_DROPPED_PKT_CNT
 (
DCC_CSRS
 + 0x000000000120)

	)

140 
	#DCC_ERR_FLG
 (
DCC_CSRS
 + 0x000000000050)

	)

141 
	#DCC_ERR_FLG_BAD_CRDT_ACK_ERR_SMASK
 0x4000uÎ

	)

142 
	#DCC_ERR_FLG_BAD_CTRL_DIST_ERR_SMASK
 0x200000uÎ

	)

143 
	#DCC_ERR_FLG_BAD_CTRL_FLIT_ERR_SMASK
 0x10000uÎ

	)

144 
	#DCC_ERR_FLG_BAD_DLID_TARGET_ERR_SMASK
 0x200uÎ

	)

145 
	#DCC_ERR_FLG_BAD_HEAD_DIST_ERR_SMASK
 0x800000uÎ

	)

146 
	#DCC_ERR_FLG_BAD_L2_ERR_SMASK
 0x2uÎ

	)

147 
	#DCC_ERR_FLG_BAD_LVER_ERR_SMASK
 0x400uÎ

	)

148 
	#DCC_ERR_FLG_BAD_MID_TAIL_ERR_SMASK
 0x8uÎ

	)

149 
	#DCC_ERR_FLG_BAD_PKT_LENGTH_ERR_SMASK
 0x4000000uÎ

	)

150 
	#DCC_ERR_FLG_BAD_PREEMPTION_ERR_SMASK
 0x10uÎ

	)

151 
	#DCC_ERR_FLG_BAD_SC_ERR_SMASK
 0x4uÎ

	)

152 
	#DCC_ERR_FLG_BAD_TAIL_DIST_ERR_SMASK
 0x400000uÎ

	)

153 
	#DCC_ERR_FLG_BAD_VL_MARKER_ERR_SMASK
 0x80uÎ

	)

154 
	#DCC_ERR_FLG_CLR
 (
DCC_CSRS
 + 0x000000000060)

	)

155 
	#DCC_ERR_FLG_CSR_ACCESS_BLOCKED_HOST_SMASK
 0x8000000000uÎ

	)

156 
	#DCC_ERR_FLG_CSR_ACCESS_BLOCKED_UC_SMASK
 0x10000000000uÎ

	)

157 
	#DCC_ERR_FLG_CSR_INVAL_ADDR_SMASK
 0x400000000000uÎ

	)

158 
	#DCC_ERR_FLG_CSR_PARITY_ERR_SMASK
 0x200000000000uÎ

	)

159 
	#DCC_ERR_FLG_DLID_ZERO_ERR_SMASK
 0x40000000uÎ

	)

160 
	#DCC_ERR_FLG_EN
 (
DCC_CSRS
 + 0x000000000058)

	)

161 
	#DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_HOST_SMASK
 0x8000000000uÎ

	)

162 
	#DCC_ERR_FLG_EN_CSR_ACCESS_BLOCKED_UC_SMASK
 0x10000000000uÎ

	)

163 
	#DCC_ERR_FLG_EVENT_CNTR_PARITY_ERR_SMASK
 0x20000uÎ

	)

164 
	#DCC_ERR_FLG_EVENT_CNTR_ROLLOVER_ERR_SMASK
 0x40000uÎ

	)

165 
	#DCC_ERR_FLG_FMCONFIG_ERR_SMASK
 0x40000000000000uÎ

	)

166 
	#DCC_ERR_FLG_FPE_TX_FIFO_OVFLW_ERR_SMASK
 0x2000000000uÎ

	)

167 
	#DCC_ERR_FLG_FPE_TX_FIFO_UNFLW_ERR_SMASK
 0x4000000000uÎ

	)

168 
	#DCC_ERR_FLG_LATE_EBP_ERR_SMASK
 0x1000000000uÎ

	)

169 
	#DCC_ERR_FLG_LATE_LONG_ERR_SMASK
 0x800000000uÎ

	)

170 
	#DCC_ERR_FLG_LATE_SHORT_ERR_SMASK
 0x400000000uÎ

	)

171 
	#DCC_ERR_FLG_LENGTH_MTU_ERR_SMASK
 0x80000000uÎ

	)

172 
	#DCC_ERR_FLG_LINK_ERR_SMASK
 0x80000uÎ

	)

173 
	#DCC_ERR_FLG_MISC_CNTR_ROLLOVER_ERR_SMASK
 0x100000uÎ

	)

174 
	#DCC_ERR_FLG_NONVL15_STATE_ERR_SMASK
 0x1000000uÎ

	)

175 
	#DCC_ERR_FLG_PERM_NVL15_ERR_SMASK
 0x10000000uÎ

	)

176 
	#DCC_ERR_FLG_PREEMPTION_ERR_SMASK
 0x20uÎ

	)

177 
	#DCC_ERR_FLG_PREEMPTIONVL15_ERR_SMASK
 0x40uÎ

	)

178 
	#DCC_ERR_FLG_RCVPORT_ERR_SMASK
 0x80000000000000uÎ

	)

179 
	#DCC_ERR_FLG_RX_BYTE_SHFT_PARITY_ERR_SMASK
 0x1000000000000uÎ

	)

180 
	#DCC_ERR_FLG_RX_CTRL_PARITY_MBE_ERR_SMASK
 0x100000000000uÎ

	)

181 
	#DCC_ERR_FLG_RX_EARLY_DROP_ERR_SMASK
 0x200000000uÎ

	)

182 
	#DCC_ERR_FLG_SLID_ZERO_ERR_SMASK
 0x20000000uÎ

	)

183 
	#DCC_ERR_FLG_TX_BYTE_SHFT_PARITY_ERR_SMASK
 0x800000000000uÎ

	)

184 
	#DCC_ERR_FLG_TX_CTRL_PARITY_ERR_SMASK
 0x20000000000uÎ

	)

185 
	#DCC_ERR_FLG_TX_CTRL_PARITY_MBE_ERR_SMASK
 0x40000000000uÎ

	)

186 
	#DCC_ERR_FLG_TX_SC_PARITY_ERR_SMASK
 0x80000000000uÎ

	)

187 
	#DCC_ERR_FLG_UNCORRECTABLE_ERR_SMASK
 0x2000uÎ

	)

188 
	#DCC_ERR_FLG_UNSUP_PKT_TYPE_SMASK
 0x8000uÎ

	)

189 
	#DCC_ERR_FLG_UNSUP_VL_ERR_SMASK
 0x8000000uÎ

	)

190 
	#DCC_ERR_FLG_VL15_MULTI_ERR_SMASK
 0x2000000uÎ

	)

191 
	#DCC_ERR_FMCONFIG_ERR_CNT
 (
DCC_CSRS
 + 0x000000000110)

	)

192 
	#DCC_ERR_INFO_FMCONFIG
 (
DCC_CSRS
 + 0x000000000090)

	)

193 
	#DCC_ERR_INFO_PORTRCV
 (
DCC_CSRS
 + 0x000000000078)

	)

194 
	#DCC_ERR_INFO_PORTRCV_HDR0
 (
DCC_CSRS
 + 0x000000000080)

	)

195 
	#DCC_ERR_INFO_PORTRCV_HDR1
 (
DCC_CSRS
 + 0x000000000088)

	)

196 
	#DCC_ERR_INFO_UNCORRECTABLE
 (
DCC_CSRS
 + 0x000000000098)

	)

197 
	#DCC_ERR_PORTRCV_ERR_CNT
 (
DCC_CSRS
 + 0x000000000108)

	)

198 
	#DCC_ERR_RCVREMOTE_PHY_ERR_CNT
 (
DCC_CSRS
 + 0x000000000118)

	)

199 
	#DCC_ERR_UNCORRECTABLE_CNT
 (
DCC_CSRS
 + 0x000000000100)

	)

200 
	#DCC_PRF_PORT_MARK_FECN_CNT
 (
DCC_CSRS
 + 0x000000000330)

	)

201 
	#DCC_PRF_PORT_RCV_BECN_CNT
 (
DCC_CSRS
 + 0x000000000290)

	)

202 
	#DCC_PRF_PORT_RCV_BUBBLE_CNT
 (
DCC_CSRS
 + 0x0000000002E0)

	)

203 
	#DCC_PRF_PORT_RCV_CORRECTABLE_CNT
 (
DCC_CSRS
 + 0x000000000140)

	)

204 
	#DCC_PRF_PORT_RCV_DATA_CNT
 (
DCC_CSRS
 + 0x000000000198)

	)

205 
	#DCC_PRF_PORT_RCV_FECN_CNT
 (
DCC_CSRS
 + 0x000000000240)

	)

206 
	#DCC_PRF_PORT_RCV_MULTICAST_PKT_CNT
 (
DCC_CSRS
 + 0x000000000130)

	)

207 
	#DCC_PRF_PORT_RCV_PKTS_CNT
 (
DCC_CSRS
 + 0x0000000001A8)

	)

208 
	#DCC_PRF_PORT_VL_MARK_FECN_CNT
 (
DCC_CSRS
 + 0x000000000338)

	)

209 
	#DCC_PRF_PORT_VL_RCV_BECN_CNT
 (
DCC_CSRS
 + 0x000000000298)

	)

210 
	#DCC_PRF_PORT_VL_RCV_BUBBLE_CNT
 (
DCC_CSRS
 + 0x0000000002E8)

	)

211 
	#DCC_PRF_PORT_VL_RCV_DATA_CNT
 (
DCC_CSRS
 + 0x0000000001B0)

	)

212 
	#DCC_PRF_PORT_VL_RCV_FECN_CNT
 (
DCC_CSRS
 + 0x000000000248)

	)

213 
	#DCC_PRF_PORT_VL_RCV_PKTS_CNT
 (
DCC_CSRS
 + 0x0000000001F8)

	)

214 
	#DCC_PRF_PORT_XMIT_CORRECTABLE_CNT
 (
DCC_CSRS
 + 0x000000000138)

	)

215 
	#DCC_PRF_PORT_XMIT_DATA_CNT
 (
DCC_CSRS
 + 0x000000000190)

	)

216 
	#DCC_PRF_PORT_XMIT_MULTICAST_CNT
 (
DCC_CSRS
 + 0x000000000128)

	)

217 
	#DCC_PRF_PORT_XMIT_PKTS_CNT
 (
DCC_CSRS
 + 0x0000000001A0)

	)

218 
	#DCC_PRF_RX_FLOW_CRTL_CNT
 (
DCC_CSRS
 + 0x000000000180)

	)

219 
	#DCC_PRF_TX_FLOW_CRTL_CNT
 (
DCC_CSRS
 + 0x000000000188)

	)

220 
	#DC_DC8051_CFG_CSR_ACCESS_SEL
 (
DC_8051_CSRS
 + 0x000000000110)

	)

221 
	#DC_DC8051_CFG_CSR_ACCESS_SEL_DCC_SMASK
 0x2uÎ

	)

222 
	#DC_DC8051_CFG_CSR_ACCESS_SEL_LCB_SMASK
 0x1uÎ

	)

223 
	#DC_DC8051_CFG_EXT_DEV_0
 (
DC_8051_CSRS
 + 0x000000000118)

	)

224 
	#DC_DC8051_CFG_EXT_DEV_0_COMPLETED_SMASK
 0x1uÎ

	)

225 
	#DC_DC8051_CFG_EXT_DEV_0_RETURN_CODE_SHIFT
 8

	)

226 
	#DC_DC8051_CFG_EXT_DEV_0_RSP_DATA_SHIFT
 16

	)

227 
	#DC_DC8051_CFG_EXT_DEV_1
 (
DC_8051_CSRS
 + 0x000000000120)

	)

228 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_MASK
 0xFFFFuÎ

	)

229 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_SHIFT
 16

	)

230 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_DATA_SMASK
 0xFFFF0000uÎ

	)

231 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_NEW_SMASK
 0x1uÎ

	)

232 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_TYPE_MASK
 0xFFuÎ

	)

233 
	#DC_DC8051_CFG_EXT_DEV_1_REQ_TYPE_SHIFT
 8

	)

234 
	#DC_DC8051_CFG_HOST_CMD_0
 (
DC_8051_CSRS
 + 0x000000000028)

	)

235 
	#DC_DC8051_CFG_HOST_CMD_0_REQ_DATA_MASK
 0xFFFFFFFFFFFFuÎ

	)

236 
	#DC_DC8051_CFG_HOST_CMD_0_REQ_DATA_SHIFT
 16

	)

237 
	#DC_DC8051_CFG_HOST_CMD_0_REQ_NEW_SMASK
 0x1uÎ

	)

238 
	#DC_DC8051_CFG_HOST_CMD_0_REQ_TYPE_MASK
 0xFFuÎ

	)

239 
	#DC_DC8051_CFG_HOST_CMD_0_REQ_TYPE_SHIFT
 8

	)

240 
	#DC_DC8051_CFG_HOST_CMD_1
 (
DC_8051_CSRS
 + 0x000000000030)

	)

241 
	#DC_DC8051_CFG_HOST_CMD_1_COMPLETED_SMASK
 0x1uÎ

	)

242 
	#DC_DC8051_CFG_HOST_CMD_1_RETURN_CODE_MASK
 0xFFuÎ

	)

243 
	#DC_DC8051_CFG_HOST_CMD_1_RETURN_CODE_SHIFT
 8

	)

244 
	#DC_DC8051_CFG_HOST_CMD_1_RSP_DATA_MASK
 0xFFFFFFFFFFFFuÎ

	)

245 
	#DC_DC8051_CFG_HOST_CMD_1_RSP_DATA_SHIFT
 16

	)

246 
	#DC_DC8051_CFG_LOCAL_GUID
 (
DC_8051_CSRS
 + 0x000000000038)

	)

247 
	#DC_DC8051_CFG_MODE
 (
DC_8051_CSRS
 + 0x000000000070)

	)

248 
	#DC_DC8051_CFG_RAM_ACCESS_CTRL
 (
DC_8051_CSRS
 + 0x000000000008)

	)

249 
	#DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_MASK
 0x7FFFuÎ

	)

250 
	#DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_SHIFT
 0

	)

251 
	#DC_DC8051_CFG_RAM_ACCESS_CTRL_WRITE_ENA_SMASK
 0x1000000uÎ

	)

252 
	#DC_DC8051_CFG_RAM_ACCESS_CTRL_READ_ENA_SMASK
 0x10000uÎ

	)

253 
	#DC_DC8051_CFG_RAM_ACCESS_SETUP
 (
DC_8051_CSRS
 + 0x000000000000)

	)

254 
	#DC_DC8051_CFG_RAM_ACCESS_SETUP_AUTO_INCR_ADDR_SMASK
 0x100uÎ

	)

255 
	#DC_DC8051_CFG_RAM_ACCESS_SETUP_RAM_SEL_SMASK
 0x1uÎ

	)

256 
	#DC_DC8051_CFG_RAM_ACCESS_STATUS
 (
DC_8051_CSRS
 + 0x000000000018)

	)

257 
	#DC_DC8051_CFG_RAM_ACCESS_STATUS_ACCESS_COMPLETED_SMASK
 0x10000uÎ

	)

258 
	#DC_DC8051_CFG_RAM_ACCESS_WR_DATA
 (
DC_8051_CSRS
 + 0x000000000010)

	)

259 
	#DC_DC8051_CFG_RAM_ACCESS_RD_DATA
 (
DC_8051_CSRS
 + 0x000000000020)

	)

260 
	#DC_DC8051_CFG_RST
 (
DC_8051_CSRS
 + 0x000000000068)

	)

261 
	#DC_DC8051_CFG_RST_CRAM_SMASK
 0x2uÎ

	)

262 
	#DC_DC8051_CFG_RST_DRAM_SMASK
 0x4uÎ

	)

263 
	#DC_DC8051_CFG_RST_IRAM_SMASK
 0x8uÎ

	)

264 
	#DC_DC8051_CFG_RST_M8051W_SMASK
 0x1uÎ

	)

265 
	#DC_DC8051_CFG_RST_SFR_SMASK
 0x10uÎ

	)

266 
	#DC_DC8051_DBG_ERR_INFO_SET_BY_8051
 (
DC_8051_CSRS
 + 0x0000000000D8)

	)

267 
	#DC_DC8051_DBG_ERR_INFO_SET_BY_8051_ERROR_MASK
 0xFFFFFFFFuÎ

	)

268 
	#DC_DC8051_DBG_ERR_INFO_SET_BY_8051_ERROR_SHIFT
 16

	)

269 
	#DC_DC8051_DBG_ERR_INFO_SET_BY_8051_HOST_MSG_MASK
 0xFFFFuÎ

	)

270 
	#DC_DC8051_DBG_ERR_INFO_SET_BY_8051_HOST_MSG_SHIFT
 0

	)

271 
	#DC_DC8051_ERR_CLR
 (
DC_8051_CSRS
 + 0x0000000000E8)

	)

272 
	#DC_DC8051_ERR_EN
 (
DC_8051_CSRS
 + 0x0000000000F0)

	)

273 
	#DC_DC8051_ERR_EN_LOST_8051_HEART_BEAT_SMASK
 0x2uÎ

	)

274 
	#DC_DC8051_ERR_FLG
 (
DC_8051_CSRS
 + 0x0000000000E0)

	)

275 
	#DC_DC8051_ERR_FLG_CRAM_MBE_SMASK
 0x4uÎ

	)

276 
	#DC_DC8051_ERR_FLG_CRAM_SBE_SMASK
 0x8uÎ

	)

277 
	#DC_DC8051_ERR_FLG_DRAM_MBE_SMASK
 0x10uÎ

	)

278 
	#DC_DC8051_ERR_FLG_DRAM_SBE_SMASK
 0x20uÎ

	)

279 
	#DC_DC8051_ERR_FLG_INVALID_CSR_ADDR_SMASK
 0x400uÎ

	)

280 
	#DC_DC8051_ERR_FLG_IRAM_MBE_SMASK
 0x40uÎ

	)

281 
	#DC_DC8051_ERR_FLG_IRAM_SBE_SMASK
 0x80uÎ

	)

282 
	#DC_DC8051_ERR_FLG_LOST_8051_HEART_BEAT_SMASK
 0x2uÎ

	)

283 
	#DC_DC8051_ERR_FLG_SET_BY_8051_SMASK
 0x1uÎ

	)

284 
	#DC_DC8051_ERR_FLG_UNMATCHED_SECURE_MSG_ACROSS_BCC_LANES_SMASK
 0x100uÎ

	)

285 
	#DC_DC8051_STS_CUR_STATE
 (
DC_8051_CSRS
 + 0x000000000060)

	)

286 
	#DC_DC8051_STS_CUR_STATE_FIRMWARE_MASK
 0xFFuÎ

	)

287 
	#DC_DC8051_STS_CUR_STATE_FIRMWARE_SHIFT
 16

	)

288 
	#DC_DC8051_STS_CUR_STATE_PORT_MASK
 0xFFuÎ

	)

289 
	#DC_DC8051_STS_CUR_STATE_PORT_SHIFT
 0

	)

290 
	#DC_DC8051_STS_LOCAL_FM_SECURITY
 (
DC_8051_CSRS
 + 0x000000000050)

	)

291 
	#DC_DC8051_STS_LOCAL_FM_SECURITY_DISABLED_MASK
 0x1uÎ

	)

292 
	#DC_DC8051_STS_REMOTE_FM_SECURITY
 (
DC_8051_CSRS
 + 0x000000000058)

	)

293 
	#DC_DC8051_STS_REMOTE_GUID
 (
DC_8051_CSRS
 + 0x000000000040)

	)

294 
	#DC_DC8051_STS_REMOTE_NODE_TYPE
 (
DC_8051_CSRS
 + 0x000000000048)

	)

295 
	#DC_DC8051_STS_REMOTE_NODE_TYPE_VAL_MASK
 0x3uÎ

	)

296 
	#DC_DC8051_STS_REMOTE_PORT_NO
 (
DC_8051_CSRS
 + 0x000000000130)

	)

297 
	#DC_DC8051_STS_REMOTE_PORT_NO_VAL_SMASK
 0xFFuÎ

	)

298 
	#DC_LCB_CFG_ALLOW_LINK_UP
 (
DC_LCB_CSRS
 + 0x000000000128)

	)

299 
	#DC_LCB_CFG_ALLOW_LINK_UP_VAL_SHIFT
 0

	)

300 
	#DC_LCB_CFG_CRC_MODE
 (
DC_LCB_CSRS
 + 0x000000000058)

	)

301 
	#DC_LCB_CFG_CRC_MODE_TX_VAL_SHIFT
 0

	)

302 
	#DC_LCB_CFG_IGNORE_LOST_RCLK
 (
DC_LCB_CSRS
 + 0x000000000020)

	)

303 
	#DC_LCB_CFG_IGNORE_LOST_RCLK_EN_SMASK
 0x1uÎ

	)

304 
	#DC_LCB_CFG_LANE_WIDTH
 (
DC_LCB_CSRS
 + 0x000000000100)

	)

305 
	#DC_LCB_CFG_LINK_KILL_EN
 (
DC_LCB_CSRS
 + 0x000000000120)

	)

306 
	#DC_LCB_CFG_LINK_KILL_EN_FLIT_INPUT_BUF_MBE_SMASK
 0x100000uÎ

	)

307 
	#DC_LCB_CFG_LINK_KILL_EN_REPLAY_BUF_MBE_SMASK
 0x400000uÎ

	)

308 
	#DC_LCB_CFG_LN_DCLK
 (
DC_LCB_CSRS
 + 0x000000000060)

	)

309 
	#DC_LCB_CFG_LOOPBACK
 (
DC_LCB_CSRS
 + 0x0000000000F8)

	)

310 
	#DC_LCB_CFG_LOOPBACK_VAL_SHIFT
 0

	)

311 
	#DC_LCB_CFG_RUN
 (
DC_LCB_CSRS
 + 0x000000000000)

	)

312 
	#DC_LCB_CFG_RUN_EN_SHIFT
 0

	)

313 
	#DC_LCB_CFG_RX_FIFOS_RADR
 (
DC_LCB_CSRS
 + 0x000000000018)

	)

314 
	#DC_LCB_CFG_RX_FIFOS_RADR_DO_NOT_JUMP_VAL_SHIFT
 8

	)

315 
	#DC_LCB_CFG_RX_FIFOS_RADR_OK_TO_JUMP_VAL_SHIFT
 4

	)

316 
	#DC_LCB_CFG_RX_FIFOS_RADR_RST_VAL_SHIFT
 0

	)

317 
	#DC_LCB_CFG_TX_FIFOS_RADR
 (
DC_LCB_CSRS
 + 0x000000000010)

	)

318 
	#DC_LCB_CFG_TX_FIFOS_RADR_RST_VAL_SHIFT
 0

	)

319 
	#DC_LCB_CFG_TX_FIFOS_RESET
 (
DC_LCB_CSRS
 + 0x000000000008)

	)

320 
	#DC_LCB_CFG_TX_FIFOS_RESET_VAL_SHIFT
 0

	)

321 
	#DC_LCB_CFG_REINIT_AS_SLAVE
 (
DC_LCB_CSRS
 + 0x000000000030)

	)

322 
	#DC_LCB_CFG_CNT_FOR_SKIP_STALL
 (
DC_LCB_CSRS
 + 0x000000000040)

	)

323 
	#DC_LCB_CFG_CLK_CNTR
 (
DC_LCB_CSRS
 + 0x000000000110)

	)

324 
	#DC_LCB_ERR_CLR
 (
DC_LCB_CSRS
 + 0x000000000308)

	)

325 
	#DC_LCB_ERR_EN
 (
DC_LCB_CSRS
 + 0x000000000310)

	)

326 
	#DC_LCB_ERR_FLG
 (
DC_LCB_CSRS
 + 0x000000000300)

	)

327 
	#DC_LCB_ERR_FLG_REDUNDANT_FLIT_PARITY_ERR_SMASK
 0x20000000uÎ

	)

328 
	#DC_LCB_ERR_FLG_NEG_EDGE_LINK_TRANSFER_ACTIVE_SMASK
 0x10000000uÎ

	)

329 
	#DC_LCB_ERR_FLG_HOLD_REINIT_SMASK
 0x8000000uÎ

	)

330 
	#DC_LCB_ERR_FLG_RST_FOR_INCOMPLT_RND_TRIP_SMASK
 0x4000000uÎ

	)

331 
	#DC_LCB_ERR_FLG_RST_FOR_LINK_TIMEOUT_SMASK
 0x2000000uÎ

	)

332 
	#DC_LCB_ERR_FLG_CREDIT_RETURN_FLIT_MBE_SMASK
 0x1000000uÎ

	)

333 
	#DC_LCB_ERR_FLG_REPLAY_BUF_SBE_SMASK
 0x800000uÎ

	)

334 
	#DC_LCB_ERR_FLG_REPLAY_BUF_MBE_SMASK
 0x400000uÎ

	)

335 
	#DC_LCB_ERR_FLG_FLIT_INPUT_BUF_SBE_SMASK
 0x200000uÎ

	)

336 
	#DC_LCB_ERR_FLG_FLIT_INPUT_BUF_MBE_SMASK
 0x100000uÎ

	)

337 
	#DC_LCB_ERR_FLG_VL_ACK_INPUT_WRONG_CRC_MODE_SMASK
 0x80000uÎ

	)

338 
	#DC_LCB_ERR_FLG_VL_ACK_INPUT_PARITY_ERR_SMASK
 0x40000uÎ

	)

339 
	#DC_LCB_ERR_FLG_VL_ACK_INPUT_BUF_OFLW_SMASK
 0x20000uÎ

	)

340 
	#DC_LCB_ERR_FLG_FLIT_INPUT_BUF_OFLW_SMASK
 0x10000uÎ

	)

341 
	#DC_LCB_ERR_FLG_ILLEGAL_FLIT_ENCODING_SMASK
 0x8000uÎ

	)

342 
	#DC_LCB_ERR_FLG_ILLEGAL_NULL_LTP_SMASK
 0x4000uÎ

	)

343 
	#DC_LCB_ERR_FLG_UNEXPECTED_ROUND_TRIP_MARKER_SMASK
 0x2000uÎ

	)

344 
	#DC_LCB_ERR_FLG_UNEXPECTED_REPLAY_MARKER_SMASK
 0x1000uÎ

	)

345 
	#DC_LCB_ERR_FLG_RCLK_STOPPED_SMASK
 0x800uÎ

	)

346 
	#DC_LCB_ERR_FLG_CRC_ERR_CNT_HIT_LIMIT_SMASK
 0x400uÎ

	)

347 
	#DC_LCB_ERR_FLG_REINIT_FOR_LN_DEGRADE_SMASK
 0x200uÎ

	)

348 
	#DC_LCB_ERR_FLG_REINIT_FROM_PEER_SMASK
 0x100uÎ

	)

349 
	#DC_LCB_ERR_FLG_SEQ_CRC_ERR_SMASK
 0x80uÎ

	)

350 
	#DC_LCB_ERR_FLG_RX_LESS_THAN_FOUR_LNS_SMASK
 0x40uÎ

	)

351 
	#DC_LCB_ERR_FLG_TX_LESS_THAN_FOUR_LNS_SMASK
 0x20uÎ

	)

352 
	#DC_LCB_ERR_FLG_LOST_REINIT_STALL_OR_TOS_SMASK
 0x10uÎ

	)

353 
	#DC_LCB_ERR_FLG_ALL_LNS_FAILED_REINIT_TEST_SMASK
 0x8uÎ

	)

354 
	#DC_LCB_ERR_FLG_RST_FOR_FAILED_DESKEW_SMASK
 0x4uÎ

	)

355 
	#DC_LCB_ERR_FLG_INVALID_CSR_ADDR_SMASK
 0x2uÎ

	)

356 
	#DC_LCB_ERR_FLG_CSR_PARITY_ERR_SMASK
 0x1uÎ

	)

357 
	#DC_LCB_ERR_INFO_CRC_ERR_LN0
 (
DC_LCB_CSRS
 + 0x000000000328)

	)

358 
	#DC_LCB_ERR_INFO_CRC_ERR_LN1
 (
DC_LCB_CSRS
 + 0x000000000330)

	)

359 
	#DC_LCB_ERR_INFO_CRC_ERR_LN2
 (
DC_LCB_CSRS
 + 0x000000000338)

	)

360 
	#DC_LCB_ERR_INFO_CRC_ERR_LN3
 (
DC_LCB_CSRS
 + 0x000000000340)

	)

361 
	#DC_LCB_ERR_INFO_CRC_ERR_MULTI_LN
 (
DC_LCB_CSRS
 + 0x000000000348)

	)

362 
	#DC_LCB_ERR_INFO_ESCAPE_0_ONLY_CNT
 (
DC_LCB_CSRS
 + 0x000000000368)

	)

363 
	#DC_LCB_ERR_INFO_ESCAPE_0_PLUS1_CNT
 (
DC_LCB_CSRS
 + 0x000000000370)

	)

364 
	#DC_LCB_ERR_INFO_ESCAPE_0_PLUS2_CNT
 (
DC_LCB_CSRS
 + 0x000000000378)

	)

365 
	#DC_LCB_ERR_INFO_MISC_FLG_CNT
 (
DC_LCB_CSRS
 + 0x000000000390)

	)

366 
	#DC_LCB_ERR_INFO_REINIT_FROM_PEER_CNT
 (
DC_LCB_CSRS
 + 0x000000000380)

	)

367 
	#DC_LCB_ERR_INFO_RX_REPLAY_CNT
 (
DC_LCB_CSRS
 + 0x000000000358)

	)

368 
	#DC_LCB_ERR_INFO_SBE_CNT
 (
DC_LCB_CSRS
 + 0x000000000388)

	)

369 
	#DC_LCB_ERR_INFO_SEQ_CRC_CNT
 (
DC_LCB_CSRS
 + 0x000000000360)

	)

370 
	#DC_LCB_ERR_INFO_TOTAL_CRC_ERR
 (
DC_LCB_CSRS
 + 0x000000000320)

	)

371 
	#DC_LCB_ERR_INFO_TX_REPLAY_CNT
 (
DC_LCB_CSRS
 + 0x000000000350)

	)

372 
	#DC_LCB_PG_DBG_FLIT_CRDTS_CNT
 (
DC_LCB_CSRS
 + 0x000000000580)

	)

373 
	#DC_LCB_PG_STS_PAUSE_COMPLETE_CNT
 (
DC_LCB_CSRS
 + 0x0000000005F8)

	)

374 
	#DC_LCB_PG_STS_TX_MBE_CNT
 (
DC_LCB_CSRS
 + 0x000000000608)

	)

375 
	#DC_LCB_PG_STS_TX_SBE_CNT
 (
DC_LCB_CSRS
 + 0x000000000600)

	)

376 
	#DC_LCB_PRF_ACCEPTED_LTP_CNT
 (
DC_LCB_CSRS
 + 0x000000000408)

	)

377 
	#DC_LCB_PRF_CLK_CNTR
 (
DC_LCB_CSRS
 + 0x000000000420)

	)

378 
	#DC_LCB_PRF_GOOD_LTP_CNT
 (
DC_LCB_CSRS
 + 0x000000000400)

	)

379 
	#DC_LCB_PRF_RX_FLIT_CNT
 (
DC_LCB_CSRS
 + 0x000000000410)

	)

380 
	#DC_LCB_PRF_TX_FLIT_CNT
 (
DC_LCB_CSRS
 + 0x000000000418)

	)

381 
	#DC_LCB_STS_LINK_TRANSFER_ACTIVE
 (
DC_LCB_CSRS
 + 0x000000000468)

	)

382 
	#DC_LCB_STS_ROUND_TRIP_LTP_CNT
 (
DC_LCB_CSRS
 + 0x0000000004B0)

	)

383 
	#RCV_LENGTH_ERR_CNT
 0

	)

384 
	#RCV_SHORT_ERR_CNT
 2

	)

385 
	#RCV_ICRC_ERR_CNT
 6

	)

386 
	#RCV_EBP_CNT
 9

	)

387 
	#RCV_BUF_OVFL_CNT
 10

	)

388 
	#RCV_CONTEXT_EGR_STALL
 22

	)

389 
	#RCV_DATA_PKT_CNT
 0

	)

390 
	#RCV_DWORD_CNT
 1

	)

391 
	#RCV_TID_FLOW_GEN_MISMATCH_CNT
 20

	)

392 
	#RCV_TID_FLOW_SEQ_MISMATCH_CNT
 23

	)

393 
	#RCV_TID_FULL_ERR_CNT
 18

	)

394 
	#RCV_TID_VALID_ERR_CNT
 19

	)

395 
	#RXE_NUM_32_BIT_COUNTERS
 24

	)

396 
	#RXE_NUM_64_BIT_COUNTERS
 2

	)

397 
	#RXE_NUM_RSM_INSTANCES
 4

	)

398 
	#RXE_NUM_TID_FLOWS
 32

	)

399 
	#RXE_PER_CONTEXT_OFFSET
 0x0300000

	)

400 
	#SEND_DATA_PKT_CNT
 0

	)

401 
	#SEND_DATA_PKT_VL0_CNT
 12

	)

402 
	#SEND_DATA_VL0_CNT
 3

	)

403 
	#SEND_DROPPED_PKT_CNT
 5

	)

404 
	#SEND_DWORD_CNT
 1

	)

405 
	#SEND_FLOW_STALL_CNT
 4

	)

406 
	#SEND_HEADERS_ERR_CNT
 6

	)

407 
	#SEND_LEN_ERR_CNT
 1

	)

408 
	#SEND_MAX_MIN_LEN_ERR_CNT
 2

	)

409 
	#SEND_UNDERRUN_CNT
 3

	)

410 
	#SEND_UNSUP_VL_ERR_CNT
 0

	)

411 
	#SEND_WAIT_CNT
 2

	)

412 
	#SEND_WAIT_VL0_CNT
 21

	)

413 
	#TXE_PIO_SEND_OFFSET
 0x0800000

	)

414 
	#ASIC_CFG_DRV_STR
 (
ASIC
 + 0x000000000048)

	)

415 
	#ASIC_CFG_MUTEX
 (
ASIC
 + 0x000000000040)

	)

416 
	#ASIC_CFG_SBUS_EXECUTE
 (
ASIC
 + 0x000000000008)

	)

417 
	#ASIC_CFG_SBUS_EXECUTE_EXECUTE_SMASK
 0x1uÎ

	)

418 
	#ASIC_CFG_SBUS_EXECUTE_FAST_MODE_SMASK
 0x2uÎ

	)

419 
	#ASIC_CFG_SBUS_REQUEST
 (
ASIC
 + 0x000000000000)

	)

420 
	#ASIC_CFG_SBUS_REQUEST_COMMAND_SHIFT
 16

	)

421 
	#ASIC_CFG_SBUS_REQUEST_DATA_ADDR_SHIFT
 8

	)

422 
	#ASIC_CFG_SBUS_REQUEST_DATA_IN_SHIFT
 32

	)

423 
	#ASIC_CFG_SBUS_REQUEST_RECEIVER_ADDR_SHIFT
 0

	)

424 
	#ASIC_CFG_SCRATCH
 (
ASIC
 + 0x000000000020)

	)

425 
	#ASIC_CFG_SCRATCH_1
 (
ASIC_CFG_SCRATCH
 + 0x08)

	)

426 
	#ASIC_CFG_SCRATCH_2
 (
ASIC_CFG_SCRATCH
 + 0x10)

	)

427 
	#ASIC_CFG_SCRATCH_3
 (
ASIC_CFG_SCRATCH
 + 0x18)

	)

428 
	#ASIC_CFG_THERM_POLL_EN
 (
ASIC
 + 0x000000000050)

	)

429 
	#ASIC_EEP_ADDR_CMD
 (
ASIC
 + 0x000000000308)

	)

430 
	#ASIC_EEP_ADDR_CMD_EP_ADDR_MASK
 0xFFFFFFuÎ

	)

431 
	#ASIC_EEP_CTL_STAT
 (
ASIC
 + 0x000000000300)

	)

432 
	#ASIC_EEP_CTL_STAT_EP_RESET_SMASK
 0x4uÎ

	)

433 
	#ASIC_EEP_CTL_STAT_RATE_SPI_SHIFT
 8

	)

434 
	#ASIC_EEP_CTL_STAT_RESETCSR
 0x0000000083818000uÎ

	)

435 
	#ASIC_EEP_DATA
 (
ASIC
 + 0x000000000310)

	)

436 
	#ASIC_GPIO_CLEAR
 (
ASIC
 + 0x000000000230)

	)

437 
	#ASIC_GPIO_FORCE
 (
ASIC
 + 0x000000000238)

	)

438 
	#ASIC_GPIO_IN
 (
ASIC
 + 0x000000000200)

	)

439 
	#ASIC_GPIO_INVERT
 (
ASIC
 + 0x000000000210)

	)

440 
	#ASIC_GPIO_MASK
 (
ASIC
 + 0x000000000220)

	)

441 
	#ASIC_GPIO_OE
 (
ASIC
 + 0x000000000208)

	)

442 
	#ASIC_GPIO_OUT
 (
ASIC
 + 0x000000000218)

	)

443 
	#ASIC_PCIE_SD_HOST_CMD
 (
ASIC
 + 0x000000000100)

	)

444 
	#ASIC_PCIE_SD_HOST_CMD_INTRPT_CMD_SHIFT
 0

	)

445 
	#ASIC_PCIE_SD_HOST_CMD_SBR_MODE_SMASK
 0x400uÎ

	)

446 
	#ASIC_PCIE_SD_HOST_CMD_SBUS_RCVR_ADDR_SHIFT
 2

	)

447 
	#ASIC_PCIE_SD_HOST_CMD_TIMER_MASK
 0xFFFFFuÎ

	)

448 
	#ASIC_PCIE_SD_HOST_CMD_TIMER_SHIFT
 12

	)

449 
	#ASIC_PCIE_SD_HOST_STATUS
 (
ASIC
 + 0x000000000108)

	)

450 
	#ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_ERR_MASK
 0x7uÎ

	)

451 
	#ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_ERR_SHIFT
 2

	)

452 
	#ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_STS_MASK
 0x3uÎ

	)

453 
	#ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_STS_SHIFT
 0

	)

454 
	#ASIC_PCIE_SD_INTRPT_DATA_CODE
 (
ASIC
 + 0x000000000110)

	)

455 
	#ASIC_PCIE_SD_INTRPT_ENABLE
 (
ASIC
 + 0x000000000118)

	)

456 
	#ASIC_PCIE_SD_INTRPT_LIST
 (
ASIC
 + 0x000000000180)

	)

457 
	#ASIC_PCIE_SD_INTRPT_LIST_INTRPT_CODE_SHIFT
 16

	)

458 
	#ASIC_PCIE_SD_INTRPT_LIST_INTRPT_DATA_SHIFT
 0

	)

459 
	#ASIC_PCIE_SD_INTRPT_STATUS
 (
ASIC
 + 0x000000000128)

	)

460 
	#ASIC_QSFP1_CLEAR
 (
ASIC
 + 0x000000000270)

	)

461 
	#ASIC_QSFP1_FORCE
 (
ASIC
 + 0x000000000278)

	)

462 
	#ASIC_QSFP1_IN
 (
ASIC
 + 0x000000000240)

	)

463 
	#ASIC_QSFP1_INVERT
 (
ASIC
 + 0x000000000250)

	)

464 
	#ASIC_QSFP1_MASK
 (
ASIC
 + 0x000000000260)

	)

465 
	#ASIC_QSFP1_OE
 (
ASIC
 + 0x000000000248)

	)

466 
	#ASIC_QSFP1_OUT
 (
ASIC
 + 0x000000000258)

	)

467 
	#ASIC_QSFP1_STATUS
 (
ASIC
 + 0x000000000268)

	)

468 
	#ASIC_QSFP2_CLEAR
 (
ASIC
 + 0x0000000002B0)

	)

469 
	#ASIC_QSFP2_FORCE
 (
ASIC
 + 0x0000000002B8)

	)

470 
	#ASIC_QSFP2_IN
 (
ASIC
 + 0x000000000280)

	)

471 
	#ASIC_QSFP2_INVERT
 (
ASIC
 + 0x000000000290)

	)

472 
	#ASIC_QSFP2_MASK
 (
ASIC
 + 0x0000000002A0)

	)

473 
	#ASIC_QSFP2_OE
 (
ASIC
 + 0x000000000288)

	)

474 
	#ASIC_QSFP2_OUT
 (
ASIC
 + 0x000000000298)

	)

475 
	#ASIC_QSFP2_STATUS
 (
ASIC
 + 0x0000000002A8)

	)

476 
	#ASIC_STS_SBUS_COUNTERS
 (
ASIC
 + 0x000000000018)

	)

477 
	#ASIC_STS_SBUS_COUNTERS_EXECUTE_CNT_MASK
 0xFFFFuÎ

	)

478 
	#ASIC_STS_SBUS_COUNTERS_EXECUTE_CNT_SHIFT
 0

	)

479 
	#ASIC_STS_SBUS_COUNTERS_RCV_DATA_VALID_CNT_MASK
 0xFFFFuÎ

	)

480 
	#ASIC_STS_SBUS_COUNTERS_RCV_DATA_VALID_CNT_SHIFT
 16

	)

481 
	#ASIC_STS_SBUS_RESULT
 (
ASIC
 + 0x000000000010)

	)

482 
	#ASIC_STS_SBUS_RESULT_DONE_SMASK
 0x1uÎ

	)

483 
	#ASIC_STS_SBUS_RESULT_RCV_DATA_VALID_SMASK
 0x2uÎ

	)

484 
	#ASIC_STS_SBUS_RESULT_RESULT_CODE_SHIFT
 2

	)

485 
	#ASIC_STS_SBUS_RESULT_RESULT_CODE_MASK
 0x7uÎ

	)

486 
	#ASIC_STS_SBUS_RESULT_DATA_OUT_SHIFT
 32

	)

487 
	#ASIC_STS_SBUS_RESULT_DATA_OUT_MASK
 0xFFFFFFFFuÎ

	)

488 
	#ASIC_STS_THERM
 (
ASIC
 + 0x000000000058)

	)

489 
	#ASIC_STS_THERM_CRIT_TEMP_MASK
 0x7FFuÎ

	)

490 
	#ASIC_STS_THERM_CRIT_TEMP_SHIFT
 18

	)

491 
	#ASIC_STS_THERM_CURR_TEMP_MASK
 0x7FFuÎ

	)

492 
	#ASIC_STS_THERM_CURR_TEMP_SHIFT
 2

	)

493 
	#ASIC_STS_THERM_HI_TEMP_MASK
 0x7FFuÎ

	)

494 
	#ASIC_STS_THERM_HI_TEMP_SHIFT
 50

	)

495 
	#ASIC_STS_THERM_LO_TEMP_MASK
 0x7FFuÎ

	)

496 
	#ASIC_STS_THERM_LO_TEMP_SHIFT
 34

	)

497 
	#ASIC_STS_THERM_LOW_SHIFT
 13

	)

498 
	#CCE_COUNTER_ARRAY32
 (
CCE
 + 0x000000000060)

	)

499 
	#CCE_CTRL
 (
CCE
 + 0x000000000010)

	)

500 
	#CCE_CTRL_RXE_RESUME_SMASK
 0x800uÎ

	)

501 
	#CCE_CTRL_SPC_FREEZE_SMASK
 0x100uÎ

	)

502 
	#CCE_CTRL_SPC_UNFREEZE_SMASK
 0x200uÎ

	)

503 
	#CCE_CTRL_TXE_RESUME_SMASK
 0x2000uÎ

	)

504 
	#CCE_DC_CTRL
 (
CCE
 + 0x0000000000B8)

	)

505 
	#CCE_DC_CTRL_DC_RESET_SMASK
 0x1uÎ

	)

506 
	#CCE_DC_CTRL_RESETCSR
 0x0000000000000001uÎ

	)

507 
	#CCE_ERR_CLEAR
 (
CCE
 + 0x000000000050)

	)

508 
	#CCE_ERR_MASK
 (
CCE
 + 0x000000000048)

	)

509 
	#CCE_ERR_STATUS
 (
CCE
 + 0x000000000040)

	)

510 
	#CCE_ERR_STATUS_CCE_CLI0_ASYNC_FIFO_PARITY_ERR_SMASK
 0x40uÎ

	)

511 
	#CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_DBG_PARITY_ERROR_SMASK
 0x1000uÎ

	)

512 
	#CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_PIO_CRDT_PARITY_ERR_SMASK
 \

513 0x200uÎ

	)

514 
	#CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_RXDMA_PARITY_ERROR_SMASK
 \

515 0x800uÎ

	)

516 
	#CCE_ERR_STATUS_CCE_CLI1_ASYNC_FIFO_SDMA_HD_PARITY_ERR_SMASK
 \

517 0x400uÎ

	)

518 
	#CCE_ERR_STATUS_CCE_CLI2_ASYNC_FIFO_PARITY_ERR_SMASK
 0x100uÎ

	)

519 
	#CCE_ERR_STATUS_CCE_CSR_CFG_BUS_PARITY_ERR_SMASK
 0x80uÎ

	)

520 
	#CCE_ERR_STATUS_CCE_CSR_PARITY_ERR_SMASK
 0x1uÎ

	)

521 
	#CCE_ERR_STATUS_CCE_CSR_READ_BAD_ADDR_ERR_SMASK
 0x2uÎ

	)

522 
	#CCE_ERR_STATUS_CCE_CSR_WRITE_BAD_ADDR_ERR_SMASK
 0x4uÎ

	)

523 
	#CCE_ERR_STATUS_CCE_INT_MAP_COR_ERR_SMASK
 0x4000000000uÎ

	)

524 
	#CCE_ERR_STATUS_CCE_INT_MAP_UNC_ERR_SMASK
 0x8000000000uÎ

	)

525 
	#CCE_ERR_STATUS_CCE_MSIX_CSR_PARITY_ERR_SMASK
 0x10000000000uÎ

	)

526 
	#CCE_ERR_STATUS_CCE_MSIX_TABLE_COR_ERR_SMASK
 0x1000000000uÎ

	)

527 
	#CCE_ERR_STATUS_CCE_MSIX_TABLE_UNC_ERR_SMASK
 0x2000000000uÎ

	)

528 
	#CCE_ERR_STATUS_CCE_RCPL_ASYNC_FIFO_PARITY_ERR_SMASK
 0x400000000uÎ

	)

529 
	#CCE_ERR_STATUS_CCE_RSPD_DATA_PARITY_ERR_SMASK
 0x20uÎ

	)

530 
	#CCE_ERR_STATUS_CCE_RXDMA_CONV_FIFO_PARITY_ERR_SMASK
 0x800000000uÎ

	)

531 
	#CCE_ERR_STATUS_CCE_SEG_READ_BAD_ADDR_ERR_SMASK
 0x100000000uÎ

	)

532 
	#CCE_ERR_STATUS_CCE_SEG_WRITE_BAD_ADDR_ERR_SMASK
 0x200000000uÎ

	)

533 
	#CCE_ERR_STATUS_CCE_TRGT_ACCESS_ERR_SMASK
 0x10uÎ

	)

534 
	#CCE_ERR_STATUS_CCE_TRGT_ASYNC_FIFO_PARITY_ERR_SMASK
 0x8uÎ

	)

535 
	#CCE_ERR_STATUS_CCE_TRGT_CPL_TIMEOUT_ERR_SMASK
 0x40000000uÎ

	)

536 
	#CCE_ERR_STATUS_LA_TRIGGERED_SMASK
 0x80000000uÎ

	)

537 
	#CCE_ERR_STATUS_PCIC_CPL_DAT_QCOR_ERR_SMASK
 0x40000uÎ

	)

538 
	#CCE_ERR_STATUS_PCIC_CPL_DAT_QUNC_ERR_SMASK
 0x4000000uÎ

	)

539 
	#CCE_ERR_STATUS_PCIC_CPL_HD_QCOR_ERR_SMASK
 0x20000uÎ

	)

540 
	#CCE_ERR_STATUS_PCIC_CPL_HD_QUNC_ERR_SMASK
 0x2000000uÎ

	)

541 
	#CCE_ERR_STATUS_PCIC_NPOST_DAT_QPARITY_ERR_SMASK
 0x100000uÎ

	)

542 
	#CCE_ERR_STATUS_PCIC_NPOST_HQ_PARITY_ERR_SMASK
 0x80000uÎ

	)

543 
	#CCE_ERR_STATUS_PCIC_POST_DAT_QCOR_ERR_SMASK
 0x10000uÎ

	)

544 
	#CCE_ERR_STATUS_PCIC_POST_DAT_QUNC_ERR_SMASK
 0x1000000uÎ

	)

545 
	#CCE_ERR_STATUS_PCIC_POST_HD_QCOR_ERR_SMASK
 0x8000uÎ

	)

546 
	#CCE_ERR_STATUS_PCIC_POST_HD_QUNC_ERR_SMASK
 0x800000uÎ

	)

547 
	#CCE_ERR_STATUS_PCIC_RECEIVE_PARITY_ERR_SMASK
 0x20000000uÎ

	)

548 
	#CCE_ERR_STATUS_PCIC_RETRY_MEM_COR_ERR_SMASK
 0x2000uÎ

	)

549 
	#CCE_ERR_STATUS_PCIC_RETRY_MEM_UNC_ERR_SMASK
 0x200000uÎ

	)

550 
	#CCE_ERR_STATUS_PCIC_RETRY_SOT_MEM_COR_ERR_SMASK
 0x4000uÎ

	)

551 
	#CCE_ERR_STATUS_PCIC_RETRY_SOT_MEM_UNC_ERR_SMASK
 0x400000uÎ

	)

552 
	#CCE_ERR_STATUS_PCIC_TRANSMIT_BACK_PARITY_ERR_SMASK
 0x10000000uÎ

	)

553 
	#CCE_ERR_STATUS_PCIC_TRANSMIT_FRONT_PARITY_ERR_SMASK
 0x8000000uÎ

	)

554 
	#CCE_INT_CLEAR
 (
CCE
 + 0x000000110A00)

	)

555 
	#CCE_INT_COUNTER_ARRAY32
 (
CCE
 + 0x000000110D00)

	)

556 
	#CCE_INT_FORCE
 (
CCE
 + 0x000000110B00)

	)

557 
	#CCE_INT_MAP
 (
CCE
 + 0x000000110500)

	)

558 
	#CCE_INT_MASK
 (
CCE
 + 0x000000110900)

	)

559 
	#CCE_INT_STATUS
 (
CCE
 + 0x000000110800)

	)

560 
	#CCE_MSIX_INT_GRANTED
 (
CCE
 + 0x000000110200)

	)

561 
	#CCE_MSIX_TABLE_LOWER
 (
CCE
 + 0x000000100000)

	)

562 
	#CCE_MSIX_TABLE_UPPER
 (
CCE
 + 0x000000100008)

	)

563 
	#CCE_MSIX_TABLE_UPPER_RESETCSR
 0x0000000100000000uÎ

	)

564 
	#CCE_MSIX_VEC_CLR_WITHOUT_INT
 (
CCE
 + 0x000000110400)

	)

565 
	#CCE_PCIE_CTRL
 (
CCE
 + 0x0000000000C0)

	)

566 
	#CCE_PCIE_CTRL_PCIE_LANE_BUNDLE_MASK
 0x3uÎ

	)

567 
	#CCE_PCIE_CTRL_PCIE_LANE_BUNDLE_SHIFT
 0

	)

568 
	#CCE_PCIE_CTRL_PCIE_LANE_DELAY_MASK
 0xFuÎ

	)

569 
	#CCE_PCIE_CTRL_PCIE_LANE_DELAY_SHIFT
 2

	)

570 
	#CCE_PCIE_CTRL_XMT_MARGIN_OVERWRITE_ENABLE_SHIFT
 8

	)

571 
	#CCE_PCIE_CTRL_XMT_MARGIN_SHIFT
 9

	)

572 
	#CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_OVERWRITE_ENABLE_MASK
 0x1uÎ

	)

573 
	#CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_OVERWRITE_ENABLE_SHIFT
 12

	)

574 
	#CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_MASK
 0x7uÎ

	)

575 
	#CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_SHIFT
 13

	)

576 
	#CCE_REVISION
 (
CCE
 + 0x000000000000)

	)

577 
	#CCE_REVISION2
 (
CCE
 + 0x000000000008)

	)

578 
	#CCE_REVISION2_HFI_ID_MASK
 0x1uÎ

	)

579 
	#CCE_REVISION2_HFI_ID_SHIFT
 0

	)

580 
	#CCE_REVISION2_IMPL_CODE_SHIFT
 8

	)

581 
	#CCE_REVISION2_IMPL_REVISION_SHIFT
 16

	)

582 
	#CCE_REVISION_BOARD_ID_LOWER_NIBBLE_MASK
 0xFuÎ

	)

583 
	#CCE_REVISION_BOARD_ID_LOWER_NIBBLE_SHIFT
 32

	)

584 
	#CCE_REVISION_CHIP_REV_MAJOR_MASK
 0xFFuÎ

	)

585 
	#CCE_REVISION_CHIP_REV_MAJOR_SHIFT
 8

	)

586 
	#CCE_REVISION_CHIP_REV_MINOR_MASK
 0xFFuÎ

	)

587 
	#CCE_REVISION_CHIP_REV_MINOR_SHIFT
 0

	)

588 
	#CCE_REVISION_SW_MASK
 0xFFuÎ

	)

589 
	#CCE_REVISION_SW_SHIFT
 24

	)

590 
	#CCE_SCRATCH
 (
CCE
 + 0x000000000020)

	)

591 
	#CCE_STATUS
 (
CCE
 + 0x000000000018)

	)

592 
	#CCE_STATUS_RXE_FROZE_SMASK
 0x2uÎ

	)

593 
	#CCE_STATUS_RXE_PAUSED_SMASK
 0x20uÎ

	)

594 
	#CCE_STATUS_SDMA_FROZE_SMASK
 0x1uÎ

	)

595 
	#CCE_STATUS_SDMA_PAUSED_SMASK
 0x10uÎ

	)

596 
	#CCE_STATUS_TXE_FROZE_SMASK
 0x4uÎ

	)

597 
	#CCE_STATUS_TXE_PAUSED_SMASK
 0x40uÎ

	)

598 
	#CCE_STATUS_TXE_PIO_FROZE_SMASK
 0x8uÎ

	)

599 
	#CCE_STATUS_TXE_PIO_PAUSED_SMASK
 0x80uÎ

	)

600 
	#MISC_CFG_FW_CTRL
 (
MISC
 + 0x000000001000)

	)

601 
	#MISC_CFG_FW_CTRL_FW_8051_LOADED_SMASK
 0x2uÎ

	)

602 
	#MISC_CFG_FW_CTRL_RSA_STATUS_SHIFT
 2

	)

603 
	#MISC_CFG_FW_CTRL_RSA_STATUS_SMASK
 0xCuÎ

	)

604 
	#MISC_CFG_RSA_CMD
 (
MISC
 + 0x000000000A08)

	)

605 
	#MISC_CFG_RSA_MODULUS
 (
MISC
 + 0x000000000400)

	)

606 
	#MISC_CFG_RSA_MU
 (
MISC
 + 0x000000000A10)

	)

607 
	#MISC_CFG_RSA_R2
 (
MISC
 + 0x000000000000)

	)

608 
	#MISC_CFG_RSA_SIGNATURE
 (
MISC
 + 0x000000000200)

	)

609 
	#MISC_CFG_SHA_PRELOAD
 (
MISC
 + 0x000000000A00)

	)

610 
	#MISC_ERR_CLEAR
 (
MISC
 + 0x000000002010)

	)

611 
	#MISC_ERR_MASK
 (
MISC
 + 0x000000002008)

	)

612 
	#MISC_ERR_STATUS
 (
MISC
 + 0x000000002000)

	)

613 
	#MISC_ERR_STATUS_MISC_PLL_LOCK_FAIL_ERR_SMASK
 0x1000uÎ

	)

614 
	#MISC_ERR_STATUS_MISC_MBIST_FAIL_ERR_SMASK
 0x800uÎ

	)

615 
	#MISC_ERR_STATUS_MISC_INVALID_EEP_CMD_ERR_SMASK
 0x400uÎ

	)

616 
	#MISC_ERR_STATUS_MISC_EFUSE_DONE_PARITY_ERR_SMASK
 0x200uÎ

	)

617 
	#MISC_ERR_STATUS_MISC_EFUSE_WRITE_ERR_SMASK
 0x100uÎ

	)

618 
	#MISC_ERR_STATUS_MISC_EFUSE_READ_BAD_ADDR_ERR_SMASK
 0x80uÎ

	)

619 
	#MISC_ERR_STATUS_MISC_EFUSE_CSR_PARITY_ERR_SMASK
 0x40uÎ

	)

620 
	#MISC_ERR_STATUS_MISC_FW_AUTH_FAILED_ERR_SMASK
 0x20uÎ

	)

621 
	#MISC_ERR_STATUS_MISC_KEY_MISMATCH_ERR_SMASK
 0x10uÎ

	)

622 
	#MISC_ERR_STATUS_MISC_SBUS_WRITE_FAILED_ERR_SMASK
 0x8uÎ

	)

623 
	#MISC_ERR_STATUS_MISC_CSR_WRITE_BAD_ADDR_ERR_SMASK
 0x4uÎ

	)

624 
	#MISC_ERR_STATUS_MISC_CSR_READ_BAD_ADDR_ERR_SMASK
 0x2uÎ

	)

625 
	#MISC_ERR_STATUS_MISC_CSR_PARITY_ERR_SMASK
 0x1uÎ

	)

626 
	#PCI_CFG_MSIX0
 (
PCIE
 + 0x0000000000B0)

	)

627 
	#PCI_CFG_REG1
 (
PCIE
 + 0x000000000004)

	)

628 
	#PCI_CFG_REG11
 (
PCIE
 + 0x00000000002C)

	)

629 
	#PCIE_CFG_SPCIE1
 (
PCIE
 + 0x00000000014C)

	)

630 
	#PCIE_CFG_SPCIE2
 (
PCIE
 + 0x000000000150)

	)

631 
	#PCIE_CFG_TPH2
 (
PCIE
 + 0x000000000180)

	)

632 
	#RCV_ARRAY
 (
RXE
 + 0x000000200000)

	)

633 
	#RCV_ARRAY_CNT
 (
RXE
 + 0x000000000018)

	)

634 
	#RCV_ARRAY_RT_ADDR_MASK
 0xFFFFFFFFFuÎ

	)

635 
	#RCV_ARRAY_RT_ADDR_SHIFT
 0

	)

636 
	#RCV_ARRAY_RT_BUF_SIZE_SHIFT
 36

	)

637 
	#RCV_ARRAY_RT_WRITE_ENABLE_SMASK
 0x8000000000000000uÎ

	)

638 
	#RCV_AVAIL_TIME_OUT
 (
RXE
 + 0x000000100050)

	)

639 
	#RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_MASK
 0xFFuÎ

	)

640 
	#RCV_AVAIL_TIME_OUT_TIME_OUT_RELOAD_SHIFT
 0

	)

641 
	#RCV_BTH_QP
 (
RXE
 + 0x000000000028)

	)

642 
	#RCV_BTH_QP_KDETH_QP_MASK
 0xFFuÎ

	)

643 
	#RCV_BTH_QP_KDETH_QP_SHIFT
 16

	)

644 
	#RCV_BYPASS
 (
RXE
 + 0x000000000038)

	)

645 
	#RCV_BYPASS_HDR_SIZE_SHIFT
 16

	)

646 
	#RCV_BYPASS_HDR_SIZE_MASK
 0x1FuÎ

	)

647 
	#RCV_BYPASS_HDR_SIZE_SMASK
 0x1F0000uÎ

	)

648 
	#RCV_BYPASS_BYPASS_CONTEXT_SHIFT
 0

	)

649 
	#RCV_BYPASS_BYPASS_CONTEXT_MASK
 0xFFuÎ

	)

650 
	#RCV_BYPASS_BYPASS_CONTEXT_SMASK
 0xFFuÎ

	)

651 
	#RCV_CONTEXTS
 (
RXE
 + 0x000000000010)

	)

652 
	#RCV_COUNTER_ARRAY32
 (
RXE
 + 0x000000000400)

	)

653 
	#RCV_COUNTER_ARRAY64
 (
RXE
 + 0x000000000500)

	)

654 
	#RCV_CTRL
 (
RXE
 + 0x000000000000)

	)

655 
	#RCV_CTRL_RCV_BYPASS_ENABLE_SMASK
 0x10uÎ

	)

656 
	#RCV_CTRL_RCV_EXTENDED_PSN_ENABLE_SMASK
 0x40uÎ

	)

657 
	#RCV_CTRL_RCV_PARTITION_KEY_ENABLE_SMASK
 0x4uÎ

	)

658 
	#RCV_CTRL_RCV_PORT_ENABLE_SMASK
 0x1uÎ

	)

659 
	#RCV_CTRL_RCV_QP_MAP_ENABLE_SMASK
 0x2uÎ

	)

660 
	#RCV_CTRL_RCV_RSM_ENABLE_SMASK
 0x20uÎ

	)

661 
	#RCV_CTRL_RX_RBUF_INIT_SMASK
 0x200uÎ

	)

662 
	#RCV_CTXT_CTRL
 (
RXE
 + 0x000000100000)

	)

663 
	#RCV_CTXT_CTRL_DONT_DROP_EGR_FULL_SMASK
 0x4uÎ

	)

664 
	#RCV_CTXT_CTRL_DONT_DROP_RHQ_FULL_SMASK
 0x8uÎ

	)

665 
	#RCV_CTXT_CTRL_EGR_BUF_SIZE_MASK
 0x7uÎ

	)

666 
	#RCV_CTXT_CTRL_EGR_BUF_SIZE_SHIFT
 8

	)

667 
	#RCV_CTXT_CTRL_EGR_BUF_SIZE_SMASK
 0x700uÎ

	)

668 
	#RCV_CTXT_CTRL_ENABLE_SMASK
 0x1uÎ

	)

669 
	#RCV_CTXT_CTRL_INTR_AVAIL_SMASK
 0x20uÎ

	)

670 
	#RCV_CTXT_CTRL_ONE_PACKET_PER_EGR_BUFFER_SMASK
 0x2uÎ

	)

671 
	#RCV_CTXT_CTRL_TAIL_UPD_SMASK
 0x40uÎ

	)

672 
	#RCV_CTXT_CTRL_TID_FLOW_ENABLE_SMASK
 0x10uÎ

	)

673 
	#RCV_CTXT_STATUS
 (
RXE
 + 0x000000100008)

	)

674 
	#RCV_EGR_CTRL
 (
RXE
 + 0x000000100010)

	)

675 
	#RCV_EGR_CTRL_EGR_BASE_INDEX_MASK
 0x1FFFuÎ

	)

676 
	#RCV_EGR_CTRL_EGR_BASE_INDEX_SHIFT
 0

	)

677 
	#RCV_EGR_CTRL_EGR_CNT_MASK
 0x1FFuÎ

	)

678 
	#RCV_EGR_CTRL_EGR_CNT_SHIFT
 32

	)

679 
	#RCV_EGR_INDEX_HEAD
 (
RXE
 + 0x000000300018)

	)

680 
	#RCV_EGR_INDEX_HEAD_HEAD_MASK
 0x7FFuÎ

	)

681 
	#RCV_EGR_INDEX_HEAD_HEAD_SHIFT
 0

	)

682 
	#RCV_ERR_CLEAR
 (
RXE
 + 0x000000000070)

	)

683 
	#RCV_ERR_INFO
 (
RXE
 + 0x000000000050)

	)

684 
	#RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SC_SMASK
 0x1FuÎ

	)

685 
	#RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SMASK
 0x20uÎ

	)

686 
	#RCV_ERR_MASK
 (
RXE
 + 0x000000000068)

	)

687 
	#RCV_ERR_STATUS
 (
RXE
 + 0x000000000060)

	)

688 
	#RCV_ERR_STATUS_RX_CSR_PARITY_ERR_SMASK
 0x8000000000000000uÎ

	)

689 
	#RCV_ERR_STATUS_RX_CSR_READ_BAD_ADDR_ERR_SMASK
 0x2000000000000000uÎ

	)

690 
	#RCV_ERR_STATUS_RX_CSR_WRITE_BAD_ADDR_ERR_SMASK
 \

691 0x4000000000000000uÎ

	)

692 
	#RCV_ERR_STATUS_RX_DC_INTF_PARITY_ERR_SMASK
 0x2uÎ

	)

693 
	#RCV_ERR_STATUS_RX_DC_SOP_EOP_PARITY_ERR_SMASK
 0x200uÎ

	)

694 
	#RCV_ERR_STATUS_RX_DMA_CSR_COR_ERR_SMASK
 0x1uÎ

	)

695 
	#RCV_ERR_STATUS_RX_DMA_CSR_PARITY_ERR_SMASK
 0x200000000000000uÎ

	)

696 
	#RCV_ERR_STATUS_RX_DMA_CSR_UNC_ERR_SMASK
 0x1000000000000000uÎ

	)

697 
	#RCV_ERR_STATUS_RX_DMA_DATA_FIFO_RD_COR_ERR_SMASK
 \

698 0x40000000000000uÎ

	)

699 
	#RCV_ERR_STATUS_RX_DMA_DATA_FIFO_RD_UNC_ERR_SMASK
 \

700 0x20000000000000uÎ

	)

701 
	#RCV_ERR_STATUS_RX_DMA_DQ_FSM_ENCODING_ERR_SMASK
 \

702 0x800000000000000uÎ

	)

703 
	#RCV_ERR_STATUS_RX_DMA_EQ_FSM_ENCODING_ERR_SMASK
 \

704 0x400000000000000uÎ

	)

705 
	#RCV_ERR_STATUS_RX_DMA_FLAG_COR_ERR_SMASK
 0x800uÎ

	)

706 
	#RCV_ERR_STATUS_RX_DMA_FLAG_UNC_ERR_SMASK
 0x400uÎ

	)

707 
	#RCV_ERR_STATUS_RX_DMA_HDR_FIFO_RD_COR_ERR_SMASK
 0x10000000000000uÎ

	)

708 
	#RCV_ERR_STATUS_RX_DMA_HDR_FIFO_RD_UNC_ERR_SMASK
 0x8000000000000uÎ

	)

709 
	#RCV_ERR_STATUS_RX_HQ_INTR_CSR_PARITY_ERR_SMASK
 0x200000000000uÎ

	)

710 
	#RCV_ERR_STATUS_RX_HQ_INTR_FSM_ERR_SMASK
 0x400000000000uÎ

	)

711 
	#RCV_ERR_STATUS_RX_LOOKUP_CSR_PARITY_ERR_SMASK
 0x100000000000uÎ

	)

712 
	#RCV_ERR_STATUS_RX_LOOKUP_DES_PART1_UNC_COR_ERR_SMASK
 \

713 0x10000000000uÎ

	)

714 
	#RCV_ERR_STATUS_RX_LOOKUP_DES_PART1_UNC_ERR_SMASK
 0x8000000000uÎ

	)

715 
	#RCV_ERR_STATUS_RX_LOOKUP_DES_PART2_PARITY_ERR_SMASK
 \

716 0x20000000000uÎ

	)

717 
	#RCV_ERR_STATUS_RX_LOOKUP_RCV_ARRAY_COR_ERR_SMASK
 0x80000000000uÎ

	)

718 
	#RCV_ERR_STATUS_RX_LOOKUP_RCV_ARRAY_UNC_ERR_SMASK
 0x40000000000uÎ

	)

719 
	#RCV_ERR_STATUS_RX_RBUF_BAD_LOOKUP_ERR_SMASK
 0x40000000uÎ

	)

720 
	#RCV_ERR_STATUS_RX_RBUF_BLOCK_LIST_READ_COR_ERR_SMASK
 0x100000uÎ

	)

721 
	#RCV_ERR_STATUS_RX_RBUF_BLOCK_LIST_READ_UNC_ERR_SMASK
 0x80000uÎ

	)

722 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QENT_CNT_PARITY_ERR_SMASK
 0x400000uÎ

	)

723 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QEOPDW_PARITY_ERR_SMASK
 0x10000000uÎ

	)

724 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QHD_PTR_PARITY_ERR_SMASK
 0x2000000uÎ

	)

725 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QHEAD_BUF_NUM_PARITY_ERR_SMASK
 \

726 0x200000uÎ

	)

727 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QNEXT_BUF_PARITY_ERR_SMASK
 0x800000uÎ

	)

728 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QNUM_OF_PKT_PARITY_ERR_SMASK
 \

729 0x8000000uÎ

	)

730 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QTL_PTR_PARITY_ERR_SMASK
 0x4000000uÎ

	)

731 
	#RCV_ERR_STATUS_RX_RBUF_CSR_QVLD_BIT_PARITY_ERR_SMASK
 0x1000000uÎ

	)

732 
	#RCV_ERR_STATUS_RX_RBUF_CTX_ID_PARITY_ERR_SMASK
 0x20000000uÎ

	)

733 
	#RCV_ERR_STATUS_RX_RBUF_DATA_COR_ERR_SMASK
 0x100000000000000uÎ

	)

734 
	#RCV_ERR_STATUS_RX_RBUF_DATA_UNC_ERR_SMASK
 0x80000000000000uÎ

	)

735 
	#RCV_ERR_STATUS_RX_RBUF_DESC_PART1_COR_ERR_SMASK
 0x1000000000000uÎ

	)

736 
	#RCV_ERR_STATUS_RX_RBUF_DESC_PART1_UNC_ERR_SMASK
 0x800000000000uÎ

	)

737 
	#RCV_ERR_STATUS_RX_RBUF_DESC_PART2_COR_ERR_SMASK
 0x4000000000000uÎ

	)

738 
	#RCV_ERR_STATUS_RX_RBUF_DESC_PART2_UNC_ERR_SMASK
 0x2000000000000uÎ

	)

739 
	#RCV_ERR_STATUS_RX_RBUF_EMPTY_ERR_SMASK
 0x100000000uÎ

	)

740 
	#RCV_ERR_STATUS_RX_RBUF_FL_INITDONE_PARITY_ERR_SMASK
 0x800000000uÎ

	)

741 
	#RCV_ERR_STATUS_RX_RBUF_FL_INIT_WR_ADDR_PARITY_ERR_SMASK
 \

742 0x1000000000uÎ

	)

743 
	#RCV_ERR_STATUS_RX_RBUF_FL_RD_ADDR_PARITY_ERR_SMASK
 0x200000000uÎ

	)

744 
	#RCV_ERR_STATUS_RX_RBUF_FL_WR_ADDR_PARITY_ERR_SMASK
 0x400000000uÎ

	)

745 
	#RCV_ERR_STATUS_RX_RBUF_FREE_LIST_COR_ERR_SMASK
 0x4000uÎ

	)

746 
	#RCV_ERR_STATUS_RX_RBUF_FREE_LIST_UNC_ERR_SMASK
 0x2000uÎ

	)

747 
	#RCV_ERR_STATUS_RX_RBUF_FULL_ERR_SMASK
 0x80000000uÎ

	)

748 
	#RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_COR_ERR_SMASK
 0x40000uÎ

	)

749 
	#RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_REG_UNC_COR_ERR_SMASK
 0x10000uÎ

	)

750 
	#RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_REG_UNC_ERR_SMASK
 0x8000uÎ

	)

751 
	#RCV_ERR_STATUS_RX_RBUF_LOOKUP_DES_UNC_ERR_SMASK
 0x20000uÎ

	)

752 
	#RCV_ERR_STATUS_RX_RBUF_NEXT_FREE_BUF_COR_ERR_SMASK
 0x4000000000uÎ

	)

753 
	#RCV_ERR_STATUS_RX_RBUF_NEXT_FREE_BUF_UNC_ERR_SMASK
 0x2000000000uÎ

	)

754 
	#RCV_ERR_STATUS_RX_RCV_CSR_PARITY_ERR_SMASK
 0x100uÎ

	)

755 
	#RCV_ERR_STATUS_RX_RCV_DATA_COR_ERR_SMASK
 0x20uÎ

	)

756 
	#RCV_ERR_STATUS_RX_RCV_DATA_UNC_ERR_SMASK
 0x10uÎ

	)

757 
	#RCV_ERR_STATUS_RX_RCV_FSM_ENCODING_ERR_SMASK
 0x1000uÎ

	)

758 
	#RCV_ERR_STATUS_RX_RCV_HDR_COR_ERR_SMASK
 0x8uÎ

	)

759 
	#RCV_ERR_STATUS_RX_RCV_HDR_UNC_ERR_SMASK
 0x4uÎ

	)

760 
	#RCV_ERR_STATUS_RX_RCV_QP_MAP_TABLE_COR_ERR_SMASK
 0x80uÎ

	)

761 
	#RCV_ERR_STATUS_RX_RCV_QP_MAP_TABLE_UNC_ERR_SMASK
 0x40uÎ

	)

762 
	#RCV_HDR_ADDR
 (
RXE
 + 0x000000100028)

	)

763 
	#RCV_HDR_CNT
 (
RXE
 + 0x000000100030)

	)

764 
	#RCV_HDR_CNT_CNT_MASK
 0x1FFuÎ

	)

765 
	#RCV_HDR_CNT_CNT_SHIFT
 0

	)

766 
	#RCV_HDR_ENT_SIZE
 (
RXE
 + 0x000000100038)

	)

767 
	#RCV_HDR_ENT_SIZE_ENT_SIZE_MASK
 0x7uÎ

	)

768 
	#RCV_HDR_ENT_SIZE_ENT_SIZE_SHIFT
 0

	)

769 
	#RCV_HDR_HEAD
 (
RXE
 + 0x000000300008)

	)

770 
	#RCV_HDR_HEAD_COUNTER_MASK
 0xFFuÎ

	)

771 
	#RCV_HDR_HEAD_COUNTER_SHIFT
 32

	)

772 
	#RCV_HDR_HEAD_HEAD_MASK
 0x7FFFFuÎ

	)

773 
	#RCV_HDR_HEAD_HEAD_SHIFT
 0

	)

774 
	#RCV_HDR_HEAD_HEAD_SMASK
 0x7FFFFuÎ

	)

775 
	#RCV_HDR_OVFL_CNT
 (
RXE
 + 0x000000100058)

	)

776 
	#RCV_HDR_SIZE
 (
RXE
 + 0x000000100040)

	)

777 
	#RCV_HDR_SIZE_HDR_SIZE_MASK
 0x1FuÎ

	)

778 
	#RCV_HDR_SIZE_HDR_SIZE_SHIFT
 0

	)

779 
	#RCV_HDR_TAIL
 (
RXE
 + 0x000000300000)

	)

780 
	#RCV_HDR_TAIL_ADDR
 (
RXE
 + 0x000000100048)

	)

781 
	#RCV_KEY_CTRL
 (
RXE
 + 0x000000100020)

	)

782 
	#RCV_KEY_CTRL_JOB_KEY_ENABLE_SMASK
 0x200000000uÎ

	)

783 
	#RCV_KEY_CTRL_JOB_KEY_VALUE_MASK
 0xFFFFuÎ

	)

784 
	#RCV_KEY_CTRL_JOB_KEY_VALUE_SHIFT
 0

	)

785 
	#RCV_MULTICAST
 (
RXE
 + 0x000000000030)

	)

786 
	#RCV_PARTITION_KEY
 (
RXE
 + 0x000000000200)

	)

787 
	#RCV_PARTITION_KEY_PARTITION_KEY_A_MASK
 0xFFFFuÎ

	)

788 
	#RCV_PARTITION_KEY_PARTITION_KEY_B_SHIFT
 16

	)

789 
	#RCV_QP_MAP_TABLE
 (
RXE
 + 0x000000000100)

	)

790 
	#RCV_RSM_CFG
 (
RXE
 + 0x000000000600)

	)

791 
	#RCV_RSM_CFG_ENABLE_OR_CHAIN_RSM0_MASK
 0x1uÎ

	)

792 
	#RCV_RSM_CFG_ENABLE_OR_CHAIN_RSM0_SHIFT
 0

	)

793 
	#RCV_RSM_CFG_PACKET_TYPE_SHIFT
 60

	)

794 
	#RCV_RSM_CFG_OFFSET_SHIFT
 32

	)

795 
	#RCV_RSM_MAP_TABLE
 (
RXE
 + 0x000000000900)

	)

796 
	#RCV_RSM_MAP_TABLE_RCV_CONTEXT_A_MASK
 0xFFuÎ

	)

797 
	#RCV_RSM_MATCH
 (
RXE
 + 0x000000000800)

	)

798 
	#RCV_RSM_MATCH_MASK1_SHIFT
 0

	)

799 
	#RCV_RSM_MATCH_MASK2_SHIFT
 16

	)

800 
	#RCV_RSM_MATCH_VALUE1_SHIFT
 8

	)

801 
	#RCV_RSM_MATCH_VALUE2_SHIFT
 24

	)

802 
	#RCV_RSM_SELECT
 (
RXE
 + 0x000000000700)

	)

803 
	#RCV_RSM_SELECT_FIELD1_OFFSET_SHIFT
 0

	)

804 
	#RCV_RSM_SELECT_FIELD2_OFFSET_SHIFT
 16

	)

805 
	#RCV_RSM_SELECT_INDEX1_OFFSET_SHIFT
 32

	)

806 
	#RCV_RSM_SELECT_INDEX1_WIDTH_SHIFT
 44

	)

807 
	#RCV_RSM_SELECT_INDEX2_OFFSET_SHIFT
 48

	)

808 
	#RCV_RSM_SELECT_INDEX2_WIDTH_SHIFT
 60

	)

809 
	#RCV_STATUS
 (
RXE
 + 0x000000000008)

	)

810 
	#RCV_STATUS_RX_PKT_IN_PROGRESS_SMASK
 0x1uÎ

	)

811 
	#RCV_STATUS_RX_RBUF_INIT_DONE_SMASK
 0x200uÎ

	)

812 
	#RCV_STATUS_RX_RBUF_PKT_PENDING_SMASK
 0x40uÎ

	)

813 
	#RCV_TID_CTRL
 (
RXE
 + 0x000000100018)

	)

814 
	#RCV_TID_CTRL_TID_BASE_INDEX_MASK
 0x1FFFuÎ

	)

815 
	#RCV_TID_CTRL_TID_BASE_INDEX_SHIFT
 0

	)

816 
	#RCV_TID_CTRL_TID_PAIR_CNT_MASK
 0x1FFuÎ

	)

817 
	#RCV_TID_CTRL_TID_PAIR_CNT_SHIFT
 32

	)

818 
	#RCV_TID_FLOW_TABLE
 (
RXE
 + 0x000000300800)

	)

819 
	#RCV_VL15
 (
RXE
 + 0x000000000048)

	)

820 
	#SEND_BTH_QP
 (
TXE
 + 0x0000000000A0)

	)

821 
	#SEND_BTH_QP_KDETH_QP_MASK
 0xFFuÎ

	)

822 
	#SEND_BTH_QP_KDETH_QP_SHIFT
 16

	)

823 
	#SEND_CM_CREDIT_USED_STATUS
 (
TXE
 + 0x000000000510)

	)

824 
	#SEND_CM_CREDIT_USED_STATUS_VL0_RETURN_CREDIT_STATUS_SMASK
 \

825 0x1000000000000uÎ

	)

826 
	#SEND_CM_CREDIT_USED_STATUS_VL15_RETURN_CREDIT_STATUS_SMASK
 \

827 0x8000000000000000uÎ

	)

828 
	#SEND_CM_CREDIT_USED_STATUS_VL1_RETURN_CREDIT_STATUS_SMASK
 \

829 0x2000000000000uÎ

	)

830 
	#SEND_CM_CREDIT_USED_STATUS_VL2_RETURN_CREDIT_STATUS_SMASK
 \

831 0x4000000000000uÎ

	)

832 
	#SEND_CM_CREDIT_USED_STATUS_VL3_RETURN_CREDIT_STATUS_SMASK
 \

833 0x8000000000000uÎ

	)

834 
	#SEND_CM_CREDIT_USED_STATUS_VL4_RETURN_CREDIT_STATUS_SMASK
 \

835 0x10000000000000uÎ

	)

836 
	#SEND_CM_CREDIT_USED_STATUS_VL5_RETURN_CREDIT_STATUS_SMASK
 \

837 0x20000000000000uÎ

	)

838 
	#SEND_CM_CREDIT_USED_STATUS_VL6_RETURN_CREDIT_STATUS_SMASK
 \

839 0x40000000000000uÎ

	)

840 
	#SEND_CM_CREDIT_USED_STATUS_VL7_RETURN_CREDIT_STATUS_SMASK
 \

841 0x80000000000000uÎ

	)

842 
	#SEND_CM_CREDIT_VL
 (
TXE
 + 0x000000000600)

	)

843 
	#SEND_CM_CREDIT_VL15
 (
TXE
 + 0x000000000678)

	)

844 
	#SEND_CM_CREDIT_VL15_DEDICATED_LIMIT_VL_SHIFT
 0

	)

845 
	#SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_MASK
 0xFFFFuÎ

	)

846 
	#SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SHIFT
 0

	)

847 
	#SEND_CM_CREDIT_VL_DEDICATED_LIMIT_VL_SMASK
 0xFFFFuÎ

	)

848 
	#SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_MASK
 0xFFFFuÎ

	)

849 
	#SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_SHIFT
 16

	)

850 
	#SEND_CM_CREDIT_VL_SHARED_LIMIT_VL_SMASK
 0xFFFF0000uÎ

	)

851 
	#SEND_CM_CTRL
 (
TXE
 + 0x000000000500)

	)

852 
	#SEND_CM_CTRL_FORCE_CREDIT_MODE_SMASK
 0x8uÎ

	)

853 
	#SEND_CM_CTRL_RESETCSR
 0x0000000000000020uÎ

	)

854 
	#SEND_CM_GLOBAL_CREDIT
 (
TXE
 + 0x000000000508)

	)

855 
	#SEND_CM_GLOBAL_CREDIT_AU_MASK
 0x7uÎ

	)

856 
	#SEND_CM_GLOBAL_CREDIT_AU_SHIFT
 16

	)

857 
	#SEND_CM_GLOBAL_CREDIT_AU_SMASK
 0x70000uÎ

	)

858 
	#SEND_CM_GLOBAL_CREDIT_RESETCSR
 0x0000094000030000uÎ

	)

859 
	#SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_MASK
 0xFFFFuÎ

	)

860 
	#SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SHIFT
 0

	)

861 
	#SEND_CM_GLOBAL_CREDIT_SHARED_LIMIT_SMASK
 0xFFFFuÎ

	)

862 
	#SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_MASK
 0xFFFFuÎ

	)

863 
	#SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SHIFT
 32

	)

864 
	#SEND_CM_GLOBAL_CREDIT_TOTAL_CREDIT_LIMIT_SMASK
 0xFFFF00000000uÎ

	)

865 
	#SEND_CM_LOCAL_AU_TABLE0_TO3
 (
TXE
 + 0x000000000520)

	)

866 
	#SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE0_SHIFT
 0

	)

867 
	#SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE1_SHIFT
 16

	)

868 
	#SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE2_SHIFT
 32

	)

869 
	#SEND_CM_LOCAL_AU_TABLE0_TO3_LOCAL_AU_TABLE3_SHIFT
 48

	)

870 
	#SEND_CM_LOCAL_AU_TABLE4_TO7
 (
TXE
 + 0x000000000528)

	)

871 
	#SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE4_SHIFT
 0

	)

872 
	#SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE5_SHIFT
 16

	)

873 
	#SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE6_SHIFT
 32

	)

874 
	#SEND_CM_LOCAL_AU_TABLE4_TO7_LOCAL_AU_TABLE7_SHIFT
 48

	)

875 
	#SEND_CM_REMOTE_AU_TABLE0_TO3
 (
TXE
 + 0x000000000530)

	)

876 
	#SEND_CM_REMOTE_AU_TABLE4_TO7
 (
TXE
 + 0x000000000538)

	)

877 
	#SEND_CM_TIMER_CTRL
 (
TXE
 + 0x000000000518)

	)

878 
	#SEND_CONTEXTS
 (
TXE
 + 0x000000000010)

	)

879 
	#SEND_CONTEXT_SET_CTRL
 (
TXE
 + 0x000000000200)

	)

880 
	#SEND_COUNTER_ARRAY32
 (
TXE
 + 0x000000000300)

	)

881 
	#SEND_COUNTER_ARRAY64
 (
TXE
 + 0x000000000400)

	)

882 
	#SEND_CTRL
 (
TXE
 + 0x000000000000)

	)

883 
	#SEND_CTRL_CM_RESET_SMASK
 0x4uÎ

	)

884 
	#SEND_CTRL_SEND_ENABLE_SMASK
 0x1uÎ

	)

885 
	#SEND_CTRL_UNSUPPORTED_VL_SHIFT
 3

	)

886 
	#SEND_CTRL_UNSUPPORTED_VL_MASK
 0xFFuÎ

	)

887 
	#SEND_CTRL_UNSUPPORTED_VL_SMASK
 (
SEND_CTRL_UNSUPPORTED_VL_MASK
 \

888 << 
SEND_CTRL_UNSUPPORTED_VL_SHIFT
)

	)

889 
	#SEND_CTRL_VL_ARBITER_ENABLE_SMASK
 0x2uÎ

	)

890 
	#SEND_CTXT_CHECK_ENABLE
 (
TXE
 + 0x000000100080)

	)

891 
	#SEND_CTXT_CHECK_ENABLE_CHECK_BYPASS_VL_MAPPING_SMASK
 0x80uÎ

	)

892 
	#SEND_CTXT_CHECK_ENABLE_CHECK_ENABLE_SMASK
 0x1uÎ

	)

893 
	#SEND_CTXT_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
 0x4uÎ

	)

894 
	#SEND_CTXT_CHECK_ENABLE_CHECK_OPCODE_SMASK
 0x20uÎ

	)

895 
	#SEND_CTXT_CHECK_ENABLE_CHECK_PARTITION_KEY_SMASK
 0x8uÎ

	)

896 
	#SEND_CTXT_CHECK_ENABLE_CHECK_SLID_SMASK
 0x10uÎ

	)

897 
	#SEND_CTXT_CHECK_ENABLE_CHECK_VL_MAPPING_SMASK
 0x40uÎ

	)

898 
	#SEND_CTXT_CHECK_ENABLE_CHECK_VL_SMASK
 0x2uÎ

	)

899 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_BAD_PKT_LEN_SMASK
 0x20000uÎ

	)

900 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_BYPASS_BAD_PKT_LEN_SMASK
 \

901 0x200000uÎ

	)

902 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_BYPASS_SMASK
 0x800uÎ

	)

903 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_GRH_SMASK
 0x400uÎ

	)

904 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_KDETH_PACKETS_SMASK
 0x1000uÎ

	)

905 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_NON_KDETH_PACKETS_SMASK
 0x2000uÎ

	)

906 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK
 \

907 0x100000uÎ

	)

908 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_TEST_SMASK
 0x10000uÎ

	)

909 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_RAW_IPV6_SMASK
 0x200uÎ

	)

910 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_RAW_SMASK
 0x100uÎ

	)

911 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_LONG_BYPASS_PACKETS_SMASK
 \

912 0x80000uÎ

	)

913 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_LONG_IB_PACKETS_SMASK
 \

914 0x40000uÎ

	)

915 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_SMALL_BYPASS_PACKETS_SMASK
 \

916 0x8000uÎ

	)

917 
	#SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_SMALL_IB_PACKETS_SMASK
 \

918 0x4000uÎ

	)

919 
	#SEND_CTXT_CHECK_JOB_KEY
 (
TXE
 + 0x000000100090)

	)

920 
	#SEND_CTXT_CHECK_JOB_KEY_ALLOW_PERMISSIVE_SMASK
 0x100000000uÎ

	)

921 
	#SEND_CTXT_CHECK_JOB_KEY_MASK_SMASK
 0xFFFF0000uÎ

	)

922 
	#SEND_CTXT_CHECK_JOB_KEY_VALUE_MASK
 0xFFFFuÎ

	)

923 
	#SEND_CTXT_CHECK_JOB_KEY_VALUE_SHIFT
 0

	)

924 
	#SEND_CTXT_CHECK_OPCODE
 (
TXE
 + 0x0000001000A8)

	)

925 
	#SEND_CTXT_CHECK_OPCODE_MASK_SHIFT
 8

	)

926 
	#SEND_CTXT_CHECK_OPCODE_VALUE_SHIFT
 0

	)

927 
	#SEND_CTXT_CHECK_PARTITION_KEY
 (
TXE
 + 0x000000100098)

	)

928 
	#SEND_CTXT_CHECK_PARTITION_KEY_VALUE_MASK
 0xFFFFuÎ

	)

929 
	#SEND_CTXT_CHECK_PARTITION_KEY_VALUE_SHIFT
 0

	)

930 
	#SEND_CTXT_CHECK_SLID
 (
TXE
 + 0x0000001000A0)

	)

931 
	#SEND_CTXT_CHECK_SLID_MASK_MASK
 0xFFFFuÎ

	)

932 
	#SEND_CTXT_CHECK_SLID_MASK_SHIFT
 16

	)

933 
	#SEND_CTXT_CHECK_SLID_VALUE_MASK
 0xFFFFuÎ

	)

934 
	#SEND_CTXT_CHECK_SLID_VALUE_SHIFT
 0

	)

935 
	#SEND_CTXT_CHECK_VL
 (
TXE
 + 0x000000100088)

	)

936 
	#SEND_CTXT_CREDIT_CTRL
 (
TXE
 + 0x000000100010)

	)

937 
	#SEND_CTXT_CREDIT_CTRL_CREDIT_INTR_SMASK
 0x20000uÎ

	)

938 
	#SEND_CTXT_CREDIT_CTRL_EARLY_RETURN_SMASK
 0x10000uÎ

	)

939 
	#SEND_CTXT_CREDIT_CTRL_THRESHOLD_MASK
 0x7FFuÎ

	)

940 
	#SEND_CTXT_CREDIT_CTRL_THRESHOLD_SHIFT
 0

	)

941 
	#SEND_CTXT_CREDIT_CTRL_THRESHOLD_SMASK
 0x7FFuÎ

	)

942 
	#SEND_CTXT_CREDIT_STATUS
 (
TXE
 + 0x000000100018)

	)

943 
	#SEND_CTXT_CREDIT_STATUS_CURRENT_FREE_COUNTER_MASK
 0x7FFuÎ

	)

944 
	#SEND_CTXT_CREDIT_STATUS_CURRENT_FREE_COUNTER_SHIFT
 32

	)

945 
	#SEND_CTXT_CREDIT_STATUS_LAST_RETURNED_COUNTER_SMASK
 0x7FFuÎ

	)

946 
	#SEND_CTXT_CREDIT_FORCE
 (
TXE
 + 0x000000100028)

	)

947 
	#SEND_CTXT_CREDIT_FORCE_FORCE_RETURN_SMASK
 0x1uÎ

	)

948 
	#SEND_CTXT_CREDIT_RETURN_ADDR
 (
TXE
 + 0x000000100020)

	)

949 
	#SEND_CTXT_CREDIT_RETURN_ADDR_ADDRESS_SMASK
 0xFFFFFFFFFFC0uÎ

	)

950 
	#SEND_CTXT_CTRL
 (
TXE
 + 0x000000100000)

	)

951 
	#SEND_CTXT_CTRL_CTXT_BASE_MASK
 0x3FFFuÎ

	)

952 
	#SEND_CTXT_CTRL_CTXT_BASE_SHIFT
 32

	)

953 
	#SEND_CTXT_CTRL_CTXT_DEPTH_MASK
 0x7FFuÎ

	)

954 
	#SEND_CTXT_CTRL_CTXT_DEPTH_SHIFT
 48

	)

955 
	#SEND_CTXT_CTRL_CTXT_ENABLE_SMASK
 0x1uÎ

	)

956 
	#SEND_CTXT_ERR_CLEAR
 (
TXE
 + 0x000000100050)

	)

957 
	#SEND_CTXT_ERR_MASK
 (
TXE
 + 0x000000100048)

	)

958 
	#SEND_CTXT_ERR_STATUS
 (
TXE
 + 0x000000100040)

	)

959 
	#SEND_CTXT_ERR_STATUS_PIO_DISALLOWED_PACKET_ERR_SMASK
 0x2uÎ

	)

960 
	#SEND_CTXT_ERR_STATUS_PIO_INCONSISTENT_SOP_ERR_SMASK
 0x1uÎ

	)

961 
	#SEND_CTXT_ERR_STATUS_PIO_WRITE_CROSSES_BOUNDARY_ERR_SMASK
 0x4uÎ

	)

962 
	#SEND_CTXT_ERR_STATUS_PIO_WRITE_OUT_OF_BOUNDS_ERR_SMASK
 0x10uÎ

	)

963 
	#SEND_CTXT_ERR_STATUS_PIO_WRITE_OVERFLOW_ERR_SMASK
 0x8uÎ

	)

964 
	#SEND_CTXT_STATUS
 (
TXE
 + 0x000000100008)

	)

965 
	#SEND_CTXT_STATUS_CTXT_HALTED_SMASK
 0x1uÎ

	)

966 
	#SEND_DMA_BASE_ADDR
 (
TXE
 + 0x000000200010)

	)

967 
	#SEND_DMA_CHECK_ENABLE
 (
TXE
 + 0x000000200080)

	)

968 
	#SEND_DMA_CHECK_ENABLE_CHECK_BYPASS_VL_MAPPING_SMASK
 0x80uÎ

	)

969 
	#SEND_DMA_CHECK_ENABLE_CHECK_ENABLE_SMASK
 0x1uÎ

	)

970 
	#SEND_DMA_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
 0x4uÎ

	)

971 
	#SEND_DMA_CHECK_ENABLE_CHECK_OPCODE_SMASK
 0x20uÎ

	)

972 
	#SEND_DMA_CHECK_ENABLE_CHECK_PARTITION_KEY_SMASK
 0x8uÎ

	)

973 
	#SEND_DMA_CHECK_ENABLE_CHECK_SLID_SMASK
 0x10uÎ

	)

974 
	#SEND_DMA_CHECK_ENABLE_CHECK_VL_MAPPING_SMASK
 0x40uÎ

	)

975 
	#SEND_DMA_CHECK_ENABLE_CHECK_VL_SMASK
 0x2uÎ

	)

976 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_BAD_PKT_LEN_SMASK
 0x20000uÎ

	)

977 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_BYPASS_BAD_PKT_LEN_SMASK
 0x200000uÎ

	)

978 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK
 \

979 0x100000uÎ

	)

980 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_RAW_IPV6_SMASK
 0x200uÎ

	)

981 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_RAW_SMASK
 0x100uÎ

	)

982 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_LONG_BYPASS_PACKETS_SMASK
 \

983 0x80000uÎ

	)

984 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_LONG_IB_PACKETS_SMASK
 0x40000uÎ

	)

985 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_SMALL_BYPASS_PACKETS_SMASK
 \

986 0x8000uÎ

	)

987 
	#SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_SMALL_IB_PACKETS_SMASK
 0x4000uÎ

	)

988 
	#SEND_DMA_CHECK_JOB_KEY
 (
TXE
 + 0x000000200090)

	)

989 
	#SEND_DMA_CHECK_OPCODE
 (
TXE
 + 0x0000002000A8)

	)

990 
	#SEND_DMA_CHECK_PARTITION_KEY
 (
TXE
 + 0x000000200098)

	)

991 
	#SEND_DMA_CHECK_SLID
 (
TXE
 + 0x0000002000A0)

	)

992 
	#SEND_DMA_CHECK_SLID_MASK_MASK
 0xFFFFuÎ

	)

993 
	#SEND_DMA_CHECK_SLID_MASK_SHIFT
 16

	)

994 
	#SEND_DMA_CHECK_SLID_VALUE_MASK
 0xFFFFuÎ

	)

995 
	#SEND_DMA_CHECK_SLID_VALUE_SHIFT
 0

	)

996 
	#SEND_DMA_CHECK_VL
 (
TXE
 + 0x000000200088)

	)

997 
	#SEND_DMA_CTRL
 (
TXE
 + 0x000000200000)

	)

998 
	#SEND_DMA_CTRL_SDMA_CLEANUP_SMASK
 0x4uÎ

	)

999 
	#SEND_DMA_CTRL_SDMA_ENABLE_SMASK
 0x1uÎ

	)

1000 
	#SEND_DMA_CTRL_SDMA_HALT_SMASK
 0x2uÎ

	)

1001 
	#SEND_DMA_CTRL_SDMA_INT_ENABLE_SMASK
 0x8uÎ

	)

1002 
	#SEND_DMA_DESC_CNT
 (
TXE
 + 0x000000200050)

	)

1003 
	#SEND_DMA_DESC_CNT_CNT_MASK
 0xFFFFuÎ

	)

1004 
	#SEND_DMA_DESC_CNT_CNT_SHIFT
 0

	)

1005 
	#SEND_DMA_ENG_ERR_CLEAR
 (
TXE
 + 0x000000200070)

	)

1006 
	#SEND_DMA_ENG_ERR_CLEAR_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_MASK
 0x1uÎ

	)

1007 
	#SEND_DMA_ENG_ERR_CLEAR_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_SHIFT
 18

	)

1008 
	#SEND_DMA_ENG_ERR_MASK
 (
TXE
 + 0x000000200068)

	)

1009 
	#SEND_DMA_ENG_ERR_STATUS
 (
TXE
 + 0x000000200060)

	)

1010 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_ASSEMBLY_UNC_ERR_SMASK
 0x8000uÎ

	)

1011 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_DESC_TABLE_UNC_ERR_SMASK
 0x4000uÎ

	)

1012 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_FIRST_DESC_ERR_SMASK
 0x10uÎ

	)

1013 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_GEN_MISMATCH_ERR_SMASK
 0x2uÎ

	)

1014 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HALT_ERR_SMASK
 0x40uÎ

	)

1015 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HEADER_ADDRESS_ERR_SMASK
 0x800uÎ

	)

1016 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HEADER_LENGTH_ERR_SMASK
 0x1000uÎ

	)

1017 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_SMASK
 \

1018 0x40000uÎ

	)

1019 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HEADER_SELECT_ERR_SMASK
 0x400uÎ

	)

1020 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_HEADER_STORAGE_UNC_ERR_SMASK
 \

1021 0x20000uÎ

	)

1022 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_LENGTH_MISMATCH_ERR_SMASK
 0x80uÎ

	)

1023 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_MEM_READ_ERR_SMASK
 0x20uÎ

	)

1024 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_PACKET_DESC_OVERFLOW_ERR_SMASK
 \

1025 0x100uÎ

	)

1026 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_PACKET_TRACKING_UNC_ERR_SMASK
 \

1027 0x10000uÎ

	)

1028 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_TAIL_OUT_OF_BOUNDS_ERR_SMASK
 0x8uÎ

	)

1029 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_TIMEOUT_ERR_SMASK
 0x2000uÎ

	)

1030 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_TOO_LONG_ERR_SMASK
 0x4uÎ

	)

1031 
	#SEND_DMA_ENG_ERR_STATUS_SDMA_WRONG_DW_ERR_SMASK
 0x1uÎ

	)

1032 
	#SEND_DMA_ENGINES
 (
TXE
 + 0x000000000018)

	)

1033 
	#SEND_DMA_ERR_CLEAR
 (
TXE
 + 0x000000000070)

	)

1034 
	#SEND_DMA_ERR_MASK
 (
TXE
 + 0x000000000068)

	)

1035 
	#SEND_DMA_ERR_STATUS
 (
TXE
 + 0x000000000060)

	)

1036 
	#SEND_DMA_ERR_STATUS_SDMA_CSR_PARITY_ERR_SMASK
 0x2uÎ

	)

1037 
	#SEND_DMA_ERR_STATUS_SDMA_PCIE_REQ_TRACKING_COR_ERR_SMASK
 0x8uÎ

	)

1038 
	#SEND_DMA_ERR_STATUS_SDMA_PCIE_REQ_TRACKING_UNC_ERR_SMASK
 0x4uÎ

	)

1039 
	#SEND_DMA_ERR_STATUS_SDMA_RPY_TAG_ERR_SMASK
 0x1uÎ

	)

1040 
	#SEND_DMA_HEAD
 (
TXE
 + 0x000000200028)

	)

1041 
	#SEND_DMA_HEAD_ADDR
 (
TXE
 + 0x000000200030)

	)

1042 
	#SEND_DMA_LEN_GEN
 (
TXE
 + 0x000000200018)

	)

1043 
	#SEND_DMA_LEN_GEN_GENERATION_SHIFT
 16

	)

1044 
	#SEND_DMA_LEN_GEN_LENGTH_SHIFT
 6

	)

1045 
	#SEND_DMA_MEMORY
 (
TXE
 + 0x0000002000B0)

	)

1046 
	#SEND_DMA_MEMORY_SDMA_MEMORY_CNT_SHIFT
 16

	)

1047 
	#SEND_DMA_MEMORY_SDMA_MEMORY_INDEX_SHIFT
 0

	)

1048 
	#SEND_DMA_MEM_SIZE
 (
TXE
 + 0x000000000028)

	)

1049 
	#SEND_DMA_PRIORITY_THLD
 (
TXE
 + 0x000000200038)

	)

1050 
	#SEND_DMA_RELOAD_CNT
 (
TXE
 + 0x000000200048)

	)

1051 
	#SEND_DMA_STATUS
 (
TXE
 + 0x000000200008)

	)

1052 
	#SEND_DMA_STATUS_ENG_CLEANED_UP_SMASK
 0x200000000000000uÎ

	)

1053 
	#SEND_DMA_STATUS_ENG_HALTED_SMASK
 0x100000000000000uÎ

	)

1054 
	#SEND_DMA_TAIL
 (
TXE
 + 0x000000200020)

	)

1055 
	#SEND_EGRESS_CTXT_STATUS
 (
TXE
 + 0x000000000800)

	)

1056 
	#SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_HALT_STATUS_SMASK
 0x10000uÎ

	)

1057 
	#SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_PACKET_OCCUPANCY_SHIFT
 0

	)

1058 
	#SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_PACKET_OCCUPANCY_SMASK
 \

1059 0x3FFFuÎ

	)

1060 
	#SEND_EGRESS_ERR_CLEAR
 (
TXE
 + 0x000000000090)

	)

1061 
	#SEND_EGRESS_ERR_INFO
 (
TXE
 + 0x000000000F00)

	)

1062 
	#SEND_EGRESS_ERR_INFO_BAD_PKT_LEN_ERR_SMASK
 0x20000uÎ

	)

1063 
	#SEND_EGRESS_ERR_INFO_BYPASS_ERR_SMASK
 0x800uÎ

	)

1064 
	#SEND_EGRESS_ERR_INFO_GRH_ERR_SMASK
 0x400uÎ

	)

1065 
	#SEND_EGRESS_ERR_INFO_JOB_KEY_ERR_SMASK
 0x4uÎ

	)

1066 
	#SEND_EGRESS_ERR_INFO_KDETH_PACKETS_ERR_SMASK
 0x1000uÎ

	)

1067 
	#SEND_EGRESS_ERR_INFO_NON_KDETH_PACKETS_ERR_SMASK
 0x2000uÎ

	)

1068 
	#SEND_EGRESS_ERR_INFO_OPCODE_ERR_SMASK
 0x20uÎ

	)

1069 
	#SEND_EGRESS_ERR_INFO_PARTITION_KEY_ERR_SMASK
 0x8uÎ

	)

1070 
	#SEND_EGRESS_ERR_INFO_PBC_STATIC_RATE_CONTROL_ERR_SMASK
 0x100000uÎ

	)

1071 
	#SEND_EGRESS_ERR_INFO_PBC_TEST_ERR_SMASK
 0x10000uÎ

	)

1072 
	#SEND_EGRESS_ERR_INFO_RAW_ERR_SMASK
 0x100uÎ

	)

1073 
	#SEND_EGRESS_ERR_INFO_RAW_IPV6_ERR_SMASK
 0x200uÎ

	)

1074 
	#SEND_EGRESS_ERR_INFO_SLID_ERR_SMASK
 0x10uÎ

	)

1075 
	#SEND_EGRESS_ERR_INFO_TOO_LONG_BYPASS_PACKETS_ERR_SMASK
 0x80000uÎ

	)

1076 
	#SEND_EGRESS_ERR_INFO_TOO_LONG_IB_PACKET_ERR_SMASK
 0x40000uÎ

	)

1077 
	#SEND_EGRESS_ERR_INFO_TOO_SMALL_BYPASS_PACKETS_ERR_SMASK
 0x8000uÎ

	)

1078 
	#SEND_EGRESS_ERR_INFO_TOO_SMALL_IB_PACKETS_ERR_SMASK
 0x4000uÎ

	)

1079 
	#SEND_EGRESS_ERR_INFO_VL_ERR_SMASK
 0x2uÎ

	)

1080 
	#SEND_EGRESS_ERR_INFO_VL_MAPPING_ERR_SMASK
 0x40uÎ

	)

1081 
	#SEND_EGRESS_ERR_MASK
 (
TXE
 + 0x000000000088)

	)

1082 
	#SEND_EGRESS_ERR_SOURCE
 (
TXE
 + 0x000000000F08)

	)

1083 
	#SEND_EGRESS_ERR_STATUS
 (
TXE
 + 0x000000000080)

	)

1084 
	#SEND_EGRESS_ERR_STATUS_TX_CONFIG_PARITY_ERR_SMASK
 0x8000uÎ

	)

1085 
	#SEND_EGRESS_ERR_STATUS_TX_CREDIT_OVERRUN_ERR_SMASK
 \

1086 0x200000000000000uÎ

	)

1087 
	#SEND_EGRESS_ERR_STATUS_TX_CREDIT_RETURN_PARITY_ERR_SMASK
 \

1088 0x20000000000uÎ

	)

1089 
	#SEND_EGRESS_ERR_STATUS_TX_CREDIT_RETURN_VL_ERR_SMASK
 \

1090 0x800000000000uÎ

	)

1091 
	#SEND_EGRESS_ERR_STATUS_TX_EGRESS_FIFO_COR_ERR_SMASK
 \

1092 0x2000000000000000uÎ

	)

1093 
	#SEND_EGRESS_ERR_STATUS_TX_EGRESS_FIFO_UNC_ERR_SMASK
 \

1094 0x200000000000uÎ

	)

1095 
	#SEND_EGRESS_ERR_STATUS_TX_EGRESS_FIFO_UNDERRUN_OR_PARITY_ERR_SMASK
 \

1096 0x8uÎ

	)

1097 
	#SEND_EGRESS_ERR_STATUS_TX_HCRC_INSERTION_ERR_SMASK
 \

1098 0x400000000000uÎ

	)

1099 
	#SEND_EGRESS_ERR_STATUS_TX_ILLEGAL_VL_ERR_SMASK
 0x1000uÎ

	)

1100 
	#SEND_EGRESS_ERR_STATUS_TX_INCORRECT_LINK_STATE_ERR_SMASK
 0x20uÎ

	)

1101 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_CSR_PARITY_ERR_SMASK
 0x2000uÎ

	)

1102 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO0_COR_ERR_SMASK
 \

1103 0x1000000000000uÎ

	)

1104 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO0_UNC_OR_PARITY_ERR_SMASK
 \

1105 0x100000000uÎ

	)

1106 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO1_COR_ERR_SMASK
 \

1107 0x2000000000000uÎ

	)

1108 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO1_UNC_OR_PARITY_ERR_SMASK
 \

1109 0x200000000uÎ

	)

1110 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO2_COR_ERR_SMASK
 \

1111 0x4000000000000uÎ

	)

1112 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO2_UNC_OR_PARITY_ERR_SMASK
 \

1113 0x400000000uÎ

	)

1114 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO3_COR_ERR_SMASK
 \

1115 0x8000000000000uÎ

	)

1116 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO3_UNC_OR_PARITY_ERR_SMASK
 \

1117 0x800000000uÎ

	)

1118 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO4_COR_ERR_SMASK
 \

1119 0x10000000000000uÎ

	)

1120 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO4_UNC_OR_PARITY_ERR_SMASK
 \

1121 0x1000000000uÎ

	)

1122 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO5_COR_ERR_SMASK
 \

1123 0x20000000000000uÎ

	)

1124 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO5_UNC_OR_PARITY_ERR_SMASK
 \

1125 0x2000000000uÎ

	)

1126 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO6_COR_ERR_SMASK
 \

1127 0x40000000000000uÎ

	)

1128 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO6_UNC_OR_PARITY_ERR_SMASK
 \

1129 0x4000000000uÎ

	)

1130 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO7_COR_ERR_SMASK
 \

1131 0x80000000000000uÎ

	)

1132 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO7_UNC_OR_PARITY_ERR_SMASK
 \

1133 0x8000000000uÎ

	)

1134 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO8_COR_ERR_SMASK
 \

1135 0x100000000000000uÎ

	)

1136 
	#SEND_EGRESS_ERR_STATUS_TX_LAUNCH_FIFO8_UNC_OR_PARITY_ERR_SMASK
 \

1137 0x10000000000uÎ

	)

1138 
	#SEND_EGRESS_ERR_STATUS_TX_LINKDOWN_ERR_SMASK
 0x10uÎ

	)

1139 
	#SEND_EGRESS_ERR_STATUS_TX_PIO_LAUNCH_INTF_PARITY_ERR_SMASK
 0x80uÎ

	)

1140 
	#SEND_EGRESS_ERR_STATUS_TX_PKT_INTEGRITY_MEM_COR_ERR_SMASK
 0x1uÎ

	)

1141 
	#SEND_EGRESS_ERR_STATUS_TX_PKT_INTEGRITY_MEM_UNC_ERR_SMASK
 0x2uÎ

	)

1142 
	#SEND_EGRESS_ERR_STATUS_TX_READ_PIO_MEMORY_COR_ERR_SMASK
 \

1143 0x1000000000000000uÎ

	)

1144 
	#SEND_EGRESS_ERR_STATUS_TX_READ_PIO_MEMORY_CSR_UNC_ERR_SMASK
 \

1145 0x8000000000000000uÎ

	)

1146 
	#SEND_EGRESS_ERR_STATUS_TX_READ_PIO_MEMORY_UNC_ERR_SMASK
 \

1147 0x100000000000uÎ

	)

1148 
	#SEND_EGRESS_ERR_STATUS_TX_READ_SDMA_MEMORY_COR_ERR_SMASK
 \

1149 0x800000000000000uÎ

	)

1150 
	#SEND_EGRESS_ERR_STATUS_TX_READ_SDMA_MEMORY_CSR_UNC_ERR_SMASK
 \

1151 0x4000000000000000uÎ

	)

1152 
	#SEND_EGRESS_ERR_STATUS_TX_READ_SDMA_MEMORY_UNC_ERR_SMASK
 \

1153 0x80000000000uÎ

	)

1154 
	#SEND_EGRESS_ERR_STATUS_TX_SB_HDR_COR_ERR_SMASK
 0x400000000000000uÎ

	)

1155 
	#SEND_EGRESS_ERR_STATUS_TX_SB_HDR_UNC_ERR_SMASK
 0x40000000000uÎ

	)

1156 
	#SEND_EGRESS_ERR_STATUS_TX_SBRD_CTL_CSR_PARITY_ERR_SMASK
 0x4000uÎ

	)

1157 
	#SEND_EGRESS_ERR_STATUS_TX_SBRD_CTL_STATE_MACHINE_PARITY_ERR_SMASK
 \

1158 0x800uÎ

	)

1159 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA0_DISALLOWED_PACKET_ERR_SMASK
 \

1160 0x10000uÎ

	)

1161 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA10_DISALLOWED_PACKET_ERR_SMASK
 \

1162 0x4000000uÎ

	)

1163 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA11_DISALLOWED_PACKET_ERR_SMASK
 \

1164 0x8000000uÎ

	)

1165 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA12_DISALLOWED_PACKET_ERR_SMASK
 \

1166 0x10000000uÎ

	)

1167 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA13_DISALLOWED_PACKET_ERR_SMASK
 \

1168 0x20000000uÎ

	)

1169 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA14_DISALLOWED_PACKET_ERR_SMASK
 \

1170 0x40000000uÎ

	)

1171 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA15_DISALLOWED_PACKET_ERR_SMASK
 \

1172 0x80000000uÎ

	)

1173 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA1_DISALLOWED_PACKET_ERR_SMASK
 \

1174 0x20000uÎ

	)

1175 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA2_DISALLOWED_PACKET_ERR_SMASK
 \

1176 0x40000uÎ

	)

1177 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA3_DISALLOWED_PACKET_ERR_SMASK
 \

1178 0x80000uÎ

	)

1179 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA4_DISALLOWED_PACKET_ERR_SMASK
 \

1180 0x100000uÎ

	)

1181 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA5_DISALLOWED_PACKET_ERR_SMASK
 \

1182 0x200000uÎ

	)

1183 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA6_DISALLOWED_PACKET_ERR_SMASK
 \

1184 0x400000uÎ

	)

1185 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA7_DISALLOWED_PACKET_ERR_SMASK
 \

1186 0x800000uÎ

	)

1187 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA8_DISALLOWED_PACKET_ERR_SMASK
 \

1188 0x1000000uÎ

	)

1189 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA9_DISALLOWED_PACKET_ERR_SMASK
 \

1190 0x2000000uÎ

	)

1191 
	#SEND_EGRESS_ERR_STATUS_TX_SDMA_LAUNCH_INTF_PARITY_ERR_SMASK
 \

1192 0x100uÎ

	)

1193 
	#SEND_EGRESS_SEND_DMA_STATUS
 (
TXE
 + 0x000000000E00)

	)

1194 
	#SEND_EGRESS_SEND_DMA_STATUS_SDMA_EGRESS_PACKET_OCCUPANCY_SHIFT
 0

	)

1195 
	#SEND_EGRESS_SEND_DMA_STATUS_SDMA_EGRESS_PACKET_OCCUPANCY_SMASK
 \

1196 0x3FFFuÎ

	)

1197 
	#SEND_ERR_CLEAR
 (
TXE
 + 0x0000000000F0)

	)

1198 
	#SEND_ERR_MASK
 (
TXE
 + 0x0000000000E8)

	)

1199 
	#SEND_ERR_STATUS
 (
TXE
 + 0x0000000000E0)

	)

1200 
	#SEND_ERR_STATUS_SEND_CSR_PARITY_ERR_SMASK
 0x1uÎ

	)

1201 
	#SEND_ERR_STATUS_SEND_CSR_READ_BAD_ADDR_ERR_SMASK
 0x2uÎ

	)

1202 
	#SEND_ERR_STATUS_SEND_CSR_WRITE_BAD_ADDR_ERR_SMASK
 0x4uÎ

	)

1203 
	#SEND_HIGH_PRIORITY_LIMIT
 (
TXE
 + 0x000000000030)

	)

1204 
	#SEND_HIGH_PRIORITY_LIMIT_LIMIT_MASK
 0x3FFFuÎ

	)

1205 
	#SEND_HIGH_PRIORITY_LIMIT_LIMIT_SHIFT
 0

	)

1206 
	#SEND_HIGH_PRIORITY_LIST
 (
TXE
 + 0x000000000180)

	)

1207 
	#SEND_LEN_CHECK0
 (
TXE
 + 0x0000000000D0)

	)

1208 
	#SEND_LEN_CHECK0_LEN_VL0_MASK
 0xFFFuÎ

	)

1209 
	#SEND_LEN_CHECK0_LEN_VL1_SHIFT
 12

	)

1210 
	#SEND_LEN_CHECK1
 (
TXE
 + 0x0000000000D8)

	)

1211 
	#SEND_LEN_CHECK1_LEN_VL15_MASK
 0xFFFuÎ

	)

1212 
	#SEND_LEN_CHECK1_LEN_VL15_SHIFT
 48

	)

1213 
	#SEND_LEN_CHECK1_LEN_VL4_MASK
 0xFFFuÎ

	)

1214 
	#SEND_LEN_CHECK1_LEN_VL5_SHIFT
 12

	)

1215 
	#SEND_LOW_PRIORITY_LIST
 (
TXE
 + 0x000000000100)

	)

1216 
	#SEND_LOW_PRIORITY_LIST_VL_MASK
 0x7uÎ

	)

1217 
	#SEND_LOW_PRIORITY_LIST_VL_SHIFT
 16

	)

1218 
	#SEND_LOW_PRIORITY_LIST_WEIGHT_MASK
 0xFFuÎ

	)

1219 
	#SEND_LOW_PRIORITY_LIST_WEIGHT_SHIFT
 0

	)

1220 
	#SEND_PIO_ERR_CLEAR
 (
TXE
 + 0x000000000050)

	)

1221 
	#SEND_PIO_ERR_CLEAR_PIO_INIT_SM_IN_ERR_SMASK
 0x20000uÎ

	)

1222 
	#SEND_PIO_ERR_MASK
 (
TXE
 + 0x000000000048)

	)

1223 
	#SEND_PIO_ERR_STATUS
 (
TXE
 + 0x000000000040)

	)

1224 
	#SEND_PIO_ERR_STATUS_PIO_BLOCK_QW_COUNT_PARITY_ERR_SMASK
 \

1225 0x1000000uÎ

	)

1226 
	#SEND_PIO_ERR_STATUS_PIO_CREDIT_RET_FIFO_PARITY_ERR_SMASK
 0x8000uÎ

	)

1227 
	#SEND_PIO_ERR_STATUS_PIO_CSR_PARITY_ERR_SMASK
 0x4uÎ

	)

1228 
	#SEND_PIO_ERR_STATUS_PIO_CURRENT_FREE_CNT_PARITY_ERR_SMASK
 \

1229 0x100000000uÎ

	)

1230 
	#SEND_PIO_ERR_STATUS_PIO_HOST_ADDR_MEM_COR_ERR_SMASK
 0x100000uÎ

	)

1231 
	#SEND_PIO_ERR_STATUS_PIO_HOST_ADDR_MEM_UNC_ERR_SMASK
 0x80000uÎ

	)

1232 
	#SEND_PIO_ERR_STATUS_PIO_INIT_SM_IN_ERR_SMASK
 0x20000uÎ

	)

1233 
	#SEND_PIO_ERR_STATUS_PIO_LAST_RETURNED_CNT_PARITY_ERR_SMASK
 \

1234 0x200000000uÎ

	)

1235 
	#SEND_PIO_ERR_STATUS_PIO_PCC_FIFO_PARITY_ERR_SMASK
 0x20uÎ

	)

1236 
	#SEND_PIO_ERR_STATUS_PIO_PCC_SOP_HEAD_PARITY_ERR_SMASK
 \

1237 0x400000000uÎ

	)

1238 
	#SEND_PIO_ERR_STATUS_PIO_PEC_FIFO_PARITY_ERR_SMASK
 0x40uÎ

	)

1239 
	#SEND_PIO_ERR_STATUS_PIO_PEC_SOP_HEAD_PARITY_ERR_SMASK
 \

1240 0x800000000uÎ

	)

1241 
	#SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_FIFO_PARITY_ERR_SMASK
 0x200uÎ

	)

1242 
	#SEND_PIO_ERR_STATUS_PIO_PKT_EVICT_SM_OR_ARB_SM_ERR_SMASK
 0x40000uÎ

	)

1243 
	#SEND_PIO_ERR_STATUS_PIO_PPMC_BQC_MEM_PARITY_ERR_SMASK
 0x10000000uÎ

	)

1244 
	#SEND_PIO_ERR_STATUS_PIO_PPMC_PBL_FIFO_ERR_SMASK
 0x10000uÎ

	)

1245 
	#SEND_PIO_ERR_STATUS_PIO_PPMC_SOP_LEN_ERR_SMASK
 0x20000000uÎ

	)

1246 
	#SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO0_ERR_SMASK
 0x8uÎ

	)

1247 
	#SEND_PIO_ERR_STATUS_PIO_SB_MEM_FIFO1_ERR_SMASK
 0x10uÎ

	)

1248 
	#SEND_PIO_ERR_STATUS_PIO_SBRDCTL_CRREL_PARITY_ERR_SMASK
 0x80uÎ

	)

1249 
	#SEND_PIO_ERR_STATUS_PIO_SBRDCTRL_CRREL_FIFO_PARITY_ERR_SMASK
 \

1250 0x100uÎ

	)

1251 
	#SEND_PIO_ERR_STATUS_PIO_SM_PKT_RESET_PARITY_ERR_SMASK
 0x400uÎ

	)

1252 
	#SEND_PIO_ERR_STATUS_PIO_STATE_MACHINE_ERR_SMASK
 0x400000uÎ

	)

1253 
	#SEND_PIO_ERR_STATUS_PIO_VL_FIFO_PARITY_ERR_SMASK
 0x8000000uÎ

	)

1254 
	#SEND_PIO_ERR_STATUS_PIO_VLF_SOP_PARITY_ERR_SMASK
 0x4000000uÎ

	)

1255 
	#SEND_PIO_ERR_STATUS_PIO_VLF_VL_LEN_PARITY_ERR_SMASK
 0x2000000uÎ

	)

1256 
	#SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK0_COR_ERR_SMASK
 0x2000uÎ

	)

1257 
	#SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK0_UNC_ERR_SMASK
 0x800uÎ

	)

1258 
	#SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK1_COR_ERR_SMASK
 0x4000uÎ

	)

1259 
	#SEND_PIO_ERR_STATUS_PIO_VL_LEN_MEM_BANK1_UNC_ERR_SMASK
 0x1000uÎ

	)

1260 
	#SEND_PIO_ERR_STATUS_PIO_WRITE_ADDR_PARITY_ERR_SMASK
 0x2uÎ

	)

1261 
	#SEND_PIO_ERR_STATUS_PIO_WRITE_BAD_CTXT_ERR_SMASK
 0x1uÎ

	)

1262 
	#SEND_PIO_ERR_STATUS_PIO_WRITE_DATA_PARITY_ERR_SMASK
 0x200000uÎ

	)

1263 
	#SEND_PIO_ERR_STATUS_PIO_WRITE_QW_VALID_PARITY_ERR_SMASK
 0x800000uÎ

	)

1264 
	#SEND_PIO_INIT_CTXT
 (
TXE
 + 0x000000000038)

	)

1265 
	#SEND_PIO_INIT_CTXT_PIO_ALL_CTXT_INIT_SMASK
 0x1uÎ

	)

1266 
	#SEND_PIO_INIT_CTXT_PIO_CTXT_NUM_MASK
 0xFFuÎ

	)

1267 
	#SEND_PIO_INIT_CTXT_PIO_CTXT_NUM_SHIFT
 8

	)

1268 
	#SEND_PIO_INIT_CTXT_PIO_INIT_ERR_SMASK
 0x8uÎ

	)

1269 
	#SEND_PIO_INIT_CTXT_PIO_INIT_IN_PROGRESS_SMASK
 0x4uÎ

	)

1270 
	#SEND_PIO_INIT_CTXT_PIO_SINGLE_CTXT_INIT_SMASK
 0x2uÎ

	)

1271 
	#SEND_PIO_MEM_SIZE
 (
TXE
 + 0x000000000020)

	)

1272 
	#SEND_SC2VLT0
 (
TXE
 + 0x0000000000B0)

	)

1273 
	#SEND_SC2VLT0_SC0_SHIFT
 0

	)

1274 
	#SEND_SC2VLT0_SC1_SHIFT
 8

	)

1275 
	#SEND_SC2VLT0_SC2_SHIFT
 16

	)

1276 
	#SEND_SC2VLT0_SC3_SHIFT
 24

	)

1277 
	#SEND_SC2VLT0_SC4_SHIFT
 32

	)

1278 
	#SEND_SC2VLT0_SC5_SHIFT
 40

	)

1279 
	#SEND_SC2VLT0_SC6_SHIFT
 48

	)

1280 
	#SEND_SC2VLT0_SC7_SHIFT
 56

	)

1281 
	#SEND_SC2VLT1
 (
TXE
 + 0x0000000000B8)

	)

1282 
	#SEND_SC2VLT1_SC10_SHIFT
 16

	)

1283 
	#SEND_SC2VLT1_SC11_SHIFT
 24

	)

1284 
	#SEND_SC2VLT1_SC12_SHIFT
 32

	)

1285 
	#SEND_SC2VLT1_SC13_SHIFT
 40

	)

1286 
	#SEND_SC2VLT1_SC14_SHIFT
 48

	)

1287 
	#SEND_SC2VLT1_SC15_SHIFT
 56

	)

1288 
	#SEND_SC2VLT1_SC8_SHIFT
 0

	)

1289 
	#SEND_SC2VLT1_SC9_SHIFT
 8

	)

1290 
	#SEND_SC2VLT2
 (
TXE
 + 0x0000000000C0)

	)

1291 
	#SEND_SC2VLT2_SC16_SHIFT
 0

	)

1292 
	#SEND_SC2VLT2_SC17_SHIFT
 8

	)

1293 
	#SEND_SC2VLT2_SC18_SHIFT
 16

	)

1294 
	#SEND_SC2VLT2_SC19_SHIFT
 24

	)

1295 
	#SEND_SC2VLT2_SC20_SHIFT
 32

	)

1296 
	#SEND_SC2VLT2_SC21_SHIFT
 40

	)

1297 
	#SEND_SC2VLT2_SC22_SHIFT
 48

	)

1298 
	#SEND_SC2VLT2_SC23_SHIFT
 56

	)

1299 
	#SEND_SC2VLT3
 (
TXE
 + 0x0000000000C8)

	)

1300 
	#SEND_SC2VLT3_SC24_SHIFT
 0

	)

1301 
	#SEND_SC2VLT3_SC25_SHIFT
 8

	)

1302 
	#SEND_SC2VLT3_SC26_SHIFT
 16

	)

1303 
	#SEND_SC2VLT3_SC27_SHIFT
 24

	)

1304 
	#SEND_SC2VLT3_SC28_SHIFT
 32

	)

1305 
	#SEND_SC2VLT3_SC29_SHIFT
 40

	)

1306 
	#SEND_SC2VLT3_SC30_SHIFT
 48

	)

1307 
	#SEND_SC2VLT3_SC31_SHIFT
 56

	)

1308 
	#SEND_STATIC_RATE_CONTROL
 (
TXE
 + 0x0000000000A8)

	)

1309 
	#SEND_STATIC_RATE_CONTROL_CSR_SRC_RELOAD_SHIFT
 0

	)

1310 
	#SEND_STATIC_RATE_CONTROL_CSR_SRC_RELOAD_SMASK
 0xFFFFuÎ

	)

1311 
	#PCIE_CFG_REG_PL2
 (
PCIE
 + 0x000000000708)

	)

1312 
	#PCIE_CFG_REG_PL3
 (
PCIE
 + 0x00000000070C)

	)

1313 
	#PCIE_CFG_REG_PL3_L1_ENT_LATENCY_SHIFT
 27

	)

1314 
	#PCIE_CFG_REG_PL3_L1_ENT_LATENCY_SMASK
 0x38000000

	)

1315 
	#PCIE_CFG_REG_PL102
 (
PCIE
 + 0x000000000898)

	)

1316 
	#PCIE_CFG_REG_PL102_GEN3_EQ_POST_CURSOR_PSET_SHIFT
 12

	)

1317 
	#PCIE_CFG_REG_PL102_GEN3_EQ_CURSOR_PSET_SHIFT
 6

	)

1318 
	#PCIE_CFG_REG_PL102_GEN3_EQ_PRE_CURSOR_PSET_SHIFT
 0

	)

1319 
	#PCIE_CFG_REG_PL103
 (
PCIE
 + 0x00000000089C)

	)

1320 
	#PCIE_CFG_REG_PL105
 (
PCIE
 + 0x0000000008A4)

	)

1321 
	#PCIE_CFG_REG_PL105_GEN3_EQ_VIOLATE_COEF_RULES_SMASK
 0x1uÎ

	)

1322 
	#PCIE_CFG_REG_PL2_LOW_PWR_ENT_CNT_SHIFT
 24

	)

1323 
	#PCIE_CFG_REG_PL100
 (
PCIE
 + 0x000000000890)

	)

1324 
	#PCIE_CFG_REG_PL100_EQ_EIEOS_CNT_SMASK
 0x400uÎ

	)

1325 
	#PCIE_CFG_REG_PL101
 (
PCIE
 + 0x000000000894)

	)

1326 
	#PCIE_CFG_REG_PL101_GEN3_EQ_LOCAL_FS_SHIFT
 6

	)

1327 
	#PCIE_CFG_REG_PL101_GEN3_EQ_LOCAL_LF_SHIFT
 0

	)

1328 
	#PCIE_CFG_REG_PL106
 (
PCIE
 + 0x0000000008A8)

	)

1329 
	#PCIE_CFG_REG_PL106_GEN3_EQ_PSET_REQ_VEC_SHIFT
 8

	)

1330 
	#PCIE_CFG_REG_PL106_GEN3_EQ_EVAL2MS_DISABLE_SMASK
 0x20uÎ

	)

1331 
	#PCIE_CFG_REG_PL106_GEN3_EQ_PHASE23_EXIT_MODE_SMASK
 0x10uÎ

	)

1332 
	#CCE_INT_BLOCKED
 (
CCE
 + 0x000000110C00)

	)

1333 
	#SEND_DMA_IDLE_CNT
 (
TXE
 + 0x000000200040)

	)

1334 
	#SEND_DMA_DESC_FETCHED_CNT
 (
TXE
 + 0x000000200058)

	)

1335 
	#CCE_MSIX_PBA_OFFSET
 0X0110000

	)

	@common.h

48 #iâdeà
_COMMON_H


49 
	#_COMMON_H


	)

51 
	~<rdma/hfi/hfi1_u£r.h
>

62 
	#IPS_PROTO_VERSION
 2

	)

76 
	#HFI1_CAP_USER_SHIFT
 24

	)

77 
	#HFI1_CAP_MASK
 ((1UL << 
HFI1_CAP_USER_SHIFT
è- 1)

	)

79 
	#HFI1_CAP_LOCKED_SHIFT
 63

	)

80 
	#HFI1_CAP_LOCKED_MASK
 0x1ULL

	)

81 
	#HFI1_CAP_LOCKED_SMASK
 (
HFI1_CAP_LOCKED_MASK
 << 
HFI1_CAP_LOCKED_SHIFT
)

	)

83 
	#HFI1_CAP_MISC_SHIFT
 (
HFI1_CAP_USER_SHIFT
 * 2)

	)

84 
	#HFI1_CAP_MISC_MASK
 ((1ULL << (
HFI1_CAP_LOCKED_SHIFT
 - \

85 
HFI1_CAP_MISC_SHIFT
)è- 1)

	)

87 
	#HFI1_CAP_KSET
(
ÿp
è({ 
hfi1_ÿp_mask
 |ð
HFI1_CAP_
##ÿp; hfi1_ÿp_mask; })

	)

88 
	#HFI1_CAP_KCLEAR
(
ÿp
) \

90 
hfi1_ÿp_mask
 &ð~
HFI1_CAP_
##
ÿp
; \

91 
hfi1_ÿp_mask
; \

92 })

	)

93 
	#HFI1_CAP_USET
(
ÿp
) \

95 
hfi1_ÿp_mask
 |ð(
HFI1_CAP_
##
ÿp
 << 
HFI1_CAP_USER_SHIFT
); \

96 
hfi1_ÿp_mask
; \

97 })

	)

98 
	#HFI1_CAP_UCLEAR
(
ÿp
) \

100 
hfi1_ÿp_mask
 &ð~(
HFI1_CAP_
##
ÿp
 << 
HFI1_CAP_USER_SHIFT
); \

101 
hfi1_ÿp_mask
; \

102 })

	)

103 
	#HFI1_CAP_SET
(
ÿp
) \

105 
hfi1_ÿp_mask
 |ð(
HFI1_CAP_
##
ÿp
 | (HFI1_CAP_##cap << \

106 
HFI1_CAP_USER_SHIFT
)); \

107 
hfi1_ÿp_mask
; \

108 })

	)

109 
	#HFI1_CAP_CLEAR
(
ÿp
) \

111 
hfi1_ÿp_mask
 &ð~(
HFI1_CAP_
##
ÿp
 | \

112 (
HFI1_CAP_
##
ÿp
 << 
HFI1_CAP_USER_SHIFT
)); \

113 
hfi1_ÿp_mask
; \

114 })

	)

115 
	#HFI1_CAP_LOCK
() \

116 ({ 
hfi1_ÿp_mask
 |ð
HFI1_CAP_LOCKED_SMASK
; hfi1_ÿp_mask; })

	)

117 
	#HFI1_CAP_LOCKED
(è(!!(
hfi1_ÿp_mask
 & 
HFI1_CAP_LOCKED_SMASK
))

	)

124 
	#HFI1_CAP_WRITABLE_MASK
 (
HFI1_CAP_SDMA_AHG
 | \

125 
HFI1_CAP_HDRSUPP
 | \

126 
HFI1_CAP_MULTI_PKT_EGR
 | \

127 
HFI1_CAP_NODROP_RHQ_FULL
 | \

128 
HFI1_CAP_NODROP_EGR_FULL
 | \

129 
HFI1_CAP_ALLOW_PERM_JKEY
 | \

130 
HFI1_CAP_STATIC_RATE_CTRL
 | \

131 
HFI1_CAP_PRINT_UNIMPL
 | \

132 
HFI1_CAP_TID_UNMAP
 | \

133 
HFI1_CAP_OPFN
)

	)

138 
	#HFI1_CAP_RESERVED_MASK
 ((
HFI1_CAP_SDMA
 | \

139 
HFI1_CAP_USE_SDMA_HEAD
 | \

140 
HFI1_CAP_EXTENDED_PSN
 | \

141 
HFI1_CAP_PRINT_UNIMPL
 | \

142 
HFI1_CAP_NO_INTEGRITY
 | \

143 
HFI1_CAP_PKEY_CHECK
 | \

144 
HFI1_CAP_TID_RDMA
 | \

145 
HFI1_CAP_OPFN
) << \

146 
HFI1_CAP_USER_SHIFT
)

	)

151 
	#HFI1_CAP_MUST_HAVE_KERN
 (
HFI1_CAP_STATIC_RATE_CTRL
)

	)

153 
	#HFI1_CAP_MASK_DEFAULT
 (
HFI1_CAP_HDRSUPP
 | \

154 
HFI1_CAP_NODROP_RHQ_FULL
 | \

155 
HFI1_CAP_NODROP_EGR_FULL
 | \

156 
HFI1_CAP_SDMA
 | \

157 
HFI1_CAP_PRINT_UNIMPL
 | \

158 
HFI1_CAP_STATIC_RATE_CTRL
 | \

159 
HFI1_CAP_PKEY_CHECK
 | \

160 
HFI1_CAP_MULTI_PKT_EGR
 | \

161 
HFI1_CAP_EXTENDED_PSN
 | \

162 ((
HFI1_CAP_HDRSUPP
 | \

163 
HFI1_CAP_MULTI_PKT_EGR
 | \

164 
HFI1_CAP_STATIC_RATE_CTRL
 | \

165 
HFI1_CAP_PKEY_CHECK
 | \

166 
HFI1_CAP_EARLY_CREDIT_RETURN
) << \

167 
HFI1_CAP_USER_SHIFT
))

	)

172 
	#HFI1_CAP_K2U
 (
HFI1_CAP_SDMA
 | \

173 
HFI1_CAP_EXTENDED_PSN
 | \

174 
HFI1_CAP_PKEY_CHECK
 | \

175 
HFI1_CAP_NO_INTEGRITY
)

	)

177 
	#HFI1_USER_SWVERSION
 ((
HFI1_USER_SWMAJOR
 << 
HFI1_SWMAJOR_SHIFT
) | \

178 
HFI1_USER_SWMINOR
)

	)

180 #iâdeà
HFI1_KERN_TYPE


181 
	#HFI1_KERN_TYPE
 0

	)

195 
	#HFI1_KERN_SWVERSION
 ((
HFI1_KERN_TYPE
 << 31è| 
HFI1_USER_SWVERSION
)

	)

201 #iâdeà
HFI1_DRIVER_VERSION_BASE


202 
	#HFI1_DRIVER_VERSION_BASE
 "10.11.0.0"

	)

206 #ifdeà
HFI1_IDSTR


207 
	#HFI1_DRIVER_VERSION
 
HFI1_DRIVER_VERSION_BASE
 " " 
HFI1_IDSTR


	)

209 
	#HFI1_DRIVER_VERSION
 
HFI1_DRIVER_VERSION_BASE


	)

216 
	#JKEY_SEC_SPLIT
 8

	)

217 
	#JKEY_SEC_MASK
 0xFF

	)

226 
	#_DIAG_PKT_VERS
 1

	)

227 
	sdŸg_pkt
 {

228 
__u16
 
	mv”siÚ
;

229 
__u16
 
	mun™
;

230 
__u16
 
	msw_šdex
;

231 
__u16
 
	mËn
;

232 
__u16
 
	mpÜt
;

233 
__u16
 
	munu£d
;

234 
__u32
 
	mæags
;

235 
__u64
 
	md©a
;

236 
__u64
 
	mpbc
;

240 
	#F_DIAGPKT_WAIT
 0x1

	)

250 
	#RHF_PKT_LEN_SHIFT
 0

	)

251 
	#RHF_PKT_LEN_MASK
 0xfffuÎ

	)

252 
	#RHF_PKT_LEN_SMASK
 (
RHF_PKT_LEN_MASK
 << 
RHF_PKT_LEN_SHIFT
)

	)

254 
	#RHF_RCV_TYPE_SHIFT
 12

	)

255 
	#RHF_RCV_TYPE_MASK
 0x7uÎ

	)

256 
	#RHF_RCV_TYPE_SMASK
 (
RHF_RCV_TYPE_MASK
 << 
RHF_RCV_TYPE_SHIFT
)

	)

258 
	#RHF_USE_EGR_BFR_SHIFT
 15

	)

259 
	#RHF_USE_EGR_BFR_MASK
 0x1uÎ

	)

260 
	#RHF_USE_EGR_BFR_SMASK
 (
RHF_USE_EGR_BFR_MASK
 << 
RHF_USE_EGR_BFR_SHIFT
)

	)

262 
	#RHF_EGR_INDEX_SHIFT
 16

	)

263 
	#RHF_EGR_INDEX_MASK
 0x7ffuÎ

	)

264 
	#RHF_EGR_INDEX_SMASK
 (
RHF_EGR_INDEX_MASK
 << 
RHF_EGR_INDEX_SHIFT
)

	)

266 
	#RHF_DC_INFO_SHIFT
 27

	)

267 
	#RHF_DC_INFO_MASK
 0x1uÎ

	)

268 
	#RHF_DC_INFO_SMASK
 (
RHF_DC_INFO_MASK
 << 
RHF_DC_INFO_SHIFT
)

	)

270 
	#RHF_RCV_SEQ_SHIFT
 28

	)

271 
	#RHF_RCV_SEQ_MASK
 0xfuÎ

	)

272 
	#RHF_RCV_SEQ_SMASK
 (
RHF_RCV_SEQ_MASK
 << 
RHF_RCV_SEQ_SHIFT
)

	)

274 
	#RHF_EGR_OFFSET_SHIFT
 32

	)

275 
	#RHF_EGR_OFFSET_MASK
 0xfffuÎ

	)

276 
	#RHF_EGR_OFFSET_SMASK
 (
RHF_EGR_OFFSET_MASK
 << 
RHF_EGR_OFFSET_SHIFT
)

	)

277 
	#RHF_HDRQ_OFFSET_SHIFT
 44

	)

278 
	#RHF_HDRQ_OFFSET_MASK
 0x1ffuÎ

	)

279 
	#RHF_HDRQ_OFFSET_SMASK
 (
RHF_HDRQ_OFFSET_MASK
 << 
RHF_HDRQ_OFFSET_SHIFT
)

	)

280 
	#RHF_K_HDR_LEN_ERR
 (0x1uÎ << 53)

	)

281 
	#RHF_DC_UNC_ERR
 (0x1uÎ << 54)

	)

282 
	#RHF_DC_ERR
 (0x1uÎ << 55)

	)

283 
	#RHF_RCV_TYPE_ERR_SHIFT
 56

	)

284 
	#RHF_RCV_TYPE_ERR_MASK
 0x7ul

	)

285 
	#RHF_RCV_TYPE_ERR_SMASK
 (
RHF_RCV_TYPE_ERR_MASK
 << 
RHF_RCV_TYPE_ERR_SHIFT
)

	)

286 
	#RHF_TID_ERR
 (0x1uÎ << 59)

	)

287 
	#RHF_LEN_ERR
 (0x1uÎ << 60)

	)

288 
	#RHF_ECC_ERR
 (0x1uÎ << 61)

	)

289 
	#RHF_RESERVED
 (0x1uÎ << 62)

	)

290 
	#RHF_ICRC_ERR
 (0x1uÎ << 63)

	)

292 
	#RHF_ERROR_SMASK
 0xfã0000000000000uÎ

	)

295 
	#RHF_RCV_TYPE_EXPECTED
 0

	)

296 
	#RHF_RCV_TYPE_EAGER
 1

	)

297 
	#RHF_RCV_TYPE_IB
 2

	)

298 
	#RHF_RCV_TYPE_ERROR
 3

	)

299 
	#RHF_RCV_TYPE_BYPASS
 4

	)

300 
	#RHF_RCV_TYPE_INVALID5
 5

	)

301 
	#RHF_RCV_TYPE_INVALID6
 6

	)

302 
	#RHF_RCV_TYPE_INVALID7
 7

	)

305 
	#RHF_RTE_EXPECTED_FLOW_SEQ_ERR
 0x2

	)

306 
	#RHF_RTE_EXPECTED_FLOW_GEN_ERR
 0x4

	)

309 
	#RHF_RTE_EAGER_NO_ERR
 0x0

	)

312 
	#RHF_RTE_IB_NO_ERR
 0x0

	)

315 
	#RHF_RTE_ERROR_NO_ERR
 0x0

	)

316 
	#RHF_RTE_ERROR_OP_CODE_ERR
 0x1

	)

317 
	#RHF_RTE_ERROR_KHDR_MIN_LEN_ERR
 0x2

	)

318 
	#RHF_RTE_ERROR_KHDR_HCRC_ERR
 0x3

	)

319 
	#RHF_RTE_ERROR_KHDR_KVER_ERR
 0x4

	)

320 
	#RHF_RTE_ERROR_CONTEXT_ERR
 0x5

	)

321 
	#RHF_RTE_ERROR_KHDR_TID_ERR
 0x6

	)

324 
	#RHF_RTE_BYPASS_NO_ERR
 0x0

	)

327 
	#RHF_MAX_SEQ
 13

	)

330 
	#HFI1_LRH_GRH
 0x0003

	)

331 
	#HFI1_LRH_BTH
 0x0002

	)

334 
	#SC15_PACKET
 0xF

	)

335 
	#SIZE_OF_CRC
 1

	)

336 
	#SIZE_OF_LT
 1

	)

337 
	#MAX_16B_PADDING
 12

	)

339 
	#LIM_MGMT_P_KEY
 0x7FFF

	)

340 
	#FULL_MGMT_P_KEY
 0xFFFF

	)

342 
	#DEFAULT_P_KEY
 
LIM_MGMT_P_KEY


	)

344 
	#HFI1_PSM_IOC_BASE_SEQ
 0x0

	)

347 
	#HFI1_KDETH_BTH_SEQ_SHIFT
 11

	)

348 
	#HFI1_KDETH_BTH_SEQ_MASK
 (
	`BIT
(
HFI1_KDETH_BTH_SEQ_SHIFT
è- 1)

	)

350 
šlše
 
__u64
 
	$rhf_to_ýu
(cÚ¡ 
__Ë32
 *
rbuf
)

352  
	`__Ë64_to_ýu
(*((
__Ë64
 *)
rbuf
));

353 
	}
}

355 
šlše
 
u64
 
	$rhf_”r_æags
(
u64
 
rhf
)

357  
rhf
 & 
RHF_ERROR_SMASK
;

358 
	}
}

360 
šlše
 
u32
 
	$rhf_rcv_ty³
(
u64
 
rhf
)

362  (
rhf
 >> 
RHF_RCV_TYPE_SHIFT
è& 
RHF_RCV_TYPE_MASK
;

363 
	}
}

365 
šlše
 
u32
 
	$rhf_rcv_ty³_”r
(
u64
 
rhf
)

367  (
rhf
 >> 
RHF_RCV_TYPE_ERR_SHIFT
è& 
RHF_RCV_TYPE_ERR_MASK
;

368 
	}
}

371 
šlše
 
u32
 
	$rhf_pkt_Ën
(
u64
 
rhf
)

373  ((
rhf
 & 
RHF_PKT_LEN_SMASK
è>> 
RHF_PKT_LEN_SHIFT
) << 2;

374 
	}
}

376 
šlše
 
u32
 
	$rhf_egr_šdex
(
u64
 
rhf
)

378  (
rhf
 >> 
RHF_EGR_INDEX_SHIFT
è& 
RHF_EGR_INDEX_MASK
;

379 
	}
}

381 
šlše
 
u32
 
	$rhf_rcv_£q
(
u64
 
rhf
)

383  (
rhf
 >> 
RHF_RCV_SEQ_SHIFT
è& 
RHF_RCV_SEQ_MASK
;

384 
	}
}

387 
šlše
 
u32
 
	$rhf_hdrq_off£t
(
u64
 
rhf
)

389  (
rhf
 >> 
RHF_HDRQ_OFFSET_SHIFT
è& 
RHF_HDRQ_OFFSET_MASK
;

390 
	}
}

392 
šlše
 
u64
 
	$rhf_u£_egr_bä
(
u64
 
rhf
)

394  
rhf
 & 
RHF_USE_EGR_BFR_SMASK
;

395 
	}
}

397 
šlše
 
u64
 
	$rhf_dc_šfo
(
u64
 
rhf
)

399  
rhf
 & 
RHF_DC_INFO_SMASK
;

400 
	}
}

402 
šlše
 
u32
 
	$rhf_egr_buf_off£t
(
u64
 
rhf
)

404  (
rhf
 >> 
RHF_EGR_OFFSET_SHIFT
è& 
RHF_EGR_OFFSET_MASK
;

405 
	}
}

407 #iâdeà
HAVE_SECURITY_H


408 
šlše
 
	$£cur™y_ib_pkey_acûss
(*
£c
, 
u64
 
subÃt_´efix
, 
u16
 
pkey
)

411 
	}
}

413 
šlše
 
	$£cur™y_ib_®loc_£cur™y
(**
£c
)

416 
	}
}

418 
šlše
 
	$£cur™y_ib_ä“_£cur™y
(*
£c
)

420 
	}
}

423 #iâdeà
HAVE_IB_GET_CACHED_SUBNET_PREFIX


424 
šlše
 
	$ib_g‘_ÿched_subÃt_´efix
(
ib_deviû
 *
deviû
,

425 
u8
 
pÜt_num
,

426 
u64
 *
¢_pfx
)

429 
	}
}

	@debugfs.c

47 
	~<lšux/debugfs.h
>

48 
	~<lšux/£q_fže.h
>

49 
	~<lšux/k”Ãl.h
>

50 
	~<lšux/expÜt.h
>

51 
	~<lšux/moduË.h
>

52 
	~<lšux/¡ršg.h
>

53 
	~<lšux/ty³s.h
>

54 
	~<lšux/¿‹lim™.h
>

55 
	~<lšux/çuÉ-šjeù.h
>

57 
	~"hfi.h
"

58 
	~"Œaû.h
"

59 
	~"debugfs.h
"

60 
	~"deviû.h
"

61 
	~"qp.h
"

62 
	~"sdma.h
"

63 
	~"çuÉ.h
"

65 
d’Œy
 *
	ghfi1_dbg_roÙ
;

68 #ifdeà
NEED_FILE_FINISH


69 
ssize_t
 
	$hfi1_£q_»ad
(
fže
 *fže, 
__u£r
 *
buf
, 
size_t
 
size
,

70 
loff_t
 *
µos
)

72 
d’Œy
 *
d
 = 
fže
->
f_·th
.dentry;

73 
¤cu_idx
;

74 
ssize_t
 
r
;

76 
r
 = 
	`debugfs_u£_fže_¡¬t
(
d
, &
¤cu_idx
);

77 ià(
	`lik–y
(!
r
))

78 
r
 = 
	`£q_»ad
(
fže
, 
buf
, 
size
, 
µos
);

80 
	`debugfs_u£_fže_fšish
(
¤cu_idx
);

81  
r
;

82 
	}
}

84 
loff_t
 
	$hfi1_£q_l£ek
(
fže
 *fže, 
loff_t
 
off£t
, 
wh’û
)

86 
d’Œy
 *
d
 = 
fže
->
f_·th
.dentry;

87 
¤cu_idx
;

88 
loff_t
 
r
;

90 
r
 = 
	`debugfs_u£_fže_¡¬t
(
d
, &
¤cu_idx
);

91 ià(
	`lik–y
(!
r
))

92 
r
 = 
	`£q_l£ek
(
fže
, 
off£t
, 
wh’û
);

94 
	`debugfs_u£_fže_fšish
(
¤cu_idx
);

95  
r
;

96 
	}
}

99 
ssize_t
 
	$hfi1_£q_»ad
(
fže
 *fže, 
__u£r
 *
buf
, 
size_t
 
size
,

100 
loff_t
 *
µos
)

102 
d’Œy
 *
d
 = 
fže
->
f_·th
.dentry;

103 
ssize_t
 
r
;

105 
r
 = 
	`debugfs_fže_g‘
(
d
);

107 ià(
	`lik–y
(!
r
))

108 
r
 = 
	`£q_»ad
(
fže
, 
buf
, 
size
, 
µos
);

109 
	`debugfs_fže_put
(
d
);

110  
r
;

111 
	}
}

113 
loff_t
 
	$hfi1_£q_l£ek
(
fže
 *fže, 
loff_t
 
off£t
, 
wh’û
)

115 
d’Œy
 *
d
 = 
fže
->
f_·th
.dentry;

116 
loff_t
 
r
;

118 
r
 = 
	`debugfs_fže_g‘
(
d
);

120 ià(
	`lik–y
(!
r
))

121 
r
 = 
	`£q_l£ek
(
fže
, 
off£t
, 
wh’û
);

122 
	`debugfs_fže_put
(
d
);

123  
r
;

124 
	}
}

127 
	#´iv©e2dd
(
fže
è(
	`fže_šode
(fže)->
i_´iv©e
)

	)

128 
	#´iv©e2µd
(
fže
è(
	`fže_šode
(fže)->
i_´iv©e
)

	)

130 *
	$_Ýcode_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

132 
hfi1_Ýcode_¡©s_³rùx
 *
Ý¡©s
;

134 ià(*
pos
 >ð
	`ARRAY_SIZE
(
Ý¡©s
->
¡©s
))

135  
NULL
;

136  
pos
;

137 
	}
}

139 *
	$_Ýcode_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

141 
hfi1_Ýcode_¡©s_³rùx
 *
Ý¡©s
;

143 ++*
pos
;

144 ià(*
pos
 >ð
	`ARRAY_SIZE
(
Ý¡©s
->
¡©s
))

145  
NULL
;

146  
pos
;

147 
	}
}

149 
	$_Ýcode_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

151 
	}
}

153 
	$Ýcode_¡©s_show
(
£q_fže
 *
s
, 
u8
 
i
, 
u64
 
·ck‘s
, u64 
by‹s
)

155 ià(!
·ck‘s
 && !
by‹s
)

156  
SEQ_SKIP
;

157 
	`£q_´štf
(
s
, "%02x %Îu/%Îu\n", 
i
,

158 ()
·ck‘s
,

159 ()
by‹s
);

162 
	}
}

164 
	$_Ýcode_¡©s_£q_show
(
£q_fže
 *
s
, *
v
)

166 
loff_t
 *
¥os
 = 
v
;

167 
loff_t
 
i
 = *
¥os
, 
j
;

168 
u64
 
n_·ck‘s
 = 0, 
n_by‹s
 = 0;

169 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

170 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

171 
hfi1_ùxtd©a
 *
rcd
;

173 
j
 = 0; j < 
dd
->
fœ¡_dyn_®loc_ùxt
; j++) {

174 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
j
);

175 ià(
rcd
) {

176 
n_·ck‘s
 +ð
rcd
->
Ý¡©s
->
¡©s
[
i
].n_packets;

177 
n_by‹s
 +ð
rcd
->
Ý¡©s
->
¡©s
[
i
].n_bytes;

179 
	`hfi1_rcd_put
(
rcd
);

181  
	`Ýcode_¡©s_show
(
s
, 
i
, 
n_·ck‘s
, 
n_by‹s
);

182 
	}
}

184 
DEBUGFS_SEQ_FILE_OPS
(
Ýcode_¡©s
);

185 
	$DEBUGFS_SEQ_FILE_OPEN
(
Ýcode_¡©s
)

186 
	`DEBUGFS_FILE_OPS
(
Ýcode_¡©s
);

188 *
	$_tx_Ýcode_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

190  
	`_Ýcode_¡©s_£q_¡¬t
(
s
, 
pos
);

191 
	}
}

193 *
	$_tx_Ýcode_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

195  
	`_Ýcode_¡©s_£q_Ãxt
(
s
, 
v
, 
pos
);

196 
	}
}

198 
	$_tx_Ýcode_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

200 
	}
}

202 
	$_tx_Ýcode_¡©s_£q_show
(
£q_fže
 *
s
, *
v
)

204 
loff_t
 *
¥os
 = 
v
;

205 
loff_t
 
i
 = *
¥os
;

206 
j
;

207 
u64
 
n_·ck‘s
 = 0, 
n_by‹s
 = 0;

208 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

209 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

211 
	`fÜ_—ch_possibË_ýu
(
j
) {

212 
hfi1_Ýcode_¡©s_³rùx
 *
s
 =

213 
	`³r_ýu_±r
(
dd
->
tx_Ý¡©s
, 
j
);

214 
n_·ck‘s
 +ð
s
->
¡©s
[
i
].n_packets;

215 
n_by‹s
 +ð
s
->
¡©s
[
i
].n_bytes;

217  
	`Ýcode_¡©s_show
(
s
, 
i
, 
n_·ck‘s
, 
n_by‹s
);

218 
	}
}

220 
DEBUGFS_SEQ_FILE_OPS
(
tx_Ýcode_¡©s
);

221 
	$DEBUGFS_SEQ_FILE_OPEN
(
tx_Ýcode_¡©s
)

222 
	`DEBUGFS_FILE_OPS
(
tx_Ýcode_¡©s
);

224 *
	$_ùx_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

226 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

227 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

229 ià(!*
pos
)

230  
SEQ_START_TOKEN
;

231 ià(*
pos
 >ð
dd
->
fœ¡_dyn_®loc_ùxt
)

232  
NULL
;

233  
pos
;

234 
	}
}

236 *
	$_ùx_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

238 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

239 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

241 ià(
v
 =ð
SEQ_START_TOKEN
)

242  
pos
;

244 ++*
pos
;

245 ià(*
pos
 >ð
dd
->
fœ¡_dyn_®loc_ùxt
)

246  
NULL
;

247  
pos
;

248 
	}
}

250 
	$_ùx_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

253 
	}
}

255 
	$_ùx_¡©s_£q_show
(
£q_fže
 *
s
, *
v
)

257 
loff_t
 *
¥os
;

258 
loff_t
 
i
, 
j
;

259 
u64
 
n_·ck‘s
 = 0;

260 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

261 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

262 
hfi1_ùxtd©a
 *
rcd
;

264 ià(
v
 =ð
SEQ_START_TOKEN
) {

265 
	`£q_puts
(
s
, "Ctx:npkts\n");

269 
¥os
 = 
v
;

270 
i
 = *
¥os
;

272 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex_§ã
(
dd
, 
i
);

273 ià(!
rcd
)

274  
SEQ_SKIP
;

276 
j
 = 0; j < 
	`ARRAY_SIZE
(
rcd
->
Ý¡©s
->
¡©s
); j++)

277 
n_·ck‘s
 +ð
rcd
->
Ý¡©s
->
¡©s
[
j
].n_packets;

279 
	`hfi1_rcd_put
(
rcd
);

281 ià(!
n_·ck‘s
)

282  
SEQ_SKIP
;

284 
	`£q_´štf
(
s
, " %Îu:%Îu\n", 
i
, 
n_·ck‘s
);

286 
	}
}

288 
DEBUGFS_SEQ_FILE_OPS
(
ùx_¡©s
);

289 
	$DEBUGFS_SEQ_FILE_OPEN
(
ùx_¡©s
)

290 
	`DEBUGFS_FILE_OPS
(
ùx_¡©s
);

292 *
	$_qp_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

293 
	$__acquœes
(
RCU
)

295 
rvt_qp_™”
 *
™”
;

296 
loff_t
 
n
 = *
pos
;

298 
™”
 = 
	`rvt_qp_™”_š™
(
s
->
´iv©e
, 0, 
NULL
);

301 
	`rcu_»ad_lock
();

303 ià(!
™”
)

304  
NULL
;

307 ià(
	`rvt_qp_™”_Ãxt
(
™”
)) {

308 
	`kä“
(
™”
);

309  
NULL
;

311 } 
n
--);

313  
™”
;

314 
	}
}

316 *
	$_qp_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
™”_±r
,

317 
loff_t
 *
pos
)

318 
	$__mu¡_hÞd
(
RCU
)

320 
rvt_qp_™”
 *
™”
 = 
™”_±r
;

322 (*
pos
)++;

324 ià(
	`rvt_qp_™”_Ãxt
(
™”
)) {

325 
	`kä“
(
™”
);

326  
NULL
;

329  
™”
;

330 
	}
}

332 
	$_qp_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
™”_±r
)

333 
	$__»Ëa£s
(
RCU
)

335 
	`rcu_»ad_uÆock
();

336 
	}
}

338 
	$_qp_¡©s_£q_show
(
£q_fže
 *
s
, *
™”_±r
)

340 
rvt_qp_™”
 *
™”
 = 
™”_±r
;

342 ià(!
™”
)

345 
	`qp_™”_´št
(
s
, 
™”
);

348 
	}
}

350 
DEBUGFS_SEQ_FILE_OPS
(
qp_¡©s
);

351 
	$DEBUGFS_SEQ_FILE_OPEN
(
qp_¡©s
)

352 
	`DEBUGFS_FILE_OPS
(
qp_¡©s
);

354 *
	$_sdes_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

356 
hfi1_ibdev
 *
ibd
;

357 
hfi1_devd©a
 *
dd
;

359 
ibd
 = (
hfi1_ibdev
 *)
s
->
´iv©e
;

360 
dd
 = 
	`dd_äom_dev
(
ibd
);

361 ià(!
dd
->
³r_sdma
 || *
pos
 >ðdd->
num_sdma
)

362  
NULL
;

363  
pos
;

364 
	}
}

366 *
	$_sdes_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

368 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

369 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

371 ++*
pos
;

372 ià(!
dd
->
³r_sdma
 || *
pos
 >ðdd->
num_sdma
)

373  
NULL
;

374  
pos
;

375 
	}
}

377 
	$_sdes_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

379 
	}
}

381 
	$_sdes_£q_show
(
£q_fže
 *
s
, *
v
)

383 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

384 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

385 
loff_t
 *
¥os
 = 
v
;

386 
loff_t
 
i
 = *
¥os
;

388 
	`sdma_£qfže_dump_sde
(
s
, &
dd
->
³r_sdma
[
i
]);

390 
	}
}

392 
DEBUGFS_SEQ_FILE_OPS
(
sdes
);

393 
	$DEBUGFS_SEQ_FILE_OPEN
(
sdes
)

394 
	`DEBUGFS_FILE_OPS
(
sdes
);

396 *
	$_rcds_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

398 
hfi1_ibdev
 *
ibd
;

399 
hfi1_devd©a
 *
dd
;

401 
ibd
 = (
hfi1_ibdev
 *)
s
->
´iv©e
;

402 
dd
 = 
	`dd_äom_dev
(
ibd
);

403 ià(!
dd
->
rcd
 || *
pos
 >ðdd->
n_krcv_queues
)

404  
NULL
;

405  
pos
;

406 
	}
}

408 *
	$_rcds_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

410 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

411 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

413 ++*
pos
;

414 ià(!
dd
->
rcd
 || *
pos
 >ðdd->
num_rcv_cÚ‹xts
)

415  
NULL
;

416  
pos
;

417 
	}
}

419 
	$_rcds_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

421 
	}
}

423 
	$_rcds_£q_show
(
£q_fže
 *
s
, *
v
)

425 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

426 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

427 
hfi1_ùxtd©a
 *
rcd
;

428 
loff_t
 *
¥os
 = 
v
;

429 
loff_t
 
i
 = *
¥os
;

431 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex_§ã
(
dd
, 
i
);

432 ià(
rcd
)

433 
	`£qfže_dump_rcd
(
s
, 
rcd
);

434 
	`hfi1_rcd_put
(
rcd
);

436 
	}
}

438 
DEBUGFS_SEQ_FILE_OPS
(
rcds
);

439 
	$DEBUGFS_SEQ_FILE_OPEN
(
rcds
)

440 
	`DEBUGFS_FILE_OPS
(
rcds
);

442 *
	$_pios_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

444 
hfi1_ibdev
 *
ibd
;

445 
hfi1_devd©a
 *
dd
;

447 
ibd
 = (
hfi1_ibdev
 *)
s
->
´iv©e
;

448 
dd
 = 
	`dd_äom_dev
(
ibd
);

449 ià(!
dd
->
£nd_cÚ‹xts
 || *
pos
 >ðdd->
num_£nd_cÚ‹xts
)

450  
NULL
;

451  
pos
;

452 
	}
}

454 *
	$_pios_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

456 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

457 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

459 ++*
pos
;

460 ià(!
dd
->
£nd_cÚ‹xts
 || *
pos
 >ðdd->
num_£nd_cÚ‹xts
)

461  
NULL
;

462  
pos
;

463 
	}
}

465 
	$_pios_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

467 
	}
}

469 
	$_pios_£q_show
(
£q_fže
 *
s
, *
v
)

471 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

472 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

473 
£nd_cÚ‹xt_šfo
 *
sci
;

474 
loff_t
 *
¥os
 = 
v
;

475 
loff_t
 
i
 = *
¥os
;

476 
æags
;

478 
	`¥š_lock_œq§ve
(&
dd
->
sc_lock
, 
æags
);

479 
sci
 = &
dd
->
£nd_cÚ‹xts
[
i
];

480 ià(
sci
 && sci->
ty³
 !ð
SC_USER
 && sci->
®loÿ‹d
 && sci->
sc
)

481 
	`£qfže_dump_sci
(
s
, 
i
, 
sci
);

482 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
æags
);

484 
	}
}

486 
DEBUGFS_SEQ_FILE_OPS
(
pios
);

487 
	$DEBUGFS_SEQ_FILE_OPEN
(
pios
)

488 
	`DEBUGFS_FILE_OPS
(
pios
);

491 
ssize_t
 
	$dev_couÁ”s_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

492 
size_t
 
couÁ
, 
loff_t
 *
µos
)

494 
u64
 *
couÁ”s
;

495 
size_t
 
avaž
;

496 
hfi1_devd©a
 *
dd
;

497 
ssize_t
 
rv®
;

499 
dd
 = 
	`´iv©e2dd
(
fže
);

500 
avaž
 = 
	`hfi1_»ad_úŒs
(
dd
, 
NULL
, &
couÁ”s
);

501 
rv®
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
couÁ”s
, 
avaž
);

502  
rv®
;

503 
	}
}

506 
ssize_t
 
	$dev_Çmes_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

507 
size_t
 
couÁ
, 
loff_t
 *
µos
)

509 *
Çmes
;

510 
size_t
 
avaž
;

511 
hfi1_devd©a
 *
dd
;

512 
ssize_t
 
rv®
;

514 
dd
 = 
	`´iv©e2dd
(
fže
);

515 
avaž
 = 
	`hfi1_»ad_úŒs
(
dd
, &
Çmes
, 
NULL
);

516 
rv®
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
Çmes
, 
avaž
);

517  
rv®
;

518 
	}
}

520 
	scouÁ”_šfo
 {

521 *
	mÇme
;

522 cÚ¡ 
fže_Ý”©iÚs
 
	mÝs
;

531 
ssize_t
 
	$pÜŠames_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

532 
size_t
 
couÁ
, 
loff_t
 *
µos
)

534 *
Çmes
;

535 
size_t
 
avaž
;

536 
hfi1_devd©a
 *
dd
;

537 
ssize_t
 
rv®
;

539 
dd
 = 
	`´iv©e2dd
(
fže
);

540 
avaž
 = 
	`hfi1_»ad_pÜtúŒs
(
dd
->
µÜt
, &
Çmes
, 
NULL
);

541 
rv®
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
Çmes
, 
avaž
);

542  
rv®
;

543 
	}
}

546 
ssize_t
 
	$pÜtúŒs_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

547 
size_t
 
couÁ
, 
loff_t
 *
µos
)

549 
u64
 *
couÁ”s
;

550 
size_t
 
avaž
;

551 
hfi1_µÜtd©a
 *
µd
;

552 
ssize_t
 
rv®
;

554 
µd
 = 
	`´iv©e2µd
(
fže
);

555 
avaž
 = 
	`hfi1_»ad_pÜtúŒs
(
µd
, 
NULL
, &
couÁ”s
);

556 
rv®
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
couÁ”s
, 
avaž
);

557  
rv®
;

558 
	}
}

560 
	$check_dyn_æag
(
u64
 
sü©ch0
, *
p
, 
size
, *
u£d
,

561 
this_hfi
, 
hfi
, 
u32
 
æag
, cÚ¡ *
wh©
)

563 
u32
 
mask
;

565 
mask
 = 
æag
 << (
hfi
 ? 
CR_DYN_SHIFT
 : 0);

566 ià(
sü©ch0
 & 
mask
) {

567 *
u£d
 +ð
	`sú´štf
(
p
 + *u£d, 
size
 - *used,

569 
mask
, 
hfi
, 
wh©
,

570 
this_hfi
 =ð
hfi
 ? "this" : "other");

572 
	}
}

574 
ssize_t
 
	$asic_æags_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

575 
size_t
 
couÁ
, 
loff_t
 *
µos
)

577 
hfi1_µÜtd©a
 *
µd
;

578 
hfi1_devd©a
 *
dd
;

579 
u64
 
sü©ch0
;

580 *
tmp
;

581 
»t
 = 0;

582 
size
;

583 
u£d
;

584 
i
;

586 
µd
 = 
	`´iv©e2µd
(
fže
);

587 
dd
 = 
µd
->dd;

588 
size
 = 
PAGE_SIZE
;

589 
u£d
 = 0;

590 
tmp
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

591 ià(!
tmp
)

592  -
ENOMEM
;

594 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

595 
u£d
 +ð
	`sú´štf
(
tmp
 + u£d, 
size
 - used,

596 "Resourû fÏgs: 0x%016Îx\n", 
sü©ch0
);

599 ià(
sü©ch0
 & 
CR_THERM_INIT
) {

600 
u£d
 +ð
	`sú´štf
(
tmp
 + u£d, 
size
 - used,

602 (
u32
)
CR_THERM_INIT
);

606 
i
 = 0; i < 2; i++) {

607 
	`check_dyn_æag
(
sü©ch0
, 
tmp
, 
size
, &
u£d
, 
dd
->
hfi1_id
, 
i
,

608 
CR_SBUS
, "SBus");

609 
	`check_dyn_æag
(
sü©ch0
, 
tmp
, 
size
, &
u£d
, 
dd
->
hfi1_id
, 
i
,

610 
CR_EPROM
, "EPROM");

611 
	`check_dyn_æag
(
sü©ch0
, 
tmp
, 
size
, &
u£d
, 
dd
->
hfi1_id
, 
i
,

612 
CR_I2C1
, "i2c chain 1");

613 
	`check_dyn_æag
(
sü©ch0
, 
tmp
, 
size
, &
u£d
, 
dd
->
hfi1_id
, 
i
,

614 
CR_I2C2
, "i2c chain 2");

616 
u£d
 +ð
	`sú´štf
(
tmp
 + u£d, 
size
 - used, "Write bitso clear\n");

618 
»t
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
tmp
, 
u£d
);

619 
	`kä“
(
tmp
);

620  
»t
;

621 
	}
}

623 
ssize_t
 
	$asic_æags_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

624 
size_t
 
couÁ
, 
loff_t
 *
µos
)

626 
hfi1_µÜtd©a
 *
µd
;

627 
hfi1_devd©a
 *
dd
;

628 *
buff
;

629 
»t
;

630 
v®ue
;

631 
u64
 
sü©ch0
;

632 
u64
 
þ—r
;

634 
µd
 = 
	`´iv©e2µd
(
fže
);

635 
dd
 = 
µd
->dd;

638 
buff
 = 
	`memdup_u£r_nul
(
buf
, 
couÁ
);

639 ià(
	`IS_ERR
(
buff
))

640  
	`PTR_ERR
(
buff
);

642 
»t
 = 
	`k¡¹ouÎ
(
buff
, 0, &
v®ue
);

643 ià(
»t
)

644 
do_ä“
;

645 
þ—r
 = 
v®ue
;

648 
	`mu‹x_lock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

649 
	`acquœe_hw_mu‹x
(
dd
);

651 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

652 
sü©ch0
 &ð~
þ—r
;

653 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SCRATCH
, 
sü©ch0
);

655 ()
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

657 
	`»Ëa£_hw_mu‹x
(
dd
);

658 
	`mu‹x_uÆock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

661 
»t
 = 
couÁ
;

663 
do_ä“
:

664 
	`kä“
(
buff
);

665  
»t
;

666 
	}
}

669 
ssize_t
 
	$dc8051_memÜy_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

670 
size_t
 
couÁ
, 
loff_t
 *
µos
)

672 
hfi1_µÜtd©a
 *
µd
 = 
	`´iv©e2µd
(
fže
);

673 
ssize_t
 
rv®
;

674 *
tmp
;

675 
loff_t
 
¡¬t
, 
’d
;

678 ià(*
µos
 < 0)

679  -
EINVAL
;

681 
tmp
 = 
	`kz®loc
(
DC8051_DATA_MEM_SIZE
, 
GFP_KERNEL
);

682 ià(!
tmp
)

683  -
ENOMEM
;

691 
¡¬t
 = *
µos
 & ~0x7;

692 ià(
¡¬t
 < 
DC8051_DATA_MEM_SIZE
) {

693 
’d
 = (*
µos
 + 
couÁ
 + 7) & ~0x7;

694 ià(
’d
 > 
DC8051_DATA_MEM_SIZE
)

695 
’d
 = 
DC8051_DATA_MEM_SIZE
;

696 
rv®
 = 
	`»ad_8051_d©a
(
µd
->
dd
, 
¡¬t
, 
’d
 - start,

697 (
u64
 *)(
tmp
 + 
¡¬t
));

698 ià(
rv®
)

699 
dÚe
;

702 
rv®
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
tmp
,

703 
DC8051_DATA_MEM_SIZE
);

704 
dÚe
:

705 
	`kä“
(
tmp
);

706  
rv®
;

707 
	}
}

709 
ssize_t
 
	$debugfs_lcb_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

710 
size_t
 
couÁ
, 
loff_t
 *
µos
)

712 
hfi1_µÜtd©a
 *
µd
 = 
	`´iv©e2µd
(
fže
);

713 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

714 
tÙ®
, 
c¤_off
;

715 
u64
 
d©a
;

717 ià(*
µos
 < 0)

718  -
EINVAL
;

720 ià((
couÁ
 % 8) != 0)

721  -
EINVAL
;

723 ià((*
µos
 % 8) != 0)

724  -
EINVAL
;

726 ià(*
µos
 >ð(
LCB_END
 - 
LCB_START
è|| !
couÁ
)

729 ià(*
µos
 + 
couÁ
 > 
LCB_END
 - 
LCB_START
)

730 
couÁ
 = (
LCB_END
 - 
LCB_START
è- *
µos
;

732 
c¤_off
 = 
LCB_START
 + *
µos
;

733 
tÙ®
 = 0;Ù® < 
couÁ
;Ù® +ð8, 
c¤_off
 += 8) {

734 ià(
	`»ad_lcb_c¤
(
dd
, 
c¤_off
, (
u64
 *)&
d©a
))

736 ià(
	`put_u£r
(
d©a
, (
__u£r
 *)(
buf
 + 
tÙ®
)))

739 *
µos
 +ð
tÙ®
;

740  
tÙ®
;

741 
	}
}

743 
ssize_t
 
	$debugfs_lcb_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

744 
size_t
 
couÁ
, 
loff_t
 *
µos
)

746 
hfi1_µÜtd©a
 *
µd
 = 
	`´iv©e2µd
(
fže
);

747 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

748 
tÙ®
, 
c¤_off
, 
d©a
;

750 ià(*
µos
 < 0)

751  -
EINVAL
;

753 ià((
couÁ
 % 8) != 0)

754  -
EINVAL
;

756 ià((*
µos
 % 8) != 0)

757  -
EINVAL
;

759 ià(*
µos
 >ð(
LCB_END
 - 
LCB_START
è|| !
couÁ
)

762 ià(*
µos
 + 
couÁ
 > 
LCB_END
 - 
LCB_START
)

763 
couÁ
 = (
LCB_END
 - 
LCB_START
è- *
µos
;

765 
c¤_off
 = 
LCB_START
 + *
µos
;

766 
tÙ®
 = 0;Ù® < 
couÁ
;Ù® +ð8, 
c¤_off
 += 8) {

767 ià(
	`g‘_u£r
(
d©a
, (
__u£r
 *)(
buf
 + 
tÙ®
)))

769 ià(
	`wr™e_lcb_c¤
(
dd
, 
c¤_off
, 
d©a
))

772 *
µos
 +ð
tÙ®
;

773  
tÙ®
;

774 
	}
}

779 
ssize_t
 
	$qså_debugfs_dump
(
fže
 *fže, 
__u£r
 *
buf
,

780 
size_t
 
couÁ
, 
loff_t
 *
µos
)

782 
hfi1_µÜtd©a
 *
µd
;

783 *
tmp
;

784 
»t
;

786 
µd
 = 
	`´iv©e2µd
(
fže
);

787 
tmp
 = 
	`km®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

788 ià(!
tmp
)

789  -
ENOMEM
;

791 
»t
 = 
	`qså_dump
(
µd
, 
tmp
, 
PAGE_SIZE
);

792 ià(
»t
 > 0)

793 
»t
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
couÁ
, 
µos
, 
tmp
,„et);

794 
	`kä“
(
tmp
);

795  
»t
;

796 
	}
}

799 
ssize_t
 
	$__i2c_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

800 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
u32
 
rg‘
)

802 
hfi1_µÜtd©a
 *
µd
;

803 *
buff
;

804 
»t
;

805 
i2c_addr
;

806 
off£t
;

807 
tÙ®_wr™‹n
;

809 
µd
 = 
	`´iv©e2µd
(
fže
);

812 
i2c_addr
 = (*
µos
 >> 16) & 0xffff;

813 
off£t
 = *
µos
 & 0xffff;

816 ià(
i2c_addr
 == 0)

817  -
EINVAL
;

819 
buff
 = 
	`memdup_u£r
(
buf
, 
couÁ
);

820 ià(
	`IS_ERR
(
buff
))

821  
	`PTR_ERR
(
buff
);

823 
tÙ®_wr™‹n
 = 
	`i2c_wr™e
(
µd
, 
rg‘
, 
i2c_addr
, 
off£t
, 
buff
, 
couÁ
);

824 ià(
tÙ®_wr™‹n
 < 0) {

825 
»t
 = 
tÙ®_wr™‹n
;

826 
_ä“
;

829 *
µos
 +ð
tÙ®_wr™‹n
;

831 
»t
 = 
tÙ®_wr™‹n
;

833 
_ä“
:

834 
	`kä“
(
buff
);

835  
»t
;

836 
	}
}

839 
ssize_t
 
	$i2c1_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

840 
size_t
 
couÁ
, 
loff_t
 *
µos
)

842  
	`__i2c_debugfs_wr™e
(
fže
, 
buf
, 
couÁ
, 
µos
, 0);

843 
	}
}

846 
ssize_t
 
	$i2c2_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

847 
size_t
 
couÁ
, 
loff_t
 *
µos
)

849  
	`__i2c_debugfs_wr™e
(
fže
, 
buf
, 
couÁ
, 
µos
, 1);

850 
	}
}

853 
ssize_t
 
	$__i2c_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

854 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
u32
 
rg‘
)

856 
hfi1_µÜtd©a
 *
µd
;

857 *
buff
;

858 
»t
;

859 
i2c_addr
;

860 
off£t
;

861 
tÙ®_»ad
;

863 
µd
 = 
	`´iv©e2µd
(
fže
);

866 
i2c_addr
 = (*
µos
 >> 16) & 0xffff;

867 
off£t
 = *
µos
 & 0xffff;

870 ià(
i2c_addr
 == 0)

871  -
EINVAL
;

873 
buff
 = 
	`km®loc
(
couÁ
, 
GFP_KERNEL
);

874 ià(!
buff
)

875  -
ENOMEM
;

877 
tÙ®_»ad
 = 
	`i2c_»ad
(
µd
, 
rg‘
, 
i2c_addr
, 
off£t
, 
buff
, 
couÁ
);

878 ià(
tÙ®_»ad
 < 0) {

879 
»t
 = 
tÙ®_»ad
;

880 
_ä“
;

883 *
µos
 +ð
tÙ®_»ad
;

885 
»t
 = 
	`cÝy_to_u£r
(
buf
, 
buff
, 
tÙ®_»ad
);

886 ià(
»t
 > 0) {

887 
»t
 = -
EFAULT
;

888 
_ä“
;

891 
»t
 = 
tÙ®_»ad
;

893 
_ä“
:

894 
	`kä“
(
buff
);

895  
»t
;

896 
	}
}

899 
ssize_t
 
	$i2c1_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

900 
size_t
 
couÁ
, 
loff_t
 *
µos
)

902  
	`__i2c_debugfs_»ad
(
fže
, 
buf
, 
couÁ
, 
µos
, 0);

903 
	}
}

906 
ssize_t
 
	$i2c2_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

907 
size_t
 
couÁ
, 
loff_t
 *
µos
)

909  
	`__i2c_debugfs_»ad
(
fže
, 
buf
, 
couÁ
, 
µos
, 1);

910 
	}
}

913 
ssize_t
 
	$__qså_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

914 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
u32
 
rg‘
)

916 
hfi1_µÜtd©a
 *
µd
;

917 *
buff
;

918 
»t
;

919 
tÙ®_wr™‹n
;

921 ià(*
µos
 + 
couÁ
 > 
QSFP_PAGESIZE
 * 4)

922  -
EINVAL
;

924 
µd
 = 
	`´iv©e2µd
(
fže
);

926 
buff
 = 
	`memdup_u£r
(
buf
, 
couÁ
);

927 ià(
	`IS_ERR
(
buff
))

928  
	`PTR_ERR
(
buff
);

930 
tÙ®_wr™‹n
 = 
	`qså_wr™e
(
µd
, 
rg‘
, *
µos
, 
buff
, 
couÁ
);

931 ià(
tÙ®_wr™‹n
 < 0) {

932 
»t
 = 
tÙ®_wr™‹n
;

933 
_ä“
;

936 *
µos
 +ð
tÙ®_wr™‹n
;

938 
»t
 = 
tÙ®_wr™‹n
;

940 
_ä“
:

941 
	`kä“
(
buff
);

942  
»t
;

943 
	}
}

946 
ssize_t
 
	$qså1_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

947 
size_t
 
couÁ
, 
loff_t
 *
µos
)

949  
	`__qså_debugfs_wr™e
(
fže
, 
buf
, 
couÁ
, 
µos
, 0);

950 
	}
}

953 
ssize_t
 
	$qså2_debugfs_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

954 
size_t
 
couÁ
, 
loff_t
 *
µos
)

956  
	`__qså_debugfs_wr™e
(
fže
, 
buf
, 
couÁ
, 
µos
, 1);

957 
	}
}

960 
ssize_t
 
	$__qså_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

961 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
u32
 
rg‘
)

963 
hfi1_µÜtd©a
 *
µd
;

964 *
buff
;

965 
»t
;

966 
tÙ®_»ad
;

968 ià(*
µos
 + 
couÁ
 > 
QSFP_PAGESIZE
 * 4) {

969 
»t
 = -
EINVAL
;

970 
_»tuº
;

973 
µd
 = 
	`´iv©e2µd
(
fže
);

975 
buff
 = 
	`km®loc
(
couÁ
, 
GFP_KERNEL
);

976 ià(!
buff
) {

977 
»t
 = -
ENOMEM
;

978 
_»tuº
;

981 
tÙ®_»ad
 = 
	`qså_»ad
(
µd
, 
rg‘
, *
µos
, 
buff
, 
couÁ
);

982 ià(
tÙ®_»ad
 < 0) {

983 
»t
 = 
tÙ®_»ad
;

984 
_ä“
;

987 *
µos
 +ð
tÙ®_»ad
;

989 
»t
 = 
	`cÝy_to_u£r
(
buf
, 
buff
, 
tÙ®_»ad
);

990 ià(
»t
 > 0) {

991 
»t
 = -
EFAULT
;

992 
_ä“
;

995 
»t
 = 
tÙ®_»ad
;

997 
_ä“
:

998 
	`kä“
(
buff
);

999 
_»tuº
:

1000  
»t
;

1001 
	}
}

1004 
ssize_t
 
	$qså1_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

1005 
size_t
 
couÁ
, 
loff_t
 *
µos
)

1007  
	`__qså_debugfs_»ad
(
fže
, 
buf
, 
couÁ
, 
µos
, 0);

1008 
	}
}

1011 
ssize_t
 
	$qså2_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

1012 
size_t
 
couÁ
, 
loff_t
 *
µos
)

1014  
	`__qså_debugfs_»ad
(
fže
, 
buf
, 
couÁ
, 
µos
, 1);

1015 
	}
}

1017 
	$__i2c_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
, 
u32
 
rg‘
)

1019 
hfi1_µÜtd©a
 *
µd
;

1020 
»t
;

1022 ià(!
	`Œy_moduË_g‘
(
THIS_MODULE
))

1023  -
ENODEV
;

1025 
µd
 = 
	`´iv©e2µd
(
å
);

1027 
»t
 = 
	`acquœe_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 0);

1028 ià(
»t
)

1029 
	`moduË_put
(
THIS_MODULE
);

1031  
»t
;

1032 
	}
}

1034 
	$i2c1_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
)

1036  
	`__i2c_debugfs_Ý’
(
š
, 
å
, 0);

1037 
	}
}

1039 
	$i2c2_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
)

1041  
	`__i2c_debugfs_Ý’
(
š
, 
å
, 1);

1042 
	}
}

1044 
	$__i2c_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
, 
u32
 
rg‘
)

1046 
hfi1_µÜtd©a
 *
µd
;

1048 
µd
 = 
	`´iv©e2µd
(
å
);

1050 
	`»Ëa£_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
));

1051 
	`moduË_put
(
THIS_MODULE
);

1054 
	}
}

1056 
	$i2c1_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

1058  
	`__i2c_debugfs_»Ëa£
(
š
, 
å
, 0);

1059 
	}
}

1061 
	$i2c2_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

1063  
	`__i2c_debugfs_»Ëa£
(
š
, 
å
, 1);

1064 
	}
}

1066 
	$__qså_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
, 
u32
 
rg‘
)

1068 
hfi1_µÜtd©a
 *
µd
;

1069 
»t
;

1071 ià(!
	`Œy_moduË_g‘
(
THIS_MODULE
))

1072  -
ENODEV
;

1074 
µd
 = 
	`´iv©e2µd
(
å
);

1076 
»t
 = 
	`acquœe_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 0);

1077 ià(
»t
)

1078 
	`moduË_put
(
THIS_MODULE
);

1080  
»t
;

1081 
	}
}

1083 
	$qså1_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
)

1085  
	`__qså_debugfs_Ý’
(
š
, 
å
, 0);

1086 
	}
}

1088 
	$qså2_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
)

1090  
	`__qså_debugfs_Ý’
(
š
, 
å
, 1);

1091 
	}
}

1093 
	$__qså_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
, 
u32
 
rg‘
)

1095 
hfi1_µÜtd©a
 *
µd
;

1097 
µd
 = 
	`´iv©e2µd
(
å
);

1099 
	`»Ëa£_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
));

1100 
	`moduË_put
(
THIS_MODULE
);

1103 
	}
}

1105 
	$qså1_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

1107  
	`__qså_debugfs_»Ëa£
(
š
, 
å
, 0);

1108 
	}
}

1110 
	$qså2_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

1112  
	`__qså_debugfs_»Ëa£
(
š
, 
å
, 1);

1113 
	}
}

1115 
	#EXPROM_WRITE_ENABLE
 
	`BIT_ULL
(14)

	)

1117 
boÞ
 
	gex´om_wp_di§bËd
;

1119 
	$ex´om_wp_£t
(
hfi1_devd©a
 *
dd
, 
boÞ
 
di§bË
)

1121 
u64
 
gpio_v®
 = 0;

1123 ià(
di§bË
) {

1124 
gpio_v®
 = 
EXPROM_WRITE_ENABLE
;

1125 
ex´om_wp_di§bËd
 = 
Œue
;

1126 
	`dd_dev_šfo
(
dd
, "Disable Expansion ROM Write Protection\n");

1128 
ex´om_wp_di§bËd
 = 
çl£
;

1129 
	`dd_dev_šfo
(
dd
, "Enable Expansion ROM Write Protection\n");

1132 
	`wr™e_c¤
(
dd
, 
ASIC_GPIO_OUT
, 
gpio_v®
);

1133 
	`wr™e_c¤
(
dd
, 
ASIC_GPIO_OE
, 
gpio_v®
);

1136 
	}
}

1138 
ssize_t
 
	$ex´om_wp_debugfs_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

1139 
size_t
 
couÁ
, 
loff_t
 *
µos
)

1142 
	}
}

1144 
ssize_t
 
	$ex´om_wp_debugfs_wr™e
(
fže
 *file,

1145 cÚ¡ 
__u£r
 *
buf
, 
size_t
 
couÁ
,

1146 
loff_t
 *
µos
)

1148 
hfi1_µÜtd©a
 *
µd
 = 
	`´iv©e2µd
(
fže
);

1149 
cd©a
;

1151 ià(
couÁ
 != 1)

1152  -
EINVAL
;

1153 ià(
	`g‘_u£r
(
cd©a
, 
buf
))

1154  -
EFAULT
;

1155 ià(
cd©a
 == '0')

1156 
	`ex´om_wp_£t
(
µd
->
dd
, 
çl£
);

1157 ià(
cd©a
 == '1')

1158 
	`ex´om_wp_£t
(
µd
->
dd
, 
Œue
);

1160  -
EINVAL
;

1163 
	}
}

1165 
	gex´om_š_u£
;

1167 
	$ex´om_wp_debugfs_Ý’
(
šode
 *
š
, 
fže
 *
å
)

1169 ià(
	`‹¡_ªd_£t_b™
(0, &
ex´om_š_u£
))

1170  -
EBUSY
;

1173 
	}
}

1175 
	$ex´om_wp_debugfs_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

1177 
hfi1_µÜtd©a
 *
µd
 = 
	`´iv©e2µd
(
å
);

1179 ià(
ex´om_wp_di§bËd
)

1180 
	`ex´om_wp_£t
(
µd
->
dd
, 
çl£
);

1181 
	`þ—r_b™
(0, &
ex´om_š_u£
);

1184 
	}
}

1186 #ifdeà
NEED_DEBUGFS_OPEN


1187 
	#DEBUGFS_OPS
(
nm
, 
»adroutše
, 
wr™”outše
) \

1189 .
Çme
 = 
nm
, \

1190 .
Ýs
 = { \

1191 .
Ý’
 = 
sim¶e_Ý’
, \

1192 .
»ad
 = 
»adroutše
, \

1193 .
wr™e
 = 
wr™”outše
, \

1194 .
Î£ek
 = 
g’”ic_fže_Î£ek
, \

1196 }

	)

1198 
	#DEBUGFS_OPS
(
nm
, 
»adroutše
, 
wr™”outše
) \

1200 .
Çme
 = 
nm
, \

1201 .
Ýs
 = { \

1202 .
»ad
 = 
»adroutše
, \

1203 .
wr™e
 = 
wr™”outše
, \

1204 .
Î£ek
 = 
g’”ic_fže_Î£ek
, \

1206 }

	)

1209 
	#DEBUGFS_XOPS
(
nm
, 
»adf
, 
wr™ef
, 
Ý’f
, 
»Ëa£f
) \

1211 .
Çme
 = 
nm
, \

1212 .
Ýs
 = { \

1213 .
»ad
 = 
»adf
, \

1214 .
wr™e
 = 
wr™ef
, \

1215 .
Î£ek
 = 
g’”ic_fže_Î£ek
, \

1216 .
Ý’
 = 
Ý’f
, \

1217 .
»Ëa£
 = 
»Ëa£f
 \

1219 }

	)

1221 cÚ¡ 
couÁ”_šfo
 
	gúŒ_Ýs
[] = {

1222 
DEBUGFS_OPS
("couÁ”_Çmes", 
dev_Çmes_»ad
, 
NULL
),

1223 
DEBUGFS_OPS
("couÁ”s", 
dev_couÁ”s_»ad
, 
NULL
),

1224 
DEBUGFS_OPS
("pÜtcouÁ”_Çmes", 
pÜŠames_»ad
, 
NULL
),

1227 cÚ¡ 
couÁ”_šfo
 
	gpÜt_úŒ_Ýs
[] = {

1228 
DEBUGFS_OPS
("pÜt%dcouÁ”s", 
pÜtúŒs_debugfs_»ad
, 
NULL
),

1229 
DEBUGFS_XOPS
("i2c1", 
i2c1_debugfs_»ad
, 
i2c1_debugfs_wr™e
,

1230 
i2c1_debugfs_Ý’
, 
i2c1_debugfs_»Ëa£
),

1231 
DEBUGFS_XOPS
("i2c2", 
i2c2_debugfs_»ad
, 
i2c2_debugfs_wr™e
,

1232 
i2c2_debugfs_Ý’
, 
i2c2_debugfs_»Ëa£
),

1233 
DEBUGFS_OPS
("qså_dump%d", 
qså_debugfs_dump
, 
NULL
),

1234 
DEBUGFS_XOPS
("qså1", 
qså1_debugfs_»ad
, 
qså1_debugfs_wr™e
,

1235 
qså1_debugfs_Ý’
, 
qså1_debugfs_»Ëa£
),

1236 
DEBUGFS_XOPS
("qså2", 
qså2_debugfs_»ad
, 
qså2_debugfs_wr™e
,

1237 
qså2_debugfs_Ý’
, 
qså2_debugfs_»Ëa£
),

1238 
DEBUGFS_XOPS
("ex´om_wp", 
ex´om_wp_debugfs_»ad
,

1239 
ex´om_wp_debugfs_wr™e
, 
ex´om_wp_debugfs_Ý’
,

1240 
ex´om_wp_debugfs_»Ëa£
),

1241 
DEBUGFS_OPS
("asic_æags", 
asic_æags_»ad
, 
asic_æags_wr™e
),

1242 
DEBUGFS_OPS
("dc8051_memÜy", 
dc8051_memÜy_»ad
, 
NULL
),

1243 
DEBUGFS_OPS
("lcb", 
debugfs_lcb_»ad
, 
debugfs_lcb_wr™e
),

1246 *
	$_sdma_ýu_li¡_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

1248 ià(*
pos
 >ð
	`num_Úlše_ýus
())

1249  
NULL
;

1251  
pos
;

1252 
	}
}

1254 *
	$_sdma_ýu_li¡_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

1256 ++*
pos
;

1257 ià(*
pos
 >ð
	`num_Úlše_ýus
())

1258  
NULL
;

1260  
pos
;

1261 
	}
}

1263 
	$_sdma_ýu_li¡_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

1266 
	}
}

1268 
	$_sdma_ýu_li¡_£q_show
(
£q_fže
 *
s
, *
v
)

1270 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

1271 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

1272 
loff_t
 *
¥os
 = 
v
;

1273 
loff_t
 
i
 = *
¥os
;

1275 
	`sdma_£qfže_dump_ýu_li¡
(
s
, 
dd
, ()
i
);

1277 
	}
}

1279 
DEBUGFS_SEQ_FILE_OPS
(
sdma_ýu_li¡
);

1280 
	$DEBUGFS_SEQ_FILE_OPEN
(
sdma_ýu_li¡
)

1281 
	`DEBUGFS_FILE_OPS
(
sdma_ýu_li¡
);

1283 
	$hfi1_dbg_ibdev_š™
(
hfi1_ibdev
 *
ibd
)

1285 
Çme
[("port0counters") + 1];

1286 
lšk
[10];

1287 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

1288 
hfi1_µÜtd©a
 *
µd
;

1289 
d’Œy
 *
roÙ
;

1290 
un™
 = 
dd
->unit;

1291 
i
, 
j
;

1293 ià(!
hfi1_dbg_roÙ
)

1295 
	`¢´štf
(
Çme
, Òame), "%s_%d", 
	`þass_Çme
(), 
un™
);

1296 
	`¢´štf
(
lšk
, Öšk), "%d", 
un™
);

1297 
roÙ
 = 
	`debugfs_ü—‹_dœ
(
Çme
, 
hfi1_dbg_roÙ
);

1298 
ibd
->
hfi1_ibdev_dbg
 = 
roÙ
;

1300 
ibd
->
hfi1_ibdev_lšk
 =

1301 
	`debugfs_ü—‹_symlšk
(
lšk
, 
hfi1_dbg_roÙ
, 
Çme
);

1303 
	`debugfs_ü—‹_fže
("Ýcode_¡©s", 0444, 
roÙ
, 
ibd
,

1304 &
_Ýcode_¡©s_fže_Ýs
);

1305 
	`debugfs_ü—‹_fže
("tx_Ýcode_¡©s", 0444, 
roÙ
, 
ibd
,

1306 &
_tx_Ýcode_¡©s_fže_Ýs
);

1307 
	`debugfs_ü—‹_fže
("ùx_¡©s", 0444, 
roÙ
, 
ibd
, &
_ùx_¡©s_fže_Ýs
);

1308 
	`debugfs_ü—‹_fže
("qp_¡©s", 0444, 
roÙ
, 
ibd
, &
_qp_¡©s_fže_Ýs
);

1309 
	`debugfs_ü—‹_fže
("sdes", 0444, 
roÙ
, 
ibd
, &
_sdes_fže_Ýs
);

1310 
	`debugfs_ü—‹_fže
("rcds", 0444, 
roÙ
, 
ibd
, &
_rcds_fže_Ýs
);

1311 
	`debugfs_ü—‹_fže
("pios", 0444, 
roÙ
, 
ibd
, &
_pios_fže_Ýs
);

1312 
	`debugfs_ü—‹_fže
("sdma_ýu_li¡", 0444, 
roÙ
, 
ibd
,

1313 &
_sdma_ýu_li¡_fže_Ýs
);

1316 
i
 = 0; i < 
	`ARRAY_SIZE
(
úŒ_Ýs
); i++)

1317 
	`debugfs_ü—‹_fže
(
úŒ_Ýs
[
i
].
Çme
, 0444, 
roÙ
, 
dd
,

1318 &
úŒ_Ýs
[
i
].
Ýs
);

1321 
µd
 = 
dd
->
µÜt
, 
j
 = 0; j < dd->
num_µÜts
; j++,…pd++)

1322 
i
 = 0; i < 
	`ARRAY_SIZE
(
pÜt_úŒ_Ýs
); i++) {

1323 
	`¢´štf
(
Çme
,

1324 (
Çme
),

1325 
pÜt_úŒ_Ýs
[
i
].
Çme
,

1326 
j
 + 1);

1327 
	`debugfs_ü—‹_fže
(
Çme
,

1328 !
pÜt_úŒ_Ýs
[
i
].
Ýs
.
wr™e
 ?

1329 
S_IRUGO
 :

1330 
S_IRUGO
 | 
S_IWUSR
,

1331 
roÙ
, 
µd
, &
pÜt_úŒ_Ýs
[
i
].
Ýs
);

1334 
	`hfi1_çuÉ_š™_debugfs
(
ibd
);

1335 
	}
}

1337 
	$hfi1_dbg_ibdev_ex™
(
hfi1_ibdev
 *
ibd
)

1339 ià(!
hfi1_dbg_roÙ
)

1340 
out
;

1341 
	`hfi1_çuÉ_ex™_debugfs
(
ibd
);

1342 
	`debugfs_»move
(
ibd
->
hfi1_ibdev_lšk
);

1343 
	`debugfs_»move_»cursive
(
ibd
->
hfi1_ibdev_dbg
);

1344 
out
:

1345 
ibd
->
hfi1_ibdev_dbg
 = 
NULL
;

1346 
	}
}

1355 cÚ¡ * cÚ¡ 
	ghfi1_¡©Çmes
[] = {

1369 *
	$_driv”_¡©s_Çmes_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

1371 ià(*
pos
 >ð
	`ARRAY_SIZE
(
hfi1_¡©Çmes
))

1372  
NULL
;

1373  
pos
;

1374 
	}
}

1376 *
	$_driv”_¡©s_Çmes_£q_Ãxt
(

1377 
£q_fže
 *
s
,

1378 *
v
,

1379 
loff_t
 *
pos
)

1381 ++*
pos
;

1382 ià(*
pos
 >ð
	`ARRAY_SIZE
(
hfi1_¡©Çmes
))

1383  
NULL
;

1384  
pos
;

1385 
	}
}

1387 
	$_driv”_¡©s_Çmes_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

1389 
	}
}

1391 
	$_driv”_¡©s_Çmes_£q_show
(
£q_fže
 *
s
, *
v
)

1393 
loff_t
 *
¥os
 = 
v
;

1395 
	`£q_´štf
(
s
, "%s\n", 
hfi1_¡©Çmes
[*
¥os
]);

1397 
	}
}

1399 
DEBUGFS_SEQ_FILE_OPS
(
driv”_¡©s_Çmes
);

1400 
	$DEBUGFS_SEQ_FILE_OPEN
(
driv”_¡©s_Çmes
)

1401 
	`DEBUGFS_FILE_OPS
(
driv”_¡©s_Çmes
);

1403 *
	$_driv”_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

1405 ià(*
pos
 >ð
	`ARRAY_SIZE
(
hfi1_¡©Çmes
))

1406  
NULL
;

1407  
pos
;

1408 
	}
}

1410 *
	$_driv”_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

1412 ++*
pos
;

1413 ià(*
pos
 >ð
	`ARRAY_SIZE
(
hfi1_¡©Çmes
))

1414  
NULL
;

1415  
pos
;

1416 
	}
}

1418 
	$_driv”_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

1420 
	}
}

1422 
u64
 
	$hfi1_¥s_šts
()

1424 
æags
;

1425 
hfi1_devd©a
 *
dd
;

1426 
u64
 
¥s_šts
 = 0;

1428 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

1429 
	`li¡_fÜ_—ch_’Œy
(
dd
, &
hfi1_dev_li¡
, 
li¡
) {

1430 
¥s_šts
 +ð
	`g‘_®l_ýu_tÙ®
(
dd
->
št_couÁ”
);

1432 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

1433  
¥s_šts
;

1434 
	}
}

1436 
	$_driv”_¡©s_£q_show
(
£q_fže
 *
s
, *
v
)

1438 
loff_t
 *
¥os
 = 
v
;

1439 *
bufãr
;

1440 
u64
 *
¡©s
 = (u64 *)&
hfi1_¡©s
;

1441 
size_t
 
sz
 = 
	`£q_g‘_buf
(
s
, &
bufãr
);

1443 ià(
sz
 < (
u64
))

1444  
SEQ_SKIP
;

1446 ià(*
¥os
 == 0)

1447 *(
u64
 *)
bufãr
 = 
	`hfi1_¥s_šts
();

1449 *(
u64
 *)
bufãr
 = 
¡©s
[*
¥os
];

1450 
	`£q_comm™
(
s
, (
u64
));

1452 
	}
}

1454 
DEBUGFS_SEQ_FILE_OPS
(
driv”_¡©s
);

1455 
	$DEBUGFS_SEQ_FILE_OPEN
(
driv”_¡©s
)

1456 
	`DEBUGFS_FILE_OPS
(
driv”_¡©s
);

1458 
	$hfi1_dbg_š™
()

1460 
hfi1_dbg_roÙ
 = 
	`debugfs_ü—‹_dœ
(
DRIVER_NAME
, 
NULL
);

1461 
	`debugfs_ü—‹_fže
("driv”_¡©s_Çmes", 0444, 
hfi1_dbg_roÙ
, 
NULL
,

1462 &
_driv”_¡©s_Çmes_fže_Ýs
);

1463 
	`debugfs_ü—‹_fže
("driv”_¡©s", 0444, 
hfi1_dbg_roÙ
, 
NULL
,

1464 &
_driv”_¡©s_fže_Ýs
);

1465 
	}
}

1467 
	$hfi1_dbg_ex™
()

1469 
	`debugfs_»move_»cursive
(
hfi1_dbg_roÙ
);

1470 
hfi1_dbg_roÙ
 = 
NULL
;

1471 
	}
}

	@debugfs.h

1 #iâdeà
_HFI1_DEBUGFS_H


2 
	#_HFI1_DEBUGFS_H


	)

50 
	ghfi1_ibdev
;

52 
	#DEBUGFS_SEQ_FILE_OPS
(
Çme
) \

53 cÚ¡ 
£q_Ý”©iÚs
 
_
##
Çme
##
_£q_Ýs
 = { \

54 .
¡¬t
 = 
_
##
Çme
##
_£q_¡¬t
, \

55 .
Ãxt
 = 
_
##
Çme
##
_£q_Ãxt
, \

56 .
¡Ý
 = 
_
##
Çme
##
_£q_¡Ý
, \

57 .
show
 = 
_
##
Çme
##
_£q_show
 \

58 }

	)

60 
	#DEBUGFS_SEQ_FILE_OPEN
(
Çme
) \

61 
_
##
Çme
##
	`_Ý’
(
šode
 *šode, 
fže
 *
s
) \

63 
£q_fže
 *
£q
; \

64 
»t
; \

65 
»t
 = 
	`£q_Ý’
(
s
, &
_
##
Çme
##
_£q_Ýs
); \

66 ià(
»t
) \

67  
»t
; \

68 
£q
 = 
s
->
´iv©e_d©a
; \

69 
£q
->
´iv©e
 = 
šode
->
i_´iv©e
; \

71 }

	)

73 
	#DEBUGFS_FILE_OPS
(
Çme
) \

74 cÚ¡ 
fže_Ý”©iÚs
 
_
##
Çme
##
_fže_Ýs
 = { \

75 .
owÃr
 = 
THIS_MODULE
, \

76 .
Ý’
 = 
_
##
Çme
##
_Ý’
, \

77 .
»ad
 = 
hfi1_£q_»ad
, \

78 .
Î£ek
 = 
hfi1_£q_l£ek
, \

79 .
»Ëa£
 = 
£q_»Ëa£
 \

80 }

	)

83 
ssize_t
 
hfi1_£q_»ad
(
fže
 *fže, 
__u£r
 *
buf
, 
size_t
 
size
,

84 
loff_t
 *
µos
);

85 
loff_t
 
hfi1_£q_l£ek
(
fže
 *fže,†off_ˆ
off£t
, 
wh’û
);

87 #ifdeà
CONFIG_DEBUG_FS


88 
hfi1_dbg_ibdev_š™
(
hfi1_ibdev
 *
ibd
);

89 
hfi1_dbg_ibdev_ex™
(
hfi1_ibdev
 *
ibd
);

90 
hfi1_dbg_š™
();

91 
hfi1_dbg_ex™
();

94 
šlše
 
	$hfi1_dbg_ibdev_š™
(
hfi1_ibdev
 *
ibd
)

96 
	}
}

98 
šlše
 
	$hfi1_dbg_ibdev_ex™
(
hfi1_ibdev
 *
ibd
)

100 
	}
}

102 
šlše
 
	$hfi1_dbg_š™
()

104 
	}
}

106 
šlše
 
	$hfi1_dbg_ex™
()

108 
	}
}

	@device.c

48 
	~<lšux/cdev.h
>

49 
	~<lšux/moduË.h
>

50 
	~<lšux/deviû.h
>

51 
	~<lšux/fs.h
>

53 
	~"hfi.h
"

54 
	~"deviû.h
"

56 
þass
 *
	gþass
;

57 
þass
 *
	gu£r_þass
;

58 
dev_t
 
	ghfi1_dev
;

60 
	$hfi1_cdev_š™
(
mšÜ
, cÚ¡ *
Çme
,

61 cÚ¡ 
fže_Ý”©iÚs
 *
fÝs
,

62 
cdev
 *cdev, 
deviû
 **
devp
,

63 
boÞ
 
u£r_acûssibË
,

64 
kobjeù
 *
·»Á
)

66 cÚ¡ 
dev_t
 
dev
 = 
	`MKDEV
(
	`MAJOR
(
hfi1_dev
), 
mšÜ
);

67 
deviû
 *deviû = 
NULL
;

68 
»t
;

70 
	`cdev_š™
(
cdev
, 
fÝs
);

71 
cdev
->
owÃr
 = 
THIS_MODULE
;

72 
	`cdev_£t_·»Á
(
cdev
, 
·»Á
);

73 
	`kobjeù_£t_Çme
(&
cdev
->
kobj
, 
Çme
);

75 
»t
 = 
	`cdev_add
(
cdev
, 
dev
, 1);

76 ià(
»t
 < 0) {

77 
	`´_”r
("Could‚ot‡dd cdev for minor %d, %s (err %d)\n",

78 
mšÜ
, 
Çme
, -
»t
);

79 
dÚe
;

82 ià(
u£r_acûssibË
)

83 
deviû
 = 
	`deviû_ü—‹
(
u£r_þass
, 
NULL
, 
dev
, NULL, "%s", 
Çme
);

85 
deviû
 = 
	`deviû_ü—‹
(
þass
, 
NULL
, 
dev
, NULL, "%s", 
Çme
);

87 ià(
	`IS_ERR
(
deviû
)) {

88 
»t
 = 
	`PTR_ERR
(
deviû
);

89 
deviû
 = 
NULL
;

90 
	`´_”r
("Could‚ot create device for minor %d, %s (err %d)\n",

91 
mšÜ
, 
Çme
, -
»t
);

92 
	`cdev_d–
(
cdev
);

94 
dÚe
:

95 *
devp
 = 
deviû
;

96  
»t
;

97 
	}
}

99 
	$hfi1_cdev_þ—nup
(
cdev
 *cdev, 
deviû
 **
devp
)

101 
deviû
 *deviû = *
devp
;

103 ià(
deviû
) {

104 
	`deviû_uÄegi¡”
(
deviû
);

105 *
devp
 = 
NULL
;

107 
	`cdev_d–
(
cdev
);

109 
	}
}

111 cÚ¡ *
	ghfi1_þass_Çme
 = "hfi1";

113 cÚ¡ *
	$þass_Çme
()

115  
hfi1_þass_Çme
;

116 
	}
}

118 *
	$hfi1_devnode
(
deviû
 *
dev
, 
umode_t
 *
mode
)

120 ià(
mode
)

121 *
mode
 = 0600;

122  
	`ka¥rštf
(
GFP_KERNEL
, "%s", 
	`dev_Çme
(
dev
));

123 
	}
}

125 cÚ¡ *
	ghfi1_þass_Çme_u£r
 = "hfi1_user";

126 cÚ¡ *
	$þass_Çme_u£r
()

128  
hfi1_þass_Çme_u£r
;

129 
	}
}

131 *
	$hfi1_u£r_devnode
(
deviû
 *
dev
, 
umode_t
 *
mode
)

133 ià(
mode
)

134 *
mode
 = 0666;

135  
	`ka¥rštf
(
GFP_KERNEL
, "%s", 
	`dev_Çme
(
dev
));

136 
	}
}

138 
__š™
 
	$dev_š™
()

140 
»t
;

142 
»t
 = 
	`®loc_chrdev_»giÚ
(&
hfi1_dev
, 0, 
HFI1_NMINORS
, 
DRIVER_NAME
);

143 ià(
»t
 < 0) {

144 
	`´_”r
("Could‚Ù‡Îoÿ‹ chrdev„egiÚ (”¸%d)\n", -
»t
);

145 
dÚe
;

148 
þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
	`þass_Çme
());

149 ià(
	`IS_ERR
(
þass
)) {

150 
»t
 = 
	`PTR_ERR
(
þass
);

151 
	`´_”r
("Could‚Ù c»©deviû cÏs Ó¼ %d)\n", -
»t
);

152 
	`uÄegi¡”_chrdev_»giÚ
(
hfi1_dev
, 
HFI1_NMINORS
);

153 
dÚe
;

155 
þass
->
devnode
 = 
hfi1_devnode
;

157 
u£r_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
	`þass_Çme_u£r
());

158 ià(
	`IS_ERR
(
u£r_þass
)) {

159 
»t
 = 
	`PTR_ERR
(
u£r_þass
);

160 
	`´_”r
("Could‚ot create device class for user‡ccessible files (err %d)\n",

161 -
»t
);

162 
	`þass_de¡roy
(
þass
);

163 
þass
 = 
NULL
;

164 
u£r_þass
 = 
NULL
;

165 
	`uÄegi¡”_chrdev_»giÚ
(
hfi1_dev
, 
HFI1_NMINORS
);

166 
dÚe
;

168 
u£r_þass
->
devnode
 = 
hfi1_u£r_devnode
;

170 
dÚe
:

171  
»t
;

172 
	}
}

174 
	$dev_þ—nup
()

176 
	`þass_de¡roy
(
þass
);

177 
þass
 = 
NULL
;

179 
	`þass_de¡roy
(
u£r_þass
);

180 
u£r_þass
 = 
NULL
;

182 
	`uÄegi¡”_chrdev_»giÚ
(
hfi1_dev
, 
HFI1_NMINORS
);

183 
	}
}

	@device.h

1 #iâdeà
_HFI1_DEVICE_H


2 
	#_HFI1_DEVICE_H


	)

50 
hfi1_cdev_š™
(
mšÜ
, cÚ¡ *
Çme
,

51 cÚ¡ 
fže_Ý”©iÚs
 *
fÝs
,

52 
cdev
 *cdev, 
deviû
 **
devp
,

53 
boÞ
 
u£r_acûssibË
,

54 
kobjeù
 *
·»Á
);

55 
hfi1_cdev_þ—nup
(
cdev
 *cdev, 
deviû
 **
devp
);

56 cÚ¡ *
þass_Çme
();

57 
__š™
 
dev_š™
();

58 
dev_þ—nup
();

	@diag.c

58 
	~<lšux/io.h
>

59 
	~<lšux/pci.h
>

60 
	~<lšux/pÞl.h
>

61 
	~<lšux/vm®loc.h
>

62 
	~<lšux/expÜt.h
>

63 
	~<lšux/fs.h
>

64 
	~<lšux/uacûss.h
>

65 
	~<lšux/moduË.h
>

66 
	~<rdma/ib_smi.h
>

67 
	~"hfi.h
"

68 
	~"deviû.h
"

69 
	~"commÚ.h
"

70 
	~"v”bs_tx»q.h
"

71 
	~"Œaû.h
"

73 #undeà
´_fmt


74 
	#´_fmt
(
fmt
è
DRIVER_NAME
 ": " 
	)
fmt

75 
	#¢oÝ_dbg
(
fmt
, ...) \

76 
	`hfi1_cdbg
(
SNOOP
, 
fmt
, ##
__VA_ARGS__
)

	)

79 
	#SNOOP_DROP_SEND
 
	`BIT
(0)

	)

80 
	#SNOOP_USE_METADATA
 
	`BIT
(1)

	)

81 
	#SNOOP_SET_VL0TOVL15
 
	`BIT
(2)

	)

83 
u8
 
	g¢oÝ_æags
;

85 
	ehfi1_fž‹r_¡©us
 {

86 
	mHFI1_FILTER_HIT
,

87 
	mHFI1_FILTER_ERR
,

88 
	mHFI1_FILTER_MISS


92 
	s¢oÝ_·ck‘
 {

93 
li¡_h—d
 
	mli¡
;

94 
u32
 
	mtÙ®_Ën
;

95 
u8
 
	md©a
[];

99 
	#PKT_DIR_EGRESS
 0x0

	)

100 
	#PKT_DIR_INGRESS
 0x1

	)

103 
	sÿ±u»_md
 {

104 
u8
 
	mpÜt
;

105 
u8
 
	mdœ
;

106 
u8
 
	m»£rved
[6];

108 
u64
 
	mpbc
;

109 
u64
 
	mrhf
;

110 } 
	mu
;

113 
©omic_t
 
	gdŸgpkt_couÁ
 = 
ATOMIC_INIT
(0);

114 
cdev
 
	gdŸgpkt_cdev
;

115 
deviû
 *
	gdŸgpkt_deviû
;

117 
ssize_t
 
dŸgpkt_wr™e
(
fže
 *
å
, cÚ¡ 
__u£r
 *
d©a
,

118 
size_t
 
couÁ
, 
loff_t
 *
off
);

120 cÚ¡ 
fže_Ý”©iÚs
 
	gdŸgpkt_fže_Ýs
 = {

121 .
owÃr
 = 
THIS_MODULE
,

122 .
	gwr™e
 = 
dŸgpkt_wr™e
,

123 .
	gÎ£ek
 = 
noÝ_Î£ek
,

129 
	shfi1_lšk_šfo
 {

130 
__be64
 
	mnode_guid
;

131 
u8
 
	mpÜt_mode
;

132 
u8
 
	mpÜt_¡©e
;

133 
u16
 
	mlšk_¥“d_aùive
;

134 
u16
 
	mlšk_width_aùive
;

135 
u16
 
	mvl15_š™
;

136 
u8
 
	mpÜt_numb”
;

144 
u8
 
	m»s
[47];

151 
	#SNOOP_CAPTURE_VERSION
 0x1

	)

153 
	#HFI1_SNOOP_IOC_MAGIC
 
IB_IOCTL_MAGIC


	)

154 
	#HFI1_SNOOP_IOC_BASE_SEQ
 0x80

	)

156 
	#HFI1_SNOOP_IOCGETLINKSTATE
 \

157 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
)

	)

158 
	#HFI1_SNOOP_IOCSETLINKSTATE
 \

159 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 1)

	)

160 
	#HFI1_SNOOP_IOCCLEARQUEUE
 \

161 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 2)

	)

162 
	#HFI1_SNOOP_IOCCLEARFILTER
 \

163 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 3)

	)

164 
	#HFI1_SNOOP_IOCSETFILTER
 \

165 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 4)

	)

166 
	#HFI1_SNOOP_IOCGETVERSION
 \

167 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 5)

	)

168 
	#HFI1_SNOOP_IOCSET_OPTS
 \

169 
	`_IO
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 6)

	)

175 
	#HFI1_SNOOP_IOCGETLINKSTATE_EXTRA
 \

176 
	`_IOWR
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 6, \

177 
hfi1_lšk_šfo
)

	)

178 
	#HFI1_SNOOP_IOCSETLINKSTATE_EXTRA
 \

179 
	`_IOWR
(
HFI1_SNOOP_IOC_MAGIC
, 
HFI1_SNOOP_IOC_BASE_SEQ
 + 7, \

180 
hfi1_lšk_šfo
)

	)

182 
hfi1_¢oÝ_Ý’
(
šode
 *
š
, 
fže
 *
å
);

183 
ssize_t
 
hfi1_¢oÝ_»ad
(
fže
 *
å
, 
__u£r
 *
d©a
,

184 
size_t
 
pkt_Ën
, 
loff_t
 *
off
);

185 
ssize_t
 
hfi1_¢oÝ_wr™e
(
fže
 *
å
, cÚ¡ 
__u£r
 *
d©a
,

186 
size_t
 
couÁ
, 
loff_t
 *
off
);

187 
hfi1_ioùl
(
fže
 *
å
, 
cmd
, 
¬g
);

188 
hfi1_¢oÝ_pÞl
(
fže
 *
å
,

189 
pÞl_bË_¡ruù
 *
wa™
);

190 
hfi1_¢oÝ_»Ëa£
(
šode
 *
š
, 
fže
 *
å
);

192 
	shfi1_·ck‘_fž‹r_commªd
 {

193 
	mÝcode
;

194 
	mËngth
;

195 *
	mv®ue_±r
;

199 
	#HFI1_SNOOP_INGRESS
 0x1

	)

200 
	#HFI1_SNOOP_EGRESS
 0x2

	)

202 
	ehfi1_·ck‘_fž‹r_Ýcodes
 {

203 
	mFILTER_BY_LID
,

204 
	mFILTER_BY_DLID
,

205 
	mFILTER_BY_MAD_MGMT_CLASS
,

206 
	mFILTER_BY_QP_NUMBER
,

207 
	mFILTER_BY_PKT_TYPE
,

208 
	mFILTER_BY_SERVICE_LEVEL
,

209 
	mFILTER_BY_PKEY
,

210 
	mFILTER_BY_DIRECTION
,

213 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
	g¢oÝ_rhf_rcv_funùiÚs
[];

215 cÚ¡ 
fže_Ý”©iÚs
 
	g¢oÝ_fže_Ýs
 = {

216 .
owÃr
 = 
THIS_MODULE
,

217 .
	gÝ’
 = 
hfi1_¢oÝ_Ý’
,

218 .
	g»ad
 = 
hfi1_¢oÝ_»ad
,

219 .
	guÆocked_ioùl
 = 
hfi1_ioùl
,

220 .
	gpÞl
 = 
hfi1_¢oÝ_pÞl
,

221 .
	gwr™e
 = 
hfi1_¢oÝ_wr™e
,

222 .
	g»Ëa£
 = 
hfi1_¢oÝ_»Ëa£


225 
	shfi1_fž‹r_¬¿y
 {

226 (*
	mfž‹r
)(*, *, *);

229 
hfi1_fž‹r_lid
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
);

230 
hfi1_fž‹r_dlid
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
);

231 
hfi1_fž‹r_mad_mgmt_þass
(*
ibhdr
, *
·ck‘_d©a
,

232 *
v®ue
);

233 
hfi1_fž‹r_qp_numb”
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
);

234 
hfi1_fž‹r_ib·ck‘_ty³
(*
ibhdr
, *
·ck‘_d©a
,

235 *
v®ue
);

236 
hfi1_fž‹r_ib_£rviû_Ëv–
(*
ibhdr
, *
·ck‘_d©a
,

237 *
v®ue
);

238 
hfi1_fž‹r_ib_pkey
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
);

239 
hfi1_fž‹r_dœeùiÚ
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
);

241 cÚ¡ 
hfi1_fž‹r_¬¿y
 
	ghfi1_fž‹rs
[] = {

242 { 
hfi1_fž‹r_lid
 },

243 { 
hfi1_fž‹r_dlid
 },

244 { 
hfi1_fž‹r_mad_mgmt_þass
 },

245 { 
hfi1_fž‹r_qp_numb”
 },

246 { 
hfi1_fž‹r_ib·ck‘_ty³
 },

247 { 
hfi1_fž‹r_ib_£rviû_Ëv–
 },

248 { 
hfi1_fž‹r_ib_pkey
 },

249 { 
hfi1_fž‹r_dœeùiÚ
 },

252 
	#HFI1_MAX_FILTERS
 
	`ARRAY_SIZE
(
hfi1_fž‹rs
)

	)

253 
	#HFI1_DIAG_MINOR_BASE
 129

	)

255 
hfi1_¢oÝ_add
(
hfi1_devd©a
 *
dd
, cÚ¡ *
Çme
);

257 
	$hfi1_dŸg_add
(
hfi1_devd©a
 *
dd
)

259 
Çme
[16];

260 
»t
 = 0;

262 
	`¢´štf
(
Çme
, Òame), "%s_dŸgpkt%d", 
	`þass_Çme
(),

263 
dd
->
un™
);

268 
»t
 = 
	`hfi1_¢oÝ_add
(
dd
, 
Çme
);

269 ià(
»t
)

270 
	`dd_dev_”r
(
dd
, "Unableo init snoop/capture device");

272 
	`¢´štf
(
Çme
, Òame), "%s_dŸgpkt", 
	`þass_Çme
());

273 ià(
	`©omic_šc_»tuº
(&
dŸgpkt_couÁ
) == 1) {

274 
	`kobjeù_g‘
(&
dd
->
kobj
);

275 
»t
 = 
	`hfi1_cdev_š™
(
HFI1_DIAGPKT_MINOR
, 
Çme
,

276 &
dŸgpkt_fže_Ýs
, &
dŸgpkt_cdev
,

277 &
dŸgpkt_deviû
, 
çl£
, &
dd
->
kobj
);

278 ià(
»t
)

279 
	`kobjeù_put
(&
dd
->
kobj
);

282  
»t
;

283 
	}
}

286 
	$d¿š_¢oÝ_li¡
(
li¡_h—d
 *
queue
)

288 
li¡_h—d
 *
pos
, *
q
;

289 
¢oÝ_·ck‘
 *
·ck‘
;

291 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, 
queue
) {

292 
·ck‘
 = 
	`li¡_’Œy
(
pos
, 
¢oÝ_·ck‘
, 
li¡
);

293 
	`li¡_d–
(
pos
);

294 
	`kä“
(
·ck‘
);

296 
	}
}

298 
	$hfi1_¢oÝ_»move
(
hfi1_devd©a
 *
dd
)

300 
æags
 = 0;

302 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

303 
	`d¿š_¢oÝ_li¡
(&
dd
->
hfi1_¢oÝ
.
queue
);

304 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

305 
	`hfi1_cdev_þ—nup
(&
dd
->
hfi1_¢oÝ
.
cdev
, &dd->hfi1_¢oÝ.
þass_dev
);

306 
	`kobjeù_put
(&
dd
->
kobj
);

307 
	}
}

309 
	$hfi1_dŸg_»move
(
hfi1_devd©a
 *
dd
)

311 
	`hfi1_¢oÝ_»move
(
dd
);

312 ià(
	`©omic_dec_ªd_‹¡
(&
dŸgpkt_couÁ
)) {

313 
	`hfi1_cdev_þ—nup
(&
dŸgpkt_cdev
, &
dŸgpkt_deviû
);

314 
	`kobjeù_put
(&
dd
->
kobj
);

316 
	`hfi1_cdev_þ—nup
(&
dd
->
dŸg_cdev
, &dd->
dŸg_deviû
);

317 
	}
}

323 
	sdŸgpkt_wa™
 {

324 
com¶‘iÚ
 
	müed™s_»tuºed
;

325 
	mcode
;

326 
©omic_t
 
	mcouÁ
;

333 
	$put_dŸgpkt_wa™
(
dŸgpkt_wa™
 *
wa™
)

335 ià(
	`©omic_dec_ªd_‹¡
(&
wa™
->
couÁ
))

336 
	`kä“
(
wa™
);

337 
	}
}

343 
	$dŸgpkt_com¶‘e
(*
¬g
, 
code
)

345 
dŸgpkt_wa™
 *
wa™
 = (dŸgpkt_wa™ *)
¬g
;

347 
wa™
->
code
 = code;

348 
	`com¶‘e
(&
wa™
->
üed™s_»tuºed
);

349 
	`put_dŸgpkt_wa™
(
wa™
);

350 
	}
}

356 
ssize_t
 
	$dŸgpkt_£nd
(
dŸg_pkt
 *
dp
)

358 
hfi1_devd©a
 *
dd
;

359 
£nd_cÚ‹xt
 *
sc
;

360 
pio_buf
 *
pbuf
;

361 
u32
 *
tmpbuf
 = 
NULL
;

362 
ssize_t
 
»t
 = 0;

363 
u32
 
pkt_Ën
, 
tÙ®_Ën
;

364 
pio_»Ëa£_cb
 
üed™_cb
 = 
NULL
;

365 *
üed™_¬g
 = 
NULL
;

366 
dŸgpkt_wa™
 *
wa™
 = 
NULL
;

367 
ŒycouÁ
 = 0;

369 
dd
 = 
	`hfi1_lookup
(
dp
->
un™
);

370 ià(!
dd
 || !(dd->
æags
 & 
HFI1_PRESENT
è|| !dd->
k»gba£1
) {

371 
»t
 = -
ENODEV
;

372 
baž
;

374 ià(!(
dd
->
æags
 & 
HFI1_INITTED
)) {

376 
»t
 = -
ENODEV
;

377 
baž
;

380 ià(
dp
->
v”siÚ
 !ð
_DIAG_PKT_VERS
) {

381 
	`dd_dev_”r
(
dd
, "Invalid version %u for diagpkt_write\n",

382 
dp
->
v”siÚ
);

383 
»t
 = -
EINVAL
;

384 
baž
;

388 ià(
dp
->
Ën
 & 3) {

389 
»t
 = -
EINVAL
;

390 
baž
;

394 ià(
dp
->
pÜt
 != 1) {

395 
»t
 = -
EINVAL
;

396 
baž
;

400 ià(
dp
->
sw_šdex
 >ð
dd
->
num_£nd_cÚ‹xts
) {

401 
»t
 = -
EINVAL
;

402 
baž
;

405 ià(
dd
->
£nd_cÚ‹xts
[
dp
->
sw_šdex
].
ty³
 !ð
SC_KERNEL
 &&

406 
dd
->
£nd_cÚ‹xts
[
dp
->
sw_šdex
].
ty³
 !ð
SC_VL15
) {

407 
»t
 = -
EINVAL
;

408 
baž
;

411 
sc
 = 
dd
->
£nd_cÚ‹xts
[
dp
->
sw_šdex
].sc;

412 ià(!
sc
) {

413 
»t
 = -
EINVAL
;

414 
baž
;

417 ià(!(
sc
->
æags
 & 
SCF_ENABLED
)) {

418 
»t
 = -
EINVAL
;

419 
baž
;

423 
tmpbuf
 = 
	`vm®loc
(
dp
->
Ën
);

424 ià(!
tmpbuf
) {

425 
»t
 = -
ENOMEM
;

426 
baž
;

429 ià(
	`cÝy_äom_u£r
(
tmpbuf
,

430 (cÚ¡ 
__u£r
 *)()
dp
->
d©a
,

431 
dp
->
Ën
)) {

432 
»t
 = -
EFAULT
;

433 
baž
;

441 
pkt_Ën
 = 
dp
->
Ën
 >> 2;

442 
tÙ®_Ën
 = 
pkt_Ën
 + 2;

445 ià(
dp
->
pbc
 == 0) {

446 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

448 
	`hfi1_cdbg
(
PKT
, "Generating PBC");

449 
dp
->
pbc
 = 
	`ü—‹_pbc
(
µd
, 0, 0, 0, 
tÙ®_Ën
);

451 
	`hfi1_cdbg
(
PKT
, "Using…assed in PBC");

454 
	`hfi1_cdbg
(
PKT
, "Eg»s PBC cÚ‹Á i 0x%Îx", 
dp
->
pbc
);

465 ià(
dp
->
æags
 & 
F_DIAGPKT_WAIT
) {

466 
wa™
 = 
	`km®loc
((*wa™), 
GFP_KERNEL
);

467 ià(!
wa™
) {

468 
»t
 = -
ENOMEM
;

469 
baž
;

472 
dp
->
pbc
 |ð
PBC_CREDIT_RETURN
;

474 
	`sc_add_üed™_»tuº_šŒ
(
sc
);

475 
	`š™_com¶‘iÚ
(&
wa™
->
üed™s_»tuºed
);

476 
	`©omic_£t
(&
wa™
->
couÁ
, 2);

477 
wa™
->
code
 = 
PRC_OK
;

479 
üed™_cb
 = 
dŸgpkt_com¶‘e
;

480 
üed™_¬g
 = 
wa™
;

483 
»Œy
:

484 
pbuf
 = 
	`sc_bufãr_®loc
(
sc
, 
tÙ®_Ën
, 
üed™_cb
, 
üed™_¬g
);

485 ià(
	`IS_ERR_OR_NULL
(
pbuf
)) {

486 ià(!
pbuf
 && 
ŒycouÁ
 == 0) {

488 
	`sc_»tuº_üed™s
(
sc
);

489 
ŒycouÁ
 = 1;

490 
»Œy
;

497 ià(
dp
->
æags
 & 
F_DIAGPKT_WAIT
) {

498 
	`sc_d–_üed™_»tuº_šŒ
(
sc
);

499 
	`kä“
(
wa™
);

500 
wa™
 = 
NULL
;

502 ià(
	`IS_ERR
(
pbuf
))

503 
»t
 = 
	`PTR_ERR
(
pbuf
);

505 
»t
 = -
ENOSPC
;

506 
baž
;

509 
	`pio_cÝy
(
dd
, 
pbuf
, 
dp
->
pbc
, 
tmpbuf
, 
pkt_Ën
);

512 
»t
 = (*
dp
);

514 ià(
dp
->
æags
 & 
F_DIAGPKT_WAIT
) {

516 
»t
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
(

517 &
wa™
->
üed™s_»tuºed
);

530 ià(!
»t
 && (((
wa™
->
code
 & 
PRC_STATUS_ERR
) ||

531 (
wa™
->
code
 & 
PRC_FILL_ERR
) ||

532 (
wa™
->
code
 & 
PRC_SC_DISABLE
))))

533 
»t
 = -
EIO
;

535 
	`put_dŸgpkt_wa™
(
wa™
);

536 
	`sc_d–_üed™_»tuº_šŒ
(
sc
);

539 
baž
:

540 
	`vä“
(
tmpbuf
);

541  
»t
;

542 
	}
}

544 
ssize_t
 
	$dŸgpkt_wr™e
(
fže
 *
å
, cÚ¡ 
__u£r
 *
d©a
,

545 
size_t
 
couÁ
, 
loff_t
 *
off
)

547 
hfi1_devd©a
 *
dd
;

548 
£nd_cÚ‹xt
 *
sc
;

549 
u8
 
vl
;

551 
dŸg_pkt
 
dp
;

553 ià(
couÁ
 !ð(
dp
))

554  -
EINVAL
;

556 ià(
	`cÝy_äom_u£r
(&
dp
, 
d©a
, (dp)))

557  -
EFAULT
;

563 ià(
dp
.
pbc
) {

564 
dd
 = 
	`hfi1_lookup
(
dp
.
un™
);

565 ià(!
dd
)

566  -
ENODEV
;

567 
vl
 = (
dp
.
pbc
 >> 
PBC_VL_SHIFT
è& 
PBC_VL_MASK
;

568 
sc
 = 
dd
->
vld
[
vl
].sc;

569 ià(
sc
) {

570 
dp
.
sw_šdex
 = 
sc
->sw_index;

571 
	`hfi1_cdbg
(

572 
PKT
,

574 
vl
, 
sc
->
sw_šdex
, sc->
hw_cÚ‹xt
);

578  
	`dŸgpkt_£nd
(&
dp
);

579 
	}
}

581 
	$hfi1_¢oÝ_š™
(
hfi1_devd©a
 *
dd
)

583 
	`¥š_lock_š™
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
);

584 
	`INIT_LIST_HEAD
(&
dd
->
hfi1_¢oÝ
.
queue
);

585 
	`š™_wa™queue_h—d
(&
dd
->
hfi1_¢oÝ
.
wa™q
);

586 
	}
}

588 
	$hfi1_¢oÝ_add
(
hfi1_devd©a
 *
dd
, cÚ¡ *
Çme
)

590 
»t
 = 0;

592 
	`kobjeù_g‘
(&
dd
->
kobj
);

593 
»t
 = 
	`hfi1_cdev_š™
(
HFI1_SNOOP_CAPTURE_BASE
 + 
dd
->
un™
, 
Çme
,

594 &
¢oÝ_fže_Ýs
,

595 &
dd
->
hfi1_¢oÝ
.
cdev
, &dd->hfi1_¢oÝ.
þass_dev
,

596 
çl£
, &
dd
->
kobj
);

598 ià(
»t
) {

599 
	`dd_dev_”r
(
dd
, "Couldn'ˆü—‹ % deviû: %d", 
Çme
, 
»t
);

600 
	`hfi1_cdev_þ—nup
(&
dd
->
hfi1_¢oÝ
.
cdev
,

601 &
dd
->
hfi1_¢oÝ
.
þass_dev
);

602 
	`kobjeù_put
(&
dd
->
kobj
);

605  
»t
;

606 
	}
}

608 
hfi1_devd©a
 *
	$hfi1_dd_äom_sc_šode
(
šode
 *
š
)

610 
un™
 = 
	`imšÜ
(
š
è- 
HFI1_SNOOP_CAPTURE_BASE
;

611 
hfi1_devd©a
 *
dd
;

613 
dd
 = 
	`hfi1_lookup
(
un™
);

614  
dd
;

615 
	}
}

618 
	$adju¡_š‹gr™y_checks
(
hfi1_devd©a
 *
dd
)

620 
£nd_cÚ‹xt
 *
sc
;

621 
sc_æags
;

622 
i
;

624 
	`¥š_lock_œq§ve
(&
dd
->
sc_lock
, 
sc_æags
);

625 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

626 
’abË
;

628 
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

630 ià(!
sc
)

633 
’abË
 = 
	`lik–y
(!
	`HFI1_CAP_IS_KSET
(
NO_INTEGRITY
)) &&

634 
dd
->
hfi1_¢oÝ
.
mode_æag
 !ð
HFI1_PORT_SNOOP_MODE
;

636 
	`£t_pio_š‹gr™y
(
sc
);

638 ià(
’abË
)

639 
	`hfi1_š™_ùxt
(
sc
);

641 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
sc_æags
);

642 
	}
}

644 
	$hfi1_¢oÝ_§ve_funcs
(
hfi1_devd©a
 *
dd
)

646 
i
;

648 
hfi1_ùxtd©a
 *
rcd
;

650 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

651 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex_§ã
(
dd
, 
i
);

652 ià(
rcd
 && (
i
 < 
dd
->
fœ¡_dyn_®loc_ùxt
 ||„cd->
is_vnic
)) {

653 
	`¢oÝ_dbg
("context %u changing from %po %p\n",

654 
i
, 
rcd
->
rhf_rcv_funùiÚ_m­
, 
¢oÝ_rhf_rcv_funùiÚs
);

655 
rcd
->
§ve_rhf_rcv_funùiÚ_m­
 =

656 
rcd
->
rhf_rcv_funùiÚ_m­
;

657 
rcd
->
rhf_rcv_funùiÚ_m­
 =

658 
¢oÝ_rhf_rcv_funùiÚs
;

660 
	`hfi1_rcd_put
(
rcd
);

662 
	}
}

664 
	$hfi1_¢oÝ_»¡Üe_funcs
(
hfi1_devd©a
 *
dd
)

666 
i
;

667 
hfi1_ùxtd©a
 *
rcd
;

669 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

670 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex_§ã
(
dd
, 
i
);

671 ià(
rcd
 && (
i
 < 
dd
->
fœ¡_dyn_®loc_ùxt
 ||„cd->
is_vnic
)) {

672 cÚ¡ 
rhf_rcv_funùiÚ_±r
 *
tmp
 =

673 
rcd
->
§ve_rhf_rcv_funùiÚ_m­
;

675 ià(
tmp
) {

676 
	`¢oÝ_dbg
("context %u changing from %po %p\n",

677 
i
, 
rcd
->
rhf_rcv_funùiÚ_m­
, 
tmp
);

678 
rcd
->
rhf_rcv_funùiÚ_m­
 = 
tmp
;

681 
	`hfi1_rcd_put
(
rcd
);

683 
	}
}

685 
	$hfi1_¢oÝ_Ý’
(
šode
 *
š
, 
fže
 *
å
)

687 
»t
;

688 
mode_æag
 = 0;

689 
æags
 = 0;

690 
hfi1_devd©a
 *
dd
;

691 
li¡_h—d
 *
queue
;

693 
	`mu‹x_lock
(&
hfi1_mu‹x
);

695 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
š
);

696 ià(!
dd
) {

697 
»t
 = -
ENODEV
;

698 
baž
;

708 ià((
å
->
f_æags
 & 
O_ACCMODE
è=ð
O_RDONLY
) {

709 
	`¢oÝ_dbg
("Capture Enabled");

710 
mode_æag
 = 
HFI1_PORT_CAPTURE_MODE
;

711 } ià((
å
->
f_æags
 & 
O_ACCMODE
è=ð
O_RDWR
) {

712 
	`¢oÝ_dbg
("Snoop Enabled");

713 
mode_æag
 = 
HFI1_PORT_SNOOP_MODE
;

715 
	`¢oÝ_dbg
("Invalid");

716 
»t
 = -
EINVAL
;

717 
baž
;

719 
queue
 = &
dd
->
hfi1_¢oÝ
.queue;

724 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

725 ià(
dd
->
hfi1_¢oÝ
.
mode_æag
) {

726 
»t
 = -
EBUSY
;

727 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

728 
baž
;

731 
dd
->
hfi1_¢oÝ
.
mode_æag
 = mode_flag;

732 
	`d¿š_¢oÝ_li¡
(
queue
);

734 
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
 = 
NULL
;

735 
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
 = 
NULL
;

741 ià(
mode_æag
 =ð
HFI1_PORT_SNOOP_MODE
) {

743 
	`adju¡_š‹gr™y_checks
(
dd
);

749 
dd
->
hfi1_¢oÝ
.
dcc_cfg
 = 
	`»ad_c¤
(dd, 
DCC_CFG_PORT_CONFIG1
);

750 
	`wr™e_c¤
(
dd
, 
DCC_CFG_PORT_CONFIG1
,

751 (
dd
->
hfi1_¢oÝ
.
dcc_cfg
 >> 32) << 32);

762 
	`hfi1_¢oÝ_§ve_funcs
(
dd
);

763 
dd
->
´oûss_pio_£nd
 = 
¢oÝ_£nd_pio_hªdËr
;

764 
dd
->
´oûss_dma_£nd
 = 
¢oÝ_£nd_pio_hªdËr
;

765 
dd
->
pio_šlše_£nd
 = 
¢oÝ_šlše_pio_£nd
;

767 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

768 
»t
 = 0;

770 
baž
:

771 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

773  
»t
;

774 
	}
}

776 
	$hfi1_¢oÝ_»Ëa£
(
šode
 *
š
, 
fže
 *
å
)

778 
æags
 = 0;

779 
hfi1_devd©a
 *
dd
;

780 
mode_æag
;

782 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
š
);

783 ià(!
dd
)

784  -
ENODEV
;

786 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

789 
mode_æag
 = 
dd
->
hfi1_¢oÝ
.mode_flag;

790 
dd
->
hfi1_¢oÝ
.
mode_æag
 = 0;

796 
	`d¿š_¢oÝ_li¡
(&
dd
->
hfi1_¢oÝ
.
queue
);

797 ià(
mode_æag
 =ð
HFI1_PORT_SNOOP_MODE
) {

799 
	`adju¡_š‹gr™y_checks
(
dd
);

806 
	`wr™e_c¤
(
dd
, 
DCC_CFG_PORT_CONFIG1
, dd->
hfi1_¢oÝ
.
dcc_cfg
);

809 
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
 = 
NULL
;

810 
	`kä“
(
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

811 
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
 = 
NULL
;

817 
	`hfi1_¢oÝ_»¡Üe_funcs
(
dd
);

818 
dd
->
´oûss_pio_£nd
 = 
hfi1_v”bs_£nd_pio
;

819 
dd
->
´oûss_dma_£nd
 = 
hfi1_v”bs_£nd_dma
;

820 
dd
->
pio_šlše_£nd
 = 
pio_cÝy
;

822 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

824 
	`¢oÝ_dbg
("snoop/capture device„eleased");

827 
	}
}

829 
	$hfi1_¢oÝ_pÞl
(
fže
 *
å
,

830 
pÞl_bË_¡ruù
 *
wa™
)

832 
»t
 = 0;

833 
æags
 = 0;

835 
hfi1_devd©a
 *
dd
;

837 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
å
->
f_šode
);

838 ià(!
dd
)

839  -
ENODEV
;

841 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

843 
	`pÞl_wa™
(
å
, &
dd
->
hfi1_¢oÝ
.
wa™q
, 
wa™
);

844 ià(!
	`li¡_em±y
(&
dd
->
hfi1_¢oÝ
.
queue
))

845 
»t
 |ð
POLLIN
 | 
POLLRDNORM
;

847 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

848  
»t
;

849 
	}
}

851 
ssize_t
 
	$hfi1_¢oÝ_wr™e
(
fže
 *
å
, cÚ¡ 
__u£r
 *
d©a
,

852 
size_t
 
couÁ
, 
loff_t
 *
off
)

854 
dŸg_pkt
 
dpkt
;

855 
hfi1_devd©a
 *
dd
;

856 
size_t
 
»t
;

857 
u8
 
by‹_two
, 
¦
, 
sc5
, 
sc4
, 
vl
, 
by‹_Úe
;

858 
£nd_cÚ‹xt
 *
sc
;

859 
u32
 
Ën
;

860 
u64
 
pbc
;

861 
hfi1_ibpÜt
 *
ibp
;

862 
hfi1_µÜtd©a
 *
µd
;

864 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
å
->
f_šode
);

865 ià(!
dd
)

866  -
ENODEV
;

868 
µd
 = 
dd
->
µÜt
;

869 
	`¢oÝ_dbg
("»ûived %lu by‹ äom u£r", 
couÁ
);

871 
	`mem£t
(&
dpkt
, 0, (
dŸg_pkt
));

872 
dpkt
.
v”siÚ
 = 
_DIAG_PKT_VERS
;

873 
dpkt
.
un™
 = 
dd
->unit;

874 
dpkt
.
pÜt
 = 1;

876 ià(
	`lik–y
(!(
¢oÝ_æags
 & 
SNOOP_USE_METADATA
))) {

887 ià(
	`cÝy_äom_u£r
(&
by‹_Úe
, 
d©a
, 1))

888  -
EINVAL
;

890 ià(
	`cÝy_äom_u£r
(&
by‹_two
, 
d©a
 + 1, 1))

891  -
EINVAL
;

893 
sc4
 = (
by‹_Úe
 >> 4) & 0xf;

894 ià(
sc4
 == 0xF) {

895 
	`¢oÝ_dbg
("Detected VL15…acket ignoring SL in…acket");

896 
vl
 = 
sc4
;

898 
¦
 = (
by‹_two
 >> 4) & 0xf;

899 
ibp
 = 
	`to_Üt
(&
dd
->
v”bs_dev
.
rdi
.
ibdev
, 1);

900 
sc5
 = 
ibp
->
¦_to_sc
[
¦
];

901 
vl
 = 
	`sc_to_vÉ
(
dd
, 
sc5
);

902 ià(
vl
 !ð
sc4
) {

903 
	`¢oÝ_dbg
("VL %d does‚ot match SC %d of…acket",

904 
vl
, 
sc4
);

905  -
EINVAL
;

909 
sc
 = 
dd
->
vld
[
vl
].sc;

910 ià(
sc
) {

911 
dpkt
.
sw_šdex
 = 
sc
->sw_index;

912 
	`¢oÝ_dbg
("S’dšg oÀcÚ‹xˆ%u(%u)", 
sc
->
sw_šdex
,

913 
sc
->
hw_cÚ‹xt
);

915 
	`¢oÝ_dbg
("Could‚Ù fšd cÚ‹xˆfÜ vÈ%d", 
vl
);

916  -
EINVAL
;

919 
Ën
 = (
couÁ
 >> 2) + 2;

920 
pbc
 = 
	`ü—‹_pbc
(
µd
, 0, 0, 
vl
, 
Ën
);

922 ià(
	`cÝy_äom_u£r
(&
pbc
, 
d©a
, (pbc)))

923  -
EINVAL
;

924 
vl
 = (
pbc
 >> 
PBC_VL_SHIFT
è& 
PBC_VL_MASK
;

925 
sc
 = 
dd
->
vld
[
vl
].sc;

926 ià(
sc
) {

927 
dpkt
.
sw_šdex
 = 
sc
->sw_index;

929 
	`¢oÝ_dbg
("Could‚Ù fšd cÚ‹xˆfÜ vÈ%d", 
vl
);

930  -
EINVAL
;

932 
d©a
 +ð(
pbc
);

933 
couÁ
 -ð(
pbc
);

935 
dpkt
.
Ën
 = 
couÁ
;

936 
dpkt
.
d©a
 = ()data;

938 
	`¢oÝ_dbg
("PBC: vl=0x%llx Length=0x%llx",

939 (
pbc
 >> 12) & 0xf,

940 (
pbc
 & 0xfff));

942 
dpkt
.
pbc
 =…bc;

943 
»t
 = 
	`dŸgpkt_£nd
(&
dpkt
);

948 ià(
»t
 =ð(
dpkt
))

949  
couÁ
;

951  
»t
;

952 
	}
}

954 
ssize_t
 
	$hfi1_¢oÝ_»ad
(
fže
 *
å
, 
__u£r
 *
d©a
,

955 
size_t
 
pkt_Ën
, 
loff_t
 *
off
)

957 
ssize_t
 
»t
 = 0;

958 
æags
 = 0;

959 
¢oÝ_·ck‘
 *
·ck‘
 = 
NULL
;

960 
hfi1_devd©a
 *
dd
;

962 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
å
->
f_šode
);

963 ià(!
dd
)

964  -
ENODEV
;

966 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

968 
	`li¡_em±y
(&
dd
->
hfi1_¢oÝ
.
queue
)) {

969 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

971 ià(
å
->
f_æags
 & 
O_NONBLOCK
)

972  -
EAGAIN
;

974 ià(
	`wa™_ev’t_š‹¼u±ibË
(

975 
dd
->
hfi1_¢oÝ
.
wa™q
,

976 !
	`li¡_em±y
(&
dd
->
hfi1_¢oÝ
.
queue
)))

977  -
EINTR
;

979 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

982 ià(!
	`li¡_em±y
(&
dd
->
hfi1_¢oÝ
.
queue
)) {

983 
·ck‘
 = 
	`li¡_’Œy
(
dd
->
hfi1_¢oÝ
.
queue
.
Ãxt
,

984 
¢oÝ_·ck‘
, 
li¡
);

985 
	`li¡_d–
(&
·ck‘
->
li¡
);

986 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

987 ià(
pkt_Ën
 >ð
·ck‘
->
tÙ®_Ën
) {

988 ià(
	`cÝy_to_u£r
(
d©a
, 
·ck‘
->data,

989 
·ck‘
->
tÙ®_Ën
))

990 
»t
 = -
EFAULT
;

992 
»t
 = 
·ck‘
->
tÙ®_Ën
;

994 
»t
 = -
EINVAL
;

997 
	`kä“
(
·ck‘
);

999 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1002  
»t
;

1003 
	}
}

1026 
	$hfi1_assign_¢oÝ_lšk_üed™s
(
hfi1_µÜtd©a
 *
µd
,

1027 
v®ue
)

1029 
	#OPA_MIN_PER_VL_CREDITS
 34

	)

1030 
bufãr_cÚŒÞ
 
t
;

1031 
i
;

1032 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1033 
u16
 
tÙ®_üed™s
 = (
v®ue
 >> 16) & 0xffff;

1034 
u16
 
vl15_üed™s
 = 
dd
->
vl15_š™
 / 2;

1035 
u16
 
³r_vl_üed™s
;

1036 
__be16
 
be_³r_vl_üed™s
;

1038 ià(
µd
->
ho¡_lšk_¡©e
 & 
HLS_DOWN
)

1039 
”r_ex™
;

1040 ià(
tÙ®_üed™s
 < 
vl15_üed™s
)

1041 
”r_ex™
;

1043 
³r_vl_üed™s
 = (
tÙ®_üed™s
 - 
vl15_üed™s
è/ 
TXE_NUM_DATA_VL
;

1045 ià(
³r_vl_üed™s
 < 
OPA_MIN_PER_VL_CREDITS
)

1046 
”r_ex™
;

1048 
	`mem£t
(&
t
, 0, (t));

1049 
be_³r_vl_üed™s
 = 
	`ýu_to_be16
(
³r_vl_üed™s
);

1051 
i
 = 0; i < 
TXE_NUM_DATA_VL
; i++)

1052 
t
.
vl
[
i
].
dediÿ‹d
 = 
be_³r_vl_üed™s
;

1054 
t
.
vl
[15].
dediÿ‹d
 = 
	`ýu_to_be16
(
vl15_üed™s
);

1055  
	`£t_bufãr_cÚŒÞ
(
µd
, &
t
);

1057 
”r_ex™
:

1058 
	`¢oÝ_dbg
("port_state = 0x%x,otal_credits = %d, vl15_credits = %d",

1059 
µd
->
ho¡_lšk_¡©e
, 
tÙ®_üed™s
, 
vl15_üed™s
);

1061  -
EINVAL
;

1062 
	}
}

1064 
	$hfi1_ioùl
(
fže
 *
å
, 
cmd
, 
¬g
)

1066 
hfi1_devd©a
 *
dd
;

1067 *
fž‹r_v®ue
 = 
NULL
;

1068 
»t
 = 0;

1069 
v®ue
 = 0;

1070 
u8
 
phys_¡©e
 = 0;

1071 
u8
 
lšk_¡©e
 = 0;

1072 
u16
 
dev_¡©e
 = 0;

1073 
æags
 = 0;

1074 *
¬gp
 = 
NULL
;

1075 
hfi1_·ck‘_fž‹r_commªd
 
fž‹r_cmd
 = {0};

1076 
mode_æag
 = 0;

1077 
hfi1_µÜtd©a
 *
µd
 = 
NULL
;

1078 
šdex
;

1079 
hfi1_lšk_šfo
 
lšk_šfo
;

1081 
dd
 = 
	`hfi1_dd_äom_sc_šode
(
å
->
f_šode
);

1082 ià(!
dd
)

1083  -
ENODEV
;

1085 
mode_æag
 = 
dd
->
hfi1_¢oÝ
.mode_flag;

1087 ià(!
	`acûss_ok
((
__u£r
 *)
¬g
, 
	`_IOC_SIZE
(
cmd
)))

1088  -
EFAULT
;

1090 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1091  -
EPERM
;

1093 ià((
mode_æag
 & 
HFI1_PORT_CAPTURE_MODE
) &&

1094 (
cmd
 !ð
HFI1_SNOOP_IOCCLEARQUEUE
) &&

1095 (
cmd
 !ð
HFI1_SNOOP_IOCCLEARFILTER
) &&

1096 (
cmd
 !ð
HFI1_SNOOP_IOCSETFILTER
))

1103  -
EINVAL
;

1105 
cmd
) {

1106 
HFI1_SNOOP_IOCSETLINKSTATE_EXTRA
:

1107 
	`mem£t
(&
lšk_šfo
, 0, (link_info));

1109 ià(
	`cÝy_äom_u£r
(&
lšk_šfo
,

1110 (
hfi1_lšk_šfo
 
__u£r
 *)
¬g
,

1111 (
lšk_šfo
)))

1112  -
EFAULT
;

1114 
v®ue
 = 
lšk_šfo
.
pÜt_¡©e
;

1115 
šdex
 = 
lšk_šfo
.
pÜt_numb”
;

1116 ià(
šdex
 > 
dd
->
num_µÜts
 - 1)

1117  -
EINVAL
;

1119 
µd
 = &
dd
->
µÜt
[
šdex
];

1120 ià(!
µd
)

1121  -
EINVAL
;

1124 
phys_¡©e
 = (
v®ue
 >> 4) & 0xF;

1125 
lšk_¡©e
 = 
v®ue
 & 0xF;

1126 
	`¢oÝ_dbg
("S‘tšg†šk s‹ 0x%x", 
v®ue
);

1128 
lšk_¡©e
) {

1129 
IB_PORT_NOP
:

1130 ià(
phys_¡©e
 == 0)

1133 
IB_PORT_DOWN
:

1134 
phys_¡©e
) {

1136 
dev_¡©e
 = 
HLS_DN_DOWNDEF
;

1139 
dev_¡©e
 = 
HLS_DN_POLL
;

1142 
dev_¡©e
 = 
HLS_DN_DISABLE
;

1145  -
EINVAL
;

1147 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
dev_¡©e
);

1149 
IB_PORT_ARMED
:

1150 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ARMED
);

1151 ià(!
»t
)

1152 
	`£nd_idË_sma
(
dd
, 
SMA_IDLE_ARM
);

1154 
IB_PORT_ACTIVE
:

1155 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ACTIVE
);

1156 ià(!
»t
)

1157 
	`£nd_idË_sma
(
dd
, 
SMA_IDLE_ACTIVE
);

1160  -
EINVAL
;

1163 ià(
»t
)

1166 
HFI1_SNOOP_IOCGETLINKSTATE
:

1167 
HFI1_SNOOP_IOCGETLINKSTATE_EXTRA
:

1168 ià(
cmd
 =ð
HFI1_SNOOP_IOCGETLINKSTATE_EXTRA
) {

1169 
	`mem£t
(&
lšk_šfo
, 0, (link_info));

1170 ià(
	`cÝy_äom_u£r
(&
lšk_šfo
,

1171 (
hfi1_lšk_šfo
 
__u£r
 *)
¬g
,

1172 (
lšk_šfo
)))

1173  -
EFAULT
;

1174 
šdex
 = 
lšk_šfo
.
pÜt_numb”
;

1176 
»t
 = 
	`__g‘_u£r
(
šdex
, (
__u£r
 *)
¬g
);

1177 ià(
»t
 != 0)

1181 ià(
šdex
 > 
dd
->
num_µÜts
 - 1)

1182  -
EINVAL
;

1184 
µd
 = &
dd
->
µÜt
[
šdex
];

1185 ià(!
µd
)

1186  -
EINVAL
;

1188 
v®ue
 = 
	`driv”_p¡©e
(
µd
);

1189 
v®ue
 <<= 4;

1190 
v®ue
 |ð
	`driv”_l¡©e
(
µd
);

1192 
	`¢oÝ_dbg
("Lšk…Üˆ| Lšk S‹: %d", 
v®ue
);

1194 ià((
cmd
 =ð
HFI1_SNOOP_IOCGETLINKSTATE_EXTRA
) ||

1195 (
cmd
 =ð
HFI1_SNOOP_IOCSETLINKSTATE_EXTRA
)) {

1196 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

1198 
lšk_šfo
.
pÜt_¡©e
 = 
v®ue
;

1199 
lšk_šfo
.
node_guid
 = 
	`g‘_sguid
(
ibp
,

1200 
HFI1_PORT_GUID_INDEX
);

1201 
lšk_šfo
.
lšk_¥“d_aùive
 =

1202 
µd
->
lšk_¥“d_aùive
;

1203 
lšk_šfo
.
lšk_width_aùive
 =

1204 
µd
->
lšk_width_aùive
;

1205 ià(
	`cÝy_to_u£r
((
hfi1_lšk_šfo
 
__u£r
 *)
¬g
,

1206 &
lšk_šfo
, (link_info)))

1207  -
EFAULT
;

1209 
»t
 = 
	`__put_u£r
(
v®ue
, (
__u£r
 *)
¬g
);

1213 
HFI1_SNOOP_IOCCLEARQUEUE
:

1214 
	`¢oÝ_dbg
("Clearing snoop queue");

1215 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1216 
	`d¿š_¢oÝ_li¡
(&
dd
->
hfi1_¢oÝ
.
queue
);

1217 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1220 
HFI1_SNOOP_IOCCLEARFILTER
:

1221 
	`¢oÝ_dbg
("Clearing filter");

1222 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1223 ià(
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
) {

1225 
	`d¿š_¢oÝ_li¡
(&
dd
->
hfi1_¢oÝ
.
queue
);

1226 
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
 = 
NULL
;

1228 
	`kä“
(
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

1229 
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
 = 
NULL
;

1230 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1233 
HFI1_SNOOP_IOCSETFILTER
:

1234 
	`¢oÝ_dbg
("Setting filter");

1236 
¬gp
 = (*)
¬g
;

1237 ià(
	`cÝy_äom_u£r
(&
fž‹r_cmd
, (
__u£r
 *)
¬gp
,

1238 (
fž‹r_cmd
)))

1239  -
EFAULT
;

1241 ià(
fž‹r_cmd
.
Ýcode
 >ð
HFI1_MAX_FILTERS
) {

1242 
	`´_®”t
("Invalid opcode in„equest\n");

1243  -
EINVAL
;

1246 
	`¢oÝ_dbg
("Opcode %d Len %d Ptr %p",

1247 
fž‹r_cmd
.
Ýcode
, fž‹r_cmd.
Ëngth
,

1248 
fž‹r_cmd
.
v®ue_±r
);

1250 
fž‹r_v®ue
 = 
	`kÿÎoc
(
fž‹r_cmd
.
Ëngth
, (
u8
),

1251 
GFP_KERNEL
);

1252 ià(!
fž‹r_v®ue
)

1253  -
ENOMEM
;

1256 ià(
	`cÝy_äom_u£r
((
u8
 *)
fž‹r_v®ue
,

1257 (
__u£r
 *)
fž‹r_cmd
.
v®ue_±r
,

1258 
fž‹r_cmd
.
Ëngth
)) {

1259 
	`kä“
(
fž‹r_v®ue
);

1260  -
EFAULT
;

1263 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1264 
	`d¿š_¢oÝ_li¡
(&
dd
->
hfi1_¢oÝ
.
queue
);

1265 
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
 =

1266 
hfi1_fž‹rs
[
fž‹r_cmd
.
Ýcode
].
fž‹r
;

1268 
	`kä“
(
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

1269 
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
 = filter_value;

1270 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1272 
HFI1_SNOOP_IOCGETVERSION
:

1273 
v®ue
 = 
SNOOP_CAPTURE_VERSION
;

1274 
	`¢oÝ_dbg
("G‘tšg v”siÚ: %d", 
v®ue
);

1275 
»t
 = 
	`__put_u£r
(
v®ue
, (
__u£r
 *)
¬g
);

1277 
HFI1_SNOOP_IOCSET_OPTS
:

1278 
¢oÝ_æags
 = 0;

1279 
»t
 = 
	`__g‘_u£r
(
v®ue
, (
__u£r
 *)
¬g
);

1280 ià(
»t
 != 0)

1283 
	`¢oÝ_dbg
("S‘tšg snoÝ o±iÚ %d", 
v®ue
);

1284 ià(
v®ue
 & 
SNOOP_DROP_SEND
)

1285 
¢oÝ_æags
 |ð
SNOOP_DROP_SEND
;

1286 ià(
v®ue
 & 
SNOOP_USE_METADATA
)

1287 
¢oÝ_æags
 |ð
SNOOP_USE_METADATA
;

1288 ià(
v®ue
 & (
SNOOP_SET_VL0TOVL15
)) {

1289 
i
;

1291 
µd
 = &
dd
->
µÜt
[0];

1292 
»t
 = 
	`hfi1_assign_¢oÝ_lšk_üed™s
(
µd
, 
v®ue
);

1293 ià(
»t
) {

1294 
	`dd_dev_”r
(
dd
, "set_link_credits failed %ld\n",

1295 
»t
);

1301 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++)

1302 ià(!
dd
->
vld
[
i
].
mtu
)

1303 
dd
->
vld
[
i
].
mtu
 = dd->vld[15].mtu;

1304 
»t
 = 
	`£t_mtu
(
µd
);

1305 ià(
»t
)

1306 
	`dd_dev_”r
(
dd
, "£t_mtu fažed %ld\n", 
»t
);

1310  -
ENOTTY
;

1313  
»t
;

1314 
	}
}

1316 
	$¢oÝ_li¡_add_ž
(
¢oÝ_·ck‘
 *
·ck‘
,

1317 
hfi1_devd©a
 *
dd
)

1319 
æags
 = 0;

1321 
	`¥š_lock_œq§ve
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1322 ià(
	`lik–y
((
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
) ||

1323 (
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_CAPTURE_MODE
))) {

1324 
	`li¡_add_ž
(&
·ck‘
->
li¡
, &
dd
->
hfi1_¢oÝ
.
queue
);

1325 
	`¢oÝ_dbg
("Added…acketo†ist");

1334 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
hfi1_¢oÝ
.
¢oÝ_lock
, 
æags
);

1335 
	`wake_up_š‹¼u±ibË
(&
dd
->
hfi1_¢oÝ
.
wa™q
);

1336 
	}
}

1338 
šlše
 
	$hfi1_fž‹r_check
(*
v®
, cÚ¡ *
msg
)

1340 ià(!
v®
) {

1341 
	`¢oÝ_dbg
("E¼Ü inv®id % v®ufÜ fž‹r", 
msg
);

1342  
HFI1_FILTER_ERR
;

1345 
	}
}

1347 
	$hfi1_fž‹r_lid
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
)

1349 
ib_h—d”
 *
hdr
;

1350 
»t
;

1352 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1353 ià(
»t
)

1354  
»t
;

1355 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1356 ià(
»t
)

1357  
»t
;

1358 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1360 ià(*((
u16
 *)
v®ue
è=ð
	`be16_to_ýu
(
hdr
->
Ìh
[3]))

1361  
HFI1_FILTER_HIT
;

1363  
HFI1_FILTER_MISS
;

1364 
	}
}

1366 
	$hfi1_fž‹r_dlid
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
)

1368 
ib_h—d”
 *
hdr
;

1369 
»t
;

1371 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1372 ià(
»t
)

1373  
»t
;

1374 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1375 ià(
»t
)

1376  
»t
;

1378 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1380 ià(*((
u16
 *)
v®ue
è=ð
	`be16_to_ýu
(
hdr
->
Ìh
[1]))

1381  
HFI1_FILTER_HIT
;

1383  
HFI1_FILTER_MISS
;

1384 
	}
}

1387 
	$hfi1_fž‹r_mad_mgmt_þass
(*
ibhdr
, *
·ck‘_d©a
,

1388 *
v®ue
)

1390 
ib_h—d”
 *
hdr
;

1391 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

1392 
ib_smp
 *
smp
 = 
NULL
;

1393 
u32
 
q²
 = 0;

1394 
»t
;

1396 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1397 ià(
»t
)

1398  
»t
;

1399 
»t
 = 
	`hfi1_fž‹r_check
(
·ck‘_d©a
, "packet_data");

1400 ià(
»t
)

1401  
»t
;

1402 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1403 ià(
»t
)

1404  
»t
;

1406 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1409 ià((
	`be16_to_ýu
(
hdr
->
Ìh
[0]è& 3è=ð
HFI1_LRH_BTH
)

1410 
ohdr
 = &
hdr
->
u
.
Ùh
;

1412 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1414 
q²
 = 
	`be32_to_ýu
(
ohdr
->
bth
[1]) & 0x00FFFFFF;

1415 ià(
q²
 <= 1) {

1416 
smp
 = (
ib_smp
 *)
·ck‘_d©a
;

1417 ià(*((
u8
 *)
v®ue
è=ð
smp
->
mgmt_þass
)

1418  
HFI1_FILTER_HIT
;

1420  
HFI1_FILTER_MISS
;

1422  
HFI1_FILTER_ERR
;

1423 
	}
}

1425 
	$hfi1_fž‹r_qp_numb”
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
)

1427 
ib_h—d”
 *
hdr
;

1428 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

1429 
»t
;

1431 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1432 ià(
»t
)

1433  
»t
;

1434 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1435 ià(
»t
)

1436  
»t
;

1438 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1441 ià((
	`be16_to_ýu
(
hdr
->
Ìh
[0]è& 3è=ð
HFI1_LRH_BTH
)

1442 
ohdr
 = &
hdr
->
u
.
Ùh
;

1444 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1445 ià(*((
u32
 *)
v®ue
è=ð(
	`be32_to_ýu
(
ohdr
->
bth
[1]) & 0x00FFFFFF))

1446  
HFI1_FILTER_HIT
;

1448  
HFI1_FILTER_MISS
;

1449 
	}
}

1451 
	$hfi1_fž‹r_ib·ck‘_ty³
(*
ibhdr
, *
·ck‘_d©a
,

1452 *
v®ue
)

1454 
u32
 
Êh
 = 0;

1455 
u8
 
Ýcode
 = 0;

1456 
ib_h—d”
 *
hdr
;

1457 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

1458 
»t
;

1460 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1461 ià(
»t
)

1462  
»t
;

1463 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1464 ià(
»t
)

1465  
»t
;

1467 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1469 
Êh
 = (
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3);

1471 ià(
Êh
 =ð
HFI1_LRH_BTH
)

1472 
ohdr
 = &
hdr
->
u
.
Ùh
;

1473 ià(
Êh
 =ð
HFI1_LRH_GRH
)

1474 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1476  
HFI1_FILTER_ERR
;

1478 
Ýcode
 = 
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24;

1480 ià(*((
u8
 *)
v®ue
è=ð((
Ýcode
 >> 5) & 0x7))

1481  
HFI1_FILTER_HIT
;

1483  
HFI1_FILTER_MISS
;

1484 
	}
}

1486 
	$hfi1_fž‹r_ib_£rviû_Ëv–
(*
ibhdr
, *
·ck‘_d©a
,

1487 *
v®ue
)

1489 
ib_h—d”
 *
hdr
;

1490 
»t
;

1492 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1493 ià(
»t
)

1494  
»t
;

1495 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1496 ià(
»t
)

1497  
»t
;

1499 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1501 ià((*((
u8
 *)
v®ue
)è=ð((
	`be16_to_ýu
(
hdr
->
Ìh
[0]) >> 4) & 0xF))

1502  
HFI1_FILTER_HIT
;

1504  
HFI1_FILTER_MISS
;

1505 
	}
}

1507 
	$hfi1_fž‹r_ib_pkey
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
)

1509 
u32
 
Êh
 = 0;

1510 
ib_h—d”
 *
hdr
;

1511 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

1512 
»t
;

1514 
»t
 = 
	`hfi1_fž‹r_check
(
ibhdr
, "header");

1515 ià(
»t
)

1516  
»t
;

1517 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1518 ià(
»t
)

1519  
»t
;

1521 
hdr
 = (
ib_h—d”
 *)
ibhdr
;

1523 
Êh
 = (
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3);

1524 ià(
Êh
 =ð
HFI1_LRH_BTH
)

1525 
ohdr
 = &
hdr
->
u
.
Ùh
;

1526 ià(
Êh
 =ð
HFI1_LRH_GRH
)

1527 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1529  
HFI1_FILTER_ERR
;

1539 ià((*(
u16
 *)
v®ue
 & 0x7FFF) ==

1540 ((
	`be32_to_ýu
(
ohdr
->
bth
[0])) & 0x7FFF))

1541  
HFI1_FILTER_HIT
;

1543  
HFI1_FILTER_MISS
;

1544 
	}
}

1550 
	$hfi1_fž‹r_dœeùiÚ
(*
ibhdr
, *
·ck‘_d©a
, *
v®ue
)

1552 
u8
 
u£r_dœ
 = *(u8 *)
v®ue
;

1553 
»t
;

1555 
»t
 = 
	`hfi1_fž‹r_check
(
v®ue
, "user");

1556 ià(
»t
)

1557  
»t
;

1559 ià(
·ck‘_d©a
) {

1561 ià(
u£r_dœ
 & 
HFI1_SNOOP_INGRESS
)

1562  
HFI1_FILTER_HIT
;

1565 ià(
u£r_dœ
 & 
HFI1_SNOOP_EGRESS
)

1566  
HFI1_FILTER_HIT
;

1569  
HFI1_FILTER_MISS
;

1570 
	}
}

1576 
¢oÝ_·ck‘
 *
	$®loÿ‹_¢oÝ_·ck‘
(
u32
 
hdr_Ën
,

1577 
u32
 
d©a_Ën
,

1578 
u32
 
md_Ën
)

1580 
¢oÝ_·ck‘
 *
·ck‘
;

1582 
·ck‘
 = 
	`kz®loc
((*·ck‘è+ 
hdr_Ën
 + 
d©a_Ën


1583 + 
md_Ën
,

1584 
GFP_ATOMIC
 | 
__GFP_NOWARN
);

1585 ià(
	`lik–y
(
·ck‘
))

1586 
	`INIT_LIST_HEAD
(&
·ck‘
->
li¡
);

1588  
·ck‘
;

1589 
	}
}

1591 
šlše
 *
	$hfi1_g‘_·ck‘_h—d”
(
hfi1_ùxtd©a
 *
rcd
,

1592 
__Ë32
 *
rhf_addr
)

1594 
u32
 
off£t
 = 
	`rhf_hdrq_off£t
(
	`rhf_to_ýu
(
rhf_addr
));

1596  (*)(
rhf_addr
 - 
rcd
->
rhf_off£t
 + 
off£t
);

1597 
	}
}

1610 
	$¢oÝ_»cv_hªdËr
(
hfi1_·ck‘
 *
·ck‘
)

1612 
hfi1_µÜtd©a
 *
µd
 = 
·ck‘
->
rcd
->ppd;

1613 
ib_h—d”
 *
hdr
 = 
	`hfi1_g‘_·ck‘_h—d”
(
·ck‘
->
rcd
,

1614 
·ck‘
->
rhf_addr
);

1615 
h—d”_size
 = (
u8
 *)
·ck‘
->
rhf_addr
 - (u8 *)
hdr
;

1616 *
d©a
 = 
·ck‘
->
ebuf
;

1617 
u32
 
Ž’
 = 
·ck‘
->tlen;

1618 
¢oÝ_·ck‘
 *
s_·ck‘
 = 
NULL
;

1619 
»t
;

1620 
¢oÝ_mode
 = 0;

1621 
u32
 
md_Ën
 = 0;

1622 
ÿ±u»_md
 
md
;

1624 
	`¢oÝ_dbg
("PACKET IN: hd¸siz%dËÀ%d d©¨%p", 
h—d”_size
, 
Ž’
,

1625 
d©a
);

1627 
	`Œaû_¢oÝ_ÿ±u»
(
µd
->
dd
, 
h—d”_size
, 
hdr
, 
Ž’
 - header_size,

1628 
d©a
);

1630 ià(!
µd
->
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
) {

1631 
	`¢oÝ_dbg
("filter‚ot set");

1632 
»t
 = 
HFI1_FILTER_HIT
;

1634 
»t
 = 
µd
->
dd
->
hfi1_¢oÝ
.
	`fž‹r_ÿÎback
(
hdr
, 
d©a
,

1635 
µd
->
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

1638 
»t
) {

1639 
HFI1_FILTER_ERR
:

1640 
	`¢oÝ_dbg
("Error in filter call");

1642 
HFI1_FILTER_MISS
:

1643 
	`¢oÝ_dbg
("Filter Miss");

1645 
HFI1_FILTER_HIT
:

1647 ià(
µd
->
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
)

1648 
¢oÝ_mode
 = 1;

1649 ià((
¢oÝ_mode
 == 0) ||

1650 
	`uÆik–y
(
¢oÝ_æags
 & 
SNOOP_USE_METADATA
))

1651 
md_Ën
 = (
ÿ±u»_md
);

1653 
s_·ck‘
 = 
	`®loÿ‹_¢oÝ_·ck‘
(
h—d”_size
,

1654 
Ž’
 - 
h—d”_size
,

1655 
md_Ën
);

1657 ià(
	`uÆik–y
(!
s_·ck‘
)) {

1658 
	`dd_dev_w¬n_¿‹lim™ed
(
µd
->
dd
, "Unableo‡llocate snoop/capture…acket\n");

1662 ià(
md_Ën
 > 0) {

1663 
	`mem£t
(&
md
, 0, (
ÿ±u»_md
));

1664 
md
.
pÜt
 = 1;

1665 
md
.
dœ
 = 
PKT_DIR_INGRESS
;

1666 
md
.
u
.
rhf
 = 
·ck‘
->rhf;

1667 
	`memýy
(
s_·ck‘
->
d©a
, &
md
, 
md_Ën
);

1671 ià(
hdr
) {

1672 
	`memýy
(
s_·ck‘
->
d©a
 + 
md_Ën
, 
hdr
, 
h—d”_size
);

1674 
	`dd_dev_”r
(
µd
->
dd
, "Unableo copy headero snoop/capture…acket\n");

1675 
	`kä“
(
s_·ck‘
);

1686 ià(
d©a
)

1687 
	`memýy
(
s_·ck‘
->
d©a
 + 
h—d”_size
 + 
md_Ën
, data,

1688 
Ž’
 - 
h—d”_size
);

1690 
s_·ck‘
->
tÙ®_Ën
 = 
Ž’
 + 
md_Ën
;

1691 
	`¢oÝ_li¡_add_ž
(
s_·ck‘
, 
µd
->
dd
);

1697 
	`¢oÝ_dbg
("Capturing…acket");

1698 ià(
µd
->
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
) {

1699 
	`¢oÝ_dbg
("Throwing…acket‡way");

1706 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
)))

1707 
	`hªdË_eæags
(
·ck‘
);

1721 
·ck‘
->
rcd
->
§ve_rhf_rcv_funùiÚ_m­
[
	`rhf_rcv_ty³
Õack‘->
rhf
)](packet);

1722 
	}
}

1724 
	$¢oÝ_´oûss_»ûive_šv®id
(
hfi1_·ck‘
 *
·ck‘
)

1726 
	`´_®”t
("Recv Invalid Snoop Packet!\n");

1727 
	}
}

1732 
	$¢oÝ_£nd_dma_hªdËr
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

1733 
u64
 
pbc
)

1735 
	`´_®”t
("Snooping/Capture of Send DMA Packets Is Not Supported!\n");

1736 
	`¢oÝ_dbg
("Unsupported Operation");

1737  
	`hfi1_v”bs_£nd_dma
(
qp
, 
ps
, 0);

1738 
	}
}

1745 
	$¢oÝ_£nd_pio_hªdËr
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

1746 
u64
 
pbc
)

1748 
u32
 
hdrwÜds
 = 
ps
->
s_tx»q
->
hdr_dwÜds
;

1749 
u32
 
Ën
 = 
ps
->
s_tx»q
->
s_cur_size
;

1750 
u32
 
dwÜds
;

1751 
u32
 
¶’
;

1752 
hfi1_µÜtd©a
 *
µd
 = 
ps
->ppd;

1753 
¢oÝ_·ck‘
 *
s_·ck‘
;

1754 
»t
;

1755 
¢oÝ_mode
 = 0;

1756 
md_Ën
 = 0;

1757 
u32
 
hdr_Ën
 = 
hdrwÜds
 << 2;

1758 
u16
 
Ž’
;

1760 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
) {

1761 
u8
 
·d_size
 = 
	`hfi1_g‘_16b_·ddšg
((
hdrwÜds
 << 2), 
Ën
);

1762 
u8
 
exŒa_by‹s
 = 
·d_size
 + (
SIZE_OF_CRC
 << 2è+ 
SIZE_OF_LT
;

1764 
dwÜds
 = (
Ën
 + 
exŒa_by‹s
) >> 2;

1766 
Ž’
 = 
	`hfi1_16B_g‘_Ën
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
) << 3;

1768 
dwÜds
 = (
Ën
 + 3) >> 2;

1769 
Ž’
 = 
	`ib_g‘_Ën
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
) << 2;

1771 
¶’
 = 
hdrwÜds
 + 
dwÜds
 + (
pbc
) / 4;

1773 
	`¢oÝ_dbg
("PACKET OUT: hdrword %u†en %u…len %u dwords %ulen %u",

1774 
hdrwÜds
, 
Ën
, 
¶’
, 
dwÜds
, 
Ž’
);

1775 ià(
µd
->
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
)

1776 
¢oÝ_mode
 = 1;

1777 ià((
¢oÝ_mode
 == 0) ||

1778 
	`uÆik–y
(
¢oÝ_æags
 & 
SNOOP_USE_METADATA
))

1779 
md_Ën
 = (
ÿ±u»_md
);

1782 
s_·ck‘
 = 
	`®loÿ‹_¢oÝ_·ck‘
(
hdr_Ën
, 
Ž’
 - hdr_Ën, 
md_Ën
);

1784 ià(
	`uÆik–y
(!
s_·ck‘
)) {

1785 
	`dd_dev_w¬n_¿‹lim™ed
(
µd
->
dd
, "Unableo‡llocate snoop/capture…acket\n");

1786 
out
;

1789 
s_·ck‘
->
tÙ®_Ën
 = 
Ž’
 + 
md_Ën
;

1791 ià(
md_Ën
 > 0) {

1792 
ÿ±u»_md
 
md
 = { .
pÜt
 = 1, .
dœ
 = 
PKT_DIR_EGRESS
 };

1794 ià(
	`lik–y
(
pbc
 == 0)) {

1795 
u8
 
sc5
 = ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_sc
;

1796 
u8
 
vl
 = 
	`sc_to_vÉ
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
), 
sc5
);

1799 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
)

1800 
pbc
 |ð
PBC_PACKET_BYPASS
 |

1801 
PBC_INSERT_BYPASS_ICRC
;

1803 
pbc
 |ð(
	`ib_is_sc5
(
sc5
è<< 
PBC_DC_INFO_SHIFT
);

1805 
pbc
 = 
	`ü—‹_pbc
(
µd
,…bc, 
qp
->
¤©e_mbps
, 
vl
, 
¶’
);

1808 ià((
ps
->
Ýcode
 & 
IB_OPCODE_TID_RDMA
) ==

1809 
IB_OPCODE_TID_RDMA
) {

1810 
pbc
 &ð~
PBC_INSERT_HCRC_SMASK
;

1811 
pbc
 |ð(
u64
)
PBC_IHCRC_LKDETH
 <<

1812 
PBC_INSERT_HCRC_SHIFT
;

1815 
md
.
u
.
pbc
 =…bc;

1816 
	`memýy
(
s_·ck‘
->
d©a
, &
md
, 
md_Ën
);

1820 
	`memýy
(
s_·ck‘
->
d©a
 + 
md_Ën
, &
ps
->
s_tx»q
->
phdr
.
hdr
, 
hdr_Ën
);

1822 ià(
ps
->
s_tx»q
->
ss
) {

1823 
rvt_sge_¡©e
 
‹mp_ss
;

1824 *
d©a
;

1825 
u32
 
Ëngth
;

1827 
d©a
 = 
s_·ck‘
->d©¨+ 
hdr_Ën
 + 
md_Ën
;

1836 
‹mp_ss
 = *
ps
->
s_tx»q
->
ss
;

1837 
Ëngth
 = 
Ën
;

1839 
	`¢oÝ_dbg
("N“dØcÝy %d by‹s", 
Ëngth
);

1840 
Ëngth
) {

1841 *
addr
 = 
‹mp_ss
.
sge
.
vaddr
;

1842 
u32
 
¦’
 = 
‹mp_ss
.
sge
.
Ëngth
;

1844 
¦’
 = 
	`rvt_g‘_sge_Ëngth
(&
‹mp_ss
.
sge
, 
Ëngth
);

1845 
	`¢oÝ_dbg
("cÝy %dØ%p", 
¦’
, 
addr
);

1846 
	`memýy
(
d©a
, 
addr
, 
¦’
);

1847 
	`rvt_upd©e_sge
(&
‹mp_ss
, 
¦’
, 
çl£
);

1848 
Ëngth
 -ð
¦’
;

1849 
d©a
 +ð
¦’
;

1850 
	`¢oÝ_dbg
("d©¨i now %°by‹ Ëá %d", 
d©a
, 
Ëngth
);

1852 
	`¢oÝ_dbg
("Completed SGE copy");

1859 ià(!
µd
->
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
) {

1860 
	`¢oÝ_dbg
("filter‚ot set\n");

1861 
»t
 = 
HFI1_FILTER_HIT
;

1863 
»t
 = 
µd
->
dd
->
hfi1_¢oÝ
.
	`fž‹r_ÿÎback
(

1864 &
ps
->
s_tx»q
->
phdr
.
hdr
,

1865 
NULL
,

1866 
µd
->
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

1869 
»t
) {

1870 
HFI1_FILTER_ERR
:

1871 
	`¢oÝ_dbg
("Error in filter call");

1873 
HFI1_FILTER_MISS
:

1874 
	`¢oÝ_dbg
("Filter Miss");

1875 
	`kä“
(
s_·ck‘
);

1877 
HFI1_FILTER_HIT
:

1878 
	`¢oÝ_dbg
("Capturing…acket");

1879 
	`¢oÝ_li¡_add_ž
(
s_·ck‘
, 
µd
->
dd
);

1881 ià(
	`uÆik–y
((
¢oÝ_æags
 & 
SNOOP_DROP_SEND
) &&

1882 (
µd
->
dd
->
hfi1_¢oÝ
.
mode_æag
 &

1883 
HFI1_PORT_SNOOP_MODE
))) {

1884 
æags
;

1886 
	`¢oÝ_dbg
("Dropping…acket");

1887 ià(
qp
->
s_wqe
) {

1888 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

1889 
	`rvt_£nd_com¶‘e
(

1890 
qp
,

1891 
qp
->
s_wqe
,

1892 
IB_WC_SUCCESS
);

1893 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

1894 } ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
) {

1895 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

1896 
	`hfi1_rc_£nd_com¶‘e
(
qp
,

1897 &
ps
->
s_tx»q
->
phdr
.
hdr
);

1898 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

1905 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

1910 
	`kä“
(
s_·ck‘
);

1913 
out
:

1914  
	`hfi1_v”bs_£nd_pio
(
qp
, 
ps
, 
pbc
);

1915 
	}
}

1922 
	$¢oÝ_šlše_pio_£nd
(
hfi1_devd©a
 *
dd
, 
pio_buf
 *
pbuf
,

1923 
u64
 
pbc
, cÚ¡ *
äom
, 
size_t
 
couÁ
)

1925 
¢oÝ_mode
 = 0;

1926 
md_Ën
 = 0;

1927 
ÿ±u»_md
 
md
;

1928 
¢oÝ_·ck‘
 *
s_·ck‘
 = 
NULL
;

1934 
·ck‘_Ën
 = (
couÁ
 << 2) + 4;

1935 
»t
;

1937 
	`¢oÝ_dbg
("ACK OUT:†’ %d", 
·ck‘_Ën
);

1939 ià(!
dd
->
hfi1_¢oÝ
.
fž‹r_ÿÎback
) {

1940 
	`¢oÝ_dbg
("filter‚ot set");

1941 
»t
 = 
HFI1_FILTER_HIT
;

1943 
»t
 = 
dd
->
hfi1_¢oÝ
.
	`fž‹r_ÿÎback
(

1944 (
ib_h—d”
 *)
äom
,

1945 
NULL
,

1946 
dd
->
hfi1_¢oÝ
.
fž‹r_v®ue
);

1949 
»t
) {

1950 
HFI1_FILTER_ERR
:

1951 
	`¢oÝ_dbg
("Error in filter call");

1953 
HFI1_FILTER_MISS
:

1954 
	`¢oÝ_dbg
("Filter Miss");

1956 
HFI1_FILTER_HIT
:

1957 
	`¢oÝ_dbg
("Capturing…acket");

1958 ià(
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
)

1959 
¢oÝ_mode
 = 1;

1960 ià((
¢oÝ_mode
 == 0) ||

1961 
	`uÆik–y
(
¢oÝ_æags
 & 
SNOOP_USE_METADATA
))

1962 
md_Ën
 = (
ÿ±u»_md
);

1964 
s_·ck‘
 = 
	`®loÿ‹_¢oÝ_·ck‘
(
·ck‘_Ën
, 0, 
md_Ën
);

1966 ià(
	`uÆik–y
(!
s_·ck‘
)) {

1967 
	`dd_dev_w¬n_¿‹lim™ed
(
dd
, "Unableo‡llocate snoop/capture…acket\n");

1968 
šlše_pio_out
;

1971 
s_·ck‘
->
tÙ®_Ën
 = 
·ck‘_Ën
 + 
md_Ën
;

1974 ià(
md_Ën
 > 0) {

1975 
	`mem£t
(&
md
, 0, (
ÿ±u»_md
));

1976 
md
.
pÜt
 = 1;

1977 
md
.
dœ
 = 
PKT_DIR_EGRESS
;

1978 
md
.
u
.
pbc
 =…bc;

1979 
	`memýy
(
s_·ck‘
->
d©a
, &
md
, 
md_Ën
);

1983 
	`memýy
(
s_·ck‘
->
d©a
 + 
md_Ën
, 
äom
, 
·ck‘_Ën
);

1985 
	`¢oÝ_li¡_add_ž
(
s_·ck‘
, 
dd
);

1987 ià(
	`uÆik–y
((
¢oÝ_æags
 & 
SNOOP_DROP_SEND
è&& 
¢oÝ_mode
)) {

1988 
	`¢oÝ_dbg
("Dropping…acket");

1996 
šlše_pio_out
:

1997 
	`pio_cÝy
(
dd
, 
pbuf
, 
pbc
, 
äom
, 
couÁ
);

1998 
	}
}

2001 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
	g¢oÝ_rhf_rcv_funùiÚs
[] = {

2002 [
RHF_RCV_TYPE_EXPECTED
] = 
¢oÝ_»cv_hªdËr
,

2003 [
RHF_RCV_TYPE_EAGER
] = 
¢oÝ_»cv_hªdËr
,

2004 [
RHF_RCV_TYPE_IB
] = 
¢oÝ_»cv_hªdËr
,

2005 [
RHF_RCV_TYPE_ERROR
] = 
¢oÝ_»cv_hªdËr
,

2006 [
RHF_RCV_TYPE_BYPASS
] = 
¢oÝ_»cv_hªdËr
,

2007 [
RHF_RCV_TYPE_INVALID5
] = 
¢oÝ_´oûss_»ûive_šv®id
,

2008 [
RHF_RCV_TYPE_INVALID6
] = 
¢oÝ_´oûss_»ûive_šv®id
,

2009 [
RHF_RCV_TYPE_INVALID7
] = 
¢oÝ_´oûss_»ûive_šv®id
,

	@driver.c

48 
	~<lšux/¥šlock.h
>

49 
	~<lšux/pci.h
>

50 
	~<lšux/io.h
>

51 
	~<lšux/d–ay.h
>

52 
	~<lšux/Ãtdeviû.h
>

53 
	~<lšux/vm®loc.h
>

54 
	~<lšux/moduË.h
>

55 
	~<lšux/´eãtch.h
>

56 
	~<rdma/ib_v”bs.h
>

57 
	~<lšux/‘h”deviû.h
>

59 
	~"hfi.h
"

60 
	~"Œaû.h
"

61 
	~"qp.h
"

62 
	~"sdma.h
"

63 
	~"debugfs.h
"

64 
	~"vnic.h
"

65 
	~"çuÉ.h
"

67 
	~"oib.h
"

68 
	~"Ãtdev.h
"

70 #undeà
´_fmt


71 
	#´_fmt
(
fmt
è
DRIVER_NAME
 ": " 
	)
fmt

77 cÚ¡ 
	gib_hfi1_v”siÚ
[] = 
HFI1_DRIVER_VERSION
 "\n";

79 
DEFINE_SPINLOCK
(
hfi1_devs_lock
);

80 
LIST_HEAD
(
hfi1_dev_li¡
);

81 
DEFINE_MUTEX
(
hfi1_mu‹x
);

83 
	ghfi1_max_mtu
 = 
HFI1_DEFAULT_MAX_MTU
;

84 
moduË_·¿m_Çmed
(
max_mtu
, 
hfi1_max_mtu
, 
ušt
, 
S_IRUGO
);

85 
MODULE_PARM_DESC
(
max_mtu
, "S‘ max MTU by‹s, deçuÉ i " 
__¡ršgify
(

86 
HFI1_DEFAULT_MAX_MTU
));

87 
EXPORT_SYMBOL
(
hfi1_max_mtu
);

89 
	ghfi1_cu
 = 1;

90 
moduË_·¿m_Çmed
(
cu
, 
hfi1_cu
, 
ušt
, 
S_IRUGO
);

91 
MODULE_PARM_DESC
(
cu
, "Credit„eturn units");

93 
	ghfi1_ÿp_mask
 = 
HFI1_CAP_MASK_DEFAULT
;

94 
hfi1_ÿps_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

95 
hfi1_ÿps_g‘
(*
bufãr
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

96 cÚ¡ 
k”Ãl_·¿m_Ýs
 
	gÿp_Ýs
 = {

97 .
£t
 = 
hfi1_ÿps_£t
,

98 .
	gg‘
 = 
hfi1_ÿps_g‘


100 
moduË_·¿m_cb
(
ÿp_mask
, &
ÿp_Ýs
, &
hfi1_ÿp_mask
, 
S_IWUSR
 | 
S_IRUGO
);

101 
MODULE_PARM_DESC
(
ÿp_mask
, "Bit mask ofƒnabled/disabled HW features");

103 
MODULE_LICENSE
("Dual BSD/GPL");

104 
MODULE_DESCRIPTION
("Intel Omni-Path Architecture driver");

105 
MODULE_VERSION
(
HFI1_DRIVER_VERSION
);

110 
	#MAX_PKT_RECV
 64

	)

115 
	#MAX_PKT_RECV_THREAD
 (
MAX_PKT_RECV
 * 4)

	)

116 
	#EGR_HEAD_UPDATE_THRESHOLD
 16

	)

118 
hfi1_ib_¡©s
 
	ghfi1_¡©s
;

120 
	$hfi1_ÿps_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

122 
»t
 = 0;

123 *
ÿp_mask_±r
 = (*)
kp
->
¬g
,

124 
ÿp_mask
 = *
ÿp_mask_±r
, 
v®ue
, 
diff
,

125 
wr™e_mask
 = ((
HFI1_CAP_WRITABLE_MASK
 << 
HFI1_CAP_USER_SHIFT
) |

126 
HFI1_CAP_WRITABLE_MASK
);

128 
»t
 = 
	`k¡¹oul
(
v®
, 0, &
v®ue
);

129 ià(
»t
) {

130 
	`´_w¬n
("Invalid module…arameter value for 'cap_mask'\n");

131 
dÚe
;

134 
diff
 = 
v®ue
 ^ (
ÿp_mask
 & ~
HFI1_CAP_LOCKED_SMASK
);

137 ià(
	`HFI1_CAP_LOCKED
(è&& (
diff
 & ~
wr™e_mask
)) {

138 
	`´_w¬n
("Ignoring‚on-writable capability bits %#lx\n",

139 
diff
 & ~
wr™e_mask
);

140 
diff
 &ð
wr™e_mask
;

144 
diff
 &ð~
HFI1_CAP_RESERVED_MASK
;

146 
ÿp_mask
 &ð~
diff
;

148 
ÿp_mask
 |ð(
v®ue
 & 
diff
);

150 
diff
 = (
ÿp_mask
 & (
HFI1_CAP_MUST_HAVE_KERN
 << 
HFI1_CAP_USER_SHIFT
)) ^

151 ((
ÿp_mask
 & 
HFI1_CAP_MUST_HAVE_KERN
è<< 
HFI1_CAP_USER_SHIFT
);

152 
ÿp_mask
 &ð~
diff
;

154 *
ÿp_mask_±r
 = 
ÿp_mask
;

155 
dÚe
:

156  
»t
;

157 
	}
}

159 
	$hfi1_ÿps_g‘
(*
bufãr
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

161 
ÿp_mask
 = *(*)
kp
->
¬g
;

163 
ÿp_mask
 &ð~
HFI1_CAP_LOCKED_SMASK
;

164 
ÿp_mask
 |ð((ÿp_mask & 
HFI1_CAP_K2U
è<< 
HFI1_CAP_USER_SHIFT
);

166  
	`sú´štf
(
bufãr
, 
PAGE_SIZE
, "0x%lx", 
ÿp_mask
);

167 
	}
}

169 
pci_dev
 *
	$g‘_pci_dev
(
rvt_dev_šfo
 *
rdi
)

171 
hfi1_ibdev
 *
ibdev
 = 
	`cÚš”_of
(
rdi
, hfi1_ibdev,„di);

172 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
ibdev
,

173 
hfi1_devd©a
, 
v”bs_dev
);

174  
dd
->
pcidev
;

175 
	}
}

180 
	$hfi1_couÁ_aùive_un™s
()

182 
hfi1_devd©a
 *
dd
;

183 
hfi1_µÜtd©a
 *
µd
;

184 
æags
;

185 
pidx
, 
nun™s_aùive
 = 0;

187 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

188 
	`li¡_fÜ_—ch_’Œy
(
dd
, &
hfi1_dev_li¡
, 
li¡
) {

189 ià(!(
dd
->
æags
 & 
HFI1_PRESENT
è|| !dd->
k»gba£1
)

191 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

192 
µd
 = 
dd
->
µÜt
 + 
pidx
;

193 ià(
µd
->
lid
 &&…pd->
lškup
) {

194 
nun™s_aùive
++;

199 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

200  
nun™s_aùive
;

201 
	}
}

207 
šlše
 *
	$g‘_egrbuf
(cÚ¡ 
hfi1_ùxtd©a
 *
rcd
, 
u64
 
rhf
,

208 
u8
 *
upd©e
)

210 
u32
 
idx
 = 
	`rhf_egr_šdex
(
rhf
), 
off£t
 = 
	`rhf_egr_buf_off£t
(rhf);

212 *
upd©e
 |ð!(
idx
 & (
rcd
->
egrbufs
.
th»shÞd
 - 1)è&& !
off£t
;

213  (*)(((
u64
)(
rcd
->
egrbufs
.
rcvtids
[
idx
].
addr
)) +

214 (
off£t
 * 
RCV_BUF_BLOCK_SIZE
));

215 
	}
}

217 
šlše
 *
	$hfi1_g‘_h—d”
(
hfi1_ùxtd©a
 *
rcd
,

218 
__Ë32
 *
rhf_addr
)

220 
u32
 
off£t
 = 
	`rhf_hdrq_off£t
(
	`rhf_to_ýu
(
rhf_addr
));

222  (*)(
rhf_addr
 - 
rcd
->
rhf_off£t
 + 
off£t
);

223 
	}
}

225 
šlše
 
ib_h—d”
 *
	$hfi1_g‘_msgh—d”
(
hfi1_ùxtd©a
 *
rcd
,

226 
__Ë32
 *
rhf_addr
)

228  (
ib_h—d”
 *)
	`hfi1_g‘_h—d”
(
rcd
, 
rhf_addr
);

229 
	}
}

231 
šlše
 
hfi1_16b_h—d”


232 *
	$hfi1_g‘_16B_h—d”
(
hfi1_ùxtd©a
 *
rcd
,

233 
__Ë32
 *
rhf_addr
)

235  (
hfi1_16b_h—d”
 *)
	`hfi1_g‘_h—d”
(
rcd
, 
rhf_addr
);

236 
	}
}

244 
	$hfi1_rcvbuf_v®id©e
(
u32
 
size
, 
u8
 
ty³
, 
u16
 *
’coded
)

246 ià(
	`uÆik–y
(!
	`PAGE_ALIGNED
(
size
)))

248 ià(
	`uÆik–y
(
size
 < 
MIN_EAGER_BUFFER
))

250 ià(
size
 >

251 (
ty³
 =ð
PT_EAGER
 ? 
MAX_EAGER_BUFFER
 : 
MAX_EXPECTED_BUFFER
))

253 ià(
’coded
)

254 *
’coded
 = 
	`žog2
(
size
 / 
PAGE_SIZE
) + 1;

256 
	}
}

258 
	$rcv_hd»¼
(
hfi1_ùxtd©a
 *
rcd
, 
hfi1_µÜtd©a
 *
µd
,

259 
hfi1_·ck‘
 *
·ck‘
)

261 
ib_h—d”
 *
rhdr
 = 
·ck‘
->
hdr
;

262 
u32
 
¹e
 = 
	`rhf_rcv_ty³_”r
(
·ck‘
->
rhf
);

263 
u32
 
mlid_ba£
;

264 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

265 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

266 
hfi1_ibdev
 *
v”bs_dev
 = &
dd
->verbs_dev;

267 
rvt_dev_šfo
 *
rdi
 = &
v”bs_dev
->rdi;

269 ià((
·ck‘
->
rhf
 & 
RHF_DC_ERR
) &&

270 
	`hfi1_dbg_çuÉ_suµ»ss_”r
(
v”bs_dev
))

273 ià(
·ck‘
->
rhf
 & 
RHF_ICRC_ERR
)

276 ià(
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

277 
drÝ
;

279 
u8
 
Êh
 = 
	`ib_g‘_Êh
(
rhdr
);

281 
mlid_ba£
 = 
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
);

282 ià(
Êh
 =ð
HFI1_LRH_BTH
) {

283 
·ck‘
->
ohdr
 = &
rhdr
->
u
.
Ùh
;

284 } ià(
Êh
 =ð
HFI1_LRH_GRH
) {

285 
·ck‘
->
ohdr
 = &
rhdr
->
u
.
l
.
Ùh
;

286 
·ck‘
->
grh
 = &
rhdr
->
u
.
l
.grh;

288 
drÝ
;

292 ià(
·ck‘
->
rhf
 & 
RHF_TID_ERR
) {

294 
u32
 
Ž’
 = 
	`rhf_pkt_Ën
(
·ck‘
->
rhf
);

295 
u32
 
dlid
 = 
	`ib_g‘_dlid
(
rhdr
);

296 
u32
 
qp_num
;

299 ià(
Ž’
 < 24)

300 
drÝ
;

303 ià(
·ck‘
->
grh
) {

304 
u32
 
vtf
;

305 
ib_grh
 *
grh
 = 
·ck‘
->grh;

307 ià(
grh
->
Ãxt_hdr
 !ð
IB_GRH_NEXT_HDR
)

308 
drÝ
;

309 
vtf
 = 
	`be32_to_ýu
(
grh
->
v”siÚ_tþass_æow
);

310 ià((
vtf
 >> 
IB_GRH_VERSION_SHIFT
è!ð
IB_GRH_VERSION
)

311 
drÝ
;

315 
qp_num
 = 
	`ib_bth_g‘_q²
(
·ck‘
->
ohdr
);

316 ià(
dlid
 < 
mlid_ba£
) {

317 
rvt_qp
 *
qp
;

318 
æags
;

320 
	`rcu_»ad_lock
();

321 
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
qp_num
);

322 ià(!
qp
) {

323 
	`rcu_»ad_uÆock
();

324 
drÝ
;

331 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
æags
);

334 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] &

335 
RVT_PROCESS_RECV_OK
)) {

336 
ibp
->
rvp
.
n_pkt_drÝs
++;

339 
qp
->
ibqp
.
qp_ty³
) {

340 
IB_QPT_RC
:

341 
	`hfi1_rc_hd»¼
(
rcd
, 
·ck‘
, 
qp
);

348 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
æags
);

349 
	`rcu_»ad_uÆock
();

354 
¹e
) {

355 
RHF_RTE_ERROR_OP_CODE_ERR
:

357 *
ebuf
 = 
NULL
;

358 
u8
 
Ýcode
;

360 ià(
	`rhf_u£_egr_bä
(
·ck‘
->
rhf
))

361 
ebuf
 = 
·ck‘
->ebuf;

363 ià(!
ebuf
)

364 
drÝ
;

366 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
·ck‘
->
ohdr
);

367 ià(
Ýcode
 =ð
IB_OPCODE_CNP
) {

372 
rvt_qp
 *
qp
 = 
NULL
;

373 
u32
 
lq²
, 
rq²
;

374 
u16
 
¾id
;

375 
u8
 
svc_ty³
, 
¦
, 
sc5
;

377 
sc5
 = 
	`hfi1_9B_g‘_sc5
(
rhdr
, 
·ck‘
->
rhf
);

378 
¦
 = 
ibp
->
sc_to_¦
[
sc5
];

380 
lq²
 = 
	`ib_bth_g‘_q²
(
·ck‘
->
ohdr
);

381 
	`rcu_»ad_lock
();

382 
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
lq²
);

383 ià(!
qp
) {

384 
	`rcu_»ad_uÆock
();

385 
drÝ
;

388 
qp
->
ibqp
.
qp_ty³
) {

389 
IB_QPT_UD
:

390 
¾id
 = 0;

391 
rq²
 = 0;

392 
svc_ty³
 = 
IB_CC_SVCTYPE_UD
;

394 
IB_QPT_UC
:

395 
¾id
 = 
	`ib_g‘_¦id
(
rhdr
);

396 
rq²
 = 
qp
->
»mÙe_q²
;

397 
svc_ty³
 = 
IB_CC_SVCTYPE_UC
;

400 
	`rcu_»ad_uÆock
();

401 
drÝ
;

404 
	`´oûss_beú
(
µd
, 
¦
, 
¾id
, 
lq²
, 
rq²
, 
svc_ty³
);

405 
	`rcu_»ad_uÆock
();

408 
·ck‘
->
rhf
 &ð~
RHF_RCV_TYPE_ERR_SMASK
;

415 
drÝ
:

417 
	}
}

419 
šlše
 
	$š™_·ck‘
(
hfi1_ùxtd©a
 *
rcd
,

420 
hfi1_·ck‘
 *
·ck‘
)

422 
·ck‘
->
rsize
 = 
	`g‘_hdrq’tsize
(
rcd
);

423 
·ck‘
->
maxút
 = 
	`g‘_hdrq_út
(
rcd
è*…ack‘->
rsize
;

424 
·ck‘
->
rcd
 =„cd;

425 
·ck‘
->
updegr
 = 0;

426 
·ck‘
->
‘až
 = -1;

427 
·ck‘
->
rhf_addr
 = 
	`g‘_rhf_addr
(
rcd
);

428 
·ck‘
->
rhf
 = 
	`rhf_to_ýu
Õack‘->
rhf_addr
);

429 
·ck‘
->
‘y³
 = 
	`rhf_rcv_ty³
Õack‘->
rhf
);

430 
·ck‘
->
rhqoff
 = 
	`hfi1_rcd_h—d
(
rcd
);

431 
·ck‘
->
numpkt
 = 0;

432 
	}
}

435 cÚ¡ 
hfi1_hªdË_úp
 
	ghfi1_hªdË_úp_tbl
[2] = {

436 [
HFI1_PKT_TYPE_9B
] = &
»tuº_úp
,

437 [
HFI1_PKT_TYPE_16B
] = &
»tuº_úp_16B


453 
boÞ
 
	$hfi1_´oûss_eú_¦ow·th
(
rvt_qp
 *
qp
, 
hfi1_·ck‘
 *
pkt
,

454 
boÞ
 
´esÿn
)

456 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

457 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

458 
ib_Ùh”_h—d”s
 *
ohdr
 = 
pkt
->ohdr;

459 
ib_grh
 *
grh
 = 
pkt
->grh;

460 
u32
 
rq²
 = 0;

461 
u16
 
pkey
;

462 
u32
 
¾id
, 
¦id
, 
dlid
 = 0;

463 
u8
 
hdr_ty³
, 
sc
, 
svc_ty³
, 
Ýcode
;

464 
boÞ
 
is_mÿ¡
 = 
çl£
, 
ignÜe_ãú
 = f®£, 
do_úp
 = false,

465 
ãú
, 
beú
;

468 ià(
pkt
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

469 
pkey
 = 
	`hfi1_16B_g‘_pkey
(
pkt
->
hdr
);

470 
sc
 = 
	`hfi1_16B_g‘_sc
(
pkt
->
hdr
);

471 
dlid
 = 
	`hfi1_16B_g‘_dlid
(
pkt
->
hdr
);

472 
¦id
 = 
	`hfi1_16B_g‘_¦id
(
pkt
->
hdr
);

473 
is_mÿ¡
 = 
	`hfi1_is_16B_mÿ¡
(
dlid
);

474 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

475 
hdr_ty³
 = 
HFI1_PKT_TYPE_16B
;

476 
ãú
 = 
	`hfi1_16B_g‘_ãú
(
pkt
->
hdr
);

477 
beú
 = 
	`hfi1_16B_g‘_beú
(
pkt
->
hdr
);

479 
pkey
 = 
	`ib_bth_g‘_pkey
(
ohdr
);

480 
sc
 = 
	`hfi1_9B_g‘_sc5
(
pkt
->
hdr
,…kt->
rhf
);

481 
dlid
 = 
qp
->
ibqp
.
qp_ty³
 !ð
IB_QPT_UD
 ? 
	`ib_g‘_dlid
(
pkt
->
hdr
) :

482 
µd
->
lid
;

483 
¦id
 = 
	`ib_g‘_¦id
(
pkt
->
hdr
);

484 
is_mÿ¡
 = (
dlid
 > 
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) &&

485 (
dlid
 !ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
));

486 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

487 
hdr_ty³
 = 
HFI1_PKT_TYPE_9B
;

488 
ãú
 = 
	`ib_bth_g‘_ãú
(
ohdr
);

489 
beú
 = 
	`ib_bth_g‘_beú
(
ohdr
);

492 
qp
->
ibqp
.
qp_ty³
) {

493 
IB_QPT_UD
:

494 
¾id
 = 
¦id
;

495 
rq²
 = 
	`ib_g‘_sq²
(
pkt
->
ohdr
);

496 
svc_ty³
 = 
IB_CC_SVCTYPE_UD
;

498 
IB_QPT_SMI
:

499 
IB_QPT_GSI
:

500 
¾id
 = 
¦id
;

501 
rq²
 = 
	`ib_g‘_sq²
(
pkt
->
ohdr
);

502 
svc_ty³
 = 
IB_CC_SVCTYPE_UD
;

504 
IB_QPT_UC
:

505 
¾id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
);

506 
rq²
 = 
qp
->
»mÙe_q²
;

507 
svc_ty³
 = 
IB_CC_SVCTYPE_UC
;

509 
IB_QPT_RC
:

510 
¾id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
);

511 
rq²
 = 
qp
->
»mÙe_q²
;

512 
svc_ty³
 = 
IB_CC_SVCTYPE_RC
;

515  
çl£
;

518 
ignÜe_ãú
 = 
is_mÿ¡
 || (
Ýcode
 =ð
IB_OPCODE_CNP
) ||

519 (
Ýcode
 =ð
IB_OPCODE_RC_ACKNOWLEDGE
);

524 
do_úp
 = 
´esÿn
 ||

525 (
Ýcode
 >ð
IB_OPCODE_RC_RDMA_READ_RESPONSE_FIRST
 &&

526 
Ýcode
 <ð
IB_OPCODE_RC_ATOMIC_ACKNOWLEDGE
) ||

527 
Ýcode
 =ð
	`TID_OP
(
READ_RESP
) ||

528 
Ýcode
 =ð
	`TID_OP
(
ACK
);

531 ià(!
ignÜe_ãú
 && 
do_úp
 && 
ãú
)

532 
hfi1_hªdË_úp_tbl
[
hdr_ty³
](
ibp
, 
qp
, 
rq²
, 
pkey
,

533 
dlid
, 
¾id
, 
sc
, 
grh
);

535 ià(
beú
) {

536 
u32
 
lq²
 = 
	`be32_to_ýu
(
ohdr
->
bth
[1]è& 
RVT_QPN_MASK
;

537 
u8
 
¦
 = 
ibp
->
sc_to_¦
[
sc
];

539 
	`´oûss_beú
(
µd
, 
¦
, 
¾id
, 
lq²
, 
rq²
, 
svc_ty³
);

541  !
ignÜe_ãú
 && 
ãú
;

542 
	}
}

544 
	sps_md©a
 {

545 
hfi1_ùxtd©a
 *
	mrcd
;

546 
u32
 
	mmaxút
;

547 
u32
 
	mps_h—d
;

548 
u32
 
	mps_ž
;

549 
u8
 
	mps_£q
;

550 
u8
 
	mrsize
;

553 
šlše
 
	$š™_ps_md©a
(
ps_md©a
 *
md©a
,

554 
hfi1_·ck‘
 *
·ck‘
)

556 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

558 
md©a
->
rcd
 =„cd;

559 
md©a
->
rsize
 = 
·ck‘
->rsize;

560 
md©a
->
maxút
 = 
·ck‘
->maxcnt;

561 
md©a
->
ps_h—d
 = 
·ck‘
->
rhqoff
;

563 ià(
	`g‘_dma_¹až_£‰šg
(
rcd
)) {

564 
md©a
->
ps_ž
 = 
	`g‘_rcvhd¹až
(
rcd
);

565 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
)

566 
md©a
->
ps_£q
 = 
	`hfi1_£q_út
(
rcd
);

568 
md©a
->
ps_£q
 = 0;

570 
md©a
->
ps_ž
 = 0;

571 
md©a
->
ps_£q
 = 
	`hfi1_£q_út
(
rcd
);

573 
	}
}

575 
šlše
 
	$ps_dÚe
(
ps_md©a
 *
md©a
, 
u64
 
rhf
,

576 
hfi1_ùxtd©a
 *
rcd
)

578 ià(
	`g‘_dma_¹až_£‰šg
(
rcd
))

579  
md©a
->
ps_h—d
 =ðmd©a->
ps_ž
;

580  
md©a
->
ps_£q
 !ð
	`rhf_rcv_£q
(
rhf
);

581 
	}
}

583 
šlše
 
	$ps_sk
(
ps_md©a
 *
md©a
, 
u64
 
rhf
,

584 
hfi1_ùxtd©a
 *
rcd
)

590 ià((
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
è&& (
md©a
->
ps_h—d
 !ðmd©a->
ps_ž
))

591  
md©a
->
ps_£q
 !ð
	`rhf_rcv_£q
(
rhf
);

594 
	}
}

596 
šlše
 
	$upd©e_ps_md©a
(
ps_md©a
 *
md©a
,

597 
hfi1_ùxtd©a
 *
rcd
)

599 
md©a
->
ps_h—d
 +ðmd©a->
rsize
;

600 ià(
md©a
->
ps_h—d
 >ðmd©a->
maxút
)

601 
md©a
->
ps_h—d
 = 0;

604 ià(!
	`g‘_dma_¹až_£‰šg
(
rcd
) ||

605 (
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
))

606 
md©a
->
ps_£q
 = 
	`hfi1_£q_šü_w¿p
(mdata->ps_seq);

607 
	}
}

617 
	#´esÿn_rxq
(
rcd
, 
·ck‘
) \

619 ià(
rcd
->
µd
->
cc_´esÿn
) \

620 
	`__´esÿn_rxq
(
·ck‘
); \

621 } 0)

	)

622 
	$__´esÿn_rxq
(
hfi1_·ck‘
 *
·ck‘
)

624 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

625 
ps_md©a
 
md©a
;

627 
	`š™_ps_md©a
(&
md©a
, 
·ck‘
);

630 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

631 
__Ë32
 *
rhf_addr
 = (__Ë32 *)
rcd
->
rcvhdrq
 + 
md©a
.
ps_h—d
 +

632 
·ck‘
->
rcd
->
rhf_off£t
;

633 
rvt_qp
 *
qp
;

634 
ib_h—d”
 *
hdr
;

635 
rvt_dev_šfo
 *
rdi
 = &
rcd
->
dd
->
v”bs_dev
.rdi;

636 
u64
 
rhf
 = 
	`rhf_to_ýu
(
rhf_addr
);

637 
u32
 
‘y³
 = 
	`rhf_rcv_ty³
(
rhf
), 
q²
, 
bth1
;

638 
u8
 
Êh
;

640 ià(
	`ps_dÚe
(&
md©a
, 
rhf
, 
rcd
))

643 ià(
	`ps_sk
(&
md©a
, 
rhf
, 
rcd
))

644 
Ãxt
;

646 ià(
‘y³
 !ð
RHF_RCV_TYPE_IB
)

647 
Ãxt
;

649 
·ck‘
->
hdr
 = 
	`hfi1_g‘_msgh—d”
Õack‘->
rcd
, 
rhf_addr
);

650 
hdr
 = 
·ck‘
->hdr;

651 
Êh
 = 
	`ib_g‘_Êh
(
hdr
);

653 ià(
Êh
 =ð
HFI1_LRH_BTH
) {

654 
·ck‘
->
ohdr
 = &
hdr
->
u
.
Ùh
;

655 
·ck‘
->
grh
 = 
NULL
;

656 } ià(
Êh
 =ð
HFI1_LRH_GRH
) {

657 
·ck‘
->
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

658 
·ck‘
->
grh
 = &
hdr
->
u
.
l
.grh;

660 
Ãxt
;

663 ià(!
	`hfi1_may_eú
(
·ck‘
))

664 
Ãxt
;

666 
bth1
 = 
	`be32_to_ýu
(
·ck‘
->
ohdr
->
bth
[1]);

667 
q²
 = 
bth1
 & 
RVT_QPN_MASK
;

668 
	`rcu_»ad_lock
();

669 
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
q²
);

671 ià(!
qp
) {

672 
	`rcu_»ad_uÆock
();

673 
Ãxt
;

676 
	`hfi1_´oûss_eú_¦ow·th
(
qp
, 
·ck‘
, 
Œue
);

677 
	`rcu_»ad_uÆock
();

680 
bth1
 &ð~(
IB_FECN_SMASK
 | 
IB_BECN_SMASK
);

681 
·ck‘
->
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
bth1
);

682 
Ãxt
:

683 
	`upd©e_ps_md©a
(&
md©a
, 
rcd
);

685 
	}
}

687 
	$´oûss_rcv_qp_wÜk
(
hfi1_·ck‘
 *
·ck‘
)

689 
rvt_qp
 *
qp
, *
nqp
;

690 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

696 
	`li¡_fÜ_—ch_’Œy_§ã
(
qp
, 
nqp
, &
rcd
->
qp_wa™_li¡
, 
r¥wa™
) {

697 
	`li¡_d–_š™
(&
qp
->
r¥wa™
);

698 ià(
qp
->
r_æags
 & 
RVT_R_RSP_NAK
) {

699 
qp
->
r_æags
 &ð~
RVT_R_RSP_NAK
;

700 
·ck‘
->
qp
 = qp;

701 
	`hfi1_£nd_rc_ack
(
·ck‘
, 0);

703 ià(
qp
->
r_æags
 & 
RVT_R_RSP_SEND
) {

704 
æags
;

706 
qp
->
r_æags
 &ð~
RVT_R_RSP_SEND
;

707 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

708 ià(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] &

709 
RVT_PROCESS_OR_FLUSH_SEND
)

710 
	`hfi1_scheduË_£nd
(
qp
);

711 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

713 
	`rvt_put_qp
(
qp
);

715 
	}
}

717 
nošlše
 
	$max_·ck‘_exûeded
(
hfi1_·ck‘
 *
·ck‘
, 
th»ad
)

719 ià(
th»ad
) {

720 ià((
·ck‘
->
numpkt
 & (
MAX_PKT_RECV_THREAD
 - 1)) == 0)

722 
	`´oûss_rcv_qp_wÜk
(
·ck‘
);

723 
	`cÚd_»sched
();

724  
RCV_PKT_OK
;

726 
	`this_ýu_šc
(*
·ck‘
->
rcd
->
dd
->
rcv_lim™
);

727  
RCV_PKT_LIMIT
;

729 
	}
}

731 
šlše
 
	$check_max_·ck‘
(
hfi1_·ck‘
 *
·ck‘
, 
th»ad
)

733 
»t
 = 
RCV_PKT_OK
;

735 ià(
	`uÆik–y
((
·ck‘
->
numpkt
 & (
MAX_PKT_RECV
 - 1)) == 0))

736 
»t
 = 
	`max_·ck‘_exûeded
(
·ck‘
, 
th»ad
);

737  
»t
;

738 
	}
}

740 
nošlše
 
	$sk_rcv_·ck‘
(
hfi1_·ck‘
 *
·ck‘
, 
th»ad
)

742 
»t
;

744 
·ck‘
->
rcd
->
dd
->
ùx0_£q_drÝ
++;

746 
·ck‘
->
rhqoff
 +ð·ck‘->
rsize
;

747 ià(
·ck‘
->
rhqoff
 >ð·ck‘->
maxút
)

748 
·ck‘
->
rhqoff
 = 0;

750 
·ck‘
->
numpkt
++;

751 
»t
 = 
	`check_max_·ck‘
(
·ck‘
, 
th»ad
);

753 
·ck‘
->
rhf_addr
 = (
__Ë32
 *íack‘->
rcd
->
rcvhdrq
 +…ack‘->
rhqoff
 +

754 
·ck‘
->
rcd
->
rhf_off£t
;

755 
·ck‘
->
rhf
 = 
	`rhf_to_ýu
Õack‘->
rhf_addr
);

757  
»t
;

758 
	}
}

760 
šlše
 
	$´oûss_rcv_·ck‘_Çpi
(
hfi1_·ck‘
 *
·ck‘
)

762 
·ck‘
->
‘y³
 = 
	`rhf_rcv_ty³
Õack‘->
rhf
);

765 
·ck‘
->
Ž’
 = 
	`rhf_pkt_Ën
Õack‘->
rhf
);

767 
·ck‘
->
‘až
 = 
	`rhf_egr_šdex
Õack‘->
rhf
);

768 
·ck‘
->
ebuf
 = 
	`g‘_egrbuf
Õack‘->
rcd
,…ack‘->
rhf
,

769 &
·ck‘
->
updegr
);

775 
	`´eãtch_¿nge
(
·ck‘
->
ebuf
,

776 
·ck‘
->
Ž’
 - (Õack‘->
rcd
->
rcvhdrq’tsize
 -

777 (
	`rhf_hdrq_off£t
(
·ck‘
->
rhf
)

780 
·ck‘
->
rcd
->
rhf_rcv_funùiÚ_m­
[·ck‘->
‘y³
](packet);

781 
·ck‘
->
numpkt
++;

784 
·ck‘
->
rhqoff
 +ð·ck‘->
rsize
;

785 ià(
·ck‘
->
rhqoff
 >ð·ck‘->
maxút
)

786 
·ck‘
->
rhqoff
 = 0;

788 
·ck‘
->
rhf_addr
 = (
__Ë32
 *íack‘->
rcd
->
rcvhdrq
 +…ack‘->
rhqoff
 +

789 
·ck‘
->
rcd
->
rhf_off£t
;

790 
·ck‘
->
rhf
 = 
	`rhf_to_ýu
Õack‘->
rhf_addr
);

791 
	}
}

793 
šlše
 
	$´oûss_rcv_·ck‘
(
hfi1_·ck‘
 *
·ck‘
, 
th»ad
)

795 
»t
;

797 
·ck‘
->
‘y³
 = 
	`rhf_rcv_ty³
Õack‘->
rhf
);

800 
·ck‘
->
Ž’
 = 
	`rhf_pkt_Ën
Õack‘->
rhf
);

802 
·ck‘
->
ebuf
 = 
NULL
;

803 ià(
	`rhf_u£_egr_bä
(
·ck‘
->
rhf
)) {

804 
·ck‘
->
‘až
 = 
	`rhf_egr_šdex
Õack‘->
rhf
);

805 
·ck‘
->
ebuf
 = 
	`g‘_egrbuf
Õack‘->
rcd
,…ack‘->
rhf
,

806 &
·ck‘
->
updegr
);

812 
	`´eãtch_¿nge
(
·ck‘
->
ebuf
,

813 
·ck‘
->
Ž’
 - ((
	`g‘_hdrq’tsize
Õack‘->
rcd
) -

814 (
	`rhf_hdrq_off£t
(
·ck‘
->
rhf
)

826 
·ck‘
->
rcd
->
rhf_rcv_funùiÚ_m­
[·ck‘->
‘y³
](packet);

827 
·ck‘
->
numpkt
++;

830 
·ck‘
->
rhqoff
 +ð·ck‘->
rsize
;

831 ià(
·ck‘
->
rhqoff
 >ð·ck‘->
maxút
)

832 
·ck‘
->
rhqoff
 = 0;

834 
»t
 = 
	`check_max_·ck‘
(
·ck‘
, 
th»ad
);

836 
·ck‘
->
rhf_addr
 = (
__Ë32
 *íack‘->
rcd
->
rcvhdrq
 +…ack‘->
rhqoff
 +

837 
·ck‘
->
rcd
->
rhf_off£t
;

838 
·ck‘
->
rhf
 = 
	`rhf_to_ýu
Õack‘->
rhf_addr
);

840  
»t
;

841 
	}
}

843 
šlše
 
	$´oûss_rcv_upd©e
(
Ï¡
, 
hfi1_·ck‘
 *
·ck‘
)

851 ià(!
Ï¡
 && !(
·ck‘
->
numpkt
 & 0xf)) {

852 
	`upd©e_u¤h—d
(
·ck‘
->
rcd
,…ack‘->
rhqoff
,…ack‘->
updegr
,

853 
·ck‘
->
‘až
, 0, 0);

854 
·ck‘
->
updegr
 = 0;

856 
·ck‘
->
grh
 = 
NULL
;

857 
	}
}

859 
šlše
 
	$fšish_·ck‘
(
hfi1_·ck‘
 *
·ck‘
)

867 
	`upd©e_u¤h—d
(
·ck‘
->
rcd
, 
	`hfi1_rcd_h—d
Õack‘->rcd),…ack‘->
updegr
,

868 
·ck‘
->
‘až
, 
rcv_šŒ_dyÇmic
,…ack‘->
numpkt
);

869 
	}
}

880 
	$hªdË_»ûive_š‹¼u±_Çpi_å
(
hfi1_ùxtd©a
 *
rcd
, 
budg‘
)

882 
hfi1_·ck‘
 
·ck‘
;

884 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

885 ià(
	`Ï¡_rcv_£q
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

886 
baž
;

888 
·ck‘
.
numpkt
 < 
budg‘
) {

889 
	`´oûss_rcv_·ck‘_Çpi
(&
·ck‘
);

890 ià(
	`hfi1_£q_šü
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

893 
	`´oûss_rcv_upd©e
(0, &
·ck‘
);

895 
	`hfi1_£t_rcd_h—d
(
rcd
, 
·ck‘
.
rhqoff
);

896 
baž
:

897 
	`fšish_·ck‘
(&
·ck‘
);

898  
·ck‘
.
numpkt
;

899 
	}
}

904 
	$hªdË_»ûive_š‹¼u±_nodma_¹až
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
)

906 
Ï¡
 = 
RCV_PKT_OK
;

907 
hfi1_·ck‘
 
·ck‘
;

909 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

910 ià(
	`Ï¡_rcv_£q
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
))) {

911 
Ï¡
 = 
RCV_PKT_DONE
;

912 
baž
;

915 
	`´esÿn_rxq
(
rcd
, &
·ck‘
);

917 
Ï¡
 =ð
RCV_PKT_OK
) {

918 
Ï¡
 = 
	`´oûss_rcv_·ck‘
(&
·ck‘
, 
th»ad
);

919 ià(
	`hfi1_£q_šü
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

920 
Ï¡
 = 
RCV_PKT_DONE
;

921 
	`´oûss_rcv_upd©e
(
Ï¡
, &
·ck‘
);

923 
	`´oûss_rcv_qp_wÜk
(&
·ck‘
);

924 
	`hfi1_£t_rcd_h—d
(
rcd
, 
·ck‘
.
rhqoff
);

925 
baž
:

926 
	`fšish_·ck‘
(&
·ck‘
);

927  
Ï¡
;

928 
	}
}

930 
	$hªdË_»ûive_š‹¼u±_dma_¹až
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
)

932 
u32
 
hdrqž
;

933 
Ï¡
 = 
RCV_PKT_OK
;

934 
hfi1_·ck‘
 
·ck‘
;

936 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

937 
hdrqž
 = 
	`g‘_rcvhd¹až
(
rcd
);

938 ià(
·ck‘
.
rhqoff
 =ð
hdrqž
) {

939 
Ï¡
 = 
RCV_PKT_DONE
;

940 
baž
;

942 
	`smp_rmb
();

944 
	`´esÿn_rxq
(
rcd
, &
·ck‘
);

946 
Ï¡
 =ð
RCV_PKT_OK
) {

947 
Ï¡
 = 
	`´oûss_rcv_·ck‘
(&
·ck‘
, 
th»ad
);

948 ià(
·ck‘
.
rhqoff
 =ð
hdrqž
)

949 
Ï¡
 = 
RCV_PKT_DONE
;

950 
	`´oûss_rcv_upd©e
(
Ï¡
, &
·ck‘
);

952 
	`´oûss_rcv_qp_wÜk
(&
·ck‘
);

953 
	`hfi1_£t_rcd_h—d
(
rcd
, 
·ck‘
.
rhqoff
);

954 
baž
:

955 
	`fšish_·ck‘
(&
·ck‘
);

956  
Ï¡
;

957 
	}
}

959 
	$£t_®l_ç¡·th
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
)

961 
u16
 
i
;

963 
	`dd_dev_šfo
(
dd
, "Switchingo fast…ath interrupts\n");

969 ià(
rcd
->
ùxt
 >ð
dd
->
fœ¡_dyn_®loc_ùxt
 && !rcd->
is_vnic
) {

970 
	`hfi1_rcd_g‘
(
rcd
);

971 
	`hfi1_£t_ç¡
(
rcd
);

972 
	`hfi1_rcd_put
(
rcd
);

976 
i
 = 
HFI1_CTRL_CTXT
 + 1; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

977 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

978 ià(
rcd
 &&

979 (
rcd
->
ùxt
 < 
dd
->
fœ¡_dyn_®loc_ùxt
 ||„cd->
is_vnic
))

980 
	`hfi1_£t_ç¡
(
rcd
);

981 
	`hfi1_rcd_put
(
rcd
);

983 
	}
}

985 
	$£t_®l_¦ow·th
(
hfi1_devd©a
 *
dd
)

987 
hfi1_ùxtd©a
 *
rcd
;

988 
u16
 
i
;

991 
i
 = 
HFI1_CTRL_CTXT
 + 1; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

992 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

993 ià(!
rcd
)

995 ià(
i
 < 
dd
->
fœ¡_dyn_®loc_ùxt
 || 
rcd
->
is_vnic
)

996 
rcd
->
do_š‹¼u±
 =„cd->
¦ow_hªdËr
;

998 
	`hfi1_rcd_put
(
rcd
);

1000 
	}
}

1008 
nošlše
 
	$__£t_¬med_to_aùive
(
hfi1_·ck‘
 *
·ck‘
)

1010 
u8
 
‘y³
 = 
	`rhf_rcv_ty³
(
·ck‘
->
rhf
);

1011 
u8
 
sc
 = 
SC15_PACKET
;

1013 ià(
‘y³
 =ð
RHF_RCV_TYPE_IB
) {

1014 
ib_h—d”
 *
hdr
 = 
	`hfi1_g‘_msgh—d”
(
·ck‘
->
rcd
,

1015 
·ck‘
->
rhf_addr
);

1016 
sc
 = 
	`hfi1_9B_g‘_sc5
(
hdr
, 
·ck‘
->
rhf
);

1017 } ià(
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

1018 
hfi1_16b_h—d”
 *
hdr
 = 
	`hfi1_g‘_16B_h—d”
(

1019 
·ck‘
->
rcd
,

1020 
·ck‘
->
rhf_addr
);

1021 
sc
 = 
	`hfi1_16B_g‘_sc
(
hdr
);

1023 ià(
sc
 !ð
SC15_PACKET
) {

1024 
hw¡©e
 = 
	`driv”_l¡©e
(
·ck‘
->
rcd
->
µd
);

1025 
wÜk_¡ruù
 *
l§w
 = &
·ck‘
->
rcd
->
µd
->
lšk¡©e_aùive_wÜk
;

1027 ià(
hw¡©e
 !ð
IB_PORT_ACTIVE
) {

1028 
	`dd_dev_šfo
(
·ck‘
->
rcd
->
dd
,

1030 
	`Ýa_l¡©e_Çme
(
hw¡©e
));

1034 
	`queue_wÜk
(
·ck‘
->
rcd
->
µd
->
lšk_wq
, 
l§w
);

1038 
	}
}

1046 
boÞ
 
	$£t_¬med_to_aùive
(
hfi1_·ck‘
 *
·ck‘
)

1048 ià(
	`lik–y
(
·ck‘
->
rcd
->
µd
->
ho¡_lšk_¡©e
 !ð
HLS_UP_ARMED
))

1049  
çl£
;

1050  
	`__£t_¬med_to_aùive
(
·ck‘
);

1051 
	}
}

1061 
	$hªdË_»ûive_š‹¼u±
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
)

1063 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1064 
u32
 
hdrqž
;

1065 
Ï¡
 = 
RCV_PKT_OK
;

1066 
hfi1_·ck‘
 
·ck‘
;

1067 
sk_pkt
 = 0;

1068 
boÞ
 
Ãed£t
 = 
rcd
->
ùxt
 !ð
HFI1_CTRL_CTXT
;

1070 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

1072 ià(!
	`g‘_dma_¹až_£‰šg
(
rcd
)) {

1073 ià(
	`Ï¡_rcv_£q
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
))) {

1074 
Ï¡
 = 
RCV_PKT_DONE
;

1075 
baž
;

1077 
hdrqž
 = 0;

1079 
hdrqž
 = 
	`g‘_rcvhd¹až
(
rcd
);

1080 ià(
·ck‘
.
rhqoff
 =ð
hdrqž
) {

1081 
Ï¡
 = 
RCV_PKT_DONE
;

1082 
baž
;

1084 
	`smp_rmb
();

1090 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
)

1091 ià(
	`Ï¡_rcv_£q
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

1092 
sk_pkt
 = 1;

1095 
	`´esÿn_rxq
(
rcd
, &
·ck‘
);

1097 
Ï¡
 =ð
RCV_PKT_OK
) {

1098 ià(
	`hfi1_Ãed_drÝ
(
dd
)) {

1100 
·ck‘
.
rhqoff
 +ð·ck‘.
rsize
;

1101 
·ck‘
.
rhf_addr
 = (
__Ë32
 *)
rcd
->
rcvhdrq
 +

1102 
·ck‘
.
rhqoff
 +

1103 
rcd
->
rhf_off£t
;

1104 
·ck‘
.
rhf
 = 
	`rhf_to_ýu
Õack‘.
rhf_addr
);

1106 } ià(
sk_pkt
) {

1107 
Ï¡
 = 
	`sk_rcv_·ck‘
(&
·ck‘
, 
th»ad
);

1108 
sk_pkt
 = 0;

1110 ià(
	`£t_¬med_to_aùive
(&
·ck‘
))

1111 
baž
;

1112 
Ï¡
 = 
	`´oûss_rcv_·ck‘
(&
·ck‘
, 
th»ad
);

1115 ià(!
	`g‘_dma_¹až_£‰šg
(
rcd
)) {

1116 ià(
	`hfi1_£q_šü
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

1117 
Ï¡
 = 
RCV_PKT_DONE
;

1119 ià(
·ck‘
.
rhqoff
 =ð
hdrqž
)

1120 
Ï¡
 = 
RCV_PKT_DONE
;

1125 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
) {

1126 
boÞ
 
l£q
;

1128 
l£q
 = 
	`hfi1_£q_šü
(
rcd
,

1129 
	`rhf_rcv_£q
(
·ck‘
.
rhf
));

1130 ià(!
Ï¡
 && 
l£q
)

1131 
sk_pkt
 = 1;

1134 ià(
Ãed£t
) {

1135 
Ãed£t
 = 
çl£
;

1136 
	`£t_®l_ç¡·th
(
dd
, 
rcd
);

1138 
	`´oûss_rcv_upd©e
(
Ï¡
, &
·ck‘
);

1141 
	`´oûss_rcv_qp_wÜk
(&
·ck‘
);

1142 
	`hfi1_£t_rcd_h—d
(
rcd
, 
·ck‘
.
rhqoff
);

1144 
baž
:

1149 
	`fšish_·ck‘
(&
·ck‘
);

1150  
Ï¡
;

1151 
	}
}

1162 
	$hªdË_»ûive_š‹¼u±_Çpi_¥
(
hfi1_ùxtd©a
 *
rcd
, 
budg‘
)

1164 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1165 
Ï¡
 = 
RCV_PKT_OK
;

1166 
boÞ
 
Ãed£t
 = 
Œue
;

1167 
hfi1_·ck‘
 
·ck‘
;

1169 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

1170 ià(
	`Ï¡_rcv_£q
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

1171 
baž
;

1173 
Ï¡
 !ð
RCV_PKT_DONE
 && 
·ck‘
.
numpkt
 < 
budg‘
) {

1174 ià(
	`hfi1_Ãed_drÝ
(
dd
)) {

1176 
·ck‘
.
rhqoff
 +ð·ck‘.
rsize
;

1177 
·ck‘
.
rhf_addr
 = (
__Ë32
 *)
rcd
->
rcvhdrq
 +

1178 
·ck‘
.
rhqoff
 +

1179 
rcd
->
rhf_off£t
;

1180 
·ck‘
.
rhf
 = 
	`rhf_to_ýu
Õack‘.
rhf_addr
);

1183 ià(
	`£t_¬med_to_aùive
(&
·ck‘
))

1184 
baž
;

1185 
	`´oûss_rcv_·ck‘_Çpi
(&
·ck‘
);

1188 ià(
	`hfi1_£q_šü
(
rcd
, 
	`rhf_rcv_£q
(
·ck‘
.
rhf
)))

1189 
Ï¡
 = 
RCV_PKT_DONE
;

1191 ià(
Ãed£t
) {

1192 
Ãed£t
 = 
çl£
;

1193 
	`£t_®l_ç¡·th
(
dd
, 
rcd
);

1196 
	`´oûss_rcv_upd©e
(
Ï¡
, &
·ck‘
);

1199 
	`hfi1_£t_rcd_h—d
(
rcd
, 
·ck‘
.
rhqoff
);

1201 
baž
:

1206 
	`fšish_·ck‘
(&
·ck‘
);

1207  
·ck‘
.
numpkt
;

1208 
	}
}

1230 
	$»ûive_š‹¼u±_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1232 
hfi1_µÜtd©a
 *
µd
 = 
	`cÚš”_of
(
wÜk
, hfi1_pportdata,

1233 
lšk¡©e_aùive_wÜk
);

1234 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1235 
hfi1_ùxtd©a
 *
rcd
;

1236 
u16
 
i
;

1239 
µd
->
ÃighbÜ_nÜm®
 = 1;

1240 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ACTIVE
);

1248 
i
 = 
HFI1_CTRL_CTXT
; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; i++) {

1249 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

1250 ià(
rcd
)

1251 
	`fÜû_»cv_šŒ
(
rcd
);

1252 
	`hfi1_rcd_put
(
rcd
);

1254 
	}
}

1260 
	$mtu_to_’um
(
u32
 
mtu
, 
deçuÉ_if_bad
)

1262 
mtu
) {

1263 0:  
OPA_MTU_0
;

1264 256:  
OPA_MTU_256
;

1265 512:  
OPA_MTU_512
;

1266 1024:  
OPA_MTU_1024
;

1267 2048:  
OPA_MTU_2048
;

1268 4096:  
OPA_MTU_4096
;

1269 8192:  
OPA_MTU_8192
;

1270 10240:  
OPA_MTU_10240
;

1272  
deçuÉ_if_bad
;

1273 
	}
}

1275 
u16
 
	$’um_to_mtu
(
mtu
)

1277 
mtu
) {

1278 
OPA_MTU_0
:  0;

1279 
OPA_MTU_256
:  256;

1280 
OPA_MTU_512
:  512;

1281 
OPA_MTU_1024
:  1024;

1282 
OPA_MTU_2048
:  2048;

1283 
OPA_MTU_4096
:  4096;

1284 
OPA_MTU_8192
:  8192;

1285 
OPA_MTU_10240
:  10240;

1288 
	}
}

1298 
	$£t_mtu
(
hfi1_µÜtd©a
 *
µd
)

1300 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1301 
i
, 
d¿š
, 
»t
 = 0, 
is_up
 = 0;

1303 
µd
->
ibmtu
 = 0;

1304 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++)

1305 ià(
µd
->
ibmtu
 < 
dd
->
vld
[
i
].
mtu
)

1306 
µd
->
ibmtu
 = 
dd
->
vld
[
i
].
mtu
;

1307 
µd
->
ibmaxËn
 =…pd->
ibmtu
 + 
	`Ìh_max_h—d”_by‹s
Õpd->
dd
);

1309 
	`mu‹x_lock
(&
µd
->
hls_lock
);

1310 ià(
µd
->
ho¡_lšk_¡©e
 =ð
HLS_UP_INIT
 ||

1311 
µd
->
ho¡_lšk_¡©e
 =ð
HLS_UP_ARMED
 ||

1312 
µd
->
ho¡_lšk_¡©e
 =ð
HLS_UP_ACTIVE
)

1313 
is_up
 = 1;

1315 
d¿š
 = !
	`is_ax
(
dd
è&& 
is_up
;

1317 ià(
d¿š
)

1323 
»t
 = 
	`¡Ý_d¿š_d©a_vls
(
dd
);

1325 ià(
»t
) {

1326 
	`dd_dev_”r
(
dd
, "%s: cannot stop/drain VLs -„efusingo change…er-VL MTUs\n",

1327 
__func__
);

1328 
”r
;

1331 
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_MTU
, 0);

1333 ià(
d¿š
)

1334 
	`Ý’_fžl_d©a_vls
(
dd
);

1336 
”r
:

1337 
	`mu‹x_uÆock
(&
µd
->
hls_lock
);

1339  
»t
;

1340 
	}
}

1342 
	$hfi1_£t_lid
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
lid
, 
u8
 
lmc
)

1344 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1346 
µd
->
lid
 =†id;

1347 
µd
->
lmc
 =†mc;

1348 
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_LIDLMC
, 0);

1350 
	`dd_dev_šfo
(
dd
, "pÜˆ%u: gÙ‡†id: 0x%x\n", 
µd
->
pÜt
, 
lid
);

1353 
	}
}

1355 
	$shutdown_Ëd_ov”ride
(
hfi1_µÜtd©a
 *
µd
)

1357 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1364 
	`smp_rmb
();

1365 ià(
	`©omic_»ad
(&
µd
->
Ëd_ov”ride_tim”_aùive
)) {

1366 
	`d–_tim”_sync
(&
µd
->
Ëd_ov”ride_tim”
);

1367 
	`©omic_£t
(&
µd
->
Ëd_ov”ride_tim”_aùive
, 0);

1369 
	`smp_wmb
();

1373 
	`wr™e_c¤
(
dd
, 
DCC_CFG_LED_CNTRL
, 0);

1374 
	}
}

1376 
	$run_Ëd_ov”ride
(
tim”_li¡
 *
t
)

1378 
hfi1_µÜtd©a
 *
µd
 = 
	`äom_tim”
Õpd, 
t
, 
Ëd_ov”ride_tim”
);

1379 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1380 
timeout
;

1381 
pha£_idx
;

1383 ià(!(
dd
->
æags
 & 
HFI1_INITTED
))

1386 
pha£_idx
 = 
µd
->
Ëd_ov”ride_pha£
 & 1;

1388 
	`£‹xŽed
(
dd
, 
pha£_idx
);

1390 
timeout
 = 
µd
->
Ëd_ov”ride_v®s
[
pha£_idx
];

1393 
µd
->
Ëd_ov”ride_pha£
 = !ppd->led_override_phase;

1395 
	`mod_tim”
(&
µd
->
Ëd_ov”ride_tim”
, 
jiff›s
 + 
timeout
);

1396 
	}
}

1404 
	$hfi1_¡¬t_Ëd_ov”ride
(
hfi1_µÜtd©a
 *
µd
, 
timeÚ
,

1405 
timeoff
)

1407 ià(!(
µd
->
dd
->
æags
 & 
HFI1_INITTED
))

1411 
µd
->
Ëd_ov”ride_v®s
[0] = 
	`m£cs_to_jiff›s
(
timeoff
);

1412 
µd
->
Ëd_ov”ride_v®s
[1] = 
	`m£cs_to_jiff›s
(
timeÚ
);

1415 
µd
->
Ëd_ov”ride_pha£
 = 1;

1421 ià(!
	`tim”_³ndšg
(&
µd
->
Ëd_ov”ride_tim”
)) {

1422 
	`tim”_£tup
(&
µd
->
Ëd_ov”ride_tim”
, 
run_Ëd_ov”ride
, 0);

1423 
µd
->
Ëd_ov”ride_tim”
.
expœes
 = 
jiff›s
 + 1;

1424 
	`add_tim”
(&
µd
->
Ëd_ov”ride_tim”
);

1425 
	`©omic_£t
(&
µd
->
Ëd_ov”ride_tim”_aùive
, 1);

1427 
	`smp_wmb
();

1429 
	}
}

1440 
	$hfi1_»£t_deviû
(
un™
)

1442 
»t
;

1443 
hfi1_devd©a
 *
dd
 = 
	`hfi1_lookup
(
un™
);

1444 
hfi1_µÜtd©a
 *
µd
;

1445 
pidx
;

1447 ià(!
dd
) {

1448 
»t
 = -
ENODEV
;

1449 
baž
;

1452 
	`dd_dev_šfo
(
dd
, "Re£ˆÚ un™ %u„eque¡ed\n", 
un™
);

1454 ià(!
dd
->
k»gba£1
 || !(dd->
æags
 & 
HFI1_PRESENT
)) {

1455 
	`dd_dev_šfo
(
dd
,

1457 
un™
);

1458 
»t
 = -
ENXIO
;

1459 
baž
;

1463 
	`mu‹x_lock
(&
hfi1_mu‹x
);

1464 ià(
dd
->
rcd
)

1465 ià(
hfi1_¡©s
.
¥s_ùxts
) {

1466 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

1467 
»t
 = -
EBUSY
;

1468 
baž
;

1470 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

1472 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1473 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1475 
	`shutdown_Ëd_ov”ride
(
µd
);

1477 ià(
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
)

1478 
	`sdma_ex™
(
dd
);

1480 
	`hfi1_»£t_ýu_couÁ”s
(
dd
);

1482 
»t
 = 
	`hfi1_š™
(
dd
, 1);

1484 ià(
»t
)

1485 
	`dd_dev_”r
(
dd
,

1487 
un™
, 
»t
);

1489 
	`dd_dev_šfo
(
dd
, "Reinitialized unit %u‡fter„esetting\n",

1490 
un™
);

1492 
baž
:

1493  
»t
;

1494 
	}
}

1496 
šlše
 
	$hfi1_£tup_ib_h—d”
(
hfi1_·ck‘
 *
·ck‘
)

1498 
·ck‘
->
hdr
 = (
hfi1_ib_mes§ge_h—d”
 *)

1499 
	`hfi1_g‘_msgh—d”
(
·ck‘
->
rcd
,

1500 
·ck‘
->
rhf_addr
);

1501 
·ck‘
->
hËn
 = (
u8
 *íack‘->
rhf_addr
 - (u8 *íack‘->
hdr
;

1502 
	}
}

1504 
	$hfi1_by·ss_šg»ss_pkt_check
(
hfi1_·ck‘
 *
·ck‘
)

1506 
hfi1_µÜtd©a
 *
µd
 = 
·ck‘
->
rcd
->ppd;

1509 ià((!
·ck‘
->
¦id
è|| (!·ck‘->
dlid
))

1510  -
EINVAL
;

1513 ià((!(
	`hfi1_is_16B_mÿ¡
(
·ck‘
->
dlid
))) &&

1514 (
·ck‘
->
dlid
 !=

1515 
	`Ýa_g‘_lid
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
), 16B))) {

1516 ià((
·ck‘
->
dlid
 & ~((1 << 
µd
->
lmc
è- 1)è!ðµd->
lid
)

1517  -
EINVAL
;

1521 ià((
	`hfi1_is_16B_mÿ¡
(
·ck‘
->
dlid
)è&& (·ck‘->
sc
 == 0xF))

1522  -
EINVAL
;

1525 ià((
·ck‘
->
dlid
 =ð
	`Ýa_g‘_lid
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
),

1527 (
·ck‘
->
sc
 != 0xF))

1528  -
EINVAL
;

1531 
	}
}

1533 
	$hfi1_£tup_9B_·ck‘
(
hfi1_·ck‘
 *
·ck‘
)

1535 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

1536 
ib_h—d”
 *
hdr
;

1537 
u8
 
Êh
;

1539 
	`hfi1_£tup_ib_h—d”
(
·ck‘
);

1540 
hdr
 = 
·ck‘
->hdr;

1542 
Êh
 = 
	`ib_g‘_Êh
(
hdr
);

1543 ià(
Êh
 =ð
HFI1_LRH_BTH
) {

1544 
·ck‘
->
ohdr
 = &
hdr
->
u
.
Ùh
;

1545 
·ck‘
->
grh
 = 
NULL
;

1546 } ià(
Êh
 =ð
HFI1_LRH_GRH
) {

1547 
u32
 
vtf
;

1549 
·ck‘
->
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1550 
·ck‘
->
grh
 = &
hdr
->
u
.
l
.grh;

1551 ià(
·ck‘
->
grh
->
Ãxt_hdr
 !ð
IB_GRH_NEXT_HDR
)

1552 
drÝ
;

1553 
vtf
 = 
	`be32_to_ýu
(
·ck‘
->
grh
->
v”siÚ_tþass_æow
);

1554 ià((
vtf
 >> 
IB_GRH_VERSION_SHIFT
è!ð
IB_GRH_VERSION
)

1555 
drÝ
;

1557 
drÝ
;

1561 
·ck‘
->
·ylßd
 =…ack‘->
ebuf
;

1562 
·ck‘
->
Ýcode
 = 
	`ib_bth_g‘_Ýcode
Õack‘->
ohdr
);

1563 
·ck‘
->
¦id
 = 
	`ib_g‘_¦id
(
hdr
);

1564 
·ck‘
->
dlid
 = 
	`ib_g‘_dlid
(
hdr
);

1565 ià(
	`uÆik–y
((
·ck‘
->
dlid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) &&

1566 (
·ck‘
->
dlid
 !ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
))))

1567 
·ck‘
->
dlid
 +ð
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
) -

1568 
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
);

1569 
·ck‘
->
¦
 = 
	`ib_g‘_¦
(
hdr
);

1570 
·ck‘
->
sc
 = 
	`hfi1_9B_g‘_sc5
(
hdr
,…ack‘->
rhf
);

1571 
·ck‘
->
·d
 = 
	`ib_bth_g‘_·d
Õack‘->
ohdr
);

1572 
·ck‘
->
exŒa_by‹
 = 0;

1573 
·ck‘
->
pkey
 = 
	`ib_bth_g‘_pkey
Õack‘->
ohdr
);

1574 
·ck‘
->
mig¿‹d
 = 
	`ib_bth_is_mig¿tiÚ
Õack‘->
ohdr
);

1577 
drÝ
:

1578 
ibp
->
rvp
.
n_pkt_drÝs
++;

1579  -
EINVAL
;

1580 
	}
}

1582 
	$hfi1_£tup_by·ss_·ck‘
(
hfi1_·ck‘
 *
·ck‘
)

1594 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1595 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

1596 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

1597 
u8
 
l4
;

1599 
·ck‘
->
hdr
 = (
hfi1_16b_h—d”
 *)

1600 
	`hfi1_g‘_16B_h—d”
(
·ck‘
->
rcd
,

1601 
·ck‘
->
rhf_addr
);

1602 
l4
 = 
	`hfi1_16B_g‘_l4
(
·ck‘
->
hdr
);

1603 ià(
l4
 =ð
OPA_16B_L4_IB_LOCAL
) {

1604 
·ck‘
->
ohdr
 =…ack‘->
ebuf
;

1605 
·ck‘
->
grh
 = 
NULL
;

1606 
·ck‘
->
Ýcode
 = 
	`ib_bth_g‘_Ýcode
Õack‘->
ohdr
);

1607 
·ck‘
->
·d
 = 
	`hfi1_16B_bth_g‘_·d
Õack‘->
ohdr
);

1609 
·ck‘
->
hËn
 = 
hdr_Ën_by_Ýcode
[·ck‘->
Ýcode
] +

1610 (
LRH_16B_BYTES
 - 
LRH_9B_BYTES
);

1611 
·ck‘
->
mig¿‹d
 = 
	`Ýa_bth_is_mig¿tiÚ
Õack‘->
ohdr
);

1612 } ià(
l4
 =ð
OPA_16B_L4_IB_GLOBAL
) {

1613 
u32
 
vtf
;

1614 
u8
 
grh_Ën
 = (
ib_grh
);

1616 
·ck‘
->
ohdr
 =…ack‘->
ebuf
 + 
grh_Ën
;

1617 
·ck‘
->
grh
 =…ack‘->
ebuf
;

1618 
·ck‘
->
Ýcode
 = 
	`ib_bth_g‘_Ýcode
Õack‘->
ohdr
);

1619 
·ck‘
->
·d
 = 
	`hfi1_16B_bth_g‘_·d
Õack‘->
ohdr
);

1621 
·ck‘
->
hËn
 = 
hdr_Ën_by_Ýcode
[·ck‘->
Ýcode
] +

1622 (
LRH_16B_BYTES
 - 
LRH_9B_BYTES
è+ 
grh_Ën
;

1623 
·ck‘
->
mig¿‹d
 = 
	`Ýa_bth_is_mig¿tiÚ
Õack‘->
ohdr
);

1625 ià(
·ck‘
->
grh
->
Ãxt_hdr
 !ð
IB_GRH_NEXT_HDR
)

1626 
drÝ
;

1627 
vtf
 = 
	`be32_to_ýu
(
·ck‘
->
grh
->
v”siÚ_tþass_æow
);

1628 ià((
vtf
 >> 
IB_GRH_VERSION_SHIFT
è!ð
IB_GRH_VERSION
)

1629 
drÝ
;

1630 } ià(
l4
 =ð
OPA_16B_L4_FM
) {

1631 
·ck‘
->
mgmt
 =…ack‘->
ebuf
;

1632 
·ck‘
->
ohdr
 = 
NULL
;

1633 
·ck‘
->
grh
 = 
NULL
;

1634 
·ck‘
->
Ýcode
 = 
IB_OPCODE_UD_SEND_ONLY
;

1635 
·ck‘
->
·d
 = 
OPA_16B_L4_FM_PAD
;

1636 
·ck‘
->
hËn
 = 
OPA_16B_L4_FM_HLEN
;

1637 
·ck‘
->
mig¿‹d
 = 
çl£
;

1639 
drÝ
;

1643 
·ck‘
->
·ylßd
 =…ack‘->
ebuf
 +…ack‘->
hËn
 - 
LRH_16B_BYTES
;

1644 
·ck‘
->
¦id
 = 
	`hfi1_16B_g‘_¦id
Õack‘->
hdr
);

1645 
·ck‘
->
dlid
 = 
	`hfi1_16B_g‘_dlid
Õack‘->
hdr
);

1646 ià(
	`uÆik–y
(
	`hfi1_is_16B_mÿ¡
(
·ck‘
->
dlid
)))

1647 
·ck‘
->
dlid
 +ð
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
) -

1648 
	`Ýa_g‘_lid
(
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
),

1650 
·ck‘
->
sc
 = 
	`hfi1_16B_g‘_sc
Õack‘->
hdr
);

1651 
·ck‘
->
¦
 = 
ibp
->
sc_to_¦
[·ck‘->
sc
];

1652 
·ck‘
->
exŒa_by‹
 = 
SIZE_OF_LT
;

1653 
·ck‘
->
pkey
 = 
	`hfi1_16B_g‘_pkey
Õack‘->
hdr
);

1655 ià(
	`hfi1_by·ss_šg»ss_pkt_check
(
·ck‘
))

1656 
drÝ
;

1659 
drÝ
:

1660 
	`hfi1_cdbg
(
PKT
, "%s:…ack‘ drÝ³d\n", 
__func__
);

1661 
ibp
->
rvp
.
n_pkt_drÝs
++;

1662  -
EINVAL
;

1663 
	}
}

1665 
šlše
 
	$show_eæags_”rs
(
hfi1_·ck‘
 *
·ck‘
)

1667 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1668 
u32
 
¹e
 = 
	`rhf_rcv_ty³_”r
(
·ck‘
->
rhf
);

1670 
	`dd_dev_”r
(
rcd
->
dd
,

1672 
rcd
->
ùxt
, 
·ck‘
->
rhf
,

1673 
·ck‘
->
rhf
 & 
RHF_K_HDR_LEN_ERR
 ? "k_hdr_len " : "",

1674 
·ck‘
->
rhf
 & 
RHF_DC_UNC_ERR
 ? "dc_unc " : "",

1675 
·ck‘
->
rhf
 & 
RHF_DC_ERR
 ? "dc " : "",

1676 
·ck‘
->
rhf
 & 
RHF_TID_ERR
 ? "tid " : "",

1677 
·ck‘
->
rhf
 & 
RHF_LEN_ERR
 ? "len " : "",

1678 
·ck‘
->
rhf
 & 
RHF_ECC_ERR
 ? "ecc " : "",

1679 
·ck‘
->
rhf
 & 
RHF_ICRC_ERR
 ? "icrc " : "",

1680 
¹e
);

1681 
	}
}

1683 
	$hªdË_eæags
(
hfi1_·ck‘
 *
·ck‘
)

1685 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1687 
	`rcv_hd»¼
(
rcd
,„cd->
µd
, 
·ck‘
);

1688 ià(
	`rhf_”r_æags
(
·ck‘
->
rhf
))

1689 
	`show_eæags_”rs
(
·ck‘
);

1690 
	}
}

1692 
	$hfi1_oib_ib_rcv
(
hfi1_·ck‘
 *
·ck‘
)

1694 
hfi1_ibpÜt
 *
ibp
;

1695 
Ãt_deviû
 *
Ãtdev
;

1696 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1697 
Çpi_¡ruù
 *
Çpi
 = 
rcd
->napi;

1698 
sk_buff
 *
skb
;

1699 
hfi1_Ãtdev_rxq
 *
rxq
 = 
	`cÚš”_of
(
Çpi
,

1700 
hfi1_Ãtdev_rxq
, 
Çpi
);

1701 
u32
 
exŒa_by‹s
;

1702 
u32
 
Ž’
, 
q²um
;

1703 
hfi1_oib_dev_´iv
 *
´iv
;

1705 
	`Œaû_hfi1_rcvhdr
(
·ck‘
);

1707 
	`hfi1_£tup_ib_h—d”
(
·ck‘
);

1709 
·ck‘
->
ohdr
 = &((
ib_h—d”
 *íack‘->
hdr
)->
u
.
Ùh
;

1710 
·ck‘
->
grh
 = 
NULL
;

1712 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
))) {

1713 
	`hªdË_eæags
(
·ck‘
);

1717 
q²um
 = 
	`ib_bth_g‘_q²
(
·ck‘
->
ohdr
);

1718 
Ãtdev
 = 
	`hfi1_Ãtdev_g‘_d©a
(
rcd
->
dd
, 
q²um
);

1719 ià(!
Ãtdev
)

1720 
drÝ_no_nd
;

1722 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, !!(
	`rhf_dc_šfo
Õack‘->
rhf
)));

1724 #ifdeà
AIP


1725 
	`Œaû_ùxt_rsm_hi¡
(
rcd
->
ùxt
);

1729 
	`´oûss_eú
(
	`hfi1_oib_´iv
(
Ãtdev
)->
qp
, 
·ck‘
);

1737 
Ž’
 = 
·ck‘
->tlen;

1738 
exŒa_by‹s
 = 
	`ib_bth_g‘_·d
(
·ck‘
->
ohdr
è+ (
SIZE_OF_CRC
 << 2) +

1739 
·ck‘
->
hËn
;

1740 ià(
	`uÆik–y
(
Ž’
 < 
exŒa_by‹s
))

1741 
drÝ
;

1743 
Ž’
 -ð
exŒa_by‹s
;

1745 
skb
 = 
	`hfi1_oib_´•¬e_skb
(
rxq
, 
Ž’
, 
·ck‘
->
ebuf
);

1746 ià(
	`uÆik–y
(!
skb
))

1747 
drÝ
;

1749 
´iv
 = 
	`hfi1_oib_´iv
(
Ãtdev
);

1750 
	`hfi1_oib_upd©e_rx_Ãt¡©s
(
´iv
, 1, 
skb
->
Ën
);

1752 
skb
->
dev
 = 
Ãtdev
;

1753 
skb
->
pkt_ty³
 = 
PACKET_HOST
;

1754 
	`Ãtif_»ûive_skb
(
skb
);

1758 
drÝ
:

1759 ++
Ãtdev
->
¡©s
.
rx_drÝ³d
;

1760 
drÝ_no_nd
:

1761 
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

1762 ++
ibp
->
rvp
.
n_pkt_drÝs
;

1763 
	}
}

1769 
	$´oûss_»ûive_ib
(
hfi1_·ck‘
 *
·ck‘
)

1771 ià(
	`hfi1_£tup_9B_·ck‘
(
·ck‘
))

1774 ià(
	`uÆik–y
(
	`hfi1_dbg_should_çuÉ_rx
(
·ck‘
)))

1777 
	`Œaû_hfi1_rcvhdr
(
·ck‘
);

1779 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
))) {

1780 
	`hªdË_eæags
(
·ck‘
);

1784 
	`hfi1_ib_rcv
(
·ck‘
);

1785 
	}
}

1787 
šlše
 
boÞ
 
	$hfi1_is_vnic_·ck‘
(
hfi1_·ck‘
 *
·ck‘
)

1790 ià(
·ck‘
->
rcd
->
is_vnic
)

1791  
Œue
;

1793 ià((
	`hfi1_16B_g‘_l2
(
·ck‘
->
ebuf
è=ð
OPA_16B_L2_TYPE
) &&

1794 (
	`hfi1_16B_g‘_l4
(
·ck‘
->
ebuf
è=ð
OPA_16B_L4_ETHR
))

1795  
Œue
;

1797  
çl£
;

1798 
	}
}

1800 
	$´oûss_»ûive_by·ss
(
hfi1_·ck‘
 *
·ck‘
)

1802 
hfi1_devd©a
 *
dd
 = 
·ck‘
->
rcd
->dd;

1804 ià(
	`hfi1_£tup_by·ss_·ck‘
(
·ck‘
))

1807 
	`Œaû_hfi1_rcvhdr
(
·ck‘
);

1809 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
))) {

1810 
	`hªdË_eæags
(
·ck‘
);

1814 ià(
	`hfi1_16B_g‘_l2
(
·ck‘
->
hdr
) == 0x2) {

1815 
	`hfi1_16B_rcv
(
·ck‘
);

1817 
	`dd_dev_”r
(
dd
,

1819 
	`šü_úŒ64
(&
dd
->
sw_rcv_by·ss_·ck‘_”rÜs
);

1820 ià(!(
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 &

1821 
OPA_EI_STATUS_SMASK
)) {

1822 
u64
 *
æ™s
 = 
·ck‘
->
ebuf
;

1824 ià(
æ™s
 && !(
·ck‘
->
rhf
 & 
RHF_LEN_ERR
)) {

1825 
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™1
 = 
æ™s
[0];

1826 
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™2
 =

1827 
·ck‘
->
Ž’
 > (
æ™s
[0]) ?

1828 
æ™s
[1] : 0;

1830 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 |=

1831 (
OPA_EI_STATUS_SMASK
 | 
BAD_L2_ERR
);

1834 
	}
}

1836 
	$´oûss_»ûive_”rÜ
(
hfi1_·ck‘
 *
·ck‘
)

1839 ià(
	`uÆik–y
(

1840 
	`hfi1_dbg_çuÉ_suµ»ss_”r
(&
·ck‘
->
rcd
->
dd
->
v”bs_dev
) &&

1841 (
	`rhf_rcv_ty³_”r
(
·ck‘
->
rhf
è=ð
RHF_RCV_TYPE_ERROR
 ||

1842 
·ck‘
->
rhf
 & 
RHF_DC_ERR
)))

1845 
	`hfi1_£tup_ib_h—d”
(
·ck‘
);

1846 
	`hªdË_eæags
(
·ck‘
);

1848 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
)))

1849 
	`dd_dev_”r
(
·ck‘
->
rcd
->
dd
,

1851 
	}
}

1853 
	$kd‘h_´oûss_ex³ùed
(
hfi1_·ck‘
 *
·ck‘
)

1855 
	`hfi1_£tup_9B_·ck‘
(
·ck‘
);

1856 ià(
	`uÆik–y
(
	`hfi1_dbg_should_çuÉ_rx
(
·ck‘
)))

1859 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
))) {

1860 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1862 ià(
	`hfi1_hªdË_kd‘h_eæags
(
rcd
,„cd->
µd
, 
·ck‘
))

1866 
	`hfi1_kd‘h_ex³ùed_rcv
(
·ck‘
);

1868 
	}
}

1870 
	$kd‘h_´oûss_—g”
(
hfi1_·ck‘
 *
·ck‘
)

1872 
	`hfi1_£tup_9B_·ck‘
(
·ck‘
);

1873 ià(
	`uÆik–y
(
	`hfi1_dbg_should_çuÉ_rx
(
·ck‘
)))

1876 
	`Œaû_hfi1_rcvhdr
(
·ck‘
);

1877 ià(
	`uÆik–y
(
	`rhf_”r_æags
(
·ck‘
->
rhf
))) {

1878 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1880 
	`show_eæags_”rs
(
·ck‘
);

1881 ià(
	`hfi1_hªdË_kd‘h_eæags
(
rcd
,„cd->
µd
, 
·ck‘
))

1885 
	`hfi1_kd‘h_—g”_rcv
(
·ck‘
);

1887 
	}
}

1889 
	$´oûss_»ûive_šv®id
(
hfi1_·ck‘
 *
·ck‘
)

1891 
	`dd_dev_”r
(
·ck‘
->
rcd
->
dd
, "Invalid…acketype %d. Dropping\n",

1892 
	`rhf_rcv_ty³
(
·ck‘
->
rhf
));

1893 
	}
}

1895 
	$£qfže_dump_rcd
(
£q_fže
 *
s
, 
hfi1_ùxtd©a
 *
rcd
)

1897 
hfi1_·ck‘
 
·ck‘
;

1898 
ps_md©a
 
md©a
;

1899 
i
;

1901 
	`£q_´štf
(
s
, "Rcd %u: RcvHdr cnt %uƒntsize %u %s ctrl 0x%08llx status 0x%08llx, head %lluail %llu sw head %u\n",

1902 
rcd
->
ùxt
, 
	`g‘_hdrq_út
Ôcd), 
	`g‘_hdrq’tsize
(rcd),

1903 
	`g‘_dma_¹až_£‰šg
(
rcd
) ?

1905 
	`»ad_kùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_CTXT_CTRL
),

1906 
	`»ad_kùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_CTXT_STATUS
),

1907 
	`»ad_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_HDR_HEAD
) &

1908 
RCV_HDR_HEAD_HEAD_MASK
,

1909 
	`»ad_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
, 
RCV_HDR_TAIL
),

1910 
rcd
->
h—d
);

1912 
	`š™_·ck‘
(
rcd
, &
·ck‘
);

1913 
	`š™_ps_md©a
(&
md©a
, &
·ck‘
);

1915 
i
 = 0; i < 5; i++) {

1916 
__Ë32
 *
rhf_addr
 = (__Ë32 *)
rcd
->
rcvhdrq
 + 
md©a
.
ps_h—d
 +

1917 
rcd
->
rhf_off£t
;

1918 
ib_h—d”
 *
hdr
;

1919 
u64
 
rhf
 = 
	`rhf_to_ýu
(
rhf_addr
);

1920 
u32
 
‘y³
 = 
	`rhf_rcv_ty³
(
rhf
), 
q²
;

1921 
u8
 
Ýcode
;

1922 
u32
 
p¢
;

1923 
u8
 
Êh
;

1925 ià(
	`ps_dÚe
(&
md©a
, 
rhf
, 
rcd
))

1928 ià(
	`ps_sk
(&
md©a
, 
rhf
, 
rcd
))

1929 
Ãxt
;

1931 ià(
‘y³
 > 
RHF_RCV_TYPE_IB
)

1932 
Ãxt
;

1934 
·ck‘
.
hdr
 = 
	`hfi1_g‘_msgh—d”
(
rcd
, 
rhf_addr
);

1935 
hdr
 = 
·ck‘
.hdr;

1937 
Êh
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3;

1939 ià(
Êh
 =ð
HFI1_LRH_BTH
)

1940 
·ck‘
.
ohdr
 = &
hdr
->
u
.
Ùh
;

1941 ià(
Êh
 =ð
HFI1_LRH_GRH
)

1942 
·ck‘
.
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1944 
Ãxt
;

1946 
Ýcode
 = (
	`be32_to_ýu
(
·ck‘
.
ohdr
->
bth
[0]) >> 24);

1947 
q²
 = 
	`be32_to_ýu
(
·ck‘
.
ohdr
->
bth
[1]è& 
RVT_QPN_MASK
;

1948 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
·ck‘
.
ohdr
->
bth
[2]));

1950 
	`£q_´štf
(
s
, "\tEnt %u: opcode 0x%x, qpn 0x%x,…sn 0x%x\n",

1951 
md©a
.
ps_h—d
, 
Ýcode
, 
q²
, 
p¢
);

1952 
Ãxt
:

1953 
	`upd©e_ps_md©a
(&
md©a
, 
rcd
);

1955 
	}
}

1957 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
	gnÜm®_rhf_rcv_funùiÚs
[] = {

1958 [
RHF_RCV_TYPE_EXPECTED
] = 
kd‘h_´oûss_ex³ùed
,

1959 [
RHF_RCV_TYPE_EAGER
] = 
kd‘h_´oûss_—g”
,

1960 [
RHF_RCV_TYPE_IB
] = 
´oûss_»ûive_ib
,

1961 [
RHF_RCV_TYPE_ERROR
] = 
´oûss_»ûive_”rÜ
,

1962 [
RHF_RCV_TYPE_BYPASS
] = 
´oûss_»ûive_by·ss
,

1963 [
RHF_RCV_TYPE_INVALID5
] = 
´oûss_»ûive_šv®id
,

1964 [
RHF_RCV_TYPE_INVALID6
] = 
´oûss_»ûive_šv®id
,

1965 [
RHF_RCV_TYPE_INVALID7
] = 
´oûss_»ûive_šv®id
,

1968 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
	gÃtdev_rhf_rcv_funùiÚs
[] = {

1969 [
RHF_RCV_TYPE_EXPECTED
] = 
´oûss_»ûive_šv®id
,

1970 [
RHF_RCV_TYPE_EAGER
] = 
´oûss_»ûive_šv®id
,

1971 [
RHF_RCV_TYPE_IB
] = 
hfi1_oib_ib_rcv
,

1972 [
RHF_RCV_TYPE_ERROR
] = 
´oûss_»ûive_”rÜ
,

1973 [
RHF_RCV_TYPE_BYPASS
] = 
hfi1_vnic_by·ss_rcv
,

1974 [
RHF_RCV_TYPE_INVALID5
] = 
´oûss_»ûive_šv®id
,

1975 [
RHF_RCV_TYPE_INVALID6
] = 
´oûss_»ûive_šv®id
,

1976 [
RHF_RCV_TYPE_INVALID7
] = 
´oûss_»ûive_šv®id
,

	@efivar.c

48 
	~<lšux/ùy³.h
>

49 
	~"efiv¬.h
"

52 
	#HFI1_EFIVAR_GUID
 
	`EFI_GUID
(0xc50a953e, 0xa8b2, 0x42a6, \

53 0xbf, 0x89, 0xd3, 0x33, 0xa6, 0xe9, 0xe6, 0xd4)

	)

55 
	#EFI_DATA_SIZE
 4096

	)

65 
	$»ad_efi_v¬
(cÚ¡ *
Çme
, *
size
,

66 **
»tuº_d©a
)

68 
efi_¡©us_t
 
¡©us
;

69 
efi_ch¬16_t
 *
uni_Çme
;

70 
efi_guid_t
 
guid
;

71 
‹mp_size
;

72 *
‹mp_bufãr
;

73 *
d©a
;

74 
i
;

75 
»t
;

78 *
size
 = 0;

79 *
»tuº_d©a
 = 
NULL
;

81 ià(!
	`efi_’abËd
(
EFI_RUNTIME_SERVICES
))

82  -
EOPNOTSUPP
;

84 
uni_Çme
 = 
	`kÿÎoc
(
	`¡¾’
(
Çme
è+ 1, (
efi_ch¬16_t
), 
GFP_KERNEL
);

85 
‹mp_bufãr
 = 
	`kz®loc
(
EFI_DATA_SIZE
, 
GFP_KERNEL
);

87 ià(!
uni_Çme
 || !
‹mp_bufãr
) {

88 
»t
 = -
ENOMEM
;

89 
çž
;

93 
‹mp_size
 = 
EFI_DATA_SIZE
;

96 
i
 = 0; 
Çme
[i]; i++)

97 
uni_Çme
[
i
] = 
Çme
[i];

100 
guid
 = 
HFI1_EFIVAR_GUID
;

103 
¡©us
 = 
efi
.
	`g‘_v¬ŸbË
(

104 
uni_Çme
,

105 &
guid
,

106 
NULL
,

107 &
‹mp_size
,

108 
‹mp_bufãr
);

117 
»t
 = 
¡©us
 =ð
EFI_SUCCESS
 ? 0 :

118 
¡©us
 =ð
EFI_NOT_FOUND
 ? -
ENOENT
 :

119 -
EINVAL
;

120 ià(
»t
)

121 
çž
;

128 
d©a
 = 
	`kmemdup
(
‹mp_bufãr
, 
‹mp_size
, 
GFP_KERNEL
);

129 ià(!
d©a
) {

130 
»t
 = -
ENOMEM
;

131 
çž
;

134 *
size
 = 
‹mp_size
;

135 *
»tuº_d©a
 = 
d©a
;

137 
çž
:

138 
	`kä“
(
uni_Çme
);

139 
	`kä“
(
‹mp_bufãr
);

141  
»t
;

142 
	}
}

151 
	$»ad_hfi1_efi_v¬
(
hfi1_devd©a
 *
dd
, cÚ¡ *
kšd
,

152 *
size
, **
»tuº_d©a
)

154 
´efix_Çme
[64];

155 
Çme
[64];

156 
»suÉ
;

157 
i
;

160 
	`¢´štf
(
´efix_Çme
, (prefix_name), "%04x:%02x:%02x.%x",

161 
	`pci_domaš_Ä
(
dd
->
pcidev
->
bus
),

162 
dd
->
pcidev
->
bus
->
numb”
,

163 
	`PCI_SLOT
(
dd
->
pcidev
->
devâ
),

164 
	`PCI_FUNC
(
dd
->
pcidev
->
devâ
));

165 
	`¢´štf
(
Çme
, Òame), "%s-%s", 
´efix_Çme
, 
kšd
);

166 
»suÉ
 = 
	`»ad_efi_v¬
(
Çme
, 
size
, 
»tuº_d©a
);

172 ià(
»suÉ
) {

174 
i
 = 0; 
´efix_Çme
[i]; i++)

175 ià(
	`i§Íha
(
´efix_Çme
[
i
]))

176 
´efix_Çme
[
i
] = 
	`touµ”
(prefix_name[i]);

177 
	`¢´štf
(
Çme
, Òame), "%s-%s", 
´efix_Çme
, 
kšd
);

178 
»suÉ
 = 
	`»ad_efi_v¬
(
Çme
, 
size
, 
»tuº_d©a
);

181  
»suÉ
;

182 
	}
}

	@efivar.h

47 #iâdeà
_HFI1_EFIVAR_H


48 
	#_HFI1_EFIVAR_H


	)

50 
	~<lšux/efi.h
>

52 
	~"hfi.h
"

54 
»ad_hfi1_efi_v¬
(
hfi1_devd©a
 *
dd
, cÚ¡ *
kšd
,

55 *
size
, **
»tuº_d©a
);

	@eprom.c

47 
	~<lšux/d–ay.h
>

48 
	~"hfi.h
"

49 
	~"commÚ.h
"

50 
	~"•rom.h
"

58 
	#P0_SIZE
 (128 * 1024)

	)

59 
	#P1_SIZE
 (4 * 1024)

	)

60 
	#P1_START
 
P0_SIZE


	)

61 
	#P2_START
 (
P0_SIZE
 + 
P1_SIZE
)

	)

64 
	#EP_PAGE_SIZE
 256

	)

65 
	#EP_PAGE_MASK
 (
EP_PAGE_SIZE
 - 1)

	)

66 
	#EP_PAGE_DWORDS
 (
EP_PAGE_SIZE
 / (
u32
))

	)

69 
	#CMD_SHIFT
 24

	)

70 
	#CMD_NOP
 (0)

	)

71 
	#CMD_READ_DATA
(
addr
è((0x03 << 
CMD_SHIFT
è|‡ddr)

	)

72 
	#CMD_RELEASE_POWERDOWN_NOID
 ((0xab << 
CMD_SHIFT
))

	)

75 
	#EP_SPEED_FULL
 0x2

	)

82 
	#EPROM_TIMEOUT
 80000

	)

88 
	$»ad_·ge
(
hfi1_devd©a
 *
dd
, 
u32
 
off£t
, u32 *
»suÉ
)

90 
i
;

92 
	`wr™e_c¤
(
dd
, 
ASIC_EEP_ADDR_CMD
, 
	`CMD_READ_DATA
(
off£t
));

93 
i
 = 0; i < 
EP_PAGE_DWORDS
; i++)

94 
»suÉ
[
i
] = (
u32
)
	`»ad_c¤
(
dd
, 
ASIC_EEP_DATA
);

95 
	`wr™e_c¤
(
dd
, 
ASIC_EEP_ADDR_CMD
, 
CMD_NOP
);

96 
	}
}

101 
	$»ad_Ëngth
(
hfi1_devd©a
 *
dd
, 
u32
 
¡¬t
, u32 
Ën
, *
de¡
)

103 
u32
 
bufãr
[
EP_PAGE_DWORDS
];

104 
u32
 
’d
;

105 
u32
 
¡¬t_off£t
;

106 
u32
 
»ad_¡¬t
;

107 
u32
 
by‹s
;

109 ià(
Ën
 == 0)

112 
’d
 = 
¡¬t
 + 
Ën
;

119 ià(
’d
 > (1 << 
CMD_SHIFT
))

120  -
EINVAL
;

123 
¡¬t_off£t
 = 
¡¬t
 & 
EP_PAGE_MASK
;

124 ià(
¡¬t_off£t
) {

128 
»ad_¡¬t
 = 
¡¬t
 & ~
EP_PAGE_MASK
;

129 
	`»ad_·ge
(
dd
, 
»ad_¡¬t
, 
bufãr
);

132 
by‹s
 = 
EP_PAGE_SIZE
 - 
¡¬t_off£t
;

134 ià(
Ën
 <ð
by‹s
) {

136 
	`memýy
(
de¡
, (
u8
 *)
bufãr
 + 
¡¬t_off£t
, 
Ën
);

140 
	`memýy
(
de¡
, (
u8
 *)
bufãr
 + 
¡¬t_off£t
, 
by‹s
);

142 
¡¬t
 +ð
by‹s
;

143 
Ën
 -ð
by‹s
;

144 
de¡
 +ð
by‹s
;

149 
Ën
 >ð
EP_PAGE_SIZE
) {

150 
	`»ad_·ge
(
dd
, 
¡¬t
, 
bufãr
);

151 
	`memýy
(
de¡
, 
bufãr
, 
EP_PAGE_SIZE
);

153 
¡¬t
 +ð
EP_PAGE_SIZE
;

154 
Ën
 -ð
EP_PAGE_SIZE
;

155 
de¡
 +ð
EP_PAGE_SIZE
;

159 ià(
Ën
) {

160 
	`»ad_·ge
(
dd
, 
¡¬t
, 
bufãr
);

161 
	`memýy
(
de¡
, 
bufãr
, 
Ën
);

165 
	}
}

170 
	$•rom_š™
(
hfi1_devd©a
 *
dd
)

172 
»t
 = 0;

175 ià(
dd
->
pcidev
->
deviû
 !ð
PCI_DEVICE_ID_INTEL0
)

182 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_EPROM
, 
EPROM_TIMEOUT
);

183 ià(
»t
) {

184 
	`dd_dev_”r
(
dd
,

186 
__func__
);

187 
dÚe_asic
;

193 
	`wr™e_c¤
(
dd
, 
ASIC_EEP_CTL_STAT
, 
ASIC_EEP_CTL_STAT_EP_RESET_SMASK
);

195 
	`wr™e_c¤
(
dd
, 
ASIC_EEP_CTL_STAT
,

196 
EP_SPEED_FULL
 << 
ASIC_EEP_CTL_STAT_RATE_SPI_SHIFT
);

199 
	`wr™e_c¤
(
dd
, 
ASIC_EEP_ADDR_CMD
, 
CMD_RELEASE_POWERDOWN_NOID
);

201 
dd
->
•rom_avažabË
 = 
Œue
;

202 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_EPROM
);

203 
dÚe_asic
:

204  
»t
;

205 
	}
}

208 
	#IMAGE_START_MAGIC
 "APO="

	)

211 
	#IMAGE_TRAIL_MAGIC
 "egamiAPO"

	)

214 
	#HFI1_EFT_PLATFORM_CONFIG
 2

	)

217 
	#SEG_SIZE
 (128 * 1024)

	)

219 
	shfi1_•rom_foÙ”
 {

220 
u32
 
	mÝrom_size
;

221 
u16
 
	mnum_bË_’Œ›s
;

222 
u16
 
	mv”siÚ
;

223 
u32
 
	mmagic
;

226 
	shfi1_•rom_bË_’Œy
 {

227 
u32
 
	mty³
;

228 
u32
 
	moff£t
;

229 
u32
 
	msize
;

236 
	#MAX_TABLE_ENTRIES
(
dœ_size
) \

237 (((
dœ_size
è- (
hfi1_•rom_foÙ”
)) / \

238 (
hfi1_•rom_bË_’Œy
))

	)

240 
	#DIRECTORY_SIZE
(
n
è((
hfi1_•rom_foÙ”
) + \

241 ((
hfi1_•rom_bË_’Œy
è* (
n
)))

	)

243 
	#MAGIC4
(
a
, 
b
, 
c
, 
d
è((dè<< 24 | (cè<< 16 | (bè<< 8 | (a))

	)

244 
	#FOOTER_MAGIC
 
	`MAGIC4
('e', 'p', 'r', 'm')

	)

245 
	#FOOTER_VERSION
 1

	)

251 
	$»ad_·¹™iÚ_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
, **
d©a
,

252 
u32
 *
size
)

254 *
bufãr
;

255 *
p
;

256 
u32
 
Ëngth
;

257 
»t
;

259 
bufãr
 = 
	`km®loc
(
P1_SIZE
, 
GFP_KERNEL
);

260 ià(!
bufãr
)

261  -
ENOMEM
;

263 
»t
 = 
	`»ad_Ëngth
(
dd
, 
P1_START
, 
P1_SIZE
, 
bufãr
);

264 ià(
»t
) {

265 
	`kä“
(
bufãr
);

266  
»t
;

270 ià(
	`memcmp
(
bufãr
, 
IMAGE_START_MAGIC
, 
	`¡¾’
(IMAGE_START_MAGIC))) {

271 
	`kä“
(
bufãr
);

272  -
ENOENT
;

276 
p
 = 
	`¡º¡r
(
bufãr
, 
IMAGE_TRAIL_MAGIC
, 
P1_SIZE
);

277 ià(
p
)

278 
Ëngth
 = 
p
 - 
bufãr
;

280 
Ëngth
 = 
P1_SIZE
;

282 *
d©a
 = 
bufãr
;

283 *
size
 = 
Ëngth
;

285 
	}
}

293 
	$»ad_£gm’t_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
,

294 *
dœeùÜy
, **
d©a
, 
u32
 *
size
)

296 
hfi1_•rom_foÙ”
 *
foÙ”
;

297 
hfi1_•rom_bË_’Œy
 *
bË
;

298 
hfi1_•rom_bË_’Œy
 *
’Œy
;

299 *
bufãr
 = 
NULL
;

300 *
bË_bufãr
 = 
NULL
;

301 
»t
, 
i
;

302 
u32
 
dœeùÜy_size
;

303 
u32
 
£g_ba£
, 
£g_off£t
;

304 
u32
 
by‹s_avažabË
, 
ncÝ›d
, 
to_cÝy
;

307 
foÙ”
 = (
hfi1_•rom_foÙ”
 *)

308 (
dœeùÜy
 + 
EP_PAGE_SIZE
 - (*
foÙ”
));

311 ià(
foÙ”
->
v”siÚ
 !ð
FOOTER_VERSION
)

312  -
EINVAL
;

315 ià(
foÙ”
->
Ýrom_size
 >ð
SEG_SIZE
)

316  -
EINVAL
;

319 ià(
foÙ”
->
num_bË_’Œ›s
 >

320 
	`MAX_TABLE_ENTRIES
(
SEG_SIZE
 - 
foÙ”
->
Ýrom_size
))

321  -
EINVAL
;

324 
dœeùÜy_size
 = 
	`DIRECTORY_SIZE
(
foÙ”
->
num_bË_’Œ›s
);

325 ià(
dœeùÜy_size
 <ð
EP_PAGE_SIZE
) {

327 
bË
 = (
hfi1_•rom_bË_’Œy
 *)

328 (
dœeùÜy
 + 
EP_PAGE_SIZE
 - 
dœeùÜy_size
);

331 
bË_bufãr
 = 
	`km®loc
(
dœeùÜy_size
, 
GFP_KERNEL
);

332 ià(!
bË_bufãr
)

333  -
ENOMEM
;

334 
»t
 = 
	`»ad_Ëngth
(
dd
, 
SEG_SIZE
 - 
dœeùÜy_size
,

335 
dœeùÜy_size
, 
bË_bufãr
);

336 ià(
»t
)

337 
dÚe
;

338 
bË
 = 
bË_bufãr
;

342 
’Œy
 = 
NULL
, 
i
 = 0; i < 
foÙ”
->
num_bË_’Œ›s
; i++) {

343 ià(
bË
[
i
].
ty³
 =ð
HFI1_EFT_PLATFORM_CONFIG
) {

344 
’Œy
 = &
bË
[
i
];

348 ià(!
’Œy
) {

349 
»t
 = -
ENOENT
;

350 
dÚe
;

357 ià(
’Œy
->
size
 > (4 * 1024)) {

358 
	`dd_dev_”r
(
dd
, "Bad configuration file size 0x%x\n",

359 
’Œy
->
size
);

360 
»t
 = -
EINVAL
;

361 
dÚe
;

365 ià(
’Œy
->
off£t
 +ƒÁry->
size
 <ƒntry->offset) {

366 
	`dd_dev_”r
(
dd
,

368 
’Œy
->
off£t
,ƒÁry->
size
);

369 
»t
 = -
EINVAL
;

370 
dÚe
;

374 
bufãr
 = 
	`km®loc
(
’Œy
->
size
, 
GFP_KERNEL
);

375 ià(!
bufãr
) {

376 
»t
 = -
ENOMEM
;

377 
dÚe
;

383 
£g_off£t
 = 
’Œy
->
off£t
 % 
SEG_SIZE
;

384 
£g_ba£
 = 
’Œy
->
off£t
 - 
£g_off£t
;

385 
ncÝ›d
 = 0;

386 
ncÝ›d
 < 
’Œy
->
size
) {

390 
by‹s_avažabË
 = 
SEG_SIZE
 - 
£g_off£t
;

392 ià(
£g_ba£
 == 0) {

397 ià(
by‹s_avažabË
 <ð
dœeùÜy_size
) {

398 
	`dd_dev_”r
(
dd
,

400 
’Œy
->
off£t
);

401 
»t
 = -
EINVAL
;

402 
dÚe
;

404 
by‹s_avažabË
 -ð
dœeùÜy_size
;

408 
to_cÝy
 = 
’Œy
->
size
 - 
ncÝ›d
;

411 ià(
to_cÝy
 > 
by‹s_avažabË
)

412 
to_cÝy
 = 
by‹s_avažabË
;

424 
»t
 = 
	`»ad_Ëngth
(
dd
, 
£g_ba£
 + 
£g_off£t
, 
to_cÝy
,

425 
bufãr
 + 
ncÝ›d
);

426 ià(
»t
)

427 
dÚe
;

429 
ncÝ›d
 +ð
to_cÝy
;

432 
£g_off£t
 = 
foÙ”
->
Ýrom_size
;

433 
£g_ba£
 +ð
SEG_SIZE
;

437 
»t
 = 0;

438 *
d©a
 = 
bufãr
;

439 *
size
 = 
’Œy
->size;

441 
dÚe
:

442 
	`kä“
(
bË_bufãr
);

443 ià(
»t
)

444 
	`kä“
(
bufãr
);

445  
»t
;

446 
	}
}

462 
	$•rom_»ad_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
, **
d©a
, 
u32
 *
size
)

464 
u32
 
dœeùÜy
[
EP_PAGE_DWORDS
];

465 
»t
;

467 ià(!
dd
->
•rom_avažabË
)

468  -
ENXIO
;

470 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_EPROM
, 
EPROM_TIMEOUT
);

471 ià(
»t
)

472  -
EBUSY
;

475 
»t
 = 
	`»ad_Ëngth
(
dd
, 
SEG_SIZE
 - 
EP_PAGE_SIZE
, EP_PAGE_SIZE, 
dœeùÜy
);

476 ià(
»t
)

477 
dÚe
;

480 ià(
dœeùÜy
[
EP_PAGE_DWORDS
 - 1] =ð
FOOTER_MAGIC
) {

482 
»t
 = 
	`»ad_£gm’t_¶©fÜm_cÚfig
(
dd
, 
dœeùÜy
, 
d©a
, 
size
);

485 
»t
 = 
	`»ad_·¹™iÚ_¶©fÜm_cÚfig
(
dd
, 
d©a
, 
size
);

488 
dÚe
:

489 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_EPROM
);

490  
»t
;

491 
	}
}

	@eprom.h

48 
	ghfi1_devd©a
;

50 
•rom_š™
(
hfi1_devd©a
 *
dd
);

51 
•rom_»ad_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
, **
buf_»t
,

52 
u32
 *
size_»t
);

	@exp_rcv.c

48 
	~"exp_rcv.h
"

49 
	~"Œaû.h
"

55 
	$hfi1_exp_tid_£t_š™
(
exp_tid_£t
 *
£t
)

57 
	`INIT_LIST_HEAD
(&
£t
->
li¡
);

58 
£t
->
couÁ
 = 0;

59 
	}
}

65 
	$hfi1_exp_tid_group_š™
(
hfi1_ùxtd©a
 *
rcd
)

67 
	`hfi1_exp_tid_£t_š™
(&
rcd
->
tid_group_li¡
);

68 
	`hfi1_exp_tid_£t_š™
(&
rcd
->
tid_u£d_li¡
);

69 
	`hfi1_exp_tid_£t_š™
(&
rcd
->
tid_fuÎ_li¡
);

70 
	}
}

76 
	$hfi1_®loc_ùxt_rcv_groups
(
hfi1_ùxtd©a
 *
rcd
)

78 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

79 
u32
 
tidba£
;

80 
tid_group
 *
g½
;

81 
i
;

82 
u32
 
ngroups
;

84 
ngroups
 = 
rcd
->
ex³ùed_couÁ
 / 
dd
->
rcv_’Œ›s
.
group_size
;

85 
rcd
->
groups
 =

86 
	`kÿÎoc_node
(
ngroups
, (*
rcd
->
groups
),

87 
GFP_KERNEL
, 
rcd
->
numa_id
);

88 ià(!
rcd
->
groups
)

89  -
ENOMEM
;

90 
tidba£
 = 
rcd
->
ex³ùed_ba£
;

91 
i
 = 0; i < 
ngroups
; i++) {

92 
g½
 = &
rcd
->
groups
[
i
];

93 
g½
->
size
 = 
dd
->
rcv_’Œ›s
.
group_size
;

94 
g½
->
ba£
 = 
tidba£
;

95 
	`tid_group_add_ž
(
g½
, &
rcd
->
tid_group_li¡
);

96 
tidba£
 +ð
dd
->
rcv_’Œ›s
.
group_size
;

100 
	}
}

113 
	$hfi1_ä“_ùxt_rcv_groups
(
hfi1_ùxtd©a
 *
rcd
)

115 
	`kä“
(
rcd
->
groups
);

116 
rcd
->
groups
 = 
NULL
;

117 
	`hfi1_exp_tid_group_š™
(
rcd
);

119 
	`hfi1_þ—r_tids
(
rcd
);

120 
	}
}

	@exp_rcv.h

1 #iâdeà
_HFI1_EXP_RCV_H


2 
	#_HFI1_EXP_RCV_H


	)

50 
	~"hfi.h
"

52 
	#EXP_TID_SET_EMPTY
(
£t
è(£t.
couÁ
 =ð0 && 
	`li¡_em±y
(&£t.
li¡
))

	)

54 
	#EXP_TID_TIDLEN_MASK
 0x7FFULL

	)

55 
	#EXP_TID_TIDLEN_SHIFT
 0

	)

56 
	#EXP_TID_TIDCTRL_MASK
 0x3ULL

	)

57 
	#EXP_TID_TIDCTRL_SHIFT
 20

	)

58 
	#EXP_TID_TIDIDX_MASK
 0x3FFULL

	)

59 
	#EXP_TID_TIDIDX_SHIFT
 22

	)

60 
	#EXP_TID_GET
(
tid
, 
f›ld
) \

61 (((
tid
è>> 
EXP_TID_TID
##
f›ld
##
_SHIFT
è& EXP_TID_TID##f›ld##
_MASK
)

	)

63 
	#EXP_TID_SET
(
f›ld
, 
v®ue
) \

64 (((
v®ue
è& 
EXP_TID_TID
##
f›ld
##
_MASK
) << \

65 
EXP_TID_TID
##
f›ld
##
_SHIFT
)

	)

66 
	#EXP_TID_CLEAR
(
tid
, 
f›ld
) ({ \

67 (
tid
è&ð~(
EXP_TID_TID
##
f›ld
##
_MASK
 << \

68 
EXP_TID_TID
##
f›ld
##
_SHIFT
); \

69 })

	)

70 
	#EXP_TID_RESET
(
tid
, 
f›ld
, 
v®ue
) do { \

71 
	`EXP_TID_CLEAR
(
tid
, 
f›ld
); \

72 (
tid
è|ð
	`EXP_TID_SET
(
f›ld
, (
v®ue
)); \

73 } 0)

	)

79 
	#KDETH_OFFSET_SHIFT
 0

	)

80 
	#KDETH_OFFSET_MASK
 0x7fff

	)

81 
	#KDETH_OM_SHIFT
 15

	)

82 
	#KDETH_OM_MASK
 0x1

	)

83 
	#KDETH_TID_SHIFT
 16

	)

84 
	#KDETH_TID_MASK
 0x3ff

	)

85 
	#KDETH_TIDCTRL_SHIFT
 26

	)

86 
	#KDETH_TIDCTRL_MASK
 0x3

	)

87 
	#KDETH_INTR_SHIFT
 28

	)

88 
	#KDETH_INTR_MASK
 0x1

	)

89 
	#KDETH_SH_SHIFT
 29

	)

90 
	#KDETH_SH_MASK
 0x1

	)

91 
	#KDETH_KVER_SHIFT
 30

	)

92 
	#KDETH_KVER_MASK
 0x3

	)

93 
	#KDETH_JKEY_SHIFT
 0x0

	)

94 
	#KDETH_JKEY_MASK
 0xff

	)

95 
	#KDETH_HCRC_UPPER_SHIFT
 16

	)

96 
	#KDETH_HCRC_UPPER_MASK
 0xff

	)

97 
	#KDETH_HCRC_LOWER_SHIFT
 24

	)

98 
	#KDETH_HCRC_LOWER_MASK
 0xff

	)

100 
	#KDETH_GET
(
v®
, 
f›ld
) \

101 (((
	`Ë32_to_ýu
((
v®
))è>> 
KDETH_
##
f›ld
##
_SHIFT
è& KDETH_##f›ld##
_MASK
)

	)

102 
	#KDETH_SET
(
dw
, 
f›ld
, 
v®
) do { \

103 
u32
 
dwv®
 = 
	`Ë32_to_ýu
(
dw
); \

104 
dwv®
 &ð~(
KDETH_
##
f›ld
##
_MASK
 << KDETH_##f›ld##
_SHIFT
); \

105 
dwv®
 |ð(((
v®
è& 
KDETH_
##
f›ld
##
_MASK
) << \

106 
KDETH_
##
f›ld
##
_SHIFT
); \

107 
dw
 = 
	`ýu_to_Ë32
(
dwv®
); \

108 } 0)

	)

110 
	#KDETH_RESET
(
dw
, 
f›ld
, 
v®
è({ dw = 0; 
	`KDETH_SET
(dw, f›ld, v®); })

	)

113 
	#KDETH_OM_SMALL
 4

	)

114 
	#KDETH_OM_SMALL_SHIFT
 2

	)

115 
	#KDETH_OM_LARGE
 64

	)

116 
	#KDETH_OM_LARGE_SHIFT
 6

	)

117 
	#KDETH_OM_MAX_SIZE
 (1 << ((
KDETH_OM_LARGE
 / 
KDETH_OM_SMALL
è+ 1))

	)

119 
	stid_group
 {

120 
li¡_h—d
 
	mli¡
;

121 
u32
 
	mba£
;

122 
u8
 
	msize
;

123 
u8
 
	mu£d
;

124 
u8
 
	mm­
;

134 
šlše
 
	$rcv_¬¿y_wc_fžl
(
hfi1_devd©a
 *
dd
, 
u32
 
šdex
)

140 ià((
dd
->
æags
 & 
HFI1_PRESENT
è&& dd->
rcv¬¿y_wc
) {

141 
	`wr™eq
(0, 
dd
->
rcv¬¿y_wc
 + (
šdex
 * 8));

142 ià((
šdex
 & 3) == 3)

143 
	`æush_wc
();

145 
	}
}

147 
šlše
 
	$tid_group_add_ž
(
tid_group
 *
g½
,

148 
exp_tid_£t
 *
£t
)

150 
	`li¡_add_ž
(&
g½
->
li¡
, &
£t
->list);

151 
£t
->
couÁ
++;

152 
	}
}

154 
šlše
 
	$tid_group_»move
(
tid_group
 *
g½
,

155 
exp_tid_£t
 *
£t
)

157 
	`li¡_d–_š™
(&
g½
->
li¡
);

158 
£t
->
couÁ
--;

159 
	}
}

161 
šlše
 
	$tid_group_move
(
tid_group
 *
group
,

162 
exp_tid_£t
 *
s1
,

163 
exp_tid_£t
 *
s2
)

165 
	`tid_group_»move
(
group
, 
s1
);

166 
	`tid_group_add_ž
(
group
, 
s2
);

167 
	}
}

169 
šlše
 
tid_group
 *
	$tid_group_pÝ
(
exp_tid_£t
 *
£t
)

171 
tid_group
 *
g½
 =

172 
	`li¡_fœ¡_’Œy
(&
£t
->
li¡
, 
tid_group
,†ist);

173 
	`li¡_d–_š™
(&
g½
->
li¡
);

174 
£t
->
couÁ
--;

175  
g½
;

176 
	}
}

178 
šlše
 
u32
 
	$rcv’Œy2tidšfo
(
u32
 
rcv’Œy
)

180 
u32
 
·œ
 = 
rcv’Œy
 & ~0x1;

182  
	`EXP_TID_SET
(
IDX
, 
·œ
 >> 1) |

183 
	`EXP_TID_SET
(
CTRL
, 1 << (
rcv’Œy
 - 
·œ
));

184 
	}
}

191 
šlše
 
u16


192 
	$hfi1_tid_group_to_idx
(
hfi1_ùxtd©a
 *
rcd
, 
tid_group
 *
g½
)

194  
g½
 - &
rcd
->
groups
[0];

195 
	}
}

202 
šlše
 
tid_group
 *

203 
	$hfi1_idx_to_tid_group
(
hfi1_ùxtd©a
 *
rcd
, 
u16
 
idx
)

205  &
rcd
->
groups
[
idx
];

206 
	}
}

208 
hfi1_®loc_ùxt_rcv_groups
(
hfi1_ùxtd©a
 *
rcd
);

209 
hfi1_ä“_ùxt_rcv_groups
(
hfi1_ùxtd©a
 *
rcd
);

210 
hfi1_exp_tid_group_š™
(
hfi1_ùxtd©a
 *
rcd
);

	@fault.c

47 
	~<lšux/debugfs.h
>

48 
	~<lšux/£q_fže.h
>

49 
	~<lšux/k”Ãl.h
>

50 
	~<lšux/moduË.h
>

51 
	~<lšux/ty³s.h
>

52 
	~<lšux/b™m­.h
>

54 
	~"debugfs.h
"

55 
	~"çuÉ.h
"

56 
	~"Œaû.h
"

58 
	#HFI1_FAULT_DIR_TX
 
	`BIT
(0)

	)

59 
	#HFI1_FAULT_DIR_RX
 
	`BIT
(1)

	)

60 
	#HFI1_FAULT_DIR_TXRX
 (
HFI1_FAULT_DIR_TX
 | 
HFI1_FAULT_DIR_RX
)

	)

62 *
	$_çuÉ_¡©s_£q_¡¬t
(
£q_fže
 *
s
, 
loff_t
 *
pos
)

64 
hfi1_Ýcode_¡©s_³rùx
 *
Ý¡©s
;

66 ià(*
pos
 >ð
	`ARRAY_SIZE
(
Ý¡©s
->
¡©s
))

67  
NULL
;

68  
pos
;

69 
	}
}

71 *
	$_çuÉ_¡©s_£q_Ãxt
(
£q_fže
 *
s
, *
v
, 
loff_t
 *
pos
)

73 
hfi1_Ýcode_¡©s_³rùx
 *
Ý¡©s
;

75 ++*
pos
;

76 ià(*
pos
 >ð
	`ARRAY_SIZE
(
Ý¡©s
->
¡©s
))

77  
NULL
;

78  
pos
;

79 
	}
}

81 
	$_çuÉ_¡©s_£q_¡Ý
(
£q_fže
 *
s
, *
v
)

83 
	}
}

85 
	$_çuÉ_¡©s_£q_show
(
£q_fže
 *
s
, *
v
)

87 
loff_t
 *
¥os
 = 
v
;

88 
loff_t
 
i
 = *
¥os
, 
j
;

89 
u64
 
n_·ck‘s
 = 0, 
n_by‹s
 = 0;

90 
hfi1_ibdev
 *
ibd
 = (hfi1_ibdev *)
s
->
´iv©e
;

91 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
ibd
);

92 
hfi1_ùxtd©a
 *
rcd
;

94 
j
 = 0; j < 
dd
->
fœ¡_dyn_®loc_ùxt
; j++) {

95 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
j
);

96 ià(
rcd
) {

97 
n_·ck‘s
 +ð
rcd
->
Ý¡©s
->
¡©s
[
i
].n_packets;

98 
n_by‹s
 +ð
rcd
->
Ý¡©s
->
¡©s
[
i
].n_bytes;

100 
	`hfi1_rcd_put
(
rcd
);

102 
	`fÜ_—ch_possibË_ýu
(
j
) {

103 
hfi1_Ýcode_¡©s_³rùx
 *
¥
 =

104 
	`³r_ýu_±r
(
dd
->
tx_Ý¡©s
, 
j
);

106 
n_·ck‘s
 +ð
¥
->
¡©s
[
i
].n_packets;

107 
n_by‹s
 +ð
¥
->
¡©s
[
i
].n_bytes;

109 ià(!
n_·ck‘s
 && !
n_by‹s
)

110  
SEQ_SKIP
;

111 ià(!
ibd
->
çuÉ
->
n_rxçuÉs
[
i
] && !ibd->çuÉ->
n_txçuÉs
[i])

112  
SEQ_SKIP
;

113 
	`£q_´štf
(
s
, "%02Îx %Îu/%Îu (çuÉ rx:%Îu fauÉs:x:%Îu)\n", 
i
,

114 ()
n_·ck‘s
,

115 ()
n_by‹s
,

116 ()
ibd
->
çuÉ
->
n_rxçuÉs
[
i
],

117 ()
ibd
->
çuÉ
->
n_txçuÉs
[
i
]);

119 
	}
}

121 
DEBUGFS_SEQ_FILE_OPS
(
çuÉ_¡©s
);

122 
DEBUGFS_SEQ_FILE_OPEN
(
çuÉ_¡©s
);

123 
DEBUGFS_FILE_OPS
(
çuÉ_¡©s
);

125 
	$çuÉ_Ýcodes_Ý’
(
šode
 *šode, 
fže
 *file)

127 
fže
->
´iv©e_d©a
 = 
šode
->
i_´iv©e
;

128  
	`nÚ£ekabË_Ý’
(
šode
, 
fže
);

129 
	}
}

131 
ssize_t
 
	$çuÉ_Ýcodes_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

132 
size_t
 
Ën
, 
loff_t
 *
pos
)

134 
ssize_t
 
»t
 = 0;

136 
size_t
 
cÝy
, 
d©®’
 = 1280;

137 *
d©a
, *
tok’
, *
±r
, *
’d
;

138 
çuÉ
 *çuÉ = 
fže
->
´iv©e_d©a
;

140 
d©a
 = 
	`kÿÎoc
(
d©®’
, (*d©a), 
GFP_KERNEL
);

141 ià(!
d©a
)

142  -
ENOMEM
;

143 
cÝy
 = 
	`mš
(
Ën
, 
d©®’
 - 1);

144 ià(
	`cÝy_äom_u£r
(
d©a
, 
buf
, 
cÝy
)) {

145 
»t
 = -
EFAULT
;

146 
ä“_d©a
;

149 
»t
 = 
	`debugfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
);

150 ià(
	`uÆik–y
(
»t
))

151 
ä“_d©a
;

152 
±r
 = 
d©a
;

153 
tok’
 = 
±r
;

154 
±r
 = 
d©a
; *±r;…Œ = 
’d
 + 1, 
tok’
 =…tr) {

155 *
dash
;

156 
¿nge_¡¬t
, 
¿nge_’d
, 
i
;

157 
boÞ
 
»move
 = 
çl£
;

158 
bound
 = 1U << 
BITS_PER_BYTE
;

160 
’d
 = 
	`¡rchr
(
±r
, ',');

161 ià(
’d
)

162 *
’d
 = '\0';

163 ià(
tok’
[0] == '-') {

164 
»move
 = 
Œue
;

165 
tok’
++;

167 
dash
 = 
	`¡rchr
(
tok’
, '-');

168 ià(
dash
)

169 *
dash
 = '\0';

170 ià(
	`k¡¹oul
(
tok’
, 0, &
¿nge_¡¬t
))

172 ià(
dash
) {

173 
tok’
 = 
dash
 + 1;

174 ià(
	`k¡¹oul
(
tok’
, 0, &
¿nge_’d
))

177 
¿nge_’d
 = 
¿nge_¡¬t
;

179 ià(
¿nge_¡¬t
 =ð
¿nge_’d
 &&„ange_start == -1UL) {

180 
	`b™m­_z”o
(
çuÉ
->
Ýcodes
, (fault->opcodes) *

181 
BITS_PER_BYTE
);

185 ià(
¿nge_¡¬t
 >ð
bound
 || 
¿nge_’d
 >= bound)

188 
i
 = 
¿nge_¡¬t
; i <ð
¿nge_’d
; i++) {

189 ià(
»move
)

190 
	`þ—r_b™
(
i
, 
çuÉ
->
Ýcodes
);

192 
	`£t_b™
(
i
, 
çuÉ
->
Ýcodes
);

194 ià(!
’d
)

197 
»t
 = 
Ën
;

199 
	`debugfs_fže_put
(
fže
->
f_·th
.
d’Œy
);

200 
ä“_d©a
:

201 
	`kä“
(
d©a
);

202  
»t
;

203 
	}
}

205 
ssize_t
 
	$çuÉ_Ýcodes_»ad
(
fže
 *fže, 
__u£r
 *
buf
,

206 
size_t
 
Ën
, 
loff_t
 *
pos
)

208 
ssize_t
 
»t
 = 0;

209 *
d©a
;

210 
size_t
 
d©®’
 = 1280, 
size
 = 0;

211 
b™
 = 0, 
z”o
 = 0;

212 
çuÉ
 *çuÉ = 
fže
->
´iv©e_d©a
;

213 
size_t
 
b™size
 = (
çuÉ
->
Ýcodes
è* 
BITS_PER_BYTE
;

215 
d©a
 = 
	`kÿÎoc
(
d©®’
, (*d©a), 
GFP_KERNEL
);

216 ià(!
d©a
)

217  -
ENOMEM
;

218 
»t
 = 
	`debugfs_fže_g‘
(
fže
->
f_·th
.
d’Œy
);

219 ià(
	`uÆik–y
(
»t
))

220 
ä“_d©a
;

221 
b™
 = 
	`fšd_fœ¡_b™
(
çuÉ
->
Ýcodes
, 
b™size
);

222 
b™
 < 
b™size
) {

223 
z”o
 = 
	`fšd_Ãxt_z”o_b™
(
çuÉ
->
Ýcodes
, 
b™size
, 
b™
);

224 ià(
z”o
 - 1 !ð
b™
)

225 
size
 +ð
	`¢´štf
(
d©a
 + size,

226 
d©®’
 - 
size
 - 1,

227 "0x%lx-0x%lx,", 
b™
, 
z”o
 - 1);

229 
size
 +ð
	`¢´štf
(
d©a
 + size,

230 
d©®’
 - 
size
 - 1, "0x%lx,",

231 
b™
);

232 
b™
 = 
	`fšd_Ãxt_b™
(
çuÉ
->
Ýcodes
, 
b™size
, 
z”o
);

234 
	`debugfs_fže_put
(
fže
->
f_·th
.
d’Œy
);

235 
d©a
[
size
 - 1] = '\n';

236 
d©a
[
size
] = '\0';

237 
»t
 = 
	`sim¶e_»ad_äom_bufãr
(
buf
, 
Ën
, 
pos
, 
d©a
, 
size
);

238 
ä“_d©a
:

239 
	`kä“
(
d©a
);

240  
»t
;

241 
	}
}

243 cÚ¡ 
fže_Ý”©iÚs
 
	g__çuÉ_Ýcodes_fÝs
 = {

244 .
owÃr
 = 
THIS_MODULE
,

245 .
	gÝ’
 = 
çuÉ_Ýcodes_Ý’
,

246 .
	g»ad
 = 
çuÉ_Ýcodes_»ad
,

247 .
	gwr™e
 = 
çuÉ_Ýcodes_wr™e
,

248 .
	gÎ£ek
 = 
no_Î£ek


251 
	$hfi1_çuÉ_ex™_debugfs
(
hfi1_ibdev
 *
ibd
)

253 ià(
ibd
->
çuÉ
)

254 
	`debugfs_»move_»cursive
(
ibd
->
çuÉ
->
dœ
);

255 
	`kä“
(
ibd
->
çuÉ
);

256 
ibd
->
çuÉ
 = 
NULL
;

257 
	}
}

259 
	$hfi1_çuÉ_š™_debugfs
(
hfi1_ibdev
 *
ibd
)

261 
d’Œy
 *
·»Á
 = 
ibd
->
hfi1_ibdev_dbg
;

262 
d’Œy
 *
çuÉ_dœ
;

264 
ibd
->
çuÉ
 = 
	`kz®loc
((*ibd->çuÉ), 
GFP_KERNEL
);

265 ià(!
ibd
->
çuÉ
)

266  -
ENOMEM
;

268 
ibd
->
çuÉ
->
©Œ
.
š‹rv®
 = 1;

269 
ibd
->
çuÉ
->
©Œ
.
»quœe_’d
 = 
ULONG_MAX
;

270 
ibd
->
çuÉ
->
©Œ
.
¡ackŒaû_d•th
 = 32;

271 
ibd
->
çuÉ
->
©Œ
.
dÇme
 = 
NULL
;

272 
ibd
->
çuÉ
->
©Œ
.
v”bo£
 = 0;

273 
ibd
->
çuÉ
->
’abË
 = 
çl£
;

274 
ibd
->
çuÉ
->
Ýcode
 = 
çl£
;

275 
ibd
->
çuÉ
->
çuÉ_sk
 = 0;

276 
ibd
->
çuÉ
->
sk
 = 0;

277 
ibd
->
çuÉ
->
dœeùiÚ
 = 
HFI1_FAULT_DIR_TXRX
;

278 
ibd
->
çuÉ
->
suµ»ss_”r
 = 
çl£
;

279 
	`b™m­_z”o
(
ibd
->
çuÉ
->
Ýcodes
,

280 (
ibd
->
çuÉ
->
Ýcodes
è* 
BITS_PER_BYTE
);

282 
çuÉ_dœ
 =

283 
	`çuÉ_ü—‹_debugfs_©Œ
("çuÉ", 
·»Á
, &
ibd
->
çuÉ
->
©Œ
);

284 ià(
	`IS_ERR
(
çuÉ_dœ
)) {

285 
	`kä“
(
ibd
->
çuÉ
);

286 
ibd
->
çuÉ
 = 
NULL
;

287  -
ENOENT
;

289 
ibd
->
çuÉ
->
dœ
 = 
çuÉ_dœ
;

291 
	`debugfs_ü—‹_fže
("çuÉ_¡©s", 0444, 
çuÉ_dœ
, 
ibd
,

292 &
_çuÉ_¡©s_fže_Ýs
);

293 
	`debugfs_ü—‹_boÞ
("’abË", 0600, 
çuÉ_dœ
, &
ibd
->
çuÉ
->
’abË
);

294 
	`debugfs_ü—‹_boÞ
("suµ»ss_”r", 0600, 
çuÉ_dœ
,

295 &
ibd
->
çuÉ
->
suµ»ss_”r
);

296 
	`debugfs_ü—‹_boÞ
("Ýcode_mode", 0600, 
çuÉ_dœ
,

297 &
ibd
->
çuÉ
->
Ýcode
);

298 
	`debugfs_ü—‹_fže
("Ýcodes", 0600, 
çuÉ_dœ
, 
ibd
->
çuÉ
,

299 &
__çuÉ_Ýcodes_fÝs
);

300 
	`debugfs_ü—‹_u64
("sk_pkts", 0600, 
çuÉ_dœ
,

301 &
ibd
->
çuÉ
->
çuÉ_sk
);

302 
	`debugfs_ü—‹_u64
("sk_u£c", 0600, 
çuÉ_dœ
,

303 &
ibd
->
çuÉ
->
çuÉ_sk_u£c
);

304 
	`debugfs_ü—‹_u8
("dœeùiÚ", 0600, 
çuÉ_dœ
, &
ibd
->
çuÉ
->
dœeùiÚ
);

307 
	}
}

309 
boÞ
 
	$hfi1_dbg_çuÉ_suµ»ss_”r
(
hfi1_ibdev
 *
ibd
)

311 ià(
ibd
->
çuÉ
)

312  
ibd
->
çuÉ
->
suµ»ss_”r
;

313  
çl£
;

314 
	}
}

316 
boÞ
 
	$__hfi1_should_çuÉ
(
hfi1_ibdev
 *
ibd
, 
u32
 
Ýcode
,

317 
u8
 
dœeùiÚ
)

319 
boÞ
 
»t
 = 
çl£
;

321 ià(!
ibd
->
çuÉ
 || !ibd->çuÉ->
’abË
)

322  
çl£
;

323 ià(!(
ibd
->
çuÉ
->
dœeùiÚ
 & direction))

324  
çl£
;

325 ià(
ibd
->
çuÉ
->
Ýcode
) {

326 ià(
	`b™m­_em±y
(
ibd
->
çuÉ
->
Ýcodes
,

327 ((
ibd
->
çuÉ
->
Ýcodes
) *

328 
BITS_PER_BYTE
)))

329  
çl£
;

330 ià(!(
	`‹¡_b™
(
Ýcode
, 
ibd
->
çuÉ
->
Ýcodes
)))

331  
çl£
;

333 ià(
ibd
->
çuÉ
->
çuÉ_sk_u£c
 &&

334 
	`time_befÜe
(
jiff›s
, 
ibd
->
çuÉ
->
sk_u£c
))

335  
çl£
;

336 ià(
ibd
->
çuÉ
->
çuÉ_sk
 && ibd->çuÉ->
sk
) {

337 
ibd
->
çuÉ
->
sk
--;

338  
çl£
;

340 
»t
 = 
	`should_çž
(&
ibd
->
çuÉ
->
©Œ
, 1);

341 ià(
»t
) {

342 
ibd
->
çuÉ
->
sk
 = ibd->çuÉ->
çuÉ_sk
;

343 
ibd
->
çuÉ
->
sk_u£c
 = 
jiff›s
 +

344 
	`u£cs_to_jiff›s
(
ibd
->
çuÉ
->
çuÉ_sk_u£c
);

346  
»t
;

347 
	}
}

349 
boÞ
 
	$hfi1_dbg_should_çuÉ_tx
(
rvt_qp
 *
qp
, 
u32
 
Ýcode
)

351 
hfi1_ibdev
 *
ibd
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

353 ià(
	`__hfi1_should_çuÉ
(
ibd
, 
Ýcode
, 
HFI1_FAULT_DIR_TX
)) {

354 
	`Œaû_hfi1_çuÉ_Ýcode
(
qp
, 
Ýcode
);

355 
ibd
->
çuÉ
->
n_txçuÉs
[
Ýcode
]++;

356  
Œue
;

358  
çl£
;

359 
	}
}

361 
boÞ
 
	$hfi1_dbg_should_çuÉ_rx
(
hfi1_·ck‘
 *
·ck‘
)

363 
hfi1_ibdev
 *
ibd
 = &
·ck‘
->
rcd
->
dd
->
v”bs_dev
;

365 ià(
	`__hfi1_should_çuÉ
(
ibd
, 
·ck‘
->
Ýcode
, 
HFI1_FAULT_DIR_RX
)) {

366 
	`Œaû_hfi1_çuÉ_·ck‘
(
·ck‘
);

367 
ibd
->
çuÉ
->
n_rxçuÉs
[
·ck‘
->
Ýcode
]++;

368  
Œue
;

370  
çl£
;

371 
	}
}

	@fault.h

1 #iâdeà
_HFI1_FAULT_H


2 
	#_HFI1_FAULT_H


	)

49 
	~<lšux/çuÉ-šjeù.h
>

50 
	~<lšux/dÿche.h
>

51 
	~<lšux/b™Ýs.h
>

52 
	~<lšux/k”Ãl.h
>

53 
	~<rdma/rdma_vt.h
>

55 
	~"hfi.h
"

57 
	ghfi1_ibdev
;

59 #ià
defšed
(
CONFIG_FAULT_INJECTION
è&& defšed(
CONFIG_FAULT_INJECTION_DEBUG_FS
)

60 
	sçuÉ
 {

61 
çuÉ_©Œ
 
	m©Œ
;

62 
d’Œy
 *
	mdœ
;

63 
u64
 
	mn_rxçuÉs
[(1U << 
BITS_PER_BYTE
)];

64 
u64
 
	mn_txçuÉs
[(1U << 
BITS_PER_BYTE
)];

65 
u64
 
	mçuÉ_sk
;

66 
u64
 
	msk
;

67 
u64
 
	mçuÉ_sk_u£c
;

68 
	msk_u£c
;

69 
	mÝcodes
[(1U << 
BITS_PER_BYTE
è/ 
BITS_PER_LONG
];

70 
boÞ
 
	m’abË
;

71 
boÞ
 
	msuµ»ss_”r
;

72 
boÞ
 
	mÝcode
;

73 
u8
 
	mdœeùiÚ
;

76 
hfi1_çuÉ_š™_debugfs
(
hfi1_ibdev
 *
ibd
);

77 
boÞ
 
hfi1_dbg_should_çuÉ_tx
(
rvt_qp
 *
qp
, 
u32
 
Ýcode
);

78 
boÞ
 
hfi1_dbg_should_çuÉ_rx
(
hfi1_·ck‘
 *
·ck‘
);

79 
boÞ
 
hfi1_dbg_çuÉ_suµ»ss_”r
(
hfi1_ibdev
 *
ibd
);

80 
hfi1_çuÉ_ex™_debugfs
(
hfi1_ibdev
 *
ibd
);

84 
šlše
 
	$hfi1_çuÉ_š™_debugfs
(
hfi1_ibdev
 *
ibd
)

87 
	}
}

89 
šlše
 
boÞ
 
	$hfi1_dbg_should_çuÉ_rx
(
hfi1_·ck‘
 *
·ck‘
)

91  
çl£
;

92 
	}
}

94 
šlše
 
boÞ
 
	$hfi1_dbg_should_çuÉ_tx
(
rvt_qp
 *
qp
,

95 
u32
 
Ýcode
)

97  
çl£
;

98 
	}
}

100 
šlše
 
boÞ
 
	$hfi1_dbg_çuÉ_suµ»ss_”r
(
hfi1_ibdev
 *
ibd
)

102  
çl£
;

103 
	}
}

105 
šlše
 
	$hfi1_çuÉ_ex™_debugfs
(
hfi1_ibdev
 *
ibd
)

107 
	}
}

	@file_ops.c

47 
	~<lšux/pÞl.h
>

48 
	~<lšux/cdev.h
>

49 
	~<lšux/vm®loc.h
>

50 
	~<lšux/io.h
>

51 
	~"com·t.h
"

53 #ifdeà
NEED_AIO


54 
	~<lšux/aio.h
>

57 #ifdeà
NEED_SCHED_H


58 
	~<rdma/ib_u£r_mad.h
>

60 
	~<lšux/sched/mm.h
>

63 
	~<lšux/b™m­.h
>

64 
	~<rdma/ib.h
>

66 
	~"hfi.h
"

67 
	~"pio.h
"

68 
	~"deviû.h
"

69 
	~"commÚ.h
"

70 
	~"Œaû.h
"

71 
	~"mmu_rb.h
"

72 
	~"u£r_sdma.h
"

73 #ifdeà
NVIDIA_GPU_DIRECT


74 
	~"u£r_sdma_gpu.h
"

76 
	~"u£r_exp_rcv.h
"

77 
	~"a¥m.h
"

78 
	~"com·t_commÚ.h
"

80 #undeà
´_fmt


81 
	#´_fmt
(
fmt
è
DRIVER_NAME
 ": " 
	)
fmt

83 
	#SEND_CTXT_HALT_TIMEOUT
 1000

	)

85 
	g£lšux_mode
 = 0;

86 
	g´št_£_bªÃr
 = 1;

91 
hfi1_fže_Ý’
(
šode
 *šode, 
fže
 *
å
);

92 
hfi1_fže_þo£
(
šode
 *šode, 
fže
 *
å
);

93 
ssize_t
 
hfi1_wr™e_™”
(
kiocb
 *kiocb, 
iov_™”
 *
äom
);

94 #ifdeà
HAVE_AIO_WRITE


95 
	#™”_is_iovec
(
äom
è
Œue


	)

97 
ssize_t
 
	$hfi1_aio_wr™e
(
kiocb
 *kiocb, cÚ¡ 
iovec
 *iovec,

98 
dim
, 
loff_t
 
off£t
)

100 
iov_™”
 
äom
 = {

101 .
Ä_£gs
 = 
dim
,

102 .
iov
 = 
iovec


105  
	`hfi1_wr™e_™”
(
kiocb
, &
äom
);

106 
	}
}

108 
__pÞl_t
 
hfi1_pÞl
(
fže
 *
å
, 
pÞl_bË_¡ruù
 *
±
);

109 
hfi1_fže_mm­
(
fže
 *
å
, 
vm_¬—_¡ruù
 *
vma
);

111 
u64
 
kvœt_to_phys
(*
addr
);

112 
assign_ùxt
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
);

113 
š™_subùxts
(
hfi1_ùxtd©a
 *
uùxt
,

114 cÚ¡ 
hfi1_u£r_šfo
 *
ušfo
);

115 
š™_u£r_ùxt
(
hfi1_fžed©a
 *
fd
,

116 
hfi1_ùxtd©a
 *
uùxt
);

117 
u£r_š™
(
hfi1_ùxtd©a
 *
uùxt
);

118 
g‘_ùxt_šfo
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
);

119 
g‘_ba£_šfo
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
);

120 
u£r_exp_rcv_£tup
(
hfi1_fžed©a
 *
fd
, 
¬g
,

121 #ifdeà
NVIDIA_GPU_DIRECT


122 
ioùl_cmd
,

124 
u32
 
Ën
);

125 
u£r_exp_rcv_þ—r
(
hfi1_fžed©a
 *
fd
, 
¬g
,

126 
u32
 
Ën
);

127 
u£r_exp_rcv_šv®id
(
hfi1_fžed©a
 *
fd
, 
¬g
,

128 
u32
 
Ën
);

129 
£tup_ba£_ùxt
(
hfi1_fžed©a
 *
fd
,

130 
hfi1_ùxtd©a
 *
uùxt
);

131 
£tup_subùxt
(
hfi1_ùxtd©a
 *
uùxt
);

133 
fšd_sub_ùxt
(
hfi1_fžed©a
 *
fd
,

134 cÚ¡ 
hfi1_u£r_šfo
 *
ušfo
);

135 
®loÿ‹_ùxt
(
hfi1_fžed©a
 *
fd
, 
hfi1_devd©a
 *
dd
,

136 
hfi1_u£r_šfo
 *
ušfo
,

137 
hfi1_ùxtd©a
 **
cd
);

138 
d—Îoÿ‹_ùxt
(
hfi1_ùxtd©a
 *
uùxt
);

139 
__pÞl_t
 
pÞl_urg’t
(
fže
 *
å
, 
pÞl_bË_¡ruù
 *
±
);

140 
__pÞl_t
 
pÞl_Ãxt
(
fže
 *
å
, 
pÞl_bË_¡ruù
 *
±
);

141 
u£r_ev’t_ack
(
hfi1_ùxtd©a
 *
uùxt
, 
u16
 
subùxt
,

142 
¬g
);

143 
£t_ùxt_pkey
(
hfi1_ùxtd©a
 *
uùxt
, 
¬g
);

144 
ùxt_»£t
(
hfi1_ùxtd©a
 *
uùxt
);

145 
mªage_rcvq
(
hfi1_ùxtd©a
 *
uùxt
, 
u16
 
subùxt
,

146 
¬g
);

147 #iâdeà
VM_OPS_FAULT_HAVE_VMA


148 
vm_çuÉ_t
 
vma_çuÉ
(
vm_çuÉ
 *
vmf
);

150 
vm_çuÉ_t
 
vma_çuÉ
(
vm_¬—_¡ruù
 *
vma
, 
vm_çuÉ
 *
vmf
);

152 
hfi1_fže_ioùl
(
fže
 *
å
, 
cmd
,

153 
¬g
);

155 cÚ¡ 
fže_Ý”©iÚs
 
	ghfi1_fže_Ýs
 = {

156 .
owÃr
 = 
THIS_MODULE
,

157 #iâdeà
HAVE_AIO_WRITE


158 .
	gwr™e_™”
 = 
hfi1_wr™e_™”
,

160 .
	gaio_wr™e
 = 
hfi1_aio_wr™e
,

162 .
	gÝ’
 = 
hfi1_fže_Ý’
,

163 .
	g»Ëa£
 = 
hfi1_fže_þo£
,

164 .
	guÆocked_ioùl
 = 
hfi1_fže_ioùl
,

165 .
	gpÞl
 = 
hfi1_pÞl
,

166 .
	gmm­
 = 
hfi1_fže_mm­
,

167 .
	gÎ£ek
 = 
noÝ_Î£ek
,

170 cÚ¡ 
vm_Ý”©iÚs_¡ruù
 
	gvm_Ýs
 = {

171 .
çuÉ
 = 
vma_çuÉ
,

177 
	emm­_ty³s
 {

178 
	mPIO_BUFS
 = 1,

179 
	mPIO_BUFS_SOP
,

180 
	mPIO_CRED
,

181 
	mRCV_HDRQ
,

182 
	mRCV_EGRBUF
,

183 
	mUREGS
,

184 
	mEVENTS
,

185 
	mSTATUS
,

186 
	mRTAIL
,

187 
	mSUBCTXT_UREGS
,

188 
	mSUBCTXT_RCV_HDRQ
,

189 
	mSUBCTXT_EGRBUF
,

190 
	mSDMA_COMP


196 
	#HFI1_MMAP_OFFSET_MASK
 0xfffULL

	)

197 
	#HFI1_MMAP_OFFSET_SHIFT
 0

	)

198 
	#HFI1_MMAP_SUBCTXT_MASK
 0xfULL

	)

199 
	#HFI1_MMAP_SUBCTXT_SHIFT
 12

	)

200 
	#HFI1_MMAP_CTXT_MASK
 0xffULL

	)

201 
	#HFI1_MMAP_CTXT_SHIFT
 16

	)

202 
	#HFI1_MMAP_TYPE_MASK
 0xfULL

	)

203 
	#HFI1_MMAP_TYPE_SHIFT
 24

	)

204 
	#HFI1_MMAP_MAGIC_MASK
 0xffffffffULL

	)

205 
	#HFI1_MMAP_MAGIC_SHIFT
 32

	)

207 
	#HFI1_MMAP_MAGIC
 0xdabbad00

	)

209 
	#HFI1_MMAP_TOKEN_SET
(
f›ld
, 
v®
) \

210 (((
v®
è& 
HFI1_MMAP_
##
f›ld
##
_MASK
è<< HFI1_MMAP_##f›ld##
_SHIFT
)

	)

211 
	#HFI1_MMAP_TOKEN_GET
(
f›ld
, 
tok’
) \

212 (((
tok’
è>> 
HFI1_MMAP_
##
f›ld
##
_SHIFT
è& HFI1_MMAP_##f›ld##
_MASK
)

	)

213 
	#HFI1_MMAP_TOKEN
(
ty³
, 
ùxt
, 
subùxt
, 
addr
) \

214 (
	`HFI1_MMAP_TOKEN_SET
(
MAGIC
, 
HFI1_MMAP_MAGIC
) | \

215 
	`HFI1_MMAP_TOKEN_SET
(
TYPE
, 
ty³
) | \

216 
	`HFI1_MMAP_TOKEN_SET
(
CTXT
, 
ùxt
) | \

217 
	`HFI1_MMAP_TOKEN_SET
(
SUBCTXT
, 
subùxt
) | \

218 
	`HFI1_MMAP_TOKEN_SET
(
OFFSET
, (
	`off£t_š_·ge
(
addr
))))

	)

220 
	#dbg
(
fmt
, ...) \

221 
	`´_šfo
(
fmt
, ##
__VA_ARGS__
)

	)

223 
šlše
 
	$is_v®id_mm­
(
u64
 
tok’
)

225  (
	`HFI1_MMAP_TOKEN_GET
(
MAGIC
, 
tok’
è=ð
HFI1_MMAP_MAGIC
);

226 
	}
}

228 
	$hfi1_fže_Ý’
(
šode
 *šode, 
fže
 *
å
)

230 
hfi1_fžed©a
 *
fd
;

231 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
šode
->
i_cdev
,

232 
hfi1_devd©a
,

233 
u£r_cdev
);

235 ià(!((
dd
->
æags
 & 
HFI1_PRESENT
è&& dd->
k»gba£1
))

236  -
EINVAL
;

238 ià(!
	`©omic_šc_nÙ_z”o
(&
dd
->
u£r_»fcouÁ
))

239  -
ENXIO
;

243 
fd
 = 
	`kz®loc
((*fd), 
GFP_KERNEL
);

245 ià(!
fd
 || 
	`š™_¤cu_¡ruù
(&fd->
pq_¤cu
))

246 
nomem
;

247 
	`¥š_lock_š™
(&
fd
->
pq_rcu_lock
);

248 
	`¥š_lock_š™
(&
fd
->
tid_lock
);

249 
	`¥š_lock_š™
(&
fd
->
šv®id_lock
);

250 
fd
->
»c_ýu_num
 = -1;

251 
fd
->
mm
 = 
cu¼’t
->mm;

252 
	`mmg¿b
(
fd
->
mm
);

253 
fd
->
dd
 = dd;

254 
	`kobjeù_g‘
(&
fd
->
dd
->
kobj
);

255 
å
->
´iv©e_d©a
 = 
fd
;

257 
nomem
:

258 
	`kä“
(
fd
);

259 
å
->
´iv©e_d©a
 = 
NULL
;

260 ià(
	`©omic_dec_ªd_‹¡
(&
dd
->
u£r_»fcouÁ
))

261 
	`com¶‘e
(&
dd
->
u£r_comp
);

262  -
ENOMEM
;

263 
	}
}

265 
	$hfi1_fže_ioùl
(
fže
 *
å
, 
cmd
,

266 
¬g
)

268 
hfi1_fžed©a
 *
fd
 = 
å
->
´iv©e_d©a
;

269 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

270 
»t
 = 0;

271 
uv®
 = 0;

273 
	`hfi1_cdbg
(
IOCTL
, "IOCTL„ecv: 0x%x", 
cmd
);

274 ià(
cmd
 !ð
HFI1_IOCTL_ASSIGN_CTXT
 &&

275 
cmd
 !ð
HFI1_IOCTL_GET_VERS
 &&

276 !
uùxt
)

277  -
EINVAL
;

279 
cmd
) {

280 
HFI1_IOCTL_ASSIGN_CTXT
:

281 
»t
 = 
	`assign_ùxt
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

284 
HFI1_IOCTL_CTXT_INFO
:

285 
»t
 = 
	`g‘_ùxt_šfo
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

288 
HFI1_IOCTL_USER_INFO
:

289 
»t
 = 
	`g‘_ba£_šfo
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

292 
HFI1_IOCTL_CREDIT_UPD
:

293 ià(
uùxt
)

294 
	`sc_»tuº_üed™s
(
uùxt
->
sc
);

297 
HFI1_IOCTL_TID_UPDATE
:

298 #iâdeà
NVIDIA_GPU_DIRECT


299 
»t
 = 
	`u£r_exp_rcv_£tup
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

302 
HFI1_IOCTL_TID_UPDATE_V2
:

303 
»t
 = 
	`u£r_exp_rcv_£tup
(
fd
, 
¬g
, 
cmd
, 
	`_IOC_SIZE
(cmd));

306 
HFI1_IOCTL_SDMA_CACHE_EVICT
:

307 
»t
 = 
	`u£r_sdma_gpu_ÿche_eviù
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

310 
HFI1_IOCTL_TID_FREE
:

311 
»t
 = 
	`u£r_exp_rcv_þ—r
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

314 
HFI1_IOCTL_TID_INVAL_READ
:

315 
»t
 = 
	`u£r_exp_rcv_šv®id
(
fd
, 
¬g
, 
	`_IOC_SIZE
(
cmd
));

318 
HFI1_IOCTL_RECV_CTRL
:

319 
»t
 = 
	`mªage_rcvq
(
uùxt
, 
fd
->
subùxt
, 
¬g
);

322 
HFI1_IOCTL_POLL_TYPE
:

323 ià(
	`g‘_u£r
(
uv®
, (
__u£r
 *)
¬g
))

324  -
EFAULT
;

325 
uùxt
->
pÞl_ty³
 = (
	`ty³of
(uùxt->pÞl_ty³))
uv®
;

328 
HFI1_IOCTL_ACK_EVENT
:

329 
»t
 = 
	`u£r_ev’t_ack
(
uùxt
, 
fd
->
subùxt
, 
¬g
);

332 
HFI1_IOCTL_SET_PKEY
:

333 
»t
 = 
	`£t_ùxt_pkey
(
uùxt
, 
¬g
);

336 
HFI1_IOCTL_CTXT_RESET
:

337 
»t
 = 
	`ùxt_»£t
(
uùxt
);

340 
HFI1_IOCTL_GET_VERS
:

341 
uv®
 = 
HFI1_USER_SWVERSION
;

342 ià(
	`put_u£r
(
uv®
, (
__u£r
 *)
¬g
))

343  -
EFAULT
;

347  -
EINVAL
;

350  
»t
;

351 
	}
}

353 
ssize_t
 
	$hfi1_wr™e_™”
(
kiocb
 *kiocb, 
iov_™”
 *
äom
)

355 
hfi1_fžed©a
 *
fd
 = 
kiocb
->
ki_fžp
->
´iv©e_d©a
;

356 
hfi1_u£r_sdma_pkt_q
 *
pq
;

357 
hfi1_u£r_sdma_comp_q
 *
cq
 = 
fd
->cq;

358 
dÚe
 = 0, 
»qs
 = 0;

359 
dim
 = 
äom
->
Ä_£gs
;

360 
idx
;

362 
idx
 = 
	`¤cu_»ad_lock
(&
fd
->
pq_¤cu
);

363 
pq
 = 
	`¤cu_d”eã»nû
(
fd
->pq, &fd->
pq_¤cu
);

364 ià(!
cq
 || !
pq
) {

365 
	`¤cu_»ad_uÆock
(&
fd
->
pq_¤cu
, 
idx
);

366  -
EIO
;

369 ià(!
	`™”_is_iovec
(
äom
è|| !
dim
) {

370 
	`¤cu_»ad_uÆock
(&
fd
->
pq_¤cu
, 
idx
);

371  -
EINVAL
;

374 
	`Œaû_hfi1_sdma_»que¡
(
fd
->
dd
, fd->
uùxt
->
ùxt
, fd->
subùxt
, 
dim
);

376 ià(
	`©omic_»ad
(&
pq
->
n_»qs
è=ðpq->
n_max_»qs
) {

377 
	`¤cu_»ad_uÆock
(&
fd
->
pq_¤cu
, 
idx
);

378  -
ENOSPC
;

381 
dim
) {

382 
»t
;

383 
couÁ
 = 0;

385 
»t
 = 
	`hfi1_u£r_sdma_´oûss_»que¡
(

386 
fd
, (
iovec
 *)(
äom
->
iov
 + 
dÚe
),

387 
dim
, &
couÁ
);

388 ià(
»t
) {

389 
»qs
 = 
»t
;

392 
dim
 -ð
couÁ
;

393 
dÚe
 +ð
couÁ
;

394 
»qs
++;

397 
	`¤cu_»ad_uÆock
(&
fd
->
pq_¤cu
, 
idx
);

398  
»qs
;

399 
	}
}

401 
	$hfi1_fže_mm­
(
fže
 *
å
, 
vm_¬—_¡ruù
 *
vma
)

403 
hfi1_fžed©a
 *
fd
 = 
å
->
´iv©e_d©a
;

404 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

405 
hfi1_devd©a
 *
dd
;

406 
æags
;

407 
u64
 
tok’
 = 
vma
->
vm_pgoff
 << 
PAGE_SHIFT
,

408 
memaddr
 = 0;

409 *
memvœt
 = 
NULL
;

410 
u8
 
subùxt
, 
m­io
 = 0, 
vmf
 = 0, 
ty³
;

411 
ssize_t
 
memËn
 = 0;

412 
»t
 = 0;

413 
u16
 
ùxt
;

415 ià(!
	`is_v®id_mm­
(
tok’
è|| !
uùxt
 ||

416 !(
vma
->
vm_æags
 & 
VM_SHARED
)) {

417 
»t
 = -
EINVAL
;

418 
dÚe
;

420 
dd
 = 
uùxt
->dd;

421 
ùxt
 = 
	`HFI1_MMAP_TOKEN_GET
(
CTXT
, 
tok’
);

422 
subùxt
 = 
	`HFI1_MMAP_TOKEN_GET
(
SUBCTXT
, 
tok’
);

423 
ty³
 = 
	`HFI1_MMAP_TOKEN_GET
(
TYPE
, 
tok’
);

424 ià(
ùxt
 !ð
uùxt
->ùxˆ|| 
subùxt
 !ð
fd
->subctxt) {

425 
»t
 = -
EINVAL
;

426 
dÚe
;

429 
æags
 = 
vma
->
vm_æags
;

431 
ty³
) {

432 
PIO_BUFS
:

433 
PIO_BUFS_SOP
:

434 
memaddr
 = ((
dd
->
phy§ddr
 + 
TXE_PIO_SEND
) +

436 (
uùxt
->
sc
->
hw_cÚ‹xt
 * 
	`BIT
(16))) +

438 (
ty³
 =ð
PIO_BUFS_SOP
 ?

439 (
TXE_PIO_SIZE
 / 2) : 0);

444 
memËn
 = 
	`PAGE_ALIGN
(
uùxt
->
sc
->
üed™s
 * 
PIO_BLOCK_SIZE
);

445 
æags
 &ð~
VM_MAYREAD
;

446 
æags
 |ð
VM_DONTCOPY
 | 
VM_DONTEXPAND
;

447 
vma
->
vm_·ge_´Ù
 = 
	`pg´Ù_wr™ecombše
(vma->vm_page_prot);

448 
m­io
 = 1;

450 
PIO_CRED
:

451 ià(
æags
 & 
VM_WRITE
) {

452 
»t
 = -
EPERM
;

453 
dÚe
;

460 
memvœt
 = 
dd
->
ü_ba£
[
uùxt
->
numa_id
].
va
;

461 
memaddr
 = 
	`vœt_to_phys
(
memvœt
) +

462 (((
u64
)
uùxt
->
sc
->
hw_ä“
 -

463 (
u64
)
dd
->
ü_ba£
[
uùxt
->
numa_id
].
va
è& 
PAGE_MASK
);

464 
memËn
 = 
PAGE_SIZE
;

465 
æags
 &ð~
VM_MAYWRITE
;

466 
æags
 |ð
VM_DONTCOPY
 | 
VM_DONTEXPAND
;

473 
m­io
 = 1;

475 
RCV_HDRQ
:

476 
memËn
 = 
	`rcvhdrq_size
(
uùxt
);

477 
memvœt
 = 
uùxt
->
rcvhdrq
;

479 
RCV_EGRBUF
: {

480 
addr
;

481 
i
;

487 
memËn
 = 
uùxt
->
egrbufs
.
size
;

488 ià((
vma
->
vm_’d
 - vma->
vm_¡¬t
è!ð
memËn
) {

489 
	`dd_dev_”r
(
dd
, "Eager buffer map size invalid (%lu != %lu)\n",

490 (
vma
->
vm_’d
 - vma->
vm_¡¬t
), 
memËn
);

491 
»t
 = -
EINVAL
;

492 
dÚe
;

494 ià(
vma
->
vm_æags
 & 
VM_WRITE
) {

495 
»t
 = -
EPERM
;

496 
dÚe
;

498 
vma
->
vm_æags
 &ð~
VM_MAYWRITE
;

499 
addr
 = 
vma
->
vm_¡¬t
;

500 
i
 = 0 ; i < 
uùxt
->
egrbufs
.
numbufs
; i++) {

501 
memËn
 = 
uùxt
->
egrbufs
.
bufãrs
[
i
].
Ën
;

502 
memvœt
 = 
uùxt
->
egrbufs
.
bufãrs
[
i
].
addr
;

503 
»t
 = 
	`»m­_pâ_¿nge
(

504 
vma
, 
addr
,

510 
	`PFN_DOWN
(
	`__·
(
memvœt
)),

511 
memËn
,

512 
vma
->
vm_·ge_´Ù
);

513 ià(
»t
 < 0)

514 
dÚe
;

515 
addr
 +ð
memËn
;

517 
»t
 = 0;

518 
dÚe
;

520 
UREGS
:

525 
memaddr
 = ()

526 (
dd
->
phy§ddr
 + 
RXE_PER_CONTEXT_USER
)

527 + (
uùxt
->
ùxt
 * 
RXE_PER_CONTEXT_SIZE
);

532 
memËn
 = 
PAGE_SIZE
;

533 
æags
 |ð
VM_DONTCOPY
 | 
VM_DONTEXPAND
;

534 
vma
->
vm_·ge_´Ù
 = 
	`pg´Ù_nÚÿched
(vma->vm_page_prot);

535 
m­io
 = 1;

537 
EVENTS
:

542 
memaddr
 = ()

543 (
dd
->
ev’ts
 + 
	`uùxt_off£t
(
uùxt
)è& 
PAGE_MASK
;

544 
memËn
 = 
PAGE_SIZE
;

549 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

550 
vmf
 = 1;

552 
STATUS
:

553 ià(
æags
 & 
VM_WRITE
) {

554 
»t
 = -
EPERM
;

555 
dÚe
;

557 
memaddr
 = 
	`kvœt_to_phys
((*)
dd
->
¡©us
);

558 
memËn
 = 
PAGE_SIZE
;

559 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

561 
RTAIL
:

562 ià(!
	`HFI1_CAP_IS_USET
(
DMA_RTAIL
)) {

567 
»t
 = -
EINVAL
;

568 
dÚe
;

570 
memvœt
 = (*)
	`hfi1_rcvhd¹až_kvaddr
(
uùxt
);

571 ià((
æags
 & 
VM_WRITE
è|| !
memvœt
) {

572 
»t
 = -
EPERM
;

573 
dÚe
;

575 
memËn
 = 
PAGE_SIZE
;

576 
æags
 &ð~
VM_MAYWRITE
;

578 
SUBCTXT_UREGS
:

579 
memaddr
 = (
u64
)
uùxt
->
subùxt_u»gba£
;

580 
memËn
 = 
PAGE_SIZE
;

581 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

582 
vmf
 = 1;

584 
SUBCTXT_RCV_HDRQ
:

585 
memaddr
 = (
u64
)
uùxt
->
subùxt_rcvhdr_ba£
;

586 
memËn
 = 
	`rcvhdrq_size
(
uùxt
è* uùxt->
subùxt_út
;

587 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

588 
vmf
 = 1;

590 
SUBCTXT_EGRBUF
:

591 
memaddr
 = (
u64
)
uùxt
->
subùxt_rcvegrbuf
;

592 
memËn
 = 
uùxt
->
egrbufs
.
size
 * uùxt->
subùxt_út
;

593 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

594 
æags
 &ð~
VM_MAYWRITE
;

595 
vmf
 = 1;

597 
SDMA_COMP
: {

598 
hfi1_u£r_sdma_comp_q
 *
cq
 = 
fd
->cq;

600 ià(!
cq
) {

601 
»t
 = -
EFAULT
;

602 
dÚe
;

604 
memaddr
 = (
u64
)
cq
->
comps
;

605 
memËn
 = 
	`PAGE_ALIGN
((*
cq
->
comps
è* cq->
ÃÁr›s
);

606 
æags
 |ð
VM_IO
 | 
VM_DONTEXPAND
;

607 
vmf
 = 1;

611 
»t
 = -
EINVAL
;

615 ià((
vma
->
vm_’d
 - vma->
vm_¡¬t
è!ð
memËn
) {

616 
	`hfi1_cdbg
(
PROC
, "%u:%u Memory size mismatch %lu:%lu",

617 
uùxt
->
ùxt
, 
fd
->
subùxt
,

618 (
vma
->
vm_’d
 - vma->
vm_¡¬t
), 
memËn
);

619 
»t
 = -
EINVAL
;

620 
dÚe
;

623 
vma
->
vm_æags
 = 
æags
;

624 
	`hfi1_cdbg
(
PROC
,

626 
ùxt
, 
subùxt
, 
ty³
, 
m­io
, 
vmf
, 
memaddr
, 
memËn
,

627 
vma
->
vm_’d
 - vma->
vm_¡¬t
, vma->
vm_æags
);

628 ià(
vmf
) {

629 
vma
->
vm_pgoff
 = 
	`PFN_DOWN
(
memaddr
);

630 
vma
->
vm_Ýs
 = &vm_ops;

631 
»t
 = 0;

632 } ià(
m­io
) {

633 
»t
 = 
	`io_»m­_pâ_¿nge
(
vma
, vma->
vm_¡¬t
,

634 
	`PFN_DOWN
(
memaddr
),

635 
memËn
,

636 
vma
->
vm_·ge_´Ù
);

637 } ià(
memvœt
) {

638 
»t
 = 
	`»m­_pâ_¿nge
(
vma
, vma->
vm_¡¬t
,

639 
	`PFN_DOWN
(
	`__·
(
memvœt
)),

640 
memËn
,

641 
vma
->
vm_·ge_´Ù
);

643 
»t
 = 
	`»m­_pâ_¿nge
(
vma
, vma->
vm_¡¬t
,

644 
	`PFN_DOWN
(
memaddr
),

645 
memËn
,

646 
vma
->
vm_·ge_´Ù
);

648 
dÚe
:

649  
»t
;

650 
	}
}

656 #iâdeà
VM_OPS_FAULT_HAVE_VMA


657 
vm_çuÉ_t
 
	$vma_çuÉ
(
vm_çuÉ
 *
vmf
)

659 
vm_çuÉ_t
 
	$vma_çuÉ
(
vm_¬—_¡ruù
 *
vma
, 
vm_çuÉ
 *
vmf
)

662 
·ge
 *page;

664 
·ge
 = 
	`vm®loc_to_·ge
((*)(
vmf
->
pgoff
 << 
PAGE_SHIFT
));

665 ià(!
·ge
)

666  
VM_FAULT_SIGBUS
;

668 
	`g‘_·ge
(
·ge
);

669 
vmf
->
·ge
 =…age;

672 
	}
}

674 
__pÞl_t
 
	$hfi1_pÞl
(
fže
 *
å
, 
pÞl_bË_¡ruù
 *
±
)

676 
hfi1_ùxtd©a
 *
uùxt
;

677 
__pÞl_t
 
pÞlæag
;

679 
uùxt
 = ((
hfi1_fžed©a
 *)
å
->
´iv©e_d©a
)->uctxt;

680 ià(!
uùxt
)

681 
pÞlæag
 = 
EPOLLERR
;

682 ià(
uùxt
->
pÞl_ty³
 =ð
HFI1_POLL_TYPE_URGENT
)

683 
pÞlæag
 = 
	`pÞl_urg’t
(
å
, 
±
);

684 ià(
uùxt
->
pÞl_ty³
 =ð
HFI1_POLL_TYPE_ANYRCV
)

685 
pÞlæag
 = 
	`pÞl_Ãxt
(
å
, 
±
);

687 
pÞlæag
 = 
EPOLLERR
;

689  
pÞlæag
;

690 
	}
}

692 
	$hfi1_fže_þo£
(
šode
 *šode, 
fže
 *
å
)

694 
hfi1_fžed©a
 *
fd©a
 = 
å
->
´iv©e_d©a
;

695 
hfi1_ùxtd©a
 *
uùxt
 = 
fd©a
->uctxt;

696 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
šode
->
i_cdev
,

697 
hfi1_devd©a
,

698 
u£r_cdev
);

699 
æags
, *
ev
;

701 
å
->
´iv©e_d©a
 = 
NULL
;

703 ià(!
uùxt
)

704 
dÚe
;

706 
	`hfi1_cdbg
(
PROC
, "þosšg ctxˆ%u:%u", 
uùxt
->
ùxt
, 
fd©a
->
subùxt
);

708 
	`æush_wc
();

710 
	`hfi1_u£r_sdma_ä“_queues
(
fd©a
, 
uùxt
);

713 
	`hfi1_put_´oc_affš™y
(
fd©a
->
»c_ýu_num
);

716 
	`hfi1_u£r_exp_rcv_ä“
(
fd©a
);

722 
fd©a
->
uùxt
 = 
NULL
;

723 
	`hfi1_rcd_put
(
uùxt
);

729 
ev
 = 
dd
->
ev’ts
 + 
	`uùxt_off£t
(
uùxt
è+ 
fd©a
->
subùxt
;

730 *
ev
 = 0;

732 
	`¥š_lock_œq§ve
(&
dd
->
uùxt_lock
, 
æags
);

733 
	`__þ—r_b™
(
fd©a
->
subùxt
, 
uùxt
->
š_u£_ùxts
);

734 ià(!
	`b™m­_em±y
(
uùxt
->
š_u£_ùxts
, 
HFI1_MAX_SHARED_CTXTS
)) {

735 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

736 
dÚe
;

738 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

744 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_CTXT_DIS
 |

745 
HFI1_RCVCTRL_TIDFLOW_DIS
 |

746 
HFI1_RCVCTRL_INTRAVAIL_DIS
 |

747 
HFI1_RCVCTRL_TAILUPD_DIS
 |

748 
HFI1_RCVCTRL_ONE_PKT_EGR_DIS
 |

749 
HFI1_RCVCTRL_NO_RHQ_DROP_DIS
 |

750 
HFI1_RCVCTRL_NO_EGR_DROP_DIS
 |

751 
HFI1_RCVCTRL_URGENT_DIS
, 
uùxt
);

753 
	`hfi1_þ—r_ùxt_jkey
(
dd
, 
uùxt
);

754 ià(
uùxt
->
£cur™y
)

755 
	`£cur™y_ib_ä“_£cur™y
(
uùxt
->
£cur™y
);

760 ià(
uùxt
->
sc
) {

761 
	`sc_di§bË
(
uùxt
->
sc
);

762 
	`£t_pio_š‹gr™y
(
uùxt
->
sc
);

765 
	`hfi1_ä“_ùxt_rcv_groups
(
uùxt
);

766 
	`hfi1_þ—r_ùxt_pkey
(
dd
, 
uùxt
);

768 
uùxt
->
ev’t_æags
 = 0;

770 
	`d—Îoÿ‹_ùxt
(
uùxt
);

771 
dÚe
:

772 
	`mmdrÝ
(
fd©a
->
mm
);

773 
	`kobjeù_put
(&
dd
->
kobj
);

775 ià(
	`©omic_dec_ªd_‹¡
(&
dd
->
u£r_»fcouÁ
))

776 
	`com¶‘e
(&
dd
->
u£r_comp
);

778 
	`þ—nup_¤cu_¡ruù
(&
fd©a
->
pq_¤cu
);

779 
	`kä“
(
fd©a
);

781 
	}
}

787 
u64
 
	$kvœt_to_phys
(*
addr
)

789 
·ge
 *page;

790 
u64
 
·ddr
 = 0;

792 
·ge
 = 
	`vm®loc_to_·ge
(
addr
);

793 ià(
·ge
)

794 
·ddr
 = 
	`·ge_to_pâ
(
·ge
è<< 
PAGE_SHIFT
;

796  
·ddr
;

797 
	}
}

811 
	$com¶‘e_subùxt
(
hfi1_fžed©a
 *
fd
)

813 
»t
;

814 
æags
;

820 
»t
 = 
	`wa™_ev’t_š‹¼u±ibË
(

821 
fd
->
uùxt
->
wa™
,

822 !
	`‹¡_b™
(
HFI1_CTXT_BASE_UNINIT
, &
fd
->
uùxt
->
ev’t_æags
));

824 ià(
	`‹¡_b™
(
HFI1_CTXT_BASE_FAILED
, &
fd
->
uùxt
->
ev’t_æags
))

825 
»t
 = -
ENOMEM
;

828 ià(!
»t
) {

829 
fd
->
»c_ýu_num
 = 
	`hfi1_g‘_´oc_affš™y
(fd->
uùxt
->
numa_id
);

830 
»t
 = 
	`š™_u£r_ùxt
(
fd
, fd->
uùxt
);

833 ià(
»t
) {

834 
	`¥š_lock_œq§ve
(&
fd
->
dd
->
uùxt_lock
, 
æags
);

835 
	`__þ—r_b™
(
fd
->
subùxt
, fd->
uùxt
->
š_u£_ùxts
);

836 
	`¥š_uÆock_œq»¡Üe
(&
fd
->
dd
->
uùxt_lock
, 
æags
);

837 
	`hfi1_rcd_put
(
fd
->
uùxt
);

838 
fd
->
uùxt
 = 
NULL
;

841  
»t
;

842 
	}
}

844 
	$assign_ùxt
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
)

846 
»t
;

847 
swmajÜ
;

848 
hfi1_ùxtd©a
 *
uùxt
 = 
NULL
;

849 
hfi1_u£r_šfo
 
ušfo
;

851 ià(
fd
->
uùxt
)

852  -
EINVAL
;

854 ià((
ušfo
è!ð
Ën
)

855  -
EINVAL
;

857 ià(
	`cÝy_äom_u£r
(&
ušfo
, (
__u£r
 *)
¬g
, (uinfo)))

858  -
EFAULT
;

860 
swmajÜ
 = 
ušfo
.
u£rv”siÚ
 >> 16;

861 ià(
swmajÜ
 !ð
HFI1_USER_SWMAJOR
)

862  -
ENODEV
;

864 ià(
ušfo
.
subùxt_út
 > 
HFI1_MAX_SHARED_CTXTS
)

865  -
EINVAL
;

871 
	`mu‹x_lock
(&
hfi1_mu‹x
);

876 
»t
 = 
	`fšd_sub_ùxt
(
fd
, &
ušfo
);

882 ià(!
»t
)

883 
»t
 = 
	`®loÿ‹_ùxt
(
fd
, fd->
dd
, &
ušfo
, &
uùxt
);

885 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

888 
»t
) {

890 
»t
 = 
	`£tup_ba£_ùxt
(
fd
, 
uùxt
);

891 ià(
»t
)

892 
	`d—Îoÿ‹_ùxt
(
uùxt
);

895 
»t
 = 
	`com¶‘e_subùxt
(
fd
);

901  
»t
;

902 
	}
}

913 
	$m©ch_ùxt
(
hfi1_fžed©a
 *
fd
,

914 cÚ¡ 
hfi1_u£r_šfo
 *
ušfo
,

915 
hfi1_ùxtd©a
 *
uùxt
)

917 
hfi1_devd©a
 *
dd
 = 
fd
->dd;

918 
æags
;

919 
u16
 
subùxt
;

922 ià(
uùxt
->
sc
 && (uùxt->sc->
ty³
 =ð
SC_KERNEL
))

926 ià(
	`memcmp
(
uùxt
->
uuid
, 
ušfo
->uuid, (uctxt->uuid)) ||

927 
uùxt
->
jkey
 !ð
	`g’”©e_jkey
(
	`cu¼’t_uid
()) ||

928 
uùxt
->
subùxt_id
 !ð
ušfo
->subctxt_id ||

929 
uùxt
->
subùxt_út
 !ð
ušfo
->subctxt_cnt)

933 ià(
uùxt
->
u£rv”siÚ
 !ð
ušfo
->userversion)

934  -
EINVAL
;

937 
	`¥š_lock_œq§ve
(&
dd
->
uùxt_lock
, 
æags
);

938 ià(
	`b™m­_em±y
(
uùxt
->
š_u£_ùxts
, 
HFI1_MAX_SHARED_CTXTS
)) {

940 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

944 
subùxt
 = 
	`fšd_fœ¡_z”o_b™
(
uùxt
->
š_u£_ùxts
,

945 
HFI1_MAX_SHARED_CTXTS
);

946 ià(
subùxt
 >ð
uùxt
->
subùxt_út
) {

947 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

948  -
EBUSY
;

951 
fd
->
subùxt
 = subctxt;

952 
	`__£t_b™
(
fd
->
subùxt
, 
uùxt
->
š_u£_ùxts
);

953 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

955 
fd
->
uùxt
 = uctxt;

956 
	`hfi1_rcd_g‘
(
uùxt
);

959 
	}
}

975 
	$fšd_sub_ùxt
(
hfi1_fžed©a
 *
fd
,

976 cÚ¡ 
hfi1_u£r_šfo
 *
ušfo
)

978 
hfi1_ùxtd©a
 *
uùxt
;

979 
hfi1_devd©a
 *
dd
 = 
fd
->dd;

980 
u16
 
i
;

981 
»t
;

983 ià(!
ušfo
->
subùxt_út
)

986 
i
 = 
dd
->
fœ¡_dyn_®loc_ùxt
; i < dd->
num_rcv_cÚ‹xts
; i++) {

987 
uùxt
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

988 ià(
uùxt
) {

989 
»t
 = 
	`m©ch_ùxt
(
fd
, 
ušfo
, 
uùxt
);

990 
	`hfi1_rcd_put
(
uùxt
);

992 ià(
»t
)

993  
»t
;

998 
	}
}

1000 
	$®loÿ‹_ùxt
(
hfi1_fžed©a
 *
fd
, 
hfi1_devd©a
 *
dd
,

1001 
hfi1_u£r_šfo
 *
ušfo
,

1002 
hfi1_ùxtd©a
 **
rcd
)

1004 
hfi1_ùxtd©a
 *
uùxt
;

1005 
»t
, 
numa
;

1007 ià(
dd
->
æags
 & 
HFI1_FROZEN
) {

1015  -
EIO
;

1018 ià(!
dd
->
ä“ùxts
)

1019  -
EBUSY
;

1025 
fd
->
»c_ýu_num
 = 
	`hfi1_g‘_´oc_affš™y
(
dd
->
node
);

1026 ià(
fd
->
»c_ýu_num
 != -1)

1027 
numa
 = 
	`ýu_to_node
(
fd
->
»c_ýu_num
);

1029 
numa
 = 
	`numa_node_id
();

1030 
»t
 = 
	`hfi1_ü—‹_ùxtd©a
(
dd
->
µÜt
, 
numa
, &
uùxt
);

1031 ià(
»t
 < 0) {

1032 
	`dd_dev_”r
(
dd
, "user ctxtdata‡llocation failed\n");

1033  
»t
;

1035 
	`hfi1_cdbg
(
PROC
, "[%u:%u]…id %u‡ssignedo CPU %d (NUMA %u)",

1036 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
cu¼’t
->
pid
, fd->
»c_ýu_num
,

1037 
uùxt
->
numa_id
);

1042 
uùxt
->
sc
 = 
	`sc_®loc
(
dd
, 
SC_USER
, uùxt->
rcvhdrq’tsize
, dd->
node
);

1043 ià(!
uùxt
->
sc
) {

1044 
»t
 = -
ENOMEM
;

1045 
ùxd©a_ä“
;

1047 
	`hfi1_cdbg
(
PROC
, "®loÿ‹d s’d cÚ‹xˆ%u(%u)\n", 
uùxt
->
sc
->
sw_šdex
,

1048 
uùxt
->
sc
->
hw_cÚ‹xt
);

1049 
»t
 = 
	`sc_’abË
(
uùxt
->
sc
);

1050 ià(
»t
)

1051 
ùxd©a_ä“
;

1062 
	`__£t_b™
(0, 
uùxt
->
š_u£_ùxts
);

1063 ià(
ušfo
->
subùxt_út
)

1064 
	`š™_subùxts
(
uùxt
, 
ušfo
);

1065 
uùxt
->
u£rv”siÚ
 = 
ušfo
->userversion;

1066 
uùxt
->
æags
 = 
hfi1_ÿp_mask
;

1067 
	`š™_wa™queue_h—d
(&
uùxt
->
wa™
);

1068 
	`¡¾ýy
(
uùxt
->
comm
, 
cu¼’t
->comm, (uctxt->comm));

1069 
	`memýy
(
uùxt
->
uuid
, 
ušfo
->uuid, (uctxt->uuid));

1076 
uùxt
->
jkey
 = 
	`g’”©e_jkey
(
	`cu¼’t_uid
());

1077 
hfi1_¡©s
.
¥s_ùxts
++;

1082 ià(
dd
->
ä“ùxts
-- =ðdd->
num_u£r_cÚ‹xts
)

1083 
	`a¥m_di§bË_®l
(
dd
);

1085 *
rcd
 = 
uùxt
;

1089 
ùxd©a_ä“
:

1090 
	`hfi1_ä“_ùxt
(
uùxt
);

1091  
»t
;

1092 
	}
}

1094 
	$d—Îoÿ‹_ùxt
(
hfi1_ùxtd©a
 *
uùxt
)

1096 
	`mu‹x_lock
(&
hfi1_mu‹x
);

1097 
hfi1_¡©s
.
¥s_ùxts
--;

1098 ià(++
uùxt
->
dd
->
ä“ùxts
 =ðuùxt->dd->
num_u£r_cÚ‹xts
)

1099 
	`a¥m_’abË_®l
(
uùxt
->
dd
);

1100 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

1102 
	`hfi1_ä“_ùxt
(
uùxt
);

1103 
	}
}

1105 
	$š™_subùxts
(
hfi1_ùxtd©a
 *
uùxt
,

1106 cÚ¡ 
hfi1_u£r_šfo
 *
ušfo
)

1108 
uùxt
->
subùxt_út
 = 
ušfo
->subctxt_cnt;

1109 
uùxt
->
subùxt_id
 = 
ušfo
->subctxt_id;

1110 
	`£t_b™
(
HFI1_CTXT_BASE_UNINIT
, &
uùxt
->
ev’t_æags
);

1111 
	}
}

1113 
	$£tup_subùxt
(
hfi1_ùxtd©a
 *
uùxt
)

1115 
»t
 = 0;

1116 
u16
 
num_subùxts
 = 
uùxt
->
subùxt_út
;

1118 
uùxt
->
subùxt_u»gba£
 = 
	`vm®loc_u£r
(
PAGE_SIZE
);

1119 ià(!
uùxt
->
subùxt_u»gba£
)

1120  -
ENOMEM
;

1123 
uùxt
->
subùxt_rcvhdr_ba£
 = 
	`vm®loc_u£r
(
	`rcvhdrq_size
(uctxt) *

1124 
num_subùxts
);

1125 ià(!
uùxt
->
subùxt_rcvhdr_ba£
) {

1126 
»t
 = -
ENOMEM
;

1127 
baž_u»g
;

1130 
uùxt
->
subùxt_rcvegrbuf
 = 
	`vm®loc_u£r
(uùxt->
egrbufs
.
size
 *

1131 
num_subùxts
);

1132 ià(!
uùxt
->
subùxt_rcvegrbuf
) {

1133 
»t
 = -
ENOMEM
;

1134 
baž_rhdr
;

1139 
baž_rhdr
:

1140 
	`vä“
(
uùxt
->
subùxt_rcvhdr_ba£
);

1141 
uùxt
->
subùxt_rcvhdr_ba£
 = 
NULL
;

1142 
baž_u»g
:

1143 
	`vä“
(
uùxt
->
subùxt_u»gba£
);

1144 
uùxt
->
subùxt_u»gba£
 = 
NULL
;

1146  
»t
;

1147 
	}
}

1149 
	$u£r_š™
(
hfi1_ùxtd©a
 *
uùxt
)

1151 
rcvù¾_Ýs
 = 0;

1154 
uùxt
->
urg’t
 = 0;

1155 
uùxt
->
urg’t_pÞl
 = 0;

1168 
	`þ—r_rcvhd¹až
(
uùxt
);

1170 ià(
uùxt
->
£cur™y
)

1174 
	`hfi1_£t_ùxt_jkey
(
uùxt
->
dd
, uctxt, 0xFF00);

1176 
	`hfi1_£t_ùxt_jkey
(
uùxt
->
dd
, uùxt, uùxt->
jkey
);

1178 
rcvù¾_Ýs
 = 
HFI1_RCVCTRL_CTXT_ENB
;

1179 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_URGENT_ENB
;

1180 ià(
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
HDRSUPP
))

1181 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_TIDFLOW_ENB
;

1187 ià(!
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
MULTI_PKT_EGR
))

1188 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_ONE_PKT_EGR_ENB
;

1189 ià(
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
NODROP_EGR_FULL
))

1190 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_NO_EGR_DROP_ENB
;

1191 ià(
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
NODROP_RHQ_FULL
))

1192 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_NO_RHQ_DROP_ENB
;

1199 ià(
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
DMA_RTAIL
))

1200 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_TAILUPD_ENB
;

1202 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_TAILUPD_DIS
;

1203 
	`hfi1_rcvù¾
(
uùxt
->
dd
, 
rcvù¾_Ýs
, uctxt);

1204 
	}
}

1206 
	$g‘_ùxt_šfo
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
)

1208 
hfi1_ùxt_šfo
 
cšfo
;

1209 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

1211 ià((
cšfo
è!ð
Ën
)

1212  -
EINVAL
;

1214 
	`mem£t
(&
cšfo
, 0, (cinfo));

1215 
cšfo
.
ruÁime_æags
 = (((
uùxt
->
æags
 >> 
HFI1_CAP_MISC_SHIFT
) &

1216 
HFI1_CAP_MISC_MASK
è<< 
HFI1_CAP_USER_SHIFT
) |

1217 #ifdeà
NVIDIA_GPU_DIRECT


1218 
HFI1_CAP_GPUDIRECT_OT
 |

1220 
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
MASK
) |

1221 
	`HFI1_CAP_KGET_MASK
(
uùxt
->
æags
, 
K2U
);

1223 ià(!
fd
->
hªdËr
)

1224 
cšfo
.
ruÁime_æags
 |ð
HFI1_CAP_TID_UNMAP
;

1226 
cšfo
.
num_aùive
 = 
	`hfi1_couÁ_aùive_un™s
();

1227 
cšfo
.
un™
 = 
uùxt
->
dd
->unit;

1228 
cšfo
.
ùxt
 = 
uùxt
->ctxt;

1229 
cšfo
.
subùxt
 = 
fd
->subctxt;

1230 
cšfo
.
rcvtids
 = 
	`roundup
(
uùxt
->
egrbufs
.
®loûd
,

1231 
uùxt
->
dd
->
rcv_’Œ›s
.
group_size
) +

1232 
uùxt
->
ex³ùed_couÁ
;

1233 
cšfo
.
üed™s
 = 
uùxt
->
sc
->credits;

1234 
cšfo
.
numa_node
 = 
uùxt
->
numa_id
;

1235 
cšfo
.
»c_ýu
 = 
fd
->
»c_ýu_num
;

1236 
cšfo
.
£nd_ùxt
 = 
uùxt
->
sc
->
hw_cÚ‹xt
;

1238 
cšfo
.
eg¹ids
 = 
uùxt
->
egrbufs
.
®loûd
;

1239 
cšfo
.
rcvhdrq_út
 = 
	`g‘_hdrq_út
(
uùxt
);

1240 
cšfo
.
rcvhdrq_’tsize
 = 
uùxt
->
rcvhdrq’tsize
 << 2;

1241 
cšfo
.
sdma_ršg_size
 = 
fd
->
cq
->
ÃÁr›s
;

1242 
cšfo
.
rcvegr_size
 = 
uùxt
->
egrbufs
.
rcvtid_size
;

1244 
	`Œaû_hfi1_ùxt_šfo
(
uùxt
->
dd
, uùxt->
ùxt
, 
fd
->
subùxt
, &
cšfo
);

1245 ià(
	`cÝy_to_u£r
((
__u£r
 *)
¬g
, &
cšfo
, 
Ën
))

1246  -
EFAULT
;

1249 
	}
}

1251 
	$š™_u£r_ùxt
(
hfi1_fžed©a
 *
fd
,

1252 
hfi1_ùxtd©a
 *
uùxt
)

1254 
»t
;

1256 
»t
 = 
	`hfi1_u£r_sdma_®loc_queues
(
uùxt
, 
fd
);

1257 ià(
»t
)

1258  
»t
;

1260 
»t
 = 
	`hfi1_u£r_exp_rcv_š™
(
fd
, 
uùxt
);

1261 ià(
»t
)

1262 
	`hfi1_u£r_sdma_ä“_queues
(
fd
, 
uùxt
);

1264  
»t
;

1265 
	}
}

1267 
	$£tup_ba£_ùxt
(
hfi1_fžed©a
 *
fd
,

1268 
hfi1_ùxtd©a
 *
uùxt
)

1270 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1271 
»t
 = 0;

1273 
	`hfi1_š™_ùxt
(
uùxt
->
sc
);

1280 ià(
£lšux_mode
 == 1) {

1281 ià(
	`uÆik–y
(
´št_£_bªÃr
)) {

1282 
´št_£_bªÃr
 = 0;

1283 
	`´štk
(
KERN_CRIT
 "-----------------------------------\n");

1284 
	`´štk
(
KERN_CRIT
 "Experimental SELinux mode‡ctivated\n");

1285 
	`´štk
(
KERN_CRIT
 "-----------------------------------\n");

1287 ià(
	`£cur™y_ib_®loc_£cur™y
(&
uùxt
->
£cur™y
)) {

1288 
»t
 = -
ENOMEM
;

1289 
dÚe
;

1294 
»t
 = 
	`hfi1_ü—‹_rcvhdrq
(
dd
, 
uùxt
);

1295 ià(
»t
)

1296 
dÚe
;

1298 
»t
 = 
	`hfi1_£tup_—g”bufs
(
uùxt
);

1299 ià(
»t
)

1300 
dÚe
;

1303 ià(
uùxt
->
subùxt_út
)

1304 
»t
 = 
	`£tup_subùxt
(
uùxt
);

1305 ià(
»t
)

1306 
dÚe
;

1308 
»t
 = 
	`hfi1_®loc_ùxt_rcv_groups
(
uùxt
);

1309 ià(
»t
)

1310 
dÚe
;

1312 
»t
 = 
	`š™_u£r_ùxt
(
fd
, 
uùxt
);

1313 ià(
»t
)

1314 
dÚe
;

1316 
	`u£r_š™
(
uùxt
);

1319 
fd
->
uùxt
 = uctxt;

1320 
	`hfi1_rcd_g‘
(
uùxt
);

1322 
dÚe
:

1323 ià(
uùxt
->
subùxt_út
) {

1328 ià(
»t
)

1329 
	`£t_b™
(
HFI1_CTXT_BASE_FAILED
, &
uùxt
->
ev’t_æags
);

1335 
	`þ—r_b™
(
HFI1_CTXT_BASE_UNINIT
, &
uùxt
->
ev’t_æags
);

1336 
	`wake_up
(&
uùxt
->
wa™
);

1339  
»t
;

1340 
	}
}

1342 
	$g‘_ba£_šfo
(
hfi1_fžed©a
 *
fd
, 
¬g
, 
u32
 
Ën
)

1344 
hfi1_ba£_šfo
 
bšfo
;

1345 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

1346 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1347 
off£t
;

1349 
	`Œaû_hfi1_uùxtd©a
(
uùxt
->
dd
, uùxt, 
fd
->
subùxt
);

1351 ià((
bšfo
è!ð
Ën
)

1352  -
EINVAL
;

1354 
	`mem£t
(&
bšfo
, 0, (binfo));

1355 
bšfo
.
hw_v”siÚ
 = 
dd
->
»visiÚ
;

1356 
bšfo
.
sw_v”siÚ
 = 
HFI1_KERN_SWVERSION
;

1357 
bšfo
.
bthqp
 = 
RVT_KDETH_QP_PREFIX
;

1358 
	`hfi1_cdbg
(
SEL
, "Hªdšghu£¸thJKey 0x%x", 
uùxt
->
jkey
);

1359 
bšfo
.
jkey
 = 
uùxt
->jkey;

1366 
off£t
 = ((
u64
)
uùxt
->
sc
->
hw_ä“
 -

1367 (
u64
)
dd
->
ü_ba£
[
uùxt
->
numa_id
].
va
è% 
PAGE_SIZE
;

1368 
bšfo
.
sc_üed™s_addr
 = 
	`HFI1_MMAP_TOKEN
(
PIO_CRED
, 
uùxt
->
ùxt
,

1369 
fd
->
subùxt
, 
off£t
);

1370 
bšfo
.
pio_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
PIO_BUFS
, 
uùxt
->
ùxt
,

1371 
fd
->
subùxt
,

1372 
uùxt
->
sc
->
ba£_addr
);

1373 
bšfo
.
pio_bufba£_sÝ
 = 
	`HFI1_MMAP_TOKEN
(
PIO_BUFS_SOP
,

1374 
uùxt
->
ùxt
,

1375 
fd
->
subùxt
,

1376 
uùxt
->
sc
->
ba£_addr
);

1377 
bšfo
.
rcvhdr_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
RCV_HDRQ
, 
uùxt
->
ùxt
,

1378 
fd
->
subùxt
,

1379 
uùxt
->
rcvhdrq
);

1380 
bšfo
.
rcvegr_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
RCV_EGRBUF
, 
uùxt
->
ùxt
,

1381 
fd
->
subùxt
,

1382 
uùxt
->
egrbufs
.
rcvtids
[0].
dma
);

1383 
bšfo
.
sdma_comp_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
SDMA_COMP
, 
uùxt
->
ùxt
,

1384 
fd
->
subùxt
, 0);

1389 
bšfo
.
u£r_»gba£
 = 
	`HFI1_MMAP_TOKEN
(
UREGS
, 
uùxt
->
ùxt
,

1390 
fd
->
subùxt
, 0);

1391 
off£t
 = 
	`off£t_š_·ge
((
	`uùxt_off£t
(
uùxt
è+ 
fd
->
subùxt
) *

1392 (*
dd
->
ev’ts
));

1393 
bšfo
.
ev’ts_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
EVENTS
, 
uùxt
->
ùxt
,

1394 
fd
->
subùxt
,

1395 
off£t
);

1396 
bšfo
.
¡©us_bufba£
 = 
	`HFI1_MMAP_TOKEN
(
STATUS
, 
uùxt
->
ùxt
,

1397 
fd
->
subùxt
,

1398 
dd
->
¡©us
);

1399 ià(
	`HFI1_CAP_IS_USET
(
DMA_RTAIL
))

1400 
bšfo
.
rcvhd¹až_ba£
 = 
	`HFI1_MMAP_TOKEN
(
RTAIL
, 
uùxt
->
ùxt
,

1401 
fd
->
subùxt
, 0);

1402 ià(
uùxt
->
subùxt_út
) {

1403 
bšfo
.
subùxt_u»gba£
 = 
	`HFI1_MMAP_TOKEN
(
SUBCTXT_UREGS
,

1404 
uùxt
->
ùxt
,

1405 
fd
->
subùxt
, 0);

1406 
bšfo
.
subùxt_rcvhdrbuf
 = 
	`HFI1_MMAP_TOKEN
(
SUBCTXT_RCV_HDRQ
,

1407 
uùxt
->
ùxt
,

1408 
fd
->
subùxt
, 0);

1409 
bšfo
.
subùxt_rcvegrbuf
 = 
	`HFI1_MMAP_TOKEN
(
SUBCTXT_EGRBUF
,

1410 
uùxt
->
ùxt
,

1411 
fd
->
subùxt
, 0);

1414 ià(
	`cÝy_to_u£r
((
__u£r
 *)
¬g
, &
bšfo
, 
Ën
))

1415  -
EFAULT
;

1418 
	}
}

1429 
u£r_exp_rcv_£tup
(
hfi1_fžed©a
 *
fd
, 
¬g
,

1430 #ifdeà
NVIDIA_GPU_DIRECT


1431 
ioùl_cmd
,

1433 
u32
 
Ën
)

1435 
	g»t
;

1436 
	gaddr
;

1437 #iâdeà
NVIDIA_GPU_DIRECT


1438 
hfi1_tid_šfo
 
	gtšfo
;

1440 ià((
	gtšfo
è!ð
Ën
)

1441  -
EINVAL
;

1443 ià(
cÝy_äom_u£r
(&
tšfo
, (
__u£r
 *)
¬g
, ((tinfo))))

1444  -
	gEFAULT
;

1446 
size_t
 
	gsizeof_tšfo_cÝy
;

1447 
hfi1_tid_šfo_v2
 
	gtšfo
;

1449 
mem£t
(&
tšfo
, 0, (tinfo));

1450 ià(
	gioùl_cmd
 =ð
HFI1_IOCTL_TID_UPDATE_V2
)

1451 
sizeof_tšfo_cÝy
 = (
hfi1_tid_šfo_v2
);

1453 
	gsizeof_tšfo_cÝy
 = (
hfi1_tid_šfo
);

1455 ià(
	gsizeof_tšfo_cÝy
 !ð
Ën
)

1456  -
EINVAL
;

1458 ià(
cÝy_äom_u£r
(&
tšfo
, (
__u£r
 *)
¬g
, (
sizeof_tšfo_cÝy
)))

1459  -
	gEFAULT
;

1462 
	g»t
 = 
hfi1_u£r_exp_rcv_£tup
(
fd
, &
tšfo
);

1463 ià(!
	g»t
) {

1468 
	gaddr
 = 
¬g
 + 
off£tof
(
hfi1_tid_šfo
, 
tidút
);

1469 ià(
cÝy_to_u£r
((
__u£r
 *)
addr
, &
tšfo
.
tidút
,

1470 (
tšfo
.
tidút
)))

1471  -
	gEFAULT
;

1473 
	gaddr
 = 
¬g
 + 
off£tof
(
hfi1_tid_šfo
, 
Ëngth
);

1474 ià(
cÝy_to_u£r
((
__u£r
 *)
addr
, &
tšfo
.
Ëngth
,

1475 (
tšfo
.
Ëngth
)))

1476 
	g»t
 = -
EFAULT
;

1479  
	g»t
;

1492 
	$u£r_exp_rcv_þ—r
(
hfi1_fžed©a
 *
fd
, 
¬g
,

1493 
u32
 
Ën
)

1495 
»t
;

1496 
addr
;

1497 
hfi1_tid_šfo
 
tšfo
;

1499 ià((
tšfo
è!ð
Ën
)

1500  -
EINVAL
;

1502 ià(
	`cÝy_äom_u£r
(&
tšfo
, (
__u£r
 *)
¬g
, ((tinfo))))

1503  -
EFAULT
;

1505 
»t
 = 
	`hfi1_u£r_exp_rcv_þ—r
(
fd
, &
tšfo
);

1506 ià(!
»t
) {

1507 
addr
 = 
¬g
 + 
	`off£tof
(
hfi1_tid_šfo
, 
tidút
);

1508 ià(
	`cÝy_to_u£r
((
__u£r
 *)
addr
, &
tšfo
.
tidút
,

1509 (
tšfo
.
tidút
)))

1510  -
EFAULT
;

1513  
»t
;

1514 
	}
}

1525 
	$u£r_exp_rcv_šv®id
(
hfi1_fžed©a
 *
fd
, 
¬g
,

1526 
u32
 
Ën
)

1528 
»t
;

1529 
addr
;

1530 
hfi1_tid_šfo
 
tšfo
;

1532 ià((
tšfo
è!ð
Ën
)

1533  -
EINVAL
;

1535 ià(!
fd
->
šv®id_tids
)

1536  -
EINVAL
;

1538 ià(
	`cÝy_äom_u£r
(&
tšfo
, (
__u£r
 *)
¬g
, ((tinfo))))

1539  -
EFAULT
;

1541 
»t
 = 
	`hfi1_u£r_exp_rcv_šv®id
(
fd
, &
tšfo
);

1542 ià(
»t
)

1543  
»t
;

1545 
addr
 = 
¬g
 + 
	`off£tof
(
hfi1_tid_šfo
, 
tidút
);

1546 ià(
	`cÝy_to_u£r
((
__u£r
 *)
addr
, &
tšfo
.
tidút
,

1547 (
tšfo
.
tidút
)))

1548 
»t
 = -
EFAULT
;

1550  
»t
;

1551 
	}
}

1553 
__pÞl_t
 
	$pÞl_urg’t
(
fže
 *
å
,

1554 
pÞl_bË_¡ruù
 *
±
)

1556 
hfi1_fžed©a
 *
fd
 = 
å
->
´iv©e_d©a
;

1557 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

1558 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1559 
__pÞl_t
 
pÞlæag
;

1561 
	`pÞl_wa™
(
å
, &
uùxt
->
wa™
, 
±
);

1563 
	`¥š_lock_œq
(&
dd
->
uùxt_lock
);

1564 ià(
uùxt
->
urg’t
 !ðuùxt->
urg’t_pÞl
) {

1565 
pÞlæag
 = 
EPOLLIN
 | 
EPOLLRDNORM
;

1566 
uùxt
->
urg’t_pÞl
 = uùxt->
urg’t
;

1568 
pÞlæag
 = 0;

1569 
	`£t_b™
(
HFI1_CTXT_WAITING_URG
, &
uùxt
->
ev’t_æags
);

1571 
	`¥š_uÆock_œq
(&
dd
->
uùxt_lock
);

1573  
pÞlæag
;

1574 
	}
}

1576 
__pÞl_t
 
	$pÞl_Ãxt
(
fže
 *
å
,

1577 
pÞl_bË_¡ruù
 *
±
)

1579 
hfi1_fžed©a
 *
fd
 = 
å
->
´iv©e_d©a
;

1580 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

1581 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1582 
__pÞl_t
 
pÞlæag
;

1584 
	`pÞl_wa™
(
å
, &
uùxt
->
wa™
, 
±
);

1586 
	`¥š_lock_œq
(&
dd
->
uùxt_lock
);

1587 ià(
	`hdrqem±y
(
uùxt
)) {

1588 
	`£t_b™
(
HFI1_CTXT_WAITING_RCV
, &
uùxt
->
ev’t_æags
);

1589 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_INTRAVAIL_ENB
, 
uùxt
);

1590 
pÞlæag
 = 0;

1592 
pÞlæag
 = 
EPOLLIN
 | 
EPOLLRDNORM
;

1594 
	`¥š_uÆock_œq
(&
dd
->
uùxt_lock
);

1596  
pÞlæag
;

1597 
	}
}

1604 
	$hfi1_£t_uev’t_b™s
(
hfi1_µÜtd©a
 *
µd
, cÚ¡ 
evtb™
)

1606 
hfi1_ùxtd©a
 *
uùxt
;

1607 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1608 
u16
 
ùxt
;

1610 ià(!
dd
->
ev’ts
)

1611  -
EINVAL
;

1613 
ùxt
 = 
dd
->
fœ¡_dyn_®loc_ùxt
; ctxˆ< dd->
num_rcv_cÚ‹xts
;

1614 
ùxt
++) {

1615 
uùxt
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
ùxt
);

1616 ià(
uùxt
) {

1617 *
evs
;

1618 
i
;

1623 
evs
 = 
dd
->
ev’ts
 + 
	`uùxt_off£t
(
uùxt
);

1624 
	`£t_b™
(
evtb™
, 
evs
);

1625 
i
 = 1; i < 
uùxt
->
subùxt_út
; i++)

1626 
	`£t_b™
(
evtb™
, 
evs
 + 
i
);

1627 
	`hfi1_rcd_put
(
uùxt
);

1632 
	}
}

1644 
	$mªage_rcvq
(
hfi1_ùxtd©a
 *
uùxt
, 
u16
 
subùxt
,

1645 
¬g
)

1647 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1648 
rcvù¾_Ý
;

1649 
¡¬t_¡Ý
;

1651 ià(
subùxt
)

1654 ià(
	`g‘_u£r
(
¡¬t_¡Ý
, (
__u£r
 *)
¬g
))

1655  -
EFAULT
;

1658 ià(
¡¬t_¡Ý
) {

1667 
	`þ—r_rcvhd¹až
(
uùxt
);

1668 
rcvù¾_Ý
 = 
HFI1_RCVCTRL_CTXT_ENB
;

1670 
rcvù¾_Ý
 = 
HFI1_RCVCTRL_CTXT_DIS
;

1672 
	`hfi1_rcvù¾
(
dd
, 
rcvù¾_Ý
, 
uùxt
);

1676 
	}
}

1683 
	$u£r_ev’t_ack
(
hfi1_ùxtd©a
 *
uùxt
, 
u16
 
subùxt
,

1684 
¬g
)

1686 
i
;

1687 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1688 *
evs
;

1689 
ev’ts
;

1691 ià(!
dd
->
ev’ts
)

1694 ià(
	`g‘_u£r
(
ev’ts
, (
__u£r
 *)
¬g
))

1695  -
EFAULT
;

1697 
evs
 = 
dd
->
ev’ts
 + 
	`uùxt_off£t
(
uùxt
è+ 
subùxt
;

1699 
i
 = 0; i <ð
_HFI1_MAX_EVENT_BIT
; i++) {

1700 ià(!
	`‹¡_b™
(
i
, &
ev’ts
))

1702 
	`þ—r_b™
(
i
, 
evs
);

1705 
	}
}

1707 
	$£t_£cu»_jkey
(
hfi1_ùxtd©a
 *
uùxt
, 
u16
 
pkey_idx
)

1714 
uùxt
->
jkey
 &ð
JKEY_SEC_MASK
;

1715 
uùxt
->
jkey
 = (
pkey_idx
 << 
JKEY_SEC_SPLIT
) | uctxt->jkey;

1716 
	`hfi1_cdbg
(
SEL
, "PKey index %u JKey 0x%x", 
pkey_idx
, 
uùxt
->
jkey
);

1717 
	`hfi1_£t_ùxt_jkey
(
uùxt
->
dd
, uùxt, uùxt->
jkey
);

1718 
	}
}

1720 
	$£t_ùxt_pkey
(
hfi1_ùxtd©a
 *
uùxt
, 
¬g
)

1722 
i
;

1723 
hfi1_µÜtd©a
 *
µd
 = 
uùxt
->ppd;

1724 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

1725 
u16
 
pkey
;

1726 
»t
;

1727 
u64
 
subÃt_´efix
;

1733 ià(
uùxt
->
£cur™y
)

1734 ià(
	`hfi1_g‘_v”bs_subÃt_´efix
(
dd
, 1, &
subÃt_´efix
))

1735  -
EINVAL
;

1737 ià(!
	`HFI1_CAP_IS_USET
(
PKEY_CHECK
))

1738  -
EPERM
;

1740 ià(
	`g‘_u£r
(
pkey
, (
u16
 
__u£r
 *)
¬g
))

1741  -
EFAULT
;

1743 
	`hfi1_cdbg
(
SEL
, "U£¸wªt tØ£ˆPKEY: 0x%x", 
pkey
);

1752 ià(
uùxt
->
£cur™y
)

1753 ià(!(
pkey
 & 
PKEY_MEMBER_MASK
))

1754  -
EINVAL
;

1762 ià(
pkey
 =ð
LIM_MGMT_P_KEY
 ||…key =ð
FULL_MGMT_P_KEY
)

1763  -
EINVAL
;

1765 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); i++) {

1766 
	`hfi1_cdbg
(
SEL
, "Pkey[%d].... 0x%x", 
i
, 
µd
->
pkeys
[i]);

1767 ià(
pkey
 =ð
µd
->
pkeys
[
i
]) {

1772 ià(
uùxt
->
£cur™y
) {

1773 
»t
 = 
	`£cur™y_ib_pkey_acûss
(
uùxt
->
£cur™y
,

1774 
subÃt_´efix
,

1775 
pkey
);

1776 ià(
»t
) {

1777 
	`hfi1_cdbg
(
SEL
, "SELinux is blocking…key");

1778  -
EPERM
;

1780 
	`hfi1_cdbg
(
SEL
, "Found PKEY‡nd user has‡ccess");

1791 
»t
 = 
	`hfi1_£t_ùxt_pkey
(
dd
, 
uùxt
, 
pkey
);

1792 ià(
»t
)

1793  
»t
;

1798 ià(
uùxt
->
£cur™y
)

1799 
	`£t_£cu»_jkey
(
uùxt
, 
i
);

1804  -
ENOENT
;

1805 
	}
}

1811 
	$ùxt_»£t
(
hfi1_ùxtd©a
 *
uùxt
)

1813 
£nd_cÚ‹xt
 *
sc
;

1814 
hfi1_devd©a
 *
dd
;

1815 
»t
 = 0;

1817 ià(!
uùxt
 || !uùxt->
dd
 || !uùxt->
sc
)

1818  -
EINVAL
;

1826 
dd
 = 
uùxt
->dd;

1827 
sc
 = 
uùxt
->sc;

1833 
	`wa™_ev’t_š‹¼u±ibË_timeout
(

1834 
sc
->
h®t_wa™
, (sc->
æags
 & 
SCF_HALTED
),

1835 
	`m£cs_to_jiff›s
(
SEND_CTXT_HALT_TIMEOUT
));

1836 ià(!(
sc
->
æags
 & 
SCF_HALTED
))

1837  -
ENOLCK
;

1843 ià(
sc
->
æags
 & 
SCF_FROZEN
) {

1844 
	`wa™_ev’t_š‹¼u±ibË_timeout
(

1845 
dd
->
ev’t_queue
,

1846 !(
	`READ_ONCE
(
dd
->
æags
è& 
HFI1_FROZEN
),

1847 
	`m£cs_to_jiff›s
(
SEND_CTXT_HALT_TIMEOUT
));

1848 ià(
dd
->
æags
 & 
HFI1_FROZEN
)

1849  -
ENOLCK
;

1851 ià(
dd
->
æags
 & 
HFI1_FORCED_FREEZE
)

1856  -
ENODEV
;

1858 
	`sc_di§bË
(
sc
);

1859 
»t
 = 
	`sc_’abË
(
sc
);

1860 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_CTXT_ENB
, 
uùxt
);

1862 
»t
 = 
	`sc_»¡¬t
(
sc
);

1864 ià(!
»t
)

1865 
	`sc_»tuº_üed™s
(
sc
);

1867  
»t
;

1868 
	}
}

1870 
	$u£r_»move
(
hfi1_devd©a
 *
dd
)

1873 
	`hfi1_cdev_þ—nup
(&
dd
->
u£r_cdev
, &dd->
u£r_deviû
);

1874 
	}
}

1876 
	$u£r_add
(
hfi1_devd©a
 *
dd
)

1878 
Çme
[10];

1879 
»t
;

1881 
	`¢´štf
(
Çme
, Òame), "%s_%d", 
	`þass_Çme
(), 
dd
->
un™
);

1882 
»t
 = 
	`hfi1_cdev_š™
(
dd
->
un™
, 
Çme
, &
hfi1_fže_Ýs
,

1883 &
dd
->
u£r_cdev
, &dd->
u£r_deviû
,

1884 
Œue
, &
dd
->
kobj
);

1885 ià(
»t
)

1886 
	`u£r_»move
(
dd
);

1888  
»t
;

1889 
	}
}

1894 
	$hfi1_deviû_ü—‹
(
hfi1_devd©a
 *
dd
)

1896 
	`hfi1_dŸg_add
(
dd
);

1897  
	`u£r_add
(
dd
);

1898 
	}
}

1904 
	$hfi1_deviû_»move
(
hfi1_devd©a
 *
dd
)

1906 
	`hfi1_dŸg_»move
(
dd
);

1907 
	`u£r_»move
(
dd
);

1908 
	}
}

	@firmware.c

48 
	~<lšux/fœmw¬e.h
>

49 
	~<lšux/mu‹x.h
>

50 
	~<lšux/moduË.h
>

51 
	~<lšux/d–ay.h
>

52 
	~<lšux/üc32.h
>

54 
	~"hfi.h
"

55 
	~"Œaû.h
"

62 
	#DEFAULT_FW_8051_NAME_FPGA
 "hfi_dc8051.bš"

	)

63 
	#DEFAULT_FW_8051_NAME_ASIC
 "hfi1_dc8051.fw"

	)

64 
	#DEFAULT_FW_FABRIC_NAME
 "hfi1_çbric.fw"

	)

65 
	#DEFAULT_FW_SBUS_NAME
 "hfi1_sbus.fw"

	)

66 
	#DEFAULT_FW_PCIE_NAME
 "hfi1_pc›.fw"

	)

67 
	#ALT_FW_8051_NAME_ASIC
 "hfi1_dc8051_d.fw"

	)

68 
	#ALT_FW_FABRIC_NAME
 "hfi1_çbric_d.fw"

	)

69 
	#ALT_FW_SBUS_NAME
 "hfi1_sbus_d.fw"

	)

70 
	#ALT_FW_PCIE_NAME
 "hfi1_pc›_d.fw"

	)

72 
MODULE_FIRMWARE
(
DEFAULT_FW_8051_NAME_ASIC
);

73 
MODULE_FIRMWARE
(
DEFAULT_FW_FABRIC_NAME
);

74 
MODULE_FIRMWARE
(
DEFAULT_FW_SBUS_NAME
);

75 
MODULE_FIRMWARE
(
DEFAULT_FW_PCIE_NAME
);

77 
ušt
 
	gfw_8051_lßd
 = 1;

78 
ušt
 
	gfw_çbric_£rdes_lßd
 = 1;

79 
ušt
 
	gfw_pc›_£rdes_lßd
 = 1;

80 
ušt
 
	gfw_sbus_lßd
 = 1;

83 *
	gfw_8051_Çme
;

84 *
	gfw_çbric_£rdes_Çme
;

85 *
	gfw_sbus_Çme
;

86 *
	gfw_pc›_£rdes_Çme
;

88 
	#SBUS_MAX_POLL_COUNT
 100

	)

89 
	#SBUS_COUNTER
(
»g
, 
Çme
) \

90 (((
»g
è>> 
ASIC_STS_SBUS_COUNTERS_
##
Çme
##
_CNT_SHIFT
) & \

91 
ASIC_STS_SBUS_COUNTERS_
##
Çme
##
_CNT_MASK
)

	)

96 
	scss_h—d”
 {

97 
u32
 
	mmoduË_ty³
;

98 
u32
 
	mh—d”_Ën
;

99 
u32
 
	mh—d”_v”siÚ
;

100 
u32
 
	mmoduË_id
;

101 
u32
 
	mmoduË_v’dÜ
;

102 
u32
 
	md©e
;

103 
u32
 
	msize
;

104 
u32
 
	mkey_size
;

105 
u32
 
	mmodulus_size
;

106 
u32
 
	mexpÚ’t_size
;

107 
u32
 
	m»£rved
[22];

111 
	#CSS_MODULE_TYPE
 0x00000006

	)

112 
	#CSS_HEADER_LEN
 0x000000a1

	)

113 
	#CSS_HEADER_VERSION
 0x00010000

	)

114 
	#CSS_MODULE_VENDOR
 0x00008086

	)

116 
	#KEY_SIZE
 256

	)

117 
	#MU_SIZE
 8

	)

118 
	#EXPONENT_SIZE
 4

	)

121 
	#MAX_PLATFORM_CONFIG_FILE_SIZE
 4096

	)

124 
	#PLATFORM_CONFIG_FORMAT_4_FILE_SIZE
 528

	)

127 
	sfœmw¬e_fže
 {

128 
css_h—d”
 
	mcss_h—d”
;

129 
u8
 
	mmodulus
[
KEY_SIZE
];

130 
u8
 
	mexpÚ’t
[
EXPONENT_SIZE
];

131 
u8
 
	msigÇtu»
[
KEY_SIZE
];

132 
u8
 
	mfœmw¬e
[];

135 
	saugm’‹d_fœmw¬e_fže
 {

136 
css_h—d”
 
	mcss_h—d”
;

137 
u8
 
	mmodulus
[
KEY_SIZE
];

138 
u8
 
	mexpÚ’t
[
EXPONENT_SIZE
];

139 
u8
 
	msigÇtu»
[
KEY_SIZE
];

140 
u8
 
	mr2
[
KEY_SIZE
];

141 
u8
 
	mmu
[
MU_SIZE
];

142 
u8
 
	mfœmw¬e
[];

146 
	#AUGMENT_SIZE
 ((
augm’‹d_fœmw¬e_fže
) - \

147 (
fœmw¬e_fže
))

	)

149 
	sfœmw¬e_d‘ažs
 {

151 cÚ¡ 
fœmw¬e
 *
	mfw
;

153 
css_h—d”
 *
	mcss_h—d”
;

154 
u8
 *
	mfœmw¬e_±r
;

155 
u32
 
	mfœmw¬e_Ën
;

156 
u8
 *
	mmodulus
;

157 
u8
 *
	mexpÚ’t
;

158 
u8
 *
	msigÇtu»
;

159 
u8
 *
	mr2
;

160 
u8
 *
	mmu
;

161 
augm’‹d_fœmw¬e_fže
 
	mdummy_h—d”
;

168 
DEFINE_MUTEX
(
fw_mu‹x
);

169 
	efw_¡©e
 {

170 
	mFW_EMPTY
,

171 
	mFW_TRY
,

172 
	mFW_FINAL
,

173 
	mFW_ERR


176 
fw_¡©e
 
	gfw_¡©e
 = 
FW_EMPTY
;

177 
	gfw_”r
;

178 
fœmw¬e_d‘ažs
 
	gfw_8051
;

179 
fœmw¬e_d‘ažs
 
	gfw_çbric
;

180 
fœmw¬e_d‘ažs
 
	gfw_pc›
;

181 
fœmw¬e_d‘ažs
 
	gfw_sbus
;

184 
	#SPICO_SBUS
 0x1

	)

185 
	#SPICO_FABRIC
 0x2

	)

186 
	#ENABLE_SPICO_SMASK
 0x1

	)

189 
	#RSA_CMD_INIT
 0x1

	)

190 
	#RSA_CMD_START
 0x2

	)

193 
	#RSA_STATUS_IDLE
 0x0

	)

194 
	#RSA_STATUS_ACTIVE
 0x1

	)

195 
	#RSA_STATUS_DONE
 0x2

	)

196 
	#RSA_STATUS_FAILED
 0x3

	)

199 
	#RSA_ENGINE_TIMEOUT
 100

	)

202 
	#HM_TIMEOUT
 10

	)

205 
	#DC8051_ACCESS_TIMEOUT
 100

	)

208 
	#NUM_FABRIC_SERDES
 4

	)

211 
	#SBUS_READ_COMPLETE
 0x4

	)

214 cÚ¡ 
u8
 
	gçbric_£rdes_addrs
[2][
NUM_FABRIC_SERDES
] = {

220 cÚ¡ 
u8
 
	gpc›_£rdes_addrs
[2][
NUM_PCIE_SERDES
] = {

228 cÚ¡ 
u8
 
	gpc›_pcs_addrs
[2][
NUM_PCIE_SERDES
] = {

236 cÚ¡ 
u8
 
	gçbric_£rdes_brßdÿ¡
[2] = { 0xe4, 0xe5 };

237 cÚ¡ 
u8
 
	g®l_çbric_£rdes_brßdÿ¡
 = 0xe1;

240 cÚ¡ 
u8
 
	gpc›_£rdes_brßdÿ¡
[2] = { 0xe2, 0xe3 };

241 cÚ¡ 
u8
 
	g®l_pc›_£rdes_brßdÿ¡
 = 0xe0;

243 cÚ¡ 
u32
 
	g¶©fÜm_cÚfig_bË_lim™s
[
PLATFORM_CONFIG_TABLE_MAX
] = {

245 
SYSTEM_TABLE_MAX
,

246 
PORT_TABLE_MAX
,

247 
RX_PRESET_TABLE_MAX
,

248 
TX_PRESET_TABLE_MAX
,

249 
QSFP_ATTEN_TABLE_MAX
,

250 
VARIABLE_SETTINGS_TABLE_MAX


254 
di¥o£_Úe_fœmw¬e
(
fœmw¬e_d‘ažs
 *
fd‘
);

255 
lßd_çbric_£rdes_fœmw¬e
(
hfi1_devd©a
 *
dd
,

256 
fœmw¬e_d‘ažs
 *
fd‘
);

257 
dump_fw_v”siÚ
(
hfi1_devd©a
 *
dd
);

272 
	$__»ad_8051_d©a
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, 
u64
 *
»suÉ
)

274 
u64
 
»g
;

275 
couÁ
;

278 
»g
 = (
addr
 & 
DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_MASK
)

279 << 
DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_SHIFT
;

280 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_CTRL
, 
»g
);

282 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_CTRL
,

283 
»g
 | 
DC_DC8051_CFG_RAM_ACCESS_CTRL_READ_ENA_SMASK
);

286 
couÁ
 = 0;

287 (
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_STATUS
)

288 & 
DC_DC8051_CFG_RAM_ACCESS_STATUS_ACCESS_COMPLETED_SMASK
)

290 
couÁ
++;

291 ià(
couÁ
 > 
DC8051_ACCESS_TIMEOUT
) {

292 
	`dd_dev_”r
(
dd
, "timeout„eading 8051 data\n");

293  -
ENXIO
;

295 
	`nd–ay
(10);

299 *
»suÉ
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_RD_DATA
);

302 
	}
}

308 
	$»ad_8051_d©a
(
hfi1_devd©a
 *
dd
, 
u32
 
addr
, u32 
Ën
, 
u64
 *
»suÉ
)

310 
æags
;

311 
u32
 
dÚe
;

312 
»t
 = 0;

314 
	`¥š_lock_œq§ve
(&
dd
->
dc8051_memlock
, 
æags
);

317 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_SETUP
, 0);

319 
dÚe
 = 0; dÚ< 
Ën
; 
addr
 +ð8, dÚ+ð8, 
»suÉ
++) {

320 
»t
 = 
	`__»ad_8051_d©a
(
dd
, 
addr
, 
»suÉ
);

321 ià(
»t
)

326 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_CTRL
, 0);

328 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
dc8051_memlock
, 
æags
);

330  
»t
;

331 
	}
}

336 
	$wr™e_8051
(
hfi1_devd©a
 *
dd
, 
code
, 
u32
 
¡¬t
,

337 cÚ¡ 
u8
 *
d©a
, 
u32
 
Ën
)

339 
u64
 
»g
;

340 
u32
 
off£t
;

341 
®igÃd
, 
couÁ
;

344 
®igÃd
 = (()
d©a
 & 0x7) == 0;

347 
»g
 = (
code
 ? 
DC_DC8051_CFG_RAM_ACCESS_SETUP_RAM_SEL_SMASK
 : 0ull)

348 | 
DC_DC8051_CFG_RAM_ACCESS_SETUP_AUTO_INCR_ADDR_SMASK
;

349 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_SETUP
, 
»g
);

351 
»g
 = ((
¡¬t
 & 
DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_MASK
)

352 << 
DC_DC8051_CFG_RAM_ACCESS_CTRL_ADDRESS_SHIFT
)

353 | 
DC_DC8051_CFG_RAM_ACCESS_CTRL_WRITE_ENA_SMASK
;

354 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_CTRL
, 
»g
);

357 
off£t
 = 0; off£ˆ< 
Ën
; offset += 8) {

358 
by‹s
 = 
Ën
 - 
off£t
;

360 ià(
by‹s
 < 8) {

361 
»g
 = 0;

362 
	`memýy
(&
»g
, &
d©a
[
off£t
], 
by‹s
);

363 } ià(
®igÃd
) {

364 
»g
 = *(
u64
 *)&
d©a
[
off£t
];

366 
	`memýy
(&
»g
, &
d©a
[
off£t
], 8);

368 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_WR_DATA
, 
»g
);

371 
couÁ
 = 0;

372 (
	`»ad_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_STATUS
)

373 & 
DC_DC8051_CFG_RAM_ACCESS_STATUS_ACCESS_COMPLETED_SMASK
)

375 
couÁ
++;

376 ià(
couÁ
 > 
DC8051_ACCESS_TIMEOUT
) {

377 
	`dd_dev_”r
(
dd
, "timeout writing 8051 data\n");

378  -
ENXIO
;

380 
	`ud–ay
(1);

385 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_CTRL
, 0);

386 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RAM_ACCESS_SETUP
, 0);

389 
	}
}

392 
	$šv®id_h—d”
(
hfi1_devd©a
 *
dd
, cÚ¡ *
wh©
,

393 
u32
 
aùu®
, u32 
ex³ùed
)

395 ià(
aùu®
 =ð
ex³ùed
)

398 
	`dd_dev_”r
(
dd
,

400 
wh©
, 
ex³ùed
, 
aùu®
);

402 
	}
}

407 
	$v”ify_css_h—d”
(
hfi1_devd©a
 *
dd
, 
css_h—d”
 *
css
)

410 ià(
	`šv®id_h—d”
(
dd
, "moduË_ty³", 
css
->
moduË_ty³
,

411 
CSS_MODULE_TYPE
) ||

412 
	`šv®id_h—d”
(
dd
, "h—d”_Ën", 
css
->
h—d”_Ën
,

413 ((
fœmw¬e_fže
) / 4)) ||

414 
	`šv®id_h—d”
(
dd
, "h—d”_v”siÚ", 
css
->
h—d”_v”siÚ
,

415 
CSS_HEADER_VERSION
) ||

416 
	`šv®id_h—d”
(
dd
, "moduË_v’dÜ", 
css
->
moduË_v’dÜ
,

417 
CSS_MODULE_VENDOR
) ||

418 
	`šv®id_h—d”
(
dd
, "key_size", 
css
->
key_size
, 
KEY_SIZE
 / 4) ||

419 
	`šv®id_h—d”
(
dd
, "modulus_size", 
css
->
modulus_size
,

420 
KEY_SIZE
 / 4) ||

421 
	`šv®id_h—d”
(
dd
, "expÚ’t_size", 
css
->
expÚ’t_size
,

422 
EXPONENT_SIZE
 / 4)) {

423  -
EINVAL
;

426 
	}
}

431 
	$·ylßd_check
(
hfi1_devd©a
 *
dd
, cÚ¡ *
Çme
,

432 
fže_size
, 
´efix_size
)

435 ià(
´efix_size
 >ð
fže_size
) {

436 
	`dd_dev_”r
(
dd
,

438 
Çme
, 
fže_size
, 
´efix_size
);

439  -
EINVAL
;

443 
	}
}

450 
	$obš_Úe_fœmw¬e
(
hfi1_devd©a
 *
dd
, cÚ¡ *
Çme
,

451 
fœmw¬e_d‘ažs
 *
fd‘
)

453 
css_h—d”
 *
css
;

454 
»t
;

456 
	`mem£t
(
fd‘
, 0, (*fdet));

458 
»t
 = 
	`»que¡_fœmw¬e
(&
fd‘
->
fw
, 
Çme
, &
dd
->
pcidev
->
dev
);

459 ià(
»t
) {

460 
	`dd_dev_w¬n
(
dd
, "cannot find firmware \"%s\",ƒrr %d\n",

461 
Çme
, 
»t
);

462  
»t
;

466 ià(
fd‘
->
fw
->
size
 < (
css_h—d”
)) {

467 
	`dd_dev_”r
(
dd
, "fœmw¬\"%s\" i toØsm®l\n", 
Çme
);

468 
»t
 = -
EINVAL
;

469 
dÚe
;

471 
css
 = (
css_h—d”
 *)
fd‘
->
fw
->
d©a
;

473 
	`hfi1_cdbg
(
FIRMWARE
, "Fœmw¬% d‘ažs:", 
Çme
);

474 
	`hfi1_cdbg
(
FIRMWARE
, "fžsize: 0x%lx by‹s", 
fd‘
->
fw
->
size
);

475 
	`hfi1_cdbg
(
FIRMWARE
, "CSS structure:");

476 
	`hfi1_cdbg
(
FIRMWARE
, " moduË_ty³ 0x%x", 
css
->
moduË_ty³
);

477 
	`hfi1_cdbg
(
FIRMWARE
, " header_len 0x%03x (0x%03x bytes)",

478 
css
->
h—d”_Ën
, 4 * css->header_len);

479 
	`hfi1_cdbg
(
FIRMWARE
, " h—d”_v”siÚ 0x%x", 
css
->
h—d”_v”siÚ
);

480 
	`hfi1_cdbg
(
FIRMWARE
, " moduË_id 0x%x", 
css
->
moduË_id
);

481 
	`hfi1_cdbg
(
FIRMWARE
, " moduË_v’dÜ 0x%x", 
css
->
moduË_v’dÜ
);

482 
	`hfi1_cdbg
(
FIRMWARE
, " d© 0x%x", 
css
->
d©e
);

483 
	`hfi1_cdbg
(
FIRMWARE
, " size 0x%03x (0x%03x bytes)",

484 
css
->
size
, 4 * css->size);

485 
	`hfi1_cdbg
(
FIRMWARE
, " key_size 0x%03x (0x%03x bytes)",

486 
css
->
key_size
, 4 * css->key_size);

487 
	`hfi1_cdbg
(
FIRMWARE
, " modulus_size 0x%03x (0x%03x bytes)",

488 
css
->
modulus_size
, 4 * css->modulus_size);

489 
	`hfi1_cdbg
(
FIRMWARE
, "ƒxponent_size 0x%03x (0x%03x bytes)",

490 
css
->
expÚ’t_size
, 4 * css->exponent_size);

491 
	`hfi1_cdbg
(
FIRMWARE
, "firmware size: 0x%lx bytes",

492 
fd‘
->
fw
->
size
 - (
fœmw¬e_fže
));

504 
»t
 = 
	`v”ify_css_h—d”
(
dd
, 
css
);

505 ià(
»t
) {

506 
	`dd_dev_šfo
(
dd
, "Inv®id CSS h—d” fÜ \"%s\"\n", 
Çme
);

507 } ià((
css
->
size
 * 4è=ð
fd‘
->
fw
->size) {

509 
fœmw¬e_fže
 *
ff
 = (firmware_file *)

510 
fd‘
->
fw
->
d©a
;

513 
»t
 = 
	`·ylßd_check
(
dd
, 
Çme
, 
fd‘
->
fw
->
size
,

514 (
fœmw¬e_fže
));

515 ià(
»t
 == 0) {

516 
fd‘
->
css_h—d”
 = 
css
;

517 
fd‘
->
modulus
 = 
ff
->modulus;

518 
fd‘
->
expÚ’t
 = 
ff
->exponent;

519 
fd‘
->
sigÇtu»
 = 
ff
->signature;

520 
fd‘
->
r2
 = fd‘->
dummy_h—d”
.r2;

521 
fd‘
->
mu
 = fd‘->
dummy_h—d”
.mu;

522 
fd‘
->
fœmw¬e_±r
 = 
ff
->
fœmw¬e
;

523 
fd‘
->
fœmw¬e_Ën
 = fd‘->
fw
->
size
 -

524 (
fœmw¬e_fže
);

529 
	`dd_dev_”r
(
dd
, "driver is unableo validate firmware without„2‡nd mu (not in firmware file)\n");

530 
»t
 = -
EINVAL
;

532 } ià((
css
->
size
 * 4è+ 
AUGMENT_SIZE
 =ð
fd‘
->
fw
->size) {

534 
augm’‹d_fœmw¬e_fže
 *
aff
 =

535 (
augm’‹d_fœmw¬e_fže
 *)
fd‘
->
fw
->
d©a
;

538 
»t
 = 
	`·ylßd_check
(
dd
, 
Çme
, 
fd‘
->
fw
->
size
,

539 (
augm’‹d_fœmw¬e_fže
));

540 ià(
»t
 == 0) {

541 
fd‘
->
css_h—d”
 = 
css
;

542 
fd‘
->
modulus
 = 
aff
->modulus;

543 
fd‘
->
expÚ’t
 = 
aff
->exponent;

544 
fd‘
->
sigÇtu»
 = 
aff
->signature;

545 
fd‘
->
r2
 = 
aff
->r2;

546 
fd‘
->
mu
 = 
aff
->mu;

547 
fd‘
->
fœmw¬e_±r
 = 
aff
->
fœmw¬e
;

548 
fd‘
->
fœmw¬e_Ën
 = fd‘->
fw
->
size
 -

549 (
augm’‹d_fœmw¬e_fže
);

553 
	`dd_dev_”r
(
dd
,

555 
fd‘
->
fw
->
size
 / 4,

556 (
fd‘
->
fw
->
size
 - 
AUGMENT_SIZE
) / 4,

557 
css
->
size
);

559 
»t
 = -
EINVAL
;

562 
dÚe
:

564 ià(
»t
)

565 
	`di¥o£_Úe_fœmw¬e
(
fd‘
);

566  
»t
;

567 
	}
}

569 
	$di¥o£_Úe_fœmw¬e
(
fœmw¬e_d‘ažs
 *
fd‘
)

571 
	`»Ëa£_fœmw¬e
(
fd‘
->
fw
);

573 
	`mem£t
(
fd‘
, 0, (*fdet));

574 
	}
}

584 
	$__obš_fœmw¬e
(
hfi1_devd©a
 *
dd
)

586 
”r
 = 0;

588 ià(
fw_¡©e
 =ð
FW_FINAL
)

590 ià(
fw_¡©e
 =ð
FW_ERR
)

594 
»Œy
:

595 ià(
fw_¡©e
 =ð
FW_TRY
) {

600 
	`dd_dev_w¬n
(
dd
, "using‡lternate firmware‚ames\n");

606 
	`cÚd_»sched
();

607 ià(
fw_8051_lßd
)

608 
	`di¥o£_Úe_fœmw¬e
(&
fw_8051
);

609 ià(
fw_çbric_£rdes_lßd
)

610 
	`di¥o£_Úe_fœmw¬e
(&
fw_çbric
);

611 ià(
fw_sbus_lßd
)

612 
	`di¥o£_Úe_fœmw¬e
(&
fw_sbus
);

613 ià(
fw_pc›_£rdes_lßd
)

614 
	`di¥o£_Úe_fœmw¬e
(&
fw_pc›
);

615 
fw_8051_Çme
 = 
ALT_FW_8051_NAME_ASIC
;

616 
fw_çbric_£rdes_Çme
 = 
ALT_FW_FABRIC_NAME
;

617 
fw_sbus_Çme
 = 
ALT_FW_SBUS_NAME
;

618 
fw_pc›_£rdes_Çme
 = 
ALT_FW_PCIE_NAME
;

626 
	`u¦“p_¿nge
(100, 120);

629 ià(
fw_sbus_lßd
) {

630 
”r
 = 
	`obš_Úe_fœmw¬e
(
dd
, 
fw_sbus_Çme
, &
fw_sbus
);

631 ià(
”r
)

632 
dÚe
;

635 ià(
fw_pc›_£rdes_lßd
) {

636 
”r
 = 
	`obš_Úe_fœmw¬e
(
dd
, 
fw_pc›_£rdes_Çme
, &
fw_pc›
);

637 ià(
”r
)

638 
dÚe
;

641 ià(
fw_çbric_£rdes_lßd
) {

642 
”r
 = 
	`obš_Úe_fœmw¬e
(
dd
, 
fw_çbric_£rdes_Çme
,

643 &
fw_çbric
);

644 ià(
”r
)

645 
dÚe
;

648 ià(
fw_8051_lßd
) {

649 
”r
 = 
	`obš_Úe_fœmw¬e
(
dd
, 
fw_8051_Çme
, &
fw_8051
);

650 ià(
”r
)

651 
dÚe
;

654 
dÚe
:

655 ià(
”r
) {

657 ià(
fw_¡©e
 =ð
FW_EMPTY
 && 
dd
->
icode
 =ð
ICODE_RTL_SILICON
) {

659 
fw_¡©e
 = 
FW_TRY
;

660 
»Œy
;

662 
	`dd_dev_”r
(
dd
, "unableo obtain working firmware\n");

663 
fw_¡©e
 = 
FW_ERR
;

664 
fw_”r
 = -
ENOENT
;

667 ià(
fw_¡©e
 =ð
FW_EMPTY
 &&

668 
dd
->
icode
 !ð
ICODE_FUNCTIONAL_SIMULATOR
)

669 
fw_¡©e
 = 
FW_TRY
;

671 
fw_¡©e
 = 
FW_FINAL
;

673 
	}
}

684 
	$obš_fœmw¬e
(
hfi1_devd©a
 *
dd
)

686 
timeout
;

688 
	`mu‹x_lock
(&
fw_mu‹x
);

691 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(40000);

692 
fw_¡©e
 =ð
FW_TRY
) {

697 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

699 
	`dd_dev_”r
(
dd
, "Timeout waiting for firmwarery");

700 
fw_¡©e
 = 
FW_ERR
;

701 
fw_”r
 = -
ETIMEDOUT
;

704 
	`mu‹x_uÆock
(&
fw_mu‹x
);

705 
	`m¦“p
(20);

706 
	`mu‹x_lock
(&
fw_mu‹x
);

711 ià(
fw_¡©e
 =ð
FW_EMPTY
)

712 
	`__obš_fœmw¬e
(
dd
);

714 
	`mu‹x_uÆock
(&
fw_mu‹x
);

715  
fw_”r
;

716 
	}
}

729 
	$di¥o£_fœmw¬e
()

731 
	`di¥o£_Úe_fœmw¬e
(&
fw_8051
);

732 
	`di¥o£_Úe_fœmw¬e
(&
fw_çbric
);

733 
	`di¥o£_Úe_fœmw¬e
(&
fw_pc›
);

734 
	`di¥o£_Úe_fœmw¬e
(&
fw_sbus
);

737 ià(
fw_¡©e
 !ð
FW_ERR
)

738 
fw_¡©e
 = 
FW_EMPTY
;

739 
	}
}

746 
	$»Œy_fœmw¬e
(
hfi1_devd©a
 *
dd
, 
lßd_»suÉ
)

748 
»Œy
;

750 
	`mu‹x_lock
(&
fw_mu‹x
);

752 ià(
lßd_»suÉ
 == 0) {

757 ià(
fw_¡©e
 =ð
FW_TRY
)

758 
fw_¡©e
 = 
FW_FINAL
;

759 
»Œy
 = 0;

760 } ià(
fw_¡©e
 =ð
FW_TRY
) {

762 
	`__obš_fœmw¬e
(
dd
);

763 
»Œy
 = (
fw_¡©e
 =ð
FW_FINAL
);

766 
»Œy
 = 0;

769 
	`mu‹x_uÆock
(&
fw_mu‹x
);

770  
»Œy
;

771 
	}
}

777 
	$wr™e_r§_d©a
(
hfi1_devd©a
 *
dd
, 
wh©
,

778 cÚ¡ 
u8
 *
d©a
, 
nby‹s
)

780 
qw_size
 = 
nby‹s
 / 8;

781 
i
;

783 ià((()
d©a
 & 0x7) == 0) {

785 
u64
 *
±r
 = (u64 *)
d©a
;

787 
i
 = 0; i < 
qw_size
; i++, 
±r
++)

788 
	`wr™e_c¤
(
dd
, 
wh©
 + (8 * 
i
), *
±r
);

791 
i
 = 0; i < 
qw_size
; i++, 
d©a
 += 8) {

792 
u64
 
v®ue
;

794 
	`memýy
(&
v®ue
, 
d©a
, 8);

795 
	`wr™e_c¤
(
dd
, 
wh©
 + (8 * 
i
), 
v®ue
);

798 
	}
}

804 
	$wr™e_¡»amed_r§_d©a
(
hfi1_devd©a
 *
dd
, 
wh©
,

805 cÚ¡ 
u8
 *
d©a
, 
nby‹s
)

807 
u64
 *
±r
 = (u64 *)
d©a
;

808 
qw_size
 = 
nby‹s
 / 8;

810 ; 
qw_size
 > 0; qw_size--, 
±r
++)

811 
	`wr™e_c¤
(
dd
, 
wh©
, *
±r
);

812 
	}
}

818 
	$run_r§
(
hfi1_devd©a
 *
dd
, cÚ¡ *
who
,

819 cÚ¡ 
u8
 *
sigÇtu»
)

821 
timeout
;

822 
u64
 
»g
;

823 
u32
 
¡©us
;

824 
»t
 = 0;

827 
	`wr™e_r§_d©a
(
dd
, 
MISC_CFG_RSA_SIGNATURE
, 
sigÇtu»
, 
KEY_SIZE
);

830 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_CMD
, 
RSA_CMD_INIT
);

836 
¡©us
 = (
	`»ad_c¤
(
dd
, 
MISC_CFG_FW_CTRL
)

837 & 
MISC_CFG_FW_CTRL_RSA_STATUS_SMASK
)

838 >> 
MISC_CFG_FW_CTRL_RSA_STATUS_SHIFT
;

839 ià(
¡©us
 !ð
RSA_STATUS_IDLE
) {

840 
	`dd_dev_”r
(
dd
, "%s securityƒngine‚ot idle - giving up\n",

841 
who
);

842  -
EBUSY
;

846 
	`wr™e_c¤
(
dd
, 
MISC_CFG_RSA_CMD
, 
RSA_CMD_START
);

869 
timeout
 = 
	`m£cs_to_jiff›s
(
RSA_ENGINE_TIMEOUT
è+ 
jiff›s
;

871 
¡©us
 = (
	`»ad_c¤
(
dd
, 
MISC_CFG_FW_CTRL
)

872 & 
MISC_CFG_FW_CTRL_RSA_STATUS_SMASK
)

873 >> 
MISC_CFG_FW_CTRL_RSA_STATUS_SHIFT
;

875 ià(
¡©us
 =ð
RSA_STATUS_IDLE
) {

877 
	`dd_dev_”r
(
dd
, "%s firmware security bad idle state\n",

878 
who
);

879 
»t
 = -
EINVAL
;

881 } ià(
¡©us
 =ð
RSA_STATUS_DONE
) {

884 } ià(
¡©us
 =ð
RSA_STATUS_FAILED
) {

886 
»t
 = -
EINVAL
;

891 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

897 
	`dd_dev_”r
(
dd
, "% fœmw¬£cur™yimout\n", 
who
);

898 
»t
 = -
ETIMEDOUT
;

902 
	`m¦“p
(20);

911 
	`wr™e_c¤
(
dd
, 
MISC_ERR_CLEAR
,

912 
MISC_ERR_STATUS_MISC_FW_AUTH_FAILED_ERR_SMASK
 |

913 
MISC_ERR_STATUS_MISC_KEY_MISMATCH_ERR_SMASK
);

919 
»g
 = 
	`»ad_c¤
(
dd
, 
MISC_ERR_STATUS
);

920 ià(
»t
) {

921 ià(
»g
 & 
MISC_ERR_STATUS_MISC_FW_AUTH_FAILED_ERR_SMASK
)

922 
	`dd_dev_w¬n
(
dd
, "%s firmware‡uthorization failed\n",

923 
who
);

924 ià(
»g
 & 
MISC_ERR_STATUS_MISC_KEY_MISMATCH_ERR_SMASK
)

925 
	`dd_dev_w¬n
(
dd
, "% fœmw¬key mism©ch\n", 
who
);

928  
»t
;

929 
	}
}

931 
	$lßd_£cur™y_v¬ŸbËs
(
hfi1_devd©a
 *
dd
,

932 
fœmw¬e_d‘ažs
 *
fd‘
)

935 
	`wr™e_r§_d©a
(
dd
, 
MISC_CFG_RSA_MODULUS
, 
fd‘
->
modulus
, 
KEY_SIZE
);

937 
	`wr™e_r§_d©a
(
dd
, 
MISC_CFG_RSA_R2
, 
fd‘
->
r2
, 
KEY_SIZE
);

939 
	`wr™e_r§_d©a
(
dd
, 
MISC_CFG_RSA_MU
, 
fd‘
->
mu
, 
MU_SIZE
);

941 
	`wr™e_¡»amed_r§_d©a
(
dd
, 
MISC_CFG_SHA_PRELOAD
,

942 (
u8
 *)
fd‘
->
css_h—d”
,

943 (
css_h—d”
));

944 
	}
}

947 
šlše
 
u32
 
	$g‘_fœmw¬e_¡©e
(
hfi1_devd©a
 *
dd
)

949 
u64
 
»g
 = 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_CUR_STATE
);

951  (
»g
 >> 
DC_DC8051_STS_CUR_STATE_FIRMWARE_SHIFT
)

952 & 
DC_DC8051_STS_CUR_STATE_FIRMWARE_MASK
;

953 
	}
}

959 
	$wa™_fm_»ady
(
hfi1_devd©a
 *
dd
, 
u32
 
m¡imeout
)

961 
timeout
;

964 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
)

967 
timeout
 = 
	`m£cs_to_jiff›s
(
m¡imeout
è+ 
jiff›s
;

969 ià(
	`g‘_fœmw¬e_¡©e
(
dd
) == 0xa0)

971 ià(
	`time_aá”
(
jiff›s
, 
timeout
))

972  -
ETIMEDOUT
;

973 
	`u¦“p_¿nge
(1950, 2050);

975 
	}
}

980 
	$lßd_8051_fœmw¬e
(
hfi1_devd©a
 *
dd
,

981 
fœmw¬e_d‘ažs
 *
fd‘
)

983 
u64
 
»g
;

984 
»t
;

985 
u8
 
v”_majÜ
;

986 
u8
 
v”_mšÜ
;

987 
u8
 
v”_·tch
;

996 
»g
 = 
DC_DC8051_CFG_RST_M8051W_SMASK


997 | 
DC_DC8051_CFG_RST_CRAM_SMASK


998 | 
DC_DC8051_CFG_RST_DRAM_SMASK


999 | 
DC_DC8051_CFG_RST_IRAM_SMASK


1000 | 
DC_DC8051_CFG_RST_SFR_SMASK
;

1001 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RST
, 
»g
);

1012 
»g
 = 
DC_DC8051_CFG_RST_M8051W_SMASK
;

1013 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RST
, 
»g
);

1016 
	`lßd_£cur™y_v¬ŸbËs
(
dd
, 
fd‘
);

1021 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 0);

1024 
»t
 = 
	`wr™e_8051
(
dd
, 1 , 0, 
fd‘
->
fœmw¬e_±r
,

1025 
fd‘
->
fœmw¬e_Ën
);

1026 ià(
»t
)

1027  
»t
;

1035 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 
MISC_CFG_FW_CTRL_FW_8051_LOADED_SMASK
);

1038 
»t
 = 
	`run_r§
(
dd
, "8051", 
fd‘
->
sigÇtu»
);

1039 ià(
»t
)

1040  
»t
;

1043 
	`wr™e_c¤
(
dd
, 
DC_DC8051_CFG_RST
, 0ull);

1049 
»t
 = 
	`wa™_fm_»ady
(
dd
, 
TIMEOUT_8051_START
);

1050 ià(
»t
) {

1051 
	`dd_dev_”r
(
dd
, "8051 startimeout, current state 0x%x\n",

1052 
	`g‘_fœmw¬e_¡©e
(
dd
));

1053  -
ETIMEDOUT
;

1056 
	`»ad_misc_¡©us
(
dd
, &
v”_majÜ
, &
v”_mšÜ
, &
v”_·tch
);

1057 
	`dd_dev_šfo
(
dd
, "8051 firmware version %d.%d.%d\n",

1058 ()
v”_majÜ
, ()
v”_mšÜ
, ()
v”_·tch
);

1059 
dd
->
dc8051_v”
 = 
	`dc8051_v”
(
v”_majÜ
, 
v”_mšÜ
, 
v”_·tch
);

1060 
»t
 = 
	`wr™e_ho¡_š‹rçû_v”siÚ
(
dd
, 
HOST_INTERFACE_VERSION
);

1061 ià(
»t
 !ð
HCMD_SUCCESS
) {

1062 
	`dd_dev_”r
(
dd
,

1064 
»t
);

1065  -
EIO
;

1069 
	}
}

1076 
	$sbus_»que¡
(
hfi1_devd©a
 *
dd
,

1077 
u8
 
»ûiv”_addr
, u8 
d©a_addr
, u8 
commªd
, 
u32
 
d©a_š
)

1079 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SBUS_REQUEST
,

1080 ((
u64
)
d©a_š
 << 
ASIC_CFG_SBUS_REQUEST_DATA_IN_SHIFT
) |

1081 ((
u64
)
commªd
 << 
ASIC_CFG_SBUS_REQUEST_COMMAND_SHIFT
) |

1082 ((
u64
)
d©a_addr
 << 
ASIC_CFG_SBUS_REQUEST_DATA_ADDR_SHIFT
) |

1083 ((
u64
)
»ûiv”_addr
 <<

1084 
ASIC_CFG_SBUS_REQUEST_RECEIVER_ADDR_SHIFT
));

1085 
	}
}

1092 
u32
 
	$sbus_»ad
(
hfi1_devd©a
 *
dd
, 
u8
 
»ûiv”_addr
, u8 
d©a_addr
,

1093 
u32
 
d©a_š
)

1095 
u64
 
»g
;

1096 
»Œ›s
;

1097 
sucûss
 = 0;

1098 
u32
 
»suÉ
 = 0;

1099 
u32
 
»suÉ_code
 = 0;

1101 
	`sbus_»que¡
(
dd
, 
»ûiv”_addr
, 
d©a_addr
, 
READ_SBUS_RECEIVER
, 
d©a_š
);

1103 
»Œ›s
 = 0;„etries < 100;„etries++) {

1104 
	`u¦“p_¿nge
(1000, 1200);

1105 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_RESULT
);

1106 
»suÉ_code
 = (
»g
 >> 
ASIC_STS_SBUS_RESULT_RESULT_CODE_SHIFT
)

1107 & 
ASIC_STS_SBUS_RESULT_RESULT_CODE_MASK
;

1108 ià(
»suÉ_code
 !ð
SBUS_READ_COMPLETE
)

1111 
sucûss
 = 1;

1112 
»suÉ
 = (
»g
 >> 
ASIC_STS_SBUS_RESULT_DATA_OUT_SHIFT
)

1113 & 
ASIC_STS_SBUS_RESULT_DATA_OUT_MASK
;

1117 ià(!
sucûss
) {

1118 
	`dd_dev_”r
(
dd
, "%s:„—d fažed,„esuÉ cod0x%x\n", 
__func__
,

1119 
»suÉ_code
);

1122  
»suÉ
;

1123 
	}
}

1133 
	$tuº_off_¥icos
(
hfi1_devd©a
 *
dd
, 
æags
)

1136 ià(!
	`is_ax
(
dd
))

1139 
	`dd_dev_šfo
(
dd
, "Turning off spicos:%s%s\n",

1140 
æags
 & 
SPICO_SBUS
 ? " SBus" : "",

1141 
æags
 & 
SPICO_FABRIC
 ? " fabric" : "");

1143 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 
ENABLE_SPICO_SMASK
);

1145 ià(
æags
 & 
SPICO_SBUS
)

1146 
	`sbus_»que¡
(
dd
, 
SBUS_MASTER_BROADCAST
, 0x01,

1147 
WRITE_SBUS_RECEIVER
, 0x00000040);

1150 ià(
æags
 & 
SPICO_FABRIC
)

1151 
	`sbus_»que¡
(
dd
, 
çbric_£rdes_brßdÿ¡
[dd->
hfi1_id
],

1152 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000000);

1153 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 0);

1154 
	}
}

1170 
	$çbric_£rdes_»£t
(
hfi1_devd©a
 *
dd
)

1172 
»t
;

1174 ià(!
fw_çbric_£rdes_lßd
)

1177 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_SBUS
, 
SBUS_TIMEOUT
);

1178 ià(
»t
) {

1179 
	`dd_dev_”r
(
dd
,

1183 
	`£t_sbus_ç¡_mode
(
dd
);

1185 ià(
	`is_ax
(
dd
)) {

1187 
u8
 
¿
 = 
çbric_£rdes_brßdÿ¡
[
dd
->
hfi1_id
];

1190 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000011);

1192 
	`ud–ay
(1);

1194 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000010);

1196 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000002);

1198 
	`tuº_off_¥icos
(
dd
, 
SPICO_FABRIC
);

1206 ()
	`lßd_çbric_£rdes_fœmw¬e
(
dd
, &
fw_çbric
);

1209 
	`þ—r_sbus_ç¡_mode
(
dd
);

1210 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_SBUS
);

1211 
	}
}

1214 
	$sbus_»que¡_¦ow
(
hfi1_devd©a
 *
dd
,

1215 
u8
 
»ûiv”_addr
, u8 
d©a_addr
, u8 
commªd
, 
u32
 
d©a_š
)

1217 
u64
 
»g
, 
couÁ
 = 0;

1220 
	`þ—r_sbus_ç¡_mode
(
dd
);

1222 
	`sbus_»que¡
(
dd
, 
»ûiv”_addr
, 
d©a_addr
, 
commªd
, 
d©a_š
);

1223 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SBUS_EXECUTE
,

1224 
ASIC_CFG_SBUS_EXECUTE_EXECUTE_SMASK
);

1226 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_RESULT
);

1227 !((
»g
 & 
ASIC_STS_SBUS_RESULT_DONE_SMASK
) &&

1228 (
»g
 & 
ASIC_STS_SBUS_RESULT_RCV_DATA_VALID_SMASK
))) {

1229 ià(
couÁ
++ >ð
SBUS_MAX_POLL_COUNT
) {

1230 
u64
 
couÁs
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_COUNTERS
);

1236 ià((
»g
 & 
ASIC_STS_SBUS_RESULT_DONE_SMASK
) &&

1237 (
	`SBUS_COUNTER
(
couÁs
, 
RCV_DATA_VALID
) ==

1238 
	`SBUS_COUNTER
(
couÁs
, 
EXECUTE
)))

1240  -
ETIMEDOUT
;

1242 
	`ud–ay
(1);

1243 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_RESULT
);

1245 
couÁ
 = 0;

1246 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SBUS_EXECUTE
, 0);

1248 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_RESULT
);

1249 
»g
 & 
ASIC_STS_SBUS_RESULT_DONE_SMASK
) {

1250 ià(
couÁ
++ >ð
SBUS_MAX_POLL_COUNT
)

1251  -
ETIME
;

1252 
	`ud–ay
(1);

1253 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_RESULT
);

1256 
	}
}

1258 
	$lßd_çbric_£rdes_fœmw¬e
(
hfi1_devd©a
 *
dd
,

1259 
fœmw¬e_d‘ažs
 *
fd‘
)

1261 
i
, 
”r
;

1262 cÚ¡ 
u8
 
¿
 = 
çbric_£rdes_brßdÿ¡
[
dd
->
hfi1_id
];

1264 
	`dd_dev_šfo
(
dd
, "Downloading fabric firmware\n");

1267 
	`lßd_£cur™y_v¬ŸbËs
(
dd
, 
fd‘
);

1269 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000011);

1271 
	`ud–ay
(1);

1273 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000010);

1275 
	`sbus_»que¡
(
dd
, 
¿
, 0x00, 
WRITE_SBUS_RECEIVER
, 0x40000000);

1277 
i
 = 0; i < 
fd‘
->
fœmw¬e_Ën
; i += 4) {

1278 
	`sbus_»que¡
(
dd
, 
¿
, 0x0a, 
WRITE_SBUS_RECEIVER
,

1279 *(
u32
 *)&
fd‘
->
fœmw¬e_±r
[
i
]);

1282 
	`sbus_»que¡
(
dd
, 
¿
, 0x00, 
WRITE_SBUS_RECEIVER
, 0x00000000);

1284 
	`sbus_»que¡
(
dd
, 
¿
, 0x0b, 
WRITE_SBUS_RECEIVER
, 0x000c0000);

1287 
”r
 = 
	`run_r§
(
dd
, "çbriø£rdes", 
fd‘
->
sigÇtu»
);

1288 ià(
”r
)

1289  
”r
;

1292 
	`sbus_»que¡
(
dd
, 
¿
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x00000002);

1294 
	`sbus_»que¡
(
dd
, 
¿
, 0x08, 
WRITE_SBUS_RECEIVER
, 0x00000000);

1297 
	}
}

1299 
	$lßd_sbus_fœmw¬e
(
hfi1_devd©a
 *
dd
,

1300 
fœmw¬e_d‘ažs
 *
fd‘
)

1302 
i
, 
”r
;

1303 cÚ¡ 
u8
 
¿
 = 
SBUS_MASTER_BROADCAST
;

1305 
	`dd_dev_šfo
(
dd
, "Downloading SBus firmware\n");

1308 
	`lßd_£cur™y_v¬ŸbËs
(
dd
, 
fd‘
);

1310 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x000000c0);

1312 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x00000240);

1314 
	`sbus_»que¡
(
dd
, 
¿
, 0x03, 
WRITE_SBUS_RECEIVER
, 0x80000000);

1316 
i
 = 0; i < 
fd‘
->
fœmw¬e_Ën
; i += 4) {

1317 
	`sbus_»que¡
(
dd
, 
¿
, 0x14, 
WRITE_SBUS_RECEIVER
,

1318 *(
u32
 *)&
fd‘
->
fœmw¬e_±r
[
i
]);

1321 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x00000040);

1323 
	`sbus_»que¡
(
dd
, 
¿
, 0x16, 
WRITE_SBUS_RECEIVER
, 0x000c0000);

1326 
”r
 = 
	`run_r§
(
dd
, "SBus", 
fd‘
->
sigÇtu»
);

1327 ià(
”r
)

1328  
”r
;

1331 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x00000140);

1334 
	}
}

1336 
	$lßd_pc›_£rdes_fœmw¬e
(
hfi1_devd©a
 *
dd
,

1337 
fœmw¬e_d‘ažs
 *
fd‘
)

1339 
i
;

1340 cÚ¡ 
u8
 
¿
 = 
SBUS_MASTER_BROADCAST
;

1342 
	`dd_dev_šfo
(
dd
, "Downloading PCIe firmware\n");

1345 
	`lßd_£cur™y_v¬ŸbËs
(
dd
, 
fd‘
);

1347 
	`sbus_»que¡
(
dd
, 
¿
, 0x05, 
WRITE_SBUS_RECEIVER
, 0x00000001);

1349 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x00000d40);

1355 
i
 = 0; i < 
fd‘
->
fœmw¬e_Ën
; i += 4) {

1356 
	`sbus_»que¡
(
dd
, 
¿
, 0x04, 
WRITE_SBUS_RECEIVER
,

1357 *(
u32
 *)&
fd‘
->
fœmw¬e_±r
[
i
]);

1360 
	`sbus_»que¡
(
dd
, 
¿
, 0x01, 
WRITE_SBUS_RECEIVER
, 0x00000140);

1362 
	`sbus_»que¡
(
dd
, 
¿
, 0x05, 
WRITE_SBUS_RECEIVER
, 0x00000000);

1368  
	`run_r§
(
dd
, "PCI£rdes", 
fd‘
->
sigÇtu»
);

1369 
	}
}

1374 
	$£t_£rdes_brßdÿ¡
(
hfi1_devd©a
 *
dd
, 
u8
 
bg1
, u8 
bg2
,

1375 cÚ¡ 
u8
 *
addrs
, 
couÁ
)

1377 --
couÁ
 >= 0) {

1390 
	`sbus_»que¡
(
dd
, 
addrs
[
couÁ
], 0xfd, 
WRITE_SBUS_RECEIVER
,

1391 (
u32
)
bg1
 << 4 | (u32)
bg2
 << 16);

1393 
	}
}

1395 
	$acquœe_hw_mu‹x
(
hfi1_devd©a
 *
dd
)

1397 
timeout
;

1398 
Œy
 = 0;

1399 
u8
 
mask
 = 1 << 
dd
->
hfi1_id
;

1400 
u8
 
u£r
 = (u8)
	`»ad_c¤
(
dd
, 
ASIC_CFG_MUTEX
);

1402 ià(
u£r
 =ð
mask
) {

1403 
	`dd_dev_šfo
(
dd
,

1405 (
u32
)
mask
);

1409 
»Œy
:

1410 
timeout
 = 
	`m£cs_to_jiff›s
(
HM_TIMEOUT
è+ 
jiff›s
;

1412 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_MUTEX
, 
mask
);

1413 
u£r
 = (
u8
)
	`»ad_c¤
(
dd
, 
ASIC_CFG_MUTEX
);

1414 ià(
u£r
 =ð
mask
)

1416 ià(
	`time_aá”
(
jiff›s
, 
timeout
))

1418 
	`m¦“p
(20);

1422 
	`dd_dev_”r
(
dd
,

1424 (
u32
)
u£r
, (u32)
mask
, (
Œy
 == 0) ? "retrying" : "giving up");

1426 ià(
Œy
 == 0) {

1428 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_MUTEX
, 0);

1429 
Œy
++;

1430 
»Œy
;

1433  -
EBUSY
;

1434 
	}
}

1436 
	$»Ëa£_hw_mu‹x
(
hfi1_devd©a
 *
dd
)

1438 
u8
 
mask
 = 1 << 
dd
->
hfi1_id
;

1439 
u8
 
u£r
 = (u8)
	`»ad_c¤
(
dd
, 
ASIC_CFG_MUTEX
);

1441 ià(
u£r
 !ð
mask
)

1442 
	`dd_dev_w¬n
(
dd
,

1444 (
u32
)
u£r
, (u32)
mask
);

1446 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_MUTEX
, 0);

1447 
	}
}

1450 
šlše
 
u64
 
	$»sourû_mask
(
u32
 
hfi1_id
, u32 
»sourû
)

1452  ((
u64
)
»sourû
è<< (
hfi1_id
 ? 
CR_DYN_SHIFT
 : 0);

1453 
	}
}

1455 
	$çž_mu‹x_acquœe_mes§ge
(
hfi1_devd©a
 *
dd
,

1456 cÚ¡ *
func
)

1458 
	`dd_dev_”r
(
dd
,

1460 
func
);

1461 
	}
}

1468 
	$__acquœe_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
)

1470 
u64
 
sü©ch0
, 
®l_b™s
, 
my_b™
;

1471 
»t
;

1473 ià(
»sourû
 & 
CR_DYN_MASK
) {

1475 ià(
dd
->
pcidev
->
deviû
 =ð
PCI_DEVICE_ID_INTEL0
 &&

1476 (
»sourû
 & (
CR_I2C1
 | 
CR_I2C2
))) {

1478 
®l_b™s
 = 
	`»sourû_mask
(0, 
CR_I2C1
 | 
CR_I2C2
) |

1479 
	`»sourû_mask
(1, 
CR_I2C1
 | 
CR_I2C2
);

1481 
®l_b™s
 = 
	`»sourû_mask
(0, 
»sourû
) |

1482 
	`»sourû_mask
(1, 
»sourû
);

1484 
my_b™
 = 
	`»sourû_mask
(
dd
->
hfi1_id
, 
»sourû
);

1487 
®l_b™s
 = 
»sourû
;

1488 
my_b™
 = 
»sourû
;

1492 
	`mu‹x_lock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1494 
»t
 = 
	`acquœe_hw_mu‹x
(
dd
);

1495 ià(
»t
) {

1496 
	`çž_mu‹x_acquœe_mes§ge
(
dd
, 
__func__
);

1497 
»t
 = -
EIO
;

1498 
dÚe
;

1501 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1502 ià(
sü©ch0
 & 
®l_b™s
) {

1503 
»t
 = -
EBUSY
;

1505 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SCRATCH
, 
sü©ch0
 | 
my_b™
);

1507 ()
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1510 
	`»Ëa£_hw_mu‹x
(
dd
);

1512 
dÚe
:

1513 
	`mu‹x_uÆock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1514  
»t
;

1515 
	}
}

1524 
	$acquœe_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
, u32 
mswa™
)

1526 
timeout
;

1527 
»t
;

1529 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
mswa™
);

1531 
»t
 = 
	`__acquœe_ch_»sourû
(
dd
, 
»sourû
);

1532 ià(
»t
 !ð-
EBUSY
)

1533  
»t
;

1535 ià(
	`time_aá”_eq
(
jiff›s
, 
timeout
))

1536  -
EBUSY
;

1537 
	`u¦“p_¿nge
(80, 120);

1539 
	}
}

1544 
	$»Ëa£_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
)

1546 
u64
 
sü©ch0
, 
b™
;

1549 ià(!(
»sourû
 & 
CR_DYN_MASK
)) {

1550 
	`dd_dev_”r
(
dd
, "%s: inv®id„esourû 0x%x\n", 
__func__
,

1551 
»sourû
);

1554 
b™
 = 
	`»sourû_mask
(
dd
->
hfi1_id
, 
»sourû
);

1557 
	`mu‹x_lock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1559 ià(
	`acquœe_hw_mu‹x
(
dd
)) {

1560 
	`çž_mu‹x_acquœe_mes§ge
(
dd
, 
__func__
);

1561 
dÚe
;

1564 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1565 ià((
sü©ch0
 & 
b™
) != 0) {

1566 
sü©ch0
 &ð~
b™
;

1567 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SCRATCH
, 
sü©ch0
);

1569 ()
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1571 
	`dd_dev_w¬n
(
dd
, "%s: id %d,„esource 0x%x: bit‚ot set\n",

1572 
__func__
, 
dd
->
hfi1_id
, 
»sourû
);

1575 
	`»Ëa£_hw_mu‹x
(
dd
);

1577 
dÚe
:

1578 
	`mu‹x_uÆock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1579 
	}
}

1585 
boÞ
 
	$check_ch_»sourû
(
hfi1_devd©a
 *
dd
, 
u32
 
»sourû
,

1586 cÚ¡ *
func
)

1588 
u64
 
sü©ch0
, 
b™
;

1590 ià(
»sourû
 & 
CR_DYN_MASK
)

1591 
b™
 = 
	`»sourû_mask
(
dd
->
hfi1_id
, 
»sourû
);

1593 
b™
 = 
»sourû
;

1595 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1596 ià((
sü©ch0
 & 
b™
) == 0) {

1597 ià(
func
)

1598 
	`dd_dev_w¬n
(
dd
,

1600 
func
, 
dd
->
hfi1_id
, 
»sourû
);

1601  
çl£
;

1603  
Œue
;

1604 
	}
}

1606 
	$þ—r_ch_»sourûs
(
hfi1_devd©a
 *
dd
, cÚ¡ *
func
)

1608 
u64
 
sü©ch0
;

1611 
	`mu‹x_lock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1613 ià(
	`acquœe_hw_mu‹x
(
dd
)) {

1614 
	`çž_mu‹x_acquœe_mes§ge
(
dd
, 
func
);

1615 
dÚe
;

1619 
sü©ch0
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1620 
sü©ch0
 &ð~
	`»sourû_mask
(
dd
->
hfi1_id
, 
CR_DYN_MASK
);

1621 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SCRATCH
, 
sü©ch0
);

1623 ()
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

1625 
	`»Ëa£_hw_mu‹x
(
dd
);

1627 
dÚe
:

1628 
	`mu‹x_uÆock
(&
dd
->
asic_d©a
->
asic_»sourû_mu‹x
);

1629 
	}
}

1631 
	$š™_ch_»sourûs
(
hfi1_devd©a
 *
dd
)

1634 
	`þ—r_ch_»sourûs
(
dd
, 
__func__
);

1635 
	}
}

1637 
	$fšish_ch_»sourûs
(
hfi1_devd©a
 *
dd
)

1640 
	`þ—r_ch_»sourûs
(
dd
, 
__func__
);

1641 
	}
}

1643 
	$£t_sbus_ç¡_mode
(
hfi1_devd©a
 *
dd
)

1645 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SBUS_EXECUTE
,

1646 
ASIC_CFG_SBUS_EXECUTE_FAST_MODE_SMASK
);

1647 
	}
}

1649 
	$þ—r_sbus_ç¡_mode
(
hfi1_devd©a
 *
dd
)

1651 
u64
 
»g
, 
couÁ
 = 0;

1653 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_COUNTERS
);

1654 
	`SBUS_COUNTER
(
»g
, 
EXECUTE
) !=

1655 
	`SBUS_COUNTER
(
»g
, 
RCV_DATA_VALID
)) {

1656 ià(
couÁ
++ >ð
SBUS_MAX_POLL_COUNT
)

1658 
	`ud–ay
(1);

1659 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_STS_SBUS_COUNTERS
);

1661 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_SBUS_EXECUTE
, 0);

1662 
	}
}

1664 
	$lßd_fœmw¬e
(
hfi1_devd©a
 *
dd
)

1666 
»t
;

1668 ià(
fw_çbric_£rdes_lßd
) {

1669 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_SBUS
, 
SBUS_TIMEOUT
);

1670 ià(
»t
)

1671  
»t
;

1673 
	`£t_sbus_ç¡_mode
(
dd
);

1675 
	`£t_£rdes_brßdÿ¡
(
dd
, 
®l_çbric_£rdes_brßdÿ¡
,

1676 
çbric_£rdes_brßdÿ¡
[
dd
->
hfi1_id
],

1677 
çbric_£rdes_addrs
[
dd
->
hfi1_id
],

1678 
NUM_FABRIC_SERDES
);

1679 
	`tuº_off_¥icos
(
dd
, 
SPICO_FABRIC
);

1681 
»t
 = 
	`lßd_çbric_£rdes_fœmw¬e
(
dd
, &
fw_çbric
);

1682 } 
	`»Œy_fœmw¬e
(
dd
, 
»t
));

1684 
	`þ—r_sbus_ç¡_mode
(
dd
);

1685 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_SBUS
);

1686 ià(
»t
)

1687  
»t
;

1690 ià(
fw_8051_lßd
) {

1692 
»t
 = 
	`lßd_8051_fœmw¬e
(
dd
, &
fw_8051
);

1693 } 
	`»Œy_fœmw¬e
(
dd
, 
»t
));

1694 ià(
»t
)

1695  
»t
;

1698 
	`dump_fw_v”siÚ
(
dd
);

1700 
	}
}

1702 
	$hfi1_fœmw¬e_š™
(
hfi1_devd©a
 *
dd
)

1705 ià(
dd
->
icode
 !ð
ICODE_RTL_SILICON
) {

1706 
fw_çbric_£rdes_lßd
 = 0;

1707 
fw_pc›_£rdes_lßd
 = 0;

1708 
fw_sbus_lßd
 = 0;

1712 ià(
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
)

1713 
fw_8051_lßd
 = 0;

1715 ià(!
fw_8051_Çme
) {

1716 ià(
dd
->
icode
 =ð
ICODE_RTL_SILICON
)

1717 
fw_8051_Çme
 = 
DEFAULT_FW_8051_NAME_ASIC
;

1719 
fw_8051_Çme
 = 
DEFAULT_FW_8051_NAME_FPGA
;

1721 ià(!
fw_çbric_£rdes_Çme
)

1722 
fw_çbric_£rdes_Çme
 = 
DEFAULT_FW_FABRIC_NAME
;

1723 ià(!
fw_sbus_Çme
)

1724 
fw_sbus_Çme
 = 
DEFAULT_FW_SBUS_NAME
;

1725 ià(!
fw_pc›_£rdes_Çme
)

1726 
fw_pc›_£rdes_Çme
 = 
DEFAULT_FW_PCIE_NAME
;

1728  
	`obš_fœmw¬e
(
dd
);

1729 
	}
}

1738 
	$check_m‘a_v”siÚ
(
hfi1_devd©a
 *
dd
, 
u32
 *
sy¡em_bË
)

1740 
u32
 
m‘a_v”
, 
m‘a_v”_m‘a
, 
v”_¡¬t
, 
v”_Ën
, 
mask
;

1741 
¶©fÜm_cÚfig_ÿche
 *
pcfgÿche
 = &
dd
->
pcfg_ÿche
;

1743 ià(!
sy¡em_bË
)

1744  -
EINVAL
;

1746 
m‘a_v”_m‘a
 =

1747 *(
pcfgÿche
->
cÚfig_bËs
[
PLATFORM_CONFIG_SYSTEM_TABLE
].
bË_m‘ad©a


1748 + 
SYSTEM_TABLE_META_VERSION
);

1750 
mask
 = ((1 << 
METADATA_TABLE_FIELD_START_LEN_BITS
) - 1);

1751 
v”_¡¬t
 = 
m‘a_v”_m‘a
 & 
mask
;

1753 
m‘a_v”_m‘a
 >>ð
METADATA_TABLE_FIELD_LEN_SHIFT
;

1755 
mask
 = ((1 << 
METADATA_TABLE_FIELD_LEN_LEN_BITS
) - 1);

1756 
v”_Ën
 = 
m‘a_v”_m‘a
 & 
mask
;

1758 
v”_¡¬t
 /= 8;

1759 
m‘a_v”
 = *((
u8
 *)
sy¡em_bË
 + 
v”_¡¬t
è& ((1 << 
v”_Ën
) - 1);

1761 ià(
m‘a_v”
 < 4) {

1762 
	`dd_dev_šfo
(

1763 
dd
, "%s:PËa£ upd©¶©fÜm cÚfig\n", 
__func__
);

1764  -
EINVAL
;

1767 
	}
}

1769 
	$·r£_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
)

1771 
¶©fÜm_cÚfig_ÿche
 *
pcfgÿche
 = &
dd
->
pcfg_ÿche
;

1772 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

1773 
u32
 *
±r
 = 
NULL
;

1774 
u32
 
h—d”1
 = 0, 
h—d”2
 = 0, 
magic_num
 = 0, 
üc
 = 0, 
fže_Ëngth
 = 0;

1775 
u32
 
»cÜd_idx
 = 0, 
bË_ty³
 = 0, 
bË_Ëngth_dwÜds
 = 0;

1776 
»t
 = -
EINVAL
;

1784 ià(
µd
->
cÚfig_äom_sü©ch
)

1787 ià(!
dd
->
¶©fÜm_cÚfig
.
d©a
) {

1788 
	`dd_dev_”r
(
dd
, "%s: Missšg cÚfig fže\n", 
__func__
);

1789 
baž
;

1791 
±r
 = (
u32
 *)
dd
->
¶©fÜm_cÚfig
.
d©a
;

1793 
magic_num
 = *
±r
;

1794 
±r
++;

1795 ià(
magic_num
 !ð
PLATFORM_CONFIG_MAGIC_NUM
) {

1796 
	`dd_dev_”r
(
dd
, "%s: Bad cÚfig fže\n", 
__func__
);

1797 
baž
;

1801 
fže_Ëngth
 = (*
±r
) * 4;

1808 ià(
fže_Ëngth
 > 
MAX_PLATFORM_CONFIG_FILE_SIZE
) {

1809 
	`dd_dev_šfo
(
dd
,

1811 
__func__
);

1812 
fže_Ëngth
 = 
PLATFORM_CONFIG_FORMAT_4_FILE_SIZE
;

1814 
±r
++;

1817 ià(
fže_Ëngth
 > 
dd
->
¶©fÜm_cÚfig
.
size
) {

1818 
	`dd_dev_šfo
(
dd
, "%s:File claimso be†argerhan„ead size\n",

1819 
__func__
);

1820 
baž
;

1821 } ià(
fže_Ëngth
 < 
dd
->
¶©fÜm_cÚfig
.
size
) {

1822 
	`dd_dev_šfo
(
dd
,

1824 
__func__
);

1833 
±r
 < (
u32
 *)(
dd
->
¶©fÜm_cÚfig
.
d©a
 + 
fže_Ëngth
)) {

1834 
h—d”1
 = *
±r
;

1835 
h—d”2
 = *(
±r
 + 1);

1836 ià(
h—d”1
 !ð~
h—d”2
) {

1837 
	`dd_dev_”r
(
dd
, "%s: Failed validation‡t offset %ld\n",

1838 
__func__
, (
±r
 - (
u32
 *)

1839 
dd
->
¶©fÜm_cÚfig
.
d©a
));

1840 
baž
;

1843 
»cÜd_idx
 = *
±r
 &

1844 ((1 << 
PLATFORM_CONFIG_HEADER_RECORD_IDX_LEN_BITS
) - 1);

1846 
bË_Ëngth_dwÜds
 = (*
±r
 >>

1847 
PLATFORM_CONFIG_HEADER_TABLE_LENGTH_SHIFT
) &

1848 ((1 << 
PLATFORM_CONFIG_HEADER_TABLE_LENGTH_LEN_BITS
) - 1);

1850 
bË_ty³
 = (*
±r
 >> 
PLATFORM_CONFIG_HEADER_TABLE_TYPE_SHIFT
) &

1851 ((1 << 
PLATFORM_CONFIG_HEADER_TABLE_TYPE_LEN_BITS
) - 1);

1854 
±r
 += 2;

1856 ià(
»cÜd_idx
) {

1858 
bË_ty³
) {

1859 
PLATFORM_CONFIG_SYSTEM_TABLE
:

1860 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
num_bË
 =

1862 
»t
 = 
	`check_m‘a_v”siÚ
(
dd
, 
±r
);

1863 ià(
»t
)

1864 
baž
;

1866 
PLATFORM_CONFIG_PORT_TABLE
:

1867 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
num_bË
 =

1870 
PLATFORM_CONFIG_RX_PRESET_TABLE
:

1872 
PLATFORM_CONFIG_TX_PRESET_TABLE
:

1874 
PLATFORM_CONFIG_QSFP_ATTEN_TABLE
:

1876 
PLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
:

1877 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
num_bË
 =

1878 
bË_Ëngth_dwÜds
;

1881 
	`dd_dev_”r
(
dd
,

1883 
__func__
, 
bË_ty³
,

1884 (
±r
 - (
u32
 *)

1885 
dd
->
¶©fÜm_cÚfig
.
d©a
));

1886 
baž
;

1888 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË
 = 
±r
;

1891 
bË_ty³
) {

1892 
PLATFORM_CONFIG_SYSTEM_TABLE
:

1894 
PLATFORM_CONFIG_PORT_TABLE
:

1896 
PLATFORM_CONFIG_RX_PRESET_TABLE
:

1898 
PLATFORM_CONFIG_TX_PRESET_TABLE
:

1900 
PLATFORM_CONFIG_QSFP_ATTEN_TABLE
:

1902 
PLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
:

1905 
	`dd_dev_”r
(
dd
,

1907 
__func__
, 
bË_ty³
,

1908 (
±r
 -

1909 (
u32
 *)
dd
->
¶©fÜm_cÚfig
.
d©a
));

1910 
baž
;

1912 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË_m‘ad©a
 =

1913 
±r
;

1917 
üc
 = 
	`üc32_Ë
(~(
u32
)0, (cÚ¡ *)
±r
,

1918 (
bË_Ëngth_dwÜds
 * 4));

1919 
üc
 ^ð~(
u32
)0;

1922 
±r
 +ð
bË_Ëngth_dwÜds
;

1923 ià(
üc
 !ð*
±r
) {

1924 
	`dd_dev_”r
(
dd
, "%s: Failed CRC check‡t offset %ld\n",

1925 
__func__
, (
±r
 -

1926 (
u32
 *)
dd
->
¶©fÜm_cÚfig
.
d©a
));

1927 
baž
;

1930 
±r
++;

1933 
pcfgÿche
->
ÿche_v®id
 = 1;

1935 
baž
:

1936 
	`mem£t
(
pcfgÿche
, 0, (
¶©fÜm_cÚfig_ÿche
));

1937  
»t
;

1938 
	}
}

1940 
	$g‘_š‹g¿‹d_¶©fÜm_cÚfig_f›ld
(

1941 
hfi1_devd©a
 *
dd
,

1942 
¶©fÜm_cÚfig_bË_ty³_’codšg
 
bË_ty³
,

1943 
f›ld_šdex
, 
u32
 *
d©a
)

1945 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

1946 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

1947 
u32
 
tx_´e£t
 = 0;

1949 
bË_ty³
) {

1950 
PLATFORM_CONFIG_SYSTEM_TABLE
:

1951 ià(
f›ld_šdex
 =ð
SYSTEM_TABLE_QSFP_POWER_CLASS_MAX
)

1952 *
d©a
 = 
µd
->
max_pow”_þass
;

1953 ià(
f›ld_šdex
 =ð
SYSTEM_TABLE_QSFP_ATTENUATION_DEFAULT_25G
)

1954 *
d©a
 = 
µd
->
deçuÉ_©‹n
;

1956 
PLATFORM_CONFIG_PORT_TABLE
:

1957 ià(
f›ld_šdex
 =ð
PORT_TABLE_PORT_TYPE
)

1958 *
d©a
 = 
µd
->
pÜt_ty³
;

1959 ià(
f›ld_šdex
 =ð
PORT_TABLE_LOCAL_ATTEN_25G
)

1960 *
d©a
 = 
µd
->
loÿl_©‹n
;

1961 ià(
f›ld_šdex
 =ð
PORT_TABLE_REMOTE_ATTEN_25G
)

1962 *
d©a
 = 
µd
->
»mÙe_©‹n
;

1964 
PLATFORM_CONFIG_RX_PRESET_TABLE
:

1965 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_CDR_APPLY
)

1966 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_CDR_APPLY_SMASK
) >>

1967 
QSFP_RX_CDR_APPLY_SHIFT
;

1968 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_EMP_APPLY
)

1969 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_EMP_APPLY_SMASK
) >>

1970 
QSFP_RX_EMP_APPLY_SHIFT
;

1971 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_AMP_APPLY
)

1972 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_AMP_APPLY_SMASK
) >>

1973 
QSFP_RX_AMP_APPLY_SHIFT
;

1974 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_CDR
)

1975 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_CDR_SMASK
) >>

1976 
QSFP_RX_CDR_SHIFT
;

1977 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_EMP
)

1978 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_EMP_SMASK
) >>

1979 
QSFP_RX_EMP_SHIFT
;

1980 ià(
f›ld_šdex
 =ð
RX_PRESET_TABLE_QSFP_RX_AMP
)

1981 *
d©a
 = (
µd
->
rx_´e£t
 & 
QSFP_RX_AMP_SMASK
) >>

1982 
QSFP_RX_AMP_SHIFT
;

1984 
PLATFORM_CONFIG_TX_PRESET_TABLE
:

1985 ià(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x4)

1986 
tx_´e£t
 = 
µd
->
tx_´e£t_eq
;

1988 
tx_´e£t
 = 
µd
->
tx_´e£t_nÛq
;

1989 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_PRECUR
)

1990 *
d©a
 = (
tx_´e£t
 & 
TX_PRECUR_SMASK
) >>

1991 
TX_PRECUR_SHIFT
;

1992 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_ATTN
)

1993 *
d©a
 = (
tx_´e£t
 & 
TX_ATTN_SMASK
) >>

1994 
TX_ATTN_SHIFT
;

1995 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_POSTCUR
)

1996 *
d©a
 = (
tx_´e£t
 & 
TX_POSTCUR_SMASK
) >>

1997 
TX_POSTCUR_SHIFT
;

1998 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_QSFP_TX_CDR_APPLY
)

1999 *
d©a
 = (
tx_´e£t
 & 
QSFP_TX_CDR_APPLY_SMASK
) >>

2000 
QSFP_TX_CDR_APPLY_SHIFT
;

2001 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_QSFP_TX_EQ_APPLY
)

2002 *
d©a
 = (
tx_´e£t
 & 
QSFP_TX_EQ_APPLY_SMASK
) >>

2003 
QSFP_TX_EQ_APPLY_SHIFT
;

2004 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_QSFP_TX_CDR
)

2005 *
d©a
 = (
tx_´e£t
 & 
QSFP_TX_CDR_SMASK
) >>

2006 
QSFP_TX_CDR_SHIFT
;

2007 ià(
f›ld_šdex
 =ð
TX_PRESET_TABLE_QSFP_TX_EQ
)

2008 *
d©a
 = (
tx_´e£t
 & 
QSFP_TX_EQ_SMASK
) >>

2009 
QSFP_TX_EQ_SHIFT
;

2011 
PLATFORM_CONFIG_QSFP_ATTEN_TABLE
:

2012 
PLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
:

2016 
	}
}

2018 
	$g‘_¶©fÜm_fw_f›ld_m‘ad©a
(
hfi1_devd©a
 *
dd
, 
bË
,

2019 
f›ld
, 
u32
 *
f›ld_Ën_b™s
,

2020 
u32
 *
f›ld_¡¬t_b™s
)

2022 
¶©fÜm_cÚfig_ÿche
 *
pcfgÿche
 = &
dd
->
pcfg_ÿche
;

2023 
u32
 *
¤c_±r
 = 
NULL
;

2025 ià(!
pcfgÿche
->
ÿche_v®id
)

2026  -
EINVAL
;

2028 
bË
) {

2029 
PLATFORM_CONFIG_SYSTEM_TABLE
:

2031 
PLATFORM_CONFIG_PORT_TABLE
:

2033 
PLATFORM_CONFIG_RX_PRESET_TABLE
:

2035 
PLATFORM_CONFIG_TX_PRESET_TABLE
:

2037 
PLATFORM_CONFIG_QSFP_ATTEN_TABLE
:

2039 
PLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
:

2040 ià(
f›ld
 && f›ld < 
¶©fÜm_cÚfig_bË_lim™s
[
bË
])

2041 
¤c_±r
 =

2042 
pcfgÿche
->
cÚfig_bËs
[
bË
].
bË_m‘ad©a
 + 
f›ld
;

2045 
	`dd_dev_šfo
(
dd
, "%s: UnknowÀbË\n", 
__func__
);

2049 ià(!
¤c_±r
)

2050  -
EINVAL
;

2052 ià(
f›ld_¡¬t_b™s
)

2053 *
f›ld_¡¬t_b™s
 = *
¤c_±r
 &

2054 ((1 << 
METADATA_TABLE_FIELD_START_LEN_BITS
) - 1);

2056 ià(
f›ld_Ën_b™s
)

2057 *
f›ld_Ën_b™s
 = (*
¤c_±r
 >> 
METADATA_TABLE_FIELD_LEN_SHIFT
)

2058 & ((1 << 
METADATA_TABLE_FIELD_LEN_LEN_BITS
) - 1);

2061 
	}
}

2079 
	$g‘_¶©fÜm_cÚfig_f›ld
(
hfi1_devd©a
 *
dd
,

2080 
¶©fÜm_cÚfig_bË_ty³_’codšg


2081 
bË_ty³
, 
bË_šdex
, 
f›ld_šdex
,

2082 
u32
 *
d©a
, u32 
Ën
)

2084 
»t
 = 0, 
wËn
 = 0, 
£ek
 = 0;

2085 
u32
 
f›ld_Ën_b™s
 = 0, 
f›ld_¡¬t_b™s
 = 0, *
¤c_±r
 = 
NULL
;

2086 
¶©fÜm_cÚfig_ÿche
 *
pcfgÿche
 = &
dd
->
pcfg_ÿche
;

2087 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

2089 ià(
d©a
)

2090 
	`mem£t
(
d©a
, 0, 
Ën
);

2092  -
EINVAL
;

2094 ià(
µd
->
cÚfig_äom_sü©ch
) {

2098 
	`g‘_š‹g¿‹d_¶©fÜm_cÚfig_f›ld
(
dd
, 
bË_ty³
,

2099 
f›ld_šdex
, 
d©a
);

2103 
»t
 = 
	`g‘_¶©fÜm_fw_f›ld_m‘ad©a
(
dd
, 
bË_ty³
, 
f›ld_šdex
,

2104 &
f›ld_Ën_b™s
,

2105 &
f›ld_¡¬t_b™s
);

2106 ià(
»t
)

2107  -
EINVAL
;

2110 
Ën
 *= 8;

2113 
bË_ty³
) {

2114 
PLATFORM_CONFIG_SYSTEM_TABLE
:

2115 
¤c_±r
 = 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË
;

2117 ià(
f›ld_šdex
 !ð
SYSTEM_TABLE_QSFP_POWER_CLASS_MAX
) {

2118 ià(
Ën
 < 
f›ld_Ën_b™s
)

2119  -
EINVAL
;

2121 
£ek
 = 
f›ld_¡¬t_b™s
 / 8;

2122 
wËn
 = 
f›ld_Ën_b™s
 / 8;

2124 
¤c_±r
 = (
u32
 *)((
u8
 *)¤c_±¸+ 
£ek
);

2130 
	`memýy
(
d©a
, 
¤c_±r
, 
wËn
);

2134 
PLATFORM_CONFIG_PORT_TABLE
:

2136 
¤c_±r
 = 
dd
->
hfi1_id
 ?

2137 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË
 + 4 :

2138 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË
;

2140 
PLATFORM_CONFIG_RX_PRESET_TABLE
:

2142 
PLATFORM_CONFIG_TX_PRESET_TABLE
:

2144 
PLATFORM_CONFIG_QSFP_ATTEN_TABLE
:

2146 
PLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
:

2147 
¤c_±r
 = 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
bË
;

2149 ià(
bË_šdex
 <

2150 
pcfgÿche
->
cÚfig_bËs
[
bË_ty³
].
num_bË
)

2151 
¤c_±r
 +ð
bË_šdex
;

2153 
¤c_±r
 = 
NULL
;

2156 
	`dd_dev_šfo
(
dd
, "%s: UnknowÀbË\n", 
__func__
);

2160 ià(!
¤c_±r
 || 
Ën
 < 
f›ld_Ën_b™s
)

2161  -
EINVAL
;

2163 
¤c_±r
 +ð(
f›ld_¡¬t_b™s
 / 32);

2164 *
d©a
 = (*
¤c_±r
 >> (
f›ld_¡¬t_b™s
 % 32)) &

2165 ((1 << 
f›ld_Ën_b™s
) - 1);

2168 
	}
}

2176 
	$lßd_pc›_fœmw¬e
(
hfi1_devd©a
 *
dd
)

2178 
»t
 = 0;

2181 
	`£t_sbus_ç¡_mode
(
dd
);

2183 ià(
fw_sbus_lßd
) {

2184 
	`tuº_off_¥icos
(
dd
, 
SPICO_SBUS
);

2186 
»t
 = 
	`lßd_sbus_fœmw¬e
(
dd
, &
fw_sbus
);

2187 } 
	`»Œy_fœmw¬e
(
dd
, 
»t
));

2188 ià(
»t
)

2189 
dÚe
;

2192 ià(
fw_pc›_£rdes_lßd
) {

2193 
	`dd_dev_šfo
(
dd
, "Setting PCIe SerDes broadcast\n");

2194 
	`£t_£rdes_brßdÿ¡
(
dd
, 
®l_pc›_£rdes_brßdÿ¡
,

2195 
pc›_£rdes_brßdÿ¡
[
dd
->
hfi1_id
],

2196 
pc›_£rdes_addrs
[
dd
->
hfi1_id
],

2197 
NUM_PCIE_SERDES
);

2199 
»t
 = 
	`lßd_pc›_£rdes_fœmw¬e
(
dd
, &
fw_pc›
);

2200 } 
	`»Œy_fœmw¬e
(
dd
, 
»t
));

2201 ià(
»t
)

2202 
dÚe
;

2205 
dÚe
:

2206 
	`þ—r_sbus_ç¡_mode
(
dd
);

2208  
»t
;

2209 
	}
}

2214 
	$»ad_guid
(
hfi1_devd©a
 *
dd
)

2217 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 0);

2218 ()
	`»ad_c¤
(
dd
, 
CCE_DC_CTRL
);

2220 
dd
->
ba£_guid
 = 
	`»ad_c¤
(dd, 
DC_DC8051_CFG_LOCAL_GUID
);

2221 
	`dd_dev_šfo
(
dd
, "GUID %llx",

2222 ()
dd
->
ba£_guid
);

2223 
	}
}

2226 
	$dump_fw_v”siÚ
(
hfi1_devd©a
 *
dd
)

2228 
u32
 
pc›_v”s
[
NUM_PCIE_SERDES
];

2229 
u32
 
çbric_v”s
[
NUM_FABRIC_SERDES
];

2230 
u32
 
sbus_v”s
;

2231 
i
;

2232 
®l_§me
;

2233 
»t
;

2234 
u8
 
rcv_addr
;

2236 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_SBUS
, 
SBUS_TIMEOUT
);

2237 ià(
»t
) {

2238 
	`dd_dev_”r
(
dd
, "Unableo‡cquire SBuso„ead firmware versions\n");

2243 
	`£t_sbus_ç¡_mode
(
dd
);

2246 
	`sbus_»que¡
(
dd
, 
SBUS_MASTER_BROADCAST
, 0x02, 
WRITE_SBUS_RECEIVER
, 0);

2247 
	`sbus_»que¡
(
dd
, 
SBUS_MASTER_BROADCAST
, 0x07, 
WRITE_SBUS_RECEIVER
, 0x1);

2249 
	`u¦“p_¿nge
(10000, 11000);

2250 
sbus_v”s
 = 
	`sbus_»ad
(
dd
, 
SBUS_MASTER_BROADCAST
, 0x08, 0x1);

2251 
	`dd_dev_šfo
(
dd
, "SBu Ma¡” fœmw¬v”siÚ 0x%08x\n", 
sbus_v”s
);

2254 
®l_§me
 = 1;

2255 
pc›_v”s
[0] = 0;

2256 
i
 = 0; i < 
NUM_PCIE_SERDES
; i++) {

2257 
rcv_addr
 = 
pc›_£rdes_addrs
[
dd
->
hfi1_id
][
i
];

2258 
	`sbus_»que¡
(
dd
, 
rcv_addr
, 0x03, 
WRITE_SBUS_RECEIVER
, 0);

2260 
	`u¦“p_¿nge
(10000, 11000);

2261 
pc›_v”s
[
i
] = 
	`sbus_»ad
(
dd
, 
rcv_addr
, 0x04, 0x0);

2262 ià(
i
 > 0 && 
pc›_v”s
[0] !=…cie_vers[i])

2263 
®l_§me
 = 0;

2266 ià(
®l_§me
) {

2267 
	`dd_dev_šfo
(
dd
, "PCIe SerDes firmware version 0x%x\n",

2268 
pc›_v”s
[0]);

2270 
	`dd_dev_w¬n
(
dd
, "PCIe SerDes do‚ot havehe same firmware version\n");

2271 
i
 = 0; i < 
NUM_PCIE_SERDES
; i++) {

2272 
	`dd_dev_šfo
(
dd
,

2274 
i
, 
pc›_v”s
[i]);

2279 
®l_§me
 = 1;

2280 
çbric_v”s
[0] = 0;

2281 
i
 = 0; i < 
NUM_FABRIC_SERDES
; i++) {

2282 
rcv_addr
 = 
çbric_£rdes_addrs
[
dd
->
hfi1_id
][
i
];

2283 
	`sbus_»que¡
(
dd
, 
rcv_addr
, 0x03, 
WRITE_SBUS_RECEIVER
, 0);

2285 
	`u¦“p_¿nge
(10000, 11000);

2286 
çbric_v”s
[
i
] = 
	`sbus_»ad
(
dd
, 
rcv_addr
, 0x04, 0x0);

2287 ià(
i
 > 0 && 
çbric_v”s
[0] != fabric_vers[i])

2288 
®l_§me
 = 0;

2291 ià(
®l_§me
) {

2292 
	`dd_dev_šfo
(
dd
, "Fabric SerDes firmware version 0x%x\n",

2293 
çbric_v”s
[0]);

2295 
	`dd_dev_w¬n
(
dd
, "Fabric SerDes do‚ot havehe same firmware version\n");

2296 
i
 = 0; i < 
NUM_FABRIC_SERDES
; i++) {

2297 
	`dd_dev_šfo
(
dd
,

2299 
i
, 
çbric_v”s
[i]);

2303 
	`þ—r_sbus_ç¡_mode
(
dd
);

2304 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_SBUS
);

2305 
	}
}

	@gdr_ops.c

70 
	~<lšux/pÞl.h
>

71 
	~<lšux/cdev.h
>

72 
	~<lšux/vm®loc.h
>

73 
	~<lšux/io.h
>

74 
	~<lšux/aio.h
>

75 
	~<lšux/b™m­.h
>

76 
	~<lšux/fže.h
>

77 
	~<lšux/li¡.h
>

78 
	~<lšux/mm.h
>

79 
	~<lšux/mmª.h
>

80 
	~<lšux/sched.h
>

81 
	~<lšux/io.h
>

83 
	~<rdma/ib.h
>

85 
	~"mmu_rb.h
"

86 
	~"hfi.h
"

87 
	~"deviû.h
"

88 
	~"Œaû.h
"

89 
	~"nv-p2p.h
"

90 
	~"gpu.h
"

91 
	~"gdr_Ýs.h
"

93 
	ggdr_majÜ
;

94 
þass
 *
	ggdr_þass
;

95 
deviû
 *
	ggdr_deviû
;

96 
dev_t
 
	ggdr_dev
;

98 
	#GDR_DRIVER_NAME
 "hfi1_gdr_chr"

	)

99 
	#GDR_CLASS_NAME
 "hfi1_gdr"

	)

100 
	#GDR_DEV_NAME
 "hfi1_gdr"

	)

135 
	shfi1_gdrd©a
 {

136 
©omic_t
 
	mioùl_busy_æag
;

137 
mmu_rb_hªdËr
 *
	mgdr_hªdËr
;

138 *
	mm­_this_mr
;

139 
mu‹x
 
	mmr_lock
;

140 
wÜkqueue_¡ruù
 *
	mgdr_wq
;

141 
	mn_·ges_locked
;

142 
li¡_h—d
 
	mÌu_li¡
;

164 
	sgdr_mr
 {

165 
mmu_rb_node
 
	mrb_node
;

166 
li¡_h—d
 
	mli¡
;

167 
u64
 
	mho¡_addr
;

168 
u32
 
	mmr_hªdË
;

169 
nvidŸ_p2p_·ge_bË_t
 *
	m·ge_bË
;

170 
hfi1_gdrd©a
 *
	mgd
;

171 
k»f
 
	m»f_út
;

185 
šlše
 
	$gdrdrv_munm­
(
gdr_mr
 *
mr
)

187 
unm­_»t
 = 0;

189 ià(
mr
->
ho¡_addr
 && !(
cu¼’t
->
æags
 & 
PF_EXITING
)) {

190 
unm­_»t
 = 
	`vm_munm­
(
mr
->
ho¡_addr
, mr->
rb_node
.
Ën
);

191 
	`WARN_ON
(
unm­_»t
);

193 
mr
->
ho¡_addr
 = 0;

194 
	}
}

196 
šlše
 

197 
	$mr_com¶‘e
(
k»f
 *kref)

199 
gdr_mr
 *
mr
;

200 
hfi1_gdrd©a
 *
gd
;

202 
mr
 = 
	`cÚš”_of
(
k»f
, 
gdr_mr
, 
»f_út
);

203 
gd
 = 
mr
->gd;

204 
	`WARN_ON
(
gd
->
m­_this_mr
 =ð
mr
);

205 
	`hfi1_mmu_rb_»move
(
mr
->
gd
->
gdr_hªdËr
, &mr->
rb_node
);

206 
	`li¡_d–
(&
mr
->
li¡
);

207 
	`kä“
(
mr
);

209 
	}
}

211 
šlše
 

212 
	$acquœe_ÿÎback_mr_»f
(
gdr_mr
 *
mr
)

214 
	`k»f_g‘
(&
mr
->
»f_út
);

215 
	}
}

217 
šlše
 

218 
	$»Ëa£_ÿÎback_mr_»f
(
gdr_mr
 *
mr
)

220 
	`k»f_put
(&
mr
->
»f_út
, 
mr_com¶‘e
);

221 
	}
}

223 
šlše
 

224 
	$acquœe_ioùl_mr_»f
(
gdr_mr
 *
mr
)

226 
	`k»f_g‘
(&
mr
->
»f_út
);

227 
	}
}

229 
šlše
 

230 
	$»Ëa£_ioùl_mr_»f
(
gdr_mr
 *
mr
)

232 
	`k»f_put
(&
mr
->
»f_út
, 
mr_com¶‘e
);

233 
	}
}

253 
šlše
 
off_t


254 
	$hªdË_to_off£t
(
u32
 
hªdË
)

256  (
off_t
)
hªdË
 << 
PAGE_SHIFT
;

257 
	}
}

268 
šlše
 
u32


269 
	$hªdË_äom_vm_pgoff
(
pgoff
)

271  (
u32
)
pgoff
;

272 
	}
}

281 
šlše
 
u32


282 
	$g‘_¿ndom_hªdË
()

284  (
u32
)
	`g‘_cyþes
();

285 
	}
}

290 
hfi1_gdr_Ý’
(
šode
 *šode, 
fže
 *
å
);

291 
hfi1_gdr_»Ëa£
(
šode
 *šode, 
fže
 *
å
);

292 
hfi1_gdr_mm­
(
fže
 *
å
, 
vm_¬—_¡ruù
 *
vma
);

293 
hfi1_gdr_ioùl
(
fže
 *
å
, 
cmd
,

294 
¬g
);

296 cÚ¡ 
fže_Ý”©iÚs
 
	ghfi1_gdr_Ýs
 = {

297 .
owÃr
 = 
THIS_MODULE
,

298 .
	gÝ’
 = 
hfi1_gdr_Ý’
,

299 .
	g»Ëa£
 = 
hfi1_gdr_»Ëa£
,

300 .
	guÆocked_ioùl
 = 
hfi1_gdr_ioùl
,

301 .
	gmm­
 = 
hfi1_gdr_mm­
,

302 .
	gÎ£ek
 = 
noÝ_Î£ek
,

305 
boÞ
 
	$gdr_rb_fž‹r
(
mmu_rb_node
 *
node
, 
addr
,

306 
Ën
)

308  (
boÞ
)(
node
->
addr
 ==‡ddr);

309 
	}
}

311 
	$gdr_rb_š£¹
(*
¬g
, 
mmu_rb_node
 *
mnode
)

314 
	}
}

316 
	$gdr_rb_eviù
(*
¬g
, 
mmu_rb_node
 *
mnode
,

317 *
eviù_¬g
, 
boÞ
 *
¡Ý
)

320 
	}
}

322 
	$gdr_rb_»move
(*
¬g
, 
mmu_rb_node
 *
mnode
)

324 
	}
}

326 
	$gdr_rb_šv®id©e
(*
¬g
, 
mmu_rb_node
 *
mnode
)

329 
	}
}

331 
mmu_rb_Ýs
 
	ggdr_rb_Ýs
 = {

332 .
fž‹r
 = 
gdr_rb_fž‹r
,

333 .
	gš£¹
 = 
gdr_rb_š£¹
,

334 .
	geviù
 = 
gdr_rb_eviù
,

335 .
	g»move
 = 
gdr_rb_»move
,

336 .
	gšv®id©e
 = 
gdr_rb_šv®id©e


349 
	$hfi1_gdr_Ý’
(
šode
 *šode, 
fže
 *
fž•
)

351 
»t
 = 0;

352 
hfi1_gdrd©a
 *
gd
;

354 
gd
 = 
	`kz®loc
((*gd), 
GFP_KERNEL
);

355 ià(!
gd
)

356  -
ENOMEM
;

358 
fž•
->
´iv©e_d©a
 = 
gd
;

359 
	`mu‹x_š™
(&
gd
->
mr_lock
);

360 
»t
 = 
	`hfi1_mmu_rb_»gi¡”
(
gd
, 
NULL
, &
gdr_rb_Ýs
,

361 
gd
->
gdr_wq
, &gd->
gdr_hªdËr
);

362 ià(
»t
) {

363 
fž•
->
´iv©e_d©a
 = 
NULL
;

364 
	`kä“
(
gd
);

365  
»t
;

368 
	`INIT_LIST_HEAD
(&
gd
->
Ìu_li¡
);

369 
gd
->
n_·ges_locked
 = 0;

371  
»t
;

372 
	}
}

405 
	$gdrdrv_g‘_·ges_ä“_ÿÎback
(*
d©a
)

407 
hfi1_gdrd©a
 *
gd
;

408 
gdr_mr
 *
mr
 = 
d©a
;

409 
Åages
;

411 
gd
 = 
mr
->gd;

412 
	`mu‹x_lock
(&
gd
->
mr_lock
);

413 
	`gdrdrv_munm­
(
mr
);

419 
	`WARN_ON
(!
mr
->
·ge_bË
);

420 ià(
mr
->
·ge_bË
) {

421 
	`ä“_gpu_·ge_bË
(
mr
->
·ge_bË
);

422 
mr
->
·ge_bË
 = 
NULL
;

423 
Åages
 = 
	`num_u£r_·ges_gpu
(
mr
->
rb_node
.
addr
, mr->rb_node.
Ën
);

424 
gd
->
n_·ges_locked
 -ð
Åages
;

426 
	`»Ëa£_ÿÎback_mr_»f
(
mr
);

427 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

428 
	}
}

448 
	$do_munm­_ªd_uÅš_gpu_buf
(
gdr_mr
 *
mr
)

450 
hfi1_gdrd©a
 *
gd
 = 
mr
->gd;

451 
Åages
;

452 
»t
;

454 
	`mu‹x_lock
(&
gd
->
mr_lock
);

455 
	`gdrdrv_munm­
(
mr
);

456 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

491 
»t
 = 
	`nvidŸ_p2p_put_·ges
(0, 0, 
mr
->
rb_node
.
addr
, mr->
·ge_bË
);

492 
	`mu‹x_lock
(&
gd
->
mr_lock
);

493 
Åages
 = 
	`num_u£r_·ges_gpu
(
mr
->
rb_node
.
addr
, mr->rb_node.
Ën
);

494 
gd
->
n_·ges_locked
 -ð
Åages
;

495 
	`»Ëa£_ioùl_mr_»f
(
mr
);

496 ià(!
»t
) {

497 
mr
->
·ge_bË
 = 
NULL
;

498 
	`»Ëa£_ÿÎback_mr_»f
(
mr
);

501 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

502 
	}
}

517 
gdr_mr
 *
	$ü—‹_mr
(
hfi1_gdrd©a
 *
gd
,

518 
u64
 
gpu_buf_addr
,

519 
u32
 
gpu_buf_size
)

521 
gdr_mr
 *
mr
;

523 
mr
 = 
	`kz®loc
((*mr), 
GFP_KERNEL
);

524 ià(!
mr
)

525  
mr
;

527 
mr
->
rb_node
.
addr
 = 
gpu_buf_addr
;

528 
mr
->
rb_node
.
Ën
 = 
gpu_buf_size
;

529 
mr
->
gd
 = gd;

530 
mr
->
mr_hªdË
 = 
	`g‘_¿ndom_hªdË
();

531 
mr
->
ho¡_addr
 = 0;

532 
mr
->
·ge_bË
 = 
NULL
;

533 
	`k»f_š™
(&
mr
->
»f_út
);

535  
mr
;

536 
	}
}

548 
u32
 
	$eviù_gpu_ÿche
(
hfi1_gdrd©a
 *
gd
, 
u32
 
rg‘
)

550 
gdr_mr
 *
mr
, *
±r
;

551 
Åages
, 
þ—»d
 = 0;

553 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
mr
, 
±r
, &
gd
->
Ìu_li¡
, 
li¡
) {

554 
Åages
 = 
	`num_u£r_·ges_gpu
(
mr
->
rb_node
.
addr
, mr->rb_node.
Ën
);

556 
þ—»d
 +ð
Åages
;

557 
	`acquœe_ioùl_mr_»f
(
mr
);

558 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

559 
	`do_munm­_ªd_uÅš_gpu_buf
(
mr
);

560 
	`mu‹x_lock
(&
gd
->
mr_lock
);

562 ià(
þ—»d
 >ð
rg‘
)

565  
þ—»d
;

566 
	}
}

597 
	$do_pš_ªd_mm­_gpu_buf
(
fže
 *
å
,

598 
hfi1_gdrd©a
 *
gd
,

599 
gdr_mr
 *
mr
)

601 
vœtu®
, 
max_ÿche_·ges
;

602 
Åages
, 
rg‘
, 
þ—»d
;

603 
»t
 = 0;

605 
	`mu‹x_lock
(&
gd
->
mr_lock
);

607 
max_ÿche_·ges
 = ((
gpu_ÿche_size
 << 20è>> 
NV_GPU_PAGE_SHIFT
);

608 
Åages
 = 
	`num_u£r_·ges_gpu
(
mr
->
rb_node
.
addr
, mr->rb_node.
Ën
);

610 ià(
gd
->
n_·ges_locked
 + 
Åages
 > 
max_ÿche_·ges
) {

611 ià(
Åages
 > 
max_ÿche_·ges
) {

612 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

613  -
EINVAL
;

615 
rg‘
 = 
Åages
 - (
max_ÿche_·ges
 - 
gd
->
n_·ges_locked
);

616 
þ—»d
 = 
	`eviù_gpu_ÿche
(
gd
, 
rg‘
);

617 
	`WARN_ON
(
þ—»d
 < 
rg‘
);

620 
»t
 = 
	`g‘_gpu_·ges
(
mr
->
rb_node
.
addr
, mr->rb_node.
Ën
,

621 &
mr
->
·ge_bË
,

622 
gdrdrv_g‘_·ges_ä“_ÿÎback
,

623 
mr
);

625 ià(
»t
) {

636 ià((
»t
 =ð-
ENOMEM
è|| (»ˆ=ð-
EINVAL
)) {

637 
rg‘
 = 
Åages
;

638 
þ—»d
 = 
	`eviù_gpu_ÿche
(
gd
, 
rg‘
);

639 
»t
 = 
	`g‘_gpu_·ges
(
mr
->
rb_node
.
addr
,

640 
mr
->
rb_node
.
Ën
,

641 &
mr
->
·ge_bË
,

642 
gdrdrv_g‘_·ges_ä“_ÿÎback
,

643 
mr
);

644 ià(!
»t
)

645 
pš_sucûss
;

647 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

648 
	`kä“
(
mr
);

649  
»t
;

651 
pš_sucûss
:

652 
gd
->
n_·ges_locked
 +ð
Åages
;

654 
	`acquœe_ÿÎback_mr_»f
(
mr
);

662 
gd
->
m­_this_mr
 = 
mr
;

664 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

671 
vœtu®
 = 
	`vm_mm­
(
å
, 0, 
mr
->
rb_node
.
Ën
,

672 
PROT_READ
|
PROT_WRITE
,

673 
MAP_SHARED
,

674 
	`hªdË_to_off£t
(
mr
->
mr_hªdË
));

676 
	`mu‹x_lock
(&
gd
->
mr_lock
);

684 
gd
->
m­_this_mr
 = 
NULL
;

686 ià(!
mr
->
·ge_bË
) {

698 ià(!
	`IS_ERR
((*)
vœtu®
)) {

699 
munm­_»t
;

701 
munm­_»t
 = 
	`vm_munm­
(
mr
->
ho¡_addr
, mr->
rb_node
.
Ën
);

702 
	`WARN_ON
(
munm­_»t
);

704 
	`»Ëa£_ioùl_mr_»f
(
mr
);

705 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

706  -
EINVAL
;

717 ià(
	`IS_ERR
((*)
vœtu®
)) {

718 
	`WARN_ON
(1);

719 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

720 
	`do_munm­_ªd_uÅš_gpu_buf
(
mr
);

721  
vœtu®
;

724 
mr
->
ho¡_addr
 = 
vœtu®
;

725 
»t
 = 
	`hfi1_mmu_rb_š£¹
(
gd
->
gdr_hªdËr
, &
mr
->
rb_node
);

726 ià(
»t
)

727 
	`WARN_ON
(
»t
);

728 
	`li¡_add
(&
mr
->
li¡
, &
gd
->
Ìu_li¡
);

729 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

731  
»t
;

732 
	}
}

747 
	$ãtch_u£r_qu”y_ioùl_·¿ms
(
¬g
,

748 
hfi1_gdr_qu”y_·¿ms
 *
qu”y_·¿ms
)

750 ià(
	`cÝy_äom_u£r
(
qu”y_·¿ms
,

751 (
hfi_gdr_qu”y_·¿ms
 
__u£r
 *)
¬g
,

752 (*
qu”y_·¿ms
)))

753  -
EFAULT
;

755 ià(
qu”y_·¿ms
->
qu”y_·¿ms_š
.
v”siÚ
 !ð
HFI1_GDR_VERSION
)

756  -
ENODEV
;

758 ià((!
qu”y_·¿ms
->
qu”y_·¿ms_š
.
gpu_buf_size
) ||

759 (
qu”y_·¿ms
->
qu”y_·¿ms_š
.
gpu_buf_addr
 & ~
NV_GPU_PAGE_MASK
) ||

760 (
qu”y_·¿ms
->
qu”y_·¿ms_š
.
gpu_buf_size
 & ~
NV_GPU_PAGE_MASK
))

761  -
EINVAL
;

765 
	}
}

783 
	$ioùl_gpu_buf_ÿche_eviù
(
hfi1_gdrd©a
 *
gd
,

784 
¬g
)

786 
þ—»d
 = 0, 
rg‘
;

787 
hfi1_gdr_ÿche_eviù_·¿ms
 
eviù_·¿ms
;

789 ià(
	`cÝy_äom_u£r
(&
eviù_·¿ms
,

790 (
hfi1_gdr_ÿche_eviù_·¿ms
 
__u£r
 *)
¬g
,

791 (
eviù_·¿ms
)))

792  -
EFAULT
;

794 ià(
eviù_·¿ms
.
eviù_·¿ms_š
.
v”siÚ
 !ð
HFI1_GDR_VERSION
)

795  -
ENODEV
;

797 
rg‘
 = 
eviù_·¿ms
.
eviù_·¿ms_š
.
·ges_to_eviù
;

799 
	`mu‹x_lock
(&
gd
->
mr_lock
);

800 ià(
rg‘
 > 0)

801 
þ—»d
 = 
	`eviù_gpu_ÿche
(
gd
, 
rg‘
);

802 
eviù_·¿ms
.
eviù_·¿ms_out
.
·ges_eviùed
 = 
þ—»d
;

803 
eviù_·¿ms
.
eviù_·¿ms_out
.
·ges_š_ÿche
 = 
gd
->
n_·ges_locked
;

804 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

806 ià(
	`cÝy_to_u£r
((
hfi1_gdr_ÿche_eviù_·¿ms
 
__u£r
 *)
¬g
,

807 &
eviù_·¿ms
,

808 (
eviù_·¿ms
)))

809  -
EFAULT
;

812 
	}
}

839 
	$ioùl_gpu_buf_pš_mm­
(
fže
 *
å
,

840 
hfi1_gdrd©a
 *
gd
,

841 
¬g
)

843 
hfi1_gdr_qu”y_·¿ms
 
qu”y_·¿ms
;

844 
gdr_mr
 *
mr
 = 
NULL
;

845 
»t
 = 0;

846 
mmu_rb_node
 *
rb_node
;

848 
»t
 = 
	`ãtch_u£r_qu”y_ioùl_·¿ms
(
¬g
, &
qu”y_·¿ms
);

849 ià(
»t
)

850  
»t
;

852 
	`mu‹x_lock
(&
gd
->
mr_lock
);

853 
rb_node
 = 
	`hfi1_mmu_rb_£¬ch_addr
(
gd
->
gdr_hªdËr
,

854 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_addr
,

855 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_size
);

856 ià(
rb_node
) {

861 
mr
 = 
	`cÚš”_of
(
rb_node
, 
gdr_mr
,„b_node);

862 ià(
rb_node
->
Ën
 >=

863 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_size
) {

878 
qu”y_·¿ms
.
qu”y_·¿ms_out
.
ho¡_buf_addr
 =

879 
mr
->
ho¡_addr
;

884 
	`li¡_d–
(&
mr
->
li¡
);

885 
	`li¡_add
(&
mr
->
li¡
, &
gd
->
Ìu_li¡
);

886 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

887 
sk_pš_mm­
;

902 
	`acquœe_ioùl_mr_»f
(
mr
);

903 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

904 
	`do_munm­_ªd_uÅš_gpu_buf
(
mr
);

905 
	`mu‹x_lock
(&
gd
->
mr_lock
);

908 
mr
 = 
	`ü—‹_mr
(
gd
,

909 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_addr
,

910 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_size
);

911 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

912 
»t
 = 
	`do_pš_ªd_mm­_gpu_buf
(
å
, 
gd
, 
mr
);

913 ià(!
»t
) {

914 
	`mu‹x_lock
(&
gd
->
mr_lock
);

915 
qu”y_·¿ms
.
qu”y_·¿ms_out
.
ho¡_buf_addr
 = 
mr
->
ho¡_addr
;

916 
	`»Ëa£_ioùl_mr_»f
(
mr
);

917 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

920 
sk_pš_mm­
:

921 ià((!
»t
è&& (
	`cÝy_to_u£r
((
hfi_gdr_qu”y_·¿ms
 
__u£r
 *)
¬g
,

922 &
qu”y_·¿ms
,

923 (
qu”y_·¿ms
))))

924  -
EFAULT
;

926  
»t
;

927 
	}
}

945 
	$ioùl_gpu_buf_munm­_uÅš
(
fže
 *
å
,

946 
hfi1_gdrd©a
 *
gd
,

947 
¬g
)

949 
hfi1_gdr_qu”y_·¿ms
 
qu”y_·¿ms
;

950 
gdr_mr
 *
mr
 = 
NULL
;

951 
»t
 = 0;

952 
mmu_rb_node
 *
rb_node
;

954 
»t
 = 
	`ãtch_u£r_qu”y_ioùl_·¿ms
(
¬g
, &
qu”y_·¿ms
);

955 ià(
»t
)

956  
»t
;

958 
	`mu‹x_lock
(&
gd
->
mr_lock
);

959 
rb_node
 = 
	`hfi1_mmu_rb_£¬ch_addr
(
gd
->
gdr_hªdËr
,

960 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_addr
,

961 
qu”y_·¿ms
.
qu”y_·¿ms_š
.
gpu_buf_size
);

962 ià(
rb_node
) {

963 
mr
 = 
	`cÚš”_of
(
rb_node
, 
gdr_mr
,„b_node);

964 
	`acquœe_ioùl_mr_»f
(
mr
);

966 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

968 ià(
mr
)

969 
	`do_munm­_ªd_uÅš_gpu_buf
(
mr
);

971 
»t
 = -
ENOENT
;

973  
»t
;

974 
	}
}

1000 
	$hfi1_gdr_ioùl
(
fže
 *
å
, 
cmd
,

1001 
¬g
)

1003 
hfi1_gdrd©a
 *
gd
 = 
å
->
´iv©e_d©a
;

1004 
»t
 = 0;

1006 ià(
	`©omic_cmpxchg
(&
gd
->
ioùl_busy_æag
, 0, 1))

1007  -
EINVAL
;

1009 
cmd
) {

1010 
HFI1_IOCTL_GDR_GPU_PIN_MMAP
:

1011 
»t
 = 
	`ioùl_gpu_buf_pš_mm­
(
å
, 
gd
, 
¬g
);

1013 
HFI1_IOCTL_GDR_GPU_MUNMAP_UNPIN
:

1014 
»t
 = 
	`ioùl_gpu_buf_munm­_uÅš
(
å
, 
gd
, 
¬g
);

1016 
HFI1_IOCTL_GDR_GPU_CACHE_EVICT
:

1017 
»t
 = 
	`ioùl_gpu_buf_ÿche_eviù
(
gd
, 
¬g
);

1020 
»t
 = -
EINVAL
;

1023 
	`WARN_ON
(
	`©omic_»ad
(&
gd
->
ioùl_busy_æag
) != 1);

1024 
	`©omic_£t
(&
gd
->
ioùl_busy_æag
, 0);

1026  
»t
;

1027 
	}
}

1043 
	$gdr_mm­_phys_mem_wcomb
(
vm_¬—_¡ruù
 *
vma
,

1044 
vaddr
,

1045 
·ddr
,

1046 
size_t
 
size
)

1048 
vma
->
vm_·ge_´Ù
 = 
	`pg´Ù_wr™ecombše
(vma->vm_page_prot);

1050 ià(
	`io_»m­_pâ_¿nge
(
vma
, 
vaddr
,

1051 
	`PHYS_PFN
(
·ddr
),

1052 
size
,

1053 
vma
->
vm_·ge_´Ù
))

1054  -
EAGAIN
;

1057 
	}
}

1076 
	$hfi1_gdr_mm­
(
fže
 *
fž•
, 
vm_¬—_¡ruù
 *
vma
)

1078 
»t
 = 0;

1079 
size_t
 
size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

1080 
hfi1_gdrd©a
 *
gd
 = 
fž•
->
´iv©e_d©a
;

1081 
gdr_mr
 *
mr
;

1082 
p
 = 0;

1083 
vaddr
, 
´ev_·ge_·ddr
;

1084 
phys_cÚtiguous
 = 1;

1086 
	`mu‹x_lock
(&
gd
->
mr_lock
);

1088 
mr
 = 
gd
->
m­_this_mr
;

1094 ià(!
mr
) {

1095 
»t
 = -
EINVAL
;

1096 
out
;

1104 ià(
mr
->
mr_hªdË
 !ð
	`hªdË_äom_vm_pgoff
(
vma
->
vm_pgoff
)) {

1105 
»t
 = -
EINVAL
;

1106 
out
;

1113 ià(!
mr
->
·ge_bË
) {

1114 
»t
 = -
EINVAL
;

1115 
out
;

1121 
vaddr
 = 
vma
->
vm_¡¬t
;

1122 
´ev_·ge_·ddr
 = 
mr
->
·ge_bË
->
·ges
[0]->
physiÿl_add»ss
;

1123 
phys_cÚtiguous
 = 1;

1124 
p
 = 1;… < 
mr
->
·ge_bË
->
’Œ›s
; ++p) {

1125 
nvidŸ_p2p_·ge
 *
·ge
 = 
mr
->
·ge_bË
->
·ges
[
p
];

1126 
·ge_·ddr
 = 
·ge
->
physiÿl_add»ss
;

1127 ià(
´ev_·ge_·ddr
 + 
NV_GPU_PAGE_SIZE
 !ð
·ge_·ddr
) {

1128 
phys_cÚtiguous
 = 0;

1131 
´ev_·ge_·ddr
 = 
·ge_·ddr
;

1134 ià(
phys_cÚtiguous
) {

1135 
size_t
 
Ën
 = 
	`mš
(
size
,

1136 
NV_GPU_PAGE_SIZE
 * 
mr
->
·ge_bË
->
’Œ›s
);

1137 
·ge0_·ddr
 =

1138 
mr
->
·ge_bË
->
·ges
[0]->
physiÿl_add»ss
;

1139 
»t
 = 
	`gdr_mm­_phys_mem_wcomb
(
vma
,

1140 
vaddr
,

1141 
·ge0_·ddr
,

1142 
Ën
);

1143 ià(
»t
)

1144 
out
;

1152 
p
 = 0;

1153 
size
 && 
p
 < 
mr
->
·ge_bË
->
’Œ›s
) {

1154 
nvidŸ_p2p_·ge
 *
·ge
 = 
mr
->
·ge_bË
->
·ges
[
p
];

1155 
·ge_·ddr
 = 
·ge
->
physiÿl_add»ss
;

1156 
size_t
 
Ën
 = 
	`mš
(
NV_GPU_PAGE_SIZE
, 
size
);

1158 
»t
 = 
	`gdr_mm­_phys_mem_wcomb
(
vma
,

1159 
vaddr
,

1160 
·ge_·ddr
,

1161 
Ën
);

1162 ià(
»t
)

1163 
out
;

1165 
vaddr
 +ð
Ën
;

1166 
size
 -ð
Ën
;

1167 ++
p
;

1171 
out
:

1172 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

1174  
»t
;

1175 
	}
}

1188 
	$hfi1_gdr_»Ëa£
(
šode
 *šode, 
fže
 *
fž•
)

1190 
gdr_mr
 *
mr
;

1191 
mmu_rb_node
 *
mnode
;

1192 
hfi1_gdrd©a
 *
gd
 = 
fž•
->
´iv©e_d©a
;

1194 
fž•
->
´iv©e_d©a
 = 
NULL
;

1196 
	`mu‹x_lock
(&
gd
->
mr_lock
);

1197 (
mnode
 = 
	`hfi1_mmu_rb_fœ¡_ÿched
(
gd
->
gdr_hªdËr
))) {

1198 
mr
 = 
	`cÚš”_of
(
mnode
, 
gdr_mr
, 
rb_node
);

1199 
	`acquœe_ioùl_mr_»f
(
mr
);

1200 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

1201 
	`do_munm­_ªd_uÅš_gpu_buf
(
mr
);

1202 
	`mu‹x_lock
(&
gd
->
mr_lock
);

1204 
	`mu‹x_uÆock
(&
gd
->
mr_lock
);

1206 
	`hfi1_mmu_rb_uÄegi¡”
(
gd
->
gdr_hªdËr
);

1208 
	`kä“
(
gd
);

1211 
	}
}

1213 *
	$gdr_devnode
(
deviû
 *
dev
, 
umode_t
 *
mode
)

1215 ià(
mode
)

1216 *
mode
 = 0666;

1217  
	`ka¥rštf
(
GFP_KERNEL
, "%s", 
	`dev_Çme
(
dev
));

1218 
	}
}

1221 
	$add_gdr_dev
()

1223 
»t
 = 0;

1225 
gdr_majÜ
 = 
	`»gi¡”_chrdev
(0, 
GDR_DRIVER_NAME
, &
hfi1_gdr_Ýs
);

1226 ià(
gdr_majÜ
 < 0) {

1227 
gdr_majÜ
 = 0;

1228 
»t
 = -
ENODEV
;

1229 
out
;

1232 
gdr_dev
 = 
	`MKDEV
(
gdr_majÜ
, 0);

1234 
gdr_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
GDR_CLASS_NAME
);

1235 ià(
	`IS_ERR
(
gdr_þass
)) {

1236 
»t
 = 
	`PTR_ERR
(
gdr_þass
);

1237 
gdr_þass
 = 
NULL
;

1238 
out
;

1241 
gdr_þass
->
devnode
 = 
gdr_devnode
;

1243 
gdr_deviû
 = 
	`deviû_ü—‹
(
gdr_þass
, 
NULL
, 
gdr_dev
,

1244 
NULL
, "%s", 
GDR_DEV_NAME
);

1246 ià(
	`IS_ERR
(
gdr_deviû
)) {

1247 
»t
 = -
	`PTR_ERR
(
gdr_deviû
);

1248 
gdr_deviû
 = 
NULL
;

1249 
out
;

1252 
out
:

1253  
»t
;

1254 
	}
}

1256 
	$»move_gdr_dev
()

1258 ià(
gdr_deviû
) {

1259 
	`deviû_uÄegi¡”
(
gdr_deviû
);

1260 
gdr_deviû
 = 
NULL
;

1263 ià(
gdr_þass
) {

1264 
	`þass_de¡roy
(
gdr_þass
);

1265 
gdr_þass
 = 
NULL
;

1268 ià(
gdr_majÜ
) {

1269 
	`uÄegi¡”_chrdev
(
gdr_majÜ
, 
GDR_DRIVER_NAME
);

1270 
gdr_majÜ
 = 0;

1272 
	}
}

1279 
	$hfi1_gdr_deviû_ü—‹
()

1281 
»t
 = 0;

1283 
»t
 = 
	`add_gdr_dev
();

1284 ià(
»t
)

1285 
	`»move_gdr_dev
();

1287  
»t
;

1288 
	}
}

1293 
	$hfi1_gdr_deviû_»move
()

1295 
	`»move_gdr_dev
();

1296 
	}
}

	@gdr_ops.h

47 #iâdeà
_HFI1_GDR_OPS_H


48 
	#_HFI1_GDR_OPS_H


	)

50 
hfi1_gdr_deviû_ü—‹
();

51 
hfi1_gdr_deviû_»move
();

	@gpu.c

48 
	~<lšux/pci.h
>

49 
	~<lšux/ty³s.h
>

50 
	~<lšux/moduË.h
>

51 
	~"gpu.h
"

52 
	~"Œaû.h
"

54 
	ggpu_ÿche_size
 = 256;

55 
moduË_·¿m
(
gpu_ÿche_size
, 
ulÚg
, 
S_IRUGO
 | 
S_IWUSR
);

56 
MODULE_PARM_DESC
(
gpu_ÿche_size
, "Send‡nd„eceive side GPU buffers cache size†imit (in MB)");

58 
pš_gpu_·ges
(
vaddr
, 
Ën
,

59 
nvidŸ_p2p_·ge_bË
 **
·ge_bË_±r
,

60 (*
ä“_ÿÎback
)(*
d©a
), *data)

62 
»t
;

63 
nvidŸ_p2p_·ge_bË
 *
·ge_bË
;

65 
»t
 = 
	`g‘_gpu_·ges
(
vaddr
, 
Ën
, 
·ge_bË_±r
, 
ä“_ÿÎback
, 
d©a
);

66 ià(!
»t
) {

67 
·ge_bË
 = *
·ge_bË_±r
;

69 ià(
·ge_bË
->
·ge_size
 !ð
NVIDIA_P2P_PAGE_SIZE_64KB
) {

70 
	`Œaû_gpu_·ge_size_check
(
·ge_bË
->
·ge_size
);

71 
	`put_gpu_·ges
(
vaddr
, 
·ge_bË
);

72  -
EOPNOTSUPP
;

74 #ifdeà
NVIDIA_P2P_PAGE_TABLE_VERSION_COMPATIBLE


75 ià(!
	`NVIDIA_P2P_PAGE_TABLE_VERSION_COMPATIBLE
(
·ge_bË
)) {

76 
	`Œaû_gpu_·ge_tbl_check
(
NVIDIA_P2P_PAGE_TABLE_VERSION
,

77 
·ge_bË
->
v”siÚ
);

78 
	`put_gpu_·ges
(
vaddr
, 
·ge_bË
);

79  -
EOPNOTSUPP
;

83  
»t
;

84 
	}
}

	@gpu.h

1 #iâdeà
_HFI1_GPU_H


2 
	#_HFI1_GPU_H


	)

49 
	~"nv-p2p.h
"

51 
	#NV_GPU_PAGE_SHIFT
 16

	)

52 
	#NV_GPU_PAGE_SIZE
 
	`BIT
(
NV_GPU_PAGE_SHIFT
)

	)

53 
	#NV_GPU_PAGE_MASK
 (~(
NV_GPU_PAGE_SIZE
 - 1))

	)

55 
	#GPU_PAGE_TO_PFN
(
·ge
èÕage->
physiÿl_add»ss
 >> 
NV_GPU_PAGE_SHIFT
)

	)

57 
gpu_ÿche_size
;

59 
šlše
 
	$put_gpu_·ges
(
vaddr
,

60 
nvidŸ_p2p_·ge_bË
 *
·ge_bË
)

62 
	`nvidŸ_p2p_put_·ges
(0, 0, 
vaddr
, 
·ge_bË
);

63 
	}
}

65 
šlše
 
g‘_gpu_·ges
(
vaddr
, 
Ën
,

66 
nvidŸ_p2p_·ge_bË
 **
·ge_bË_±r
,

67 (*
ä“_ÿÎback
)(*
d©a
), *data)

69  
	`nvidŸ_p2p_g‘_·ges
(0, 0, 
vaddr
, 
Ën
, 
·ge_bË_±r
,

70 
ä“_ÿÎback
, 
d©a
);

71 
	}
}

73 
šlše
 
	$ä“_gpu_·ge_bË
(
nvidŸ_p2p_·ge_bË
 *
·ge_bË
)

75 
	`nvidŸ_p2p_ä“_·ge_bË
(
·ge_bË
);

76 
	}
}

78 
šlše
 
	$num_u£r_·ges_gpu
(
addr
,

79 
Ën
)

81 cÚ¡ 
¥age
 = 
addr
 & 
NV_GPU_PAGE_MASK
;

82 cÚ¡ 
•age
 = (
addr
 + 
Ën
 - 1è& 
NV_GPU_PAGE_MASK
;

84  1 + ((
•age
 - 
¥age
è>> 
NV_GPU_PAGE_SHIFT
);

85 
	}
}

87 
pš_gpu_·ges
(
vaddr
, 
Ën
,

88 
nvidŸ_p2p_·ge_bË
 **
·ge_bË_±r
,

89 (*
ä“_ÿÎback
)(*
d©a
), *data);

	@hfi.h

1 #iâdeà
_HFI1_KERNEL_H


2 
	#_HFI1_KERNEL_H


	)

50 
	~"com·t.h
"

51 
	~<lšux/š‹¼u±.h
>

52 
	~<lšux/pci.h
>

53 
	~<lšux/dma-m­pšg.h
>

54 
	~<lšux/mu‹x.h
>

55 
	~<lšux/li¡.h
>

56 
	~<lšux/sÿ‰”li¡.h
>

57 
	~<lšux/¦ab.h
>

58 
	~<lšux/idr.h
>

59 
	~<lšux/io.h
>

60 
	~<lšux/fs.h
>

61 
	~<lšux/com¶‘iÚ.h
>

62 
	~<lšux/k»f.h
>

63 
	~<lšux/sched.h
>

64 
	~<lšux/cdev.h
>

65 
	~<lšux/d–ay.h
>

66 
	~<lšux/kth»ad.h
>

67 
	~<lšux/i2c.h
>

68 
	~<lšux/i2c-®go-b™.h
>

69 
	~<rdma/ib_hdrs.h
>

70 
	~<rdma/Ýa_addr.h
>

71 
	~<lšux/rhashbË.h
>

72 
	~<lšux/Ãtdeviû.h
>

73 
	~<rdma/rdma_vt.h
>

75 
	~"ch_»gi¡”s.h
"

76 
	~"commÚ.h
"

77 
	~"Ýâ.h
"

78 
	~"v”bs.h
"

79 
	~"pio.h
"

80 
	~"ch.h
"

81 
	~"mad.h
"

82 
	~"qså.h
"

83 
	~"¶©fÜm.h
"

84 
	~"affš™y.h
"

85 
	~"msix.h
"

88 #ià
defšed
(
HAVE_ALLOC_RDMA_NETDEV
è|| defšed(
HAVE_RDMA_NETDEV_GET_PARAMS
)

89 
	#AIP
 1

	)

93 
	#HFI1_CHIP_VERS_MAJ
 3U

	)

96 
	#HFI1_CHIP_VERS_MIN
 0U

	)

99 
	#HFI1_OUI
 0x001175

	)

100 
	#HFI1_OUI_LSB
 40

	)

102 
	#DROP_PACKET_OFF
 0

	)

103 
	#DROP_PACKET_ON
 1

	)

105 
hfi1_ÿp_mask
;

106 
	#HFI1_CAP_KGET_MASK
(
mask
, 
ÿp
è((maskè& 
HFI1_CAP_
##ÿp)

	)

107 
	#HFI1_CAP_UGET_MASK
(
mask
, 
ÿp
) \

108 (((
mask
è>> 
HFI1_CAP_USER_SHIFT
è& 
HFI1_CAP_
##
ÿp
)

	)

109 
	#HFI1_CAP_KGET
(
ÿp
è(
	`HFI1_CAP_KGET_MASK
(
hfi1_ÿp_mask
, c­))

	)

110 
	#HFI1_CAP_UGET
(
ÿp
è(
	`HFI1_CAP_UGET_MASK
(
hfi1_ÿp_mask
, c­))

	)

111 
	#HFI1_CAP_IS_KSET
(
ÿp
è(!!
	`HFI1_CAP_KGET
(ÿp))

	)

112 
	#HFI1_CAP_IS_USET
(
ÿp
è(!!
	`HFI1_CAP_UGET
(ÿp))

	)

113 
	#HFI1_MISC_GET
(è((
hfi1_ÿp_mask
 >> 
HFI1_CAP_MISC_SHIFT
) & \

114 
HFI1_CAP_MISC_MASK
)

	)

116 
	#HFI1_ODR_MASK
(
r¢
è(Ô¢è& 
OPA_PI_MASK_OFFLINE_REASON
)

	)

122 
	#HFI1_CTRL_CTXT
 0

	)

128 
	#NUM_CCE_ERR_STATUS_COUNTERS
 41

	)

129 
	#NUM_RCV_ERR_STATUS_COUNTERS
 64

	)

130 
	#NUM_MISC_ERR_STATUS_COUNTERS
 13

	)

131 
	#NUM_SEND_PIO_ERR_STATUS_COUNTERS
 36

	)

132 
	#NUM_SEND_DMA_ERR_STATUS_COUNTERS
 4

	)

133 
	#NUM_SEND_EGRESS_ERR_STATUS_COUNTERS
 64

	)

134 
	#NUM_SEND_ERR_STATUS_COUNTERS
 3

	)

135 
	#NUM_SEND_CTXT_ERR_STATUS_COUNTERS
 5

	)

136 
	#NUM_SEND_DMA_ENG_ERR_STATUS_COUNTERS
 24

	)

146 
	shfi1_ib_¡©s
 {

147 
__u64
 
	m¥s_šts
;

148 
__u64
 
	m¥s_”ršts
;

149 
__u64
 
	m¥s_tx”rs
;

150 
__u64
 
	m¥s_rcv”rs
;

151 
__u64
 
	m¥s_hw”rs
;

152 
__u64
 
	m¥s_nÝiobufs
;

153 
__u64
 
	m¥s_ùxts
;

154 
__u64
 
	m¥s_ËÃ¼s
;

155 
__u64
 
	m¥s_buffuÎ
;

156 
__u64
 
	m¥s_hdrfuÎ
;

159 
hfi1_ib_¡©s
 
hfi1_¡©s
;

160 cÚ¡ 
pci_”rÜ_hªdËrs
 
hfi1_pci_”r_hªdËr
;

162 
num_driv”_úŒs
;

170 
	#HFI1_TRAFFIC_ACTIVE_THRESHOLD
 (2000)

	)

176 
	ghfi1_Ýcode_¡©s_³rùx
;

178 
	sùxt_—g”_bufs
 {

179 
	s—g”_bufãr
 {

180 *
	maddr
;

181 
dma_addr_t
 
	mdma
;

182 
ssize_t
 
	mËn
;

183 } *
	mbufãrs
;

185 *
	maddr
;

186 
dma_addr_t
 
	mdma
;

187 } *
	mrcvtids
;

188 
u32
 
	msize
;

189 
u32
 
	mrcvtid_size
;

190 
u16
 
	mcouÁ
;

191 
u16
 
	mnumbufs
;

192 
u16
 
	m®loûd
;

193 
u16
 
	mth»shÞd
;

196 
	sexp_tid_£t
 {

197 
li¡_h—d
 
	mli¡
;

198 
u32
 
	mcouÁ
;

201 
	stid_queue
 {

202 
li¡_h—d
 
	mqueue_h—d
;

204 
u32
 
	m’queue
;

205 
u32
 
	mdequeue
;

209 
	ghfi1_ùxtd©a
;

210 (*
	tšŒ_hªdËr
)(
	thfi1_ùxtd©a
 *
	trcd
, 
	td©a
);

211 (*
	trhf_rcv_funùiÚ_±r
)(
	thfi1_·ck‘
 *
	t·ck‘
);

213 
	shfi1_ùxtd©a
 {

215 *
rcvhdrq
;

217 vÞ©ž
__Ë64
 *
rcvhd¹až_kvaddr
;

219 
hfi1_µÜtd©a
 *
µd
;

221 
hfi1_devd©a
 *
dd
;

223 
£nd_cÚ‹xt
 *
sc
;

225 cÚ¡ 
rhf_rcv_funùiÚ_±r
 *
rhf_rcv_funùiÚ_m­
;

226 cÚ¡ 
rhf_rcv_funùiÚ_±r
 *
§ve_rhf_rcv_funùiÚ_m­
;

234 
šŒ_hªdËr
 
do_š‹¼u±
;

236 
šŒ_hªdËr
 
ç¡_hªdËr
;

238 
šŒ_hªdËr
 
¦ow_hªdËr
;

240 
Çpi_¡ruù
 *
Çpi
;

242 
u64
 
imask
;

244 
u32
 
h—d
;

246 
u16
 
rcvhdrq_út
;

247 
u8
 
œeg
;

249 
u8
 
£q_út
;

251 
u8
 
rcvhdrq’tsize
;

253 
u8
 
rhf_off£t
;

255 
u8
 
rcvavaž_timeout
;

257 
boÞ
 
is_vnic
;

259 
u8
 
vnic_q_idx
;

261 
boÞ
 
a¥m_šŒ_suµÜ‹d
;

263 
boÞ
 
a¥m_’abËd
;

265 
boÞ
 
a¥m_šŒ_’abË
;

266 
ùxt_—g”_bufs
 
egrbufs
;

268 
li¡_h—d
 
qp_wa™_li¡
;

270 
exp_tid_£t
 
tid_group_li¡
;

271 
exp_tid_£t
 
tid_u£d_li¡
;

272 
exp_tid_£t
 
tid_fuÎ_li¡
;

275 
tim”_li¡
 
a¥m_tim”
;

277 
æags
;

279 
tid_group
 *
groups
;

281 
dma_addr_t
 
rcvhdrq_dma
;

282 
dma_addr_t
 
rcvhdrqžaddr_dma
;

284 
ktime_t
 
a¥m_ts_Ï¡_šŒ
;

286 
ktime_t
 
a¥m_ts_tim”_sched
;

288 
¥šlock_t
 
a¥m_lock
;

290 
k»f
 kref;

292 
numa_id
;

294 
s16
 
msix_šŒ
;

296 
u16
 
jkey
;

298 
u16
 
rcv_¬¿y_groups
;

300 
u16
 
—g”_ba£
;

302 
u16
 
ex³ùed_couÁ
;

304 
u16
 
ex³ùed_ba£
;

306 
u8
 
ùxt
;

310 
mu‹x
 
exp_mu‹x
;

312 
¥šlock_t
 
exp_lock
;

315 
æow_mask
;

316 
tid_æow_¡©e
 
æows
[
RXE_NUM_TID_FLOWS
];

318 
tid_queue
 
æow_queue
;

320 
tid_queue
 
¿¼_queue
;

322 
wa™_queue_h—d_t
 
wa™
;

324 
u8
 
uuid
[16];

326 
comm
[
TASK_COMM_LEN
];

328 
	`DECLARE_BITMAP
(
š_u£_ùxts
, 
HFI1_MAX_SHARED_CTXTS
);

330 
ev’t_æags
;

332 *
subùxt_u»gba£
;

334 *
subùxt_rcvegrbuf
;

336 *
subùxt_rcvhdr_ba£
;

338 
u32
 
urg’t
;

340 
u32
 
urg’t_pÞl
;

342 
u16
 
pÞl_ty³
;

345 *
£cur™y
;

347 
u16
 
subùxt_id
;

349 
u32
 
u£rv”siÚ
;

354 
u8
 
subùxt_út
;

357 
hfi1_Ýcode_¡©s_³rùx
 *
Ý¡©s
;

367 
	shfi1_·ck‘
 {

368 *
ebuf
;

369 *
hdr
;

370 *
·ylßd
;

371 
hfi1_ùxtd©a
 *
rcd
;

372 
__Ë32
 *
rhf_addr
;

373 
rvt_qp
 *
qp
;

374 
ib_Ùh”_h—d”s
 *
ohdr
;

375 
ib_grh
 *
grh
;

376 
Ýa_16b_mgmt
 *
mgmt
;

377 
u64
 
rhf
;

378 
u32
 
maxút
;

379 
u32
 
rhqoff
;

380 
u32
 
dlid
;

381 
u32
 
¦id
;

382 
numpkt
;

383 
u16
 
Ž’
;

384 
s16
 
‘až
;

385 
u16
 
pkey
;

386 
u8
 
hËn
;

387 
u8
 
rsize
;

388 
u8
 
updegr
;

389 
u8
 
‘y³
;

390 
u8
 
exŒa_by‹
;

391 
u8
 
·d
;

392 
u8
 
sc
;

393 
u8
 
¦
;

394 
u8
 
Ýcode
;

395 
boÞ
 
mig¿‹d
;

399 
	#HFI1_PKT_TYPE_9B
 0

	)

400 
	#HFI1_PKT_TYPE_16B
 1

	)

405 
	#OPA_16B_L4_MASK
 0xFFuÎ

	)

406 
	#OPA_16B_SC_MASK
 0x1F00000uÎ

	)

407 
	#OPA_16B_SC_SHIFT
 20

	)

408 
	#OPA_16B_LID_MASK
 0xFFFFFuÎ

	)

409 
	#OPA_16B_DLID_MASK
 0xF000uÎ

	)

410 
	#OPA_16B_DLID_SHIFT
 20

	)

411 
	#OPA_16B_DLID_HIGH_SHIFT
 12

	)

412 
	#OPA_16B_SLID_MASK
 0xF00uÎ

	)

413 
	#OPA_16B_SLID_SHIFT
 20

	)

414 
	#OPA_16B_SLID_HIGH_SHIFT
 8

	)

415 
	#OPA_16B_BECN_MASK
 0x80000000uÎ

	)

416 
	#OPA_16B_BECN_SHIFT
 31

	)

417 
	#OPA_16B_FECN_MASK
 0x10000000uÎ

	)

418 
	#OPA_16B_FECN_SHIFT
 28

	)

419 
	#OPA_16B_L2_MASK
 0x60000000uÎ

	)

420 
	#OPA_16B_L2_SHIFT
 29

	)

421 
	#OPA_16B_PKEY_MASK
 0xFFFF0000uÎ

	)

422 
	#OPA_16B_PKEY_SHIFT
 16

	)

423 
	#OPA_16B_LEN_MASK
 0x7FF00000uÎ

	)

424 
	#OPA_16B_LEN_SHIFT
 20

	)

425 
	#OPA_16B_RC_MASK
 0xE000000uÎ

	)

426 
	#OPA_16B_RC_SHIFT
 25

	)

427 
	#OPA_16B_AGE_MASK
 0xFF0000uÎ

	)

428 
	#OPA_16B_AGE_SHIFT
 16

	)

429 
	#OPA_16B_ENTROPY_MASK
 0xFFFFuÎ

	)

434 
	#OPA_16B_L4_9B
 0x00

	)

435 
	#OPA_16B_L2_TYPE
 0x02

	)

436 
	#OPA_16B_L4_FM
 0x08

	)

437 
	#OPA_16B_L4_IB_LOCAL
 0x09

	)

438 
	#OPA_16B_L4_IB_GLOBAL
 0x0A

	)

439 
	#OPA_16B_L4_ETHR
 
OPA_VNIC_L4_ETHR


	)

444 
	#OPA_16B_L4_FM_PAD
 3

	)

445 
	#OPA_16B_L4_FM_HLEN
 24

	)

447 
šlše
 
u8
 
	$hfi1_16B_g‘_l4
(
hfi1_16b_h—d”
 *
hdr
)

449  (
u8
)(
hdr
->
Ìh
[2] & 
OPA_16B_L4_MASK
);

450 
	}
}

452 
šlše
 
u8
 
	$hfi1_16B_g‘_sc
(
hfi1_16b_h—d”
 *
hdr
)

454  (
u8
)((
hdr
->
Ìh
[1] & 
OPA_16B_SC_MASK
è>> 
OPA_16B_SC_SHIFT
);

455 
	}
}

457 
šlše
 
u32
 
	$hfi1_16B_g‘_dlid
(
hfi1_16b_h—d”
 *
hdr
)

459  (
u32
)((
hdr
->
Ìh
[1] & 
OPA_16B_LID_MASK
) |

460 (((
hdr
->
Ìh
[2] & 
OPA_16B_DLID_MASK
) >>

461 
OPA_16B_DLID_HIGH_SHIFT
è<< 
OPA_16B_DLID_SHIFT
));

462 
	}
}

464 
šlše
 
u32
 
	$hfi1_16B_g‘_¦id
(
hfi1_16b_h—d”
 *
hdr
)

466  (
u32
)((
hdr
->
Ìh
[0] & 
OPA_16B_LID_MASK
) |

467 (((
hdr
->
Ìh
[2] & 
OPA_16B_SLID_MASK
) >>

468 
OPA_16B_SLID_HIGH_SHIFT
è<< 
OPA_16B_SLID_SHIFT
));

469 
	}
}

471 
šlše
 
u8
 
	$hfi1_16B_g‘_beú
(
hfi1_16b_h—d”
 *
hdr
)

473  (
u8
)((
hdr
->
Ìh
[0] & 
OPA_16B_BECN_MASK
è>> 
OPA_16B_BECN_SHIFT
);

474 
	}
}

476 
šlše
 
u8
 
	$hfi1_16B_g‘_ãú
(
hfi1_16b_h—d”
 *
hdr
)

478  (
u8
)((
hdr
->
Ìh
[1] & 
OPA_16B_FECN_MASK
è>> 
OPA_16B_FECN_SHIFT
);

479 
	}
}

481 
šlše
 
u8
 
	$hfi1_16B_g‘_l2
(
hfi1_16b_h—d”
 *
hdr
)

483  (
u8
)((
hdr
->
Ìh
[1] & 
OPA_16B_L2_MASK
è>> 
OPA_16B_L2_SHIFT
);

484 
	}
}

486 
šlše
 
u16
 
	$hfi1_16B_g‘_pkey
(
hfi1_16b_h—d”
 *
hdr
)

488  (
u16
)((
hdr
->
Ìh
[2] & 
OPA_16B_PKEY_MASK
è>> 
OPA_16B_PKEY_SHIFT
);

489 
	}
}

491 
šlše
 
u8
 
	$hfi1_16B_g‘_rc
(
hfi1_16b_h—d”
 *
hdr
)

493  (
u8
)((
hdr
->
Ìh
[1] & 
OPA_16B_RC_MASK
è>> 
OPA_16B_RC_SHIFT
);

494 
	}
}

496 
šlše
 
u8
 
	$hfi1_16B_g‘_age
(
hfi1_16b_h—d”
 *
hdr
)

498  (
u8
)((
hdr
->
Ìh
[3] & 
OPA_16B_AGE_MASK
è>> 
OPA_16B_AGE_SHIFT
);

499 
	}
}

501 
šlše
 
u16
 
	$hfi1_16B_g‘_Ën
(
hfi1_16b_h—d”
 *
hdr
)

503  (
u16
)((
hdr
->
Ìh
[0] & 
OPA_16B_LEN_MASK
è>> 
OPA_16B_LEN_SHIFT
);

504 
	}
}

506 
šlše
 
u16
 
	$hfi1_16B_g‘_’ŒÝy
(
hfi1_16b_h—d”
 *
hdr
)

508  (
u16
)(
hdr
->
Ìh
[3] & 
OPA_16B_ENTROPY_MASK
);

509 
	}
}

511 
	#OPA_16B_MAKE_QW
(
low_dw
, 
high_dw
è(((
u64
)(high_dwè<< 32è| (low_dw))

	)

516 
	#OPA_16B_BTH_PAD_MASK
 7

	)

517 
šlše
 
u8
 
	$hfi1_16B_bth_g‘_·d
(
ib_Ùh”_h—d”s
 *
ohdr
)

519  (
u8
)((
	`be32_to_ýu
(
ohdr
->
bth
[0]è>> 
IB_BTH_PAD_SHIFT
) &

520 
OPA_16B_BTH_PAD_MASK
);

521 
	}
}

525 
	shfi1_¢oÝ_d©a
 {

526 
	mmode_æag
;

527 
cdev
 
	mcdev
;

528 
deviû
 *
	mþass_dev
;

530 
¥šlock_t
 
	m¢oÝ_lock
;

531 
li¡_h—d
 
	mqueue
;

532 
wa™_queue_h—d_t
 
	mwa™q
;

533 *
	mfž‹r_v®ue
;

534 (*
	mfž‹r_ÿÎback
)(*
	mhdr
, *
	md©a
, *
	mv®ue
);

535 
u64
 
	mdcc_cfg
;

539 
	#HFI1_PORT_SNOOP_MODE
 1U

	)

540 
	#HFI1_PORT_CAPTURE_MODE
 2U

	)

545 
	#OPA_16B_MGMT_QPN_MASK
 0xFFFFFF

	)

546 
šlše
 
u32
 
	$hfi1_16B_g‘_de¡_q²
(
Ýa_16b_mgmt
 *
mgmt
)

548  
	`be32_to_ýu
(
mgmt
->
de¡_q²
è& 
OPA_16B_MGMT_QPN_MASK
;

549 
	}
}

551 
šlše
 
u32
 
	$hfi1_16B_g‘_¤c_q²
(
Ýa_16b_mgmt
 *
mgmt
)

553  
	`be32_to_ýu
(
mgmt
->
¤c_q²
è& 
OPA_16B_MGMT_QPN_MASK
;

554 
	}
}

556 
šlše
 
	$hfi1_16B_£t_q²
(
Ýa_16b_mgmt
 *
mgmt
,

557 
u32
 
de¡_qp
, u32 
¤c_qp
)

559 
mgmt
->
de¡_q²
 = 
	`ýu_to_be32
(
de¡_qp
 & 
OPA_16B_MGMT_QPN_MASK
);

560 
mgmt
->
¤c_q²
 = 
	`ýu_to_be32
(
¤c_qp
 & 
OPA_16B_MGMT_QPN_MASK
);

561 
	}
}

567 
šlše
 
ib_Ùh”_h—d”s
 *

568 
	$hfi1_g‘_rc_ohdr
(
hfi1_Ýa_h—d”
 *
Ýah
)

570 
ib_Ùh”_h—d”s
 *
ohdr
;

571 
ib_h—d”
 *
hdr
 = 
NULL
;

572 
hfi1_16b_h—d”
 *
hdr_16b
 = 
NULL
;

575 ià(
Ýah
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_9B
) {

576 
hdr
 = &
Ýah
->
ibh
;

577 ià(
	`ib_g‘_Êh
(
hdr
è=ð
HFI1_LRH_BTH
)

578 
ohdr
 = &
hdr
->
u
.
Ùh
;

580 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

582 
u8
 
l4
;

584 
hdr_16b
 = &
Ýah
->opah;

585 
l4
 = 
	`hfi1_16B_g‘_l4
(
hdr_16b
);

586 ià(
l4
 =ð
OPA_16B_L4_IB_LOCAL
)

587 
ohdr
 = &
hdr_16b
->
u
.
Ùh
;

589 
ohdr
 = &
hdr_16b
->
u
.
l
.
Ùh
;

591  
ohdr
;

592 
	}
}

594 
	grvt_sge_¡©e
;

601 
	#HFI1_IB_CFG_LIDLMC
 0

	)

602 
	#HFI1_IB_CFG_LWID_DG_ENB
 1

	)

603 
	#HFI1_IB_CFG_LWID_ENB
 2

	)

604 
	#HFI1_IB_CFG_LWID
 3

	)

605 
	#HFI1_IB_CFG_SPD_ENB
 4

	)

606 
	#HFI1_IB_CFG_SPD
 5

	)

607 
	#HFI1_IB_CFG_RXPOL_ENB
 6

	)

608 
	#HFI1_IB_CFG_LREV_ENB
 7

	)

609 
	#HFI1_IB_CFG_LINKLATENCY
 8

	)

610 
	#HFI1_IB_CFG_HRTBT
 9

	)

611 
	#HFI1_IB_CFG_OP_VLS
 10

	)

612 
	#HFI1_IB_CFG_VL_HIGH_CAP
 11

	)

613 
	#HFI1_IB_CFG_VL_LOW_CAP
 12

	)

614 
	#HFI1_IB_CFG_OVERRUN_THRESH
 13

	)

615 
	#HFI1_IB_CFG_PHYERR_THRESH
 14

	)

616 
	#HFI1_IB_CFG_LINKDEFAULT
 15

	)

617 
	#HFI1_IB_CFG_PKEYS
 16

	)

618 
	#HFI1_IB_CFG_MTU
 17

	)

619 
	#HFI1_IB_CFG_VL_HIGH_LIMIT
 19

	)

620 
	#HFI1_IB_CFG_PMA_TICKS
 20

	)

621 
	#HFI1_IB_CFG_PORT
 21

	)

631 
	#__HLS_UP_INIT_BP
 0

	)

632 
	#__HLS_UP_ARMED_BP
 1

	)

633 
	#__HLS_UP_ACTIVE_BP
 2

	)

634 
	#__HLS_DN_DOWNDEF_BP
 3

	)

635 
	#__HLS_DN_POLL_BP
 4

	)

636 
	#__HLS_DN_DISABLE_BP
 5

	)

637 
	#__HLS_DN_OFFLINE_BP
 6

	)

638 
	#__HLS_VERIFY_CAP_BP
 7

	)

639 
	#__HLS_GOING_UP_BP
 8

	)

640 
	#__HLS_GOING_OFFLINE_BP
 9

	)

641 
	#__HLS_LINK_COOLDOWN_BP
 10

	)

643 
	#HLS_UP_INIT
 
	`BIT
(
__HLS_UP_INIT_BP
)

	)

644 
	#HLS_UP_ARMED
 
	`BIT
(
__HLS_UP_ARMED_BP
)

	)

645 
	#HLS_UP_ACTIVE
 
	`BIT
(
__HLS_UP_ACTIVE_BP
)

	)

646 
	#HLS_DN_DOWNDEF
 
	`BIT
(
__HLS_DN_DOWNDEF_BP
è

	)

647 
	#HLS_DN_POLL
 
	`BIT
(
__HLS_DN_POLL_BP
)

	)

648 
	#HLS_DN_DISABLE
 
	`BIT
(
__HLS_DN_DISABLE_BP
)

	)

649 
	#HLS_DN_OFFLINE
 
	`BIT
(
__HLS_DN_OFFLINE_BP
)

	)

650 
	#HLS_VERIFY_CAP
 
	`BIT
(
__HLS_VERIFY_CAP_BP
)

	)

651 
	#HLS_GOING_UP
 
	`BIT
(
__HLS_GOING_UP_BP
)

	)

652 
	#HLS_GOING_OFFLINE
 
	`BIT
(
__HLS_GOING_OFFLINE_BP
)

	)

653 
	#HLS_LINK_COOLDOWN
 
	`BIT
(
__HLS_LINK_COOLDOWN_BP
)

	)

655 
	#HLS_UP
 (
HLS_UP_INIT
 | 
HLS_UP_ARMED
 | 
HLS_UP_ACTIVE
)

	)

656 
	#HLS_DOWN
 ~(
HLS_UP
)

	)

658 
	#HLS_DEFAULT
 
HLS_DN_POLL


	)

661 
	#HFI1_DEFAULT_ACTIVE_MTU
 10240

	)

663 
	#HFI1_DEFAULT_MAX_MTU
 10240

	)

665 
	#DEFAULT_PKEY
 0xffff

	)

670 
	#FM_TBL_VL_HIGH_ARB
 1

	)

671 
	#FM_TBL_VL_LOW_ARB
 2

	)

672 
	#FM_TBL_BUFFER_CONTROL
 3

	)

673 
	#FM_TBL_SC2VLNT
 4

	)

674 
	#FM_TBL_VL_PREEMPT_ELEMS
 5

	)

675 
	#FM_TBL_VL_PREEMPT_MATRIX
 6

	)

682 
	#HFI1_RCVCTRL_TAILUPD_ENB
 0x01

	)

683 
	#HFI1_RCVCTRL_TAILUPD_DIS
 0x02

	)

684 
	#HFI1_RCVCTRL_CTXT_ENB
 0x04

	)

685 
	#HFI1_RCVCTRL_CTXT_DIS
 0x08

	)

686 
	#HFI1_RCVCTRL_INTRAVAIL_ENB
 0x10

	)

687 
	#HFI1_RCVCTRL_INTRAVAIL_DIS
 0x20

	)

688 
	#HFI1_RCVCTRL_PKEY_ENB
 0x40

	)

689 
	#HFI1_RCVCTRL_PKEY_DIS
 0x80

	)

690 
	#HFI1_RCVCTRL_TIDFLOW_ENB
 0x0400

	)

691 
	#HFI1_RCVCTRL_TIDFLOW_DIS
 0x0800

	)

692 
	#HFI1_RCVCTRL_ONE_PKT_EGR_ENB
 0x1000

	)

693 
	#HFI1_RCVCTRL_ONE_PKT_EGR_DIS
 0x2000

	)

694 
	#HFI1_RCVCTRL_NO_RHQ_DROP_ENB
 0x4000

	)

695 
	#HFI1_RCVCTRL_NO_RHQ_DROP_DIS
 0x8000

	)

696 
	#HFI1_RCVCTRL_NO_EGR_DROP_ENB
 0x10000

	)

697 
	#HFI1_RCVCTRL_NO_EGR_DROP_DIS
 0x20000

	)

698 
	#HFI1_RCVCTRL_URGENT_ENB
 0x40000

	)

699 
	#HFI1_RCVCTRL_URGENT_DIS
 0x80000

	)

702 
	#HFI1_PART_ENFORCE_IN
 0x1

	)

703 
	#HFI1_PART_ENFORCE_OUT
 0x2

	)

706 
	#SYNTH_CNT_TIME
 3

	)

709 
	#CNTR_NORMAL
 0x0

	)

710 
	#CNTR_SYNTH
 0x1

	)

711 
	#CNTR_DISABLED
 0x2

	)

712 
	#CNTR_32BIT
 0x4

	)

713 
	#CNTR_VL
 0x8

	)

714 
	#CNTR_SDMA
 0x10

	)

715 
	#CNTR_INVALID_VL
 -1

	)

716 
	#CNTR_MODE_W
 0x0

	)

717 
	#CNTR_MODE_R
 0x1

	)

720 
	#HFI1_MIN_VLS_SUPPORTED
 1

	)

721 
	#HFI1_MAX_VLS_SUPPORTED
 8

	)

723 
	#HFI1_GUIDS_PER_PORT
 5

	)

724 
	#HFI1_PORT_GUID_INDEX
 0

	)

726 
šlše
 
	$šü_úŒ64
(
u64
 *
úŒ
)

728 ià(*
úŒ
 < (
u64
)-1LL)

729 (*
úŒ
)++;

730 
	}
}

732 
šlše
 
	$šü_úŒ32
(
u32
 *
úŒ
)

734 ià(*
úŒ
 < (
u32
)-1LL)

735 (*
úŒ
)++;

736 
	}
}

738 
	#MAX_NAME_SIZE
 64

	)

739 
	shfi1_msix_’Œy
 {

740 
œq_ty³
 
	mty³
;

741 #ifdeà
NEED_MSIX_ENTRY


742 
msix_’Œy
 
	mmsix
;

744 
	mœq
;

745 *
	m¬g
;

746 
ýumask_t
 
	mmask
;

747 
œq_affš™y_nÙify
 
	mnÙify
;

750 
	shfi1_msix_šfo
 {

752 
¥šlock_t
 
	mmsix_lock
;

753 
DECLARE_BITMAP
(
š_u£_msix
, 
CCE_NUM_MSIX_VECTORS
);

754 
hfi1_msix_’Œy
 *
	mmsix_’Œ›s
;

755 
u16
 
	mmax_»que¡ed
;

759 
	scÿ_tim”
 {

760 
h¹im”
 
	mh¹im”
;

761 
hfi1_µÜtd©a
 *
	mµd
;

762 
	m¦
;

763 
u16
 
	mcùi
;

766 
	slšk_down_»asÚ
 {

771 
u8
 
	msma
;

772 
u8
 
	mÏ‹¡
;

776 
	mLO_PRIO_TABLE
,

777 
	mHI_PRIO_TABLE
,

778 
	mMAX_PRIO_TABLE


781 
	svl_¬b_ÿche
 {

783 
¥šlock_t
 
	mlock
;

784 
ib_vl_weight_–em
 
	mbË
[
VL_ARB_TABLE_SIZE
];

793 
	shfi1_µÜtd©a
 {

794 
hfi1_ibpÜt
 
	mibpÜt_d©a
;

796 
hfi1_devd©a
 *
	mdd
;

797 
kobjeù
 
	mµÜt_cc_kobj
;

798 
kobjeù
 
	msc2vl_kobj
;

799 
kobjeù
 
	m¦2sc_kobj
;

800 
kobjeù
 
	mvl2mtu_kobj
;

803 
qså_d©a
 
	mqså_šfo
;

805 
u32
 
	mpÜt_ty³
;

806 
u32
 
	mtx_´e£t_eq
;

807 
u32
 
	mtx_´e£t_nÛq
;

808 
u32
 
	mrx_´e£t
;

809 
u8
 
	mloÿl_©‹n
;

810 
u8
 
	m»mÙe_©‹n
;

811 
u8
 
	mdeçuÉ_©‹n
;

812 
u8
 
	mmax_pow”_þass
;

815 
boÞ
 
	mcÚfig_äom_sü©ch
;

818 
u64
 
	mguids
[
HFI1_GUIDS_PER_PORT
];

821 
u64
 
	mÃighbÜ_guid
;

824 
u32
 
	mlškup
;

830 
u64
 *
	m¡©u¥
;

834 
wÜkqueue_¡ruù
 *
	mhfi1_wq
;

835 
wÜkqueue_¡ruù
 *
	mlšk_wq
;

838 
wÜk_¡ruù
 
	mlšk_vc_wÜk
;

839 
wÜk_¡ruù
 
	mlšk_up_wÜk
;

840 
wÜk_¡ruù
 
	mlšk_down_wÜk
;

841 
wÜk_¡ruù
 
	msma_mes§ge_wÜk
;

842 
wÜk_¡ruù
 
	mä“ze_wÜk
;

843 
wÜk_¡ruù
 
	mlšk_downg¿de_wÜk
;

844 
wÜk_¡ruù
 
	mlšk_bounû_wÜk
;

845 
d–ayed_wÜk
 
	m¡¬t_lšk_wÜk
;

847 
mu‹x
 
	mhls_lock
;

848 
u32
 
	mho¡_lšk_¡©e
;

852 
u32
 
	mibmtu
;

857 
u32
 
	mibmaxËn
;

858 
u32
 
	mcu¼’t_eg»ss_¿‹
;

860 
u32
 
	mlid
;

862 
u16
 
	mpkeys
[
MAX_PKEY_VALUES
];

863 
u16
 
	mlšk_width_suµÜ‹d
;

864 
u16
 
	mlšk_width_downg¿de_suµÜ‹d
;

865 
u16
 
	mlšk_¥“d_suµÜ‹d
;

866 
u16
 
	mlšk_width_’abËd
;

867 
u16
 
	mlšk_width_downg¿de_’abËd
;

868 
u16
 
	mlšk_¥“d_’abËd
;

869 
u16
 
	mlšk_width_aùive
;

870 
u16
 
	mlšk_width_downg¿de_tx_aùive
;

871 
u16
 
	mlšk_width_downg¿de_rx_aùive
;

872 
u16
 
	mlšk_¥“d_aùive
;

873 
u8
 
	mvls_suµÜ‹d
;

874 
u8
 
	mvls_Ý”©iÚ®
;

875 
u8
 
	maùu®_vls_Ý”©iÚ®
;

877 
u8
 
	mlmc
;

879 
u8
 
	mrx_pÞ_šv
;

881 
u8
 
	mhw_pidx
;

882 
u8
 
	mpÜt
;

884 
u8
 
	mÃighbÜ_ty³
;

885 
u8
 
	mÃighbÜ_nÜm®
;

886 
u8
 
	mÃighbÜ_fm_£cur™y
;

887 
u8
 
	mÃighbÜ_pÜt_numb”
;

888 
u8
 
	mis_sm_cÚfig_¡¬‹d
;

889 
u8
 
	mofæše_di§bËd_»asÚ
;

890 
u8
 
	mis_aùive_Ýtimize_’abËd
;

891 
u8
 
	mdriv”_lšk_»ady
;

892 
u8
 
	mlšk_’abËd
;

893 
u8
 
	mlškš™_»asÚ
;

894 
u8
 
	mloÿl_tx_¿‹
;

895 
u8
 
	mqså_»Œy_couÁ
;

898 
u8
 
	mov”run_th»shÞd
;

899 
u8
 
	mphy_”rÜ_th»shÞd
;

900 
	mis_lšk_down_queued
;

907 
	mËd_ov”ride_v®s
[2];

908 
u8
 
	mËd_ov”ride_pha£
;

909 
©omic_t
 
	mËd_ov”ride_tim”_aùive
;

911 
tim”_li¡
 
	mËd_ov”ride_tim”
;

913 
u32
 
	msm_Œ­_qp
;

914 
u32
 
	m§_qp
;

920 
¥šlock_t
 
cÿ_tim”_lock
 
	m____ÿch–še_®igÃd_š_smp
;

921 
cÿ_tim”
 
	mcÿ_tim”
[
OPA_MAX_SLS
];

924 
ib_cc_bË_’Œy_shadow
 
	mcùi_’Œ›s
[
CC_TABLE_SHADOW_MAX
];

927 
Ýa_cÚge¡iÚ_£‰šg_’Œy_shadow


928 
	mcÚge¡iÚ_’Œ›s
[
OPA_MAX_SLS
];

934 
¥šlock_t
 
cc_¡©e_lock
 
	m____ÿch–še_®igÃd_š_smp
;

936 
cc_¡©e
 
__rcu
 *
	mcc_¡©e
;

939 
u16
 
	mtÙ®_cù_’Œy
;

942 
u32
 
	mcc_¦_cÚŒÞ_m­
;

945 
u8
 
	mcc_max_bË_’Œ›s
;

951 
¥šlock_t
 
cc_log_lock
 
	m____ÿch–še_®igÃd_š_smp
;

952 
u8
 
	mth»shÞd_cÚg_ev’t_m­
[
OPA_MAX_SLS
 / 8];

953 
u16
 
	mth»shÞd_ev’t_couÁ”
;

954 
Ýa_hfi1_cÚg_log_ev’t_š‹º®
 
	mcc_ev’ts
[
OPA_CONG_LOG_ELEMS
];

955 
	mcc_log_idx
;

956 
	mcc_mad_idx
;

959 
vl_¬b_ÿche
 
	mvl_¬b_ÿche
[
MAX_PRIO_TABLE
];

962 
u64
 *
	múŒs
;

964 
u64
 *
	msúŒs
;

966 
u64
 
	mpÜt_xm™_disÿrds
;

967 
u64
 
	mpÜt_xm™_disÿrds_vl
[
C_VL_COUNT
];

968 
u64
 
	mpÜt_xm™_cÚ¡¿št_”rÜs
;

969 
u64
 
	mpÜt_rcv_cÚ¡¿št_”rÜs
;

971 
u64
 
	mlšk_dowÃd
;

973 
u64
 
	mlšk_up
;

975 
u64
 
	munknown_äame_couÁ
;

977 
u16
 
	mpÜt_Ép_üc_mode
;

979 
u8
 
	mpÜt_üc_mode_’abËd
;

981 
u8
 
	mmgmt_®lowed
;

982 
u8
 
	m·¹_’fÜû
;

983 
lšk_down_»asÚ
 
	mloÿl_lšk_down_»asÚ
;

984 
lšk_down_»asÚ
 
	mÃigh_lšk_down_»asÚ
;

986 
u8
 
	m»mÙe_lšk_down_»asÚ
;

988 
u32
 
	mpÜt_”rÜ_aùiÚ
;

989 
wÜk_¡ruù
 
	mlšk¡©e_aùive_wÜk
;

991 
boÞ
 
	mcc_´esÿn
;

996 
u64
 
	mpÜt_vl_xm™_wa™_Ï¡
[
C_VL_COUNT
 + 1];

997 
u16
 
	m´ev_lšk_width
;

998 
u64
 
	mvl_xm™_æ™_út
[
C_VL_COUNT
 + 1];

1001 (*
	tÝcode_hªdËr
)(
	thfi1_·ck‘
 *
	t·ck‘
);

1002 (*
	thfi1_make_»q
)(
	trvt_qp
 *
	tqp
,

1003 
	thfi1_pkt_¡©e
 *
	tps
,

1004 
	trvt_swqe
 *
	twqe
);

1005 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
nÜm®_rhf_rcv_funùiÚs
[];

1006 cÚ¡ 
rhf_rcv_funùiÚ_±r
 
Ãtdev_rhf_rcv_funùiÚs
[];

1009 
	#RHF_RCV_CONTINUE
 0

	)

1010 
	#RHF_RCV_DONE
 1

	)

1011 
	#RHF_RCV_REPROCESS
 2

	)

1013 
	srcv_¬¿y_d©a
 {

1014 
u16
 
ngroups
;

1015 
u16
 
nùxt_exŒa
;

1016 
u8
 
group_size
;

1019 
	s³r_vl_d©a
 {

1020 
u16
 
mtu
;

1021 
£nd_cÚ‹xt
 *
sc
;

1025 
	#PER_VL_SEND_CONTEXTS
 16

	)

1027 
	s”r_šfo_rcvpÜt
 {

1028 
u8
 
¡©us_ªd_code
;

1029 
u64
 
·ck‘_æ™1
;

1030 
u64
 
·ck‘_æ™2
;

1033 
	s”r_šfo_cÚ¡¿št
 {

1034 
u8
 
¡©us
;

1035 
u16
 
pkey
;

1036 
u32
 
¦id
;

1039 
	shfi1_‹mp
 {

1040 
cu¼
;

1041 
lo_lim
;

1042 
hi_lim
;

1043 
ü™_lim
;

1044 
u8
 
Œigg”s
;

1047 
	shfi1_i2c_bus
 {

1048 
hfi1_devd©a
 *
cÚŒÞlšg_dd
;

1049 
i2c_ad­‹r
 
ad­‹r
;

1050 
i2c_®go_b™_d©a
 
®go
;

1051 
num
;

1055 
	shfi1_asic_d©a
 {

1056 
hfi1_devd©a
 *
dds
[2];

1057 
mu‹x
 
asic_»sourû_mu‹x
;

1058 
hfi1_i2c_bus
 *
i2c_bus0
;

1059 
hfi1_i2c_bus
 *
i2c_bus1
;

1063 
	#NUM_MAP_ENTRIES
 256

	)

1064 
	#NUM_MAP_REGS
 32

	)

1067 
	shfi1_vnic_d©a
 {

1068 
kmem_ÿche
 *
tx»q_ÿche
;

1069 
u8
 
num_vpÜts
;

1072 
hfi1_vnic_vpÜt_šfo
;

1077 
sdma_’gše
;

1078 
sdma_vl_m­
;

1080 
	#BOARD_VERS_MAX
 96

	)

1081 
	#SERIAL_MAX
 16

	)

1083 (*
	t£nd_routše
)(
	trvt_qp
 *, 
	thfi1_pkt_¡©e
 *, 
	tu64
);

1084 
	shfi1_devd©a
 {

1085 
hfi1_ibdev
 
v”bs_dev
;

1086 
li¡_h—d
 
li¡
;

1089 
pci_dev
 *
pcidev
;

1090 
cdev
 
u£r_cdev
;

1091 
cdev
 
dŸg_cdev
;

1092 
cdev
 
ui_cdev
;

1093 
deviû
 *
u£r_deviû
;

1094 
deviû
 *
dŸg_deviû
;

1095 
deviû
 *
ui_deviû
;

1098 
u8
 
__iomem
 *
k»gba£1
;

1099 
»sourû_size_t
 
phy§ddr
;

1102 
u8
 
__iomem
 *
k»gba£2
;

1104 
u32
 
ba£2_¡¬t
;

1107 
³r_vl_d©a
 
vld
[
PER_VL_SEND_CONTEXTS
];

1109 
£nd_cÚ‹xt_šfo
 *
£nd_cÚ‹xts
;

1111 
u8
 *
hw_to_sw
;

1113 
¥šlock_t
 
sc_lock
;

1115 
¥šlock_t
 
pio_m­_lock
;

1117 
¥šlock_t
 
sc_š™_lock
;

1119 
¥šlock_t
 
sde_m­_lock
;

1121 
£nd_cÚ‹xt
 **
k”Ãl_£nd_cÚ‹xt
;

1123 
pio_vl_m­
 
__rcu
 *
pio_m­
;

1125 
u64
 
deçuÉ_desc1
;

1129 vÞ©ž
__Ë64
 *
sdma_h—ds_dma
;

1130 
dma_addr_t
 
sdma_h—ds_phys
;

1131 *
sdma_·d_dma
;

1132 
dma_addr_t
 
sdma_·d_phys
;

1134 
size_t
 
sdma_h—ds_size
;

1136 
u32
 
num_sdma
;

1138 
sdma_’gše
 *
³r_sdma
;

1140 
sdma_vl_m­
 
__rcu
 *
sdma_m­
;

1142 
wa™_queue_h—d_t
 
sdma_unä“ze_wq
;

1143 
©omic_t
 
sdma_unä“ze_couÁ
;

1145 
u32
 
lcb_acûss_couÁ
;

1148 
hfi1_asic_d©a
 *
asic_d©a
;

1151 
__iomem
 *
pioba£
;

1156 
__iomem
 *
rcv¬¿y_wc
;

1161 
üed™_»tuº_ba£
 *
ü_ba£
;

1164 
sc_cÚfig_sizes
 
sc_sizes
[
SC_MAX
];

1166 *
bßrdÇme
;

1168 
u64
 
ùx0_£q_drÝ
;

1171 
u64
 
z_št_couÁ”
;

1172 
u64
 
z_rcv_lim™
;

1173 
u64
 
z_£nd_scheduË
;

1175 
u64
 
__³rýu
 *
£nd_scheduË
;

1177 
u16
 
num_Ãtdev_cÚ‹xts
;

1179 
u32
 
num_rcv_cÚ‹xts
;

1181 
u32
 
num_£nd_cÚ‹xts
;

1185 
u32
 
ä“ùxts
;

1187 
u32
 
num_u£r_cÚ‹xts
;

1189 
u32
 
rcv_šŒ_timeout_c¤
;

1191 
¥šlock_t
 
£ndù¾_lock
;

1192 
¥šlock_t
 
rcvù¾_lock
;

1193 
¥šlock_t
 
uùxt_lock
;

1194 
mu‹x
 
dc8051_lock
;

1195 
wÜkqueue_¡ruù
 *
upd©e_úŒ_wq
;

1196 
wÜk_¡ruù
 
upd©e_úŒ_wÜk
;

1198 
¥šlock_t
 
dc8051_memlock
;

1199 
dc8051_timed_out
;

1204 *
ev’ts
;

1210 
hfi1_¡©us
 *
¡©us
;

1213 
u64
 
»visiÚ
;

1215 
u64
 
ba£_guid
;

1218 
u8
 
lšk_g’3_ÿ·bË
;

1219 
u8
 
dc_shutdown
;

1221 
u32
 
lbus_width
;

1223 
u32
 
lbus_¥“d
;

1224 
un™
;

1225 
node
;

1228 
u32
 
pcib¬0
;

1229 
u32
 
pcib¬1
;

1230 
u32
 
pci_rom
;

1231 
u16
 
pci_commªd
;

1232 
u16
 
pc›_devùl
;

1233 
u16
 
pc›_Êkùl
;

1234 
u16
 
pc›_devùl2
;

1235 
u32
 
pci_msix0
;

1236 
u32
 
pci_h2
;

1242 
u8
 
£rŸl
[
SERIAL_MAX
];

1244 
u8
 
bßrdv”siÚ
[
BOARD_VERS_MAX
];

1245 
u8
 
lbus_šfo
[32];

1247 
u8
 
maj»v
;

1249 
u8
 
mš»v
;

1251 
u8
 
hfi1_id
;

1253 
u8
 
icode
;

1255 
u8
 
vau
;

1257 
u8
 
vcu
;

1259 
u16
 
lšk_üed™s
;

1261 
u16
 
vl15_š™
;

1269 
u16
 
vl15buf_ÿched
;

1272 
u8
 
n_krcv_queues
;

1273 
u8
 
qos_shiá
;

1275 
u16
 
œev
;

1276 
u32
 
dc8051_v”
;

1278 
¥šlock_t
 
hfi1_dŸg_Œªs_lock
;

1279 
¶©fÜm_cÚfig
…latform_config;

1280 
¶©fÜm_cÚfig_ÿche
 
pcfg_ÿche
;

1282 
dŸg_þ›Á
 *diag_client;

1285 
u64
 
gi_mask
[
CCE_NUM_INT_CSRS
];

1287 
rcv_¬¿y_d©a
 
rcv_’Œ›s
;

1290 
u16
 
psxm™wa™_check_¿‹
;

1295 
tim”_li¡
 
syÁh_¡©s_tim”
;

1298 
hfi1_msix_šfo
 
msix_šfo
;

1303 *
úŒÇmes
;

1304 
size_t
 
úŒÇme¦’
;

1305 
size_t
 
ndevúŒs
;

1306 
u64
 *
úŒs
;

1307 
u64
 *
súŒs
;

1312 
u64
 
Ï¡_tx
;

1313 
u64
 
Ï¡_rx
;

1318 
size_t
 
ÅÜtúŒs
;

1319 *
pÜtúŒÇmes
;

1320 
size_t
 
pÜtúŒÇme¦’
;

1322 
hfi1_¢oÝ_d©a
 
hfi1_¢oÝ
;

1324 
”r_šfo_rcvpÜt
ƒrr_info_rcvport;

1325 
”r_šfo_cÚ¡¿št
 
”r_šfo_rcv_cÚ¡¿št
;

1326 
”r_šfo_cÚ¡¿št
 
”r_šfo_xm™_cÚ¡¿št
;

1328 
©omic_t
 
drÝ_·ck‘
;

1329 
boÞ
 
do_drÝ
;

1330 
u8
 
”r_šfo_uncÜ»ùabË
;

1331 
u8
 
”r_šfo_fmcÚfig
;

1337 
u64
 
cû_”r_¡©us_út
[
NUM_CCE_ERR_STATUS_COUNTERS
];

1338 
u64
 
rcv_”r_¡©us_út
[
NUM_RCV_ERR_STATUS_COUNTERS
];

1339 
u64
 
misc_”r_¡©us_út
[
NUM_MISC_ERR_STATUS_COUNTERS
];

1340 
u64
 
£nd_pio_”r_¡©us_út
[
NUM_SEND_PIO_ERR_STATUS_COUNTERS
];

1341 
u64
 
£nd_dma_”r_¡©us_út
[
NUM_SEND_DMA_ERR_STATUS_COUNTERS
];

1342 
u64
 
£nd_eg»ss_”r_¡©us_út
[
NUM_SEND_EGRESS_ERR_STATUS_COUNTERS
];

1343 
u64
 
£nd_”r_¡©us_út
[
NUM_SEND_ERR_STATUS_COUNTERS
];

1346 
u64
 
sw_ùxt_”r_¡©us_út
[
NUM_SEND_CTXT_ERR_STATUS_COUNTERS
];

1348 
u64
 
sw_£nd_dma_’g_”r_¡©us_út
[

1349 
NUM_SEND_DMA_ENG_ERR_STATUS_COUNTERS
];

1351 
u64
 
sw_cû_”r_¡©us_agg»g©e
;

1353 
u64
 
sw_rcv_by·ss_·ck‘_”rÜs
;

1356 
u64
 
lcb_”r_’
;

1357 
ýu_mask_£t
 *
comp_veù
;

1358 *
comp_veù_m­pšgs
;

1359 
u32
 
comp_veù_possibË_ýus
;

1365 
£nd_routše
 
´oûss_pio_£nd
 
____ÿch–še_®igÃd_š_smp
;

1366 
£nd_routše
 
´oûss_dma_£nd
;

1367 (*
pio_šlše_£nd
)(
hfi1_devd©a
 *
dd
, 
pio_buf
 *
pbuf
,

1368 
u64
 
pbc
, cÚ¡ *
äom
, 
size_t
 
couÁ
);

1369 (*
´oûss_vnic_dma_£nd
)(
hfi1_devd©a
 *
dd
, 
u8
 
q_idx
,

1370 
hfi1_vnic_vpÜt_šfo
 *
všfo
,

1371 
sk_buff
 *
skb
, 
u64
 
pbc
, 
u8
 
¶’
);

1375 
hfi1_µÜtd©a
 *
µÜt
;

1377 
hfi1_ùxtd©a
 **
rcd
;

1378 
u64
 
__³rýu
 *
št_couÁ”
;

1380 
hfi1_Ýcode_¡©s_³rùx
 
__³rýu
 *
tx_Ý¡©s
;

1382 
u16
 
æags
;

1384 
u8
 
num_µÜts
;

1386 
u8
 
fœ¡_dyn_®loc_ùxt
;

1390 
£qlock_t
 
sc2vl_lock
 
____ÿch–še_®igÃd_š_smp
;

1391 
u64
 
sc2vl
[4];

1392 
u64
 
__³rýu
 *
rcv_lim™
;

1396 
u8
 
oui1
;

1397 
u8
 
oui2
;

1398 
u8
 
oui3
;

1401 
tim”_li¡
 
rcv”r_tim”
;

1403 
wa™_queue_h—d_t
 
ev’t_queue
;

1406 
__Ë64
 *
rcvhd¹až_dummy_kvaddr
;

1407 
dma_addr_t
 
rcvhd¹až_dummy_dma
;

1409 
u32
 
rcv_ovæ_út
;

1411 
¥šlock_t
 
a¥m_lock
;

1413 
©omic_t
 
a¥m_di§bËd_út
;

1415 
©omic_t
 
u£r_»fcouÁ
;

1417 
com¶‘iÚ
 
u£r_comp
;

1419 
boÞ
 
•rom_avažabË
;

1420 
boÞ
 
a¥m_suµÜ‹d
;

1421 
boÞ
 
a¥m_’abËd
;

1422 
rhashbË
 *
sdma_rht
;

1424 
kobjeù
 
kobj
;

1427 
hfi1_vnic_d©a
 
vnic
;

1429 
¥šlock_t
 
œq_¤c_lock
;

1430 
vnic_num_vpÜts
;

1431 
Ãt_deviû
 *
dummy_Ãtdev
;

1434 
©omic_t
 
oib_rsm_u¤_num
;

1438 
	#dc8051_v”
(
a
, 
b
, 
c
è(×è<< 16 | (bè<< 8 | (c))

	)

1439 
	#dc8051_v”_maj
(
a
è((×è& 0xff0000è>> 16)

	)

1440 
	#dc8051_v”_mš
(
a
è((×è& 0x00ff00è>> 8)

	)

1441 
	#dc8051_v”_·tch
(
a
è(×è& 0x0000ff)

	)

1444 
	#PT_EXPECTED
 0

	)

1445 
	#PT_EAGER
 1

	)

1446 
	#PT_INVALID_FLUSH
 2

	)

1447 
	#PT_INVALID
 3

	)

1449 
tid_rb_node
;

1450 
mmu_rb_node
;

1451 
mmu_rb_hªdËr
;

1454 
	shfi1_fžed©a
 {

1455 
¤cu_¡ruù
 
pq_¤cu
;

1456 
hfi1_devd©a
 *
dd
;

1457 
hfi1_ùxtd©a
 *
uùxt
;

1458 
hfi1_u£r_sdma_comp_q
 *
cq
;

1460 
¥šlock_t
 
pq_rcu_lock
;

1461 
hfi1_u£r_sdma_pkt_q
 
__rcu
 *
pq
;

1462 
u16
 
subùxt
;

1464 
»c_ýu_num
;

1465 
u32
 
tid_n_pšÃd
;

1466 #ifdeà
NVIDIA_GPU_DIRECT


1467 
u32
 
tid_n_gpu_pšÃd
;

1468 
mmu_rb_hªdËr
 *
hªdËr_gpu
;

1470 
mmu_rb_hªdËr
 *
hªdËr
;

1471 
tid_rb_node
 **
’Œy_to_rb
;

1472 
¥šlock_t
 
tid_lock
;

1473 
u32
 
tid_lim™
;

1474 
u32
 
tid_u£d
;

1475 
u32
 *
šv®id_tids
;

1476 
u32
 
šv®id_tid_idx
;

1478 
¥šlock_t
 
šv®id_lock
;

1479 
mm_¡ruù
 *
mm
;

1482 
li¡_h—d
 
hfi1_dev_li¡
;

1483 
¥šlock_t
 
hfi1_devs_lock
;

1484 
hfi1_devd©a
 *
	`hfi1_lookup
(
un™
);

1486 
šlše
 
	$uùxt_off£t
(
hfi1_ùxtd©a
 *
uùxt
)

1488  (
uùxt
->
ùxt
 - uùxt->
dd
->
fœ¡_dyn_®loc_ùxt
) *

1489 
HFI1_MAX_SHARED_CTXTS
;

1490 
	}
}

1492 
hfi1_š™
(
hfi1_devd©a
 *
dd
, 
»š™
);

1493 
¢oÝ_drÝ_£nd
;

1494 
¢oÝ_fÜû_ÿ±u»
;

1495 
hfi1_couÁ_aùive_un™s
();

1497 
hfi1_dŸg_add
(
hfi1_devd©a
 *
dd
);

1498 
hfi1_dŸg_»move
(
hfi1_devd©a
 *
dd
);

1499 
hªdË_lškup_chªge
(
hfi1_devd©a
 *
dd
, 
u32
 
lškup
);

1501 
hªdË_u£r_š‹¼u±
(
hfi1_ùxtd©a
 *
rcd
);

1503 
hfi1_ü—‹_rcvhdrq
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
);

1504 
hfi1_£tup_—g”bufs
(
hfi1_ùxtd©a
 *
rcd
);

1505 
hfi1_ü—‹_kùxts
(
hfi1_devd©a
 *
dd
);

1506 
hfi1_ü—‹_ùxtd©a
(
hfi1_µÜtd©a
 *
µd
, 
numa
,

1507 
hfi1_ùxtd©a
 **
rcd
);

1508 
hfi1_ä“_ùxt
(
hfi1_ùxtd©a
 *
rcd
);

1509 
hfi1_š™_µÜtd©a
(
pci_dev
 *
pdev
, 
hfi1_µÜtd©a
 *
µd
,

1510 
hfi1_devd©a
 *
dd
, 
u8
 
hw_pidx
, u8 
pÜt
);

1511 
hfi1_ä“_ùxtd©a
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
);

1512 
hfi1_rcd_put
(
hfi1_ùxtd©a
 *
rcd
);

1513 
hfi1_rcd_g‘
(
hfi1_ùxtd©a
 *
rcd
);

1514 
hfi1_ùxtd©a
 *
hfi1_rcd_g‘_by_šdex_§ã
(
hfi1_devd©a
 *
dd
,

1515 
u16
 
ùxt
);

1516 
hfi1_ùxtd©a
 *
hfi1_rcd_g‘_by_šdex
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
);

1517 
hªdË_»ûive_š‹¼u±
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
);

1518 
hªdË_»ûive_š‹¼u±_nodma_¹až
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
);

1519 
hªdË_»ûive_š‹¼u±_dma_¹až
(
hfi1_ùxtd©a
 *
rcd
, 
th»ad
);

1520 
hªdË_»ûive_š‹¼u±_Çpi_å
(
hfi1_ùxtd©a
 *
rcd
, 
budg‘
);

1521 
hªdË_»ûive_š‹¼u±_Çpi_¥
(
hfi1_ùxtd©a
 *
rcd
, 
budg‘
);

1522 
£t_®l_¦ow·th
(
hfi1_devd©a
 *
dd
);

1524 cÚ¡ 
pci_deviû_id
 
hfi1_pci_tbl
[];

1525 
hfi1_make_ud_»q_9B
(
rvt_qp
 *
qp
,

1526 
hfi1_pkt_¡©e
 *
ps
,

1527 
rvt_swqe
 *
wqe
);

1529 
hfi1_make_ud_»q_16B
(
rvt_qp
 *
qp
,

1530 
hfi1_pkt_¡©e
 *
ps
,

1531 
rvt_swqe
 *
wqe
);

1534 
	#RCV_PKT_OK
 0x0

	)

1535 
	#RCV_PKT_LIMIT
 0x1

	)

1536 
	#RCV_PKT_DONE
 0x2

	)

1542 
šlše
 
u32
 
	$hfi1_rcd_h—d
(
hfi1_ùxtd©a
 *
rcd
)

1544  
rcd
->
h—d
;

1545 
	}
}

1552 
šlše
 
	$hfi1_£t_rcd_h—d
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
h—d
)

1554 
rcd
->
h—d
 = head;

1555 
	}
}

1558 
šlše
 
__Ë32
 *
	$g‘_rhf_addr
(
hfi1_ùxtd©a
 *
rcd
)

1560  (
__Ë32
 *)
rcd
->
rcvhdrq
 +„cd->
h—d
 +„cd->
rhf_off£t
;

1561 
	}
}

1564 
šlše
 
boÞ
 
	$g‘_dma_¹až_£‰šg
(
hfi1_ùxtd©a
 *
rcd
)

1566  !!
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
DMA_RTAIL
);

1567 
	}
}

1575 
šlše
 
u8
 
	$hfi1_£q_šü_w¿p
(
u8
 
£q
)

1577 ià(++
£q
 > 
RHF_MAX_SEQ
)

1578 
£q
 = 1;

1579  
£q
;

1580 
	}
}

1588 
šlše
 
u8
 
	$hfi1_£q_út
(
hfi1_ùxtd©a
 *
rcd
)

1590  
rcd
->
£q_út
;

1591 
	}
}

1599 
šlše
 
	$hfi1_£t_£q_út
(
hfi1_ùxtd©a
 *
rcd
, 
u8
 
út
)

1601 
rcd
->
£q_út
 = 
út
;

1602 
	}
}

1611 
šlše
 
boÞ
 
	$Ï¡_rcv_£q
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
£q
)

1613  
£q
 !ð
rcd
->
£q_út
;

1614 
	}
}

1623 
šlše
 
boÞ
 
	$hfi1_£q_šü
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
£q
)

1625 
rcd
->
£q_út
 = 
	`hfi1_£q_šü_w¿p
(rcd->seq_cnt);

1626  
	`Ï¡_rcv_£q
(
rcd
, 
£q
);

1627 
	}
}

1633 
šlše
 
u8
 
	$g‘_hdrq’tsize
(
hfi1_ùxtd©a
 *
rcd
)

1635  
rcd
->
rcvhdrq’tsize
;

1636 
	}
}

1642 
šlše
 
u16
 
	$g‘_hdrq_út
(
hfi1_ùxtd©a
 *
rcd
)

1644  
rcd
->
rcvhdrq_út
;

1645 
	}
}

1654 
šlše
 
u32
 
	$rcvhdrq_size
(
hfi1_ùxtd©a
 *
rcd
)

1656  
	`PAGE_ALIGN
(
	`g‘_hdrq_út
(
rcd
) *

1657 
rcd
->
rcvhdrq’tsize
 * (
u32
));

1658 
	}
}

1664 
šlše
 
boÞ
 
	$hfi1_is_¦ow·th
(
hfi1_ùxtd©a
 *
rcd
)

1666  
rcd
->
do_š‹¼u±
 =ðrcd->
¦ow_hªdËr
;

1667 
	}
}

1673 
šlše
 
boÞ
 
	$hfi1_is_ç¡·th
(
hfi1_ùxtd©a
 *
rcd
)

1675 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
)

1676  
çl£
;

1678  
rcd
->
do_š‹¼u±
 =ðrcd->
ç¡_hªdËr
;

1679 
	}
}

1685 
šlše
 
	$hfi1_£t_ç¡
(
hfi1_ùxtd©a
 *
rcd
)

1687 ià(
	`uÆik–y
(!
rcd
))

1689 ià(
	`uÆik–y
(!
	`hfi1_is_ç¡·th
(
rcd
)))

1690 
rcd
->
do_š‹¼u±
 =„cd->
ç¡_hªdËr
;

1691 
	}
}

1693 
hfi1_»£t_deviû
();

1695 
»ûive_š‹¼u±_wÜk
(
wÜk_¡ruù
 *
wÜk
);

1698 
šlše
 
	$hfi1_9B_g‘_sc5
(
ib_h—d”
 *
hdr
, 
u64
 
rhf
)

1700  
	`ib_g‘_sc
(
hdr
è| ((!!(
	`rhf_dc_šfo
(
rhf
))) << 4);

1701 
	}
}

1703 
	#HFI1_JKEY_WIDTH
 16

	)

1704 
	#HFI1_JKEY_MASK
 (
	`BIT
(16è- 1)

	)

1705 
	#HFI1_ADMIN_JKEY_RANGE
 32

	)

1713 
šlše
 
u16
 
	$g’”©e_jkey
(
kuid_t
 
uid
)

1715 
u16
 
jkey
 = 
	`äom_kuid
(
	`cu¼’t_u£r_ns
(), 
uid
è& 
HFI1_JKEY_MASK
;

1717 ià(
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1718 
jkey
 &ð
HFI1_ADMIN_JKEY_RANGE
 - 1;

1719 ià(
jkey
 < 64)

1720 
jkey
 |ð
	`BIT
(
HFI1_JKEY_WIDTH
 - 1);

1722  
jkey
;

1723 
	}
}

1730 
šlše
 
u32
 
	$aùive_eg»ss_¿‹
(
hfi1_µÜtd©a
 *
µd
)

1732 
u16
 
lšk_¥“d
 = 
µd
->
lšk_¥“d_aùive
;

1733 
u16
 
lšk_width
 = 
µd
->
lšk_width_aùive
;

1734 
u32
 
eg»ss_¿‹
;

1736 ià(
lšk_¥“d
 =ð
OPA_LINK_SPEED_25G
)

1737 
eg»ss_¿‹
 = 25000;

1739 
eg»ss_¿‹
 = 12500;

1741 
lšk_width
) {

1742 
OPA_LINK_WIDTH_4X
:

1743 
eg»ss_¿‹
 *= 4;

1745 
OPA_LINK_WIDTH_3X
:

1746 
eg»ss_¿‹
 *= 3;

1748 
OPA_LINK_WIDTH_2X
:

1749 
eg»ss_¿‹
 *= 2;

1756  
eg»ss_¿‹
;

1757 
	}
}

1767 
šlše
 
u32
 
	$eg»ss_cyþes
(
u32
 
Ën
, u32 
¿‹
)

1769 
u32
 
cyþes
;

1779 
cyþes
 = 
Ën
 * 8;

1780 
cyþes
 *= 805;

1781 
cyþes
 /ð
¿‹
;

1783  
cyþes
;

1784 
	}
}

1786 
£t_lšk_g
(
hfi1_µÜtd©a
 *
µd
);

1787 
´oûss_beú
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
¦
, 
u32
 
¾id
, u32 
lq²
,

1788 
u32
 
rq²
, 
u8
 
svc_ty³
);

1789 
»tuº_úp
(
hfi1_ibpÜt
 *
ibp
, 
rvt_qp
 *
qp
, 
u32
 
»mÙe_q²
,

1790 
u16
 
pkey
, 
u32
 
¦id
, u32 
dlid
, 
u8
 
sc5
,

1791 cÚ¡ 
ib_grh
 *
Þd_grh
);

1792 
»tuº_úp_16B
(
hfi1_ibpÜt
 *
ibp
, 
rvt_qp
 *
qp
,

1793 
u32
 
»mÙe_q²
, 
u16
 
pkey
, u32 
¦id
, u32 
dlid
,

1794 
u8
 
sc5
, cÚ¡ 
ib_grh
 *
Þd_grh
);

1795 (*
	thfi1_hªdË_úp
)(
	thfi1_ibpÜt
 *
	tibp
, 
	trvt_qp
 *
	tqp
,

1796 
	tu32
 
	t»mÙe_q²
, 
	tu16
 
	tpkey
, u32 
	t¦id
, u32 
	tdlid
,

1797 
	tu8
 
	tsc5
, cÚ¡ 
	tib_grh
 *
	tÞd_grh
);

1799 
	#PKEY_CHECK_INVALID
 -1

	)

1800 
	`eg»ss_pkey_check
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¦id
, 
u16
 
pkey
,

1801 
u8
 
sc5
, 
št8_t
 
s_pkey_šdex
);

1803 
	#PACKET_EGRESS_TIMEOUT
 350

	)

1804 
šlše
 
	$·u£_fÜ_üed™_»tuº
(
hfi1_devd©a
 *
dd
)

1807 
u32
 
u£c
 = 
	`cþock_to_ns
(
dd
, 
PACKET_EGRESS_TIMEOUT
) / 1000;

1809 
	`ud–ay
(
u£c
 ? usec : 1);

1810 
	}
}

1817 
šlše
 
u8
 
	$sc_to_vÉ
(
hfi1_devd©a
 *
dd
, 
u8
 
sc5
)

1819 
£q
;

1820 
u8
 
rv®
;

1822 ià(
sc5
 >ð
OPA_MAX_SCS
)

1823  (
u8
)(0xff);

1826 
£q
 = 
	`»ad_£qbegš
(&
dd
->
sc2vl_lock
);

1827 
rv®
 = *(((
u8
 *)
dd
->
sc2vl
è+ 
sc5
);

1828 } 
	`»ad_£q»Œy
(&
dd
->
sc2vl_lock
, 
£q
));

1830  
rv®
;

1831 
	}
}

1833 
	#PKEY_MEMBER_MASK
 0x8000

	)

1834 
	#PKEY_LOW_15_MASK
 0x7fff

	)

1842 
šlše
 
	$šg»ss_pkey_m©ches_’Œy
(
u16
 
pkey
, u16 
’t
)

1844 
u16
 
mkey
 = 
pkey
 & 
PKEY_LOW_15_MASK
;

1845 
u16
 
m’t
 = 
’t
 & 
PKEY_LOW_15_MASK
;

1847 ià(
mkey
 =ð
m’t
) {

1853 ià(!(
pkey
 & 
PKEY_MEMBER_MASK
))

1854  !!(
’t
 & 
PKEY_MEMBER_MASK
);

1858 
	}
}

1865 
	$šg»ss_pkey_bË_£¬ch
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
pkey
)

1867 
i
;

1869 
i
 = 0; i < 
MAX_PKEY_VALUES
; i++) {

1870 ià(
	`šg»ss_pkey_m©ches_’Œy
(
pkey
, 
µd
->
pkeys
[
i
]))

1874 
	}
}

1881 
	$šg»ss_pkey_bË_çž
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
pkey
,

1882 
u32
 
¦id
)

1884 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1886 
	`šü_úŒ64
(&
µd
->
pÜt_rcv_cÚ¡¿št_”rÜs
);

1887 ià(!(
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¡©us
 & 
OPA_EI_STATUS_SMASK
)) {

1888 
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¡©us
 |ð
OPA_EI_STATUS_SMASK
;

1889 
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¦id
 = slid;

1890 
dd
->
”r_šfo_rcv_cÚ¡¿št
.
pkey
 =…key;

1892 
	}
}

1902 
šlše
 
	$šg»ss_pkey_check
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
pkey
,

1903 
u8
 
sc5
, u8 
idx
, 
u32
 
¦id
, 
boÞ
 
fÜû
)

1905 ià(!(
fÜû
è&& !(
µd
->
·¹_’fÜû
 & 
HFI1_PART_ENFORCE_IN
))

1909 ià((
sc5
 =ð0xfè&& ((
pkey
 & 
PKEY_LOW_15_MASK
) != PKEY_LOW_15_MASK))

1910 
bad
;

1913 ià((
pkey
 & 
PKEY_LOW_15_MASK
) == 0)

1914 
bad
;

1917 ià(
	`šg»ss_pkey_m©ches_’Œy
(
pkey
, 
µd
->
pkeys
[
idx
]))

1921 ià(!
	`šg»ss_pkey_bË_£¬ch
(
µd
, 
pkey
))

1924 
bad
:

1925 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
¦id
);

1927 
	}
}

1935 
šlše
 
	$rcv_pkey_check
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
pkey
,

1936 
u8
 
sc5
, 
u16
 
¦id
)

1938 ià(!(
µd
->
·¹_’fÜû
 & 
HFI1_PART_ENFORCE_IN
))

1942 ià((
sc5
 =ð0xfè&& ((
pkey
 & 
PKEY_LOW_15_MASK
) != PKEY_LOW_15_MASK))

1943 
bad
;

1946 
bad
:

1947 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
¦id
);

1949 
	}
}

1954 
	#OPA_MTU_0
 0

	)

1955 
	#OPA_MTU_256
 1

	)

1956 
	#OPA_MTU_512
 2

	)

1957 
	#OPA_MTU_1024
 3

	)

1958 
	#OPA_MTU_2048
 4

	)

1959 
	#OPA_MTU_4096
 5

	)

1961 
u32
 
Ìh_max_h—d”_by‹s
(
hfi1_devd©a
 *
dd
);

1962 
mtu_to_’um
(
u32
 
mtu
, 
deçuÉ_if_bad
);

1963 
u16
 
’um_to_mtu
(
mtu
);

1964 
šlše
 
	$v®id_ib_mtu
(
mtu
)

1966  
mtu
 == 256 || mtu == 512 ||

1967 
mtu
 == 1024 || mtu == 2048 ||

1968 
mtu
 == 4096;

1969 
	}
}

1971 
šlše
 
	$v®id_Ýa_max_mtu
(
mtu
)

1973  
mtu
 >= 2048 &&

1974 (
	`v®id_ib_mtu
(
mtu
) || mtu == 8192 || mtu == 10240);

1975 
	}
}

1977 
£t_mtu
(
hfi1_µÜtd©a
 *
µd
);

1979 
hfi1_£t_lid
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
lid
, 
u8
 
lmc
);

1980 
hfi1_di§bË_aá”_”rÜ
(
hfi1_devd©a
 *
dd
);

1981 
hfi1_£t_uev’t_b™s
(
hfi1_µÜtd©a
 *
µd
, cÚ¡ 
evtb™
);

1982 
hfi1_rcvbuf_v®id©e
(
u32
 
size
, 
u8
 
ty³
, 
u16
 *
’code
);

1984 
fm_g‘_bË
(
hfi1_µÜtd©a
 *
µd
, 
which
, *
t
);

1985 
fm_£t_bË
(
hfi1_µÜtd©a
 *
µd
, 
which
, *
t
);

1987 
£t_up_vau
(
hfi1_devd©a
 *
dd
, 
u8
 
vau
);

1988 
£t_up_vl15
(
hfi1_devd©a
 *
dd
, 
u16
 
vl15buf
);

1989 
»£t_lšk_üed™s
(
hfi1_devd©a
 *
dd
);

1990 
assign_»mÙe_cm_au_bË
(
hfi1_devd©a
 *
dd
, 
u8
 
vcu
);

1992 
hfi1_¢oÝ_š™
(
hfi1_devd©a
 *
dd
);

1993 
¢oÝ_»cv_hªdËr
(
hfi1_·ck‘
 *
·ck‘
);

1994 
¢oÝ_£nd_dma_hªdËr
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

1995 
u64
 
pbc
);

1996 
¢oÝ_£nd_pio_hªdËr
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

1997 
u64
 
pbc
);

1998 
¢oÝ_šlše_pio_£nd
(
hfi1_devd©a
 *
dd
, 
pio_buf
 *
pbuf
,

1999 
u64
 
pbc
, cÚ¡ *
äom
, 
size_t
 
couÁ
);

2001 
£t_bufãr_cÚŒÞ
(
hfi1_µÜtd©a
 *
µd
, 
bufãr_cÚŒÞ
 *
bc
);

2003 
šlše
 
hfi1_devd©a
 *
	$dd_äom_µd
(
hfi1_µÜtd©a
 *
µd
)

2005  
µd
->
dd
;

2006 
	}
}

2008 
šlše
 
hfi1_devd©a
 *
	$dd_äom_dev
(
hfi1_ibdev
 *
dev
)

2010  
	`cÚš”_of
(
dev
, 
hfi1_devd©a
, 
v”bs_dev
);

2011 
	}
}

2013 
šlše
 
hfi1_devd©a
 *
	$dd_äom_ibdev
(
ib_deviû
 *
ibdev
)

2015  
	`dd_äom_dev
(
	`to_idev
(
ibdev
));

2016 
	}
}

2018 
šlše
 
hfi1_µÜtd©a
 *
	$µd_äom_ibp
(
hfi1_ibpÜt
 *
ibp
)

2020  
	`cÚš”_of
(
ibp
, 
hfi1_µÜtd©a
, 
ibpÜt_d©a
);

2021 
	}
}

2023 
šlše
 
hfi1_ibdev
 *
	$dev_äom_rdi
(
rvt_dev_šfo
 *
rdi
)

2025  
	`cÚš”_of
(
rdi
, 
hfi1_ibdev
,„di);

2026 
	}
}

2028 
šlše
 
hfi1_ibpÜt
 *
	$to_Üt
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt
)

2030 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2031 
pidx
 = 
pÜt
 - 1;

2033 
	`WARN_ON
(
pidx
 >ð
dd
->
num_µÜts
);

2034  &
dd
->
µÜt
[
pidx
].
ibpÜt_d©a
;

2035 
	}
}

2037 
šlše
 
hfi1_ibpÜt
 *
	$rcd_to_Üt
(
hfi1_ùxtd©a
 *
rcd
)

2039  &
rcd
->
µd
->
ibpÜt_d©a
;

2040 
	}
}

2053 
šlše
 
boÞ
 
	$hfi1_may_eú
(
hfi1_·ck‘
 *
pkt
)

2055 
boÞ
 
ãú
, 
beú
;

2057 ià(
pkt
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

2058 
ãú
 = 
	`hfi1_16B_g‘_ãú
(
pkt
->
hdr
);

2059 
beú
 = 
	`hfi1_16B_g‘_beú
(
pkt
->
hdr
);

2061 
ãú
 = 
	`ib_bth_g‘_ãú
(
pkt
->
ohdr
);

2062 
beú
 = 
	`ib_bth_g‘_beú
(
pkt
->
ohdr
);

2064  
ãú
 || 
beú
;

2065 
	}
}

2067 
boÞ
 
hfi1_´oûss_eú_¦ow·th
(
rvt_qp
 *
qp
, 
hfi1_·ck‘
 *
pkt
,

2068 
boÞ
 
´esÿn
);

2069 
šlše
 
boÞ
 
	$´oûss_eú
(
rvt_qp
 *
qp
, 
hfi1_·ck‘
 *
pkt
)

2071 
boÞ
 
do_wÜk
;

2073 
do_wÜk
 = 
	`hfi1_may_eú
(
pkt
);

2074 ià(
	`uÆik–y
(
do_wÜk
))

2075  
	`hfi1_´oûss_eú_¦ow·th
(
qp
, 
pkt
, 
çl£
);

2076  
çl£
;

2077 
	}
}

2082 
šlše
 
u16
 
	$hfi1_g‘_pkey
(
hfi1_ibpÜt
 *
ibp
, 
šdex
)

2084 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2085 
u16
 
»t
;

2087 ià(
šdex
 >ð
	`ARRAY_SIZE
(
µd
->
pkeys
))

2088 
»t
 = 0;

2090 
»t
 = 
µd
->
pkeys
[
šdex
];

2092  
»t
;

2093 
	}
}

2098 
šlše
 
__be64
 
	$g‘_sguid
(
hfi1_ibpÜt
 *
ibp
, 
šdex
)

2100 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2102 
	`WARN_ON
(
šdex
 >ð
HFI1_GUIDS_PER_PORT
);

2103  
	`ýu_to_be64
(
µd
->
guids
[
šdex
]);

2104 
	}
}

2109 
šlše
 
cc_¡©e
 *
	$g‘_cc_¡©e
(
hfi1_µÜtd©a
 *
µd
)

2111  
	`rcu_d”eã»nû
(
µd
->
cc_¡©e
);

2112 
	}
}

2117 
šlše


2118 
cc_¡©e
 *
	$g‘_cc_¡©e_´Ùeùed
(
hfi1_µÜtd©a
 *
µd
)

2120  
	`rcu_d”eã»nû_´Ùeùed
(
µd
->
cc_¡©e
,

2121 
	`lockd•_is_h–d
(&
µd
->
cc_¡©e_lock
));

2122 
	}
}

2127 
	#HFI1_INITTED
 0x1

	)

2128 
	#HFI1_PRESENT
 0x2

	)

2129 
	#HFI1_FROZEN
 0x4

	)

2130 
	#HFI1_HAS_SDMA_TIMEOUT
 0x8

	)

2131 
	#HFI1_HAS_SEND_DMA
 0x10

	)

2132 
	#HFI1_FORCED_FREEZE
 0x80

	)

2133 
	#HFI1_SHUTDOWN
 0x100

	)

2136 
	#HFI1_PBC_LENGTH_MASK
 ((1 << 11è- 1)

	)

2140 
	#HFI1_CTXT_BASE_UNINIT
 1

	)

2142 
	#HFI1_CTXT_BASE_FAILED
 2

	)

2144 
	#HFI1_CTXT_WAITING_RCV
 3

	)

2146 
	#HFI1_CTXT_WAITING_URG
 4

	)

2149 
hfi1_š™_dd
(
hfi1_devd©a
 *
dd
);

2150 
hfi1_ä“_devd©a
(
hfi1_devd©a
 *
dd
);

2153 
hfi1_¡¬t_Ëd_ov”ride
(
hfi1_µÜtd©a
 *
µd
, 
timeÚ
,

2154 
timeoff
);

2155 
shutdown_Ëd_ov”ride
(
hfi1_µÜtd©a
 *
µd
);

2157 
	#HFI1_CREDIT_RETURN_RATE
 (100)

	)

2178 
	#DEFAULT_RCVHDRSIZE
 9

	)

2195 
	#DEFAULT_RCVHDR_ENTSIZE
 32

	)

2197 
boÞ
 
hfi1_ÿn_pš_·ges
(
hfi1_devd©a
 *
dd
, 
mm_¡ruù
 *
mm
,

2198 
u32
 
Æocked
, u32 
Åages
);

2199 
hfi1_acquœe_u£r_·ges
(
mm_¡ruù
 *
mm
, 
vaddr
,

2200 
size_t
 
Åages
, 
boÞ
 
wr™abË
, 
·ge
 **
·ges
);

2201 
hfi1_»Ëa£_u£r_·ges
(
mm_¡ruù
 *
mm
, 
·ge
 **
p
,

2202 
size_t
 
Åages
, 
boÞ
 
dœty
);

2208 
šlše
 
__Ë64
 *
	$hfi1_rcvhd¹až_kvaddr
(cÚ¡ 
hfi1_ùxtd©a
 *
rcd
)

2210  (
__Ë64
 *)
rcd
->
rcvhd¹až_kvaddr
;

2211 
	}
}

2217 
šlše
 
	$þ—r_rcvhd¹až
(
hfi1_ùxtd©a
 *
rcd
)

2219 
u64
 *
kv
 = (u64 *)
	`hfi1_rcvhd¹až_kvaddr
(
rcd
);

2221 ià(
kv
)

2222 *
kv
 = 0ULL;

2223 
	}
}

2229 
šlše
 
u32
 
	$g‘_rcvhd¹až
(cÚ¡ 
hfi1_ùxtd©a
 *
rcd
)

2235  (
u32
)
	`Ë64_to_ýu
(*
	`hfi1_rcvhd¹až_kvaddr
(
rcd
));

2236 
	}
}

2238 
šlše
 
boÞ
 
	$hfi1_·ck‘_´e£Á
(
hfi1_ùxtd©a
 *
rcd
)

2240 ià(
	`lik–y
(!
rcd
->
rcvhd¹až_kvaddr
)) {

2241 
u32
 
£q
 = 
	`rhf_rcv_£q
(
	`rhf_to_ýu
(
	`g‘_rhf_addr
(
rcd
)));

2243  !
	`Ï¡_rcv_£q
(
rcd
, 
£q
);

2245  
	`hfi1_rcd_h—d
(
rcd
è!ð
	`g‘_rcvhd¹až
(rcd);

2246 
	}
}

2252 cÚ¡ 
ib_hfi1_v”siÚ
[];

2253 cÚ¡ 
©Œibu‹_group
 
ib_hfi1_©Œ_group
;

2255 
hfi1_deviû_ü—‹
(
hfi1_devd©a
 *
dd
);

2256 
hfi1_deviû_»move
(
hfi1_devd©a
 *
dd
);

2258 
hfi1_ü—‹_pÜt_fžes
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt_num
,

2259 
kobjeù
 *
kobj
);

2260 
hfi1_v”bs_»gi¡”_sysfs
(
hfi1_devd©a
 *
dd
);

2261 
hfi1_v”bs_uÄegi¡”_sysfs
(
hfi1_devd©a
 *
dd
);

2263 
qså_dump
(
hfi1_µÜtd©a
 *
µd
, *
buf
, 
Ën
);

2265 
hfi1_pc›_š™
(
hfi1_devd©a
 *
dd
);

2266 
hfi1_pc›_þ—nup
(
pci_dev
 *
pdev
);

2267 
hfi1_pc›_ddš™
(
hfi1_devd©a
 *
dd
, 
pci_dev
 *
pdev
);

2268 
hfi1_pc›_ddþ—nup
(
hfi1_devd©a
 *);

2269 
pc›_¥“ds
(
hfi1_devd©a
 *
dd
);

2270 
»¡Üe_pci_v¬ŸbËs
(
hfi1_devd©a
 *
dd
);

2271 
§ve_pci_v¬ŸbËs
(
hfi1_devd©a
 *
dd
);

2272 
do_pc›_g’3_Œªs™iÚ
(
hfi1_devd©a
 *
dd
);

2273 
tuÃ_pc›_ÿps
(
hfi1_devd©a
 *
dd
);

2274 
·r£_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
);

2275 
g‘_¶©fÜm_cÚfig_f›ld
(
hfi1_devd©a
 *
dd
,

2276 
¶©fÜm_cÚfig_bË_ty³_’codšg


2277 
bË_ty³
, 
bË_šdex
, 
f›ld_šdex
,

2278 
u32
 *
d©a
, u32 
Ën
);

2280 
pci_dev
 *
g‘_pci_dev
(
rvt_dev_šfo
 *
rdi
);

2286 
šlše
 
	$æush_wc
()

2288 
asm
 volatile("sfence" : : : "memory");

2289 
	}
}

2291 
hªdË_eæags
(
hfi1_·ck‘
 *
·ck‘
);

2292 
£qfže_dump_rcd
(
£q_fže
 *
s
, 
hfi1_ùxtd©a
 *
rcd
);

2295 
hfi1_max_mtu
;

2296 
hfi1_cu
;

2297 
u£r_üed™_»tuº_th»shÞd
;

2298 
num_u£r_cÚ‹xts
;

2299 
n_krcvqs
;

2300 
ušt
 
krcvqs
[];

2301 
krcvqs£t
;

2302 
ušt
 
loÝback
;

2303 
ušt
 
quick_lškup
;

2304 
ušt
 
rcv_šŒ_timeout
;

2305 
ušt
 
rcv_šŒ_couÁ
;

2306 
ušt
 
rcv_šŒ_dyÇmic
;

2307 
ušt
 
oib_acûl
;

2308 
ushÜt
 
lšk_üc_mask
;

2310 
mu‹x
 
hfi1_mu‹x
;

2313 
	#STATUS_TIMEOUT
 60

	)

2315 
	#DRIVER_NAME
 "hfi1"

	)

2316 
	#HFI1_USER_MINOR_BASE
 0

	)

2317 
	#HFI1_TRACE_MINOR
 127

	)

2318 
	#HFI1_DIAGPKT_MINOR
 128

	)

2319 
	#HFI1_DIAG_MINOR_BASE
 129

	)

2320 
	#HFI1_SNOOP_CAPTURE_BASE
 200

	)

2321 
	#HFI1_NMINORS
 255

	)

2323 
	#PCI_VENDOR_ID_INTEL
 0x8086

	)

2324 
	#PCI_DEVICE_ID_INTEL0
 0x24f0

	)

2325 
	#PCI_DEVICE_ID_INTEL1
 0x24f1

	)

2327 
	#HFI1_PKT_USER_SC_INTEGRITY
 \

2328 (
SEND_CTXT_CHECK_ENABLE_DISALLOW_NON_KDETH_PACKETS_SMASK
 \

2329 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_KDETH_PACKETS_SMASK
 \

2330 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_BYPASS_SMASK
 \

2331 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_GRH_SMASK
)

	)

2333 
	#HFI1_PKT_KERNEL_SC_INTEGRITY
 \

2334 (
SEND_CTXT_CHECK_ENABLE_DISALLOW_KDETH_PACKETS_SMASK
)

	)

2336 
šlše
 
u64
 
	$hfi1_pkt_deçuÉ_£nd_ùxt_mask
(
hfi1_devd©a
 *
dd
,

2337 
u16
 
ùxt_ty³
)

2339 
u64
 
ba£_sc_š‹gr™y
;

2345 ià(
	`HFI1_CAP_IS_KSET
(
NO_INTEGRITY
) ||

2346 (
dd
->
hfi1_¢oÝ
.
mode_æag
 & 
HFI1_PORT_SNOOP_MODE
))

2349 
ba£_sc_š‹gr™y
 =

2350 
SEND_CTXT_CHECK_ENABLE_DISALLOW_BYPASS_BAD_PKT_LEN_SMASK


2351 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK


2352 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_LONG_BYPASS_PACKETS_SMASK


2353 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_LONG_IB_PACKETS_SMASK


2354 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_BAD_PKT_LEN_SMASK


2355 #iâdeà
CONFIG_FAULT_INJECTION


2356 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_TEST_SMASK


2358 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_SMALL_BYPASS_PACKETS_SMASK


2359 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_TOO_SMALL_IB_PACKETS_SMASK


2360 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_RAW_IPV6_SMASK


2361 | 
SEND_CTXT_CHECK_ENABLE_DISALLOW_RAW_SMASK


2362 | 
SEND_CTXT_CHECK_ENABLE_CHECK_BYPASS_VL_MAPPING_SMASK


2363 | 
SEND_CTXT_CHECK_ENABLE_CHECK_VL_MAPPING_SMASK


2364 | 
SEND_CTXT_CHECK_ENABLE_CHECK_OPCODE_SMASK


2365 | 
SEND_CTXT_CHECK_ENABLE_CHECK_SLID_SMASK


2366 | 
SEND_CTXT_CHECK_ENABLE_CHECK_VL_SMASK


2367 | 
SEND_CTXT_CHECK_ENABLE_CHECK_ENABLE_SMASK
;

2369 ià(
ùxt_ty³
 =ð
SC_USER
)

2370 
ba£_sc_š‹gr™y
 |=

2371 #iâdeà
CONFIG_FAULT_INJECTION


2372 
SEND_CTXT_CHECK_ENABLE_DISALLOW_PBC_TEST_SMASK
 |

2374 
HFI1_PKT_USER_SC_INTEGRITY
;

2375 ià(
ùxt_ty³
 !ð
SC_KERNEL
)

2376 
ba£_sc_š‹gr™y
 |ð
HFI1_PKT_KERNEL_SC_INTEGRITY
;

2379 ià(!
	`is_ax
(
dd
))

2380 
ba£_sc_š‹gr™y
 |ð
SEND_CTXT_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
;

2382  
ba£_sc_š‹gr™y
;

2383 
	}
}

2385 
šlše
 
u64
 
	$hfi1_pkt_ba£_sdma_š‹gr™y
(
hfi1_devd©a
 *
dd
)

2387 
u64
 
ba£_sdma_š‹gr™y
;

2390 ià(
	`HFI1_CAP_IS_KSET
(
NO_INTEGRITY
))

2393 
ba£_sdma_š‹gr™y
 =

2394 
SEND_DMA_CHECK_ENABLE_DISALLOW_BYPASS_BAD_PKT_LEN_SMASK


2395 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_LONG_BYPASS_PACKETS_SMASK


2396 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_LONG_IB_PACKETS_SMASK


2397 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_BAD_PKT_LEN_SMASK


2398 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_SMALL_BYPASS_PACKETS_SMASK


2399 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_TOO_SMALL_IB_PACKETS_SMASK


2400 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_RAW_IPV6_SMASK


2401 | 
SEND_DMA_CHECK_ENABLE_DISALLOW_RAW_SMASK


2402 | 
SEND_DMA_CHECK_ENABLE_CHECK_BYPASS_VL_MAPPING_SMASK


2403 | 
SEND_DMA_CHECK_ENABLE_CHECK_VL_MAPPING_SMASK


2404 | 
SEND_DMA_CHECK_ENABLE_CHECK_OPCODE_SMASK


2405 | 
SEND_DMA_CHECK_ENABLE_CHECK_SLID_SMASK


2406 | 
SEND_DMA_CHECK_ENABLE_CHECK_VL_SMASK


2407 | 
SEND_DMA_CHECK_ENABLE_CHECK_ENABLE_SMASK
;

2409 ià(!
	`HFI1_CAP_IS_KSET
(
STATIC_RATE_CTRL
))

2410 
ba£_sdma_š‹gr™y
 |=

2411 
SEND_DMA_CHECK_ENABLE_DISALLOW_PBC_STATIC_RATE_CONTROL_SMASK
;

2414 ià(!
	`is_ax
(
dd
))

2415 
ba£_sdma_š‹gr™y
 |=

2416 
SEND_DMA_CHECK_ENABLE_CHECK_JOB_KEY_SMASK
;

2418  
ba£_sdma_š‹gr™y
;

2419 
	}
}

2421 
	#dd_dev_em”g
(
dd
, 
fmt
, ...) \

2422 
	`dev_em”g
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2423 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), ##
__VA_ARGS__
)

	)

2425 
	#dd_dev_”r
(
dd
, 
fmt
, ...) \

2426 
	`dev_”r
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2427 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), ##
__VA_ARGS__
)

	)

2429 
	#dd_dev_”r_¿‹lim™ed
(
dd
, 
fmt
, ...) \

2430 
	`dev_”r_¿‹lim™ed
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2431 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), \

2432 ##
__VA_ARGS__
)

	)

2434 
	#dd_dev_w¬n
(
dd
, 
fmt
, ...) \

2435 
	`dev_w¬n
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2436 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), ##
__VA_ARGS__
)

	)

2438 
	#dd_dev_w¬n_¿‹lim™ed
(
dd
, 
fmt
, ...) \

2439 
	`dev_w¬n_¿‹lim™ed
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2440 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), \

2441 ##
__VA_ARGS__
)

	)

2443 
	#dd_dev_šfo
(
dd
, 
fmt
, ...) \

2444 
	`dev_šfo
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2445 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), ##
__VA_ARGS__
)

	)

2447 
	#dd_dev_šfo_¿‹lim™ed
(
dd
, 
fmt
, ...) \

2448 
	`dev_šfo_¿‹lim™ed
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2449 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), \

2450 ##
__VA_ARGS__
)

	)

2452 
	#dd_dev_dbg
(
dd
, 
fmt
, ...) \

2453 
	`dev_dbg
(&(
dd
)->
pcidev
->
dev
, "%s: " 
fmt
, \

2454 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), ##
__VA_ARGS__
)

	)

2456 
	#hfi1_dev_pÜ‹¼
(
dd
, 
pÜt
, 
fmt
, ...) \

2457 
	`dev_”r
(&(
dd
)->
pcidev
->
dev
, "%s:…Üˆ%u: " 
fmt
, \

2458 
	`rvt_g‘_ibdev_Çme
(&(
dd
)->
v”bs_dev
.
rdi
), (
pÜt
), ##
__VA_ARGS__
)

	)

2463 
	shfi1_hw”rÜ_msgs
 {

2464 
u64
 
	mmask
;

2465 cÚ¡ *
	mmsg
;

2466 
size_t
 
	msz
;

2470 
hfi1_fÜm©_hw”rÜs
(
u64
 
hw”rs
,

2471 cÚ¡ 
hfi1_hw”rÜ_msgs
 *
hw”rmsgs
,

2472 
size_t
 
nhw”rmsgs
, *
msg
, size_ˆ
lmsg
);

2474 
	#USER_OPCODE_CHECK_VAL
 0xC0

	)

2475 
	#USER_OPCODE_CHECK_MASK
 0xC0

	)

2476 
	#OPCODE_CHECK_VAL_DISABLED
 0x0

	)

2477 
	#OPCODE_CHECK_MASK_DISABLED
 0x0

	)

2479 
šlše
 
	$hfi1_»£t_ýu_couÁ”s
(
hfi1_devd©a
 *
dd
)

2481 
hfi1_µÜtd©a
 *
µd
;

2482 
i
;

2484 
dd
->
z_št_couÁ”
 = 
	`g‘_®l_ýu_tÙ®
(dd->
št_couÁ”
);

2485 
dd
->
z_rcv_lim™
 = 
	`g‘_®l_ýu_tÙ®
(dd->
rcv_lim™
);

2486 
dd
->
z_£nd_scheduË
 = 
	`g‘_®l_ýu_tÙ®
(dd->
£nd_scheduË
);

2488 
µd
 = (
hfi1_µÜtd©a
 *)(
dd
 + 1);

2489 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++) {

2490 
µd
->
ibpÜt_d©a
.
rvp
.
z_rc_acks
 =

2491 
	`g‘_®l_ýu_tÙ®
(
µd
->
ibpÜt_d©a
.
rvp
.
rc_acks
);

2492 
µd
->
ibpÜt_d©a
.
rvp
.
z_rc_qacks
 =

2493 
	`g‘_®l_ýu_tÙ®
(
µd
->
ibpÜt_d©a
.
rvp
.
rc_qacks
);

2495 
	}
}

2498 
šlše
 
	$£‹xŽed
(
hfi1_devd©a
 *
dd
, 
u32
 
Ú
)

2500 ià(
Ú
)

2501 
	`wr™e_c¤
(
dd
, 
DCC_CFG_LED_CNTRL
, 0x1F);

2503 
	`wr™e_c¤
(
dd
, 
DCC_CFG_LED_CNTRL
, 0x10);

2504 
	}
}

2507 
šlše
 
u32
 
	$i2c_rg‘
(
u32
 
rg‘
)

2509  
rg‘
 ? 
CR_I2C2
 : 
CR_I2C1
;

2510 
	}
}

2513 
šlše
 
u32
 
	$qså_»sourû
(
hfi1_devd©a
 *
dd
)

2515  
	`i2c_rg‘
(
dd
->
hfi1_id
);

2516 
	}
}

2519 
šlše
 
boÞ
 
	$is_š‹g¿‹d
(
hfi1_devd©a
 *
dd
)

2521  
dd
->
pcidev
->
deviû
 =ð
PCI_DEVICE_ID_INTEL1
;

2522 
	}
}

2532 
šlše
 
boÞ
 
	$hfi1_Ãed_drÝ
(
hfi1_devd©a
 *
dd
)

2534 ià(
	`uÆik–y
(
dd
->
do_drÝ
 &&

2535 
	`©omic_xchg
(&
dd
->
drÝ_·ck‘
, 
DROP_PACKET_OFF
è=ð
DROP_PACKET_ON
)) {

2536 
dd
->
do_drÝ
 = 
çl£
;

2537  
Œue
;

2539  
çl£
;

2540 
	}
}

2542 
hfi1_‹mp£n£_rd
(
hfi1_devd©a
 *
dd
, 
hfi1_‹mp
 *
‹mp
);

2544 
	#DD_DEV_ENTRY
(
dd
è
	`__¡ršg
(
dev
, 
	`dev_Çme
(&(dd)->
pcidev
->dev))

	)

2545 
	#DD_DEV_ASSIGN
(
dd
è
	`__assign_¡r
(
dev
, 
	`dev_Çme
(&(dd)->
pcidev
->dev))

	)

2547 
šlše
 
	$hfi1_upd©e_ah_©Œ
(
ib_deviû
 *
ibdev
,

2548 
rdma_ah_©Œ
 *
©Œ
)

2550 
hfi1_µÜtd©a
 *
µd
;

2551 
hfi1_ibpÜt
 *
ibp
;

2552 
u32
 
dlid
 = 
	`rdma_ah_g‘_dlid
(
©Œ
);

2558 
ibp
 = 
	`to_Üt
(
ibdev
, 
	`rdma_ah_g‘_pÜt_num
(
©Œ
));

2559 
µd
 = 
	`µd_äom_ibp
(
ibp
);

2560 ià((((
dlid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) ||

2561 (
µd
->
lid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
))) &&

2562 (
dlid
 !ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
)) &&

2563 (
dlid
 !ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
)) &&

2564 (!(
	`rdma_ah_g‘_ah_æags
(
©Œ
è& 
IB_AH_GRH
))) ||

2565 (
	`rdma_ah_g‘_make_grd
(
©Œ
))) {

2566 
	`rdma_ah_£t_ah_æags
(
©Œ
, 
IB_AH_GRH
);

2567 
	`rdma_ah_£t_š‹rçû_id
(
©Œ
, 
	`OPA_MAKE_ID
(
dlid
));

2568 
	`rdma_ah_£t_subÃt_´efix
(
©Œ
, 
ibp
->
rvp
.
gid_´efix
);

2570 
	}
}

2580 
šlše
 
boÞ
 
	$hfi1_check_mÿ¡
(
u32
 
lid
)

2582  ((
lid
 >ð
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
)) &&

2583 (
lid
 !ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
)));

2584 
	}
}

2586 
	#Ýa_g‘_lid
(
lid
, 
fÜm©
) \

2587 
	`__Ýa_g‘_lid
(
lid
, 
OPA_PORT_PACKET_FORMAT_
##
fÜm©
)

	)

2590 
šlše
 
u32
 
	$__Ýa_g‘_lid
(
u32
 
lid
, 
u8
 
fÜm©
)

2592 
boÞ
 
is_mÿ¡
 = 
	`hfi1_check_mÿ¡
(
lid
);

2594 
fÜm©
) {

2595 
OPA_PORT_PACKET_FORMAT_8B
:

2596 
OPA_PORT_PACKET_FORMAT_10B
:

2597 ià(
is_mÿ¡
)

2598  (
lid
 - 
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
) +

2600  
lid
 & 0xFFFFF;

2601 
OPA_PORT_PACKET_FORMAT_16B
:

2602 ià(
is_mÿ¡
)

2603  (
lid
 - 
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
) +

2605  
lid
 & 0xFFFFFF;

2606 
OPA_PORT_PACKET_FORMAT_9B
:

2607 ià(
is_mÿ¡
)

2608  (
lid
 -

2609 
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
) +

2610 
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
));

2612  
lid
 & 0xFFFF;

2614  
lid
;

2616 
	}
}

2619 
šlše
 
boÞ
 
	$hfi1_is_16B_mÿ¡
(
u32
 
lid
)

2621  ((
lid
 >=

2622 
	`Ýa_g‘_lid
(
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
), 16B)) &&

2623 (
lid
 !ð
	`Ýa_g‘_lid
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
), 16B)));

2624 
	}
}

2626 
šlše
 
	$hfi1_make_Ýa_lid
(
rdma_ah_©Œ
 *
©Œ
)

2628 #iâdeà
IFS_SLES12SP3


2629 cÚ¡ 
ib_glob®_rou‹
 *
grh
 = 
	`rdma_ah_»ad_grh
(
©Œ
);

2630 
u32
 
dlid
 = 
	`rdma_ah_g‘_dlid
(
©Œ
);

2640 ià(
	`ib_is_Ýa_gid
(&
grh
->
dgid
))

2641 
dlid
 = 
	`Ýa_g‘_lid_äom_gid
(&
grh
->
dgid
);

2642 ià((
dlid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) &&

2643 (
dlid
 !ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
)) &&

2644 (
dlid
 !ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
)))

2645 
dlid
 = dlid - 
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
) +

2646 
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
);

2647 ià(
dlid
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
))

2648 
dlid
 = 
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
);

2650 
	`rdma_ah_£t_dlid
(
©Œ
, 
dlid
);

2652 
	}
}

2654 
šlše
 
u8
 
	$hfi1_g‘_·ck‘_ty³
(
u32
 
lid
)

2657 ià(
lid
 >ð
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
))

2658  
HFI1_PKT_TYPE_9B
;

2661 ià(
lid
 >ð
	`Ýa_g‘_lid
(
	`Ýa_g‘_mÿ¡_ba£
(
OPA_MCAST_NR
), 9B))

2662  
HFI1_PKT_TYPE_16B
;

2664  
HFI1_PKT_TYPE_9B
;

2665 
	}
}

2667 
šlše
 
boÞ
 
	$hfi1_g‘_hdr_ty³
(
u32
 
lid
, 
rdma_ah_©Œ
 *
©Œ
)

2676 ià(
	`rdma_ah_g‘_dlid
(
©Œ
è=ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
))

2677  (
	`ib_is_Ýa_gid
(&
	`rdma_ah_»ad_grh
(
©Œ
)->
dgid
)) ?

2678 
HFI1_PKT_TYPE_16B
 : 
HFI1_PKT_TYPE_9B
;

2684 ià(
	`hfi1_g‘_·ck‘_ty³
(
	`rdma_ah_g‘_dlid
(
©Œ
)è=ð
HFI1_PKT_TYPE_16B
)

2685  
HFI1_PKT_TYPE_16B
;

2687  
	`hfi1_g‘_·ck‘_ty³
(
lid
);

2688 
	}
}

2690 
šlše
 
	$hfi1_make_ext_grh
(
hfi1_·ck‘
 *
·ck‘
,

2691 
ib_grh
 *
grh
, 
u32
 
¦id
,

2692 
u32
 
dlid
)

2694 
hfi1_ibpÜt
 *
ibp
 = &
·ck‘
->
rcd
->
µd
->
ibpÜt_d©a
;

2695 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2697 ià(!
ibp
)

2700 
grh
->
hÝ_lim™
 = 1;

2701 
grh
->
sgid
.
glob®
.
subÃt_´efix
 = 
ibp
->
rvp
.
gid_´efix
;

2702 ià(
¦id
 =ð
	`Ýa_g‘_lid
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
), 16B))

2703 
grh
->
sgid
.
glob®
.
š‹rçû_id
 =

2704 
	`OPA_MAKE_ID
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
));

2706 
grh
->
sgid
.
glob®
.
š‹rçû_id
 = 
	`OPA_MAKE_ID
(
¦id
);

2715 
grh
->
dgid
.
glob®
.
subÃt_´efix
 = 
ibp
->
rvp
.
gid_´efix
;

2716 
grh
->
dgid
.
glob®
.
š‹rçû_id
 =

2717 
	`ýu_to_be64
(
µd
->
guids
[
HFI1_PORT_GUID_INDEX
]);

2718 
	}
}

2720 
šlše
 
	$hfi1_g‘_16b_·ddšg
(
u32
 
hdr_size
, u32 
·ylßd
)

2722  -(
hdr_size
 + 
·ylßd
 + (
SIZE_OF_CRC
 << 2) +

2723 
SIZE_OF_LT
) & 0x7;

2724 
	}
}

2726 
šlše
 
	$hfi1_make_ib_hdr
(
ib_h—d”
 *
hdr
,

2727 
u16
 
Ìh0
, u16 
Ën
,

2728 
u16
 
dlid
, u16 
¦id
)

2730 
hdr
->
Ìh
[0] = 
	`ýu_to_be16
(
Ìh0
);

2731 
hdr
->
Ìh
[1] = 
	`ýu_to_be16
(
dlid
);

2732 
hdr
->
Ìh
[2] = 
	`ýu_to_be16
(
Ën
);

2733 
hdr
->
Ìh
[3] = 
	`ýu_to_be16
(
¦id
);

2734 
	}
}

2736 
šlše
 
	$hfi1_make_16b_hdr
(
hfi1_16b_h—d”
 *
hdr
,

2737 
u32
 
¦id
, u32 
dlid
,

2738 
u16
 
Ën
, u16 
pkey
,

2739 
boÞ
 
beú
, boÞ 
ãú
, 
u8
 
l4
,

2740 
u8
 
sc
)

2742 
u32
 
Ìh0
 = 0;

2743 
u32
 
Ìh1
 = 0x40000000;

2744 
u32
 
Ìh2
 = 0;

2745 
u32
 
Ìh3
 = 0;

2747 
Ìh0
 = (Ìh0 & ~
OPA_16B_BECN_MASK
è| (
beú
 << 
OPA_16B_BECN_SHIFT
);

2748 
Ìh0
 = (Ìh0 & ~
OPA_16B_LEN_MASK
è| (
Ën
 << 
OPA_16B_LEN_SHIFT
);

2749 
Ìh0
 = (Ìh0 & ~
OPA_16B_LID_MASK
è| (
¦id
 & OPA_16B_LID_MASK);

2750 
Ìh1
 = (Ìh1 & ~
OPA_16B_FECN_MASK
è| (
ãú
 << 
OPA_16B_FECN_SHIFT
);

2751 
Ìh1
 = (Ìh1 & ~
OPA_16B_SC_MASK
è| (
sc
 << 
OPA_16B_SC_SHIFT
);

2752 
Ìh1
 = (Ìh1 & ~
OPA_16B_LID_MASK
è| (
dlid
 & OPA_16B_LID_MASK);

2753 
Ìh2
 = (Ìh2 & ~
OPA_16B_SLID_MASK
) |

2754 ((
¦id
 >> 
OPA_16B_SLID_SHIFT
è<< 
OPA_16B_SLID_HIGH_SHIFT
);

2755 
Ìh2
 = (Ìh2 & ~
OPA_16B_DLID_MASK
) |

2756 ((
dlid
 >> 
OPA_16B_DLID_SHIFT
è<< 
OPA_16B_DLID_HIGH_SHIFT
);

2757 
Ìh2
 = (Ìh2 & ~
OPA_16B_PKEY_MASK
è| ((
u32
)
pkey
 << 
OPA_16B_PKEY_SHIFT
);

2758 
Ìh2
 = (Ìh2 & ~
OPA_16B_L4_MASK
è| 
l4
;

2760 
hdr
->
Ìh
[0] = 
Ìh0
;

2761 
hdr
->
Ìh
[1] = 
Ìh1
;

2762 
hdr
->
Ìh
[2] = 
Ìh2
;

2763 
hdr
->
Ìh
[3] = 
Ìh3
;

2764 
	}
}

	@init.c

48 
	~<lšux/pci.h
>

49 
	~<lšux/Ãtdeviû.h
>

50 
	~<lšux/vm®loc.h
>

51 
	~<lšux/d–ay.h
>

52 
	~<lšux/idr.h
>

53 
	~<lšux/moduË.h
>

54 
	~<lšux/´štk.h
>

55 
	~<lšux/h¹im”.h
>

56 
	~<lšux/b™m­.h
>

57 
	~<lšux/numa.h
>

58 
	~<rdma/rdma_vt.h
>

60 
	~"hfi.h
"

61 
	~"deviû.h
"

62 
	~"commÚ.h
"

63 
	~"Œaû.h
"

64 
	~"mad.h
"

65 
	~"sdma.h
"

66 
	~"debugfs.h
"

67 
	~"v”bs.h
"

68 
	~"a¥m.h
"

69 
	~"affš™y.h
"

70 
	~"vnic.h
"

71 
	~"u£r_exp_rcv.h
"

72 #ifdeà
NVIDIA_GPU_DIRECT


73 
	~"gdr_Ýs.h
"

75 
	~"exp_rcv.h
"

76 
	~"Ãtdev.h
"

78 #undeà
´_fmt


79 
	#´_fmt
(
fmt
è
DRIVER_NAME
 ": " 
	)
fmt

81 
	#HFI1_MAX_ACTIVE_WORKQUEUE_ENTRIES
 5

	)

85 
	#HFI1_MIN_USER_CTXT_BUFCNT
 7

	)

87 
	#HFI1_MIN_EAGER_BUFFER_SIZE
 (4 * 1024è

	)

88 
	#HFI1_MAX_EAGER_BUFFER_SIZE
 (256 * 1024è

	)

90 
	#NUM_IB_PORTS
 1

	)

93 
	#hfi1_—¾y_”r
(
dev
, 
fmt
, ...) \

94 
	`dev_”r
(
dev
, 
fmt
, ##
__VA_ARGS__
)

	)

100 
	gnum_u£r_cÚ‹xts
 = -1;

101 
moduË_·¿m_Çmed
(
num_u£r_cÚ‹xts
,‚um_user_contexts, , 0444);

102 
MODULE_PARM_DESC
(

103 
num_u£r_cÚ‹xts
, "Set max‚umber of user contextso use (default: -1 will usehe„eal (non-HT) CPU count)");

105 
ušt
 
	gkrcvqs
[
RXE_NUM_DATA_VL
];

106 
	gkrcvqs£t
;

107 
moduË_·¿m_¬¿y
(
krcvqs
, 
ušt
, &
krcvqs£t
, 
S_IRUGO
);

108 
MODULE_PARM_DESC
(
krcvqs
, "Array ofhe‚umber of‚on-control kernel„eceive queues by VL");

111 
	gn_krcvqs
;

113 
	ghfi1_rcv¬r_¥l™
 = 25;

114 
moduË_·¿m_Çmed
(
rcv¬r_¥l™
, 
hfi1_rcv¬r_¥l™
, 
ušt
, 
S_IRUGO
);

115 
MODULE_PARM_DESC
(
rcv¬r_¥l™
, "Percent of context's RcvArrayƒntries used for Eager buffers");

117 
ušt
 
	g—g”_bufãr_size
 = (8 << 20);

118 
moduË_·¿m
(
—g”_bufãr_size
, 
ušt
, 
S_IRUGO
);

119 
MODULE_PARM_DESC
(
—g”_bufãr_size
, "Size ofheƒager buffers, default: 8MB");

121 
ušt
 
	grcvhdrút
 = 2048;

122 
moduË_·¿m_Çmed
(
rcvhdrút
,„cvhdrút, 
ušt
, 
S_IRUGO
);

123 
MODULE_PARM_DESC
(
rcvhdrút
, "Receive header queue count (default 2048)");

125 
ušt
 
	ghfi1_hdrq_’tsize
 = 32;

126 
moduË_·¿m_Çmed
(
hdrq_’tsize
, 
hfi1_hdrq_’tsize
, 
ušt
, 0444);

127 
MODULE_PARM_DESC
(
hdrq_’tsize
, "Size of header queueƒntries: 2 - 8B, 16 - 64B, 32 - 128B (default)");

129 
	gu£r_üed™_»tuº_th»shÞd
 = 33;

130 
moduË_·¿m
(
u£r_üed™_»tuº_th»shÞd
, 
ušt
, 
S_IRUGO
);

131 
MODULE_PARM_DESC
(
u£r_üed™_»tuº_th»shÞd
, "Credit„eturnhreshold for user send contexts,„eturn when unreturned credits…asseshis many blocks (in…ercent of‡llocated blocks, 0 is off)");

133 
boÞ
 
	gpÜt_»Üd”
;

134 
moduË_·¿m
(
pÜt_»Üd”
, 
boÞ
, 
S_IRUGO
);

135 
MODULE_PARM_DESC
(
pÜt_»Üd”
, "Device…ort„eorder: 1 - order HFIs onhe same ASIC in increasing…ort order, or 0 - orderƒxactly‡she kernelƒnumerates (default)");

137 
idr
 
	ghfi1_un™_bË
;

139 
	shfi1_š™_dev
 {

140 
li¡_h—d
 
	mli¡
;

141 
pci_dev
 *
	mpdev
;

142 cÚ¡ 
pci_deviû_id
 *
	m’t
;

143 
u64
 
	mguid
;

146 
tim”_li¡
 
	gš™_tim”
;

147 
LIST_HEAD
(
š™_li¡
);

148 
DEFINE_MUTEX
(
š™_mu‹x
);

149 
wÜkqueue_¡ruù
 *
	ghfi1_š™_wq
;

150 
hfi1_deã¼ed_š™
(
wÜk_¡ruù
 *
wÜk
);

155 
	$hfi1_ü—‹_kùxt
(
hfi1_devd©a
 *
dd
,

156 
hfi1_µÜtd©a
 *
µd
)

158 
hfi1_ùxtd©a
 *
rcd
;

159 
»t
;

162 
	`BUILD_BUG_ON
(
HFI1_CTRL_CTXT
 != 0);

164 
»t
 = 
	`hfi1_ü—‹_ùxtd©a
(
µd
, 
dd
->
node
, &
rcd
);

165 ià(
»t
 < 0) {

166 
	`dd_dev_”r
(
dd
, "Kernel„eceive context‡llocation failed\n");

167  
»t
;

175 
rcd
->
æags
 = 
	`HFI1_CAP_KGET
(
MULTI_PKT_EGR
) |

176 
	`HFI1_CAP_KGET
(
NODROP_RHQ_FULL
) |

177 
	`HFI1_CAP_KGET
(
NODROP_EGR_FULL
) |

178 
	`HFI1_CAP_KGET
(
DMA_RTAIL
);

181 ià(
rcd
->
ùxt
 =ð
HFI1_CTRL_CTXT
)

182 
rcd
->
æags
 |ð
HFI1_CAP_DMA_RTAIL
;

183 
rcd
->
ç¡_hªdËr
 = 
	`HFI1_CAP_KGET_MASK
Ôcd->
æags
, 
DMA_RTAIL
) ?

184 
hªdË_»ûive_š‹¼u±_dma_¹až
 :

185 
hªdË_»ûive_š‹¼u±_nodma_¹až
;

186 
rcd
->
¦ow_hªdËr
 = 
hªdË_»ûive_š‹¼u±
;

188 
	`hfi1_£t_£q_út
(
rcd
, 1);

190 
rcd
->
sc
 = 
	`sc_®loc
(
dd
, 
SC_ACK
,„cd->
rcvhdrq’tsize
, dd->
node
);

191 ià(!
rcd
->
sc
) {

192 
	`dd_dev_”r
(
dd
, "Kernel send context‡llocation failed\n");

193  -
ENOMEM
;

195 
	`hfi1_š™_ùxt
(
rcd
->
sc
);

198 
	}
}

203 
	$hfi1_ü—‹_kùxts
(
hfi1_devd©a
 *
dd
)

205 
u16
 
i
;

206 
»t
;

208 
dd
->
rcd
 = 
	`kÿÎoc_node
(dd->
num_rcv_cÚ‹xts
, (*dd->rcd),

209 
GFP_KERNEL
, 
dd
->
node
);

210 ià(!
dd
->
rcd
)

211  -
ENOMEM
;

213 
i
 = 0; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; ++i) {

214 
»t
 = 
	`hfi1_ü—‹_kùxt
(
dd
, dd->
µÜt
);

215 ià(
»t
)

216 
baž
;

220 
baž
:

221 
i
 = 0; 
dd
->
rcd
 && i < dd->
fœ¡_dyn_®loc_ùxt
; ++i)

222 
	`hfi1_ä“_ùxt
(
dd
->
rcd
[
i
]);

225 
	`kä“
(
dd
->
rcd
);

226 
dd
->
rcd
 = 
NULL
;

227  
»t
;

228 
	}
}

233 
	$hfi1_rcd_š™
(
hfi1_ùxtd©a
 *
rcd
)

235 
	`k»f_š™
(&
rcd
->
k»f
);

236 
	}
}

243 
	$hfi1_rcd_ä“
(
k»f
 *kref)

245 
æags
;

246 
hfi1_ùxtd©a
 *
rcd
 =

247 
	`cÚš”_of
(
k»f
, 
hfi1_ùxtd©a
, kref);

249 
	`¥š_lock_œq§ve
(&
rcd
->
dd
->
uùxt_lock
, 
æags
);

250 
rcd
->
dd
->rcd[rcd->
ùxt
] = 
NULL
;

251 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
dd
->
uùxt_lock
, 
æags
);

253 
	`hfi1_ä“_ùxtd©a
(
rcd
->
dd
,„cd);

254 
	`kä“
(
rcd
);

255 
	}
}

263 
	$hfi1_rcd_put
(
hfi1_ùxtd©a
 *
rcd
)

265 ià(
rcd
)

266  
	`k»f_put
(&
rcd
->
k»f
, 
hfi1_rcd_ä“
);

269 
	}
}

280 
	$hfi1_rcd_g‘
(
hfi1_ùxtd©a
 *
rcd
)

282  
	`k»f_g‘_uÆess_z”o
(&
rcd
->
k»f
);

283 
	}
}

295 
	$®loÿ‹_rcd_šdex
(
hfi1_devd©a
 *
dd
,

296 
hfi1_ùxtd©a
 *
rcd
, 
u16
 *
šdex
)

298 
æags
;

299 
u16
 
ùxt
;

301 
	`¥š_lock_œq§ve
(&
dd
->
uùxt_lock
, 
æags
);

302 
ùxt
 = 0; ctxˆ< 
dd
->
num_rcv_cÚ‹xts
; ctxt++)

303 ià(!
dd
->
rcd
[
ùxt
])

306 ià(
ùxt
 < 
dd
->
num_rcv_cÚ‹xts
) {

307 
rcd
->
ùxt
 = ctxt;

308 
dd
->
rcd
[
ùxt
] =„cd;

309 
	`hfi1_rcd_š™
(
rcd
);

311 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

313 ià(
ùxt
 >ð
dd
->
num_rcv_cÚ‹xts
)

314  -
EBUSY
;

316 *
šdex
 = 
ùxt
;

319 
	}
}

333 
hfi1_ùxtd©a
 *
	$hfi1_rcd_g‘_by_šdex_§ã
(
hfi1_devd©a
 *
dd
,

334 
u16
 
ùxt
)

336 ià(
ùxt
 < 
dd
->
num_rcv_cÚ‹xts
)

337  
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
ùxt
);

339  
NULL
;

340 
	}
}

354 
hfi1_ùxtd©a
 *
	$hfi1_rcd_g‘_by_šdex
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
)

356 
æags
;

357 
hfi1_ùxtd©a
 *
rcd
 = 
NULL
;

359 
	`¥š_lock_œq§ve
(&
dd
->
uùxt_lock
, 
æags
);

360 ià(
dd
->
rcd
[
ùxt
]) {

361 
rcd
 = 
dd
->rcd[
ùxt
];

362 ià(!
	`hfi1_rcd_g‘
(
rcd
))

363 
rcd
 = 
NULL
;

365 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

367  
rcd
;

368 
	}
}

374 
	$hfi1_ü—‹_ùxtd©a
(
hfi1_µÜtd©a
 *
µd
, 
numa
,

375 
hfi1_ùxtd©a
 **
cÚ‹xt
)

377 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

378 
hfi1_ùxtd©a
 *
rcd
;

379 
kùxt_ngroups
 = 0;

380 
u32
 
ba£
;

382 ià(
dd
->
rcv_’Œ›s
.
nùxt_exŒa
 >

383 
dd
->
num_rcv_cÚ‹xts
 - dd->
fœ¡_dyn_®loc_ùxt
)

384 
kùxt_ngroups
 = (
dd
->
rcv_’Œ›s
.
nùxt_exŒa
 -

385 (
dd
->
num_rcv_cÚ‹xts
 - dd->
fœ¡_dyn_®loc_ùxt
));

386 
rcd
 = 
	`kz®loc_node
((*rcd), 
GFP_KERNEL
, 
numa
);

387 ià(
rcd
) {

388 
u32
 
rcvtids
, 
max_’Œ›s
;

389 
u16
 
ùxt
;

390 
»t
;

392 
»t
 = 
	`®loÿ‹_rcd_šdex
(
dd
, 
rcd
, &
ùxt
);

393 ià(
»t
) {

394 *
cÚ‹xt
 = 
NULL
;

395 
	`kä“
(
rcd
);

396  
»t
;

399 
	`INIT_LIST_HEAD
(&
rcd
->
qp_wa™_li¡
);

400 
	`hfi1_exp_tid_group_š™
(
rcd
);

401 
rcd
->
µd
 =…pd;

402 
rcd
->
dd
 = dd;

403 
rcd
->
numa_id
 = 
numa
;

404 
rcd
->
rcv_¬¿y_groups
 = 
dd
->
rcv_’Œ›s
.
ngroups
;

405 
rcd
->
rhf_rcv_funùiÚ_m­
 = 
nÜm®_rhf_rcv_funùiÚs
;

406 
rcd
->
msix_šŒ
 = 
CCE_NUM_MSIX_VECTORS
;

408 
	`mu‹x_š™
(&
rcd
->
exp_mu‹x
);

409 
	`¥š_lock_š™
(&
rcd
->
exp_lock
);

410 
	`INIT_LIST_HEAD
(&
rcd
->
æow_queue
.
queue_h—d
);

411 
	`INIT_LIST_HEAD
(&
rcd
->
¿¼_queue
.
queue_h—d
);

413 
	`hfi1_cdbg
(
PROC
, "£‰šg u°cÚ‹xˆ%u\n", 
rcd
->
ùxt
);

422 ià(
ùxt
 < 
dd
->
fœ¡_dyn_®loc_ùxt
) {

423 ià(
ùxt
 < 
kùxt_ngroups
) {

424 
ba£
 = 
ùxt
 * (
dd
->
rcv_’Œ›s
.
ngroups
 + 1);

425 
rcd
->
rcv_¬¿y_groups
++;

427 
ba£
 = 
kùxt_ngroups
 +

428 (
ùxt
 * 
dd
->
rcv_’Œ›s
.
ngroups
);

431 
u16
 
ù
 = 
ùxt
 - 
dd
->
fœ¡_dyn_®loc_ùxt
;

433 
ba£
 = ((
dd
->
n_krcv_queues
 * dd->
rcv_’Œ›s
.
ngroups
) +

434 
kùxt_ngroups
);

435 ià(
ù
 < 
dd
->
rcv_’Œ›s
.
nùxt_exŒa
) {

436 
ba£
 +ð
ù
 * (
dd
->
rcv_’Œ›s
.
ngroups
 + 1);

437 
rcd
->
rcv_¬¿y_groups
++;

439 
ba£
 +ð
dd
->
rcv_’Œ›s
.
nùxt_exŒa
 +

440 (
ù
 * 
dd
->
rcv_’Œ›s
.
ngroups
);

443 
rcd
->
—g”_ba£
 = 
ba£
 * 
dd
->
rcv_’Œ›s
.
group_size
;

445 
rcd
->
rcvhdrq_út
 = 
rcvhdrút
;

446 
rcd
->
rcvhdrq’tsize
 = 
hfi1_hdrq_’tsize
;

447 
rcd
->
rhf_off£t
 =

448 
rcd
->
rcvhdrq’tsize
 - (
u64
è/ (
u32
);

460 
max_’Œ›s
 = 
rcd
->
rcv_¬¿y_groups
 *

461 
dd
->
rcv_’Œ›s
.
group_size
;

462 
rcvtids
 = ((
max_’Œ›s
 * 
hfi1_rcv¬r_¥l™
) / 100);

463 
rcd
->
egrbufs
.
couÁ
 = 
	`round_down
(
rcvtids
,

464 
dd
->
rcv_’Œ›s
.
group_size
);

465 ià(
rcd
->
egrbufs
.
couÁ
 > 
MAX_EAGER_ENTRIES
) {

466 
	`dd_dev_”r
(
dd
, "ctxt%u:„equestedoo many RcvArrayƒntries.\n",

467 
rcd
->
ùxt
);

468 
rcd
->
egrbufs
.
couÁ
 = 
MAX_EAGER_ENTRIES
;

470 
	`hfi1_cdbg
(
PROC
,

472 
rcd
->
ùxt
,„cd->
egrbufs
.
couÁ
);

482 
rcd
->
egrbufs
.
bufãrs
 =

483 
	`kÿÎoc_node
(
rcd
->
egrbufs
.
couÁ
,

484 (*
rcd
->
egrbufs
.
bufãrs
),

485 
GFP_KERNEL
, 
numa
);

486 ià(!
rcd
->
egrbufs
.
bufãrs
)

487 
baž
;

488 
rcd
->
egrbufs
.
rcvtids
 =

489 
	`kÿÎoc_node
(
rcd
->
egrbufs
.
couÁ
,

490 (*
rcd
->
egrbufs
.
rcvtids
),

491 
GFP_KERNEL
, 
numa
);

492 ià(!
rcd
->
egrbufs
.
rcvtids
)

493 
baž
;

494 
rcd
->
egrbufs
.
size
 = 
—g”_bufãr_size
;

500 ià(
rcd
->
egrbufs
.
size
 < 
hfi1_max_mtu
) {

501 
rcd
->
egrbufs
.
size
 = 
	`__roundup_pow_of_two
(
hfi1_max_mtu
);

502 
	`hfi1_cdbg
(
PROC
,

504 
rcd
->
ùxt
,„cd->
egrbufs
.
size
);

506 
rcd
->
egrbufs
.
rcvtid_size
 = 
HFI1_MAX_EAGER_BUFFER_SIZE
;

509 ià(
ùxt
 < 
dd
->
fœ¡_dyn_®loc_ùxt
) {

510 
rcd
->
Ý¡©s
 = 
	`kz®loc_node
((*rcd->opstats),

511 
GFP_KERNEL
, 
numa
);

512 ià(!
rcd
->
Ý¡©s
)

513 
baž
;

516 
	`hfi1_k”n_š™_ùxt_g’”©iÚs
(
rcd
);

519 *
cÚ‹xt
 = 
rcd
;

523 
baž
:

524 *
cÚ‹xt
 = 
NULL
;

525 
	`hfi1_ä“_ùxt
(
rcd
);

526  -
ENOMEM
;

527 
	}
}

539 
	$hfi1_ä“_ùxt
(
hfi1_ùxtd©a
 *
rcd
)

541 
	`hfi1_rcd_put
(
rcd
);

542 
	}
}

551 
	$£t_lšk_g
(
hfi1_µÜtd©a
 *
µd
)

553 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

554 
cc_¡©e
 *cc_state;

555 
i
;

556 
u16
 
cû
, 
cùi_lim™
, 
max_cùi
 = 0;

557 
u16
 
shiá
, 
muÉ
;

558 
u64
 
¤c
;

559 
u32
 
cu¼’t_eg»ss_¿‹
;

560 
u32
 
max_pkt_time
;

566 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

568 ià(!
cc_¡©e
)

576 
i
 = 0; i < 
OPA_MAX_SLS
; i++) {

577 
u16
 
cùi
 = 
µd
->
cÿ_tim”
[
i
].ccti;

579 ià(
cùi
 > 
max_cùi
)

580 
max_cùi
 = 
cùi
;

583 
cùi_lim™
 = 
cc_¡©e
->
cù
.ccti_limit;

584 ià(
max_cùi
 > 
cùi_lim™
)

585 
max_cùi
 = 
cùi_lim™
;

587 
cû
 = 
cc_¡©e
->
cù
.
’Œ›s
[
max_cùi
].
’Œy
;

588 
shiá
 = (
cû
 & 0xc000) >> 14;

589 
muÉ
 = (
cû
 & 0x3fff);

591 
cu¼’t_eg»ss_¿‹
 = 
	`aùive_eg»ss_¿‹
(
µd
);

593 
max_pkt_time
 = 
	`eg»ss_cyþes
(
µd
->
ibmaxËn
, 
cu¼’t_eg»ss_¿‹
);

595 
¤c
 = (
max_pkt_time
 >> 
shiá
è* 
muÉ
;

597 
¤c
 &ð
SEND_STATIC_RATE_CONTROL_CSR_SRC_RELOAD_SMASK
;

598 
¤c
 <<ð
SEND_STATIC_RATE_CONTROL_CSR_SRC_RELOAD_SHIFT
;

600 
	`wr™e_c¤
(
dd
, 
SEND_STATIC_RATE_CONTROL
, 
¤c
);

601 
	}
}

603 
h¹im”_»¡¬t
 
	$cÿ_tim”_â
(
h¹im”
 *
t
)

605 
cÿ_tim”
 *cca_timer;

606 
hfi1_µÜtd©a
 *
µd
;

607 
¦
;

608 
u16
 
cùi_tim”
, 
cùi_mš
;

609 
cc_¡©e
 *cc_state;

610 
æags
;

611 
h¹im”_»¡¬t
 
»t
 = 
HRTIMER_NORESTART
;

613 
cÿ_tim”
 = 
	`cÚš”_of
(
t
, cÿ_tim”, 
h¹im”
);

614 
µd
 = 
cÿ_tim”
->ppd;

615 
¦
 = 
cÿ_tim”
->sl;

617 
	`rcu_»ad_lock
();

619 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

621 ià(!
cc_¡©e
) {

622 
	`rcu_»ad_uÆock
();

623  
HRTIMER_NORESTART
;

632 
cùi_mš
 = 
cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
[
¦
].ccti_min;

633 
cùi_tim”
 = 
cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
[
¦
].ccti_timer;

635 
	`¥š_lock_œq§ve
(&
µd
->
cÿ_tim”_lock
, 
æags
);

637 ià(
cÿ_tim”
->
cùi
 > 
cùi_mš
) {

638 
cÿ_tim”
->
cùi
--;

639 
	`£t_lšk_g
(
µd
);

642 ià(
cÿ_tim”
->
cùi
 > 
cùi_mš
) {

643 
n£c
 = 1024 * 
cùi_tim”
;

645 
	`h¹im”_fÜw¬d_now
(
t
, 
	`ns_to_ktime
(
n£c
));

646 
»t
 = 
HRTIMER_RESTART
;

649 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
cÿ_tim”_lock
, 
æags
);

650 
	`rcu_»ad_uÆock
();

651  
»t
;

652 
	}
}

657 
	$hfi1_š™_µÜtd©a
(
pci_dev
 *
pdev
, 
hfi1_µÜtd©a
 *
µd
,

658 
hfi1_devd©a
 *
dd
, 
u8
 
hw_pidx
, u8 
pÜt
)

660 
i
;

661 
ušt
 
deçuÉ_pkey_idx
;

662 
cc_¡©e
 *cc_state;

664 
µd
->
dd
 = dd;

665 
µd
->
hw_pidx
 = hw_pidx;

666 
µd
->
pÜt
 =…ort;

667 
µd
->
´ev_lšk_width
 = 
LINK_WIDTH_DEFAULT
;

672 
i
 = 0; i < 
C_VL_COUNT
 + 1; i++) {

673 
µd
->
pÜt_vl_xm™_wa™_Ï¡
[
i
] = 0;

674 
µd
->
vl_xm™_æ™_út
[
i
] = 0;

677 
deçuÉ_pkey_idx
 = 1;

679 
µd
->
pkeys
[
deçuÉ_pkey_idx
] = 
DEFAULT_P_KEY
;

680 
µd
->
·¹_’fÜû
 |ð
HFI1_PART_ENFORCE_IN
;

682 ià(
loÝback
) {

683 
	`dd_dev_”r
(
dd
, "Faking data…artition 0x8001 in idx %u\n",

684 !
deçuÉ_pkey_idx
);

685 
µd
->
pkeys
[!
deçuÉ_pkey_idx
] = 0x8001;

688 
	`INIT_WORK
(&
µd
->
lšk_vc_wÜk
, 
hªdË_v”ify_ÿp
);

689 
	`INIT_WORK
(&
µd
->
lšk_up_wÜk
, 
hªdË_lšk_up
);

690 
	`INIT_WORK
(&
µd
->
lšk_down_wÜk
, 
hªdË_lšk_down
);

691 
	`INIT_WORK
(&
µd
->
ä“ze_wÜk
, 
hªdË_ä“ze
);

692 
	`INIT_WORK
(&
µd
->
lšk_downg¿de_wÜk
, 
hªdË_lšk_downg¿de
);

693 
	`INIT_WORK
(&
µd
->
sma_mes§ge_wÜk
, 
hªdË_sma_mes§ge
);

694 
	`INIT_WORK
(&
µd
->
lšk_bounû_wÜk
, 
hªdË_lšk_bounû
);

695 
	`INIT_DELAYED_WORK
(&
µd
->
¡¬t_lšk_wÜk
, 
hªdË_¡¬t_lšk
);

696 
	`INIT_WORK
(&
µd
->
lšk¡©e_aùive_wÜk
, 
»ûive_š‹¼u±_wÜk
);

697 
	`INIT_WORK
(&
µd
->
qså_šfo
.
qså_wÜk
, 
qså_ev’t
);

699 
	`mu‹x_š™
(&
µd
->
hls_lock
);

700 
	`¥š_lock_š™
(&
µd
->
qså_šfo
.
qså_lock
);

702 
µd
->
qså_šfo
.ppd =…pd;

703 
µd
->
sm_Œ­_qp
 = 0x0;

704 
µd
->
§_qp
 = 0x1;

706 
µd
->
hfi1_wq
 = 
NULL
;

708 
	`¥š_lock_š™
(&
µd
->
cÿ_tim”_lock
);

710 
i
 = 0; i < 
OPA_MAX_SLS
; i++) {

711 
	`h¹im”_š™
(&
µd
->
cÿ_tim”
[
i
].
h¹im”
, 
CLOCK_MONOTONIC
,

712 
HRTIMER_MODE_REL
);

713 
µd
->
cÿ_tim”
[
i
].ppd =…pd;

714 
µd
->
cÿ_tim”
[
i
].
¦
 = i;

715 
µd
->
cÿ_tim”
[
i
].
cùi
 = 0;

716 
µd
->
cÿ_tim”
[
i
].
h¹im”
.
funùiÚ
 = 
cÿ_tim”_â
;

719 
µd
->
cc_max_bË_’Œ›s
 = 
IB_CC_TABLE_CAP_DEFAULT
;

721 
	`¥š_lock_š™
(&
µd
->
cc_¡©e_lock
);

722 
	`¥š_lock_š™
(&
µd
->
cc_log_lock
);

723 
cc_¡©e
 = 
	`kz®loc
((*cc_¡©e), 
GFP_KERNEL
);

724 
	`RCU_INIT_POINTER
(
µd
->
cc_¡©e
, cc_state);

725 ià(!
cc_¡©e
)

726 
baž
;

729 
baž
:

730 
	`dd_dev_”r
(
dd
, "CÚge¡iÚ CÚŒÞ Ag’ˆdi§bËd fÜ…Üˆ%d\n", 
pÜt
);

733 
	}
}

739 
	$lßdtime_š™
(
hfi1_devd©a
 *
dd
)

742 
	}
}

752 
	$š™_aá”_»£t
(
hfi1_devd©a
 *
dd
)

754 
i
;

755 
hfi1_ùxtd©a
 *
rcd
;

761 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

762 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

763 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_CTXT_DIS
 |

764 
HFI1_RCVCTRL_INTRAVAIL_DIS
 |

765 
HFI1_RCVCTRL_TAILUPD_DIS
, 
rcd
);

766 
	`hfi1_rcd_put
(
rcd
);

768 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_GLOBAL_DISABLE
);

769 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++)

770 
	`sc_di§bË
(
dd
->
£nd_cÚ‹xts
[
i
].
sc
);

773 
	}
}

775 
	$’abË_ch
(
hfi1_devd©a
 *
dd
)

777 
hfi1_ùxtd©a
 *
rcd
;

778 
u32
 
rcvmask
;

779 
u16
 
i
;

782 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_GLOBAL_ENABLE
);

788 
i
 = 0; i < 
dd
->
fœ¡_dyn_®loc_ùxt
; ++i) {

789 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

790 ià(!
rcd
)

792 
rcvmask
 = 
HFI1_RCVCTRL_CTXT_ENB
 | 
HFI1_RCVCTRL_INTRAVAIL_ENB
;

793 
rcvmask
 |ð
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
DMA_RTAIL
) ?

794 
HFI1_RCVCTRL_TAILUPD_ENB
 : 
HFI1_RCVCTRL_TAILUPD_DIS
;

795 ià(!
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
MULTI_PKT_EGR
))

796 
rcvmask
 |ð
HFI1_RCVCTRL_ONE_PKT_EGR_ENB
;

797 ià(
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
NODROP_RHQ_FULL
))

798 
rcvmask
 |ð
HFI1_RCVCTRL_NO_RHQ_DROP_ENB
;

799 ià(
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
NODROP_EGR_FULL
))

800 
rcvmask
 |ð
HFI1_RCVCTRL_NO_EGR_DROP_ENB
;

801 ià(
	`HFI1_CAP_IS_KSET
(
TID_RDMA
))

802 
rcvmask
 |ð
HFI1_RCVCTRL_TIDFLOW_ENB
;

803 
	`hfi1_rcvù¾
(
dd
, 
rcvmask
, 
rcd
);

804 
	`sc_’abË
(
rcd
->
sc
);

805 
	`hfi1_rcd_put
(
rcd
);

807 
	}
}

813 
	$ü—‹_wÜkqueues
(
hfi1_devd©a
 *
dd
)

815 
pidx
;

816 
hfi1_µÜtd©a
 *
µd
;

818 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

819 
µd
 = 
dd
->
µÜt
 + 
pidx
;

820 ià(!
µd
->
hfi1_wq
) {

821 
µd
->
hfi1_wq
 =

822 
	`®loc_wÜkqueue
(

824 
WQ_SYSFS
 | 
WQ_HIGHPRI
 | 
WQ_CPU_INTENSIVE
 |

825 
WQ_MEM_RECLAIM
,

826 
HFI1_MAX_ACTIVE_WORKQUEUE_ENTRIES
,

827 
dd
->
un™
, 
pidx
);

828 ià(!
µd
->
hfi1_wq
)

829 
wq_”rÜ
;

831 ià(!
µd
->
lšk_wq
) {

836 
µd
->
lšk_wq
 =

837 
	`®loc_wÜkqueue
(

839 
WQ_SYSFS
 | 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
,

841 
dd
->
un™
, 
pidx
);

842 ià(!
µd
->
lšk_wq
)

843 
wq_”rÜ
;

847 
wq_”rÜ
:

848 
	`´_”r
("®loc_wÜkqueuçžed fÜ…Üˆ%d\n", 
pidx
 + 1);

849 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

850 
µd
 = 
dd
->
µÜt
 + 
pidx
;

851 ià(
µd
->
hfi1_wq
) {

852 
	`de¡roy_wÜkqueue
(
µd
->
hfi1_wq
);

853 
µd
->
hfi1_wq
 = 
NULL
;

855 ià(
µd
->
lšk_wq
) {

856 
	`de¡roy_wÜkqueue
(
µd
->
lšk_wq
);

857 
µd
->
lšk_wq
 = 
NULL
;

860  -
ENOMEM
;

861 
	}
}

867 
	$de¡roy_wÜkqueues
(
hfi1_devd©a
 *
dd
)

869 
pidx
;

870 
hfi1_µÜtd©a
 *
µd
;

872 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

873 
µd
 = 
dd
->
µÜt
 + 
pidx
;

875 ià(
µd
->
hfi1_wq
) {

876 
	`de¡roy_wÜkqueue
(
µd
->
hfi1_wq
);

877 
µd
->
hfi1_wq
 = 
NULL
;

879 ià(
µd
->
lšk_wq
) {

880 
	`de¡roy_wÜkqueue
(
µd
->
lšk_wq
);

881 
µd
->
lšk_wq
 = 
NULL
;

884 
	}
}

892 
	$’abË_g’”®_šŒ
(
hfi1_devd©a
 *
dd
)

894 
	`£t_šŒ_b™s
(
dd
, 
CCE_ERR_INT
, 
MISC_ERR_INT
, 
Œue
);

895 
	`£t_šŒ_b™s
(
dd
, 
PIO_ERR_INT
, 
TXE_ERR_INT
, 
Œue
);

896 
	`£t_šŒ_b™s
(
dd
, 
IS_SENDCTXT_ERR_START
, 
IS_SENDCTXT_ERR_END
, 
Œue
);

897 
	`£t_šŒ_b™s
(
dd
, 
PBC_INT
, 
GPIO_ASSERT_INT
, 
Œue
);

898 
	`£t_šŒ_b™s
(
dd
, 
TCRIT_INT
, TCRIT_INT, 
Œue
);

899 
	`£t_šŒ_b™s
(
dd
, 
IS_DC_START
, 
IS_DC_END
, 
Œue
);

900 
	`£t_šŒ_b™s
(
dd
, 
IS_SENDCREDIT_START
, 
IS_SENDCREDIT_END
, 
Œue
);

901 
	}
}

918 
	$hfi1_š™
(
hfi1_devd©a
 *
dd
, 
»š™
)

920 
»t
 = 0, 
pidx
, 
Ï¡çž
 = 0;

921 
Ën
;

922 
u16
 
i
;

923 
hfi1_ùxtd©a
 *
rcd
;

924 
hfi1_µÜtd©a
 *
µd
;

927 
dd
->
´oûss_pio_£nd
 = 
hfi1_v”bs_£nd_pio
;

928 
dd
->
´oûss_dma_£nd
 = 
hfi1_v”bs_£nd_dma
;

929 
dd
->
pio_šlše_£nd
 = 
pio_cÝy
;

930 
dd
->
´oûss_vnic_dma_£nd
 = 
hfi1_vnic_£nd_dma
;

932 ià(
	`is_ax
(
dd
)) {

933 
	`©omic_£t
(&
dd
->
drÝ_·ck‘
, 
DROP_PACKET_ON
);

934 
dd
->
do_drÝ
 = 
Œue
;

936 
	`©omic_£t
(&
dd
->
drÝ_·ck‘
, 
DROP_PACKET_OFF
);

937 
dd
->
do_drÝ
 = 
çl£
;

941 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

942 
µd
 = 
dd
->
µÜt
 + 
pidx
;

943 
µd
->
lškup
 = 0;

946 ià(
»š™
)

947 
»t
 = 
	`š™_aá”_»£t
(
dd
);

949 
»t
 = 
	`lßdtime_š™
(
dd
);

950 ià(
»t
)

951 
dÚe
;

954 
dd
->
rcvhd¹až_dummy_kvaddr
 = 
	`dma_®loc_coh”’t
(&dd->
pcidev
->
dev
,

955 (
u64
),

956 &
dd
->
rcvhd¹až_dummy_dma
,

957 
GFP_KERNEL
);

959 ià(!
dd
->
rcvhd¹až_dummy_kvaddr
) {

960 
	`dd_dev_”r
(
dd
, "cannot‡llocate dummyail memory\n");

961 
»t
 = -
ENOMEM
;

962 
dÚe
;

966 
i
 = 0; 
dd
->
rcd
 && i < dd->
fœ¡_dyn_®loc_ùxt
; ++i) {

973 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

974 ià(!
rcd
)

977 
rcd
->
do_š‹¼u±
 = &
hªdË_»ûive_š‹¼u±
;

979 
Ï¡çž
 = 
	`hfi1_ü—‹_rcvhdrq
(
dd
, 
rcd
);

980 ià(!
Ï¡çž
)

981 
Ï¡çž
 = 
	`hfi1_£tup_—g”bufs
(
rcd
);

982 ià(!
Ï¡çž
)

983 
Ï¡çž
 = 
	`hfi1_k”n_exp_rcv_š™
(
rcd
, 
»š™
);

984 ià(
Ï¡çž
) {

985 
	`dd_dev_”r
(
dd
,

987 
»t
 = 
Ï¡çž
;

990 
	`hfi1_rcd_put
(
rcd
);

994 
Ën
 = 
	`PAGE_ALIGN
(
	`ch_rcv_cÚ‹xts
(
dd
è* 
HFI1_MAX_SHARED_CTXTS
 *

995 (*
dd
->
ev’ts
));

996 
dd
->
ev’ts
 = 
	`vm®loc_u£r
(
Ën
);

997 ià(!
dd
->
ev’ts
)

998 
	`dd_dev_”r
(
dd
, "Failedo‡llocate userƒvents…age\n");

1003 
dd
->
¡©us
 = 
	`vm®loc_u£r
(
PAGE_SIZE
);

1004 ià(!
dd
->
¡©us
)

1005 
	`dd_dev_”r
(
dd
, "Failedo‡llocate dev status…age\n");

1006 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1007 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1008 ià(
dd
->
¡©us
)

1010 
µd
->
¡©u¥
 = &
dd
->
¡©us
->
pÜt
;

1012 
	`£t_mtu
(
µd
);

1016 
	`’abË_ch
(
dd
);

1018 
dÚe
:

1023 ià(
dd
->
¡©us
)

1024 
dd
->
¡©us
->
dev
 |ð
HFI1_STATUS_CHIP_PRESENT
 |

1025 
HFI1_STATUS_INITTED
;

1026 ià(!
»t
) {

1028 
	`’abË_g’”®_šŒ
(
dd
);

1029 
	`š™_qså_št
(
dd
);

1032 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1033 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1039 
Ï¡çž
 = 
	`bršgup_£rdes
(
µd
);

1040 ià(
Ï¡çž
)

1041 
	`dd_dev_šfo
(
dd
,

1043 
µd
->
pÜt
);

1049 ià(
µd
->
¡©u¥
)

1050 *
µd
->
¡©u¥
 |ð
HFI1_STATUS_CHIP_PRESENT
 |

1051 
HFI1_STATUS_INITTED
;

1052 ià(!
µd
->
lšk_¥“d_’abËd
)

1058  
»t
;

1059 
	}
}

1061 
šlše
 
hfi1_devd©a
 *
	$__hfi1_lookup
(
un™
)

1063  
	`idr_fšd
(&
hfi1_un™_bË
, 
un™
);

1064 
	}
}

1066 
hfi1_devd©a
 *
	$hfi1_lookup
(
un™
)

1068 
hfi1_devd©a
 *
dd
;

1069 
æags
;

1071 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

1072 
dd
 = 
	`__hfi1_lookup
(
un™
);

1073 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

1075  
dd
;

1076 
	}
}

1082 
	$¡Ý_tim”s
(
hfi1_devd©a
 *
dd
)

1084 
hfi1_µÜtd©a
 *
µd
;

1085 
pidx
;

1087 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1088 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1089 ià(
µd
->
Ëd_ov”ride_tim”
.
funùiÚ
) {

1090 
	`d–_tim”_sync
(&
µd
->
Ëd_ov”ride_tim”
);

1091 
	`©omic_£t
(&
µd
->
Ëd_ov”ride_tim”_aùive
, 0);

1094 
	}
}

1105 
	$shutdown_deviû
(
hfi1_devd©a
 *
dd
)

1107 
hfi1_µÜtd©a
 *
µd
;

1108 
hfi1_ùxtd©a
 *
rcd
;

1109 
pidx
;

1110 
i
;

1112 ià(
dd
->
æags
 & 
HFI1_SHUTDOWN
)

1114 
dd
->
æags
 |ð
HFI1_SHUTDOWN
;

1116 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1117 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1119 
µd
->
lškup
 = 0;

1120 ià(
µd
->
¡©u¥
)

1121 *
µd
->
¡©u¥
 &ð~(
HFI1_STATUS_IB_CONF
 |

1122 
HFI1_STATUS_IB_READY
);

1124 
dd
->
æags
 &ð~
HFI1_INITTED
;

1127 
	`£t_šŒ_b™s
(
dd
, 
IS_FIRST_SOURCE
, 
IS_LAST_SOURCE
, 
çl£
);

1128 
	`msix_þ—n_up_š‹¼u±s
(
dd
);

1130 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1131 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1132 
i
 = 0; i < 
dd
->
num_rcv_cÚ‹xts
; i++) {

1133 
rcd
 = 
	`hfi1_rcd_g‘_by_šdex
(
dd
, 
i
);

1134 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_TAILUPD_DIS
 |

1135 
HFI1_RCVCTRL_CTXT_DIS
 |

1136 
HFI1_RCVCTRL_INTRAVAIL_DIS
 |

1137 
HFI1_RCVCTRL_PKEY_DIS
 |

1138 
HFI1_RCVCTRL_ONE_PKT_EGR_DIS
, 
rcd
);

1139 
	`hfi1_rcd_put
(
rcd
);

1145 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++)

1146 
	`sc_æush
(
dd
->
£nd_cÚ‹xts
[
i
].
sc
);

1153 
	`ud–ay
(20);

1155 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1156 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1159 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++)

1160 
	`sc_di§bË
(
dd
->
£nd_cÚ‹xts
[
i
].
sc
);

1162 
	`pio_£nd_cÚŒÞ
(
dd
, 
PSC_GLOBAL_DISABLE
);

1164 
	`shutdown_Ëd_ov”ride
(
µd
);

1170 
	`hfi1_qu›t_£rdes
(
µd
);

1171 ià(
µd
->
hfi1_wq
)

1172 
	`æush_wÜkqueue
(
µd
->
hfi1_wq
);

1173 ià(
µd
->
lšk_wq
)

1174 
	`æush_wÜkqueue
(
µd
->
lšk_wq
);

1176 
	`sdma_ex™
(
dd
);

1177 
	}
}

1187 
	$hfi1_ä“_ùxtd©a
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
)

1189 
u32
 
e
;

1191 ià(!
rcd
)

1194 ià(
rcd
->
rcvhdrq
) {

1195 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, 
	`rcvhdrq_size
(
rcd
),

1196 
rcd
->
rcvhdrq
,„cd->
rcvhdrq_dma
);

1197 
rcd
->
rcvhdrq
 = 
NULL
;

1198 ià(
rcd
->
rcvhd¹až_kvaddr
) {

1199 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, 
PAGE_SIZE
,

1200 (*)
rcd
->
rcvhd¹až_kvaddr
,

1201 
rcd
->
rcvhdrqžaddr_dma
);

1202 
rcd
->
rcvhd¹až_kvaddr
 = 
NULL
;

1207 
	`kä“
(
rcd
->
egrbufs
.
rcvtids
);

1208 
rcd
->
egrbufs
.
rcvtids
 = 
NULL
;

1210 
e
 = 0;ƒ < 
rcd
->
egrbufs
.
®loûd
;ƒ++) {

1211 ià(
rcd
->
egrbufs
.
bufãrs
[
e
].
dma
)

1212 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
,

1213 
rcd
->
egrbufs
.
bufãrs
[
e
].
Ën
,

1214 
rcd
->
egrbufs
.
bufãrs
[
e
].
addr
,

1215 
rcd
->
egrbufs
.
bufãrs
[
e
].
dma
);

1217 
	`kä“
(
rcd
->
egrbufs
.
bufãrs
);

1218 
rcd
->
egrbufs
.
®loûd
 = 0;

1219 
rcd
->
egrbufs
.
bufãrs
 = 
NULL
;

1221 
	`sc_ä“
(
rcd
->
sc
);

1222 
rcd
->
sc
 = 
NULL
;

1224 
	`vä“
(
rcd
->
subùxt_u»gba£
);

1225 
	`vä“
(
rcd
->
subùxt_rcvegrbuf
);

1226 
	`vä“
(
rcd
->
subùxt_rcvhdr_ba£
);

1227 
	`kä“
(
rcd
->
Ý¡©s
);

1229 
rcd
->
subùxt_u»gba£
 = 
NULL
;

1230 
rcd
->
subùxt_rcvegrbuf
 = 
NULL
;

1231 
rcd
->
subùxt_rcvhdr_ba£
 = 
NULL
;

1232 
rcd
->
Ý¡©s
 = 
NULL
;

1233 
	}
}

1240 
hfi1_asic_d©a
 *
	$»Ëa£_asic_d©a
(
hfi1_devd©a
 *
dd
)

1242 
hfi1_asic_d©a
 *
ad
;

1243 
Ùh”
;

1245 ià(!
dd
->
asic_d©a
)

1246  
NULL
;

1247 
dd
->
asic_d©a
->
dds
[dd->
hfi1_id
] = 
NULL
;

1248 
Ùh”
 = 
dd
->
hfi1_id
 ? 0 : 1;

1249 
ad
 = 
dd
->
asic_d©a
;

1250 
dd
->
asic_d©a
 = 
NULL
;

1252  
ad
->
dds
[
Ùh”
] ? 
NULL
 :‡d;

1253 
	}
}

1255 
	$fš®ize_asic_d©a
(
hfi1_devd©a
 *
dd
,

1256 
hfi1_asic_d©a
 *
ad
)

1258 
	`þ—n_up_i2c
(
dd
, 
ad
);

1259 
	`kä“
(
ad
);

1260 
	}
}

1269 
	$hfi1_þ—n_devd©a
(
hfi1_devd©a
 *
dd
)

1271 
hfi1_asic_d©a
 *
ad
;

1272 
æags
;

1274 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

1275 ià(!
	`li¡_em±y
(&
dd
->
li¡
)) {

1276 
	`idr_»move
(&
hfi1_un™_bË
, 
dd
->
un™
);

1277 
	`li¡_d–_š™
(&
dd
->
li¡
);

1279 
ad
 = 
	`»Ëa£_asic_d©a
(
dd
);

1280 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

1282 
	`fš®ize_asic_d©a
(
dd
, 
ad
);

1283 
	`ä“_¶©fÜm_cÚfig
(
dd
);

1284 
	`rcu_b¬r›r
();

1285 
	`ä“_³rýu
(
dd
->
št_couÁ”
);

1286 
	`ä“_³rýu
(
dd
->
rcv_lim™
);

1287 
	`ä“_³rýu
(
dd
->
£nd_scheduË
);

1288 
	`ä“_³rýu
(
dd
->
tx_Ý¡©s
);

1289 
dd
->
št_couÁ”
 = 
NULL
;

1290 
dd
->
rcv_lim™
 = 
NULL
;

1291 
dd
->
£nd_scheduË
 = 
NULL
;

1292 
dd
->
tx_Ý¡©s
 = 
NULL
;

1293 
	`kä“
(
dd
->
comp_veù
);

1294 
dd
->
comp_veù
 = 
NULL
;

1295 
	`sdma_þ—n
(
dd
, dd->
num_sdma
);

1296 
	`rvt_d—Îoc_deviû
(&
dd
->
v”bs_dev
.
rdi
);

1297 
	}
}

1299 
	$__hfi1_ä“_devd©a
(
kobjeù
 *
kobj
)

1301 
hfi1_devd©a
 *
dd
 =

1302 
	`cÚš”_of
(
kobj
, 
hfi1_devd©a
, kobj);

1304 
	`hfi1_þ—n_devd©a
(
dd
);

1305 
	}
}

1307 
kobj_ty³
 
	ghfi1_devd©a_ty³
 = {

1308 .
»Ëa£
 = 
__hfi1_ä“_devd©a
,

1311 
	$hfi1_ä“_devd©a
(
hfi1_devd©a
 *
dd
)

1313 
	`kobjeù_put
(&
dd
->
kobj
);

1314 
	}
}

1327 
hfi1_devd©a
 *
	$hfi1_®loc_devd©a
(
pci_dev
 *
pdev
,

1328 
size_t
 
exŒa
)

1330 
æags
;

1331 
hfi1_devd©a
 *
dd
;

1332 
»t
, 
ÅÜts
;

1335 
ÅÜts
 = 
exŒa
 / (
hfi1_µÜtd©a
);

1337 
dd
 = (
hfi1_devd©a
 *)
	`rvt_®loc_deviû
((*ddè+ 
exŒa
,

1338 
ÅÜts
);

1339 ià(!
dd
)

1340  
	`ERR_PTR
(-
ENOMEM
);

1341 
	`hfi1_¢oÝ_š™
(
dd
);

1342 
dd
->
num_µÜts
 = 
ÅÜts
;

1343 
dd
->
µÜt
 = (
hfi1_µÜtd©a
 *)(dd + 1);

1344 
dd
->
pcidev
 = 
pdev
;

1345 
	`pci_£t_drvd©a
(
pdev
, 
dd
);

1347 
	`INIT_LIST_HEAD
(&
dd
->
li¡
);

1348 
	`idr_´–ßd
(
GFP_KERNEL
);

1349 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

1351 
»t
 = 
	`idr_®loc
(&
hfi1_un™_bË
, 
dd
, 0, 0, 
GFP_NOWAIT
);

1352 ià(
»t
 >= 0) {

1353 
dd
->
un™
 = 
»t
;

1354 
	`li¡_add
(&
dd
->
li¡
, &
hfi1_dev_li¡
);

1356 
dd
->
node
 = 
NUMA_NO_NODE
;

1358 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

1359 
	`idr_´–ßd_’d
();

1361 ià(
»t
 < 0) {

1362 
	`dev_”r
(&
pdev
->
dev
,

1363 "Could‚Ù‡Îoÿ‹ un™ ID:ƒ¼Ü %d\n", -
»t
);

1364 
baž
;

1366 
	`rvt_£t_ibdev_Çme
(&
dd
->
v”bs_dev
.
rdi
, "%s_%d", 
	`þass_Çme
(), dd->
un™
);

1372 
	`¥š_lock_š™
(&
dd
->
sc_lock
);

1373 
	`¥š_lock_š™
(&
dd
->
£ndù¾_lock
);

1374 
	`¥š_lock_š™
(&
dd
->
rcvù¾_lock
);

1375 
	`¥š_lock_š™
(&
dd
->
uùxt_lock
);

1376 
	`¥š_lock_š™
(&
dd
->
hfi1_dŸg_Œªs_lock
);

1377 
	`¥š_lock_š™
(&
dd
->
sc_š™_lock
);

1378 
	`¥š_lock_š™
(&
dd
->
dc8051_memlock
);

1379 
	`£qlock_š™
(&
dd
->
sc2vl_lock
);

1380 
	`¥š_lock_š™
(&
dd
->
sde_m­_lock
);

1381 
	`¥š_lock_š™
(&
dd
->
pio_m­_lock
);

1382 
	`mu‹x_š™
(&
dd
->
dc8051_lock
);

1383 
	`š™_wa™queue_h—d
(&
dd
->
ev’t_queue
);

1384 
	`¥š_lock_š™
(&
dd
->
œq_¤c_lock
);

1386 
dd
->
št_couÁ”
 = 
	`®loc_³rýu
(
u64
);

1387 ià(!
dd
->
št_couÁ”
) {

1388 
»t
 = -
ENOMEM
;

1389 
baž
;

1392 
dd
->
rcv_lim™
 = 
	`®loc_³rýu
(
u64
);

1393 ià(!
dd
->
rcv_lim™
) {

1394 
»t
 = -
ENOMEM
;

1395 
baž
;

1398 
dd
->
£nd_scheduË
 = 
	`®loc_³rýu
(
u64
);

1399 ià(!
dd
->
£nd_scheduË
) {

1400 
»t
 = -
ENOMEM
;

1401 
baž
;

1404 
dd
->
tx_Ý¡©s
 = 
	`®loc_³rýu
(
hfi1_Ýcode_¡©s_³rùx
);

1405 ià(!
dd
->
tx_Ý¡©s
) {

1406 
»t
 = -
ENOMEM
;

1407 
baž
;

1410 
dd
->
comp_veù
 = 
	`kz®loc
((*dd->comp_veù), 
GFP_KERNEL
);

1411 ià(!
dd
->
comp_veù
) {

1412 
»t
 = -
ENOMEM
;

1413 
baž
;

1416 
	`©omic_£t
(&
dd
->
oib_rsm_u¤_num
, 0);

1418 
	`kobjeù_š™
(&
dd
->
kobj
, &
hfi1_devd©a_ty³
);

1419  
dd
;

1421 
baž
:

1422 
	`hfi1_þ—n_devd©a
(
dd
);

1423  
	`ERR_PTR
(
»t
);

1424 
	}
}

1431 
	$hfi1_di§bË_aá”_”rÜ
(
hfi1_devd©a
 *
dd
)

1433 ià(
dd
->
æags
 & 
HFI1_INITTED
) {

1434 
u32
 
pidx
;

1436 
dd
->
æags
 &ð~
HFI1_INITTED
;

1437 ià(
dd
->
µÜt
)

1438 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1439 
hfi1_µÜtd©a
 *
µd
;

1441 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1442 ià(
dd
->
æags
 & 
HFI1_PRESENT
)

1443 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_DISABLE
);

1445 ià(
µd
->
¡©u¥
)

1446 *
µd
->
¡©u¥
 &ð~
HFI1_STATUS_IB_READY
;

1455 ià(
dd
->
¡©us
)

1456 
dd
->
¡©us
->
dev
 |ð
HFI1_STATUS_HWERROR
;

1457 
	}
}

1459 
»move_Úe
(
pci_dev
 *);

1460 
š™_Úe
(
pci_dev
 *, cÚ¡ 
pci_deviû_id
 *);

1461 
hfi1_´obe_dÚe
(
tim”_li¡
 *
t
);

1462 
shutdown_Úe
(
pci_dev
 *);

1464 
	#DRIVER_LOAD_MSG
 "IÁ– " 
DRIVER_NAME
 "†ßded: "

	)

1465 
	#PFX
 
DRIVER_NAME
 ": "

	)

1467 cÚ¡ 
pci_deviû_id
 
	ghfi1_pci_tbl
[] = {

1468 { 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL0
) },

1469 { 
PCI_DEVICE
(
PCI_VENDOR_ID_INTEL
, 
PCI_DEVICE_ID_INTEL1
) },

1473 
MODULE_DEVICE_TABLE
(
pci
, 
hfi1_pci_tbl
);

1475 
pci_driv”
 
	ghfi1_pci_driv”
 = {

1476 .
Çme
 = 
DRIVER_NAME
,

1477 .
	g´obe
 = 
š™_Úe
,

1478 .
	g»move
 = 
»move_Úe
,

1479 .
	gshutdown
 = 
shutdown_Úe
,

1480 .
	gid_bË
 = 
hfi1_pci_tbl
,

1481 .
	g”r_hªdËr
 = &
hfi1_pci_”r_hªdËr
,

1484 
__š™
 
	$compu‹_krcvqs
()

1486 
i
;

1488 
i
 = 0; i < 
krcvqs£t
; i++)

1489 
n_krcvqs
 +ð
krcvqs
[
i
];

1490 
	}
}

1496 
__š™
 
	$hfi1_mod_š™
()

1498 
»t
;

1500 
»t
 = 
	`dev_š™
();

1501 ià(
»t
)

1502 
baž
;

1504 #ifdeà
NVIDIA_GPU_DIRECT


1505 
»t
 = 
	`hfi1_gdr_deviû_ü—‹
();

1506 ià(
»t
)

1507 
baž_cdev
;

1510 
»t
 = 
	`node_affš™y_š™
();

1511 ià(
»t
)

1512 #ifdeà
NVIDIA_GPU_DIRECT


1513 
baž_gdr
;

1515 
baž
;

1518 ià(
pÜt_»Üd”
) {

1519 
hfi1_š™_wq
 = 
	`®loc_wÜkqueue
("hfi1_š™_wq", 
WQ_MEM_RECLAIM
,

1521 ià(!
hfi1_š™_wq
) {

1522 
	`´_”r
("Failedo create deffered dev init wq\n");

1523 
»t
 = -
ENOMEM
;

1524 #ifdeà
NVIDIA_GPU_DIRECT


1525 
baž_gdr
;

1527 
baž
;

1534 ià(!
	`v®id_Ýa_max_mtu
(
hfi1_max_mtu
)) {

1535 
	`´_”r
("Invalid max_mtu 0x%x, using 0x%x instead\n",

1536 
hfi1_max_mtu
, 
HFI1_DEFAULT_MAX_MTU
);

1537 
hfi1_max_mtu
 = 
HFI1_DEFAULT_MAX_MTU
;

1540 ià(
hfi1_cu
 > 128 || !
	`is_pow”_of_2
(hfi1_cu))

1541 
hfi1_cu
 = 1;

1543 ià(
u£r_üed™_»tuº_th»shÞd
 > 100)

1544 
u£r_üed™_»tuº_th»shÞd
 = 100;

1546 
	`compu‹_krcvqs
();

1551 ià(
rcv_šŒ_couÁ
 > 
RCV_HDR_HEAD_COUNTER_MASK
)

1552 
rcv_šŒ_couÁ
 = 
RCV_HDR_HEAD_COUNTER_MASK
;

1554 ià(
rcv_šŒ_couÁ
 =ð0 && 
rcv_šŒ_timeout
 == 0) {

1555 
	`´_”r
("Invalid mode: both„eceive interrupt count‡nd‡vailableimeout‡re zero - setting interrupt counto 1\n");

1556 
rcv_šŒ_couÁ
 = 1;

1558 ià(
rcv_šŒ_couÁ
 > 1 && 
rcv_šŒ_timeout
 == 0) {

1563 
	`´_”r
("Invalid mode:„eceive interrupt count greaterhan 1‡nd‡vailableimeout is zero - setting‡vailableimeouto 1\n");

1564 
rcv_šŒ_timeout
 = 1;

1566 ià(
rcv_šŒ_dyÇmic
 && !(
rcv_šŒ_couÁ
 > 1 && 
rcv_šŒ_timeout
 > 0)) {

1571 
	`´_”r
("Invalid mode: dynamic„eceive interrupt mitigation with invalid count‡ndimeout -urning dynamic off\n");

1572 
rcv_šŒ_dyÇmic
 = 0;

1576 
lšk_üc_mask
 &ð
SUPPORTED_CRCS
;

1582 
	`idr_š™
(&
hfi1_un™_bË
);

1584 
	`hfi1_dbg_š™
();

1586 
	`tim”_£tup
(&
š™_tim”
, 
hfi1_´obe_dÚe
, 0);

1588 
»t
 = 
	`pci_»gi¡”_driv”
(&
hfi1_pci_driv”
);

1589 ià(
»t
 < 0) {

1590 
	`´_”r
("UÇbËØ»gi¡” driv”:ƒ¼Ü %d\n", -
»t
);

1591 
baž_dev
;

1593 
baž
;

1595 
baž_dev
:

1596 
	`hfi1_dbg_ex™
();

1597 
	`idr_de¡roy
(&
hfi1_un™_bË
);

1598 #ifdeà
NVIDIA_GPU_DIRECT


1599 
baž_gdr
:

1600 
	`hfi1_gdr_deviû_»move
();

1601 
baž_cdev
:

1602 
	`dev_þ—nup
();

1604 
	`dev_þ—nup
();

1606 
baž
:

1607  
»t
;

1608 
	}
}

1610 
moduË_š™
(
hfi1_mod_š™
);

1615 
__ex™
 
	$hfi1_mod_þ—nup
()

1617 
hfi1_š™_dev
 *
pos
, *
tmp
;

1619 #ifdeà
NVIDIA_GPU_DIRECT


1620 
	`hfi1_gdr_deviû_»move
();

1622 
	`pci_uÄegi¡”_driv”
(&
hfi1_pci_driv”
);

1623 
	`node_affš™y_de¡roy_®l
();

1624 
	`hfi1_dbg_ex™
();

1626 
	`idr_de¡roy
(&
hfi1_un™_bË
);

1627 
	`di¥o£_fœmw¬e
();

1628 
	`dev_þ—nup
();

1630 
	`mu‹x_lock
(&
š™_mu‹x
);

1631 
	`li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
tmp
, &
š™_li¡
, 
li¡
) {

1632 
	`li¡_d–
(&
pos
->
li¡
);

1633 
	`kä“
(
pos
);

1635 
	`mu‹x_uÆock
(&
š™_mu‹x
);

1636 
	`d–_tim”
(&
š™_tim”
);

1637 ià(
hfi1_š™_wq
) {

1638 
	`de¡roy_wÜkqueue
(
hfi1_š™_wq
);

1639 
hfi1_š™_wq
 = 
NULL
;

1641 
	}
}

1643 
moduË_ex™
(
hfi1_mod_þ—nup
);

1646 
	$þ—nup_deviû_d©a
(
hfi1_devd©a
 *
dd
)

1648 
ùxt
;

1649 
pidx
;

1652 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1653 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[
pidx
];

1654 
cc_¡©e
 *cc_state;

1655 
i
;

1657 ià(
µd
->
¡©u¥
)

1658 *
µd
->
¡©u¥
 &ð~
HFI1_STATUS_CHIP_PRESENT
;

1660 
i
 = 0; i < 
OPA_MAX_SLS
; i++)

1661 
	`h¹im”_ÿnûl
(&
µd
->
cÿ_tim”
[
i
].
h¹im”
);

1663 
	`¥š_lock
(&
µd
->
cc_¡©e_lock
);

1664 
cc_¡©e
 = 
	`g‘_cc_¡©e_´Ùeùed
(
µd
);

1665 
	`RCU_INIT_POINTER
(
µd
->
cc_¡©e
, 
NULL
);

1666 
	`¥š_uÆock
(&
µd
->
cc_¡©e_lock
);

1668 ià(
cc_¡©e
)

1669 
	`kä“_rcu
(
cc_¡©e
, 
rcu
);

1672 
	`ä“_üed™_»tuº
(
dd
);

1674 ià(
dd
->
rcvhd¹až_dummy_kvaddr
) {

1675 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, (
u64
),

1676 (*)
dd
->
rcvhd¹až_dummy_kvaddr
,

1677 
dd
->
rcvhd¹až_dummy_dma
);

1678 
dd
->
rcvhd¹až_dummy_kvaddr
 = 
NULL
;

1685 
ùxt
 = 0; 
dd
->
rcd
 && ctxˆ< dd->
num_rcv_cÚ‹xts
; ctxt++) {

1686 
hfi1_ùxtd©a
 *
rcd
 = 
dd
->rcd[
ùxt
];

1688 ià(
rcd
) {

1689 ià(
ùxt
 < 
dd
->
fœ¡_dyn_®loc_ùxt
)

1690 
	`hfi1_ä“_ùxt_rcv_groups
(
rcd
);

1691 
	`hfi1_þ—r_tids
(
rcd
);

1692 
	`hfi1_ä“_ùxt
(
rcd
);

1696 
	`kä“
(
dd
->
rcd
);

1697 
dd
->
rcd
 = 
NULL
;

1699 
	`ä“_pio_m­
(
dd
);

1701 
ùxt
 = 0; ctxˆ< 
dd
->
num_£nd_cÚ‹xts
; ctxt++)

1702 
	`sc_ä“
(
dd
->
£nd_cÚ‹xts
[
ùxt
].
sc
);

1703 
dd
->
num_£nd_cÚ‹xts
 = 0;

1704 
	`kä“
(
dd
->
£nd_cÚ‹xts
);

1705 
dd
->
£nd_cÚ‹xts
 = 
NULL
;

1706 
	`kä“
(
dd
->
hw_to_sw
);

1707 
dd
->
hw_to_sw
 = 
NULL
;

1708 
	`kä“
(
dd
->
bßrdÇme
);

1709 
	`vä“
(
dd
->
ev’ts
);

1710 
	`vä“
(
dd
->
¡©us
);

1711 
	}
}

1717 
	$po¡š™_þ—nup
(
hfi1_devd©a
 *
dd
)

1719 
	`hfi1_¡¬t_þ—nup
(
dd
);

1720 
	`hfi1_comp_veùÜs_þ—n_up
(
dd
);

1721 
	`hfi1_dev_affš™y_þ—n_up
(
dd
);

1723 
	`hfi1_pc›_ddþ—nup
(
dd
);

1724 
	`hfi1_pc›_þ—nup
(
dd
->
pcidev
);

1726 
	`þ—nup_deviû_d©a
(
dd
);

1728 
	`hfi1_ä“_devd©a
(
dd
);

1729 
	}
}

1731 
	$do_š™_Úe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
’t
)

1733 
»t
 = 0, 
j
, 
pidx
, 
š™çž
;

1734 
hfi1_devd©a
 *
dd
;

1735 
hfi1_µÜtd©a
 *
µd
;

1738 
	`HFI1_CAP_LOCK
();

1741 ià(!(
’t
->
deviû
 =ð
PCI_DEVICE_ID_INTEL0
 ||

1742 
’t
->
deviû
 =ð
PCI_DEVICE_ID_INTEL1
)) {

1743 
	`dev_”r
(&
pdev
->
dev
, "Failing on unknown Intel deviceid 0x%x\n",

1744 
’t
->
deviû
);

1745 
»t
 = -
ENODEV
;

1746 
baž
;

1750 
dd
 = 
	`hfi1_®loc_devd©a
(
pdev
, 
NUM_IB_PORTS
 *

1751 (
hfi1_µÜtd©a
));

1752 ià(
	`IS_ERR
(
dd
)) {

1753 
»t
 = 
	`PTR_ERR
(
dd
);

1754 
baž
;

1758 
»t
 = 
	`hfi1_v®id©e_rcvhdrút
(
dd
, 
rcvhdrút
);

1759 ià(
»t
)

1760 
baž
;

1763 ià(!
	`’code_rcv_h—d”_’Œy_size
(
hfi1_hdrq_’tsize
)) {

1764 
	`dd_dev_”r
(
dd
, "Invalid HdrQ Entry size %u\n",

1765 
hfi1_hdrq_’tsize
);

1766 
»t
 = -
EINVAL
;

1767 
baž
;

1779 ià(
—g”_bufãr_size
) {

1780 ià(!
	`is_pow”_of_2
(
—g”_bufãr_size
))

1781 
—g”_bufãr_size
 =

1782 
	`roundup_pow_of_two
(
—g”_bufãr_size
);

1783 
—g”_bufãr_size
 =

1784 
	`þamp_v®
(
—g”_bufãr_size
,

1785 
MIN_EAGER_BUFFER
 * 8,

1786 
MAX_EAGER_BUFFER_TOTAL
);

1787 
	`dd_dev_šfo
(
dd
, "Eager buffer size %u\n",

1788 
—g”_bufãr_size
);

1790 
	`dd_dev_”r
(
dd
, "Invalid Eager buffer size of 0\n");

1791 
»t
 = -
EINVAL
;

1792 
baž
;

1796 
hfi1_rcv¬r_¥l™
 = 
	`þamp_v®
(hfi1_rcvarr_split, 0, 100);

1798 
»t
 = 
	`hfi1_pc›_š™
(
dd
);

1799 ià(
»t
)

1800 
baž
;

1806 
»t
 = 
	`hfi1_š™_dd
(
dd
);

1807 ià(
»t
)

1808 
þ—n_baž
;

1810 
»t
 = 
	`ü—‹_wÜkqueues
(
dd
);

1811 ià(
»t
)

1812 
þ—n_baž
;

1815 
š™çž
 = 
	`hfi1_š™
(
dd
, 0);

1817 
»t
 = 
	`hfi1_»gi¡”_ib_deviû
(
dd
);

1825 ià(!
š™çž
 && !
»t
) {

1826 
dd
->
æags
 |ð
HFI1_INITTED
;

1828 
	`hfi1_dbg_ibdev_š™
(&
dd
->
v”bs_dev
);

1831 
j
 = 
	`hfi1_deviû_ü—‹
(
dd
);

1832 ià(
j
)

1833 
	`dd_dev_”r
(
dd
, "FažedØü—‹ /dev deviûs: %d\n", -
j
);

1835 ià(
š™çž
 || 
»t
) {

1836 
	`msix_þ—n_up_š‹¼u±s
(
dd
);

1837 
	`¡Ý_tim”s
(
dd
);

1838 
	`æush_wÜkqueue
(
ib_wq
);

1839 
pidx
 = 0;…idx < 
dd
->
num_µÜts
; ++pidx) {

1840 
	`hfi1_qu›t_£rdes
(
dd
->
µÜt
 + 
pidx
);

1841 
µd
 = 
dd
->
µÜt
 + 
pidx
;

1842 ià(
µd
->
hfi1_wq
) {

1843 
	`de¡roy_wÜkqueue
(
µd
->
hfi1_wq
);

1844 
µd
->
hfi1_wq
 = 
NULL
;

1846 ià(
µd
->
lšk_wq
) {

1847 
	`de¡roy_wÜkqueue
(
µd
->
lšk_wq
);

1848 
µd
->
lšk_wq
 = 
NULL
;

1851 ià(!
j
)

1852 
	`hfi1_deviû_»move
(
dd
);

1853 ià(!
»t
)

1854 
	`hfi1_uÄegi¡”_ib_deviû
(
dd
);

1855 
	`po¡š™_þ—nup
(
dd
);

1856 ià(
š™çž
)

1857 
»t
 = 
š™çž
;

1858 
baž
;

1861 
	`sdma_¡¬t
(
dd
);

1865 
þ—n_baž
:

1866 
	`hfi1_pc›_þ—nup
(
pdev
);

1867 
baž
:

1868  
»t
;

1869 
	}
}

1871 
	$hfi1_deã¼ed_š™
(
wÜk_¡ruù
 *
wÜk
)

1873 
hfi1_š™_dev
 *
pos
, *
tmp
;

1874 
»t
;

1876 
	`mu‹x_lock
(&
š™_mu‹x
);

1877 
	`li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
tmp
, &
š™_li¡
, 
li¡
) {

1878 
»t
 = 
	`do_š™_Úe
(
pos
->
pdev
,…os->
’t
);

1879 ià(
»t
)

1880 
	`hfi1_—¾y_”r
(&
pos
->
pdev
->
dev
, "%s: dev init failed,ƒrr %d\n",

1881 
__func__
, 
»t
);

1883 
	`li¡_d–
(&
pos
->
li¡
);

1884 
	`kä“
(
pos
);

1886 
	`mu‹x_uÆock
(&
š™_mu‹x
);

1887 
	`kä“
(
wÜk
);

1888 
	}
}

1890 
	$hfi1_´obe_dÚe
(
tim”_li¡
 *
t
)

1892 
wÜk_¡ruù
 *
wÜk
;

1894 ià(!
hfi1_š™_wq
)

1898 
wÜk
 = 
	`kz®loc
((*wÜk), 
GFP_ATOMIC
);

1899 ià(!
wÜk
)

1902 
	`INIT_WORK
(
wÜk
, 
hfi1_deã¼ed_š™
);

1903 
	`queue_wÜk
(
hfi1_š™_wq
, 
wÜk
);

1904 
	}
}

1906 
	$g‘_guid
(
pci_dev
 *
pdev
, 
u64
 *
guid
)

1908 
__iomem
 *
b¬
;

1910 
b¬
 = 
	`iÜem­_noÿche
(
	`pci_»sourû_¡¬t
(
pdev
, 0),

1911 
DC_DC8051_CFG_LOCAL_GUID
 + 8);

1912 ià(!
b¬
) {

1913 
	`hfi1_—¾y_”r
(&
pdev
->
dev
, "%s: unableo ioremap bar\n",

1914 
__func__
);

1915  -
ENOMEM
;

1918 
	`wr™eq
(0uÎ, 
b¬
 + 
CCE_DC_CTRL
);

1919 ()
	`»adq
(
b¬
 + 
CCE_DC_CTRL
);

1922 *
guid
 = 
	`»adq
(
b¬
 + 
DC_DC8051_CFG_LOCAL_GUID
);

1923 
	`iounm­
(
b¬
);

1925 
	}
}

1927 
	$š™_Úe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
’t
)

1929 
hfi1_š™_dev
 *
´obed_pdev
;

1930 
hfi1_š™_dev
 *
pos
;

1931 
u64
 
guid
;

1932 
»t
;

1934 ià(!
pÜt_»Üd”
)

1935  
	`do_š™_Úe
(
pdev
, 
’t
);

1937 
´obed_pdev
 = 
	`kz®loc
((*´obed_pdev), 
GFP_KERNEL
);

1938 ià(!
´obed_pdev
)

1939  -
ENOMEM
;

1941 
»t
 = 
	`pci_’abË_deviû
(
pdev
);

1942 ià(
»t
) {

1943 
	`hfi1_—¾y_”r
(&
pdev
->
dev
, "%s: cannotƒnable device,ƒrr %d\n",

1944 
__func__
, 
»t
);

1945 
çž
;

1948 
»t
 = 
	`g‘_guid
(
pdev
, &
guid
);

1949 ià(
»t
)

1950 
çž_g‘_guid
;

1952 
´obed_pdev
->
pdev
 =…dev;

1953 
´obed_pdev
->
’t
 =ƒnt;

1954 
´obed_pdev
->
guid
 = guid;

1956 
	`mu‹x_lock
(&
š™_mu‹x
);

1957 ià(
	`li¡_em±y
(&
š™_li¡
)) {

1958 
	`li¡_add_ž
(&
´obed_pdev
->
li¡
, &
š™_li¡
);

1960 
	`li¡_fÜ_—ch_’Œy
(
pos
, &
š™_li¡
, 
li¡
)

1961 ià(
	`HFI_ASIC_GUID
(
pos
->
guid
) == HFI_ASIC_GUID(guid))

1965 ià(
pos
->
guid
 =ð
´obed_pdev
->guid) {

1967 
	`hfi1_—¾y_”r
(&
pdev
->
dev
, "%s: duplicate guid 0x%llx\n",

1968 
__func__
, 
guid
);

1969 
	`mu‹x_uÆock
(&
š™_mu‹x
);

1970 
çž_g‘_guid
;

1977 ià((
pos
->
guid
 >> 
GUID_HFI_INDEX_SHIFT
) & 1)

1978 
	`li¡_add_ž
(&
´obed_pdev
->
li¡
, &
pos
->list);

1980 
	`li¡_add
(&
´obed_pdev
->
li¡
, &
pos
->list);

1982 
	`mu‹x_uÆock
(&
š™_mu‹x
);

1983 
	`mod_tim”
(&
š™_tim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(1000));

1984 
	`pci_di§bË_deviû
(
pdev
);

1987 
çž_g‘_guid
:

1988 
	`pci_di§bË_deviû
(
pdev
);

1989 
çž
:

1990 
	`kä“
(
´obed_pdev
);

1991  
»t
;

1992 
	}
}

1994 
	$wa™_fÜ_þ›Ás
(
hfi1_devd©a
 *
dd
)

2000 ià(
	`©omic_dec_ªd_‹¡
(&
dd
->
u£r_»fcouÁ
))

2001 
	`com¶‘e
(&
dd
->
u£r_comp
);

2003 
	`wa™_fÜ_com¶‘iÚ
(&
dd
->
u£r_comp
);

2004 
	}
}

2006 
	$»move_Úe
(
pci_dev
 *
pdev
)

2008 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

2011 
	`hfi1_dbg_ibdev_ex™
(&
dd
->
v”bs_dev
);

2014 
	`hfi1_deviû_»move
(
dd
);

2017 
	`wa™_fÜ_þ›Ás
(
dd
);

2020 
	`hfi1_uÄegi¡”_ib_deviû
(
dd
);

2023 
	`hfi1_Ãtdev_ä“
(
dd
);

2028 
	`shutdown_deviû
(
dd
);

2029 
	`de¡roy_wÜkqueues
(
dd
);

2031 
	`¡Ý_tim”s
(
dd
);

2034 
	`æush_wÜkqueue
(
ib_wq
);

2036 
	`po¡š™_þ—nup
(
dd
);

2037 
	}
}

2039 
	$shutdown_Úe
(
pci_dev
 *
pdev
)

2041 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

2043 
	`shutdown_deviû
(
dd
);

2044 
	}
}

2055 
	$hfi1_ü—‹_rcvhdrq
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
)

2057 
amt
;

2059 ià(!
rcd
->
rcvhdrq
) {

2060 
gå_t
 
gå_æags
;

2062 
amt
 = 
	`rcvhdrq_size
(
rcd
);

2064 ià(
rcd
->
ùxt
 < 
dd
->
fœ¡_dyn_®loc_ùxt
 ||„cd->
is_vnic
)

2065 
gå_æags
 = 
GFP_KERNEL
;

2067 
gå_æags
 = 
GFP_USER
;

2068 
rcd
->
rcvhdrq
 = 
	`dma_®loc_coh”’t
(&
dd
->
pcidev
->
dev
, 
amt
,

2069 &
rcd
->
rcvhdrq_dma
,

2070 
gå_æags
 | 
__GFP_COMP
);

2072 ià(!
rcd
->
rcvhdrq
) {

2073 
	`dd_dev_”r
(
dd
,

2075 
amt
, 
rcd
->
ùxt
);

2076 
baž
;

2079 ià(
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
DMA_RTAIL
) ||

2080 
	`HFI1_CAP_UGET_MASK
(
rcd
->
æags
, 
DMA_RTAIL
)) {

2081 
rcd
->
rcvhd¹až_kvaddr
 = 
	`dma_®loc_coh”’t
(&
dd
->
pcidev
->
dev
,

2082 
PAGE_SIZE
,

2083 &
rcd
->
rcvhdrqžaddr_dma
,

2084 
gå_æags
);

2085 ià(!
rcd
->
rcvhd¹až_kvaddr
)

2086 
baž_ä“
;

2090 
	`£t_hdrq_»gs
(
rcd
->
dd
,„cd->
ùxt
,

2091 
rcd
->
rcvhdrq’tsize
,

2092 
rcd
->
rcvhdrq_út
);

2096 
baž_ä“
:

2097 
	`dd_dev_”r
(
dd
,

2099 
rcd
->
ùxt
);

2100 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, 
amt
, 
rcd
->
rcvhdrq
,

2101 
rcd
->
rcvhdrq_dma
);

2102 
rcd
->
rcvhdrq
 = 
NULL
;

2103 
baž
:

2104  -
ENOMEM
;

2105 
	}
}

2116 
	$hfi1_£tup_—g”bufs
(
hfi1_ùxtd©a
 *
rcd
)

2118 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

2119 
u32
 
max_’Œ›s
, 
eg¹Ý
, 
®loûd_by‹s
 = 0;

2120 
gå_t
 
gå_æags
;

2121 
u16
 
Üd”
, 
idx
 = 0;

2122 
»t
 = 0;

2123 
u16
 
round_mtu
 = 
	`roundup_pow_of_two
(
hfi1_max_mtu
);

2131 
gå_æags
 = 
__GFP_RECLAIM
 | 
__GFP_IO
 | 
__GFP_COMP
;

2140 ià(
rcd
->
egrbufs
.
size
 < (
round_mtu
 * 
dd
->
rcv_’Œ›s
.
group_size
))

2141 
rcd
->
egrbufs
.
size
 = 
round_mtu
 * 
dd
->
rcv_’Œ›s
.
group_size
;

2146 ià(!
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
MULTI_PKT_EGR
))

2147 
rcd
->
egrbufs
.
rcvtid_size
 = 
round_mtu
;

2153 ià(
rcd
->
egrbufs
.
size
 <= (1 << 20))

2154 
rcd
->
egrbufs
.
rcvtid_size
 = 
	`max
(()
round_mtu
,

2155 
	`rounddown_pow_of_two
(
rcd
->
egrbufs
.
size
 / 8));

2157 
®loûd_by‹s
 < 
rcd
->
egrbufs
.
size
 &&

2158 
rcd
->
egrbufs
.
®loûd
 <„cd->egrbufs.
couÁ
) {

2159 
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
 =

2160 
	`dma_®loc_coh”’t
(&
dd
->
pcidev
->
dev
,

2161 
rcd
->
egrbufs
.
rcvtid_size
,

2162 &
rcd
->
egrbufs
.
bufãrs
[
idx
].
dma
,

2163 
gå_æags
);

2164 ià(
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
) {

2165 
rcd
->
egrbufs
.
bufãrs
[
idx
].
Ën
 =

2166 
rcd
->
egrbufs
.
rcvtid_size
;

2167 
rcd
->
egrbufs
.
rcvtids
[rcd->egrbufs.
®loûd
].
addr
 =

2168 
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
;

2169 
rcd
->
egrbufs
.
rcvtids
[rcd->egrbufs.
®loûd
].
dma
 =

2170 
rcd
->
egrbufs
.
bufãrs
[
idx
].
dma
;

2171 
rcd
->
egrbufs
.
®loûd
++;

2172 
®loûd_by‹s
 +ð
rcd
->
egrbufs
.
rcvtid_size
;

2173 
idx
++;

2175 
u32
 
Ãw_size
, 
i
, 
j
;

2176 
u64
 
off£t
 = 0;

2184 ià(
rcd
->
egrbufs
.
rcvtid_size
 =ð
round_mtu
 ||

2185 !
	`HFI1_CAP_KGET_MASK
(
rcd
->
æags
, 
MULTI_PKT_EGR
)) {

2186 
	`dd_dev_”r
(
dd
, "ctxt%u: Failedo‡llocateƒager buffers\n",

2187 
rcd
->
ùxt
);

2188 
»t
 = -
ENOMEM
;

2189 
baž_rcvegrbuf_phys
;

2192 
Ãw_size
 = 
rcd
->
egrbufs
.
rcvtid_size
 / 2;

2199 ià(
idx
 == 0) {

2200 
rcd
->
egrbufs
.
rcvtid_size
 = 
Ãw_size
;

2208 
rcd
->
egrbufs
.
®loûd
 = 0;

2209 
i
 = 0, 
j
 = 0, 
off£t
 = 0; j < 
idx
; i++) {

2210 ià(
i
 >ð
rcd
->
egrbufs
.
couÁ
)

2212 
rcd
->
egrbufs
.
rcvtids
[
i
].
dma
 =

2213 
rcd
->
egrbufs
.
bufãrs
[
j
].
dma
 + 
off£t
;

2214 
rcd
->
egrbufs
.
rcvtids
[
i
].
addr
 =

2215 
rcd
->
egrbufs
.
bufãrs
[
j
].
addr
 + 
off£t
;

2216 
rcd
->
egrbufs
.
®loûd
++;

2217 ià((
rcd
->
egrbufs
.
bufãrs
[
j
].
dma
 + 
off£t
 +

2218 
Ãw_size
) ==

2219 (
rcd
->
egrbufs
.
bufãrs
[
j
].
dma
 +

2220 
rcd
->
egrbufs
.
bufãrs
[
j
].
Ën
)) {

2221 
j
++;

2222 
off£t
 = 0;

2224 
off£t
 +ð
Ãw_size
;

2227 
rcd
->
egrbufs
.
rcvtid_size
 = 
Ãw_size
;

2230 
rcd
->
egrbufs
.
numbufs
 = 
idx
;

2231 
rcd
->
egrbufs
.
size
 = 
®loûd_by‹s
;

2233 
	`hfi1_cdbg
(
PROC
,

2235 
rcd
->
ùxt
,„cd->
egrbufs
.
®loûd
,

2236 
rcd
->
egrbufs
.
rcvtid_size
 / 1024,„cd->egrbufs.
size
 / 1024);

2243 
rcd
->
egrbufs
.
th»shÞd
 =

2244 
	`rounddown_pow_of_two
(
rcd
->
egrbufs
.
®loûd
 / 2);

2250 
max_’Œ›s
 = 
rcd
->
rcv_¬¿y_groups
 * 
dd
->
rcv_’Œ›s
.
group_size
;

2251 
eg¹Ý
 = 
	`roundup
(
rcd
->
egrbufs
.
®loûd
, 
dd
->
rcv_’Œ›s
.
group_size
);

2252 
rcd
->
ex³ùed_couÁ
 = 
max_’Œ›s
 - 
eg¹Ý
;

2253 ià(
rcd
->
ex³ùed_couÁ
 > 
MAX_TID_PAIR_ENTRIES
 * 2)

2254 
rcd
->
ex³ùed_couÁ
 = 
MAX_TID_PAIR_ENTRIES
 * 2;

2256 
rcd
->
ex³ùed_ba£
 =„cd->
—g”_ba£
 + 
eg¹Ý
;

2257 
	`hfi1_cdbg
(
PROC
, "ctxt%u:ƒager:%u,ƒxp:%u,ƒgrbase:%u,ƒxpbase:%u\n",

2258 
rcd
->
ùxt
,„cd->
egrbufs
.
®loûd
,„cd->
ex³ùed_couÁ
,

2259 
rcd
->
—g”_ba£
,„cd->
ex³ùed_ba£
);

2261 ià(!
	`hfi1_rcvbuf_v®id©e
(
rcd
->
egrbufs
.
rcvtid_size
, 
PT_EAGER
, &
Üd”
)) {

2262 
	`hfi1_cdbg
(
PROC
,

2264 
rcd
->
ùxt
,„cd->
egrbufs
.
rcvtid_size
);

2265 
»t
 = -
EINVAL
;

2266 
baž_rcvegrbuf_phys
;

2269 
idx
 = 0; idx < 
rcd
->
egrbufs
.
®loûd
; idx++) {

2270 
	`hfi1_put_tid
(
dd
, 
rcd
->
—g”_ba£
 + 
idx
, 
PT_EAGER
,

2271 
rcd
->
egrbufs
.
rcvtids
[
idx
].
dma
, 
Üd”
);

2272 
	`cÚd_»sched
();

2277 
baž_rcvegrbuf_phys
:

2278 
idx
 = 0; idx < 
rcd
->
egrbufs
.
®loûd
 &&

2279 
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
;

2280 
idx
++) {

2281 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
,

2282 
rcd
->
egrbufs
.
bufãrs
[
idx
].
Ën
,

2283 
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
,

2284 
rcd
->
egrbufs
.
bufãrs
[
idx
].
dma
);

2285 
rcd
->
egrbufs
.
bufãrs
[
idx
].
addr
 = 
NULL
;

2286 
rcd
->
egrbufs
.
bufãrs
[
idx
].
dma
 = 0;

2287 
rcd
->
egrbufs
.
bufãrs
[
idx
].
Ën
 = 0;

2290  
»t
;

2291 
	}
}

	@intr.c

48 
	~<lšux/pci.h
>

49 
	~<lšux/d–ay.h
>

50 
	~<lšux/b™m­.h
>

52 
	~"hfi.h
"

53 
	~"commÚ.h
"

54 
	~"sdma.h
"

56 
	#LINK_UP_DELAY
 500

	)

64 
	$fÜm©_hwmsg
(*
msg
, 
size_t
 
msgl
, cÚ¡ *
hwmsg
)

66 
	`¡¾ÿt
(
msg
, "[", 
msgl
);

67 
	`¡¾ÿt
(
msg
, 
hwmsg
, 
msgl
);

68 
	`¡¾ÿt
(
msg
, "]", 
msgl
);

69 
	}
}

79 
	$hfi1_fÜm©_hw”rÜs
(
u64
 
hw”rs
, cÚ¡ 
hfi1_hw”rÜ_msgs
 *
hw”rmsgs
,

80 
size_t
 
nhw”rmsgs
, *
msg
, size_ˆ
msgl
)

82 
i
;

84 
i
 = 0; i < 
nhw”rmsgs
; i++)

85 ià(
hw”rs
 & 
hw”rmsgs
[
i
].
mask
)

86 
	`fÜm©_hwmsg
(
msg
, 
msgl
, 
hw”rmsgs
[
i
].msg);

87 
	}
}

89 
	$sigÇl_ib_ev’t
(
hfi1_µÜtd©a
 *
µd
, 
ib_ev’t_ty³
 
ev
)

91 
ib_ev’t
 
ev’t
;

92 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

99 ià(!(
dd
->
æags
 & 
HFI1_INITTED
))

101 
ev’t
.
deviû
 = &
dd
->
v”bs_dev
.
rdi
.
ibdev
;

102 
ev’t
.
–em’t
.
pÜt_num
 = 
µd
->
pÜt
;

103 
ev’t
.ev’ˆð
ev
;

104 
	`ib_di¥©ch_ev’t
(&
ev’t
);

105 
	}
}

118 
	$hªdË_lškup_chªge
(
hfi1_devd©a
 *
dd
, 
u32
 
lškup
)

120 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[0];

121 
ib_ev’t_ty³
 
ev
;

123 ià(!(
µd
->
lškup
 ^ !!linkup))

126 ià(
lškup
) {

141 ià(
quick_lškup
 || 
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
) {

142 
	`£t_up_vau
(
dd
, dd->
vau
);

143 
	`£t_up_vl15
(
dd
, dd->
vl15_š™
);

144 
	`assign_»mÙe_cm_au_bË
(
dd
, dd->
vcu
);

147 
µd
->
ÃighbÜ_guid
 =

148 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_REMOTE_GUID
);

149 
µd
->
ÃighbÜ_ty³
 =

150 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_REMOTE_NODE_TYPE
) &

151 
DC_DC8051_STS_REMOTE_NODE_TYPE_VAL_MASK
;

152 
µd
->
ÃighbÜ_pÜt_numb”
 =

153 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_REMOTE_PORT_NO
) &

154 
DC_DC8051_STS_REMOTE_PORT_NO_VAL_SMASK
;

155 
µd
->
ÃighbÜ_fm_£cur™y
 =

156 
	`»ad_c¤
(
dd
, 
DC_DC8051_STS_REMOTE_FM_SECURITY
) &

157 
DC_DC8051_STS_LOCAL_FM_SECURITY_DISABLED_MASK
;

158 
	`dd_dev_šfo
(
dd
,

160 
µd
->
ÃighbÜ_guid
,…pd->
ÃighbÜ_ty³
,

161 
µd
->
ÃighbÜ_pÜt_numb”
);

164 
	`ud–ay
(
LINK_UP_DELAY
);

167 
µd
->
lškup
 = 1;

168 
µd
->
ofæše_di§bËd_»asÚ
 =

169 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
);

172 
	`g‘_lškup_lšk_widths
(
µd
);

176 
µd
->
lškup
 = 0;

179 
µd
->
aùu®_vls_Ý”©iÚ®
 = 0;

180 
	`»£t_lšk_üed™s
(
dd
);

183 
	`¡¬t_ä“ze_hªdlšg
(
µd
, 
FREEZE_SELF
 | 
FREEZE_LINK_DOWN
);

185 
ev
 = 
IB_EVENT_PORT_ERR
;

187 
	`hfi1_£t_uev’t_b™s
(
µd
, 
_HFI1_EVENT_LINKDOWN_BIT
);

190 
µd
->
ÃighbÜ_nÜm®
 = 0;

193 
	`sigÇl_ib_ev’t
(
µd
, 
ev
);

195 
	}
}

201 
	$hªdË_u£r_š‹¼u±
(
hfi1_ùxtd©a
 *
rcd
)

203 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

204 
æags
;

206 
	`¥š_lock_œq§ve
(&
dd
->
uùxt_lock
, 
æags
);

207 ià(
	`b™m­_em±y
(
rcd
->
š_u£_ùxts
, 
HFI1_MAX_SHARED_CTXTS
))

208 
dÚe
;

210 ià(
	`‹¡_ªd_þ—r_b™
(
HFI1_CTXT_WAITING_RCV
, &
rcd
->
ev’t_æags
)) {

211 
	`wake_up_š‹¼u±ibË
(&
rcd
->
wa™
);

212 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_INTRAVAIL_DIS
, 
rcd
);

213 } ià(
	`‹¡_ªd_þ—r_b™
(
HFI1_CTXT_WAITING_URG
,

214 &
rcd
->
ev’t_æags
)) {

215 
rcd
->
urg’t
++;

216 
	`wake_up_š‹¼u±ibË
(&
rcd
->
wa™
);

218 
dÚe
:

219 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
uùxt_lock
, 
æags
);

220 
	}
}

	@iowait.c

47 
	~"iowa™.h
"

48 
	~"Œaû_iowa™.h
"

51 
	#IOWAIT_PRIORITY_STARVE_SHIFT
 4

	)

53 
	$iowa™_£t_æag
(
iowa™
 *
wa™
, 
u32
 
æag
)

55 
	`Œaû_hfi1_iowa™_£t
(
wa™
, 
æag
);

56 
	`£t_b™
(
æag
, &
wa™
->
æags
);

57 
	}
}

59 
boÞ
 
	$iowa™_æag_£t
(
iowa™
 *
wa™
, 
u32
 
æag
)

61  
	`‹¡_b™
(
æag
, &
wa™
->
æags
);

62 
	}
}

64 
šlše
 
	$iowa™_þ—r_æag
(
iowa™
 *
wa™
, 
u32
 
æag
)

66 
	`Œaû_hfi1_iowa™_þ—r
(
wa™
, 
æag
);

67 
	`þ—r_b™
(
æag
, &
wa™
->
æags
);

68 
	}
}

82 
iowa™_š™
(
iowa™
 *
wa™
, 
u32
 
tx_lim™
,

83 (*
func
)(
wÜk_¡ruù
 *
wÜk
),

84 (*
tidfunc
)(
wÜk_¡ruù
 *
wÜk
),

85 (*
¦“p
)(
sdma_’gše
 *
sde
,

86 
iowa™_wÜk
 *
wa™
,

87 
sdma_tx»q
 *
tx
,

88 
ušt
 
£q
,

89 
boÞ
 
pkts_£Á
),

90 (*
wakeup
)(
iowa™
 *
wa™
, 
»asÚ
),

91 (*
sdma_d¿šed
)(
iowa™
 *
wa™
),

92 (*
š™_´iÜ™y
)(
iowa™
 *
wa™
))

94 
i
;

96 
wa™
->
couÁ
 = 0;

97 
	`INIT_LIST_HEAD
(&
wa™
->
li¡
);

98 
	`š™_wa™queue_h—d
(&
wa™
->
wa™_dma
);

99 
	`š™_wa™queue_h—d
(&
wa™
->
wa™_pio
);

100 
	`©omic_£t
(&
wa™
->
sdma_busy
, 0);

101 
	`©omic_£t
(&
wa™
->
pio_busy
, 0);

102 
wa™
->
tx_lim™
 =x_limit;

103 
wa™
->
¦“p
 = sleep;

104 
wa™
->
wakeup
 = wakeup;

105 
wa™
->
sdma_d¿šed
 = sdma_drained;

106 
wa™
->
š™_´iÜ™y
 = init_priority;

107 
wa™
->
æags
 = 0;

108 
i
 = 0; i < 
IOWAIT_SES
; i++) {

109 
wa™
->wa™[
i
].
iow
 = wait;

110 
	`INIT_LIST_HEAD
(&
wa™
->wa™[
i
].
tx_h—d
);

111 ià(
i
 =ð
IOWAIT_IB_SE
)

112 
	`INIT_WORK
(&
wa™
->wa™[
i
].
iowÜk
, 
func
);

114 
	`INIT_WORK
(&
wa™
->wa™[
i
].
iowÜk
, 
tidfunc
);

116 
	}
}

122 
	$iowa™_ÿnûl_wÜk
(
iowa™
 *
w
)

124 
	`ÿnûl_wÜk_sync
(&
	`iowa™_g‘_ib_wÜk
(
w
)->
iowÜk
);

126 ià(
	`iowa™_g‘_tid_wÜk
(
w
)->
iowÜk
.
func
)

127 
	`ÿnûl_wÜk_sync
(&
	`iowa™_g‘_tid_wÜk
(
w
)->
iowÜk
);

128 
	}
}

134 
	$iowa™_£t_wÜk_æag
(
iowa™_wÜk
 *
w
)

136 ià(
w
 =ð&w->
iow
->
wa™
[
IOWAIT_IB_SE
]) {

137 
	`iowa™_£t_æag
(
w
->
iow
, 
IOWAIT_PENDING_IB
);

138  
IOWAIT_IB_SE
;

140 
	`iowa™_£t_æag
(
w
->
iow
, 
IOWAIT_PENDING_TID
);

141  
IOWAIT_TID_SE
;

142 
	}
}

155 
ušt
 
	$iowa™_´iÜ™y_upd©e_tÝ
(
iowa™
 *
w
,

156 
iowa™
 *
tÝ
,

157 
ušt
 
idx
, ušˆ
tÝ_idx
)

159 
u8
 
út
, 
tút
;

162 
út
 = (
w
->
´iÜ™y
 << 
IOWAIT_PRIORITY_STARVE_SHIFT
è+ w->
¡¬ved_út
;

163 
tút
 = (
tÝ
->
´iÜ™y
 << 
IOWAIT_PRIORITY_STARVE_SHIFT
) +

164 
tÝ
->
¡¬ved_út
;

165 ià(
út
 > 
tút
)

166  
idx
;

168  
tÝ_idx
;

169 
	}
}

	@iowait.h

1 #iâdeà
_HFI1_IOWAIT_H


2 
	#_HFI1_IOWAIT_H


	)

50 
	~<lšux/li¡.h
>

51 
	~<lšux/wÜkqueue.h
>

52 
	~<lšux/wa™.h
>

53 
	~<lšux/sched.h
>

55 
	~"sdma_tx»q.h
"

61 (*
	t»¡¬t_t
)(
	twÜk_¡ruù
 *
	twÜk
);

63 
	#IOWAIT_PENDING_IB
 0x0

	)

64 
	#IOWAIT_PENDING_TID
 0x1

	)

72 
	#IOWAIT_SES
 2

	)

73 
	#IOWAIT_IB_SE
 0

	)

74 
	#IOWAIT_TID_SE
 1

	)

76 
sdma_tx»q
;

77 
sdma_’gše
;

90 
iowa™
;

91 
	siowa™_wÜk
 {

92 
wÜk_¡ruù
 
iowÜk
;

93 
li¡_h—d
 
tx_h—d
;

94 
iowa™
 *
iow
;

139 
	siowa™
 {

140 
li¡_h—d
 
li¡
;

141 (*
¦“p
)(

142 
sdma_’gše
 *
sde
,

143 
iowa™_wÜk
 *
wa™
,

144 
sdma_tx»q
 *
tx
,

145 
ušt
 
£q
,

146 
boÞ
 
pkts_£Á


148 (*
wakeup
)(
iowa™
 *
wa™
, 
»asÚ
);

149 (*
sdma_d¿šed
)(
iowa™
 *
wa™
);

150 (*
š™_´iÜ™y
)(
iowa™
 *
wa™
);

151 
£qlock_t
 *
lock
;

152 
wa™_queue_h—d_t
 
wa™_dma
;

153 
wa™_queue_h—d_t
 
wa™_pio
;

154 
©omic_t
 
sdma_busy
;

155 
©omic_t
 
pio_busy
;

156 
u32
 
couÁ
;

157 
u32
 
tx_lim™
;

158 
u32
 
tx_couÁ
;

159 
u8
 
¡¬ved_út
;

160 
u8
 
´iÜ™y
;

161 
æags
;

162 
iowa™_wÜk
 
wa™
[
IOWAIT_SES
];

165 
	#SDMA_AVAIL_REASON
 0

	)

167 
	`iowa™_£t_æag
(
iowa™
 *
wa™
, 
u32
 
æag
);

168 
boÞ
 
	`iowa™_æag_£t
(
iowa™
 *
wa™
, 
u32
 
æag
);

169 
	`iowa™_þ—r_æag
(
iowa™
 *
wa™
, 
u32
 
æag
);

171 
	`iowa™_š™
(
iowa™
 *
wa™
, 
u32
 
tx_lim™
,

172 (*
func
)(
wÜk_¡ruù
 *
wÜk
),

173 (*
tidfunc
)(
wÜk_¡ruù
 *
wÜk
),

174 (*
¦“p
)(
sdma_’gše
 *
sde
,

175 
iowa™_wÜk
 *
wa™
,

176 
sdma_tx»q
 *
tx
,

177 
ušt
 
£q
,

178 
boÞ
 
pkts_£Á
),

179 (*
wakeup
)(
iowa™
 *
wa™
, 
»asÚ
),

180 (*
sdma_d¿šed
)(
iowa™
 *
wa™
),

181 (*
š™_´iÜ™y
)(
iowa™
 *
wa™
));

189 
šlše
 
boÞ
 
	$iowa™_scheduË
(
iowa™
 *
wa™
,

190 
wÜkqueue_¡ruù
 *
wq
, 
ýu
)

192  !!
	`queue_wÜk_Ú
(
ýu
, 
wq
, &
wa™
->wa™[
IOWAIT_IB_SE
].
iowÜk
);

193 
	}
}

201 
šlše
 
boÞ
 
	$iowa™_tid_scheduË
(
iowa™
 *
wa™
,

202 
wÜkqueue_¡ruù
 *
wq
, 
ýu
)

204  !!
	`queue_wÜk_Ú
(
ýu
, 
wq
, &
wa™
->wa™[
IOWAIT_TID_SE
].
iowÜk
);

205 
	}
}

214 
šlše
 
	$iowa™_sdma_d¿š
(
iowa™
 *
wa™
)

216 
	`wa™_ev’t
(
wa™
->
wa™_dma
, !
	`©omic_»ad
(&wa™->
sdma_busy
));

217 
	}
}

225 
šlše
 
	$iowa™_sdma_³ndšg
(
iowa™
 *
wa™
)

227  
	`©omic_»ad
(&
wa™
->
sdma_busy
);

228 
	}
}

234 
šlše
 
	$iowa™_sdma_šc
(
iowa™
 *
wa™
)

236 
	`©omic_šc
(&
wa™
->
sdma_busy
);

237 
	}
}

243 
šlše
 
	$iowa™_sdma_add
(
iowa™
 *
wa™
, 
couÁ
)

245 
	`©omic_add
(
couÁ
, &
wa™
->
sdma_busy
);

246 
	}
}

256 
šlše
 
	$iowa™_pio_d¿š
(
iowa™
 *
wa™
)

258 
	`wa™_ev’t_timeout
(
wa™
->
wa™_pio
,

259 !
	`©omic_»ad
(&
wa™
->
pio_busy
),

260 
HZ
);

261 
	}
}

269 
šlše
 
	$iowa™_pio_³ndšg
(
iowa™
 *
w
)

271  
	`©omic_»ad
(&
w
->
pio_busy
);

272 
	}
}

280 
šlše
 
	$iowa™_d¿š_wakeup
(
iowa™
 *
w
)

282 
	`wake_up
(&
w
->
wa™_dma
);

283 
	`wake_up
(&
w
->
wa™_pio
);

284 ià(
w
->
sdma_d¿šed
)

285 
w
->
	`sdma_d¿šed
(w);

286 
	}
}

292 
šlše
 
	$iowa™_pio_šc
(
iowa™
 *
wa™
)

294 
	`©omic_šc
(&
wa™
->
pio_busy
);

295 
	}
}

301 
šlše
 
	$iowa™_pio_dec
(
iowa™
 *
wa™
)

303 ià(!
wa™
)

305  
	`©omic_dec_ªd_‹¡
(&
wa™
->
pio_busy
);

306 
	}
}

312 
šlše
 
	$iowa™_sdma_dec
(
iowa™
 *
wa™
)

314 ià(!
wa™
)

316  
	`©omic_dec_ªd_‹¡
(&
wa™
->
sdma_busy
);

317 
	}
}

323 
šlše
 
sdma_tx»q
 *
	$iowa™_g‘_txh—d
(
iowa™_wÜk
 *
wa™
)

325 
sdma_tx»q
 *
tx
 = 
NULL
;

327 ià(!
	`li¡_em±y
(&
wa™
->
tx_h—d
)) {

328 
tx
 = 
	`li¡_fœ¡_’Œy
(

329 &
wa™
->
tx_h—d
,

330 
sdma_tx»q
,

331 
li¡
);

332 
	`li¡_d–_š™
(&
tx
->
li¡
);

334  
tx
;

335 
	}
}

337 
šlše
 
u16
 
	$iowa™_g‘_desc
(
iowa™_wÜk
 *
w
)

339 
u16
 
num_desc
 = 0;

340 
sdma_tx»q
 *
tx
 = 
NULL
;

342 ià(!
	`li¡_em±y
(&
w
->
tx_h—d
)) {

343 
tx
 = 
	`li¡_fœ¡_’Œy
(&
w
->
tx_h—d
, 
sdma_tx»q
,

344 
li¡
);

345 
num_desc
 = 
tx
->num_desc;

346 ià(
tx
->
æags
 & 
SDMA_TXREQ_F_VIP
)

347 
w
->
iow
->
´iÜ™y
++;

349  
num_desc
;

350 
	}
}

352 
šlše
 
u32
 
	$iowa™_g‘_®l_desc
(
iowa™
 *
w
)

354 
u32
 
num_desc
 = 0;

356 
num_desc
 = 
	`iowa™_g‘_desc
(&
w
->
wa™
[
IOWAIT_IB_SE
]);

357 
num_desc
 +ð
	`iowa™_g‘_desc
(&
w
->
wa™
[
IOWAIT_TID_SE
]);

358  
num_desc
;

359 
	}
}

361 
šlše
 
	$iowa™_upd©e_´iÜ™y
(
iowa™_wÜk
 *
w
)

363 
sdma_tx»q
 *
tx
 = 
NULL
;

365 ià(!
	`li¡_em±y
(&
w
->
tx_h—d
)) {

366 
tx
 = 
	`li¡_fœ¡_’Œy
(&
w
->
tx_h—d
, 
sdma_tx»q
,

367 
li¡
);

368 ià(
tx
->
æags
 & 
SDMA_TXREQ_F_VIP
)

369 
w
->
iow
->
´iÜ™y
++;

371 
	}
}

373 
šlše
 
	$iowa™_upd©e_®l_´iÜ™y
(
iowa™
 *
w
)

375 
	`iowa™_upd©e_´iÜ™y
(&
w
->
wa™
[
IOWAIT_IB_SE
]);

376 
	`iowa™_upd©e_´iÜ™y
(&
w
->
wa™
[
IOWAIT_TID_SE
]);

377 
	}
}

379 
šlše
 
	$iowa™_š™_´iÜ™y
(
iowa™
 *
w
)

381 
w
->
´iÜ™y
 = 0;

382 ià(
w
->
š™_´iÜ™y
)

383 
w
->
	`š™_´iÜ™y
(w);

384 
	}
}

386 
šlše
 
	$iowa™_g‘_´iÜ™y
(
iowa™
 *
w
)

388 
	`iowa™_š™_´iÜ™y
(
w
);

389 
	`iowa™_upd©e_®l_´iÜ™y
(
w
);

390 
	}
}

402 
šlše
 
	$iowa™_queue
(
boÞ
 
pkts_£Á
, 
iowa™
 *
w
,

403 
li¡_h—d
 *
wa™_h—d
)

411 ià(
pkts_£Á
)

412 
w
->
¡¬ved_út
 = 0;

414 
w
->
¡¬ved_út
++;

416 ià(
w
->
´iÜ™y
 > 0 || !
pkts_£Á
)

417 
	`li¡_add
(&
w
->
li¡
, 
wa™_h—d
);

419 
	`li¡_add_ž
(&
w
->
li¡
, 
wa™_h—d
);

420 
	}
}

430 
šlše
 
	$iowa™_¡¬ve_þ—r
(
boÞ
 
pkts_£Á
, 
iowa™
 *
w
)

432 ià(
pkts_£Á
)

433 
w
->
¡¬ved_út
 = 0;

434 
	}
}

437 
ušt
 
iowa™_´iÜ™y_upd©e_tÝ
(
iowa™
 *
w
,

438 
iowa™
 *
tÝ
,

439 
ušt
 
idx
, ušˆ
tÝ_idx
);

445 
šlše
 
boÞ
 
	$iowa™_·ck‘_queued
(
iowa™_wÜk
 *
w
)

447  !
	`li¡_em±y
(&
w
->
tx_h—d
);

448 
	}
}

455 
šlše
 
	$iowa™_šc_wa™_couÁ
(
iowa™_wÜk
 *
w
, 
u16
 
n
)

457 ià(!
w
)

459 
w
->
iow
->
tx_couÁ
++;

460 
w
->
iow
->
couÁ
 +ð
n
;

461 
	}
}

467 
šlše
 
iowa™_wÜk
 *
	$iowa™_g‘_tid_wÜk
(
iowa™
 *
w
)

469  &
w
->
wa™
[
IOWAIT_TID_SE
];

470 
	}
}

476 
šlše
 
iowa™_wÜk
 *
	$iowa™_g‘_ib_wÜk
(
iowa™
 *
w
)

478  &
w
->
wa™
[
IOWAIT_IB_SE
];

479 
	}
}

485 
šlše
 
iowa™
 *
	$iowa™_ioww_to_iow
(
iowa™_wÜk
 *
w
)

487 ià(
	`lik–y
(
w
))

488  
w
->
iow
;

489  
NULL
;

490 
	}
}

492 
iowa™_ÿnûl_wÜk
(
iowa™
 *
w
);

493 
iowa™_£t_wÜk_æag
(
iowa™_wÜk
 *
w
);

	@ipoib.h

53 #iâdeà
HFI1_IPOIB_H


54 
	#HFI1_IPOIB_H


	)

56 
	~<lšux/ty³s.h
>

57 
	~<lšux/¡ddef.h
>

58 
	~<lšux/©omic.h
>

59 
	~<lšux/Ãtdeviû.h
>

60 
	~<lšux/¦ab.h
>

61 
	~<lšux/skbuff.h
>

62 
	~<lšux/li¡.h
>

63 
	~<lšux/if_šfšibªd.h
>

65 
	~"hfi.h
"

66 
	~"iowa™.h
"

67 
	~"Ãtdev.h
"

69 
	~<rdma/ib_v”bs.h
>

71 
	#HFI1_IPOIB_TXREQ_NAME_LEN
 32

	)

73 
	#HFI1_IPOIB_PSEUDO_LEN
 20

	)

74 
	#HFI1_IPOIB_ENCAP_LEN
 4

	)

76 
	ghfi1_oib_dev_´iv
;

78 
	uhfi1_oib_æow
 {

79 
u16
 
	mas_št
;

81 
u8
 
	mtx_queue
;

82 
u8
 
	msc5
;

83 } 
__©Œibu‹__
((
__·cked__
));

95 
	goib_tx»q
;

96 
	shfi1_oib_cœc_buf
 {

97 
oib_tx»q
 **
	m™ems
;

98 
	mh—d
;

99 
	mž
;

100 
	mmax_™ems
;

101 
¥šlock_t
 
	m´oduûr_lock
;

102 
¥šlock_t
 
	mcÚsum”_lock
;

122 
	shfi1_oib_txq
 {

123 
hfi1_oib_dev_´iv
 *
	m´iv
;

124 
sdma_’gše
 *
	msde
;

125 
li¡_h—d
 
	mtx_li¡
;

126 
u64
 
	m£Á_tx»qs
;

127 
©omic_t
 
	m¡Ýs
;

128 
©omic_t
 
	mršg_fuÎ
;

129 
©omic_t
 
	mno_desc
;

130 
hfi1_oib_æow
 
	mæow
;

131 
u8
 
	mq_idx
;

132 
boÞ
 
	mpkts_£Á
;

133 
iowa™
 
	mwa™
;

135 
©omic64_t
 
____ÿch–še_®igÃd_š_smp
 
	mcom¶‘e_tx»qs
;

136 
Çpi_¡ruù
 *
	mÇpi
;

137 
hfi1_oib_cœc_buf
 
	mtx_ršg
;

140 
	shfi1_oib_dev_´iv
 {

141 
hfi1_devd©a
 *
	mdd
;

142 
Ãt_deviû
 *
	mÃtdev
;

143 
ib_deviû
 *
	mdeviû
;

144 
hfi1_oib_txq
 *
	mtxqs
;

145 
kmem_ÿche
 *
	mtx»q_ÿche
;

146 
Çpi_¡ruù
 *
	mtx_Çpis
;

147 
u16
 
	mpkey
;

148 
u16
 
	mpkey_šdex
;

149 
u32
 
	mqkey
;

150 
u8
 
	mpÜt_num
;

152 cÚ¡ 
Ãt_deviû_Ýs
 *
	mÃtdev_Ýs
;

153 
rvt_qp
 *
	mqp
;

154 
pýu_sw_Ãt¡©s
 
__³rýu
 *
	mÃt¡©s
;

158 
	shfi1_oib_rdma_Ãtdev
 {

159 
rdma_Ãtdev
 
	mº
;

161 
hfi1_oib_dev_´iv
 
	mdev_´iv
;

164 
šlše
 
hfi1_oib_dev_´iv
 *

165 
	$hfi1_oib_´iv
(cÚ¡ 
Ãt_deviû
 *
dev
)

167  &((
hfi1_oib_rdma_Ãtdev
 *)
	`Ãtdev_´iv
(
dev
))->
dev_´iv
;

168 
	}
}

170 
šlše
 

171 
	$hfi1_oib_upd©e_rx_Ãt¡©s
(
hfi1_oib_dev_´iv
 *
´iv
,

172 
u64
 
·ck‘s
,

173 
u64
 
by‹s
)

175 
pýu_sw_Ãt¡©s
 *
Ãt¡©s
 = 
	`this_ýu_±r
(
´iv
->netstats);

177 
	`u64_¡©s_upd©e_begš
(&
Ãt¡©s
->
syný
);

178 
Ãt¡©s
->
rx_·ck‘s
 +ð
·ck‘s
;

179 
Ãt¡©s
->
rx_by‹s
 +ð
by‹s
;

180 
	`u64_¡©s_upd©e_’d
(&
Ãt¡©s
->
syný
);

181 
	}
}

183 
šlše
 

184 
	$hfi1_oib_upd©e_tx_Ãt¡©s
(
hfi1_oib_dev_´iv
 *
´iv
,

185 
u64
 
·ck‘s
,

186 
u64
 
by‹s
)

188 
pýu_sw_Ãt¡©s
 *
Ãt¡©s
 = 
	`this_ýu_±r
(
´iv
->netstats);

190 
	`u64_¡©s_upd©e_begš
(&
Ãt¡©s
->
syný
);

191 
Ãt¡©s
->
tx_·ck‘s
 +ð
·ck‘s
;

192 
Ãt¡©s
->
tx_by‹s
 +ð
by‹s
;

193 
	`u64_¡©s_upd©e_’d
(&
Ãt¡©s
->
syný
);

194 
	}
}

196 
hfi1_oib_£nd
(
Ãt_deviû
 *
dev
,

197 
sk_buff
 *
skb
,

198 
ib_ah
 *
add»ss
,

199 
u32
 
dq²
);

201 
hfi1_oib_tx»q_š™
(
hfi1_oib_dev_´iv
 *
´iv
);

202 
hfi1_oib_tx»q_deš™
(
hfi1_oib_dev_´iv
 *
´iv
);

204 
hfi1_oib_rxq_š™
(
Ãt_deviû
 *
dev
);

205 
hfi1_oib_rxq_deš™
(
Ãt_deviû
 *
dev
);

207 
hfi1_oib_Çpi_tx_’abË
(
Ãt_deviû
 *
dev
);

208 
hfi1_oib_Çpi_tx_di§bË
(
Ãt_deviû
 *
dev
);

210 
Ãt_deviû
 *
hfi1_oib_®loc_º
(
ib_deviû
 *
deviû
,

211 
u8
 
pÜt_num
,

212 
rdma_Ãtdev_t
 
ty³
,

213 cÚ¡ *
Çme
,

214 
Çme_assign_ty³
,

215 (*
£tup
)(
Ãt_deviû
 *));

217 
sk_buff
 *
	`hfi1_oib_´•¬e_skb
(
hfi1_Ãtdev_rxq
 *
rxq
,

218 
size
, *
d©a
);

220 #ifdeà
HAVE_RDMA_NETDEV_GET_PARAMS


221 
	`hfi1_oib_º_g‘_·¿ms
(
ib_deviû
 *
deviû
,

222 
u8
 
pÜt_num
,

223 
rdma_Ãtdev_t
 
ty³
,

224 
rdma_Ãtdev_®loc_·¿ms
 *
·¿ms
);

	@ipoib_main.c

53 
	~<lšux/moduË.h
>

54 
	~"oib.h
"

55 
	~"hfi.h
"

56 
	~"Ãtdev.h
"

58 #ifdeà
AIP


59 
ušt
 
	goib_acûl
 = 1;

60 
moduË_·¿m
(
oib_acûl
, 
ušt
, 0644);

61 
MODULE_PARM_DESC
(
oib_acûl
, "Accelerated ipoib mode");

63 
ušt
 
	goib_acûl
 = 0;

65 
EXPORT_SYMBOL
(
oib_acûl
);

67 
u32
 
	$q²_äom_mac
(
u8
 *
mac_¬r
)

69  (
u32
)
mac_¬r
[1] << 16 | mac_arr[2] << 8 | mac_arr[3];

70 
	}
}

72 
	$hfi1_oib_dev_š™
(
Ãt_deviû
 *
dev
)

74 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

75 
»t
;

77 
´iv
->
Ãt¡©s
 = 
	`Ãtdev_®loc_pýu_¡©s
(
pýu_sw_Ãt¡©s
);

79 
»t
 = 
´iv
->
Ãtdev_Ýs
->
	`ndo_š™
(
dev
);

80 ià(
»t
)

81  
»t
;

83 
»t
 = 
	`hfi1_Ãtdev_add_d©a
(
´iv
->
dd
,

84 
	`q²_äom_mac
(
´iv
->
Ãtdev
->
dev_addr
),

85 
dev
);

86 ià(
»t
 < 0) {

87 
´iv
->
Ãtdev_Ýs
->
	`ndo_unš™
(
dev
);

88  
»t
;

92 
	}
}

94 
	$hfi1_oib_dev_unš™
(
Ãt_deviû
 *
dev
)

96 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

98 
	`hfi1_Ãtdev_»move_d©a
(
´iv
->
dd
, 
	`q²_äom_mac
Õriv->
Ãtdev
->
dev_addr
));

100 
´iv
->
Ãtdev_Ýs
->
	`ndo_unš™
(
dev
);

101 
	}
}

103 
	$hfi1_oib_dev_Ý’
(
Ãt_deviû
 *
dev
)

105 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

106 
»t
;

108 
»t
 = 
´iv
->
Ãtdev_Ýs
->
	`ndo_Ý’
(
dev
);

109 ià(!
»t
) {

110 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
´iv
->
deviû
,

111 
´iv
->
pÜt_num
);

112 
rvt_qp
 *
qp
;

113 
u32
 
q²
 = 
	`q²_äom_mac
(
´iv
->
Ãtdev
->
dev_addr
);

115 
	`rcu_»ad_lock
();

116 
qp
 = 
	`rvt_lookup_q²
(
	`ib_to_rvt
(
´iv
->
deviû
), &
ibp
->
rvp
, 
q²
);

117 
	`rvt_g‘_qp
(
qp
);

118 
´iv
->
qp
 = qp;

119 
	`rcu_»ad_uÆock
();

121 
	`hfi1_Ãtdev_’abË_queues
(
´iv
->
dd
);

122 
	`hfi1_oib_Çpi_tx_’abË
(
dev
);

125  
»t
;

126 
	}
}

128 
	$hfi1_oib_dev_¡Ý
(
Ãt_deviû
 *
dev
)

130 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

132 ià(!
´iv
->
qp
)

135 
	`hfi1_oib_Çpi_tx_di§bË
(
dev
);

136 
	`hfi1_Ãtdev_di§bË_queues
(
´iv
->
dd
);

138 
	`rvt_put_qp
(
´iv
->
qp
);

139 
´iv
->
qp
 = 
NULL
;

141  
´iv
->
Ãtdev_Ýs
->
	`ndo_¡Ý
(
dev
);

142 
	}
}

144 
	$hfi1_oib_dev_g‘_¡©s64
(
Ãt_deviû
 *
dev
,

145 
¹Æ_lšk_¡©s64
 *
¡Üage
)

147 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

148 
u64
 
rx_·ck‘s
 = 0ull;

149 
u64
 
rx_by‹s
 = 0ull;

150 
u64
 
tx_·ck‘s
 = 0ull;

151 
u64
 
tx_by‹s
 = 0ull;

152 
i
;

154 
	`Ãtdev_¡©s_to_¡©s64
(
¡Üage
, &
dev
->
¡©s
);

156 
	`fÜ_—ch_possibË_ýu
(
i
) {

157 cÚ¡ 
pýu_sw_Ãt¡©s
 *
¡©s
;

158 
¡¬t
;

159 
u64
 
Œx_·ck‘s
;

160 
u64
 
Œx_by‹s
;

161 
u64
 
‰x_·ck‘s
;

162 
u64
 
‰x_by‹s
;

164 
¡©s
 = 
	`³r_ýu_±r
(
´iv
->
Ãt¡©s
, 
i
);

166 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&
¡©s
->
syný
);

167 
Œx_·ck‘s
 = 
¡©s
->
rx_·ck‘s
;

168 
Œx_by‹s
 = 
¡©s
->
rx_by‹s
;

169 
‰x_·ck‘s
 = 
¡©s
->
tx_·ck‘s
;

170 
‰x_by‹s
 = 
¡©s
->
tx_by‹s
;

171 } 
	`u64_¡©s_ãtch_»Œy_œq
(&
¡©s
->
syný
, 
¡¬t
));

173 
rx_·ck‘s
 +ð
Œx_·ck‘s
;

174 
rx_by‹s
 +ð
Œx_by‹s
;

175 
tx_·ck‘s
 +ð
‰x_·ck‘s
;

176 
tx_by‹s
 +ð
‰x_by‹s
;

179 
¡Üage
->
rx_·ck‘s
 +=„x_packets;

180 
¡Üage
->
rx_by‹s
 +=„x_bytes;

181 
¡Üage
->
tx_·ck‘s
 +=x_packets;

182 
¡Üage
->
tx_by‹s
 +=x_bytes;

183 
	}
}

185 cÚ¡ 
Ãt_deviû_Ýs
 
	ghfi1_oib_Ãtdev_Ýs
 = {

186 .
ndo_š™
 = 
hfi1_oib_dev_š™
,

187 .
	gndo_unš™
 = 
hfi1_oib_dev_unš™
,

188 .
	gndo_Ý’
 = 
hfi1_oib_dev_Ý’
,

189 .
	gndo_¡Ý
 = 
hfi1_oib_dev_¡Ý
,

190 .
	gndo_g‘_¡©s64
 = 
hfi1_oib_dev_g‘_¡©s64
,

193 
	$hfi1_oib_mÿ¡_©ch
(
Ãt_deviû
 *
dev
,

194 
ib_deviû
 *
deviû
,

195 
ib_gid
 *
mgid
,

196 
u16
 
mlid
,

197 
£t_qkey
,

198 
u32
 
qkey
)

200 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

201 
u32
 
q²
 = (u32)
	`q²_äom_mac
(
´iv
->
Ãtdev
->
dev_addr
);

202 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
´iv
->
deviû
,…riv->
pÜt_num
);

203 
rvt_qp
 *
qp
;

204 
»t
 = -
EINVAL
;

206 
	`rcu_»ad_lock
();

208 
qp
 = 
	`rvt_lookup_q²
(
	`ib_to_rvt
(
´iv
->
deviû
), &
ibp
->
rvp
, 
q²
);

209 ià(
qp
) {

210 
	`rvt_g‘_qp
(
qp
);

211 
	`rcu_»ad_uÆock
();

212 ià(
£t_qkey
)

213 
´iv
->
qkey
 = qkey;

216 
»t
 = 
	`ib_©ch_mÿ¡
(&
qp
->
ibqp
, 
mgid
, 
mlid
);

217 
	`rvt_put_qp
(
qp
);

219 
	`rcu_»ad_uÆock
();

222  
»t
;

223 
	}
}

225 
	$hfi1_oib_mÿ¡_d‘ach
(
Ãt_deviû
 *
dev
,

226 
ib_deviû
 *
deviû
,

227 
ib_gid
 *
mgid
,

228 
u16
 
mlid
)

230 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

231 
u32
 
q²
 = (u32)
	`q²_äom_mac
(
´iv
->
Ãtdev
->
dev_addr
);

232 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
´iv
->
deviû
,…riv->
pÜt_num
);

233 
rvt_qp
 *
qp
;

234 
»t
 = -
EINVAL
;

236 
	`rcu_»ad_lock
();

238 
qp
 = 
	`rvt_lookup_q²
(
	`ib_to_rvt
(
´iv
->
deviû
), &
ibp
->
rvp
, 
q²
);

239 ià(
qp
) {

240 
	`rvt_g‘_qp
(
qp
);

241 
	`rcu_»ad_uÆock
();

242 
»t
 = 
	`ib_d‘ach_mÿ¡
(&
qp
->
ibqp
, 
mgid
, 
mlid
);

243 
	`rvt_put_qp
(
qp
);

245 
	`rcu_»ad_uÆock
();

247  
»t
;

248 
	}
}

250 
	$hfi1_oib_Ãtdev_dtÜ
(
Ãt_deviû
 *
dev
)

252 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

254 
	`hfi1_oib_tx»q_deš™
(
´iv
);

255 
	`hfi1_oib_rxq_deš™
(
´iv
->
Ãtdev
);

257 
	`ä“_³rýu
(
´iv
->
Ãt¡©s
);

258 
	}
}

260 
	$hfi1_oib_ä“_rdma_Ãtdev
(
Ãt_deviû
 *
dev
)

262 
	`hfi1_oib_Ãtdev_dtÜ
(
dev
);

263 
	`ä“_Ãtdev
(
dev
);

264 
	}
}

266 
	$hfi1_oib_£t_id
(
Ãt_deviû
 *
dev
, 
id
)

268 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

270 
´iv
->
pkey_šdex
 = (
u16
)
id
;

271 
	`ib_qu”y_pkey
(
´iv
->
deviû
,

272 
´iv
->
pÜt_num
,

273 
´iv
->
pkey_šdex
,

274 &
´iv
->
pkey
);

275 
	}
}

277 
Ãt_deviû
 *
hfi1_oib_®loc_º
(
ib_deviû
 *
deviû
,

278 
u8
 
pÜt_num
,

279 
rdma_Ãtdev_t
 
ty³
,

280 cÚ¡ *
Çme
,

281 
Çme_assign_ty³
,

282 (*
£tup
)(
Ãt_deviû
 *))

284 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
deviû
);

285 
Ãt_deviû
 *
dev
;

286 
rdma_Ãtdev
 *
º
;

287 
hfi1_oib_dev_´iv
 *
´iv
;

288 
rc
;

290 ià(!
oib_acûl
)

291  
	`ERR_PTR
(-
EOPNOTSUPP
);

293 ià(!
pÜt_num
 ||…Üt_num > 
dd
->
num_µÜts
)

294  
	`ERR_PTR
(-
EINVAL
);

296 
dev
 = 
	`®loc_Ãtdev_mqs
(()(
hfi1_oib_rdma_Ãtdev
),

297 
Çme
,

298 
Çme_assign_ty³
,

299 
£tup
,

300 
dd
->
num_sdma
,

301 
dd
->
num_Ãtdev_cÚ‹xts
);

302 ià(!
dev
)

303  
	`ERR_PTR
(-
ENOMEM
);

305 ià(!
dev
->
Ãtdev_Ýs
) {

306 
	`ä“_Ãtdev
(
dev
);

307  
	`ERR_PTR
(-
EOPNOTSUPP
);

310 ià(!
dev
->
Ãtdev_Ýs
->
ndo_š™
 || !dev->Ãtdev_Ýs->
ndo_unš™
 ||

311 !
dev
->
Ãtdev_Ýs
->
ndo_Ý’
 || !dev->Ãtdev_Ýs->
ndo_¡Ý
) {

312 
	`ä“_Ãtdev
(
dev
);

313  
	`ERR_PTR
(-
EOPNOTSUPP
);

316 
º
 = 
	`Ãtdev_´iv
(
dev
);

318 
º
->
£nd
 = 
hfi1_oib_£nd
;

319 
º
->
©ch_mÿ¡
 = 
hfi1_oib_mÿ¡_©ch
;

320 
º
->
d‘ach_mÿ¡
 = 
hfi1_oib_mÿ¡_d‘ach
;

321 
º
->
£t_id
 = 
hfi1_oib_£t_id
;

322 
º
->
ä“_rdma_Ãtdev
 = 
hfi1_oib_ä“_rdma_Ãtdev
;

323 
º
->
hÿ
 = 
deviû
;

324 
º
->
pÜt_num
 =…ort_num;

325 
º
->
mtu
 = 
dev
->mtu;

327 
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

328 
´iv
->
dd
 = dd;

329 
´iv
->
Ãtdev
 = 
dev
;

330 
´iv
->
deviû
 = device;

331 
´iv
->
pÜt_num
 =…ort_num;

332 
´iv
->
Ãtdev_Ýs
 = 
dev
->netdev_ops;

334 
dev
->
Ãtdev_Ýs
 = &
hfi1_oib_Ãtdev_Ýs
;

336 
	`ib_qu”y_pkey
(
deviû
, 
pÜt_num
, 
´iv
->
pkey_šdex
, &´iv->
pkey
);

338 
rc
 = 
	`hfi1_oib_tx»q_š™
(
´iv
);

339 ià(
rc
) {

340 
	`dd_dev_”r
(
dd
, "IPoIB‚‘dev TX in™ - fažed(%d)\n", 
rc
);

341 
	`hfi1_oib_ä“_rdma_Ãtdev
(
dev
);

342  
	`ERR_PTR
(
rc
);

345 
rc
 = 
	`hfi1_oib_rxq_š™
(
dev
);

346 ià(
rc
) {

347 
	`dd_dev_”r
(
dd
, "IPoIB‚‘dev RX in™ - fažed(%d)\n", 
rc
);

348 
	`hfi1_oib_ä“_rdma_Ãtdev
(
dev
);

349  
	`ERR_PTR
(
rc
);

351  
dev
;

352 
	}
}

354 #ifdeà
HAVE_RDMA_NETDEV_GET_PARAMS


355 
	$hfi1_oib_£tup_º
(
ib_deviû
 *
deviû
,

356 
u8
 
pÜt_num
,

357 
Ãt_deviû
 *
Ãtdev
,

358 *
·¿m
)

360 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
deviû
);

361 
rdma_Ãtdev
 *
º
 = 
	`Ãtdev_´iv
(
Ãtdev
);

362 
hfi1_oib_dev_´iv
 *
´iv
;

363 
rc
;

365 
º
->
£nd
 = 
hfi1_oib_£nd
;

366 
º
->
©ch_mÿ¡
 = 
hfi1_oib_mÿ¡_©ch
;

367 
º
->
d‘ach_mÿ¡
 = 
hfi1_oib_mÿ¡_d‘ach
;

368 
º
->
£t_id
 = 
hfi1_oib_£t_id
;

369 
º
->
hÿ
 = 
deviû
;

370 
º
->
pÜt_num
 =…ort_num;

371 
º
->
mtu
 = 
Ãtdev
->mtu;

373 
´iv
 = 
	`hfi1_oib_´iv
(
Ãtdev
);

374 
´iv
->
dd
 = dd;

375 
´iv
->
Ãtdev
 =‚etdev;

376 
´iv
->
deviû
 = device;

377 
´iv
->
pÜt_num
 =…ort_num;

378 
´iv
->
Ãtdev_Ýs
 = 
Ãtdev
->netdev_ops;

380 
Ãtdev
->
Ãtdev_Ýs
 = &
hfi1_oib_Ãtdev_Ýs
;

382 
	`ib_qu”y_pkey
(
deviû
, 
pÜt_num
, 
´iv
->
pkey_šdex
, &´iv->
pkey
);

384 
rc
 = 
	`hfi1_oib_tx»q_š™
(
´iv
);

385 ià(
rc
) {

386 
	`dd_dev_”r
(
dd
, "IPoIB‚‘dev TX in™ - fažed(%d)\n", 
rc
);

387 
	`hfi1_oib_ä“_rdma_Ãtdev
(
Ãtdev
);

388  
rc
;

391 
rc
 = 
	`hfi1_oib_rxq_š™
(
Ãtdev
);

392 ià(
rc
) {

393 
	`dd_dev_”r
(
dd
, "IPoIB‚‘dev RX in™ - fažed(%d)\n", 
rc
);

394 
	`hfi1_oib_ä“_rdma_Ãtdev
(
Ãtdev
);

395  
rc
;

398 #ifdeà
HAVE_NET_DEVICE_EXTENDED


399 
Ãtdev
->
ex‹nded
->
´iv_de¡ruùÜ
 = 
hfi1_oib_Ãtdev_dtÜ
;

400 
Ãtdev
->
ex‹nded
->
Ãeds_ä“_Ãtdev
 = 
Œue
;

402 
Ãtdev
->
´iv_de¡ruùÜ
 = 
hfi1_oib_Ãtdev_dtÜ
;

403 
Ãtdev
->
Ãeds_ä“_Ãtdev
 = 
Œue
;

407 
	}
}

409 
	$hfi1_oib_º_g‘_·¿ms
(
ib_deviû
 *
deviû
,

410 
u8
 
pÜt_num
,

411 
rdma_Ãtdev_t
 
ty³
,

412 
rdma_Ãtdev_®loc_·¿ms
 *
·¿ms
)

414 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
deviû
);

416 ià(
ty³
 !ð
RDMA_NETDEV_IPOIB
)

417  -
EOPNOTSUPP
;

419 ià(!
oib_acûl
 || !
dd
->
num_Ãtdev_cÚ‹xts
)

420  -
EOPNOTSUPP
;

422 ià(!
pÜt_num
 ||…Üt_num > 
dd
->
num_µÜts
)

423  -
EINVAL
;

425 
·¿ms
->
sizeof_´iv
 = (
hfi1_oib_rdma_Ãtdev
);

426 
·¿ms
->
txqs
 = 
dd
->
num_sdma
;

427 
·¿ms
->
rxqs
 = 
dd
->
num_Ãtdev_cÚ‹xts
;

428 
·¿ms
->
·¿m
 = 
NULL
;

429 
·¿ms
->
š™Ÿlize_rdma_Ãtdev
 = 
hfi1_oib_£tup_º
;

432 
	}
}

	@ipoib_rx.c

49 
	~"Ãtdev.h
"

50 
	~"oib.h
"

52 
	#HFI1_IPOIB_SKB_PAD
 
NET_SKB_PAD
 + 
NET_IP_ALIGN


	)

54 
	$cÝy_oib_buf
(
sk_buff
 *
skb
, *
d©a
, 
size
)

56 *
d¡_d©a
;

58 
	`skb_checksum_nÚe_as£¹
(
skb
);

59 
skb
->
´ÙocÞ
 = *((
__be16
 *)
d©a
);

61 
d¡_d©a
 = 
	`skb_put
(
skb
, 
size
);

62 
	`memýy
(
d¡_d©a
, 
d©a
, 
size
);

63 
skb
->
mac_h—d”
 = 
HFI1_IPOIB_PSEUDO_LEN
;

64 
	`skb_puÎ
(
skb
, 
HFI1_IPOIB_ENCAP_LEN
);

65 
	}
}

67 
sk_buff
 *
	$´•¬e_äag_skb
(
Çpi_¡ruù
 *
Çpi
, 
size
)

69 
sk_buff
 *
skb
;

70 
skb_size
 = 
	`SKB_DATA_ALIGN
(
size
 + 
HFI1_IPOIB_SKB_PAD
);

71 *
äag
;

73 
skb_size
 +ð
	`SKB_DATA_ALIGN
((
skb_sh¬ed_šfo
));

74 
skb_size
 = 
	`SKB_DATA_ALIGN
(skb_size);

75 
äag
 = 
	`Çpi_®loc_äag
(
skb_size
);

77 ià(
	`uÆik–y
(!
äag
))

78  
	`Çpi_®loc_skb
(
Çpi
, 
size
);

80 
skb
 = 
	`bužd_skb
(
äag
, 
skb_size
);

82 ià(
	`uÆik–y
(!
skb
)) {

83 
	`skb_ä“_äag
(
äag
);

84  
NULL
;

87 
	`skb_»£rve
(
skb
, 
HFI1_IPOIB_SKB_PAD
);

88  
skb
;

89 
	}
}

91 
sk_buff
 *
	$hfi1_oib_´•¬e_skb
(
hfi1_Ãtdev_rxq
 *
rxq
,

92 
size
, *
d©a
)

94 
Çpi_¡ruù
 *
Çpi
 = &
rxq
->napi;

95 
skb_size
 = 
size
 + 
HFI1_IPOIB_ENCAP_LEN
;

96 
sk_buff
 *
skb
;

102 ià(
size
 <ð
	`SKB_WITH_OVERHEAD
(
PAGE_SIZE
))

103 
skb
 = 
	`Çpi_®loc_skb
(
Çpi
, 
skb_size
);

105 
skb
 = 
	`´•¬e_äag_skb
(
Çpi
, 
skb_size
);

107 ià(
	`uÆik–y
(!
skb
))

108  
NULL
;

110 
	`cÝy_oib_buf
(
skb
, 
d©a
, 
size
);

112  
skb
;

113 
	}
}

115 
	$hfi1_oib_rxq_š™
(
Ãt_deviû
 *
Ãtdev
)

117 
hfi1_oib_dev_´iv
 *
oib_´iv
 = 
	`hfi1_oib_´iv
(
Ãtdev
);

118 
hfi1_devd©a
 *
dd
 = 
oib_´iv
->dd;

119 
»t
;

121 
»t
 = 
	`hfi1_Ãtdev_rx_š™
(
dd
);

122 ià(
»t
)

123  
»t
;

125 
	`hfi1_š™_a_rsm
(
dd
);

127  
»t
;

128 
	}
}

130 
	$hfi1_oib_rxq_deš™
(
Ãt_deviû
 *
Ãtdev
)

132 
hfi1_oib_dev_´iv
 *
oib_´iv
 = 
	`hfi1_oib_´iv
(
Ãtdev
);

133 
hfi1_devd©a
 *
dd
 = 
oib_´iv
->dd;

135 
	`hfi1_deš™_a_rsm
(
dd
);

136 
	`hfi1_Ãtdev_rx_de¡roy
(
dd
);

137 
	}
}

	@ipoib_tx.c

53 
	~<lšux/log2.h
>

54 
	~<lšux/cœc_buf.h
>

56 
	~"sdma.h
"

57 
	~"v”bs.h
"

58 
	~"Œaû_ibhdrs.h
"

59 
	~"oib.h
"

60 
	~"Œaû_tx.h
"

63 
	#CIRC_ADD
(
v®
, 
add
, 
size
è(((v®è+ (add)è& ((sizeè- 1))

	)

64 
	#CIRC_NEXT
(
v®
, 
size
è
	`CIRC_ADD
(v®, 1, size)

	)

65 
	#CIRC_PREV
(
v®
, 
size
è
	`CIRC_ADD
(v®, -1, size)

	)

76 
	soib_tx»q
 {

77 
sdma_tx»q
 
	mtx»q
;

78 
hfi1_sdma_h—d”
 
	msdma_hdr
;

79 
	msdma_¡©us
;

80 
hfi1_oib_dev_´iv
 *
	m´iv
;

81 
hfi1_oib_txq
 *
	mtxq
;

82 
sk_buff
 *
	mskb
;

85 
	soib_tx·rms
 {

86 
hfi1_devd©a
 *
	mdd
;

87 
rdma_ah_©Œ
 *
	mah_©Œ
;

88 
hfi1_ibpÜt
 *
	mibp
;

89 
hfi1_oib_txq
 *
	mtxq
;

90 
hfi1_oib_æow
 
	mæow
;

91 
u32
 
	mdq²
;

92 
u8
 
	mhdr_dwÜds
;

93 
u8
 
	m’ŒÝy
;

96 
u64
 
	$hfi1_oib_tx»qs
(cÚ¡ 
u64
 
£Á
, cÚ¡ u64 
com¶‘ed
)

98  
£Á
 - 
com¶‘ed
;

99 
	}
}

101 
u64
 
	$hfi1_oib_u£d
(
hfi1_oib_txq
 *
txq
)

103  
	`hfi1_oib_tx»qs
(
txq
->
£Á_tx»qs
,

104 
	`©omic64_»ad
(&
txq
->
com¶‘e_tx»qs
));

105 
	}
}

107 
	$hfi1_oib_¡Ý_txq
(
hfi1_oib_txq
 *
txq
)

109 
	`Œaû_hfi1_txq_¡Ý
(
txq
);

110 ià(
	`©omic_šc_»tuº
(&
txq
->
¡Ýs
) == 1)

111 
	`Ãtif_¡Ý_subqueue
(
txq
->
´iv
->
Ãtdev
,xq->
q_idx
);

112 
	}
}

114 
	$hfi1_oib_wake_txq
(
hfi1_oib_txq
 *
txq
)

116 
	`Œaû_hfi1_txq_wake
(
txq
);

117 ià(
	`©omic_dec_ªd_‹¡
(&
txq
->
¡Ýs
))

118 
	`Ãtif_wake_subqueue
(
txq
->
´iv
->
Ãtdev
,xq->
q_idx
);

119 
	}
}

121 
ušt
 
	$hfi1_oib_ršg_hw©
(
hfi1_oib_txq
 *
txq
)

123  
	`mš_t
(
ušt
, 
txq
->
´iv
->
Ãtdev
->
tx_queue_Ën
,

124 
txq
->
tx_ršg
.
max_™ems
 - 1);

125 
	}
}

127 
ušt
 
	$hfi1_oib_ršg_lw©
(
hfi1_oib_txq
 *
txq
)

129  
	`mš_t
(
ušt
, 
txq
->
´iv
->
Ãtdev
->
tx_queue_Ën
,

130 
txq
->
tx_ršg
.
max_™ems
) >> 1;

131 
	}
}

133 
	$hfi1_oib_check_queue_d•th
(
hfi1_oib_txq
 *
txq
)

135 ++
txq
->
£Á_tx»qs
;

136 ià(
	`hfi1_oib_u£d
(
txq
è>ð
	`hfi1_oib_ršg_hw©
(txq) &&

137 !
	`©omic_xchg
(&
txq
->
ršg_fuÎ
, 1)) {

138 
	`Œaû_hfi1_txq_fuÎ
(
txq
);

139 
	`hfi1_oib_¡Ý_txq
(
txq
);

141 
	}
}

143 
	$hfi1_oib_check_queue_¡Ý³d
(
hfi1_oib_txq
 *
txq
)

145 
Ãt_deviû
 *
dev
 = 
txq
->
´iv
->
Ãtdev
;

148 ià(
	`uÆik–y
(
dev
->
»g_¡©e
 !ð
NETREG_REGISTERED
))

160 ià(
	`hfi1_oib_u£d
(
txq
è< 
	`hfi1_oib_ršg_lw©
(txq) &&

161 
	`©omic_xchg
(&
txq
->
ršg_fuÎ
, 0)) {

162 
	`Œaû_hfi1_txq_xm™_un¡Ý³d
(
txq
);

163 
	`hfi1_oib_wake_txq
(
txq
);

165 
	}
}

167 
	$hfi1_oib_ä“_tx
(
oib_tx»q
 *
tx
, 
budg‘
)

169 
hfi1_oib_dev_´iv
 *
´iv
 = 
tx
->priv;

171 ià(
	`lik–y
(!
tx
->
sdma_¡©us
)) {

172 
	`hfi1_oib_upd©e_tx_Ãt¡©s
(
´iv
, 1, 
tx
->
skb
->
Ën
);

174 ++
´iv
->
Ãtdev
->
¡©s
.
tx_”rÜs
;

175 
	`dd_dev_w¬n
(
´iv
->
dd
,

177 
__func__
, 
tx
->
sdma_¡©us
,

178 
	`Ë64_to_ýu
(
tx
->
sdma_hdr
.
pbc
),x->
txq
->
q_idx
,

179 
tx
->
txq
->
sde
->
this_idx
);

182 
	`Çpi_cÚsume_skb
(
tx
->
skb
, 
budg‘
);

183 
	`sdma_txþ—n
(
´iv
->
dd
, &
tx
->
tx»q
);

184 
	`kmem_ÿche_ä“
(
´iv
->
tx»q_ÿche
, 
tx
);

185 
	}
}

187 
	$hfi1_oib_d¿š_tx_ršg
(
hfi1_oib_txq
 *
txq
, 
budg‘
)

189 
hfi1_oib_cœc_buf
 *
tx_ršg
 = &
txq
->tx_ring;

190 
h—d
;

191 
ž
;

192 
max_tx
;

193 
wÜk_dÚe
;

194 
tx_couÁ
;

196 
	`¥š_lock_bh
(&
tx_ršg
->
cÚsum”_lock
);

199 
h—d
 = 
	`smp_lßd_acquœe
(&
tx_ršg
->head);

200 
ž
 = 
tx_ršg
->tail;

201 
max_tx
 = 
tx_ršg
->
max_™ems
;

203 
wÜk_dÚe
 = 
	`mš_t
(, 
	`CIRC_CNT
(
h—d
, 
ž
, 
max_tx
), 
budg‘
);

205 
tx_couÁ
 = 
wÜk_dÚe
;x_count;x_count--) {

206 
	`hfi1_oib_ä“_tx
(
tx_ršg
->
™ems
[
ž
], 
budg‘
);

207 
ž
 = 
	`CIRC_NEXT
Ñaž, 
max_tx
);

210 
	`©omic64_add
(
wÜk_dÚe
, &
txq
->
com¶‘e_tx»qs
);

213 
	`smp_¡Üe_»Ëa£
(&
tx_ršg
->
ž
,ail);

215 
	`¥š_uÆock_bh
(&
tx_ršg
->
cÚsum”_lock
);

217 
	`hfi1_oib_check_queue_¡Ý³d
(
txq
);

219  
wÜk_dÚe
;

220 
	}
}

222 
	$hfi1_oib_´oûss_tx_ršg
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

224 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
Çpi
->
dev
);

225 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
Çpi
 -…riv->
tx_Çpis
];

227 
wÜk_dÚe
 = 
	`hfi1_oib_d¿š_tx_ršg
(
txq
, 
budg‘
);

229 ià(
wÜk_dÚe
 < 
budg‘
)

230 
	`Çpi_com¶‘e_dÚe
(
Çpi
, 
wÜk_dÚe
);

232  
wÜk_dÚe
;

233 
	}
}

235 
	$hfi1_oib_add_tx
(
oib_tx»q
 *
tx
)

237 
hfi1_oib_cœc_buf
 *
tx_ršg
 = &
tx
->
txq
->tx_ring;

238 
h—d
;

239 
ž
;

240 
size_t
 
max_tx
;

242 
	`¥š_lock
(&
tx_ršg
->
´oduûr_lock
);

244 
h—d
 = 
tx_ršg
->head;

245 
ž
 = 
	`READ_ONCE
(
tx_ršg
->tail);

246 
max_tx
 = 
tx_ršg
->
max_™ems
;

248 ià(
	`lik–y
(
	`CIRC_SPACE
(
h—d
, 
ž
, 
max_tx
))) {

249 
tx_ršg
->
™ems
[
h—d
] = 
tx
;

252 
	`smp_¡Üe_»Ëa£
(&
tx_ršg
->
h—d
, 
	`CIRC_ADD
(h—d, 1, 
max_tx
));

253 
	`Çpi_scheduË_œqoff
(
tx
->
txq
->
Çpi
);

255 
hfi1_oib_txq
 *
txq
 = 
tx
->txq;

256 
hfi1_oib_dev_´iv
 *
´iv
 = 
tx
->priv;

259 
	`hfi1_oib_ä“_tx
(
tx
, 0);

260 
	`©omic64_šc
(&
txq
->
com¶‘e_tx»qs
);

261 
	`dd_dev_dbg
(
´iv
->
dd
, "txq %d fuÎ.\n", 
txq
->
q_idx
);

264 
	`¥š_uÆock
(&
tx_ršg
->
´oduûr_lock
);

265 
	}
}

267 
	$hfi1_oib_sdma_com¶‘e
(
sdma_tx»q
 *
tx»q
, 
¡©us
)

269 
oib_tx»q
 *
tx
 = 
	`cÚš”_of
(
tx»q
, ipoib_txreq,xreq);

271 
tx
->
sdma_¡©us
 = 
¡©us
;

273 
	`hfi1_oib_add_tx
(
tx
);

274 
	}
}

276 
	$hfi1_oib_bužd_uÍ_·ylßd
(
oib_tx»q
 *
tx
,

277 
oib_tx·rms
 *
txp
)

279 
hfi1_devd©a
 *
dd
 = 
txp
->dd;

280 
sdma_tx»q
 *
tx»q
 = &
tx
->txreq;

281 
sk_buff
 *
skb
 = 
tx
->skb;

282 
»t
 = 0;

283 
i
;

285 ià(
	`skb_h—dËn
(
skb
)) {

286 
»t
 = 
	`sdma_txadd_kvaddr
(
dd
, 
tx»q
, 
skb
->
d©a
, 
	`skb_h—dËn
(skb));

287 ià(
	`uÆik–y
(
»t
))

288  
»t
;

291 
i
 = 0; i < 
	`skb_shšfo
(
skb
)->
Ä_äags
; i++) {

292 
skb_äag_t
 *
äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
i
];

294 
»t
 = 
	`sdma_txadd_·ge
(
dd
,

295 
tx»q
,

296 
	`skb_äag_·ge
(
äag
),

297 
	`skb_äag_off
(
äag
),

298 
	`skb_äag_size
(
äag
));

299 ià(
	`uÆik–y
(
»t
))

303  
»t
;

304 
	}
}

306 
	$hfi1_oib_bužd_tx_desc
(
oib_tx»q
 *
tx
,

307 
oib_tx·rms
 *
txp
)

309 
hfi1_devd©a
 *
dd
 = 
txp
->dd;

310 
sdma_tx»q
 *
tx»q
 = &
tx
->txreq;

311 
hfi1_sdma_h—d”
 *
sdma_hdr
 = &
tx
->sdma_hdr;

312 
u16
 
pkt_by‹s
 =

313 (
sdma_hdr
->
pbc
è+ (
txp
->
hdr_dwÜds
 << 2è+ 
tx
->
skb
->
Ën
;

314 
»t
;

316 
»t
 = 
	`sdma_txš™
(
tx»q
, 0, 
pkt_by‹s
, 
hfi1_oib_sdma_com¶‘e
);

317 ià(
	`uÆik–y
(
»t
))

318  
»t
;

321 
»t
 = 
	`sdma_txadd_kvaddr
(
dd
,

322 
tx»q
,

323 
sdma_hdr
,

324 (
sdma_hdr
->
pbc
è+ (
txp
->
hdr_dwÜds
 << 2));

325 ià(
	`uÆik–y
(
»t
))

326  
»t
;

329  
	`hfi1_oib_bužd_uÍ_·ylßd
(
tx
, 
txp
);

330 
	}
}

332 
	$hfi1_oib_bužd_ib_tx_h—d”s
(
oib_tx»q
 *
tx
,

333 
oib_tx·rms
 *
txp
)

335 
hfi1_oib_dev_´iv
 *
´iv
 = 
tx
->priv;

336 
hfi1_sdma_h—d”
 *
sdma_hdr
 = &
tx
->sdma_hdr;

337 
sk_buff
 *
skb
 = 
tx
->skb;

338 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
txp
->
ibp
);

339 
rdma_ah_©Œ
 *
ah_©Œ
 = 
txp
->ah_attr;

340 
ib_Ùh”_h—d”s
 *
ohdr
;

341 
ib_grh
 *
grh
;

342 
u16
 
dwÜds
;

343 
u16
 
¦id
;

344 
u16
 
dlid
;

345 
u16
 
Ìh0
;

346 
u32
 
bth0
;

347 
u32
 
sq²
 = (u32)(
´iv
->
Ãtdev
->
dev_addr
[1] << 16 |

348 
´iv
->
Ãtdev
->
dev_addr
[2] << 8 |

349 
´iv
->
Ãtdev
->
dev_addr
[3]);

350 
u16
 
·ylßd_dwÜds
;

351 
u8
 
·d_út
;

353 
·d_út
 = -
skb
->
Ën
 & 3;

356 
·ylßd_dwÜds
 = ((
skb
->
Ën
 + 
·d_út
è>> 2è+ 
SIZE_OF_CRC
;

359 
txp
->
hdr_dwÜds
 = 7;

361 ià(
	`rdma_ah_g‘_ah_æags
(
ah_©Œ
è& 
IB_AH_GRH
) {

362 
grh
 = &
sdma_hdr
->
hdr
.
ibh
.
u
.
l
.grh;

363 
txp
->
hdr_dwÜds
 +=

364 
	`hfi1_make_grh
(
txp
->
ibp
,

365 
grh
,

366 
	`rdma_ah_»ad_grh
(
ah_©Œ
),

367 
txp
->
hdr_dwÜds
 - 
LRH_9B_DWORDS
,

368 
·ylßd_dwÜds
);

369 
Ìh0
 = 
HFI1_LRH_GRH
;

370 
ohdr
 = &
sdma_hdr
->
hdr
.
ibh
.
u
.
l
.
Ùh
;

372 
Ìh0
 = 
HFI1_LRH_BTH
;

373 
ohdr
 = &
sdma_hdr
->
hdr
.
ibh
.
u
.
Ùh
;

376 
Ìh0
 |ð(
	`rdma_ah_g‘_¦
(
ah_©Œ
) & 0xf) << 4;

377 
Ìh0
 |ð(
txp
->
æow
.
sc5
 & 0xf) << 12;

379 
dlid
 = 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
), 9B);

380 ià(
dlid
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
)) {

381 
¦id
 = 
	`be16_to_ýu
(
IB_LID_PERMISSIVE
);

383 
u16
 
lid
 = (u16)
µd
->lid;

385 ià(
lid
) {

386 
lid
 |ð
	`rdma_ah_g‘_·th_b™s
(
ah_©Œ
) &

387 ((1 << 
µd
->
lmc
) - 1);

388 
¦id
 = 
lid
;

390 
¦id
 = 
	`be16_to_ýu
(
IB_LID_PERMISSIVE
);

395 
dwÜds
 = 
txp
->
hdr_dwÜds
 + 
·ylßd_dwÜds
;

398 
sdma_hdr
->
hdr
.
hdr_ty³
 = 
HFI1_PKT_TYPE_9B
;

399 
	`hfi1_make_ib_hdr
(&
sdma_hdr
->
hdr
.
ibh
, 
Ìh0
, 
dwÜds
, 
dlid
, 
¦id
);

402 
bth0
 = (
IB_OPCODE_UD_SEND_ONLY
 << 24è| (
·d_út
 << 20è| 
´iv
->
pkey
;

404 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

405 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
txp
->
dq²
);

406 
ohdr
->
bth
[2] = 
	`ýu_to_be32
(
	`mask_p¢
((
u32
)
txp
->
txq
->
£Á_tx»qs
));

409 
ohdr
->
u
.
ud
.
d‘h
[0] = 
	`ýu_to_be32
(
´iv
->
qkey
);

410 
ohdr
->
u
.
ud
.
d‘h
[1] = 
	`ýu_to_be32
((
txp
->
’ŒÝy
 <<

411 
RVT_AIP_ENTROPY_SHIFT
è| 
sq²
);

414 
sdma_hdr
->
pbc
 =

415 
	`ýu_to_Ë64
(
	`ü—‹_pbc
(
µd
,

416 
	`ib_is_sc5
(
txp
->
æow
.
sc5
) <<

417 
PBC_DC_INFO_SHIFT
,

419 
	`sc_to_vÉ
(
´iv
->
dd
, 
txp
->
æow
.
sc5
),

420 
dwÜds
 - 
SIZE_OF_CRC
 +

421 ((
sdma_hdr
->
pbc
) >> 2)));

422 
	}
}

424 
oib_tx»q
 *
	$hfi1_oib_£nd_dma_commÚ
(
Ãt_deviû
 *
dev
,

425 
sk_buff
 *
skb
,

426 
oib_tx·rms
 *
txp
)

428 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

429 
oib_tx»q
 *
tx
;

430 
»t
;

432 
tx
 = 
	`kmem_ÿche_®loc_node
(
´iv
->
tx»q_ÿche
,

433 
GFP_ATOMIC
,

434 
´iv
->
dd
->
node
);

435 ià(
	`uÆik–y
(!
tx
))

436  
	`ERR_PTR
(-
ENOMEM
);

439 
tx
->
tx»q
.
num_desc
 = 0;

440 
tx
->
´iv
 =…riv;

441 
tx
->
txq
 = 
txp
->txq;

442 
tx
->
skb
 = skb;

443 
	`INIT_LIST_HEAD
(&
tx
->
tx»q
.
li¡
);

445 
	`hfi1_oib_bužd_ib_tx_h—d”s
(
tx
, 
txp
);

447 
»t
 = 
	`hfi1_oib_bužd_tx_desc
(
tx
, 
txp
);

448 ià(
	`lik–y
(!
»t
)) {

449 ià(
txp
->
txq
->
æow
.
as_št
 !=xp->flow.as_int) {

450 
txp
->
txq
->
æow
.
tx_queue
 =xp->flow.tx_queue;

451 
txp
->
txq
->
æow
.
sc5
 =xp->flow.sc5;

452 
txp
->
txq
->
sde
 =

453 
	`sdma_£Ëù_’gše_sc
(
´iv
->
dd
,

454 
txp
->
æow
.
tx_queue
,

455 
txp
->
æow
.
sc5
);

456 
	`Œaû_hfi1_æow_sw™ch
(
txp
->
txq
);

459  
tx
;

462 
	`sdma_txþ—n
(
´iv
->
dd
, &
tx
->
tx»q
);

463 
	`kmem_ÿche_ä“
(
´iv
->
tx»q_ÿche
, 
tx
);

465  
	`ERR_PTR
(
»t
);

466 
	}
}

468 
	$hfi1_oib_subm™_tx_li¡
(
Ãt_deviû
 *
dev
,

469 
hfi1_oib_txq
 *
txq
)

471 
»t
;

472 
u16
 
couÁ_out
;

474 
»t
 = 
	`sdma_£nd_txli¡
(
txq
->
sde
,

475 
	`iowa™_g‘_ib_wÜk
(&
txq
->
wa™
),

476 &
txq
->
tx_li¡
,

477 &
couÁ_out
);

478 ià(
	`lik–y
(!
»t
è||„‘ =ð-
EBUSY
 ||„‘ =ð-
ECOMM
)

479  
»t
;

481 
	`dd_dev_w¬n
(
txq
->
´iv
->
dd
, "ÿÂÙ s’d skbx†i¡,ƒ¼ %d.\n", 
»t
);

483  
»t
;

484 
	}
}

486 
	$hfi1_oib_æush_tx_li¡
(
Ãt_deviû
 *
dev
,

487 
hfi1_oib_txq
 *
txq
)

489 
»t
 = 0;

491 ià(!
	`li¡_em±y
(&
txq
->
tx_li¡
)) {

493 
»t
 = 
	`hfi1_oib_subm™_tx_li¡
(
dev
, 
txq
);

495 ià(
	`uÆik–y
(
»t
))

496 ià(
»t
 !ð-
EBUSY
)

497 ++
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
;

500  
»t
;

501 
	}
}

503 
	$hfi1_oib_subm™_tx
(
hfi1_oib_txq
 *
txq
,

504 
oib_tx»q
 *
tx
)

506 
»t
;

508 
»t
 = 
	`sdma_£nd_tx»q
(
txq
->
sde
,

509 
	`iowa™_g‘_ib_wÜk
(&
txq
->
wa™
),

510 &
tx
->
tx»q
,

511 
txq
->
pkts_£Á
);

512 ià(
	`lik–y
(!
»t
)) {

513 
txq
->
pkts_£Á
 = 
Œue
;

514 
	`iowa™_¡¬ve_þ—r
(
txq
->
pkts_£Á
, &txq->
wa™
);

517  
»t
;

518 
	}
}

520 
	$hfi1_oib_£nd_dma_sšgË
(
Ãt_deviû
 *
dev
,

521 
sk_buff
 *
skb
,

522 
oib_tx·rms
 *
txp
)

524 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

525 
hfi1_oib_txq
 *
txq
 = 
txp
->txq;

526 
oib_tx»q
 *
tx
;

527 
»t
;

529 
tx
 = 
	`hfi1_oib_£nd_dma_commÚ
(
dev
, 
skb
, 
txp
);

530 ià(
	`uÆik–y
(
	`IS_ERR
(
tx
))) {

531 
»t
 = 
	`PTR_ERR
(
tx
);

533 
	`dev_kä“_skb_ªy
(
skb
);

535 ià(
»t
 =ð-
ENOMEM
)

536 ++
dev
->
¡©s
.
tx_”rÜs
;

538 ++
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
;

540  
NETDEV_TX_OK
;

543 
»t
 = 
	`hfi1_oib_subm™_tx
(
txq
, 
tx
);

544 ià(
	`lik–y
(!
»t
)) {

545 
tx_ok
:

546 
	`Œaû_sdma_ouut_ibhdr
(
tx
->
´iv
->
dd
,

547 &
tx
->
sdma_hdr
.
hdr
,

548 
	`ib_is_sc5
(
txp
->
æow
.
sc5
));

549 
	`hfi1_oib_check_queue_d•th
(
txq
);

550  
NETDEV_TX_OK
;

553 
txq
->
pkts_£Á
 = 
çl£
;

555 ià(
»t
 =ð-
EBUSY
 ||„‘ =ð-
ECOMM
)

556 
tx_ok
;

558 
	`sdma_txþ—n
(
´iv
->
dd
, &
tx
->
tx»q
);

559 
	`dev_kä“_skb_ªy
(
skb
);

560 
	`kmem_ÿche_ä“
(
´iv
->
tx»q_ÿche
, 
tx
);

561 ++
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
;

563  
NETDEV_TX_OK
;

564 
	}
}

566 
	$hfi1_oib_£nd_dma_li¡
(
Ãt_deviû
 *
dev
,

567 
sk_buff
 *
skb
,

568 
oib_tx·rms
 *
txp
)

570 
hfi1_oib_txq
 *
txq
 = 
txp
->txq;

571 
oib_tx»q
 *
tx
;

574 ià(
txq
->
æow
.
as_št
 !ð
txp
->flow.as_int) {

575 
»t
;

577 
	`Œaû_hfi1_æow_æush
(
txq
);

578 
»t
 = 
	`hfi1_oib_æush_tx_li¡
(
dev
, 
txq
);

579 ià(
	`uÆik–y
(
»t
)) {

580 ià(
»t
 =ð-
EBUSY
)

581 ++
dev
->
¡©s
.
tx_drÝ³d
;

582 
	`dev_kä“_skb_ªy
(
skb
);

583  
NETDEV_TX_OK
;

586 
tx
 = 
	`hfi1_oib_£nd_dma_commÚ
(
dev
, 
skb
, 
txp
);

587 ià(
	`uÆik–y
(
	`IS_ERR
(
tx
))) {

588 
»t
 = 
	`PTR_ERR
(
tx
);

590 
	`dev_kä“_skb_ªy
(
skb
);

592 ià(
»t
 =ð-
ENOMEM
)

593 ++
dev
->
¡©s
.
tx_”rÜs
;

595 ++
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
;

597  
NETDEV_TX_OK
;

600 
	`li¡_add_ž
(&
tx
->
tx»q
.
li¡
, &
txq
->
tx_li¡
);

602 
	`hfi1_oib_check_queue_d•th
(
txq
);

604 
	`Œaû_sdma_ouut_ibhdr
(
tx
->
´iv
->
dd
,

605 &
tx
->
sdma_hdr
.
hdr
,

606 
	`ib_is_sc5
(
txp
->
æow
.
sc5
));

608 ià(!
	`Ãtdev_xm™_mÜe
())

609 ()
	`hfi1_oib_æush_tx_li¡
(
dev
, 
txq
);

611  
NETDEV_TX_OK
;

612 
	}
}

614 
u8
 
	$hfi1_oib_ÿlc_’ŒÝy
(
sk_buff
 *
skb
)

616 ià(
	`skb_Œª¥Üt_h—d”_was_£t
(
skb
)) {

617 
u8
 *
hdr
 = (u8 *)
	`skb_Œª¥Üt_h—d”
(
skb
);

619  (
hdr
[0] ^ hdr[1] ^ hdr[2] ^ hdr[3]);

622  (
u8
)
	`skb_g‘_queue_m­pšg
(
skb
);

623 
	}
}

625 
	$hfi1_oib_£nd
(
Ãt_deviû
 *
dev
,

626 
sk_buff
 *
skb
,

627 
ib_ah
 *
add»ss
,

628 
u32
 
dq²
)

630 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

631 
oib_tx·rms
 
txp
;

632 
rdma_Ãtdev
 *
º
 = 
	`Ãtdev_´iv
(
dev
);

634 ià(
	`uÆik–y
(
skb
->
Ën
 > 
º
->
mtu
 + 
HFI1_IPOIB_ENCAP_LEN
)) {

635 
	`dd_dev_w¬n
(
´iv
->
dd
, "packet†en %d (> %d)oo†ongo send, dropping\n",

636 
skb
->
Ën
,

637 
º
->
mtu
 + 
HFI1_IPOIB_ENCAP_LEN
);

638 ++
dev
->
¡©s
.
tx_drÝ³d
;

639 ++
dev
->
¡©s
.
tx_”rÜs
;

640 
	`dev_kä“_skb_ªy
(
skb
);

641  
NETDEV_TX_OK
;

644 
txp
.
dd
 = 
´iv
->dd;

645 
txp
.
ah_©Œ
 = &
	`ibah_to_rvh
(
add»ss
)->
©Œ
;

646 
txp
.
ibp
 = 
	`to_Üt
(
´iv
->
deviû
,…riv->
pÜt_num
);

647 
txp
.
txq
 = &
´iv
->
txqs
[
	`skb_g‘_queue_m­pšg
(
skb
)];

648 
txp
.
dq²
 = dqpn;

649 
txp
.
æow
.
sc5
 =xp.
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
Ñxp.
ah_©Œ
)];

650 
txp
.
æow
.
tx_queue
 = (
u8
)
	`skb_g‘_queue_m­pšg
(
skb
);

651 
txp
.
’ŒÝy
 = 
	`hfi1_oib_ÿlc_’ŒÝy
(
skb
);

653 ià(
	`Ãtdev_xm™_mÜe
(è|| !
	`li¡_em±y
(&
txp
.
txq
->
tx_li¡
))

654  
	`hfi1_oib_£nd_dma_li¡
(
dev
, 
skb
, &
txp
);

656  
	`hfi1_oib_£nd_dma_sšgË
(
dev
, 
skb
, &
txp
);

657 
	}
}

667 
	$hfi1_oib_sdma_¦“p
(
sdma_’gše
 *
sde
,

668 
iowa™_wÜk
 *
wa™
,

669 
sdma_tx»q
 *
tx»q
,

670 
ušt
 
£q
,

671 
boÞ
 
pkts_£Á
)

673 
hfi1_oib_txq
 *
txq
 =

674 
	`cÚš”_of
(
wa™
->
iow
, 
hfi1_oib_txq
, wait);

676 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

677 ià(
	`lik–y
(
txq
->
´iv
->
Ãtdev
->
»g_¡©e
 =ð
NETREG_REGISTERED
)) {

678 ià(
	`sdma_´og»ss
(
sde
, 
£q
, 
tx»q
)) {

679 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

680  -
EAGAIN
;

683 ià(
	`li¡_em±y
(&
tx»q
->
li¡
))

685 
	`li¡_add_ž
(&
tx»q
->
li¡
, &
txq
->
tx_li¡
);

686 ià(
	`li¡_em±y
(&
txq
->
wa™
.
li¡
)) {

687 ià(!
	`©omic_xchg
(&
txq
->
no_desc
, 1)) {

688 
	`Œaû_hfi1_txq_queued
(
txq
);

689 
	`hfi1_oib_¡Ý_txq
(
txq
);

691 
	`iowa™_queue
(
pkts_£Á
, 
wa™
->
iow
, &
sde
->
dmawa™
);

694 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

695  -
EBUSY
;

698 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

699  -
EINVAL
;

700 
	}
}

708 
	$hfi1_oib_sdma_wakeup
(
iowa™
 *
wa™
, 
»asÚ
)

710 
hfi1_oib_txq
 *
txq
 =

711 
	`cÚš”_of
(
wa™
, 
hfi1_oib_txq
, wait);

713 
	`Œaû_hfi1_txq_wakeup
(
txq
);

714 ià(
	`lik–y
(
txq
->
´iv
->
Ãtdev
->
»g_¡©e
 =ð
NETREG_REGISTERED
))

715 
	`iowa™_scheduË
(
wa™
, 
sy¡em_high´i_wq
, 
WORK_CPU_UNBOUND
);

716 
	}
}

718 
	$hfi1_oib_æush_txq
(
wÜk_¡ruù
 *
wÜk
)

720 
iowa™_wÜk
 *
ioww
 =

721 
	`cÚš”_of
(
wÜk
, 
iowa™_wÜk
, 
iowÜk
);

722 
iowa™
 *
wa™
;

723 
hfi1_oib_txq
 *
txq
;

724 
Ãt_deviû
 *
dev
;

726 
wa™
 = 
	`iowa™_ioww_to_iow
(
ioww
);

727 ià(!
wa™
)

730 
txq
 = 
	`cÚš”_of
(
wa™
, 
hfi1_oib_txq
, wait);

731 
dev
 = 
txq
->
´iv
->
Ãtdev
;

733 ià(
	`lik–y
(
dev
->
»g_¡©e
 =ð
NETREG_REGISTERED
) &&

734 
	`lik–y
(!
	`hfi1_oib_æush_tx_li¡
(
dev
, 
txq
)))

735 ià(
	`©omic_xchg
(&
txq
->
no_desc
, 0))

736 
	`hfi1_oib_wake_txq
(
txq
);

737 
	}
}

739 
	$hfi1_oib_tx»q_š™
(
hfi1_oib_dev_´iv
 *
´iv
)

741 
Ãt_deviû
 *
dev
 = 
´iv
->
Ãtdev
;

742 
buf
[
HFI1_IPOIB_TXREQ_NAME_LEN
];

743 
tx_ršg_size
;

744 
i
;

749 
tx_ršg_size
 = 
	`roundup_pow_of_two
(()
dev
->
tx_queue_Ën
 + 1);

751 
	`¢´štf
(
buf
, (buf), "hfi1_%u_oib_tx»q_ÿche", 
´iv
->
dd
->
un™
);

752 
´iv
->
tx»q_ÿche
 = 
	`kmem_ÿche_ü—‹
(
buf
,

753 (
oib_tx»q
),

756 
NULL
);

757 ià(!
´iv
->
tx»q_ÿche
)

758  -
ENOMEM
;

760 
´iv
->
tx_Çpis
 = 
	`kÿÎoc_node
(
dev
->
num_tx_queues
,

761 (
Çpi_¡ruù
),

762 
GFP_KERNEL
,

763 
´iv
->
dd
->
node
);

764 ià(!
´iv
->
tx_Çpis
)

765 
ä“_tx»q_ÿche
;

767 
´iv
->
txqs
 = 
	`kÿÎoc_node
(
dev
->
num_tx_queues
,

768 (
hfi1_oib_txq
),

769 
GFP_KERNEL
,

770 
´iv
->
dd
->
node
);

771 ià(!
´iv
->
txqs
)

772 
ä“_tx_Çpis
;

774 
i
 = 0; i < 
dev
->
num_tx_queues
; i++) {

775 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
i
];

777 
	`iowa™_š™
(&
txq
->
wa™
,

779 
hfi1_oib_æush_txq
,

780 
NULL
,

781 
hfi1_oib_sdma_¦“p
,

782 
hfi1_oib_sdma_wakeup
,

783 
NULL
,

784 
NULL
);

785 
txq
->
´iv
 =…riv;

786 
txq
->
sde
 = 
NULL
;

787 
	`INIT_LIST_HEAD
(&
txq
->
tx_li¡
);

788 
	`©omic64_£t
(&
txq
->
com¶‘e_tx»qs
, 0);

789 
	`©omic_£t
(&
txq
->
¡Ýs
, 0);

790 
	`©omic_£t
(&
txq
->
ršg_fuÎ
, 0);

791 
	`©omic_£t
(&
txq
->
no_desc
, 0);

792 
txq
->
q_idx
 = 
i
;

793 
txq
->
æow
.
tx_queue
 = 0xff;

794 
txq
->
æow
.
sc5
 = 0xff;

795 
txq
->
pkts_£Á
 = 
çl£
;

797 
	`Ãtdev_queue_numa_node_wr™e
(
	`Ãtdev_g‘_tx_queue
(
dev
, 
i
),

798 
´iv
->
dd
->
node
);

800 
txq
->
tx_ršg
.
™ems
 =

801 
	`kÿÎoc_node
(
tx_ršg_size
,

802 (
oib_tx»q
 *),

803 
GFP_KERNEL
, 
´iv
->
dd
->
node
);

804 ià(!
txq
->
tx_ršg
.
™ems
)

805 
ä“_txqs
;

807 
	`¥š_lock_š™
(&
txq
->
tx_ršg
.
´oduûr_lock
);

808 
	`¥š_lock_š™
(&
txq
->
tx_ršg
.
cÚsum”_lock
);

809 
txq
->
tx_ršg
.
max_™ems
 = 
tx_ršg_size
;

811 
txq
->
Çpi
 = &
´iv
->
tx_Çpis
[
i
];

812 
	`Ãtif_tx_Çpi_add
(
dev
, 
txq
->
Çpi
,

813 
hfi1_oib_´oûss_tx_ršg
,

814 
NAPI_POLL_WEIGHT
);

819 
ä“_txqs
:

820 
i
--; i >= 0; i--) {

821 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
i
];

823 
	`Ãtif_Çpi_d–
(
txq
->
Çpi
);

824 
	`kä“
(
txq
->
tx_ršg
.
™ems
);

827 
	`kä“
(
´iv
->
txqs
);

828 
´iv
->
txqs
 = 
NULL
;

830 
ä“_tx_Çpis
:

831 
	`kä“
(
´iv
->
tx_Çpis
);

832 
´iv
->
tx_Çpis
 = 
NULL
;

834 
ä“_tx»q_ÿche
:

835 
	`kmem_ÿche_de¡roy
(
´iv
->
tx»q_ÿche
);

836 
´iv
->
tx»q_ÿche
 = 
NULL
;

837  -
ENOMEM
;

838 
	}
}

840 
	$hfi1_oib_d¿š_tx_li¡
(
hfi1_oib_txq
 *
txq
)

842 
sdma_tx»q
 *
tx»q
;

843 
sdma_tx»q
 *
tx»q_tmp
;

844 
©omic64_t
 *
com¶‘e_tx»qs
 = &
txq
->complete_txreqs;

846 
	`li¡_fÜ_—ch_’Œy_§ã
(
tx»q
, 
tx»q_tmp
, &
txq
->
tx_li¡
, 
li¡
) {

847 
oib_tx»q
 *
tx
 =

848 
	`cÚš”_of
(
tx»q
, 
oib_tx»q
,xreq);

850 
	`li¡_d–
(&
tx»q
->
li¡
);

851 
	`sdma_txþ—n
(
txq
->
´iv
->
dd
, &
tx
->
tx»q
);

852 
	`dev_kä“_skb_ªy
(
tx
->
skb
);

853 
	`kmem_ÿche_ä“
(
txq
->
´iv
->
tx»q_ÿche
, 
tx
);

854 
	`©omic64_šc
(
com¶‘e_tx»qs
);

857 ià(
	`hfi1_oib_u£d
(
txq
))

858 
	`dd_dev_w¬n
(
txq
->
´iv
->
dd
,

860 
txq
->
q_idx
,

861 
	`hfi1_oib_tx»qs
(
txq
->
£Á_tx»qs
,

862 
	`©omic64_»ad
(
com¶‘e_tx»qs
)));

863 
	}
}

865 
	$hfi1_oib_tx»q_deš™
(
hfi1_oib_dev_´iv
 *
´iv
)

867 
i
;

869 
i
 = 0; i < 
´iv
->
Ãtdev
->
num_tx_queues
; i++) {

870 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
i
];

872 
	`iowa™_ÿnûl_wÜk
(&
txq
->
wa™
);

873 
	`iowa™_sdma_d¿š
(&
txq
->
wa™
);

874 
	`hfi1_oib_d¿š_tx_li¡
(
txq
);

875 
	`Ãtif_Çpi_d–
(
txq
->
Çpi
);

876 ()
	`hfi1_oib_d¿š_tx_ršg
(
txq
,xq->
tx_ršg
.
max_™ems
);

877 
	`kä“
(
txq
->
tx_ršg
.
™ems
);

880 
	`kä“
(
´iv
->
txqs
);

881 
´iv
->
txqs
 = 
NULL
;

883 
	`kä“
(
´iv
->
tx_Çpis
);

884 
´iv
->
tx_Çpis
 = 
NULL
;

886 
	`kmem_ÿche_de¡roy
(
´iv
->
tx»q_ÿche
);

887 
´iv
->
tx»q_ÿche
 = 
NULL
;

888 
	}
}

890 
	$hfi1_oib_Çpi_tx_’abË
(
Ãt_deviû
 *
dev
)

892 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

893 
i
;

895 
i
 = 0; i < 
dev
->
num_tx_queues
; i++) {

896 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
i
];

898 
	`Çpi_’abË
(
txq
->
Çpi
);

900 
	}
}

902 
	$hfi1_oib_Çpi_tx_di§bË
(
Ãt_deviû
 *
dev
)

904 
hfi1_oib_dev_´iv
 *
´iv
 = 
	`hfi1_oib_´iv
(
dev
);

905 
i
;

907 
i
 = 0; i < 
dev
->
num_tx_queues
; i++) {

908 
hfi1_oib_txq
 *
txq
 = &
´iv
->
txqs
[
i
];

910 
	`Çpi_di§bË
(
txq
->
Çpi
);

911 ()
	`hfi1_oib_d¿š_tx_ršg
(
txq
,xq->
tx_ršg
.
max_™ems
);

913 
	}
}

	@mad.c

48 
	~<lšux/Ãt.h
>

49 
	~<rdma/Ýa_addr.h
>

50 
	#OPA_NUM_PKEY_BLOCKS_PER_SMP
 (
OPA_SMP_DR_DATA_SIZE
 \

51 / (
OPA_PARTITION_TABLE_BLK_SIZE
 * (
u16
)))

	)

53 
	~"hfi.h
"

54 
	~"mad.h
"

55 
	~"Œaû.h
"

56 
	~"qp.h
"

57 
	~"vnic.h
"

60 
	#OPA_LINK_WIDTH_RESET_OLD
 0x0fff

	)

61 
	#OPA_LINK_WIDTH_RESET
 0xffff

	)

63 
	sŒ­_node
 {

64 
li¡_h—d
 
	mli¡
;

65 
Ýa_mad_nÙiû_©Œ
 
	md©a
;

66 
__be64
 
	mtid
;

67 
	mËn
;

68 
u32
 
	m»Œy
;

69 
u8
 
	mš_u£
;

70 
u8
 
	m»´ess
;

73 
	$smp_Ëngth_check
(
u32
 
d©a_size
, u32 
»que¡_Ën
)

75 ià(
	`uÆik–y
(
»que¡_Ën
 < 
d©a_size
))

76  -
EINVAL
;

79 
	}
}

81 
	$»¶y
(
ib_mad_hdr
 *
smp
)

87 
smp
->
m‘hod
 = 
IB_MGMT_METHOD_GET_RESP
;

88 ià(
smp
->
mgmt_þass
 =ð
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)

89 
smp
->
¡©us
 |ð
IB_SMP_DIRECTION
;

90  
IB_MAD_RESULT_SUCCESS
 | 
IB_MAD_RESULT_REPLY
;

91 
	}
}

93 
šlše
 
	$þ—r_Ýa_smp_d©a
(
Ýa_smp
 *
smp
)

95 *
d©a
 = 
	`Ýa_g‘_smp_d©a
(
smp
);

96 
size_t
 
size
 = 
	`Ýa_g‘_smp_d©a_size
(
smp
);

98 
	`mem£t
(
d©a
, 0, 
size
);

99 
	}
}

101 
šlše
 
u16
 
	$hfi1_lookup_pkey_v®ue
(
hfi1_ibpÜt
 *
ibp
, 
pkey_idx
)

103 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

105 ià(
pkey_idx
 < 
	`ARRAY_SIZE
(
µd
->
pkeys
))

106  
µd
->
pkeys
[
pkey_idx
];

109 
	}
}

111 
	$hfi1_ev’t_pkey_chªge
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
)

113 
ib_ev’t
 
ev’t
;

115 
ev’t
.ev’ˆð
IB_EVENT_PKEY_CHANGE
;

116 
ev’t
.
deviû
 = &
dd
->
v”bs_dev
.
rdi
.
ibdev
;

117 
ev’t
.
–em’t
.
pÜt_num
 = 
pÜt
;

118 
	`ib_di¥©ch_ev’t
(&
ev’t
);

119 
	}
}

125 
	$þ—nup_Œ­s
(
hfi1_ibpÜt
 *
ibp
, 
Œ­_node
 *
Œ­
)

127 
Œ­_node
 *
node
, *
q
;

128 
æags
;

129 
li¡_h—d
 
Œ­_li¡
;

130 
i
;

132 
i
 = 0; i < 
RVT_MAX_TRAP_LISTS
; i++) {

133 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

134 
	`li¡_»¶aû_š™
(&
ibp
->
rvp
.
Œ­_li¡s
[
i
].
li¡
, &
Œ­_li¡
);

135 
ibp
->
rvp
.
Œ­_li¡s
[
i
].
li¡_Ën
 = 0;

136 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

142 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
q
, &
Œ­_li¡
, 
li¡
) {

143 
	`li¡_d–
(&
node
->
li¡
);

144 ià(
node
 !ð
Œ­
)

145 
	`kä“
(
node
);

153 
	`kä“
(
Œ­
);

154 
	}
}

156 
Œ­_node
 *
	$check_ªd_add_Œ­
(
hfi1_ibpÜt
 *
ibp
,

157 
Œ­_node
 *
Œ­
)

159 
Œ­_node
 *
node
;

160 
Œ­_li¡
 *trap_list;

161 
æags
;

162 
timeout
;

163 
found
 = 0;

164 
queue_id
;

165 
Œ­_couÁ
;

167 
queue_id
 = 
Œ­
->
d©a
.
g’”ic_ty³
 & 0x0F;

168 ià(
queue_id
 >ð
RVT_MAX_TRAP_LISTS
) {

169 
Œ­_couÁ
++;

170 
	`´_”r_¿‹lim™ed
("hfi1: Invalidrap 0x%0x dropped. Total dropped: %d\n",

171 
Œ­
->
d©a
.
g’”ic_ty³
, 
Œ­_couÁ
);

172 
	`kä“
(
Œ­
);

173  
NULL
;

180 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

181 
Œ­_li¡
 = &
ibp
->
rvp
.
Œ­_li¡s
[
queue_id
];

183 
	`li¡_fÜ_—ch_’Œy
(
node
, &
Œ­_li¡
->
li¡
,†ist) {

184 ià(
node
 =ð
Œ­
) {

185 
node
->
»Œy
++;

186 
found
 = 1;

192 ià(!
found
) {

193 ià(
Œ­_li¡
->
li¡_Ën
 < 
RVT_MAX_TRAP_LEN
) {

194 
Œ­_li¡
->
li¡_Ën
++;

195 
	`li¡_add_ž
(&
Œ­
->
li¡
, &
Œ­_li¡
->list);

197 
	`´_w¬n_¿‹lim™ed
("hfi1: Maximumrap†imit„eached for 0x%0xraps\n",

198 
Œ­
->
d©a
.
g’”ic_ty³
);

199 
	`kä“
(
Œ­
);

207 
node
 = 
NULL
;

208 ià(!
	`tim”_³ndšg
(&
ibp
->
rvp
.
Œ­_tim”
)) {

215 
timeout
 = (
RVT_TRAP_TIMEOUT
 *

216 (1UL << 
ibp
->
rvp
.
subÃt_timeout
)) / 1000;

217 
	`mod_tim”
(&
ibp
->
rvp
.
Œ­_tim”
,

218 
jiff›s
 + 
	`u£cs_to_jiff›s
(
timeout
));

219 
node
 = 
	`li¡_fœ¡_’Œy
(&
Œ­_li¡
->
li¡
, 
Œ­_node
,

220 
li¡
);

221 
node
->
š_u£
 = 1;

223 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

225  
node
;

226 
	}
}

228 
	$subn_hªdË_Ýa_Œ­_»´ess
(
hfi1_ibpÜt
 *
ibp
,

229 
Ýa_smp
 *
smp
)

231 
Œ­_li¡
 *trap_list;

232 
Œ­_node
 *
Œ­
;

233 
æags
;

234 
i
;

236 ià(
smp
->
©Œ_id
 !ð
IB_SMP_ATTR_NOTICE
)

239 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

240 
i
 = 0; i < 
RVT_MAX_TRAP_LISTS
; i++) {

241 
Œ­_li¡
 = &
ibp
->
rvp
.
Œ­_li¡s
[
i
];

242 
Œ­
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
Œ­_li¡
->
li¡
,

243 
Œ­_node
, 
li¡
);

244 ià(
Œ­
 &&¿p->
tid
 =ð
smp
->tid) {

245 ià(
Œ­
->
š_u£
) {

246 
Œ­
->
»´ess
 = 1;

248 
Œ­_li¡
->
li¡_Ën
--;

249 
	`li¡_d–
(&
Œ­
->
li¡
);

250 
	`kä“
(
Œ­
);

255 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

256 
	}
}

258 
	$hfi1_upd©e_sm_ah_©Œ
(
hfi1_ibpÜt
 *
ibp
,

259 
rdma_ah_©Œ
 *
©Œ
, 
u32
 
dlid
)

261 
	`rdma_ah_£t_dlid
(
©Œ
, 
dlid
);

262 
	`rdma_ah_£t_pÜt_num
(
©Œ
, 
	`µd_äom_ibp
(
ibp
)->
pÜt
);

263 ià(
dlid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
)) {

264 
ib_glob®_rou‹
 *
grh
 = 
	`rdma_ah_»Œ›ve_grh
(
©Œ
);

266 
	`rdma_ah_£t_ah_æags
(
©Œ
, 
IB_AH_GRH
);

267 
grh
->
sgid_šdex
 = 0;

268 
grh
->
hÝ_lim™
 = 1;

269 
grh
->
dgid
.
glob®
.
subÃt_´efix
 =

270 
ibp
->
rvp
.
gid_´efix
;

271 
grh
->
dgid
.
glob®
.
š‹rçû_id
 = 
	`OPA_MAKE_ID
(
dlid
);

273 
	}
}

275 
	$hfi1_modify_qp0_ah
(
hfi1_ibpÜt
 *
ibp
,

276 
rvt_ah
 *
ah
, 
u32
 
dlid
)

278 
rdma_ah_©Œ
 
©Œ
;

279 
rvt_qp
 *
qp0
;

280 
»t
 = -
EINVAL
;

282 
	`mem£t
(&
©Œ
, 0, (attr));

283 #iâdeà
NO_RDMA_AH_ATTR_TYPE


284 
©Œ
.
ty³
 = 
ah
->
ibah
.type;

286 
	`hfi1_upd©e_sm_ah_©Œ
(
ibp
, &
©Œ
, 
dlid
);

287 
	`rcu_»ad_lock
();

288 
qp0
 = 
	`rcu_d”eã»nû
(
ibp
->
rvp
.
qp
[0]);

289 ià(
qp0
)

290 
»t
 = 
	`rdma_modify_ah
(&
ah
->
ibah
, &
©Œ
);

291 
	`rcu_»ad_uÆock
();

292  
»t
;

293 
	}
}

295 
ib_ah
 *
	$hfi1_ü—‹_qp0_ah
(
hfi1_ibpÜt
 *
ibp
, 
u32
 
dlid
)

297 
rdma_ah_©Œ
 
©Œ
;

298 
ib_ah
 *
ah
 = 
	`ERR_PTR
(-
EINVAL
);

299 
rvt_qp
 *
qp0
;

300 #iâdeà
NO_RDMA_AH_ATTR_TYPE


301 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

302 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_µd
(
µd
);

303 
u8
 
pÜt_num
 = 
µd
->
pÜt
;

305 
	`mem£t
(&
©Œ
, 0, (attr));

306 
©Œ
.
ty³
 = 
	`rdma_ah_fšd_ty³
(&
dd
->
v”bs_dev
.
rdi
.
ibdev
, 
pÜt_num
);

308 
	`mem£t
(&
©Œ
, 0, (attr));

310 
	`hfi1_upd©e_sm_ah_©Œ
(
ibp
, &
©Œ
, 
dlid
);

311 
	`rcu_»ad_lock
();

312 
qp0
 = 
	`rcu_d”eã»nû
(
ibp
->
rvp
.
qp
[0]);

313 ià(
qp0
)

314 
ah
 = 
	`rdma_ü—‹_ah
(
qp0
->
ibqp
.
pd
, &
©Œ
, 0);

315 
	`rcu_»ad_uÆock
();

316  
ah
;

317 
	}
}

319 
	$£nd_Œ­
(
hfi1_ibpÜt
 *
ibp
, 
Œ­_node
 *
Œ­
)

321 
ib_mad_£nd_buf
 *
£nd_buf
;

322 
ib_mad_ag’t
 *
ag’t
;

323 
Ýa_smp
 *
smp
;

324 
æags
;

325 
pkey_idx
;

326 
u32
 
q²
 = 
	`µd_äom_ibp
(
ibp
)->
sm_Œ­_qp
;

328 
ag’t
 = 
ibp
->
rvp
.
£nd_ag’t
;

329 ià(!
ag’t
) {

330 
	`þ—nup_Œ­s
(
ibp
, 
Œ­
);

335 ià(
	`driv”_l¡©e
(
	`µd_äom_ibp
(
ibp
)è!ð
IB_PORT_ACTIVE
) {

336 
	`þ—nup_Œ­s
(
ibp
, 
Œ­
);

341 
Œ­
 = 
	`check_ªd_add_Œ­
(
ibp
,rap);

342 ià(!
Œ­
)

345 
pkey_idx
 = 
	`hfi1_lookup_pkey_idx
(
ibp
, 
LIM_MGMT_P_KEY
);

346 ià(
pkey_idx
 < 0) {

347 
	`´_w¬n
("%s: failedo find†imited mgmt…key, defaulting 0x%x\n",

348 
__func__
, 
	`hfi1_g‘_pkey
(
ibp
, 1));

349 
pkey_idx
 = 1;

352 
£nd_buf
 = 
	`ib_ü—‹_£nd_mad
(
ag’t
, 
q²
, 
pkey_idx
, 0,

353 
IB_MGMT_MAD_HDR
, 
IB_MGMT_MAD_DATA
,

354 
GFP_ATOMIC
, 
IB_MGMT_BASE_VERSION
);

355 ià(
	`IS_ERR
(
£nd_buf
))

358 
smp
 = 
£nd_buf
->
mad
;

359 
smp
->
ba£_v”siÚ
 = 
OPA_MGMT_BASE_VERSION
;

360 
smp
->
mgmt_þass
 = 
IB_MGMT_CLASS_SUBN_LID_ROUTED
;

361 
smp
->
þass_v”siÚ
 = 
OPA_SM_CLASS_VERSION
;

362 
smp
->
m‘hod
 = 
IB_MGMT_METHOD_TRAP
;

365 ià(
Œ­
->
tid
 == 0) {

366 
ibp
->
rvp
.
tid
++;

368 ià(
ibp
->
rvp
.
tid
 == 0)

369 
ibp
->
rvp
.
tid
++;

370 
Œ­
->
tid
 = 
	`ýu_to_be64
(
ibp
->
rvp
.tid);

372 
smp
->
tid
 = 
Œ­
->tid;

374 
smp
->
©Œ_id
 = 
IB_SMP_ATTR_NOTICE
;

377 
	`memýy
(
smp
->
rou‹
.
lid
.
d©a
, &
Œ­
->d©a,¿p->
Ën
);

379 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

380 ià(!
ibp
->
rvp
.
sm_ah
) {

381 ià(
ibp
->
rvp
.
sm_lid
 !ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
)) {

382 
ib_ah
 *
ah
;

384 
ah
 = 
	`hfi1_ü—‹_qp0_ah
(
ibp
, ibp->
rvp
.
sm_lid
);

385 ià(
	`IS_ERR
(
ah
)) {

386 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

389 
£nd_buf
->
ah
 =‡h;

390 
ibp
->
rvp
.
sm_ah
 = 
	`ibah_to_rvh
(
ah
);

392 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

396 
£nd_buf
->
ah
 = &
ibp
->
rvp
.
sm_ah
->
ibah
;

403 ià(
Œ­
->
»´ess
) {

404 
	`li¡_d–
(&
Œ­
->
li¡
);

405 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

406 
	`kä“
(
Œ­
);

407 
	`ib_ä“_£nd_mad
(
£nd_buf
);

411 
Œ­
->
š_u£
 = 0;

412 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

414 ià(
	`ib_po¡_£nd_mad
(
£nd_buf
, 
NULL
))

415 
	`ib_ä“_£nd_mad
(
£nd_buf
);

416 
	}
}

418 
	$hfi1_hªdË_Œ­_tim”
(
tim”_li¡
 *
t
)

420 
hfi1_ibpÜt
 *
ibp
 = 
	`äom_tim”
(ibp, 
t
, 
rvp
.
Œ­_tim”
);

421 
Œ­_node
 *
Œ­
 = 
NULL
;

422 
æags
;

423 
i
;

426 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

427 
i
 = 0; !
Œ­
 && i < 
RVT_MAX_TRAP_LISTS
; i++) {

428 
Œ­
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
ibp
->
rvp
.
Œ­_li¡s
[
i
].
li¡
,

429 
Œ­_node
, 
li¡
);

431 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

433 ià(
Œ­
)

434 
	`£nd_Œ­
(
ibp
, 
Œ­
);

435 
	}
}

437 
Œ­_node
 *
	$ü—‹_Œ­_node
(
u8
 
ty³
, 
__be16
 
Œ­_num
, 
u32
 
lid
)

439 
Œ­_node
 *
Œ­
;

441 
Œ­
 = 
	`kz®loc
((*Œ­), 
GFP_ATOMIC
);

442 ià(!
Œ­
)

443  
NULL
;

445 
	`INIT_LIST_HEAD
(&
Œ­
->
li¡
);

446 
Œ­
->
d©a
.
g’”ic_ty³
 = 
ty³
;

447 
Œ­
->
d©a
.
´od_ty³_lsb
 = 
IB_NOTICE_PROD_CA
;

448 
Œ­
->
d©a
.
Œ­_num
 =rap_num;

449 
Œ­
->
d©a
.
issu”_lid
 = 
	`ýu_to_be32
(
lid
);

451  
Œ­
;

452 
	}
}

457 
	$hfi1_bad_pkey
(
hfi1_ibpÜt
 *
ibp
, 
u32
 
key
, u32 
¦
,

458 
u32
 
qp1
, u32 
qp2
, u32 
lid1
, u32 
lid2
)

460 
Œ­_node
 *
Œ­
;

461 
u32
 
lid
 = 
	`µd_äom_ibp
(
ibp
)->lid;

463 
ibp
->
rvp
.
n_pkt_drÝs
++;

464 
ibp
->
rvp
.
pkey_viÞ©iÚs
++;

466 
Œ­
 = 
	`ü—‹_Œ­_node
(
IB_NOTICE_TYPE_SECURITY
, 
OPA_TRAP_BAD_P_KEY
,

467 
lid
);

468 ià(!
Œ­
)

472 
Œ­
->
d©a
.
Ác_257_258
.
lid1
 = 
	`ýu_to_be32
(lid1);

473 
Œ­
->
d©a
.
Ác_257_258
.
lid2
 = 
	`ýu_to_be32
(lid2);

474 
Œ­
->
d©a
.
Ác_257_258
.
key
 = 
	`ýu_to_be32
(key);

475 
Œ­
->
d©a
.
Ác_257_258
.
¦
 = sl << 3;

476 
Œ­
->
d©a
.
Ác_257_258
.
qp1
 = 
	`ýu_to_be32
(qp1);

477 
Œ­
->
d©a
.
Ác_257_258
.
qp2
 = 
	`ýu_to_be32
(qp2);

479 
Œ­
->
Ën
 = Ñ¿p->
d©a
);

480 
	`£nd_Œ­
(
ibp
, 
Œ­
);

481 
	}
}

486 
	$bad_mkey
(
hfi1_ibpÜt
 *
ibp
, 
ib_mad_hdr
 *
mad
,

487 
__be64
 
mkey
, 
__be32
 
dr_¦id
, 
u8
 
»tuº_·th
[], u8 
hÝ_út
)

489 
Œ­_node
 *
Œ­
;

490 
u32
 
lid
 = 
	`µd_äom_ibp
(
ibp
)->lid;

492 
Œ­
 = 
	`ü—‹_Œ­_node
(
IB_NOTICE_TYPE_SECURITY
, 
OPA_TRAP_BAD_M_KEY
,

493 
lid
);

494 ià(!
Œ­
)

498 
Œ­
->
d©a
.
Ác_256
.
lid
 =¿p->d©a.
issu”_lid
;

499 
Œ­
->
d©a
.
Ác_256
.
m‘hod
 = 
mad
->method;

500 
Œ­
->
d©a
.
Ác_256
.
©Œ_id
 = 
mad
->attr_id;

501 
Œ­
->
d©a
.
Ác_256
.
©Œ_mod
 = 
mad
->attr_mod;

502 
Œ­
->
d©a
.
Ác_256
.
mkey
 = mkey;

503 ià(
mad
->
mgmt_þass
 =ð
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
) {

504 
Œ­
->
d©a
.
Ác_256
.
dr_¦id
 = dr_slid;

505 
Œ­
->
d©a
.
Ác_256
.
dr_Œunc_hÝ
 = 
IB_NOTICE_TRAP_DR_NOTICE
;

506 ià(
hÝ_út
 > 
	`ARRAY_SIZE
(
Œ­
->
d©a
.
Ác_256
.
dr_¹n_·th
)) {

507 
Œ­
->
d©a
.
Ác_256
.
dr_Œunc_hÝ
 |=

508 
IB_NOTICE_TRAP_DR_TRUNC
;

509 
hÝ_út
 = 
	`ARRAY_SIZE
(
Œ­
->
d©a
.
Ác_256
.
dr_¹n_·th
);

511 
Œ­
->
d©a
.
Ác_256
.
dr_Œunc_hÝ
 |ð
hÝ_út
;

512 
	`memýy
(
Œ­
->
d©a
.
Ác_256
.
dr_¹n_·th
, 
»tuº_·th
,

513 
hÝ_út
);

516 
Œ­
->
Ën
 = Ñ¿p->
d©a
);

518 
	`£nd_Œ­
(
ibp
, 
Œ­
);

519 
	}
}

524 
	$hfi1_ÿp_mask_chg
(
rvt_dev_šfo
 *
rdi
, 
u8
 
pÜt_num
)

526 
Œ­_node
 *
Œ­
;

527 
hfi1_ibdev
 *
v”bs_dev
 = 
	`dev_äom_rdi
(
rdi
);

528 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
v”bs_dev
);

529 
hfi1_ibpÜt
 *
ibp
 = &
dd
->
µÜt
[
pÜt_num
 - 1].
ibpÜt_d©a
;

530 
u32
 
lid
 = 
	`µd_äom_ibp
(
ibp
)->lid;

532 
Œ­
 = 
	`ü—‹_Œ­_node
(
IB_NOTICE_TYPE_INFO
,

533 
OPA_TRAP_CHANGE_CAPABILITY
,

534 
lid
);

535 ià(!
Œ­
)

538 
Œ­
->
d©a
.
Ác_144
.
lid
 =¿p->d©a.
issu”_lid
;

539 
Œ­
->
d©a
.
Ác_144
.
Ãw_ÿp_mask
 = 
	`ýu_to_be32
(
ibp
->
rvp
.
pÜt_ÿp_æags
);

540 
Œ­
->
d©a
.
Ác_144
.
ÿp_mask3
 = 
	`ýu_to_be16
(
ibp
->
rvp
.
pÜt_ÿp3_æags
);

542 
Œ­
->
Ën
 = Ñ¿p->
d©a
);

543 
	`£nd_Œ­
(
ibp
, 
Œ­
);

544 
	}
}

549 
	$hfi1_sys_guid_chg
(
hfi1_ibpÜt
 *
ibp
)

551 
Œ­_node
 *
Œ­
;

552 
u32
 
lid
 = 
	`µd_äom_ibp
(
ibp
)->lid;

554 
Œ­
 = 
	`ü—‹_Œ­_node
(
IB_NOTICE_TYPE_INFO
, 
OPA_TRAP_CHANGE_SYSGUID
,

555 
lid
);

556 ià(!
Œ­
)

559 
Œ­
->
d©a
.
Ác_145
.
Ãw_sys_guid
 = 
ib_hfi1_sys_image_guid
;

560 
Œ­
->
d©a
.
Ác_145
.
lid
 =¿p->d©a.
issu”_lid
;

562 
Œ­
->
Ën
 = Ñ¿p->
d©a
);

563 
	`£nd_Œ­
(
ibp
, 
Œ­
);

564 
	}
}

569 
	$hfi1_node_desc_chg
(
hfi1_ibpÜt
 *
ibp
)

571 
Œ­_node
 *
Œ­
;

572 
u32
 
lid
 = 
	`µd_äom_ibp
(
ibp
)->lid;

574 
Œ­
 = 
	`ü—‹_Œ­_node
(
IB_NOTICE_TYPE_INFO
,

575 
OPA_TRAP_CHANGE_CAPABILITY
,

576 
lid
);

577 ià(!
Œ­
)

580 
Œ­
->
d©a
.
Ác_144
.
lid
 =¿p->d©a.
issu”_lid
;

581 
Œ­
->
d©a
.
Ác_144
.
chªge_æags
 =

582 
	`ýu_to_be16
(
OPA_NOTICE_TRAP_NODE_DESC_CHG
);

584 
Œ­
->
Ën
 = Ñ¿p->
d©a
);

585 
	`£nd_Œ­
(
ibp
, 
Œ­
);

586 
	}
}

588 
	$__subn_g‘_Ýa_nodedesc
(
Ýa_smp
 *
smp
, 
u32
 
am
,

589 
u8
 *
d©a
, 
ib_deviû
 *
ibdev
,

590 
u8
 
pÜt
, 
u32
 *
»¥_Ën
, u32 
max_Ën
)

592 
Ýa_node_desütiÚ
 *
nd
;

594 ià(
am
 || 
	`smp_Ëngth_check
((*
nd
), 
max_Ën
)) {

595 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

596  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

599 
nd
 = (
Ýa_node_desütiÚ
 *)
d©a
;

601 
	`memýy
(
nd
->
d©a
, 
ibdev
->
node_desc
, (nd->data));

603 ià(
»¥_Ën
)

604 *
»¥_Ën
 +ð(*
nd
);

606  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

607 
	}
}

609 
	$__subn_g‘_Ýa_nodešfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

610 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

611 
u32
 *
»¥_Ën
, u32 
max_Ën
)

613 
Ýa_node_šfo
 *
ni
;

614 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

615 
pidx
 = 
pÜt
 - 1;

617 
ni
 = (
Ýa_node_šfo
 *)
d©a
;

620 ià(
am
 || 
pidx
 >ð
dd
->
num_µÜts
 || 
ibdev
->
node_guid
 == 0 ||

621 
	`smp_Ëngth_check
((*
ni
), 
max_Ën
) ||

622 
	`g‘_sguid
(
	`to_Üt
(
ibdev
, 
pÜt
), 
HFI1_PORT_GUID_INDEX
) == 0) {

623 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

624  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

627 
ni
->
pÜt_guid
 = 
	`g‘_sguid
(
	`to_Üt
(
ibdev
, 
pÜt
), 
HFI1_PORT_GUID_INDEX
);

628 
ni
->
ba£_v”siÚ
 = 
OPA_MGMT_BASE_VERSION
;

629 
ni
->
þass_v”siÚ
 = 
OPA_SM_CLASS_VERSION
;

630 
ni
->
node_ty³
 = 1;

631 
ni
->
num_pÜts
 = 
ibdev
->
phys_pÜt_út
;

633 
ni
->
sy¡em_image_guid
 = 
ib_hfi1_sys_image_guid
;

634 
ni
->
node_guid
 = 
ibdev
->node_guid;

635 
ni
->
·¹™iÚ_ÿp
 = 
	`ýu_to_be16
(
	`hfi1_g‘_Åkeys
(
dd
));

636 
ni
->
deviû_id
 = 
	`ýu_to_be16
(
dd
->
pcidev
->
deviû
);

637 
ni
->
»visiÚ
 = 
	`ýu_to_be32
(
dd
->
mš»v
);

638 
ni
->
loÿl_pÜt_num
 = 
pÜt
;

639 
ni
->
v’dÜ_id
[0] = 
dd
->
oui1
;

640 
ni
->
v’dÜ_id
[1] = 
dd
->
oui2
;

641 
ni
->
v’dÜ_id
[2] = 
dd
->
oui3
;

643 ià(
»¥_Ën
)

644 *
»¥_Ën
 +ð(*
ni
);

646  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

647 
	}
}

649 
	$subn_g‘_nodešfo
(
ib_smp
 *
smp
, 
ib_deviû
 *
ibdev
,

650 
u8
 
pÜt
)

652 
ib_node_šfo
 *
n
 = (ib_node_šfØ*)&
smp
->
d©a
;

653 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

654 
pidx
 = 
pÜt
 - 1;

657 ià(
smp
->
©Œ_mod
 || 
pidx
 >ð
dd
->
num_µÜts
 ||

658 
ibdev
->
node_guid
 == 0 ||

659 
	`g‘_sguid
(
	`to_Üt
(
ibdev
, 
pÜt
), 
HFI1_PORT_GUID_INDEX
) == 0) {

660 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

661  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

664 
n
->
pÜt_guid
 = 
	`g‘_sguid
(
	`to_Üt
(
ibdev
, 
pÜt
), 
HFI1_PORT_GUID_INDEX
);

665 
n
->
ba£_v”siÚ
 = 
OPA_MGMT_BASE_VERSION
;

666 
n
->
þass_v”siÚ
 = 
OPA_SM_CLASS_VERSION
;

667 
n
->
node_ty³
 = 1;

668 
n
->
num_pÜts
 = 
ibdev
->
phys_pÜt_út
;

670 
n
->
sys_guid
 = 
ib_hfi1_sys_image_guid
;

671 
n
->
node_guid
 = 
ibdev
->node_guid;

672 
n
->
·¹™iÚ_ÿp
 = 
	`ýu_to_be16
(
	`hfi1_g‘_Åkeys
(
dd
));

673 
n
->
deviû_id
 = 
	`ýu_to_be16
(
dd
->
pcidev
->
deviû
);

674 
n
->
»visiÚ
 = 
	`ýu_to_be32
(
dd
->
mš»v
);

675 
n
->
loÿl_pÜt_num
 = 
pÜt
;

676 
n
->
v’dÜ_id
[0] = 
dd
->
oui1
;

677 
n
->
v’dÜ_id
[1] = 
dd
->
oui2
;

678 
n
->
v’dÜ_id
[2] = 
dd
->
oui3
;

680  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

681 
	}
}

683 
	$£t_lšk_width_’abËd
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
w
)

685 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_LWID_ENB
, 
w
);

686 
	}
}

688 
	$£t_lšk_width_downg¿de_’abËd
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
w
)

690 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_LWID_DG_ENB
, 
w
);

691 
	}
}

693 
	$£t_lšk_¥“d_’abËd
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
s
)

695 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_SPD_ENB
, 
s
);

696 
	}
}

698 
	$check_mkey
(
hfi1_ibpÜt
 *
ibp
, 
ib_mad_hdr
 *
mad
,

699 
mad_æags
, 
__be64
 
mkey
, 
__be32
 
dr_¦id
,

700 
u8
 
»tuº_·th
[], u8 
hÝ_út
)

702 
v®id_mkey
 = 0;

703 
»t
 = 0;

706 ià(
ibp
->
rvp
.
mkey_Ëa£_timeout
 &&

707 
	`time_aá”_eq
(
jiff›s
, 
ibp
->
rvp
.
mkey_Ëa£_timeout
)) {

709 
ibp
->
rvp
.
mkey_Ëa£_timeout
 = 0;

710 
ibp
->
rvp
.
mkey´Ù
 = 0;

713 ià((
mad_æags
 & 
IB_MAD_IGNORE_MKEY
è|| 
ibp
->
rvp
.
mkey
 == 0 ||

714 
ibp
->
rvp
.
mkey
 == mkey)

715 
v®id_mkey
 = 1;

718 ià(
v®id_mkey
 && 
ibp
->
rvp
.
mkey_Ëa£_timeout
 &&

719 (
mad
->
m‘hod
 =ð
IB_MGMT_METHOD_GET
 ||

720 
mad
->
m‘hod
 =ð
IB_MGMT_METHOD_SET
 ||

721 
mad
->
m‘hod
 =ð
IB_MGMT_METHOD_TRAP_REPRESS
))

722 
ibp
->
rvp
.
mkey_Ëa£_timeout
 = 0;

724 ià(!
v®id_mkey
) {

725 
mad
->
m‘hod
) {

726 
IB_MGMT_METHOD_GET
:

728 ià(
ibp
->
rvp
.
mkey´Ù
 < 2)

731 
IB_MGMT_METHOD_SET
:

732 
IB_MGMT_METHOD_TRAP_REPRESS
:

733 ià(
ibp
->
rvp
.
mkey_viÞ©iÚs
 != 0xFFFF)

734 ++
ibp
->
rvp
.
mkey_viÞ©iÚs
;

735 ià(!
ibp
->
rvp
.
mkey_Ëa£_timeout
 &&

736 
ibp
->
rvp
.
mkey_Ëa£_³riod
)

737 
ibp
->
rvp
.
mkey_Ëa£_timeout
 = 
jiff›s
 +

738 
ibp
->
rvp
.
mkey_Ëa£_³riod
 * 
HZ
;

740 
	`bad_mkey
(
ibp
, 
mad
, 
mkey
, 
dr_¦id
, 
»tuº_·th
,

741 
hÝ_út
);

742 
»t
 = 1;

746  
»t
;

747 
	}
}

753 
	slcb_d©um
 {

754 
u32
 
	moff
;

755 
u64
 
	mv®
;

758 
lcb_d©um
 
	glcb_ÿche
[] = {

759 { 
DC_LCB_STS_ROUND_TRIP_LTP_CNT
, 0 },

762 
	$wr™e_lcb_ÿche
(
u32
 
off
, 
u64
 
v®
)

764 
i
;

766 
i
 = 0; i < 
	`ARRAY_SIZE
(
lcb_ÿche
); i++) {

767 ià(
lcb_ÿche
[
i
].
off
 == off) {

768 
lcb_ÿche
[
i
].
v®
 = val;

773 
	`´_w¬n
("% bad off£ˆ0x%x\n", 
__func__
, 
off
);

775 
	}
}

777 
	$»ad_lcb_ÿche
(
u32
 
off
, 
u64
 *
v®
)

779 
i
;

781 
i
 = 0; i < 
	`ARRAY_SIZE
(
lcb_ÿche
); i++) {

782 ià(
lcb_ÿche
[
i
].
off
 == off) {

783 *
v®
 = 
lcb_ÿche
[
i
].val;

788 
	`´_w¬n
("% bad off£ˆ0x%x\n", 
__func__
, 
off
);

790 
	}
}

792 
	$»ad_Ép_¹t
(
hfi1_devd©a
 *
dd
)

794 
u64
 
»g
;

796 ià(
	`»ad_lcb_c¤
(
dd
, 
DC_LCB_STS_ROUND_TRIP_LTP_CNT
, &
»g
))

797 
	`dd_dev_”r
(
dd
, "%s: uÇbËØ»ad LTP RTT\n", 
__func__
);

799 
	`wr™e_lcb_ÿche
(
DC_LCB_STS_ROUND_TRIP_LTP_CNT
, 
»g
);

800 
	}
}

802 
	$__subn_g‘_Ýa_pÜtšfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

803 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

804 
u32
 *
»¥_Ën
, u32 
max_Ën
)

806 
i
;

807 
hfi1_devd©a
 *
dd
;

808 
hfi1_µÜtd©a
 *
µd
;

809 
hfi1_ibpÜt
 *
ibp
;

810 
Ýa_pÜt_šfo
 *
pi
 = (Ýa_pÜt_šfØ*)
d©a
;

811 
u8
 
mtu
;

812 
u8
 
üed™_¿‹
;

813 
u8
 
is_b—cÚšg_aùive
;

814 
u32
 
¡©e
;

815 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

816 
u32
 
¡¬t_of_sm_cÚfig
 = 
	`OPA_AM_START_SM_CFG
(
am
);

817 
u32
 
bufãr_un™s
;

818 
u64
 
tmp
 = 0;

820 ià(
num_pÜts
 !ð1 || 
	`smp_Ëngth_check
((*
pi
), 
max_Ën
)) {

821 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

822  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

825 
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

827 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

828 
ibp
 = &
µd
->
ibpÜt_d©a
;

830 ià(
µd
->
vls_suµÜ‹d
 / 2 > 
	`ARRAY_SIZE
(
pi
->
Ãigh_mtu
.
pvlx_to_mtu
) ||

831 
µd
->
vls_suµÜ‹d
 > 
	`ARRAY_SIZE
(
dd
->
vld
)) {

832 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

833  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

836 
pi
->
lid
 = 
	`ýu_to_be32
(
µd
->lid);

839 ià(!(
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_GET
 &&

840 
ibp
->
rvp
.
mkey
 !ð
smp
->mkey &&

841 
ibp
->
rvp
.
mkey´Ù
 == 1))

842 
pi
->
mkey
 = 
ibp
->
rvp
.mkey;

844 
pi
->
subÃt_´efix
 = 
ibp
->
rvp
.
gid_´efix
;

845 
pi
->
sm_lid
 = 
	`ýu_to_be32
(
ibp
->
rvp
.sm_lid);

846 
pi
->
ib_ÿp_mask
 = 
	`ýu_to_be32
(
ibp
->
rvp
.
pÜt_ÿp_æags
);

847 
pi
->
mkey_Ëa£_³riod
 = 
	`ýu_to_be16
(
ibp
->
rvp
.mkey_lease_period);

848 
pi
->
sm_Œ­_qp
 = 
	`ýu_to_be32
(
µd
->sm_trap_qp);

849 
pi
->
§_qp
 = 
	`ýu_to_be32
(
µd
->sa_qp);

851 
pi
->
lšk_width
.
’abËd
 = 
	`ýu_to_be16
(
µd
->
lšk_width_’abËd
);

852 
pi
->
lšk_width
.
suµÜ‹d
 = 
	`ýu_to_be16
(
µd
->
lšk_width_suµÜ‹d
);

853 
pi
->
lšk_width
.
aùive
 = 
	`ýu_to_be16
(
µd
->
lšk_width_aùive
);

855 
pi
->
lšk_width_downg¿de
.
suµÜ‹d
 =

856 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_suµÜ‹d
);

857 
pi
->
lšk_width_downg¿de
.
’abËd
 =

858 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_’abËd
);

859 
pi
->
lšk_width_downg¿de
.
tx_aùive
 =

860 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_tx_aùive
);

861 
pi
->
lšk_width_downg¿de
.
rx_aùive
 =

862 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_rx_aùive
);

864 
pi
->
lšk_¥“d
.
suµÜ‹d
 = 
	`ýu_to_be16
(
µd
->
lšk_¥“d_suµÜ‹d
);

865 
pi
->
lšk_¥“d
.
aùive
 = 
	`ýu_to_be16
(
µd
->
lšk_¥“d_aùive
);

866 
pi
->
lšk_¥“d
.
’abËd
 = 
	`ýu_to_be16
(
µd
->
lšk_¥“d_’abËd
);

868 
¡©e
 = 
	`driv”_l¡©e
(
µd
);

870 ià(
¡¬t_of_sm_cÚfig
 && (
¡©e
 =ð
IB_PORT_INIT
))

871 
µd
->
is_sm_cÚfig_¡¬‹d
 = 1;

873 
pi
->
pÜt_phys_cÚf
 = (
µd
->
pÜt_ty³
 & 0xf);

875 
pi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 = 
µd
->
ÃighbÜ_nÜm®
 << 4;

876 
pi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 |=

877 
µd
->
is_sm_cÚfig_¡¬‹d
 << 5;

883 
	`smp_rmb
();

884 
is_b—cÚšg_aùive
 = !!
	`©omic_»ad
(&
µd
->
Ëd_ov”ride_tim”_aùive
);

885 
pi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 |ð
is_b—cÚšg_aùive
 << 6;

886 
pi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 |=

887 
µd
->
ofæše_di§bËd_»asÚ
;

889 
pi
->
pÜt_¡©es
.
pÜhys¡©e_pÜt¡©e
 =

890 (
	`driv”_p¡©e
(
µd
è<< 4è| 
¡©e
;

892 
pi
->
mkey´Ùeù_lmc
 = (
ibp
->
rvp
.
mkey´Ù
 << 6è| 
µd
->
lmc
;

894 
	`mem£t
(
pi
->
Ãigh_mtu
.
pvlx_to_mtu
, 0, (pi->neigh_mtu.pvlx_to_mtu));

895 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++) {

896 
mtu
 = 
	`mtu_to_’um
(
dd
->
vld
[
i
].mtu, 
HFI1_DEFAULT_ACTIVE_MTU
);

897 ià((
i
 % 2) == 0)

898 
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[
i
 / 2] |ð(
mtu
 << 4);

900 
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[
i
 / 2] |ð
mtu
;

903 
mtu
 = 
	`mtu_to_’um
(
dd
->
vld
[15].mtu, 2048);

904 
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[15 / 2] |ð
mtu
;

905 
pi
->
sm¦
 = 
ibp
->
rvp
.
sm_¦
 & 
OPA_PI_MASK_SMSL
;

906 
pi
->
Ý”©iÚ®_vls
 = 
	`hfi1_g‘_ib_cfg
(
µd
, 
HFI1_IB_CFG_OP_VLS
);

907 
pi
->
·¹’fÜû_fž‹¼aw
 |=

908 (
µd
->
lškš™_»asÚ
 & 
OPA_PI_MASK_LINKINIT_REASON
);

909 ià(
µd
->
·¹_’fÜû
 & 
HFI1_PART_ENFORCE_IN
)

910 
pi
->
·¹’fÜû_fž‹¼aw
 |ð
OPA_PI_MASK_PARTITION_ENFORCE_IN
;

911 ià(
µd
->
·¹_’fÜû
 & 
HFI1_PART_ENFORCE_OUT
)

912 
pi
->
·¹’fÜû_fž‹¼aw
 |ð
OPA_PI_MASK_PARTITION_ENFORCE_OUT
;

913 
pi
->
mkey_viÞ©iÚs
 = 
	`ýu_to_be16
(
ibp
->
rvp
.mkey_violations);

915 
pi
->
pkey_viÞ©iÚs
 = 
	`ýu_to_be16
(
ibp
->
rvp
.pkey_violations);

916 
pi
->
qkey_viÞ©iÚs
 = 
	`ýu_to_be16
(
ibp
->
rvp
.qkey_violations);

918 
pi
->
vl
.
ÿp
 = 
µd
->
vls_suµÜ‹d
;

919 
pi
->
vl
.
high_lim™
 = 
	`ýu_to_be16
(
ibp
->
rvp
.
vl_high_lim™
);

920 
pi
->
vl
.
¬b_high_ÿp
 = (
u8
)
	`hfi1_g‘_ib_cfg
(
µd
, 
HFI1_IB_CFG_VL_HIGH_CAP
);

921 
pi
->
vl
.
¬b_low_ÿp
 = (
u8
)
	`hfi1_g‘_ib_cfg
(
µd
, 
HFI1_IB_CFG_VL_LOW_CAP
);

923 
pi
->
þ›Á»»g_subÃ‰imeout
 = 
ibp
->
rvp
.
subÃt_timeout
;

925 
pi
->
pÜt_lšk_mode
 = 
	`ýu_to_be16
(
OPA_PORT_LINK_MODE_OPA
 << 10 |

926 
OPA_PORT_LINK_MODE_OPA
 << 5 |

927 
OPA_PORT_LINK_MODE_OPA
);

929 
pi
->
pÜt_Ép_üc_mode
 = 
	`ýu_to_be16
(
µd
->port_ltp_crc_mode);

931 
pi
->
pÜt_mode
 = 
	`ýu_to_be16
(

932 
µd
->
is_aùive_Ýtimize_’abËd
 ?

933 
OPA_PI_MASK_PORT_ACTIVE_OPTOMIZE
 : 0);

935 
pi
->
pÜt_·ck‘_fÜm©
.
suµÜ‹d
 =

936 
	`ýu_to_be16
(
OPA_PORT_PACKET_FORMAT_9B
 |

937 
OPA_PORT_PACKET_FORMAT_16B
);

938 
pi
->
pÜt_·ck‘_fÜm©
.
’abËd
 =

939 
	`ýu_to_be16
(
OPA_PORT_PACKET_FORMAT_9B
 |

940 
OPA_PORT_PACKET_FORMAT_16B
);

955 
pi
->
æ™_cÚŒÞ
.
š‹¾—ve
 = 
	`ýu_to_be16
(0x1400);

957 
pi
->
lšk_down_»asÚ
 = 
µd
->
loÿl_lšk_down_»asÚ
.
sma
;

958 
pi
->
Ãigh_lšk_down_»asÚ
 = 
µd
->Ãigh_lšk_down_»asÚ.
sma
;

959 
pi
->
pÜt_”rÜ_aùiÚ
 = 
	`ýu_to_be32
(
µd
->port_error_action);

960 
pi
->
mtuÿp
 = 
	`mtu_to_’um
(
hfi1_max_mtu
, 
IB_MTU_4096
);

963 
pi
->
»¥timev®ue
 = 3;

965 
pi
->
loÿl_pÜt_num
 = 
pÜt
;

968 
pi
->
ov”®l_bufãr_¥aû
 = 
	`ýu_to_be16
(
dd
->
lšk_üed™s
);

970 
pi
->
Ãigh_node_guid
 = 
	`ýu_to_be64
(
µd
->
ÃighbÜ_guid
);

971 
pi
->
Ãigh_pÜt_num
 = 
µd
->
ÃighbÜ_pÜt_numb”
;

972 
pi
->
pÜt_Ãigh_mode
 =

973 (
µd
->
ÃighbÜ_ty³
 & 
OPA_PI_MASK_NEIGH_NODE_TYPE
) |

974 (
µd
->
mgmt_®lowed
 ? 
OPA_PI_MASK_NEIGH_MGMT_ALLOWED
 : 0) |

975 (
µd
->
ÃighbÜ_fm_£cur™y
 ?

976 
OPA_PI_MASK_NEIGH_FW_AUTH_BYPASS
 : 0);

981 
üed™_¿‹
 = 0;

982 
bufãr_un™s
 = (
dd
->
vau
è& 
OPA_PI_MASK_BUF_UNIT_BUF_ALLOC
;

983 
bufãr_un™s
 |ð(
dd
->
vcu
 << 3è& 
OPA_PI_MASK_BUF_UNIT_CREDIT_ACK
;

984 
bufãr_un™s
 |ð(
üed™_¿‹
 << 6) &

985 
OPA_PI_MASK_BUF_UNIT_VL15_CREDIT_RATE
;

986 
bufãr_un™s
 |ð(
dd
->
vl15_š™
 << 11è& 
OPA_PI_MASK_BUF_UNIT_VL15_INIT
;

987 
pi
->
bufãr_un™s
 = 
	`ýu_to_be32
(buffer_units);

989 
pi
->
Ýa_ÿp_mask
 = 
	`ýu_to_be16
(
ibp
->
rvp
.
pÜt_ÿp3_æags
);

990 
pi
->
cÞËùivemask_muÉiÿ¡mask
 = ((
OPA_COLLECTIVE_NR
 & 0x7)

991 << 3 | (
OPA_MCAST_NR
 & 0x7));

994 
pi
->
»¶ay_d•th
.
bufãr
 = 0x80;

996 
	`»ad_lcb_ÿche
(
DC_LCB_STS_ROUND_TRIP_LTP_CNT
, &
tmp
);

1002 ià(
tmp
 > 0xff)

1003 
tmp
 = 0xff;

1004 
pi
->
»¶ay_d•th
.
wœe
 = 
tmp
;

1006 ià(
»¥_Ën
)

1007 *
»¥_Ën
 +ð(
Ýa_pÜt_šfo
);

1009  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1010 
	}
}

1018 
	$g‘_pkeys
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
, 
u16
 *
pkeys
)

1020 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
 + 
pÜt
 - 1;

1022 
	`memýy
(
pkeys
, 
µd
->pkeys, (ppd->pkeys));

1025 
	}
}

1027 
	$__subn_g‘_Ýa_pkeybË
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1028 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1029 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1031 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1032 
u32
 
n_blocks_»q
 = 
	`OPA_AM_NBLK
(
am
);

1033 
u32
 
¡¬t_block
 = 
am
 & 0x7ff;

1034 
__be16
 *
p
;

1035 
u16
 *
q
;

1036 
i
;

1037 
u16
 
n_blocks_avaž
;

1038 
Åkeys
 = 
	`hfi1_g‘_Åkeys
(
dd
);

1039 
size_t
 
size
;

1041 ià(
n_blocks_»q
 == 0) {

1042 
	`´_w¬n
("OPA Get PKey AM Invalid : P = %d; B = 0x%x; N = 0x%x\n",

1043 
pÜt
, 
¡¬t_block
, 
n_blocks_»q
);

1044 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1045  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1048 
n_blocks_avaž
 = (
u16
)(
Åkeys
 / 
OPA_PARTITION_TABLE_BLK_SIZE
) + 1;

1050 
size
 = (
n_blocks_»q
 * 
OPA_PARTITION_TABLE_BLK_SIZE
è* (
u16
);

1052 ià(
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1053 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1054  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1057 ià(
¡¬t_block
 + 
n_blocks_»q
 > 
n_blocks_avaž
 ||

1058 
n_blocks_»q
 > 
OPA_NUM_PKEY_BLOCKS_PER_SMP
) {

1059 
	`´_w¬n
("OPA Get PKey AM Invalid : s 0x%x;„eq 0x%x; "

1061 
¡¬t_block
, 
n_blocks_»q
, 
n_blocks_avaž
,

1062 
OPA_NUM_PKEY_BLOCKS_PER_SMP
);

1063 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1064  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1067 
p
 = (
__be16
 *)
d©a
;

1068 
q
 = (
u16
 *)
d©a
;

1070 ià(
¡¬t_block
 == 0) {

1071 
	`g‘_pkeys
(
dd
, 
pÜt
, 
q
);

1072 
i
 = 0; i < 
Åkeys
; i++)

1073 
p
[
i
] = 
	`ýu_to_be16
(
q
[i]);

1074 ià(
»¥_Ën
)

1075 *
»¥_Ën
 +ð
size
;

1077 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1079  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1080 
	}
}

1083 
	mHFI_TRANSITION_DISALLOWED
,

1084 
	mHFI_TRANSITION_IGNORED
,

1085 
	mHFI_TRANSITION_ALLOWED
,

1086 
	mHFI_TRANSITION_UNDEFINED
,

1094 
	m__D
 = 
HFI_TRANSITION_DISALLOWED
,

1095 
	m__I
 = 
HFI_TRANSITION_IGNORED
,

1096 
	m__A
 = 
HFI_TRANSITION_ALLOWED
,

1097 
	m__U
 = 
HFI_TRANSITION_UNDEFINED
,

1104 
	#__N_PHYSTATES
 (
OPA_PORTPHYSSTATE_MAX
 - 
IB_PORTPHYSSTATE_POLLING
 + 1)

	)

1113 
u8
 
	m®lowed
[
__N_PHYSTATES
][__N_PHYSTATES];

1114 } 
	gphysiÿl_¡©e_Œªs™iÚs
 = {

1117  { 
__A
, __A, 
__D
, __D, __D, __D, __D, __D, __D, __D },

1118  { 
__A
, 
__I
, 
__D
, __D, __D, __D, __D, __D, __D, __A },

1119  { 
__U
, __U, __U, __U, __U, __U, __U, __U, __U, __U },

1120  { 
__A
, __A, 
__D
, 
__I
, __D, __D, __D, __D, __D, __D },

1121  { 
__U
, __U, __U, __U, __U, __U, __U, __U, __U, __U },

1122  { 
__D
, 
__A
, __D, __D, __D, 
__I
, __D, __D, __D, __D },

1123  { 
__U
, __U, __U, __U, __U, __U, __U, __U, __U, __U },

1124  { 
__I
, 
__A
, 
__D
, __D, __D, __D, __D, __I, __D, __D },

1125  { 
__U
, __U, __U, __U, __U, __U, __U, __U, __U, __U },

1126  { 
__D
, 
__A
, __D, __D, __D, __D, __D, __D, __D, 
__I
 },

1135 
	#__N_LOGICAL_STATES
 (
IB_PORT_ACTIVE_DEFER
 - 
IB_PORT_DOWN
 + 1)

	)

1144 
u8
 
	m®lowed
[
__N_LOGICAL_STATES
][__N_LOGICAL_STATES];

1145 } 
	glogiÿl_¡©e_Œªs™iÚs
 = {

1148  { 
__I
, 
__D
, __D, __D, 
__U
},

1149  { 
__D
, 
__I
, 
__A
, __D, 
__U
},

1150  { 
__D
, __D, 
__I
, 
__A
, 
__U
},

1151  { 
__D
, __D, 
__I
, __I, 
__U
},

1152  { 
__U
, __U, __U, __U, __U},

1156 
	$logiÿl_Œªs™iÚ_®lowed
(
Þd
, 
Ãw
)

1158 ià(
Þd
 < 
IB_PORT_NOP
 || old > 
IB_PORT_ACTIVE_DEFER
 ||

1159 
Ãw
 < 
IB_PORT_NOP
 ||‚ew > 
IB_PORT_ACTIVE_DEFER
) {

1160 
	`´_w¬n
("invalid†ogical state(s) (old %d‚ew %d)\n",

1161 
Þd
, 
Ãw
);

1162  
HFI_TRANSITION_UNDEFINED
;

1165 ià(
Ãw
 =ð
IB_PORT_NOP
)

1166  
HFI_TRANSITION_ALLOWED
;

1169 
Þd
 -ð
IB_PORT_DOWN
;

1170 
Ãw
 -ð
IB_PORT_DOWN
;

1172 ià(
Þd
 < 0 || 
Ãw
 < 0)

1173  
HFI_TRANSITION_UNDEFINED
;

1174  
logiÿl_¡©e_Œªs™iÚs
.
®lowed
[
Þd
][
Ãw
];

1175 
	}
}

1177 
	$physiÿl_Œªs™iÚ_®lowed
(
Þd
, 
Ãw
)

1179 ià(
Þd
 < 
IB_PORTPHYSSTATE_NOP
 || old > 
OPA_PORTPHYSSTATE_MAX
 ||

1180 
Ãw
 < 
IB_PORTPHYSSTATE_NOP
 ||‚ew > 
OPA_PORTPHYSSTATE_MAX
) {

1181 
	`´_w¬n
("invalid…hysical state(s) (old %d‚ew %d)\n",

1182 
Þd
, 
Ãw
);

1183  
HFI_TRANSITION_UNDEFINED
;

1186 ià(
Ãw
 =ð
IB_PORTPHYSSTATE_NOP
)

1187  
HFI_TRANSITION_ALLOWED
;

1190 
Þd
 -ð
IB_PORTPHYSSTATE_POLLING
;

1191 
Ãw
 -ð
IB_PORTPHYSSTATE_POLLING
;

1193 ià(
Þd
 < 0 || 
Ãw
 < 0)

1194  
HFI_TRANSITION_UNDEFINED
;

1195  
physiÿl_¡©e_Œªs™iÚs
.
®lowed
[
Þd
][
Ãw
];

1196 
	}
}

1198 
	$pÜt_¡©es_Œªs™iÚ_®lowed
(
hfi1_µÜtd©a
 *
µd
,

1199 
u32
 
logiÿl_Ãw
, u32 
physiÿl_Ãw
)

1201 
u32
 
physiÿl_Þd
 = 
	`driv”_p¡©e
(
µd
);

1202 
u32
 
logiÿl_Þd
 = 
	`driv”_l¡©e
(
µd
);

1203 
»t
, 
logiÿl_®lowed
, 
physiÿl_®lowed
;

1205 
»t
 = 
	`logiÿl_Œªs™iÚ_®lowed
(
logiÿl_Þd
, 
logiÿl_Ãw
);

1206 
logiÿl_®lowed
 = 
»t
;

1208 ià(
»t
 =ð
HFI_TRANSITION_DISALLOWED
 ||

1209 
»t
 =ð
HFI_TRANSITION_UNDEFINED
) {

1210 
	`´_w¬n
("invalid†ogical stateransition %s -> %s\n",

1211 
	`Ýa_l¡©e_Çme
(
logiÿl_Þd
),

1212 
	`Ýa_l¡©e_Çme
(
logiÿl_Ãw
));

1213  
»t
;

1216 
»t
 = 
	`physiÿl_Œªs™iÚ_®lowed
(
physiÿl_Þd
, 
physiÿl_Ãw
);

1217 
physiÿl_®lowed
 = 
»t
;

1219 ià(
»t
 =ð
HFI_TRANSITION_DISALLOWED
 ||

1220 
»t
 =ð
HFI_TRANSITION_UNDEFINED
) {

1221 
	`´_w¬n
("invalid…hysical stateransition %s -> %s\n",

1222 
	`Ýa_p¡©e_Çme
(
physiÿl_Þd
),

1223 
	`Ýa_p¡©e_Çme
(
physiÿl_Ãw
));

1224  
»t
;

1227 ià(
logiÿl_®lowed
 =ð
HFI_TRANSITION_IGNORED
 &&

1228 
physiÿl_®lowed
 =ð
HFI_TRANSITION_IGNORED
)

1229  
HFI_TRANSITION_IGNORED
;

1235 ià((
physiÿl_Þd
 =ð
OPA_PORTPHYSSTATE_OFFLINE
) &&

1236 (
physiÿl_Ãw
 =ð
IB_PORTPHYSSTATE_POLLING
))

1237  
HFI_TRANSITION_IGNORED
;

1243  
HFI_TRANSITION_ALLOWED
;

1244 
	}
}

1246 
	$£t_pÜt_¡©es
(
hfi1_µÜtd©a
 *
µd
, 
Ýa_smp
 *
smp
,

1247 
u32
 
logiÿl_¡©e
, u32 
phys_¡©e
, 
loÿl_mad
)

1249 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1250 
u32
 
lšk_¡©e
;

1251 
»t
;

1253 
»t
 = 
	`pÜt_¡©es_Œªs™iÚ_®lowed
(
µd
, 
logiÿl_¡©e
, 
phys_¡©e
);

1254 ià(
»t
 =ð
HFI_TRANSITION_DISALLOWED
 ||

1255 
»t
 =ð
HFI_TRANSITION_UNDEFINED
) {

1257 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1261 ià(
»t
 =ð
HFI_TRANSITION_IGNORED
)

1264 ià((
phys_¡©e
 !ð
IB_PORTPHYSSTATE_NOP
) &&

1265 !(
logiÿl_¡©e
 =ð
IB_PORT_DOWN
 ||

1266 
logiÿl_¡©e
 =ð
IB_PORT_NOP
)){

1267 
	`´_w¬n
("SubnSet(OPA_PortInfo)…ort state invalid:†ogical_state 0x%x…hysical_state 0x%x\n",

1268 
logiÿl_¡©e
, 
phys_¡©e
);

1269 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1277 
logiÿl_¡©e
) {

1278 
IB_PORT_NOP
:

1279 ià(
phys_¡©e
 =ð
IB_PORTPHYSSTATE_NOP
)

1282 
IB_PORT_DOWN
:

1283 ià(
phys_¡©e
 =ð
IB_PORTPHYSSTATE_NOP
) {

1284 
lšk_¡©e
 = 
HLS_DN_DOWNDEF
;

1285 } ià(
phys_¡©e
 =ð
IB_PORTPHYSSTATE_POLLING
) {

1286 
lšk_¡©e
 = 
HLS_DN_POLL
;

1287 
	`£t_lšk_down_»asÚ
(
µd
, 
OPA_LINKDOWN_REASON_FM_BOUNCE
,

1288 0, 
OPA_LINKDOWN_REASON_FM_BOUNCE
);

1289 } ià(
phys_¡©e
 =ð
IB_PORTPHYSSTATE_DISABLED
) {

1290 
lšk_¡©e
 = 
HLS_DN_DISABLE
;

1292 
	`´_w¬n
("SubnSet(OPA_PortInfo) invalid…hysical state 0x%x\n",

1293 
phys_¡©e
);

1294 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1298 ià((
lšk_¡©e
 =ð
HLS_DN_POLL
 ||

1299 
lšk_¡©e
 =ð
HLS_DN_DOWNDEF
)) {

1307 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_OFFLINE
);

1308 
	`¡¬t_lšk
(
µd
);

1310 
	`£t_lšk_¡©e
(
µd
, 
lšk_¡©e
);

1312 ià(
lšk_¡©e
 =ð
HLS_DN_DISABLE
 &&

1313 (
µd
->
ofæše_di§bËd_»asÚ
 >

1314 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_SMA_DISABLED
) ||

1315 
µd
->
ofæše_di§bËd_»asÚ
 ==

1316 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
)))

1317 
µd
->
ofæše_di§bËd_»asÚ
 =

1318 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_SMA_DISABLED
);

1323 ià(
lšk_¡©e
 =ð
HLS_DN_DISABLE
 && !
loÿl_mad
)

1324  
IB_MAD_RESULT_SUCCESS
 | 
IB_MAD_RESULT_CONSUMED
;

1326 
IB_PORT_ARMED
:

1327 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ARMED
);

1328 ià(!
»t
)

1329 
	`£nd_idË_sma
(
dd
, 
SMA_IDLE_ARM
);

1331 
IB_PORT_ACTIVE
:

1332 ià(
µd
->
ÃighbÜ_nÜm®
) {

1333 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_UP_ACTIVE
);

1334 ià(
»t
 == 0)

1335 
	`£nd_idË_sma
(
dd
, 
SMA_IDLE_ACTIVE
);

1337 
	`´_w¬n
("SubnSet(OPA_PortInfo) Cannot moveo Active with NeighborNormal 0\n");

1338 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1342 
	`´_w¬n
("SubnSet(OPA_PortInfo) invalid†ogical state 0x%x\n",

1343 
logiÿl_¡©e
);

1344 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1348 
	}
}

1357 
	$__subn_£t_Ýa_pÜtšfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1358 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1359 
u32
 *
»¥_Ën
, u32 
max_Ën
, 
loÿl_mad
)

1361 
Ýa_pÜt_šfo
 *
pi
 = (Ýa_pÜt_šfØ*)
d©a
;

1362 
ib_ev’t
 
ev’t
;

1363 
hfi1_devd©a
 *
dd
;

1364 
hfi1_µÜtd©a
 *
µd
;

1365 
hfi1_ibpÜt
 *
ibp
;

1366 
u8
 
þ›Á»»g
;

1367 
æags
;

1368 
u32
 
smlid
;

1369 
u32
 
lid
;

1370 
u8
 
ls_Þd
, 
ls_Ãw
, 
ps_Ãw
;

1371 
u8
 
vls
;

1372 
u8
 
m¦
;

1373 
u8
 
üc_’abËd
;

1374 
u16
 
l£
, 
lwe
, 
mtu
;

1375 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

1376 
u32
 
¡¬t_of_sm_cÚfig
 = 
	`OPA_AM_START_SM_CFG
(
am
);

1377 
»t
, 
i
, 
šv®id
 = 0, 
ÿÎ_£t_mtu
 = 0;

1378 
ÿÎ_lšk_downg¿de_pÞicy
 = 0;

1380 ià(
num_pÜts
 != 1 ||

1381 
	`smp_Ëngth_check
((*
pi
), 
max_Ën
)) {

1382 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1383  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1386 
lid
 = 
	`be32_to_ýu
(
pi
->lid);

1387 ià(
lid
 & 0xFF000000) {

1388 
	`´_w¬n
("OPA_PÜtInfØlid ouˆoà¿nge: %X\n", 
lid
);

1389 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1390 
g‘_Úly
;

1394 
smlid
 = 
	`be32_to_ýu
(
pi
->
sm_lid
);

1395 ià(
smlid
 & 0xFF000000) {

1396 
	`´_w¬n
("OPA_PÜtInfØSM†id ouˆoà¿nge: %X\n", 
smlid
);

1397 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1398 
g‘_Úly
;

1401 
þ›Á»»g
 = (
pi
->
þ›Á»»g_subÃ‰imeout
 &

1402 
OPA_PI_MASK_CLIENT_REREGISTER
);

1404 
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1406 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

1407 
ibp
 = &
µd
->
ibpÜt_d©a
;

1408 
ev’t
.
deviû
 = 
ibdev
;

1409 
ev’t
.
–em’t
.
pÜt_num
 = 
pÜt
;

1411 
ls_Þd
 = 
	`driv”_l¡©e
(
µd
);

1413 
ibp
->
rvp
.
mkey
 = 
pi
->mkey;

1414 ià(
ibp
->
rvp
.
gid_´efix
 !ð
pi
->
subÃt_´efix
) {

1415 
ibp
->
rvp
.
gid_´efix
 = 
pi
->
subÃt_´efix
;

1416 
ev’t
.ev’ˆð
IB_EVENT_GID_CHANGE
;

1417 
	`ib_di¥©ch_ev’t
(&
ev’t
);

1419 
ibp
->
rvp
.
mkey_Ëa£_³riod
 = 
	`be16_to_ýu
(
pi
->mkey_lease_period);

1422 ià((
lid
 =ð0 && 
ls_Þd
 > 
IB_PORT_INIT
) ||

1423 (
	`hfi1_is_16B_mÿ¡
(
lid
))) {

1424 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1425 
	`´_w¬n
("SubnSet(OPA_PortInfo)†id invalid 0x%x\n",

1426 
lid
);

1427 } ià(
µd
->
lid
 !=†id ||

1428 
µd
->
lmc
 !ð(
pi
->
mkey´Ùeù_lmc
 & 
OPA_PI_MASK_LMC
)) {

1429 ià(
µd
->
lid
 !=†id)

1430 
	`hfi1_£t_uev’t_b™s
(
µd
, 
_HFI1_EVENT_LID_CHANGE_BIT
);

1431 ià(
µd
->
lmc
 !ð(
pi
->
mkey´Ùeù_lmc
 & 
OPA_PI_MASK_LMC
))

1432 
	`hfi1_£t_uev’t_b™s
(
µd
, 
_HFI1_EVENT_LMC_CHANGE_BIT
);

1433 
	`hfi1_£t_lid
(
µd
, 
lid
, 
pi
->
mkey´Ùeù_lmc
 & 
OPA_PI_MASK_LMC
);

1434 
ev’t
.ev’ˆð
IB_EVENT_LID_CHANGE
;

1435 
	`ib_di¥©ch_ev’t
(&
ev’t
);

1437 ià(
HFI1_PORT_GUID_INDEX
 + 1 < 
HFI1_GUIDS_PER_PORT
) {

1441 
µd
->
guids
[
HFI1_PORT_GUID_INDEX
 + 1] =

1442 
	`be64_to_ýu
(
	`OPA_MAKE_ID
(
lid
));

1443 
ev’t
.ev’ˆð
IB_EVENT_GID_CHANGE
;

1444 
	`ib_di¥©ch_ev’t
(&
ev’t
);

1448 
m¦
 = 
pi
->
sm¦
 & 
OPA_PI_MASK_SMSL
;

1449 ià(
pi
->
·¹’fÜû_fž‹¼aw
 & 
OPA_PI_MASK_LINKINIT_REASON
)

1450 
µd
->
lškš™_»asÚ
 =

1451 (
pi
->
·¹’fÜû_fž‹¼aw
 &

1452 
OPA_PI_MASK_LINKINIT_REASON
);

1455 ià((
smlid
 =ð0 && 
ls_Þd
 > 
IB_PORT_INIT
) ||

1456 (
	`hfi1_is_16B_mÿ¡
(
smlid
))) {

1457 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1458 
	`´_w¬n
("SubnS‘(OPA_PÜtInfoèsmlid inv®id 0x%x\n", 
smlid
);

1459 } ià(
smlid
 !ð
ibp
->
rvp
.
sm_lid
 || 
m¦
 !ðibp->rvp.
sm_¦
) {

1460 
	`´_w¬n
("SubnS‘(OPA_PÜtInfoèsmlid 0x%x\n", 
smlid
);

1461 
	`¥š_lock_œq§ve
(&
ibp
->
rvp
.
lock
, 
æags
);

1462 ià(
ibp
->
rvp
.
sm_ah
) {

1463 ià(
smlid
 !ð
ibp
->
rvp
.
sm_lid
)

1464 
	`hfi1_modify_qp0_ah
(
ibp
, ibp->
rvp
.
sm_ah
, 
smlid
);

1465 ià(
m¦
 !ð
ibp
->
rvp
.
sm_¦
)

1466 
	`rdma_ah_£t_¦
(&
ibp
->
rvp
.
sm_ah
->
©Œ
, 
m¦
);

1468 
	`¥š_uÆock_œq»¡Üe
(&
ibp
->
rvp
.
lock
, 
æags
);

1469 ià(
smlid
 !ð
ibp
->
rvp
.
sm_lid
)

1470 
ibp
->
rvp
.
sm_lid
 = 
smlid
;

1471 ià(
m¦
 !ð
ibp
->
rvp
.
sm_¦
)

1472 
ibp
->
rvp
.
sm_¦
 = 
m¦
;

1473 
ev’t
.ev’ˆð
IB_EVENT_SM_CHANGE
;

1474 
	`ib_di¥©ch_ev’t
(&
ev’t
);

1477 ià(
pi
->
lšk_down_»asÚ
 == 0) {

1478 
µd
->
loÿl_lšk_down_»asÚ
.
sma
 = 0;

1479 
µd
->
loÿl_lšk_down_»asÚ
.
Ï‹¡
 = 0;

1482 ià(
pi
->
Ãigh_lšk_down_»asÚ
 == 0) {

1483 
µd
->
Ãigh_lšk_down_»asÚ
.
sma
 = 0;

1484 
µd
->
Ãigh_lšk_down_»asÚ
.
Ï‹¡
 = 0;

1487 
µd
->
sm_Œ­_qp
 = 
	`be32_to_ýu
(
pi
->sm_trap_qp);

1488 
µd
->
§_qp
 = 
	`be32_to_ýu
(
pi
->sa_qp);

1490 
µd
->
pÜt_”rÜ_aùiÚ
 = 
	`be32_to_ýu
(
pi
->port_error_action);

1491 
lwe
 = 
	`be16_to_ýu
(
pi
->
lšk_width
.
’abËd
);

1492 ià(
lwe
) {

1493 ià(
lwe
 =ð
OPA_LINK_WIDTH_RESET
 ||

1494 
lwe
 =ð
OPA_LINK_WIDTH_RESET_OLD
)

1495 
	`£t_lšk_width_’abËd
(
µd
,…pd->
lšk_width_suµÜ‹d
);

1496 ià((
lwe
 & ~
µd
->
lšk_width_suµÜ‹d
) == 0)

1497 
	`£t_lšk_width_’abËd
(
µd
, 
lwe
);

1499 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1501 
lwe
 = 
	`be16_to_ýu
(
pi
->
lšk_width_downg¿de
.
’abËd
);

1503 ià(
lwe
 =ð
OPA_LINK_WIDTH_RESET
 ||

1504 
lwe
 =ð
OPA_LINK_WIDTH_RESET_OLD
) {

1505 
	`£t_lšk_width_downg¿de_’abËd
(
µd
,

1506 
µd
->

1507 
lšk_width_downg¿de_suµÜ‹d


1509 } ià((
lwe
 & ~
µd
->
lšk_width_downg¿de_suµÜ‹d
) == 0) {

1511 ià(
lwe
 !ð
µd
->
lšk_width_downg¿de_’abËd
) {

1512 
	`£t_lšk_width_downg¿de_’abËd
(
µd
, 
lwe
);

1513 
ÿÎ_lšk_downg¿de_pÞicy
 = 1;

1516 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1518 
l£
 = 
	`be16_to_ýu
(
pi
->
lšk_¥“d
.
’abËd
);

1519 ià(
l£
) {

1520 ià(
l£
 & 
	`be16_to_ýu
(
pi
->
lšk_¥“d
.
suµÜ‹d
))

1521 
	`£t_lšk_¥“d_’abËd
(
µd
, 
l£
);

1523 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1526 
ibp
->
rvp
.
mkey´Ù
 =

1527 (
pi
->
mkey´Ùeù_lmc
 & 
OPA_PI_MASK_MKEY_PROT_BIT
) >> 6;

1528 
ibp
->
rvp
.
vl_high_lim™
 = 
	`be16_to_ýu
(
pi
->
vl
.
high_lim™
) & 0xFF;

1529 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_VL_HIGH_LIMIT
,

1530 
ibp
->
rvp
.
vl_high_lim™
);

1532 ià(
µd
->
vls_suµÜ‹d
 / 2 > 
	`ARRAY_SIZE
(
pi
->
Ãigh_mtu
.
pvlx_to_mtu
) ||

1533 
µd
->
vls_suµÜ‹d
 > 
	`ARRAY_SIZE
(
dd
->
vld
)) {

1534 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1535  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1537 
i
 = 0; i < 
µd
->
vls_suµÜ‹d
; i++) {

1538 ià((
i
 % 2) == 0)

1539 
mtu
 = 
	`’um_to_mtu
((
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[
i
 / 2] >>

1542 
mtu
 = 
	`’um_to_mtu
(
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[
i
 / 2] &

1544 ià(
mtu
 == 0xffff) {

1545 
	`´_w¬n
("SubnSet(OPA_PortInfo) mtu invalid %d (0x%x)\n",

1546 
mtu
,

1547 (
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[0] >> 4) & 0xF);

1548 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1549 
mtu
 = 
hfi1_max_mtu
;

1551 ià(
dd
->
vld
[
i
].
mtu
 != mtu) {

1552 
	`dd_dev_šfo
(
dd
,

1554 
i
, 
dd
->
vld
[i].
mtu
, mtu);

1555 
dd
->
vld
[
i
].
mtu
 = mtu;

1556 
ÿÎ_£t_mtu
++;

1562 
mtu
 = 
	`’um_to_mtu
(
pi
->
Ãigh_mtu
.
pvlx_to_mtu
[15 / 2] & 0xF);

1563 ià(
mtu
 < 2048 || mtu == 0xffff)

1564 
mtu
 = 2048;

1565 ià(
dd
->
vld
[15].
mtu
 != mtu) {

1566 
	`dd_dev_šfo
(
dd
,

1568 
dd
->
vld
[15].
mtu
, mtu);

1569 
dd
->
vld
[15].
mtu
 = mtu;

1570 
ÿÎ_£t_mtu
++;

1572 ià(
ÿÎ_£t_mtu
)

1573 
	`£t_mtu
(
µd
);

1576 
vls
 = 
pi
->
Ý”©iÚ®_vls
 & 
OPA_PI_MASK_OPERATIONAL_VL
;

1577 ià(
vls
) {

1578 ià(
vls
 > 
µd
->
vls_suµÜ‹d
) {

1579 
	`´_w¬n
("SubnSet(OPA_PortInfo) VL's supported invalid %d\n",

1580 
pi
->
Ý”©iÚ®_vls
);

1581 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1583 ià(
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_OP_VLS
,

1584 
vls
è=ð-
EINVAL
)

1585 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1589 ià(
pi
->
mkey_viÞ©iÚs
 == 0)

1590 
ibp
->
rvp
.
mkey_viÞ©iÚs
 = 0;

1592 ià(
pi
->
pkey_viÞ©iÚs
 == 0)

1593 
ibp
->
rvp
.
pkey_viÞ©iÚs
 = 0;

1595 ià(
pi
->
qkey_viÞ©iÚs
 == 0)

1596 
ibp
->
rvp
.
qkey_viÞ©iÚs
 = 0;

1598 
ibp
->
rvp
.
subÃt_timeout
 =

1599 
pi
->
þ›Á»»g_subÃ‰imeout
 & 
OPA_PI_MASK_SUBNET_TIMEOUT
;

1601 
üc_’abËd
 = 
	`be16_to_ýu
(
pi
->
pÜt_Ép_üc_mode
);

1602 
üc_’abËd
 >>= 4;

1603 
üc_’abËd
 &= 0xf;

1605 ià(
üc_’abËd
 != 0)

1606 
µd
->
pÜt_üc_mode_’abËd
 = 
	`pÜt_Ép_to_ÿp
(
üc_’abËd
);

1608 
µd
->
is_aùive_Ýtimize_’abËd
 =

1609 !!(
	`be16_to_ýu
(
pi
->
pÜt_mode
)

1610 & 
OPA_PI_MASK_PORT_ACTIVE_OPTOMIZE
);

1612 
ls_Ãw
 = 
pi
->
pÜt_¡©es
.
pÜhys¡©e_pÜt¡©e
 &

1613 
OPA_PI_MASK_PORT_STATE
;

1614 
ps_Ãw
 = (
pi
->
pÜt_¡©es
.
pÜhys¡©e_pÜt¡©e
 &

1615 
OPA_PI_MASK_PORT_PHYSICAL_STATE
) >> 4;

1617 ià(
ls_Þd
 =ð
IB_PORT_INIT
) {

1618 ià(
¡¬t_of_sm_cÚfig
) {

1619 ià(
ls_Ãw
 =ð
ls_Þd
 || (ls_Ãw =ð
IB_PORT_ARMED
))

1620 
µd
->
is_sm_cÚfig_¡¬‹d
 = 1;

1621 } ià(
ls_Ãw
 =ð
IB_PORT_ARMED
) {

1622 ià(
µd
->
is_sm_cÚfig_¡¬‹d
 == 0) {

1623 
šv®id
 = 1;

1624 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1630 ià(
þ›Á»»g
) {

1631 
ev’t
.ev’ˆð
IB_EVENT_CLIENT_REREGISTER
;

1632 
	`ib_di¥©ch_ev’t
(&
ev’t
);

1642 ià(!
šv®id
) {

1643 
»t
 = 
	`£t_pÜt_¡©es
(
µd
, 
smp
, 
ls_Ãw
, 
ps_Ãw
, 
loÿl_mad
);

1644 ià(
»t
)

1645  
»t
;

1648 
»t
 = 
	`__subn_g‘_Ýa_pÜtšfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1649 
max_Ën
);

1652 
pi
->
þ›Á»»g_subÃ‰imeout
 |ð
þ›Á»»g
;

1660 ià(
ÿÎ_lšk_downg¿de_pÞicy
)

1661 
	`­¶y_lšk_downg¿de_pÞicy
(
µd
, 0);

1663  
»t
;

1665 
g‘_Úly
:

1666  
	`__subn_g‘_Ýa_pÜtšfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1667 
max_Ën
);

1668 
	}
}

1676 
	$£t_pkeys
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
, 
u16
 *
pkeys
)

1678 
hfi1_µÜtd©a
 *
µd
;

1679 
i
;

1680 
chªged
 = 0;

1681 
upd©e_šþudes_mgmt_·¹™iÚ
 = 0;

1689 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

1693 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); i++) {

1694 ià(
pkeys
[
i
] =ð
LIM_MGMT_P_KEY
) {

1695 
upd©e_šþudes_mgmt_·¹™iÚ
 = 1;

1700 ià(!
upd©e_šþudes_mgmt_·¹™iÚ
)

1703 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); i++) {

1704 
u16
 
key
 = 
pkeys
[
i
];

1705 
u16
 
okey
 = 
µd
->
pkeys
[
i
];

1707 ià(
key
 =ð
okey
)

1714 
µd
->
pkeys
[
i
] = 
key
;

1715 
chªged
 = 1;

1718 ià(
chªged
) {

1719 ()
	`hfi1_£t_ib_cfg
(
µd
, 
HFI1_IB_CFG_PKEYS
, 0);

1720 
	`hfi1_ev’t_pkey_chªge
(
dd
, 
pÜt
);

1724 
	}
}

1726 
	$__subn_£t_Ýa_pkeybË
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1727 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1728 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1730 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1731 
u32
 
n_blocks_£Á
 = 
	`OPA_AM_NBLK
(
am
);

1732 
u32
 
¡¬t_block
 = 
am
 & 0x7ff;

1733 
u16
 *
p
 = (u16 *)
d©a
;

1734 
__be16
 *
q
 = (__be16 *)
d©a
;

1735 
i
;

1736 
u16
 
n_blocks_avaž
;

1737 
Åkeys
 = 
	`hfi1_g‘_Åkeys
(
dd
);

1738 
u32
 
size
 = 0;

1740 ià(
n_blocks_£Á
 == 0) {

1741 
	`´_w¬n
("OPA Get PKey AM Invalid : P = %d; B = 0x%x; N = 0x%x\n",

1742 
pÜt
, 
¡¬t_block
, 
n_blocks_£Á
);

1743 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1744  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1747 
n_blocks_avaž
 = (
u16
)(
Åkeys
 / 
OPA_PARTITION_TABLE_BLK_SIZE
) + 1;

1749 
size
 = (
u16
è* (
n_blocks_£Á
 * 
OPA_PARTITION_TABLE_BLK_SIZE
);

1751 ià(
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1752 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1753  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1756 ià(
¡¬t_block
 + 
n_blocks_£Á
 > 
n_blocks_avaž
 ||

1757 
n_blocks_£Á
 > 
OPA_NUM_PKEY_BLOCKS_PER_SMP
) {

1758 
	`´_w¬n
("OPA Set PKey AM Invalid : s 0x%x;„eq 0x%x;‡vail 0x%x; blk/smp 0x%lx\n",

1759 
¡¬t_block
, 
n_blocks_£Á
, 
n_blocks_avaž
,

1760 
OPA_NUM_PKEY_BLOCKS_PER_SMP
);

1761 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1762  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1765 
i
 = 0; i < 
n_blocks_£Á
 * 
OPA_PARTITION_TABLE_BLK_SIZE
; i++)

1766 
p
[
i
] = 
	`be16_to_ýu
(
q
[i]);

1768 ià(
¡¬t_block
 =ð0 && 
	`£t_pkeys
(
dd
, 
pÜt
, 
p
) != 0) {

1769 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1770  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1773  
	`__subn_g‘_Ýa_pkeybË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1774 
max_Ën
);

1775 
	}
}

1777 
	#ILLEGAL_VL
 12

	)

1785 
	$fž‹r_sc2vÉ
(*
d©a
, 
boÞ
 
£t
)

1787 
i
;

1788 
u8
 *
pd
 = 
d©a
;

1790 
i
 = 0; i < 
OPA_MAX_SCS
; i++) {

1791 ià(
i
 == 15)

1794 ià(
£t
) {

1795 ià((
pd
[
i
] & 0x1f) == 0xf)

1796 
pd
[
i
] = 
ILLEGAL_VL
;

1798 ià((
pd
[
i
] & 0x1fè=ð
ILLEGAL_VL
)

1799 
pd
[
i
] = 0xf;

1802 
	}
}

1804 
	$£t_sc2vÉ_bËs
(
hfi1_devd©a
 *
dd
, *
d©a
)

1806 
u64
 *
v®
 = 
d©a
;

1808 
	`fž‹r_sc2vÉ
(
d©a
, 
Œue
);

1810 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT0
, *
v®
++);

1811 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT1
, *
v®
++);

1812 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT2
, *
v®
++);

1813 
	`wr™e_c¤
(
dd
, 
SEND_SC2VLT3
, *
v®
++);

1814 
	`wr™e_£qlock_œq
(&
dd
->
sc2vl_lock
);

1815 
	`memýy
(
dd
->
sc2vl
, 
d©a
, (dd->sc2vl));

1816 
	`wr™e_£quÆock_œq
(&
dd
->
sc2vl_lock
);

1818 
	}
}

1820 
	$g‘_sc2vÉ_bËs
(
hfi1_devd©a
 *
dd
, *
d©a
)

1822 
u64
 *
v®
 = (u64 *)
d©a
;

1824 *
v®
++ = 
	`»ad_c¤
(
dd
, 
SEND_SC2VLT0
);

1825 *
v®
++ = 
	`»ad_c¤
(
dd
, 
SEND_SC2VLT1
);

1826 *
v®
++ = 
	`»ad_c¤
(
dd
, 
SEND_SC2VLT2
);

1827 *
v®
++ = 
	`»ad_c¤
(
dd
, 
SEND_SC2VLT3
);

1829 
	`fž‹r_sc2vÉ
((
u64
 *)
d©a
, 
çl£
);

1831 
	}
}

1833 
	$__subn_g‘_Ýa_¦_to_sc
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1834 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1835 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1837 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

1838 
u8
 *
p
 = 
d©a
;

1839 
size_t
 
size
 = 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
);

1840 
i
;

1842 ià(
am
 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1843 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1844  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1847 
i
 = 0; i < 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
); i++)

1848 *
p
++ = 
ibp
->
¦_to_sc
[
i
];

1850 ià(
»¥_Ën
)

1851 *
»¥_Ën
 +ð
size
;

1853  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1854 
	}
}

1856 
	$__subn_£t_Ýa_¦_to_sc
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1857 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1858 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1860 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

1861 
u8
 *
p
 = 
d©a
;

1862 
size_t
 
size
 = 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
);

1863 
i
;

1864 
u8
 
sc
;

1866 ià(
am
 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1867 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1868  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1871 
i
 = 0; i < 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
); i++) {

1872 
sc
 = *
p
++;

1873 ià(
ibp
->
¦_to_sc
[
i
] !ð
sc
) {

1874 
ibp
->
¦_to_sc
[
i
] = 
sc
;

1877 
	`hfi1_”rÜ_pÜt_qps
(
ibp
, 
i
);

1881  
	`__subn_g‘_Ýa_¦_to_sc
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1882 
max_Ën
);

1883 
	}
}

1885 
	$__subn_g‘_Ýa_sc_to_¦
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1886 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1887 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1889 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

1890 
u8
 *
p
 = 
d©a
;

1891 
size_t
 
size
 = 
	`ARRAY_SIZE
(
ibp
->
sc_to_¦
);

1892 
i
;

1894 ià(
am
 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1895 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1896  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1899 
i
 = 0; i < 
	`ARRAY_SIZE
(
ibp
->
sc_to_¦
); i++)

1900 *
p
++ = 
ibp
->
sc_to_¦
[
i
];

1902 ià(
»¥_Ën
)

1903 *
»¥_Ën
 +ð
size
;

1905  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1906 
	}
}

1908 
	$__subn_£t_Ýa_sc_to_¦
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1909 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1910 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1912 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

1913 
size_t
 
size
 = 
	`ARRAY_SIZE
(
ibp
->
sc_to_¦
);

1914 
u8
 *
p
 = 
d©a
;

1915 
i
;

1917 ià(
am
 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1918 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1919  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1922 
i
 = 0; i < 
	`ARRAY_SIZE
(
ibp
->
sc_to_¦
); i++)

1923 
ibp
->
sc_to_¦
[
i
] = *
p
++;

1925  
	`__subn_g‘_Ýa_sc_to_¦
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1926 
max_Ën
);

1927 
	}
}

1929 
	$__subn_g‘_Ýa_sc_to_vÉ
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1930 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1931 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1933 
u32
 
n_blocks
 = 
	`OPA_AM_NBLK
(
am
);

1934 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1935 *
vp
 = (*)
d©a
;

1936 
size_t
 
size
 = 4 * (
u64
);

1938 ià(
n_blocks
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1939 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1940  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1943 
	`g‘_sc2vÉ_bËs
(
dd
, 
vp
);

1945 ià(
»¥_Ën
)

1946 *
»¥_Ën
 +ð
size
;

1948  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1949 
	}
}

1951 
	$__subn_£t_Ýa_sc_to_vÉ
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1952 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1953 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1955 
u32
 
n_blocks
 = 
	`OPA_AM_NBLK
(
am
);

1956 
async_upd©e
 = 
	`OPA_AM_ASYNC
(
am
);

1957 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1958 *
vp
 = (*)
d©a
;

1959 
hfi1_µÜtd©a
 *
µd
;

1960 
l¡©e
;

1967 
size_t
 
size
 = 4 * (
u64
);

1969 ià(
n_blocks
 !ð1 || 
async_upd©e
 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

1970 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1971  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1975 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

1976 
l¡©e
 = 
	`driv”_l¡©e
(
µd
);

1981 ià(!
async_upd©e
 &&

1982 (
l¡©e
 =ð
IB_PORT_ARMED
 ||†¡©=ð
IB_PORT_ACTIVE
)) {

1983 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

1984  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

1987 
	`£t_sc2vÉ_bËs
(
dd
, 
vp
);

1989  
	`__subn_g‘_Ýa_sc_to_vÉ
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

1990 
max_Ën
);

1991 
	}
}

1993 
	$__subn_g‘_Ýa_sc_to_vÊt
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

1994 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

1995 
u32
 *
»¥_Ën
, u32 
max_Ën
)

1997 
u32
 
n_blocks
 = 
	`OPA_AM_NPORT
(
am
);

1998 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1999 
hfi1_µÜtd©a
 *
µd
;

2000 *
vp
 = (*)
d©a
;

2001 
size
 = (
sc2vÊt
);

2003 ià(
n_blocks
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

2004 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2005  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2008 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

2010 
	`fm_g‘_bË
(
µd
, 
FM_TBL_SC2VLNT
, 
vp
);

2012 ià(
»¥_Ën
)

2013 *
»¥_Ën
 +ð
size
;

2015  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2016 
	}
}

2018 
	$__subn_£t_Ýa_sc_to_vÊt
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2019 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2020 
u32
 *
»¥_Ën
, u32 
max_Ën
)

2022 
u32
 
n_blocks
 = 
	`OPA_AM_NPORT
(
am
);

2023 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2024 
hfi1_µÜtd©a
 *
µd
;

2025 *
vp
 = (*)
d©a
;

2026 
l¡©e
;

2027 
size
 = (
sc2vÊt
);

2029 ià(
n_blocks
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

2030 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2031  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2035 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

2036 
l¡©e
 = 
	`driv”_l¡©e
(
µd
);

2037 ià(
l¡©e
 =ð
IB_PORT_ARMED
 ||†¡©=ð
IB_PORT_ACTIVE
) {

2038 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2039  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2042 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

2044 
	`fm_£t_bË
(
µd
, 
FM_TBL_SC2VLNT
, 
vp
);

2046  
	`__subn_g‘_Ýa_sc_to_vÊt
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

2047 
»¥_Ën
, 
max_Ën
);

2048 
	}
}

2050 
	$__subn_g‘_Ýa_psi
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2051 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2052 
u32
 *
»¥_Ën
, u32 
max_Ën
)

2054 
u32
 
ÅÜts
 = 
	`OPA_AM_NPORT
(
am
);

2055 
u32
 
¡¬t_of_sm_cÚfig
 = 
	`OPA_AM_START_SM_CFG
(
am
);

2056 
u32
 
l¡©e
;

2057 
hfi1_ibpÜt
 *
ibp
;

2058 
hfi1_µÜtd©a
 *
µd
;

2059 
Ýa_pÜt_¡©e_šfo
 *
psi
 = (Ýa_pÜt_¡©e_šfØ*)
d©a
;

2061 ià(
ÅÜts
 !ð1 || 
	`smp_Ëngth_check
((*
psi
), 
max_Ën
)) {

2062 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2063  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2066 
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

2067 
µd
 = 
	`µd_äom_ibp
(
ibp
);

2069 
l¡©e
 = 
	`driv”_l¡©e
(
µd
);

2071 ià(
¡¬t_of_sm_cÚfig
 && (
l¡©e
 =ð
IB_PORT_INIT
))

2072 
µd
->
is_sm_cÚfig_¡¬‹d
 = 1;

2074 
psi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 = 
µd
->
ÃighbÜ_nÜm®
 << 4;

2075 
psi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 |=

2076 
µd
->
is_sm_cÚfig_¡¬‹d
 << 5;

2077 
psi
->
pÜt_¡©es
.
Ëd’abË_ofæš”—sÚ
 |=

2078 
µd
->
ofæše_di§bËd_»asÚ
;

2080 
psi
->
pÜt_¡©es
.
pÜhys¡©e_pÜt¡©e
 =

2081 (
	`driv”_p¡©e
(
µd
è<< 4è| (
l¡©e
 & 0xf);

2082 
psi
->
lšk_width_downg¿de_tx_aùive
 =

2083 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_tx_aùive
);

2084 
psi
->
lšk_width_downg¿de_rx_aùive
 =

2085 
	`ýu_to_be16
(
µd
->
lšk_width_downg¿de_rx_aùive
);

2086 ià(
»¥_Ën
)

2087 *
»¥_Ën
 +ð(
Ýa_pÜt_¡©e_šfo
);

2089  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2090 
	}
}

2092 
	$__subn_£t_Ýa_psi
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2093 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2094 
u32
 *
»¥_Ën
, u32 
max_Ën
, 
loÿl_mad
)

2096 
u32
 
ÅÜts
 = 
	`OPA_AM_NPORT
(
am
);

2097 
u32
 
¡¬t_of_sm_cÚfig
 = 
	`OPA_AM_START_SM_CFG
(
am
);

2098 
u32
 
ls_Þd
;

2099 
u8
 
ls_Ãw
, 
ps_Ãw
;

2100 
hfi1_ibpÜt
 *
ibp
;

2101 
hfi1_µÜtd©a
 *
µd
;

2102 
Ýa_pÜt_¡©e_šfo
 *
psi
 = (Ýa_pÜt_¡©e_šfØ*)
d©a
;

2103 
»t
, 
šv®id
 = 0;

2105 ià(
ÅÜts
 !ð1 || 
	`smp_Ëngth_check
((*
psi
), 
max_Ën
)) {

2106 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2107  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2110 
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

2111 
µd
 = 
	`µd_äom_ibp
(
ibp
);

2113 
ls_Þd
 = 
	`driv”_l¡©e
(
µd
);

2115 
ls_Ãw
 = 
	`pÜt_¡©es_to_logiÿl_¡©e
(&
psi
->
pÜt_¡©es
);

2116 
ps_Ãw
 = 
	`pÜt_¡©es_to_phys_¡©e
(&
psi
->
pÜt_¡©es
);

2118 ià(
ls_Þd
 =ð
IB_PORT_INIT
) {

2119 ià(
¡¬t_of_sm_cÚfig
) {

2120 ià(
ls_Ãw
 =ð
ls_Þd
 || (ls_Ãw =ð
IB_PORT_ARMED
))

2121 
µd
->
is_sm_cÚfig_¡¬‹d
 = 1;

2122 } ià(
ls_Ãw
 =ð
IB_PORT_ARMED
) {

2123 ià(
µd
->
is_sm_cÚfig_¡¬‹d
 == 0) {

2124 
šv®id
 = 1;

2125 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2130 ià(!
šv®id
) {

2131 
»t
 = 
	`£t_pÜt_¡©es
(
µd
, 
smp
, 
ls_Ãw
, 
ps_Ãw
, 
loÿl_mad
);

2132 ià(
»t
)

2133  
»t
;

2136  
	`__subn_g‘_Ýa_psi
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

2137 
max_Ën
);

2138 
	}
}

2140 
	$__subn_g‘_Ýa_ÿbË_šfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2141 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2142 
u32
 *
»¥_Ën
, u32 
max_Ën
)

2144 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2145 
u32
 
addr
 = 
	`OPA_AM_CI_ADDR
(
am
);

2146 
u32
 
Ën
 = 
	`OPA_AM_CI_LEN
(
am
) + 1;

2147 
»t
;

2149 ià(
dd
->
µÜt
->
pÜt_ty³
 !ð
PORT_TYPE_QSFP
 ||

2150 
	`smp_Ëngth_check
(
Ën
, 
max_Ën
)) {

2151 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2152  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2155 
	#__CI_PAGE_SIZE
 
	`BIT
(7è

	)

2156 
	#__CI_PAGE_MASK
 ~(
__CI_PAGE_SIZE
 - 1)

	)

2157 
	#__CI_PAGE_NUM
(
a
è(×è& 
__CI_PAGE_MASK
)

	)

2163 ià(
addr
 >= 4096 ||

2164 (
	`__CI_PAGE_NUM
(
addr
è!ð__CI_PAGE_NUM×dd¸+ 
Ën
 - 1))) {

2165 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2166  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2169 
»t
 = 
	`g‘_ÿbË_šfo
(
dd
, 
pÜt
, 
addr
, 
Ën
, 
d©a
);

2171 ià(
»t
 =ð-
ENODEV
) {

2172 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

2173  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2181 ià(
»t
 < 0 &&„‘ !ð-
ERANGE
) {

2182 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2183  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2186 ià(
»¥_Ën
)

2187 *
»¥_Ën
 +ð
Ën
;

2189  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2190 
	}
}

2192 
	$__subn_g‘_Ýa_bù
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2193 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
, 
u32
 *
»¥_Ën
,

2194 
u32
 
max_Ën
)

2196 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

2197 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2198 
hfi1_µÜtd©a
 *
µd
;

2199 
bufãr_cÚŒÞ
 *
p
 = (bufãr_cÚŒÞ *)
d©a
;

2200 
size
 = (
bufãr_cÚŒÞ
);

2202 ià(
num_pÜts
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

2203 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2204  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2207 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

2208 
	`fm_g‘_bË
(
µd
, 
FM_TBL_BUFFER_CONTROL
, 
p
);

2209 
	`Œaû_bù_g‘
(
dd
, 
p
);

2210 ià(
»¥_Ën
)

2211 *
»¥_Ën
 +ð
size
;

2213  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2214 
	}
}

2216 
	$__subn_£t_Ýa_bù
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2217 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
, 
u32
 *
»¥_Ën
,

2218 
u32
 
max_Ën
)

2220 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

2221 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2222 
hfi1_µÜtd©a
 *
µd
;

2223 
bufãr_cÚŒÞ
 *
p
 = (bufãr_cÚŒÞ *)
d©a
;

2225 ià(
num_pÜts
 !ð1 || 
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

2226 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2227  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2229 
µd
 = 
dd
->
µÜt
 + (
pÜt
 - 1);

2230 
	`Œaû_bù_£t
(
dd
, 
p
);

2231 ià(
	`fm_£t_bË
(
µd
, 
FM_TBL_BUFFER_CONTROL
, 
p
) < 0) {

2232 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2233  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2236  
	`__subn_g‘_Ýa_bù
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

2237 
max_Ën
);

2238 
	}
}

2240 
	$__subn_g‘_Ýa_vl_¬b
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2241 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2242 
u32
 *
»¥_Ën
, u32 
max_Ën
)

2244 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
	`to_Üt
(
ibdev
, 
pÜt
));

2245 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

2246 
u8
 
£ùiÚ
 = (
am
 & 0x00ff0000) >> 16;

2247 
u8
 *
p
 = 
d©a
;

2248 
size
 = 256;

2250 ià(
num_pÜts
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

2251 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2252  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2255 
£ùiÚ
) {

2256 
OPA_VLARB_LOW_ELEMENTS
:

2257 
	`fm_g‘_bË
(
µd
, 
FM_TBL_VL_LOW_ARB
, 
p
);

2259 
OPA_VLARB_HIGH_ELEMENTS
:

2260 
	`fm_g‘_bË
(
µd
, 
FM_TBL_VL_HIGH_ARB
, 
p
);

2262 
OPA_VLARB_PREEMPT_ELEMENTS
:

2263 
	`fm_g‘_bË
(
µd
, 
FM_TBL_VL_PREEMPT_ELEMS
, 
p
);

2265 
OPA_VLARB_PREEMPT_MATRIX
:

2266 
	`fm_g‘_bË
(
µd
, 
FM_TBL_VL_PREEMPT_MATRIX
, 
p
);

2269 
	`´_w¬n
("OPA SubnGet(VL Arb) AM Invalid : 0x%x\n",

2270 
	`be32_to_ýu
(
smp
->
©Œ_mod
));

2271 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2272 
size
 = 0;

2276 ià(
size
 > 0 && 
»¥_Ën
)

2277 *
»¥_Ën
 +ð
size
;

2279  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2280 
	}
}

2282 
	$__subn_£t_Ýa_vl_¬b
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

2283 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2284 
u32
 *
»¥_Ën
, u32 
max_Ën
)

2286 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
	`to_Üt
(
ibdev
, 
pÜt
));

2287 
u32
 
num_pÜts
 = 
	`OPA_AM_NPORT
(
am
);

2288 
u8
 
£ùiÚ
 = (
am
 & 0x00ff0000) >> 16;

2289 
u8
 *
p
 = 
d©a
;

2290 
size
 = 256;

2292 ià(
num_pÜts
 !ð1 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
)) {

2293 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2294  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

2297 
£ùiÚ
) {

2298 
OPA_VLARB_LOW_ELEMENTS
:

2299 ()
	`fm_£t_bË
(
µd
, 
FM_TBL_VL_LOW_ARB
, 
p
);

2301 
OPA_VLARB_HIGH_ELEMENTS
:

2302 ()
	`fm_£t_bË
(
µd
, 
FM_TBL_VL_HIGH_ARB
, 
p
);

2308 
OPA_VLARB_PREEMPT_ELEMENTS
:

2310 
OPA_VLARB_PREEMPT_MATRIX
:

2311 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

2314 
	`´_w¬n
("OPA SubnSet(VL Arb) AM Invalid : 0x%x\n",

2315 
	`be32_to_ýu
(
smp
->
©Œ_mod
));

2316 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2320  
	`__subn_g‘_Ýa_vl_¬b
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

2321 
max_Ën
);

2322 
	}
}

2324 
	sÝa_pma_mad
 {

2325 
ib_mad_hdr
 
	mmad_hdr
;

2326 
u8
 
	md©a
[2024];

2327 } 
	g__·cked
;

2329 
	sÝa_pÜt_¡©us_»q
 {

2330 
__u8
 
	mpÜt_num
;

2331 
__u8
 
	m»£rved
[3];

2332 
__be32
 
	mvl_£Ëù_mask
;

2335 
	#VL_MASK_ALL
 0x00000000000080ffUL

	)

2337 
	sÝa_pÜt_¡©us_r¥
 {

2338 
__u8
 
	mpÜt_num
;

2339 
__u8
 
	m»£rved
[3];

2340 
__be32
 
	mvl_£Ëù_mask
;

2343 
__be64
 
	mpÜt_xm™_d©a
;

2344 
__be64
 
	mpÜt_rcv_d©a
;

2345 
__be64
 
	mpÜt_xm™_pkts
;

2346 
__be64
 
	mpÜt_rcv_pkts
;

2347 
__be64
 
	mpÜt_muÉiÿ¡_xm™_pkts
;

2348 
__be64
 
	mpÜt_muÉiÿ¡_rcv_pkts
;

2349 
__be64
 
	mpÜt_xm™_wa™
;

2350 
__be64
 
	msw_pÜt_cÚge¡iÚ
;

2351 
__be64
 
	mpÜt_rcv_ãú
;

2352 
__be64
 
	mpÜt_rcv_beú
;

2353 
__be64
 
	mpÜt_xm™_time_cÚg
;

2354 
__be64
 
	mpÜt_xm™_wa¡ed_bw
;

2355 
__be64
 
	mpÜt_xm™_wa™_d©a
;

2356 
__be64
 
	mpÜt_rcv_bubbË
;

2357 
__be64
 
	mpÜt_m¬k_ãú
;

2359 
__be64
 
	mpÜt_rcv_cÚ¡¿št_”rÜs
;

2360 
__be64
 
	mpÜt_rcv_sw™ch_»Ïy_”rÜs
;

2361 
__be64
 
	mpÜt_xm™_disÿrds
;

2362 
__be64
 
	mpÜt_xm™_cÚ¡¿št_”rÜs
;

2363 
__be64
 
	mpÜt_rcv_»mÙe_physiÿl_”rÜs
;

2364 
__be64
 
	mloÿl_lšk_š‹gr™y_”rÜs
;

2365 
__be64
 
	mpÜt_rcv_”rÜs
;

2366 
__be64
 
	mexûssive_bufãr_ov”runs
;

2367 
__be64
 
	mfm_cÚfig_”rÜs
;

2368 
__be32
 
	mlšk_”rÜ_»cov”y
;

2369 
__be32
 
	mlšk_dowÃd
;

2370 
u8
 
	muncÜ»ùabË_”rÜs
;

2372 
u8
 
	mlšk_qu®™y_šdiÿtÜ
;

2373 
u8
 
	m»s2
[6];

2374 
	s_vls_pùrs
 {

2376 
__be64
 
	mpÜt_vl_xm™_d©a
;

2377 
__be64
 
	mpÜt_vl_rcv_d©a
;

2378 
__be64
 
	mpÜt_vl_xm™_pkts
;

2379 
__be64
 
	mpÜt_vl_rcv_pkts
;

2380 
__be64
 
	mpÜt_vl_xm™_wa™
;

2381 
__be64
 
	msw_pÜt_vl_cÚge¡iÚ
;

2382 
__be64
 
	mpÜt_vl_rcv_ãú
;

2383 
__be64
 
	mpÜt_vl_rcv_beú
;

2384 
__be64
 
	mpÜt_xm™_time_cÚg
;

2385 
__be64
 
	mpÜt_vl_xm™_wa¡ed_bw
;

2386 
__be64
 
	mpÜt_vl_xm™_wa™_d©a
;

2387 
__be64
 
	mpÜt_vl_rcv_bubbË
;

2388 
__be64
 
	mpÜt_vl_m¬k_ãú
;

2389 
__be64
 
	mpÜt_vl_xm™_disÿrds
;

2390 } 
	mvls
[0];

2393 
	ecouÁ”_£Ëùs
 {

2394 
	mCS_PORT_XMIT_DATA
 = (1 << 31),

2395 
	mCS_PORT_RCV_DATA
 = (1 << 30),

2396 
	mCS_PORT_XMIT_PKTS
 = (1 << 29),

2397 
	mCS_PORT_RCV_PKTS
 = (1 << 28),

2398 
	mCS_PORT_MCAST_XMIT_PKTS
 = (1 << 27),

2399 
	mCS_PORT_MCAST_RCV_PKTS
 = (1 << 26),

2400 
	mCS_PORT_XMIT_WAIT
 = (1 << 25),

2401 
	mCS_SW_PORT_CONGESTION
 = (1 << 24),

2402 
	mCS_PORT_RCV_FECN
 = (1 << 23),

2403 
	mCS_PORT_RCV_BECN
 = (1 << 22),

2404 
	mCS_PORT_XMIT_TIME_CONG
 = (1 << 21),

2405 
	mCS_PORT_XMIT_WASTED_BW
 = (1 << 20),

2406 
	mCS_PORT_XMIT_WAIT_DATA
 = (1 << 19),

2407 
	mCS_PORT_RCV_BUBBLE
 = (1 << 18),

2408 
	mCS_PORT_MARK_FECN
 = (1 << 17),

2409 
	mCS_PORT_RCV_CONSTRAINT_ERRORS
 = (1 << 16),

2410 
	mCS_PORT_RCV_SWITCH_RELAY_ERRORS
 = (1 << 15),

2411 
	mCS_PORT_XMIT_DISCARDS
 = (1 << 14),

2412 
	mCS_PORT_XMIT_CONSTRAINT_ERRORS
 = (1 << 13),

2413 
	mCS_PORT_RCV_REMOTE_PHYSICAL_ERRORS
 = (1 << 12),

2414 
	mCS_LOCAL_LINK_INTEGRITY_ERRORS
 = (1 << 11),

2415 
	mCS_PORT_RCV_ERRORS
 = (1 << 10),

2416 
	mCS_EXCESSIVE_BUFFER_OVERRUNS
 = (1 << 9),

2417 
	mCS_FM_CONFIG_ERRORS
 = (1 << 8),

2418 
	mCS_LINK_ERROR_RECOVERY
 = (1 << 7),

2419 
	mCS_LINK_DOWNED
 = (1 << 6),

2420 
	mCS_UNCORRECTABLE_ERRORS
 = (1 << 5),

2423 
	sÝa_þ—r_pÜt_¡©us
 {

2424 
__be64
 
	mpÜt_£Ëù_mask
[4];

2425 
__be32
 
	mcouÁ”_£Ëù_mask
;

2428 
	sÝa_agg»g©e
 {

2429 
__be16
 
	m©Œ_id
;

2430 
__be16
 
	m”r_»qËngth
;

2431 
__be32
 
	m©Œ_mod
;

2432 
u8
 
	md©a
[0];

2435 
	#MSK_LLI
 0x000000f0

	)

2436 
	#MSK_LLI_SFT
 4

	)

2437 
	#MSK_LER
 0x0000000f

	)

2438 
	#MSK_LER_SFT
 0

	)

2439 
	#ADD_LLI
 8

	)

2440 
	#ADD_LER
 2

	)

2443 
	sÝa_pÜt_d©a_couÁ”s_msg
 {

2444 
__be64
 
	mpÜt_£Ëù_mask
[4];

2445 
__be32
 
	mvl_£Ëù_mask
;

2446 
__be32
 
	m»sÞutiÚ
;

2449 
	s_pÜt_dùrs
 {

2450 
u8
 
	mpÜt_numb”
;

2451 
u8
 
	m»£rved2
[3];

2452 
__be32
 
	mlšk_qu®™y_šdiÿtÜ
;

2455 
__be64
 
	mpÜt_xm™_d©a
;

2456 
__be64
 
	mpÜt_rcv_d©a
;

2457 
__be64
 
	mpÜt_xm™_pkts
;

2458 
__be64
 
	mpÜt_rcv_pkts
;

2459 
__be64
 
	mpÜt_muÉiÿ¡_xm™_pkts
;

2460 
__be64
 
	mpÜt_muÉiÿ¡_rcv_pkts
;

2461 
__be64
 
	mpÜt_xm™_wa™
;

2462 
__be64
 
	msw_pÜt_cÚge¡iÚ
;

2463 
__be64
 
	mpÜt_rcv_ãú
;

2464 
__be64
 
	mpÜt_rcv_beú
;

2465 
__be64
 
	mpÜt_xm™_time_cÚg
;

2466 
__be64
 
	mpÜt_xm™_wa¡ed_bw
;

2467 
__be64
 
	mpÜt_xm™_wa™_d©a
;

2468 
__be64
 
	mpÜt_rcv_bubbË
;

2469 
__be64
 
	mpÜt_m¬k_ãú
;

2471 
__be64
 
	mpÜt_”rÜ_couÁ”_summ¬y
;

2474 
	s_vls_dùrs
 {

2476 
__be64
 
	mpÜt_vl_xm™_d©a
;

2477 
__be64
 
	mpÜt_vl_rcv_d©a
;

2478 
__be64
 
	mpÜt_vl_xm™_pkts
;

2479 
__be64
 
	mpÜt_vl_rcv_pkts
;

2480 
__be64
 
	mpÜt_vl_xm™_wa™
;

2481 
__be64
 
	msw_pÜt_vl_cÚge¡iÚ
;

2482 
__be64
 
	mpÜt_vl_rcv_ãú
;

2483 
__be64
 
	mpÜt_vl_rcv_beú
;

2484 
__be64
 
	mpÜt_xm™_time_cÚg
;

2485 
__be64
 
	mpÜt_vl_xm™_wa¡ed_bw
;

2486 
__be64
 
	mpÜt_vl_xm™_wa™_d©a
;

2487 
__be64
 
	mpÜt_vl_rcv_bubbË
;

2488 
__be64
 
	mpÜt_vl_m¬k_ãú
;

2489 } 
	mvls
[0];

2491 } 
	mpÜt
[1];

2494 
	sÝa_pÜt_”rÜ_couÁ”s64_msg
 {

2499 
__be64
 
	mpÜt_£Ëù_mask
[4];

2500 
__be32
 
	mvl_£Ëù_mask
;

2503 
__be32
 
	m»£rved1
;

2504 
	s_pÜt_eùrs
 {

2505 
u8
 
	mpÜt_numb”
;

2506 
u8
 
	m»£rved2
[7];

2507 
__be64
 
	mpÜt_rcv_cÚ¡¿št_”rÜs
;

2508 
__be64
 
	mpÜt_rcv_sw™ch_»Ïy_”rÜs
;

2509 
__be64
 
	mpÜt_xm™_disÿrds
;

2510 
__be64
 
	mpÜt_xm™_cÚ¡¿št_”rÜs
;

2511 
__be64
 
	mpÜt_rcv_»mÙe_physiÿl_”rÜs
;

2512 
__be64
 
	mloÿl_lšk_š‹gr™y_”rÜs
;

2513 
__be64
 
	mpÜt_rcv_”rÜs
;

2514 
__be64
 
	mexûssive_bufãr_ov”runs
;

2515 
__be64
 
	mfm_cÚfig_”rÜs
;

2516 
__be32
 
	mlšk_”rÜ_»cov”y
;

2517 
__be32
 
	mlšk_dowÃd
;

2518 
u8
 
	muncÜ»ùabË_”rÜs
;

2519 
u8
 
	m»£rved3
[7];

2520 
	s_vls_eùrs
 {

2521 
__be64
 
	mpÜt_vl_xm™_disÿrds
;

2522 } 
	mvls
[0];

2524 } 
	mpÜt
[1];

2527 
	sÝa_pÜt_”rÜ_šfo_msg
 {

2528 
__be64
 
	mpÜt_£Ëù_mask
[4];

2529 
__be32
 
	m”rÜ_šfo_£Ëù_mask
;

2530 
__be32
 
	m»£rved1
;

2531 
	s_pÜt_ei
 {

2532 
u8
 
	mpÜt_numb”
;

2533 
u8
 
	m»£rved2
[7];

2537 
u8
 
	m¡©us_ªd_code
;

2539 
u8
 
	m¿w
[17];

2542 
u8
 
	m·ck‘_æ™1
[8];

2543 
u8
 
	m·ck‘_æ™2
[8];

2544 
u8
 
	m»maššg_æ™_b™s12
;

2545 } 
	mei1to12
;

2547 
u8
 
	m·ck‘_by‹s
[8];

2548 
u8
 
	m»maššg_æ™_b™s
;

2549 } 
	mei13
;

2550 } 
	mei
;

2551 
u8
 
	m»£rved3
[6];

2552 } 
__·cked
 
	mpÜt_rcv_ei
;

2556 
u8
 
	m¡©us_ªd_sc
;

2557 
u8
 
	m»£rved4
[7];

2558 } 
__·cked
 
	mexûssive_bufãr_ov”run_ei
;

2562 
u8
 
	m¡©us
;

2563 
u8
 
	m»£rved5
;

2564 
__be16
 
	mpkey
;

2565 
__be32
 
	m¦id
;

2566 } 
__·cked
 
	mpÜt_xm™_cÚ¡¿št_ei
;

2570 
u8
 
	m¡©us
;

2571 
u8
 
	m»£rved6
;

2572 
__be16
 
	mpkey
;

2573 
__be32
 
	m¦id
;

2574 } 
__·cked
 
	mpÜt_rcv_cÚ¡¿št_ei
;

2578 
u8
 
	m¡©us_ªd_code
;

2579 
u8
 
	m»£rved7
[3];

2580 
__u32
 
	m”rÜ_šfo
;

2581 } 
__·cked
 
	mpÜt_rcv_sw™ch_»Ïy_ei
;

2585 
u8
 
	m¡©us_ªd_code
;

2586 
u8
 
	m»£rved8
;

2587 } 
__·cked
 
	muncÜ»ùabË_ei
;

2591 
u8
 
	m¡©us_ªd_code
;

2592 
u8
 
	m”rÜ_šfo
;

2593 } 
__·cked
 
	mfm_cÚfig_ei
;

2594 
__u32
 
	m»£rved9
;

2595 } 
	mpÜt
[1];

2599 
	e”rÜ_šfo_£Ëùs
 {

2600 
	mES_PORT_RCV_ERROR_INFO
 = (1 << 31),

2601 
	mES_EXCESSIVE_BUFFER_OVERRUN_INFO
 = (1 << 30),

2602 
	mES_PORT_XMIT_CONSTRAINT_ERROR_INFO
 = (1 << 29),

2603 
	mES_PORT_RCV_CONSTRAINT_ERROR_INFO
 = (1 << 28),

2604 
	mES_PORT_RCV_SWITCH_RELAY_ERROR_INFO
 = (1 << 27),

2605 
	mES_UNCORRECTABLE_ERROR_INFO
 = (1 << 26),

2606 
	mES_FM_CONFIG_ERROR_INFO
 = (1 << 25)

2609 
	$pma_g‘_Ýa_þas¥Ütšfo
(
Ýa_pma_mad
 *
pmp
,

2610 
ib_deviû
 *
ibdev
, 
u32
 *
»¥_Ën
)

2612 
Ýa_þass_pÜt_šfo
 *
p
 =

2613 (
Ýa_þass_pÜt_šfo
 *)
pmp
->
d©a
;

2615 
	`mem£t
(
pmp
->
d©a
, 0, (pmp->data));

2617 ià(
pmp
->
mad_hdr
.
©Œ_mod
 != 0)

2618 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2620 
p
->
ba£_v”siÚ
 = 
OPA_MGMT_BASE_VERSION
;

2621 
p
->
þass_v”siÚ
 = 
OPA_SM_CLASS_VERSION
;

2625 
p
->
ÿp_mask2_»¥_time
 = 
	`ýu_to_be32
(18);

2627 ià(
»¥_Ën
)

2628 *
»¥_Ën
 +ð(*
p
);

2630  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

2631 
	}
}

2633 
	$a0_pÜt¡©us
(
hfi1_µÜtd©a
 *
µd
,

2634 
Ýa_pÜt_¡©us_r¥
 *
r¥
)

2636 ià(!
	`is_bx
(
µd
->
dd
)) {

2637 
vl
;

2638 
u64
 
sum_vl_xm™_wa™
 = 0;

2639 
vl_®l_mask
 = 
VL_MASK_ALL
;

2641 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_®l_mask
, 
BITS_PER_LONG
) {

2642 
u64
 
tmp
 = 
sum_vl_xm™_wa™
 +

2643 
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_WAIT_VL
,

2644 
	`idx_äom_vl
(
vl
));

2645 ià(
tmp
 < 
sum_vl_xm™_wa™
) {

2647 
sum_vl_xm™_wa™
 = (
u64
)~0;

2650 
sum_vl_xm™_wa™
 = 
tmp
;

2652 ià(
	`be64_to_ýu
(
r¥
->
pÜt_xm™_wa™
è> 
sum_vl_xm™_wa™
)

2653 
r¥
->
pÜt_xm™_wa™
 = 
	`ýu_to_be64
(
sum_vl_xm™_wa™
);

2655 
	}
}

2666 
u16
 
	$tx_lšk_width
(
u16
 
lšk_width
)

2668 
n
 = 
LINK_WIDTH_DEFAULT
;

2669 
u16
 
tx_width
 = 
n
;

2671 
lšk_width
 && 
n
) {

2672 ià(
lšk_width
 & (1 << (
n
 - 1))) {

2673 
tx_width
 = 
n
;

2676 
n
--;

2679  
tx_width
;

2680 
	}
}

2699 
u64
 
	$g‘_xm™_wa™_couÁ”s
(
hfi1_µÜtd©a
 *
µd
,

2700 
u16
 
lšk_width
, u16 
lšk_¥“d
, 
vl
)

2702 
u64
 
pÜt_vl_xm™_wa™_cu¼
;

2703 
u64
 
d–_vl_xm™_wa™
;

2704 
u64
 
xm™_wa™_v®
;

2706 ià(
vl
 > 
C_VL_COUNT
)

2708 ià(
vl
 < 
C_VL_COUNT
)

2709 
pÜt_vl_xm™_wa™_cu¼
 =

2710 
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_WAIT_VL
, 
vl
);

2712 
pÜt_vl_xm™_wa™_cu¼
 =

2713 
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_WAIT
, 
CNTR_INVALID_VL
);

2715 
xm™_wa™_v®
 =

2716 
pÜt_vl_xm™_wa™_cu¼
 -

2717 
µd
->
pÜt_vl_xm™_wa™_Ï¡
[
vl
];

2718 
d–_vl_xm™_wa™
 =

2719 
	`cÚv”t_xm™_couÁ”
(
xm™_wa™_v®
,

2720 
µd
->
´ev_lšk_width
,

2721 
lšk_¥“d
);

2723 
µd
->
vl_xm™_æ™_út
[
vl
] +ð
d–_vl_xm™_wa™
;

2724 
µd
->
pÜt_vl_xm™_wa™_Ï¡
[
vl
] = 
pÜt_vl_xm™_wa™_cu¼
;

2725 
µd
->
´ev_lšk_width
 = 
lšk_width
;

2727  
µd
->
vl_xm™_æ™_út
[
vl
];

2728 
	}
}

2730 
	$pma_g‘_Ýa_pÜt¡©us
(
Ýa_pma_mad
 *
pmp
,

2731 
ib_deviû
 *
ibdev
,

2732 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

2734 
Ýa_pÜt_¡©us_»q
 *
»q
 =

2735 (
Ýa_pÜt_¡©us_»q
 *)
pmp
->
d©a
;

2736 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2737 
Ýa_pÜt_¡©us_r¥
 *
r¥
;

2738 
vl_£Ëù_mask
 = 
	`be32_to_ýu
(
»q
->vl_select_mask);

2739 
vl
;

2740 
size_t
 
»¥Ú£_d©a_size
;

2741 
u32
 
ÅÜts
 = 
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
) >> 24;

2742 
u8
 
pÜt_num
 = 
»q
->port_num;

2743 
u8
 
num_vls
 = 
	`hweight64
(
vl_£Ëù_mask
);

2744 
_vls_pùrs
 *
vlšfo
;

2745 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

2746 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2747 
vfi
;

2748 
u64
 
tmp
, 
tmp2
;

2749 
u16
 
lšk_width
;

2750 
u16
 
lšk_¥“d
;

2752 
»¥Ú£_d©a_size
 = 
	`¡ruù_size
(
r¥
, 
vls
, 
num_vls
);

2753 ià(
»¥Ú£_d©a_size
 > (
pmp
->
d©a
)) {

2754 
pmp
->
mad_hdr
.
¡©us
 |ð
OPA_PM_STATUS_REQUEST_TOO_LARGE
;

2755  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

2758 ià(
ÅÜts
 !ð1 || (
pÜt_num
 &&…Üt_num !ð
pÜt
) ||

2759 
num_vls
 > 
OPA_MAX_VLS
 || (
vl_£Ëù_mask
 & ~
VL_MASK_ALL
)) {

2760 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

2761  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

2764 
	`mem£t
(
pmp
->
d©a
, 0, (pmp->data));

2766 
r¥
 = (
Ýa_pÜt_¡©us_r¥
 *)
pmp
->
d©a
;

2767 ià(
pÜt_num
)

2768 
r¥
->
pÜt_num
 =…ort_num;

2770 
r¥
->
pÜt_num
 = 
pÜt
;

2772 
r¥
->
pÜt_rcv_cÚ¡¿št_”rÜs
 =

2773 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_RCV_CSTR_ERR
,

2774 
CNTR_INVALID_VL
));

2776 
	`hfi1_»ad_lšk_qu®™y
(
dd
, &
r¥
->
lšk_qu®™y_šdiÿtÜ
);

2778 
r¥
->
vl_£Ëù_mask
 = 
	`ýu_to_be32
((
u32
)vl_select_mask);

2779 
r¥
->
pÜt_xm™_d©a
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_XMIT_FLITS
,

2780 
CNTR_INVALID_VL
));

2781 
r¥
->
pÜt_rcv_d©a
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FLITS
,

2782 
CNTR_INVALID_VL
));

2783 
r¥
->
pÜt_xm™_pkts
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_XMIT_PKTS
,

2784 
CNTR_INVALID_VL
));

2785 
r¥
->
pÜt_rcv_pkts
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_PKTS
,

2786 
CNTR_INVALID_VL
));

2787 
r¥
->
pÜt_muÉiÿ¡_xm™_pkts
 =

2788 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_MC_XMIT_PKTS
,

2789 
CNTR_INVALID_VL
));

2790 
r¥
->
pÜt_muÉiÿ¡_rcv_pkts
 =

2791 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_MC_RCV_PKTS
,

2792 
CNTR_INVALID_VL
));

2797 
lšk_width
 =

2798 
	`tx_lšk_width
(
µd
->
lšk_width_downg¿de_tx_aùive
);

2799 
lšk_¥“d
 = 
	`g‘_lšk_¥“d
(
µd
->
lšk_¥“d_aùive
);

2800 
r¥
->
pÜt_xm™_wa™
 =

2801 
	`ýu_to_be64
(
	`g‘_xm™_wa™_couÁ”s
(
µd
, 
lšk_width
,

2802 
lšk_¥“d
, 
C_VL_COUNT
));

2803 
r¥
->
pÜt_rcv_ãú
 =

2804 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FCN
, 
CNTR_INVALID_VL
));

2805 
r¥
->
pÜt_rcv_beú
 =

2806 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_BCN
, 
CNTR_INVALID_VL
));

2807 
r¥
->
pÜt_xm™_disÿrds
 =

2808 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD
,

2809 
CNTR_INVALID_VL
));

2810 
r¥
->
pÜt_xm™_cÚ¡¿št_”rÜs
 =

2811 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_CSTR_ERR
,

2812 
CNTR_INVALID_VL
));

2813 
r¥
->
pÜt_rcv_»mÙe_physiÿl_”rÜs
 =

2814 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RMT_PHY_ERR
,

2815 
CNTR_INVALID_VL
));

2816 
r¥
->
loÿl_lšk_š‹gr™y_”rÜs
 =

2817 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_REPLAY
,

2818 
CNTR_INVALID_VL
));

2819 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_SEQ_CRC_CNT
, 
CNTR_INVALID_VL
);

2820 
tmp2
 = 
tmp
 + 
	`»ad_dev_úŒ
(
dd
, 
C_DC_REINIT_FROM_PEER_CNT
,

2821 
CNTR_INVALID_VL
);

2822 ià(
tmp2
 > (
u32
)
UINT_MAX
 ||mp2 < 
tmp
) {

2824 
r¥
->
lšk_”rÜ_»cov”y
 = 
	`ýu_to_be32
(~0);

2826 
r¥
->
lšk_”rÜ_»cov”y
 = 
	`ýu_to_be32
(
tmp2
);

2828 
r¥
->
pÜt_rcv_”rÜs
 =

2829 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
, 
CNTR_INVALID_VL
));

2830 
r¥
->
exûssive_bufãr_ov”runs
 =

2831 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
));

2832 
r¥
->
fm_cÚfig_”rÜs
 =

2833 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_FM_CFG_ERR
,

2834 
CNTR_INVALID_VL
));

2835 
r¥
->
lšk_dowÃd
 = 
	`ýu_to_be32
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_LINK_DOWN
,

2836 
CNTR_INVALID_VL
));

2839 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_UNC_ERR
, 
CNTR_INVALID_VL
);

2840 
r¥
->
uncÜ»ùabË_”rÜs
 = 
tmp
 < 0x100 ? (tmp & 0xff) : 0xff;

2842 
vlšfo
 = &
r¥
->
vls
[0];

2843 
vfi
 = 0;

2849 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_£Ëù_mask
, 
BITS_PER_LONG
) {

2850 
	`mem£t
(
vlšfo
, 0, (*vlinfo));

2852 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_FLIT_VL
, 
	`idx_äom_vl
(
vl
));

2853 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_d©a
 = 
	`ýu_to_be64
(
tmp
);

2855 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_pkts
 =

2856 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_PKT_VL
,

2857 
	`idx_äom_vl
(
vl
)));

2859 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_d©a
 =

2860 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_FLIT_VL
,

2861 
	`idx_äom_vl
(
vl
)));

2863 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_pkts
 =

2864 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_PKT_VL
,

2865 
	`idx_äom_vl
(
vl
)));

2870 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_wa™
 =

2871 
	`ýu_to_be64
(
	`g‘_xm™_wa™_couÁ”s
(
µd
, 
lšk_width
,

2872 
lšk_¥“d
,

2873 
	`idx_äom_vl
(
vl
)));

2875 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_ãú
 =

2876 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FCN_VL
,

2877 
	`idx_äom_vl
(
vl
)));

2879 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_beú
 =

2880 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_BCN_VL
,

2881 
	`idx_äom_vl
(
vl
)));

2883 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_disÿrds
 =

2884 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD_VL
,

2885 
	`idx_äom_vl
(
vl
)));

2886 
vlšfo
++;

2887 
vfi
++;

2890 
	`a0_pÜt¡©us
(
µd
, 
r¥
);

2892 ià(
»¥_Ën
)

2893 *
»¥_Ën
 +ð
»¥Ú£_d©a_size
;

2895  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

2896 
	}
}

2898 
u64
 
	$g‘_”rÜ_couÁ”_summ¬y
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

2899 
u8
 
»s_Îi
, u8 
»s_Ër
)

2901 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2902 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

2903 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2904 
u64
 
”rÜ_couÁ”_summ¬y
 = 0, 
tmp
;

2906 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_RCV_CSTR_ERR
,

2907 
CNTR_INVALID_VL
);

2909 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD
,

2910 
CNTR_INVALID_VL
);

2911 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_CSTR_ERR
,

2912 
CNTR_INVALID_VL
);

2913 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_dev_úŒ
(
dd
, 
C_DC_RMT_PHY_ERR
,

2914 
CNTR_INVALID_VL
);

2916 
”rÜ_couÁ”_summ¬y
 +ð(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_REPLAY
,

2917 
CNTR_INVALID_VL
è>> 
»s_Îi
);

2919 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_SEQ_CRC_CNT
, 
CNTR_INVALID_VL
);

2920 
tmp
 +ð
	`»ad_dev_úŒ
(
dd
, 
C_DC_REINIT_FROM_PEER_CNT
, 
CNTR_INVALID_VL
);

2921 
”rÜ_couÁ”_summ¬y
 +ð(
tmp
 >> 
»s_Ër
);

2922 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
,

2923 
CNTR_INVALID_VL
);

2924 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
);

2925 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_dev_úŒ
(
dd
, 
C_DC_FM_CFG_ERR
,

2926 
CNTR_INVALID_VL
);

2928 
”rÜ_couÁ”_summ¬y
 +ð
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_LINK_DOWN
,

2929 
CNTR_INVALID_VL
);

2930 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_UNC_ERR
, 
CNTR_INVALID_VL
);

2932 
”rÜ_couÁ”_summ¬y
 +ð
tmp
 < 0x100 ? (tmp & 0xff) : 0xff;

2934  
”rÜ_couÁ”_summ¬y
;

2935 
	}
}

2937 
	$a0_d©acouÁ”s
(
hfi1_µÜtd©a
 *
µd
, 
_pÜt_dùrs
 *
r¥
)

2939 ià(!
	`is_bx
(
µd
->
dd
)) {

2940 
vl
;

2941 
u64
 
sum_vl_xm™_wa™
 = 0;

2942 
vl_®l_mask
 = 
VL_MASK_ALL
;

2944 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_®l_mask
, 
BITS_PER_LONG
) {

2945 
u64
 
tmp
 = 
sum_vl_xm™_wa™
 +

2946 
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_WAIT_VL
,

2947 
	`idx_äom_vl
(
vl
));

2948 ià(
tmp
 < 
sum_vl_xm™_wa™
) {

2950 
sum_vl_xm™_wa™
 = (
u64
)~0;

2953 
sum_vl_xm™_wa™
 = 
tmp
;

2955 ià(
	`be64_to_ýu
(
r¥
->
pÜt_xm™_wa™
è> 
sum_vl_xm™_wa™
)

2956 
r¥
->
pÜt_xm™_wa™
 = 
	`ýu_to_be64
(
sum_vl_xm™_wa™
);

2958 
	}
}

2960 
	$pma_g‘_Ýa_pÜt_dùrs
(
ib_deviû
 *
ibdev
,

2961 
_pÜt_dùrs
 *
r¥
)

2963 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2965 
r¥
->
pÜt_xm™_d©a
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_XMIT_FLITS
,

2966 
CNTR_INVALID_VL
));

2967 
r¥
->
pÜt_rcv_d©a
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FLITS
,

2968 
CNTR_INVALID_VL
));

2969 
r¥
->
pÜt_xm™_pkts
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_XMIT_PKTS
,

2970 
CNTR_INVALID_VL
));

2971 
r¥
->
pÜt_rcv_pkts
 = 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_PKTS
,

2972 
CNTR_INVALID_VL
));

2973 
r¥
->
pÜt_muÉiÿ¡_xm™_pkts
 =

2974 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_MC_XMIT_PKTS
,

2975 
CNTR_INVALID_VL
));

2976 
r¥
->
pÜt_muÉiÿ¡_rcv_pkts
 =

2977 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_MC_RCV_PKTS
,

2978 
CNTR_INVALID_VL
));

2979 
	}
}

2981 
	$pma_g‘_Ýa_d©acouÁ”s
(
Ýa_pma_mad
 *
pmp
,

2982 
ib_deviû
 *
ibdev
,

2983 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

2985 
Ýa_pÜt_d©a_couÁ”s_msg
 *
»q
 =

2986 (
Ýa_pÜt_d©a_couÁ”s_msg
 *)
pmp
->
d©a
;

2987 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

2988 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

2989 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2990 
_pÜt_dùrs
 *
r¥
;

2991 
_vls_dùrs
 *
vlšfo
;

2992 
size_t
 
»¥Ú£_d©a_size
;

2993 
u32
 
num_pÜts
;

2994 
u8
 
lq
, 
num_vls
;

2995 
u8
 
»s_Îi
, 
»s_Ër
;

2996 
u64
 
pÜt_mask
;

2997 
u8
 
pÜt_num
;

2998 
vl
;

2999 
vl_£Ëù_mask
;

3000 
vfi
;

3001 
u16
 
lšk_width
;

3002 
u16
 
lšk_¥“d
;

3004 
num_pÜts
 = 
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
) >> 24;

3005 
num_vls
 = 
	`hweight32
(
	`be32_to_ýu
(
»q
->
vl_£Ëù_mask
));

3006 
vl_£Ëù_mask
 = 
	`be32_to_ýu
(
»q
->vl_select_mask);

3007 
»s_Îi
 = (
u8
)(
	`be32_to_ýu
(
»q
->
»sÞutiÚ
è& 
MSK_LLI
è>> 
MSK_LLI_SFT
;

3008 
»s_Îi
 =„es_Î˜?„es_Î˜+ 
ADD_LLI
 : 0;

3009 
»s_Ër
 = (
u8
)(
	`be32_to_ýu
(
»q
->
»sÞutiÚ
è& 
MSK_LER
è>> 
MSK_LER_SFT
;

3010 
»s_Ër
 =„es_Ë¸?„es_Ë¸+ 
ADD_LER
 : 0;

3012 ià(
num_pÜts
 !ð1 || (
vl_£Ëù_mask
 & ~
VL_MASK_ALL
)) {

3013 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3014  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3018 
»¥Ú£_d©a_size
 = 
	`¡ruù_size
(
»q
, 
pÜt
[0].
vls
, 
num_vls
);

3020 ià(
»¥Ú£_d©a_size
 > (
pmp
->
d©a
)) {

3021 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3022  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3029 
pÜt_mask
 = 
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]);

3030 
pÜt_num
 = 
	`fšd_fœ¡_b™
((*)&
pÜt_mask
,

3031 (
pÜt_mask
) * 8);

3033 ià(
pÜt_num
 !ð
pÜt
) {

3034 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3035  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3038 
r¥
 = &
»q
->
pÜt
[0];

3039 
	`mem£t
(
r¥
, 0, (*rsp));

3041 
r¥
->
pÜt_numb”
 = 
pÜt
;

3047 
	`hfi1_»ad_lšk_qu®™y
(
dd
, &
lq
);

3048 
r¥
->
lšk_qu®™y_šdiÿtÜ
 = 
	`ýu_to_be32
((
u32
)
lq
);

3049 
	`pma_g‘_Ýa_pÜt_dùrs
(
ibdev
, 
r¥
);

3055 
lšk_width
 =

3056 
	`tx_lšk_width
(
µd
->
lšk_width_downg¿de_tx_aùive
);

3057 
lšk_¥“d
 = 
	`g‘_lšk_¥“d
(
µd
->
lšk_¥“d_aùive
);

3058 
r¥
->
pÜt_xm™_wa™
 =

3059 
	`ýu_to_be64
(
	`g‘_xm™_wa™_couÁ”s
(
µd
, 
lšk_width
,

3060 
lšk_¥“d
, 
C_VL_COUNT
));

3061 
r¥
->
pÜt_rcv_ãú
 =

3062 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FCN
, 
CNTR_INVALID_VL
));

3063 
r¥
->
pÜt_rcv_beú
 =

3064 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_BCN
, 
CNTR_INVALID_VL
));

3065 
r¥
->
pÜt_”rÜ_couÁ”_summ¬y
 =

3066 
	`ýu_to_be64
(
	`g‘_”rÜ_couÁ”_summ¬y
(
ibdev
, 
pÜt
,

3067 
»s_Îi
, 
»s_Ër
));

3069 
vlšfo
 = &
r¥
->
vls
[0];

3070 
vfi
 = 0;

3076 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_£Ëù_mask
, 
BITS_PER_LONG
) {

3077 
	`mem£t
(
vlšfo
, 0, (*vlinfo));

3079 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_d©a
 =

3080 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_FLIT_VL
,

3081 
	`idx_äom_vl
(
vl
)));

3083 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_d©a
 =

3084 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_FLIT_VL
,

3085 
	`idx_äom_vl
(
vl
)));

3087 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_pkts
 =

3088 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_TX_PKT_VL
,

3089 
	`idx_äom_vl
(
vl
)));

3091 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_pkts
 =

3092 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_PKT_VL
,

3093 
	`idx_äom_vl
(
vl
)));

3099 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_wa™
 =

3100 
	`ýu_to_be64
(
	`g‘_xm™_wa™_couÁ”s
(
µd
, 
lšk_width
,

3101 
lšk_¥“d
,

3102 
	`idx_äom_vl
(
vl
)));

3104 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_ãú
 =

3105 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_FCN_VL
,

3106 
	`idx_äom_vl
(
vl
)));

3107 
r¥
->
vls
[
vfi
].
pÜt_vl_rcv_beú
 =

3108 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_BCN_VL
,

3109 
	`idx_äom_vl
(
vl
)));

3120 
vlšfo
++;

3121 
vfi
++;

3124 
	`a0_d©acouÁ”s
(
µd
, 
r¥
);

3126 ià(
»¥_Ën
)

3127 *
»¥_Ën
 +ð
»¥Ú£_d©a_size
;

3129  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3130 
	}
}

3132 
	$pma_g‘_ib_pÜtcouÁ”s_ext
(
ib_pma_mad
 *
pmp
,

3133 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
)

3135 
ib_pma_pÜtcouÁ”s_ext
 *
p
 = (ib_pma_portcounters_ext *)

3136 
pmp
->
d©a
;

3137 
_pÜt_dùrs
 
r¥
;

3139 ià(
pmp
->
mad_hdr
.
©Œ_mod
 !ð0 || 
p
->
pÜt_£Ëù
 !ð
pÜt
) {

3140 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3141 
baž
;

3144 
	`mem£t
(&
r¥
, 0, (rsp));

3145 
	`pma_g‘_Ýa_pÜt_dùrs
(
ibdev
, &
r¥
);

3147 
p
->
pÜt_xm™_d©a
 = 
r¥
.port_xmit_data;

3148 
p
->
pÜt_rcv_d©a
 = 
r¥
.port_rcv_data;

3149 
p
->
pÜt_xm™_·ck‘s
 = 
r¥
.
pÜt_xm™_pkts
;

3150 
p
->
pÜt_rcv_·ck‘s
 = 
r¥
.
pÜt_rcv_pkts
;

3151 
p
->
pÜt_uniÿ¡_xm™_·ck‘s
 = 0;

3152 
p
->
pÜt_uniÿ¡_rcv_·ck‘s
 = 0;

3153 
p
->
pÜt_muÉiÿ¡_xm™_·ck‘s
 = 
r¥
.
pÜt_muÉiÿ¡_xm™_pkts
;

3154 
p
->
pÜt_muÉiÿ¡_rcv_·ck‘s
 = 
r¥
.
pÜt_muÉiÿ¡_rcv_pkts
;

3156 
baž
:

3157  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3158 
	}
}

3160 
	$pma_g‘_Ýa_pÜt_eùrs
(
ib_deviû
 *
ibdev
,

3161 
_pÜt_eùrs
 *
r¥
, 
u8
 
pÜt
)

3163 
u64
 
tmp
, 
tmp2
;

3164 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

3165 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3166 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3168 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_SEQ_CRC_CNT
, 
CNTR_INVALID_VL
);

3169 
tmp2
 = 
tmp
 + 
	`»ad_dev_úŒ
(
dd
, 
C_DC_REINIT_FROM_PEER_CNT
,

3170 
CNTR_INVALID_VL
);

3171 ià(
tmp2
 > (
u32
)
UINT_MAX
 ||mp2 < 
tmp
) {

3173 
r¥
->
lšk_”rÜ_»cov”y
 = 
	`ýu_to_be32
(~0);

3175 
r¥
->
lšk_”rÜ_»cov”y
 = 
	`ýu_to_be32
(
tmp2
);

3178 
r¥
->
lšk_dowÃd
 = 
	`ýu_to_be32
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_LINK_DOWN
,

3179 
CNTR_INVALID_VL
));

3180 
r¥
->
pÜt_rcv_”rÜs
 =

3181 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
, 
CNTR_INVALID_VL
));

3182 
r¥
->
pÜt_rcv_»mÙe_physiÿl_”rÜs
 =

3183 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RMT_PHY_ERR
,

3184 
CNTR_INVALID_VL
));

3185 
r¥
->
pÜt_rcv_sw™ch_»Ïy_”rÜs
 = 0;

3186 
r¥
->
pÜt_xm™_disÿrds
 =

3187 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD
,

3188 
CNTR_INVALID_VL
));

3189 
r¥
->
pÜt_xm™_cÚ¡¿št_”rÜs
 =

3190 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_CSTR_ERR
,

3191 
CNTR_INVALID_VL
));

3192 
r¥
->
pÜt_rcv_cÚ¡¿št_”rÜs
 =

3193 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_RCV_CSTR_ERR
,

3194 
CNTR_INVALID_VL
));

3195 
r¥
->
loÿl_lšk_š‹gr™y_”rÜs
 =

3196 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RX_REPLAY
,

3197 
CNTR_INVALID_VL
));

3198 
r¥
->
exûssive_bufãr_ov”runs
 =

3199 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
));

3200 
	}
}

3202 
	$pma_g‘_Ýa_pÜ‹¼Üs
(
Ýa_pma_mad
 *
pmp
,

3203 
ib_deviû
 *
ibdev
,

3204 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

3206 
size_t
 
»¥Ú£_d©a_size
;

3207 
_pÜt_eùrs
 *
r¥
;

3208 
u8
 
pÜt_num
;

3209 
Ýa_pÜt_”rÜ_couÁ”s64_msg
 *
»q
;

3210 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

3211 
u32
 
num_pÜts
;

3212 
u8
 
num_p¦m
;

3213 
u8
 
num_vls
;

3214 
hfi1_ibpÜt
 *
ibp
;

3215 
hfi1_µÜtd©a
 *
µd
;

3216 
_vls_eùrs
 *
vlšfo
;

3217 
vl
;

3218 
u64
 
pÜt_mask
, 
tmp
;

3219 
vl_£Ëù_mask
;

3220 
vfi
;

3222 
»q
 = (
Ýa_pÜt_”rÜ_couÁ”s64_msg
 *)
pmp
->
d©a
;

3224 
num_pÜts
 = 
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
) >> 24;

3226 
num_p¦m
 = 
	`hweight64
(
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]));

3227 
num_vls
 = 
	`hweight32
(
	`be32_to_ýu
(
»q
->
vl_£Ëù_mask
));

3229 ià(
num_pÜts
 !ð1 ||‚um_pÜt !ð
num_p¦m
) {

3230 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3231  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3234 
»¥Ú£_d©a_size
 = 
	`¡ruù_size
(
»q
, 
pÜt
[0].
vls
, 
num_vls
);

3236 ià(
»¥Ú£_d©a_size
 > (
pmp
->
d©a
)) {

3237 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3238  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3244 
pÜt_mask
 = 
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]);

3245 
pÜt_num
 = 
	`fšd_fœ¡_b™
((*)&
pÜt_mask
,

3246 (
pÜt_mask
) * 8);

3248 ià(
pÜt_num
 !ð
pÜt
) {

3249 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3250  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3253 
r¥
 = &
»q
->
pÜt
[0];

3255 
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt_num
);

3256 
µd
 = 
	`µd_äom_ibp
(
ibp
);

3258 
	`mem£t
(
r¥
, 0, (*rsp));

3259 
r¥
->
pÜt_numb”
 = 
pÜt_num
;

3261 
	`pma_g‘_Ýa_pÜt_eùrs
(
ibdev
, 
r¥
, 
pÜt_num
);

3263 
r¥
->
pÜt_rcv_»mÙe_physiÿl_”rÜs
 =

3264 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RMT_PHY_ERR
,

3265 
CNTR_INVALID_VL
));

3266 
r¥
->
fm_cÚfig_”rÜs
 =

3267 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_FM_CFG_ERR
,

3268 
CNTR_INVALID_VL
));

3269 
tmp
 = 
	`»ad_dev_úŒ
(
dd
, 
C_DC_UNC_ERR
, 
CNTR_INVALID_VL
);

3271 
r¥
->
uncÜ»ùabË_”rÜs
 = 
tmp
 < 0x100 ? (tmp & 0xff) : 0xff;

3272 
r¥
->
pÜt_rcv_”rÜs
 =

3273 
	`ýu_to_be64
(
	`»ad_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
, 
CNTR_INVALID_VL
));

3274 
vlšfo
 = &
r¥
->
vls
[0];

3275 
vfi
 = 0;

3276 
vl_£Ëù_mask
 = 
	`be32_to_ýu
(
»q
->vl_select_mask);

3277 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_£Ëù_mask
, 
BITS_PER_LONG
) {

3278 
	`mem£t
(
vlšfo
, 0, (*vlinfo));

3279 
r¥
->
vls
[
vfi
].
pÜt_vl_xm™_disÿrds
 =

3280 
	`ýu_to_be64
(
	`»ad_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD_VL
,

3281 
	`idx_äom_vl
(
vl
)));

3282 
vlšfo
 += 1;

3283 
vfi
++;

3286 ià(
»¥_Ën
)

3287 *
»¥_Ën
 +ð
»¥Ú£_d©a_size
;

3289  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3290 
	}
}

3292 
	$pma_g‘_ib_pÜtcouÁ”s
(
ib_pma_mad
 *
pmp
,

3293 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
)

3295 
ib_pma_pÜtcouÁ”s
 *
p
 = (ib_pma_portcounters *)

3296 
pmp
->
d©a
;

3297 
_pÜt_eùrs
 
r¥
;

3298 
u64
 
‹mp_lšk_ov”run_”rÜs
;

3299 
u64
 
‹mp_64
;

3300 
u32
 
‹mp_32
;

3302 
	`mem£t
(&
r¥
, 0, (rsp));

3303 
	`pma_g‘_Ýa_pÜt_eùrs
(
ibdev
, &
r¥
, 
pÜt
);

3305 ià(
pmp
->
mad_hdr
.
©Œ_mod
 !ð0 || 
p
->
pÜt_£Ëù
 !ð
pÜt
) {

3306 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3307 
baž
;

3310 
p
->
symbÞ_”rÜ_couÁ”
 = 0;

3312 
‹mp_32
 = 
	`be32_to_ýu
(
r¥
.
lšk_”rÜ_»cov”y
);

3313 ià(
‹mp_32
 > 0xFFUL)

3314 
p
->
lšk_”rÜ_»cov”y_couÁ”
 = 0xFF;

3316 
p
->
lšk_”rÜ_»cov”y_couÁ”
 = (
u8
)
‹mp_32
;

3318 
‹mp_32
 = 
	`be32_to_ýu
(
r¥
.
lšk_dowÃd
);

3319 ià(
‹mp_32
 > 0xFFUL)

3320 
p
->
lšk_dowÃd_couÁ”
 = 0xFF;

3322 
p
->
lšk_dowÃd_couÁ”
 = (
u8
)
‹mp_32
;

3324 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_rcv_”rÜs
);

3325 ià(
‹mp_64
 > 0xFFFFUL)

3326 
p
->
pÜt_rcv_”rÜs
 = 
	`ýu_to_be16
(0xFFFF);

3328 
p
->
pÜt_rcv_”rÜs
 = 
	`ýu_to_be16
((
u16
)
‹mp_64
);

3330 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_rcv_»mÙe_physiÿl_”rÜs
);

3331 ià(
‹mp_64
 > 0xFFFFUL)

3332 
p
->
pÜt_rcv_»mphys_”rÜs
 = 
	`ýu_to_be16
(0xFFFF);

3334 
p
->
pÜt_rcv_»mphys_”rÜs
 = 
	`ýu_to_be16
((
u16
)
‹mp_64
);

3336 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_rcv_sw™ch_»Ïy_”rÜs
);

3337 
p
->
pÜt_rcv_sw™ch_»Ïy_”rÜs
 = 
	`ýu_to_be16
((
u16
)
‹mp_64
);

3339 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_xm™_disÿrds
);

3340 ià(
‹mp_64
 > 0xFFFFUL)

3341 
p
->
pÜt_xm™_disÿrds
 = 
	`ýu_to_be16
(0xFFFF);

3343 
p
->
pÜt_xm™_disÿrds
 = 
	`ýu_to_be16
((
u16
)
‹mp_64
);

3345 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_xm™_cÚ¡¿št_”rÜs
);

3346 ià(
‹mp_64
 > 0xFFUL)

3347 
p
->
pÜt_xm™_cÚ¡¿št_”rÜs
 = 0xFF;

3349 
p
->
pÜt_xm™_cÚ¡¿št_”rÜs
 = (
u8
)
‹mp_64
;

3351 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
pÜt_rcv_cÚ¡¿št_”rÜs
);

3352 ià(
‹mp_64
 > 0xFFUL)

3353 
p
->
pÜt_rcv_cÚ¡¿št_”rÜs
 = 0xFFUL;

3355 
p
->
pÜt_rcv_cÚ¡¿št_”rÜs
 = (
u8
)
‹mp_64
;

3358 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
loÿl_lšk_š‹gr™y_”rÜs
);

3359 ià(
‹mp_64
 > 0xFUL)

3360 
‹mp_64
 = 0xFUL;

3362 
‹mp_lšk_ov”run_”rÜs
 = 
‹mp_64
 << 4;

3364 
‹mp_64
 = 
	`be64_to_ýu
(
r¥
.
exûssive_bufãr_ov”runs
);

3365 ià(
‹mp_64
 > 0xFUL)

3366 
‹mp_64
 = 0xFUL;

3367 
‹mp_lšk_ov”run_”rÜs
 |ð
‹mp_64
;

3369 
p
->
lšk_ov”run_”rÜs
 = (
u8
)
‹mp_lšk_ov”run_”rÜs
;

3371 
p
->
vl15_drÝ³d
 = 0;

3373 
baž
:

3374  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3375 
	}
}

3377 
	$pma_g‘_Ýa_”rÜšfo
(
Ýa_pma_mad
 *
pmp
,

3378 
ib_deviû
 *
ibdev
,

3379 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

3381 
size_t
 
»¥Ú£_d©a_size
;

3382 
_pÜt_ei
 *
r¥
;

3383 
Ýa_pÜt_”rÜ_šfo_msg
 *
»q
;

3384 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

3385 
u64
 
pÜt_mask
;

3386 
u32
 
num_pÜts
;

3387 
u8
 
pÜt_num
;

3388 
u8
 
num_p¦m
;

3389 
u64
 
»g
;

3391 
»q
 = (
Ýa_pÜt_”rÜ_šfo_msg
 *)
pmp
->
d©a
;

3392 
r¥
 = &
»q
->
pÜt
[0];

3394 
num_pÜts
 = 
	`OPA_AM_NPORT
(
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
));

3395 
num_p¦m
 = 
	`hweight64
(
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]));

3397 
	`mem£t
(
r¥
, 0, (*rsp));

3399 ià(
num_pÜts
 !ð1 ||‚um_pÜt !ð
num_p¦m
) {

3400 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3401  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3405 
»¥Ú£_d©a_size
 = (
Ýa_pÜt_”rÜ_šfo_msg
);

3407 ià(
»¥Ú£_d©a_size
 > (
pmp
->
d©a
)) {

3408 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3409  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3416 
pÜt_mask
 = 
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]);

3417 
pÜt_num
 = 
	`fšd_fœ¡_b™
((*)&
pÜt_mask
,

3418 (
pÜt_mask
) * 8);

3420 ià(
pÜt_num
 !ð
pÜt
) {

3421 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3422  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3424 
r¥
->
pÜt_numb”
 = 
pÜt
;

3427 
r¥
->
pÜt_rcv_ei
.
¡©us_ªd_code
 =

3428 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
;

3429 
	`memýy
(&
r¥
->
pÜt_rcv_ei
.
ei
.
ei1to12
.
·ck‘_æ™1
,

3430 &
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™1
, (
u64
));

3431 
	`memýy
(&
r¥
->
pÜt_rcv_ei
.
ei
.
ei1to12
.
·ck‘_æ™2
,

3432 &
dd
->
”r_šfo_rcvpÜt
.
·ck‘_æ™2
, (
u64
));

3435 
»g
 = 
	`»ad_c¤
(
dd
, 
RCV_ERR_INFO
);

3436 ià(
»g
 & 
RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SMASK
) {

3441 
u8
 
tmp
 = (u8)
»g
;

3443 
tmp
 &ð
RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SC_SMASK
;

3444 
tmp
 <<= 2;

3445 
r¥
->
exûssive_bufãr_ov”run_ei
.
¡©us_ªd_sc
 = 
tmp
;

3447 
r¥
->
exûssive_bufãr_ov”run_ei
.
¡©us_ªd_sc
 |= 0x80;

3450 
r¥
->
pÜt_xm™_cÚ¡¿št_ei
.
¡©us
 =

3451 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¡©us
;

3452 
r¥
->
pÜt_xm™_cÚ¡¿št_ei
.
pkey
 =

3453 
	`ýu_to_be16
(
dd
->
”r_šfo_xm™_cÚ¡¿št
.
pkey
);

3454 
r¥
->
pÜt_xm™_cÚ¡¿št_ei
.
¦id
 =

3455 
	`ýu_to_be32
(
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¦id
);

3457 
r¥
->
pÜt_rcv_cÚ¡¿št_ei
.
¡©us
 =

3458 
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¡©us
;

3459 
r¥
->
pÜt_rcv_cÚ¡¿št_ei
.
pkey
 =

3460 
	`ýu_to_be16
(
dd
->
”r_šfo_rcv_cÚ¡¿št
.
pkey
);

3461 
r¥
->
pÜt_rcv_cÚ¡¿št_ei
.
¦id
 =

3462 
	`ýu_to_be32
(
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¦id
);

3465 
r¥
->
uncÜ»ùabË_ei
.
¡©us_ªd_code
 = 
dd
->
”r_šfo_uncÜ»ùabË
;

3468 
r¥
->
fm_cÚfig_ei
.
¡©us_ªd_code
 = 
dd
->
”r_šfo_fmcÚfig
;

3470 ià(
»¥_Ën
)

3471 *
»¥_Ën
 +ð
»¥Ú£_d©a_size
;

3473  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3474 
	}
}

3476 
	$pma_£t_Ýa_pÜt¡©us
(
Ýa_pma_mad
 *
pmp
,

3477 
ib_deviû
 *
ibdev
,

3478 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

3480 
Ýa_þ—r_pÜt_¡©us
 *
»q
 =

3481 (
Ýa_þ—r_pÜt_¡©us
 *)
pmp
->
d©a
;

3482 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

3483 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3484 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3485 
u32
 
ÅÜts
 = 
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
) >> 24;

3486 
u64
 
pÜŠ
 = 
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]);

3487 
u32
 
couÁ”_£Ëù
 = 
	`be32_to_ýu
(
»q
->
couÁ”_£Ëù_mask
);

3488 
vl_£Ëù_mask
 = 
VL_MASK_ALL
;

3489 
vl
;

3491 ià((
ÅÜts
 !ð1è|| (
pÜŠ
 !ð1 << 
pÜt
)) {

3492 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3493  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3501 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_DATA
)

3502 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_XMIT_FLITS
, 
CNTR_INVALID_VL
, 0);

3504 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_DATA
)

3505 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_FLITS
, 
CNTR_INVALID_VL
, 0);

3507 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_PKTS
)

3508 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_XMIT_PKTS
, 
CNTR_INVALID_VL
, 0);

3510 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_PKTS
)

3511 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_PKTS
, 
CNTR_INVALID_VL
, 0);

3513 ià(
couÁ”_£Ëù
 & 
CS_PORT_MCAST_XMIT_PKTS
)

3514 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_MC_XMIT_PKTS
, 
CNTR_INVALID_VL
, 0);

3516 ià(
couÁ”_£Ëù
 & 
CS_PORT_MCAST_RCV_PKTS
)

3517 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_MC_RCV_PKTS
, 
CNTR_INVALID_VL
, 0);

3519 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_WAIT
) {

3520 
	`wr™e_pÜt_úŒ
(
µd
, 
C_TX_WAIT
, 
CNTR_INVALID_VL
, 0);

3521 
µd
->
pÜt_vl_xm™_wa™_Ï¡
[
C_VL_COUNT
] = 0;

3522 
µd
->
vl_xm™_æ™_út
[
C_VL_COUNT
] = 0;

3526 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_FECN
)

3527 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_FCN
, 
CNTR_INVALID_VL
, 0);

3529 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_BECN
)

3530 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_BCN
, 
CNTR_INVALID_VL
, 0);

3535 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_BUBBLE
)

3536 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_BBL
, 
CNTR_INVALID_VL
, 0);

3543 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_CONSTRAINT_ERRORS
)

3544 
	`wr™e_pÜt_úŒ
(
µd
, 
C_SW_RCV_CSTR_ERR
, 
CNTR_INVALID_VL
, 0);

3547 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_DISCARDS
)

3548 
	`wr™e_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD
, 
CNTR_INVALID_VL
, 0);

3550 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_CONSTRAINT_ERRORS
)

3551 
	`wr™e_pÜt_úŒ
(
µd
, 
C_SW_XMIT_CSTR_ERR
, 
CNTR_INVALID_VL
, 0);

3553 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_REMOTE_PHYSICAL_ERRORS
)

3554 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RMT_PHY_ERR
, 
CNTR_INVALID_VL
, 0);

3556 ià(
couÁ”_£Ëù
 & 
CS_LOCAL_LINK_INTEGRITY_ERRORS
)

3557 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RX_REPLAY
, 
CNTR_INVALID_VL
, 0);

3559 ià(
couÁ”_£Ëù
 & 
CS_LINK_ERROR_RECOVERY
) {

3560 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_SEQ_CRC_CNT
, 
CNTR_INVALID_VL
, 0);

3561 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_REINIT_FROM_PEER_CNT
,

3562 
CNTR_INVALID_VL
, 0);

3565 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_ERRORS
)

3566 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
, 
CNTR_INVALID_VL
, 0);

3568 ià(
couÁ”_£Ëù
 & 
CS_EXCESSIVE_BUFFER_OVERRUNS
) {

3569 
	`wr™e_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
, 0);

3570 
dd
->
rcv_ovæ_út
 = 0;

3573 ià(
couÁ”_£Ëù
 & 
CS_FM_CONFIG_ERRORS
)

3574 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_FM_CFG_ERR
, 
CNTR_INVALID_VL
, 0);

3576 ià(
couÁ”_£Ëù
 & 
CS_LINK_DOWNED
)

3577 
	`wr™e_pÜt_úŒ
(
µd
, 
C_SW_LINK_DOWN
, 
CNTR_INVALID_VL
, 0);

3579 ià(
couÁ”_£Ëù
 & 
CS_UNCORRECTABLE_ERRORS
)

3580 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_UNC_ERR
, 
CNTR_INVALID_VL
, 0);

3582 
	`fÜ_—ch_£t_b™
(
vl
, &
vl_£Ëù_mask
, 
BITS_PER_LONG
) {

3583 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_DATA
)

3584 
	`wr™e_pÜt_úŒ
(
µd
, 
C_TX_FLIT_VL
, 
	`idx_äom_vl
(
vl
), 0);

3586 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_DATA
)

3587 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RX_FLIT_VL
, 
	`idx_äom_vl
(
vl
), 0);

3589 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_PKTS
)

3590 
	`wr™e_pÜt_úŒ
(
µd
, 
C_TX_PKT_VL
, 
	`idx_äom_vl
(
vl
), 0);

3592 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_PKTS
)

3593 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RX_PKT_VL
, 
	`idx_äom_vl
(
vl
), 0);

3595 ià(
couÁ”_£Ëù
 & 
CS_PORT_XMIT_WAIT
) {

3596 
	`wr™e_pÜt_úŒ
(
µd
, 
C_TX_WAIT_VL
, 
	`idx_äom_vl
(
vl
), 0);

3597 
µd
->
pÜt_vl_xm™_wa™_Ï¡
[
	`idx_äom_vl
(
vl
)] = 0;

3598 
µd
->
vl_xm™_æ™_út
[
	`idx_äom_vl
(
vl
)] = 0;

3602 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_FECN
)

3603 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_FCN_VL
, 
	`idx_äom_vl
(
vl
), 0);

3605 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_BECN
)

3606 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_BCN_VL
, 
	`idx_äom_vl
(
vl
), 0);

3611 ià(
couÁ”_£Ëù
 & 
CS_PORT_RCV_BUBBLE
)

3612 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_BBL_VL
, 
	`idx_äom_vl
(
vl
), 0);

3617 ià(
couÁ”_£Ëù
 & 
C_SW_XMIT_DSCD_VL
)

3618 
	`wr™e_pÜt_úŒ
(
µd
, 
C_SW_XMIT_DSCD_VL
,

3619 
	`idx_äom_vl
(
vl
), 0);

3622 ià(
»¥_Ën
)

3623 *
»¥_Ën
 +ð(*
»q
);

3625  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3626 
	}
}

3628 
	$pma_£t_Ýa_”rÜšfo
(
Ýa_pma_mad
 *
pmp
,

3629 
ib_deviû
 *
ibdev
,

3630 
u8
 
pÜt
, 
u32
 *
»¥_Ën
)

3632 
_pÜt_ei
 *
r¥
;

3633 
Ýa_pÜt_”rÜ_šfo_msg
 *
»q
;

3634 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

3635 
u64
 
pÜt_mask
;

3636 
u32
 
num_pÜts
;

3637 
u8
 
pÜt_num
;

3638 
u8
 
num_p¦m
;

3639 
u32
 
”rÜ_šfo_£Ëù
;

3641 
»q
 = (
Ýa_pÜt_”rÜ_šfo_msg
 *)
pmp
->
d©a
;

3642 
r¥
 = &
»q
->
pÜt
[0];

3644 
num_pÜts
 = 
	`OPA_AM_NPORT
(
	`be32_to_ýu
(
pmp
->
mad_hdr
.
©Œ_mod
));

3645 
num_p¦m
 = 
	`hweight64
(
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]));

3647 
	`mem£t
(
r¥
, 0, (*rsp));

3649 ià(
num_pÜts
 !ð1 ||‚um_pÜt !ð
num_p¦m
) {

3650 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3651  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3658 
pÜt_mask
 = 
	`be64_to_ýu
(
»q
->
pÜt_£Ëù_mask
[3]);

3659 
pÜt_num
 = 
	`fšd_fœ¡_b™
((*)&
pÜt_mask
,

3660 (
pÜt_mask
) * 8);

3662 ià(
pÜt_num
 !ð
pÜt
) {

3663 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3664  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3667 
”rÜ_šfo_£Ëù
 = 
	`be32_to_ýu
(
»q
->
”rÜ_šfo_£Ëù_mask
);

3670 ià(
”rÜ_šfo_£Ëù
 & 
ES_PORT_RCV_ERROR_INFO
)

3672 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 &ð~
OPA_EI_STATUS_SMASK
;

3675 ià(
”rÜ_šfo_£Ëù
 & 
ES_EXCESSIVE_BUFFER_OVERRUN_INFO
)

3680 
	`wr™e_c¤
(
dd
, 
RCV_ERR_INFO
,

3681 
RCV_ERR_INFO_RCV_EXCESS_BUFFER_OVERRUN_SMASK
);

3683 ià(
”rÜ_šfo_£Ëù
 & 
ES_PORT_XMIT_CONSTRAINT_ERROR_INFO
)

3684 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¡©us
 &ð~
OPA_EI_STATUS_SMASK
;

3686 ià(
”rÜ_šfo_£Ëù
 & 
ES_PORT_RCV_CONSTRAINT_ERROR_INFO
)

3687 
dd
->
”r_šfo_rcv_cÚ¡¿št
.
¡©us
 &ð~
OPA_EI_STATUS_SMASK
;

3690 ià(
”rÜ_šfo_£Ëù
 & 
ES_UNCORRECTABLE_ERROR_INFO
)

3692 
dd
->
”r_šfo_uncÜ»ùabË
 &ð~
OPA_EI_STATUS_SMASK
;

3695 ià(
”rÜ_šfo_£Ëù
 & 
ES_FM_CONFIG_ERROR_INFO
)

3697 
dd
->
”r_šfo_fmcÚfig
 &ð~
OPA_EI_STATUS_SMASK
;

3699 ià(
»¥_Ën
)

3700 *
»¥_Ën
 +ð(*
»q
);

3702  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

3703 
	}
}

3705 
	sÝa_cÚge¡iÚ_šfo_©Œ
 {

3706 
__be16
 
	mcÚge¡iÚ_šfo
;

3707 
u8
 
	mcÚŒÞ_bË_ÿp
;

3708 
u8
 
	mcÚge¡iÚ_log_Ëngth
;

3709 } 
	g__·cked
;

3711 
	$__subn_g‘_Ýa_cÚg_šfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

3712 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

3713 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3715 
Ýa_cÚge¡iÚ_šfo_©Œ
 *
p
 =

3716 (
Ýa_cÚge¡iÚ_šfo_©Œ
 *)
d©a
;

3717 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3718 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3720 ià(
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

3721 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3722  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3725 
p
->
cÚge¡iÚ_šfo
 = 0;

3726 
p
->
cÚŒÞ_bË_ÿp
 = 
µd
->
cc_max_bË_’Œ›s
;

3727 
p
->
cÚge¡iÚ_log_Ëngth
 = 
OPA_CONG_LOG_ELEMS
;

3729 ià(
»¥_Ën
)

3730 *
»¥_Ën
 +ð(*
p
);

3732  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3733 
	}
}

3735 
	$__subn_g‘_Ýa_cÚg_£‰šg
(
Ýa_smp
 *
smp
, 
u32
 
am
,

3736 
u8
 *
d©a
, 
ib_deviû
 *
ibdev
,

3737 
u8
 
pÜt
, 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3739 
i
;

3740 
Ýa_cÚge¡iÚ_£‰šg_©Œ
 *
p
 =

3741 (
Ýa_cÚge¡iÚ_£‰šg_©Œ
 *)
d©a
;

3742 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3743 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3744 
Ýa_cÚge¡iÚ_£‰šg_’Œy_shadow
 *
’Œ›s
;

3745 
cc_¡©e
 *cc_state;

3747 ià(
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

3748 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3749  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3752 
	`rcu_»ad_lock
();

3754 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

3756 ià(!
cc_¡©e
) {

3757 
	`rcu_»ad_uÆock
();

3758  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3761 
’Œ›s
 = 
cc_¡©e
->
cÚg_£‰šg
.entries;

3762 
p
->
pÜt_cÚŒÞ
 = 
	`ýu_to_be16
(
cc_¡©e
->
cÚg_£‰šg
.port_control);

3763 
p
->
cÚŒÞ_m­
 = 
	`ýu_to_be32
(
cc_¡©e
->
cÚg_£‰šg
.control_map);

3764 
i
 = 0; i < 
OPA_MAX_SLS
; i++) {

3765 
p
->
’Œ›s
[
i
].
cùi_šü—£
 =ƒntries[i].ccti_increase;

3766 
p
->
’Œ›s
[
i
].
cùi_tim”
 = 
	`ýu_to_be16
(entries[i].ccti_timer);

3767 
p
->
’Œ›s
[
i
].
Œigg”_th»shÞd
 =

3768 
’Œ›s
[
i
].
Œigg”_th»shÞd
;

3769 
p
->
’Œ›s
[
i
].
cùi_mš
 =ƒntries[i].ccti_min;

3772 
	`rcu_»ad_uÆock
();

3774 ià(
»¥_Ën
)

3775 *
»¥_Ën
 +ð(*
p
);

3777  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3778 
	}
}

3784 
	$­¶y_cc_¡©e
(
hfi1_µÜtd©a
 *
µd
)

3786 
cc_¡©e
 *
Þd_cc_¡©e
, *
Ãw_cc_¡©e
;

3788 
Ãw_cc_¡©e
 = 
	`kz®loc
((*Ãw_cc_¡©e), 
GFP_KERNEL
);

3789 ià(!
Ãw_cc_¡©e
)

3796 
	`¥š_lock
(&
µd
->
cc_¡©e_lock
);

3798 
Þd_cc_¡©e
 = 
	`g‘_cc_¡©e_´Ùeùed
(
µd
);

3799 ià(!
Þd_cc_¡©e
) {

3801 
	`¥š_uÆock
(&
µd
->
cc_¡©e_lock
);

3802 
	`kä“
(
Ãw_cc_¡©e
);

3806 *
Ãw_cc_¡©e
 = *
Þd_cc_¡©e
;

3808 ià(
µd
->
tÙ®_cù_’Œy
)

3809 
Ãw_cc_¡©e
->
cù
.
cùi_lim™
 = 
µd
->
tÙ®_cù_’Œy
 - 1;

3811 
Ãw_cc_¡©e
->
cù
.
cùi_lim™
 = 0;

3813 
	`memýy
(
Ãw_cc_¡©e
->
cù
.
’Œ›s
, 
µd
->
cùi_’Œ›s
,

3814 
µd
->
tÙ®_cù_’Œy
 * (
ib_cc_bË_’Œy
));

3816 
Ãw_cc_¡©e
->
cÚg_£‰šg
.
pÜt_cÚŒÞ
 = 
IB_CC_CCS_PC_SL_BASED
;

3817 
Ãw_cc_¡©e
->
cÚg_£‰šg
.
cÚŒÞ_m­
 = 
µd
->
cc_¦_cÚŒÞ_m­
;

3818 
	`memýy
(
Ãw_cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
, 
µd
->
cÚge¡iÚ_’Œ›s
,

3819 
OPA_MAX_SLS
 * (
Ýa_cÚge¡iÚ_£‰šg_’Œy
));

3821 
	`rcu_assign_poš‹r
(
µd
->
cc_¡©e
, 
Ãw_cc_¡©e
);

3823 
	`¥š_uÆock
(&
µd
->
cc_¡©e_lock
);

3825 
	`kä“_rcu
(
Þd_cc_¡©e
, 
rcu
);

3826 
	}
}

3828 
	$__subn_£t_Ýa_cÚg_£‰šg
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

3829 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

3830 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3832 
Ýa_cÚge¡iÚ_£‰šg_©Œ
 *
p
 =

3833 (
Ýa_cÚge¡iÚ_£‰šg_©Œ
 *)
d©a
;

3834 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3835 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3836 
Ýa_cÚge¡iÚ_£‰šg_’Œy_shadow
 *
’Œ›s
;

3837 
i
;

3839 ià(
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

3840 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3841  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3848 
	`¥š_lock
(&
µd
->
cc_¡©e_lock
);

3849 
µd
->
cc_¦_cÚŒÞ_m­
 = 
	`be32_to_ýu
(
p
->
cÚŒÞ_m­
);

3851 
’Œ›s
 = 
µd
->
cÚge¡iÚ_’Œ›s
;

3852 
i
 = 0; i < 
OPA_MAX_SLS
; i++) {

3853 
’Œ›s
[
i
].
cùi_šü—£
 = 
p
->entries[i].ccti_increase;

3854 
’Œ›s
[
i
].
cùi_tim”
 = 
	`be16_to_ýu
(
p
->entries[i].ccti_timer);

3855 
’Œ›s
[
i
].
Œigg”_th»shÞd
 =

3856 
p
->
’Œ›s
[
i
].
Œigg”_th»shÞd
;

3857 
’Œ›s
[
i
].
cùi_mš
 = 
p
->entries[i].ccti_min;

3859 
	`¥š_uÆock
(&
µd
->
cc_¡©e_lock
);

3862 
	`­¶y_cc_¡©e
(
µd
);

3864  
	`__subn_g‘_Ýa_cÚg_£‰šg
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

3865 
»¥_Ën
, 
max_Ën
);

3866 
	}
}

3868 
	$__subn_g‘_Ýa_hfi1_cÚg_log
(
Ýa_smp
 *
smp
, 
u32
 
am
,

3869 
u8
 *
d©a
, 
ib_deviû
 *
ibdev
,

3870 
u8
 
pÜt
, 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3872 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3873 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3874 
Ýa_hfi1_cÚg_log
 *
cÚg_log
 = (Ýa_hfi1_cÚg_log *)
d©a
;

3875 
u64
 
ts
;

3876 
i
;

3878 ià(
am
 || 
	`smp_Ëngth_check
((*
cÚg_log
), 
max_Ën
)) {

3879 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3880  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3883 
	`¥š_lock_œq
(&
µd
->
cc_log_lock
);

3885 
cÚg_log
->
log_ty³
 = 
OPA_CC_LOG_TYPE_HFI
;

3886 
cÚg_log
->
cÚge¡iÚ_æags
 = 0;

3887 
cÚg_log
->
th»shÞd_ev’t_couÁ”
 =

3888 
	`ýu_to_be16
(
µd
->
th»shÞd_ev’t_couÁ”
);

3889 
	`memýy
(
cÚg_log
->
th»shÞd_cÚg_ev’t_m­
,

3890 
µd
->
th»shÞd_cÚg_ev’t_m­
,

3891 (
cÚg_log
->
th»shÞd_cÚg_ev’t_m­
));

3893 
ts
 = 
	`ktime_g‘_ns
() / 1024;

3894 
cÚg_log
->
cu¼’t_time_¡amp
 = 
	`ýu_to_be32
(
ts
);

3895 
i
 = 0; i < 
OPA_CONG_LOG_ELEMS
; i++) {

3896 
Ýa_hfi1_cÚg_log_ev’t_š‹º®
 *
cû
 =

3897 &
µd
->
cc_ev’ts
[µd->
cc_mad_idx
++];

3898 ià(
µd
->
cc_mad_idx
 =ð
OPA_CONG_LOG_ELEMS
)

3899 
µd
->
cc_mad_idx
 = 0;

3905 ià((
ts
 - 
cû
->
time¡amp
è/ 2 > 
U32_MAX
)

3907 
	`memýy
(
cÚg_log
->
ev’ts
[
i
].
loÿl_qp_ú_’Œy
, &
cû
->
lq²
, 3);

3908 
	`memýy
(
cÚg_log
->
ev’ts
[
i
].
»mÙe_qp_numb”_ú_’Œy
,

3909 &
cû
->
rq²
, 3);

3910 
cÚg_log
->
ev’ts
[
i
].
¦_svc_ty³_ú_’Œy
 =

3911 ((
cû
->
¦
 & 0x1fè<< 3è| (cû->
svc_ty³
 & 0x7);

3912 
cÚg_log
->
ev’ts
[
i
].
»mÙe_lid_ú_’Œy
 =

3913 
	`ýu_to_be32
(
cû
->
¾id
);

3914 
cÚg_log
->
ev’ts
[
i
].
time¡amp_ú_’Œy
 =

3915 
	`ýu_to_be32
(
cû
->
time¡amp
);

3922 
	`mem£t
(
µd
->
th»shÞd_cÚg_ev’t_m­
, 0x0,

3923 (
µd
->
th»shÞd_cÚg_ev’t_m­
));

3924 
µd
->
th»shÞd_ev’t_couÁ”
 = 0;

3926 
	`¥š_uÆock_œq
(&
µd
->
cc_log_lock
);

3928 ià(
»¥_Ën
)

3929 *
»¥_Ën
 +ð(
Ýa_hfi1_cÚg_log
);

3931  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3932 
	}
}

3934 
	$__subn_g‘_Ýa_cc_bË
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

3935 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

3936 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3938 
ib_cc_bË_©Œ
 *
cc_bË_©Œ
 =

3939 (
ib_cc_bË_©Œ
 *)
d©a
;

3940 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3941 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3942 
u32
 
¡¬t_block
 = 
	`OPA_AM_START_BLK
(
am
);

3943 
u32
 
n_blocks
 = 
	`OPA_AM_NBLK
(
am
);

3944 
ib_cc_bË_’Œy_shadow
 *
’Œ›s
;

3945 
i
, 
j
;

3946 
u32
 
£Áry
, 
“Áry
;

3947 
cc_¡©e
 *cc_state;

3948 
u32
 
size
 = (
u16
è* (
IB_CCT_ENTRIES
 * 
n_blocks
 + 1);

3951 ià(
n_blocks
 =ð0 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
) ||

3952 
¡¬t_block
 + 
n_blocks
 > 
µd
->
cc_max_bË_’Œ›s
) {

3953 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

3954  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3957 
	`rcu_»ad_lock
();

3959 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

3961 ià(!
cc_¡©e
) {

3962 
	`rcu_»ad_uÆock
();

3963  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3966 
£Áry
 = 
¡¬t_block
 * 
IB_CCT_ENTRIES
;

3967 
“Áry
 = 
£Áry
 + (
IB_CCT_ENTRIES
 * 
n_blocks
);

3969 
cc_bË_©Œ
->
cùi_lim™
 = 
	`ýu_to_be16
(
cc_¡©e
->
cù
.ccti_limit);

3971 
’Œ›s
 = 
cc_¡©e
->
cù
.entries;

3974 
j
 = 0, 
i
 = 
£Áry
; i < 
“Áry
; j++, i++)

3975 
cc_bË_©Œ
->
cùi_’Œ›s
[
j
].
’Œy
 =

3976 
	`ýu_to_be16
(
’Œ›s
[
i
].
’Œy
);

3978 
	`rcu_»ad_uÆock
();

3980 ià(
»¥_Ën
)

3981 *
»¥_Ën
 +ð
size
;

3983  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

3984 
	}
}

3986 
	$__subn_£t_Ýa_cc_bË
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

3987 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

3988 
u32
 *
»¥_Ën
, u32 
max_Ën
)

3990 
ib_cc_bË_©Œ
 *
p
 = (ib_cc_bË_©Œ *)
d©a
;

3991 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

3992 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

3993 
u32
 
¡¬t_block
 = 
	`OPA_AM_START_BLK
(
am
);

3994 
u32
 
n_blocks
 = 
	`OPA_AM_NBLK
(
am
);

3995 
ib_cc_bË_’Œy_shadow
 *
’Œ›s
;

3996 
i
, 
j
;

3997 
u32
 
£Áry
, 
“Áry
;

3998 
u16
 
cùi_lim™
;

3999 
u32
 
size
 = (
u16
è* (
IB_CCT_ENTRIES
 * 
n_blocks
 + 1);

4002 ià(
n_blocks
 =ð0 || 
	`smp_Ëngth_check
(
size
, 
max_Ën
) ||

4003 
¡¬t_block
 + 
n_blocks
 > 
µd
->
cc_max_bË_’Œ›s
) {

4004 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4005  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4008 
£Áry
 = 
¡¬t_block
 * 
IB_CCT_ENTRIES
;

4009 
“Áry
 = 
£Áry
 + ((
n_blocks
 - 1è* 
IB_CCT_ENTRIES
) +

4010 (
	`be16_to_ýu
(
p
->
cùi_lim™
)è% 
IB_CCT_ENTRIES
 + 1;

4013 
cùi_lim™
 = 
	`be16_to_ýu
(
p
->ccti_limit);

4014 ià(
cùi_lim™
 + 1 > 
“Áry
) {

4015 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4016  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4023 
	`¥š_lock
(&
µd
->
cc_¡©e_lock
);

4024 
µd
->
tÙ®_cù_’Œy
 = 
cùi_lim™
 + 1;

4025 
’Œ›s
 = 
µd
->
cùi_’Œ›s
;

4026 
j
 = 0, 
i
 = 
£Áry
; i < 
“Áry
; j++, i++)

4027 
’Œ›s
[
i
].
’Œy
 = 
	`be16_to_ýu
(
p
->
cùi_’Œ›s
[
j
].entry);

4028 
	`¥š_uÆock
(&
µd
->
cc_¡©e_lock
);

4031 
	`­¶y_cc_¡©e
(
µd
);

4033  
	`__subn_g‘_Ýa_cc_bË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

4034 
max_Ën
);

4035 
	}
}

4037 
	sÝa_Ëd_šfo
 {

4038 
__be32
 
	mrsvd_Ëd_mask
;

4039 
__be32
 
	mrsvd
;

4042 
	#OPA_LED_SHIFT
 31

	)

4043 
	#OPA_LED_MASK
 
	`BIT
(
OPA_LED_SHIFT
)

	)

4045 
	$__subn_g‘_Ýa_Ëd_šfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

4046 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4047 
u32
 *
»¥_Ën
, u32 
max_Ën
)

4049 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

4050 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

4051 
Ýa_Ëd_šfo
 *
p
 = (Ýa_Ëd_šfØ*)
d©a
;

4052 
u32
 
ÅÜt
 = 
	`OPA_AM_NPORT
(
am
);

4053 
u32
 
is_b—cÚšg_aùive
;

4055 ià(
ÅÜt
 !ð1 || 
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

4056 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4057  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4065 
	`smp_rmb
();

4066 
is_b—cÚšg_aùive
 = !!
	`©omic_»ad
(&
µd
->
Ëd_ov”ride_tim”_aùive
);

4067 
p
->
rsvd_Ëd_mask
 = 
	`ýu_to_be32
(
is_b—cÚšg_aùive
 << 
OPA_LED_SHIFT
);

4069 ià(
»¥_Ën
)

4070 *
»¥_Ën
 +ð(
Ýa_Ëd_šfo
);

4072  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4073 
	}
}

4075 
	$__subn_£t_Ýa_Ëd_šfo
(
Ýa_smp
 *
smp
, 
u32
 
am
, 
u8
 *
d©a
,

4076 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4077 
u32
 *
»¥_Ën
, u32 
max_Ën
)

4079 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

4080 
Ýa_Ëd_šfo
 *
p
 = (Ýa_Ëd_šfØ*)
d©a
;

4081 
u32
 
ÅÜt
 = 
	`OPA_AM_NPORT
(
am
);

4082 
Ú
 = !!(
	`be32_to_ýu
(
p
->
rsvd_Ëd_mask
è& 
OPA_LED_MASK
);

4084 ià(
ÅÜt
 !ð1 || 
	`smp_Ëngth_check
((*
p
), 
max_Ën
)) {

4085 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4086  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4089 ià(
Ú
)

4090 
	`hfi1_¡¬t_Ëd_ov”ride
(
dd
->
µÜt
, 2000, 1500);

4092 
	`shutdown_Ëd_ov”ride
(
dd
->
µÜt
);

4094  
	`__subn_g‘_Ýa_Ëd_šfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
, 
»¥_Ën
,

4095 
max_Ën
);

4096 
	}
}

4098 
	$subn_g‘_Ýa_sma
(
__be16
 
©Œ_id
, 
Ýa_smp
 *
smp
, 
u32
 
am
,

4099 
u8
 *
d©a
, 
ib_deviû
 *
ibdev
, u8 
pÜt
,

4100 
u32
 *
»¥_Ën
, u32 
max_Ën
)

4102 
»t
;

4103 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

4105 
©Œ_id
) {

4106 
IB_SMP_ATTR_NODE_DESC
:

4107 
»t
 = 
	`__subn_g‘_Ýa_nodedesc
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4108 
»¥_Ën
, 
max_Ën
);

4110 
IB_SMP_ATTR_NODE_INFO
:

4111 
»t
 = 
	`__subn_g‘_Ýa_nodešfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4112 
»¥_Ën
, 
max_Ën
);

4114 
IB_SMP_ATTR_PORT_INFO
:

4115 
»t
 = 
	`__subn_g‘_Ýa_pÜtšfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4116 
»¥_Ën
, 
max_Ën
);

4118 
IB_SMP_ATTR_PKEY_TABLE
:

4119 
»t
 = 
	`__subn_g‘_Ýa_pkeybË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4120 
»¥_Ën
, 
max_Ën
);

4122 
OPA_ATTRIB_ID_SL_TO_SC_MAP
:

4123 
»t
 = 
	`__subn_g‘_Ýa_¦_to_sc
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4124 
»¥_Ën
, 
max_Ën
);

4126 
OPA_ATTRIB_ID_SC_TO_SL_MAP
:

4127 
»t
 = 
	`__subn_g‘_Ýa_sc_to_¦
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4128 
»¥_Ën
, 
max_Ën
);

4130 
OPA_ATTRIB_ID_SC_TO_VLT_MAP
:

4131 
»t
 = 
	`__subn_g‘_Ýa_sc_to_vÉ
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4132 
»¥_Ën
, 
max_Ën
);

4134 
OPA_ATTRIB_ID_SC_TO_VLNT_MAP
:

4135 
»t
 = 
	`__subn_g‘_Ýa_sc_to_vÊt
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4136 
»¥_Ën
, 
max_Ën
);

4138 
OPA_ATTRIB_ID_PORT_STATE_INFO
:

4139 
»t
 = 
	`__subn_g‘_Ýa_psi
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4140 
»¥_Ën
, 
max_Ën
);

4142 
OPA_ATTRIB_ID_BUFFER_CONTROL_TABLE
:

4143 
»t
 = 
	`__subn_g‘_Ýa_bù
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4144 
»¥_Ën
, 
max_Ën
);

4146 
OPA_ATTRIB_ID_CABLE_INFO
:

4147 
»t
 = 
	`__subn_g‘_Ýa_ÿbË_šfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4148 
»¥_Ën
, 
max_Ën
);

4150 
IB_SMP_ATTR_VL_ARB_TABLE
:

4151 
»t
 = 
	`__subn_g‘_Ýa_vl_¬b
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4152 
»¥_Ën
, 
max_Ën
);

4154 
OPA_ATTRIB_ID_CONGESTION_INFO
:

4155 
»t
 = 
	`__subn_g‘_Ýa_cÚg_šfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4156 
»¥_Ën
, 
max_Ën
);

4158 
OPA_ATTRIB_ID_HFI_CONGESTION_SETTING
:

4159 
»t
 = 
	`__subn_g‘_Ýa_cÚg_£‰šg
(
smp
, 
am
, 
d©a
, 
ibdev
,

4160 
pÜt
, 
»¥_Ën
, 
max_Ën
);

4162 
OPA_ATTRIB_ID_HFI_CONGESTION_LOG
:

4163 
»t
 = 
	`__subn_g‘_Ýa_hfi1_cÚg_log
(
smp
, 
am
, 
d©a
, 
ibdev
,

4164 
pÜt
, 
»¥_Ën
, 
max_Ën
);

4166 
OPA_ATTRIB_ID_CONGESTION_CONTROL_TABLE
:

4167 
»t
 = 
	`__subn_g‘_Ýa_cc_bË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4168 
»¥_Ën
, 
max_Ën
);

4170 
IB_SMP_ATTR_LED_INFO
:

4171 
»t
 = 
	`__subn_g‘_Ýa_Ëd_šfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4172 
»¥_Ën
, 
max_Ën
);

4174 
IB_SMP_ATTR_SM_INFO
:

4175 ià(
ibp
->
rvp
.
pÜt_ÿp_æags
 & 
IB_PORT_SM_DISABLED
)

4176  
IB_MAD_RESULT_SUCCESS
 | 
IB_MAD_RESULT_CONSUMED
;

4177 ià(
ibp
->
rvp
.
pÜt_ÿp_æags
 & 
IB_PORT_SM
)

4178  
IB_MAD_RESULT_SUCCESS
;

4181 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4182 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4185  
»t
;

4186 
	}
}

4188 
	$subn_£t_Ýa_sma
(
__be16
 
©Œ_id
, 
Ýa_smp
 *
smp
, 
u32
 
am
,

4189 
u8
 *
d©a
, 
ib_deviû
 *
ibdev
, u8 
pÜt
,

4190 
u32
 *
»¥_Ën
, u32 
max_Ën
, 
loÿl_mad
)

4192 
»t
;

4193 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

4195 
©Œ_id
) {

4196 
IB_SMP_ATTR_PORT_INFO
:

4197 
»t
 = 
	`__subn_£t_Ýa_pÜtšfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4198 
»¥_Ën
, 
max_Ën
, 
loÿl_mad
);

4200 
IB_SMP_ATTR_PKEY_TABLE
:

4201 
»t
 = 
	`__subn_£t_Ýa_pkeybË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4202 
»¥_Ën
, 
max_Ën
);

4204 
OPA_ATTRIB_ID_SL_TO_SC_MAP
:

4205 
»t
 = 
	`__subn_£t_Ýa_¦_to_sc
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4206 
»¥_Ën
, 
max_Ën
);

4208 
OPA_ATTRIB_ID_SC_TO_SL_MAP
:

4209 
»t
 = 
	`__subn_£t_Ýa_sc_to_¦
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4210 
»¥_Ën
, 
max_Ën
);

4212 
OPA_ATTRIB_ID_SC_TO_VLT_MAP
:

4213 
»t
 = 
	`__subn_£t_Ýa_sc_to_vÉ
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4214 
»¥_Ën
, 
max_Ën
);

4216 
OPA_ATTRIB_ID_SC_TO_VLNT_MAP
:

4217 
»t
 = 
	`__subn_£t_Ýa_sc_to_vÊt
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4218 
»¥_Ën
, 
max_Ën
);

4220 
OPA_ATTRIB_ID_PORT_STATE_INFO
:

4221 
»t
 = 
	`__subn_£t_Ýa_psi
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4222 
»¥_Ën
, 
max_Ën
, 
loÿl_mad
);

4224 
OPA_ATTRIB_ID_BUFFER_CONTROL_TABLE
:

4225 
»t
 = 
	`__subn_£t_Ýa_bù
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4226 
»¥_Ën
, 
max_Ën
);

4228 
IB_SMP_ATTR_VL_ARB_TABLE
:

4229 
»t
 = 
	`__subn_£t_Ýa_vl_¬b
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4230 
»¥_Ën
, 
max_Ën
);

4232 
OPA_ATTRIB_ID_HFI_CONGESTION_SETTING
:

4233 
»t
 = 
	`__subn_£t_Ýa_cÚg_£‰šg
(
smp
, 
am
, 
d©a
, 
ibdev
,

4234 
pÜt
, 
»¥_Ën
, 
max_Ën
);

4236 
OPA_ATTRIB_ID_CONGESTION_CONTROL_TABLE
:

4237 
»t
 = 
	`__subn_£t_Ýa_cc_bË
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4238 
»¥_Ën
, 
max_Ën
);

4240 
IB_SMP_ATTR_LED_INFO
:

4241 
»t
 = 
	`__subn_£t_Ýa_Ëd_šfo
(
smp
, 
am
, 
d©a
, 
ibdev
, 
pÜt
,

4242 
»¥_Ën
, 
max_Ën
);

4244 
IB_SMP_ATTR_SM_INFO
:

4245 ià(
ibp
->
rvp
.
pÜt_ÿp_æags
 & 
IB_PORT_SM_DISABLED
)

4246  
IB_MAD_RESULT_SUCCESS
 | 
IB_MAD_RESULT_CONSUMED
;

4247 ià(
ibp
->
rvp
.
pÜt_ÿp_æags
 & 
IB_PORT_SM
)

4248  
IB_MAD_RESULT_SUCCESS
;

4251 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4252 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4255  
»t
;

4256 
	}
}

4258 
šlše
 
	$£t_aggr_”rÜ
(
Ýa_agg»g©e
 *
ag
)

4260 
ag
->
”r_»qËngth
 |ð
	`ýu_to_be16
(0x8000);

4261 
	}
}

4263 
	$subn_g‘_Ýa_agg»g©e
(
Ýa_smp
 *
smp
,

4264 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4265 
u32
 *
»¥_Ën
)

4267 
i
;

4268 
u32
 
num_©Œ
 = 
	`be32_to_ýu
(
smp
->
©Œ_mod
) & 0x000000ff;

4269 
u8
 *
Ãxt_smp
 = 
	`Ýa_g‘_smp_d©a
(
smp
);

4271 ià(
num_©Œ
 < 1 ||‚um_attr > 117) {

4272 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4273  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4276 
i
 = 0; i < 
num_©Œ
; i++) {

4277 
Ýa_agg»g©e
 *
agg
;

4278 
size_t
 
agg_d©a_Ën
;

4279 
size_t
 
agg_size
;

4280 
u32
 
am
;

4282 
agg
 = (
Ýa_agg»g©e
 *)
Ãxt_smp
;

4283 
agg_d©a_Ën
 = (
	`be16_to_ýu
(
agg
->
”r_»qËngth
) & 0x007f) * 8;

4284 
agg_size
 = (*
agg
è+ 
agg_d©a_Ën
;

4285 
am
 = 
	`be32_to_ýu
(
agg
->
©Œ_mod
);

4287 *
»¥_Ën
 +ð
agg_size
;

4289 ià(
Ãxt_smp
 + 
agg_size
 > ((
u8
 *)
smp
) + (*smp)) {

4290 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4291  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4295 
	`mem£t
(
Ãxt_smp
 + (*
agg
), 0, 
agg_d©a_Ën
);

4297 ()
	`subn_g‘_Ýa_sma
(
agg
->
©Œ_id
, 
smp
, 
am
,‡gg->
d©a
,

4298 
ibdev
, 
pÜt
, 
NULL
, (
u32
)
agg_d©a_Ën
);

4300 ià(
smp
->
¡©us
 & 
IB_SMP_INVALID_FIELD
)

4302 ià(
smp
->
¡©us
 & ~
IB_SMP_DIRECTION
) {

4303 
	`£t_aggr_”rÜ
(
agg
);

4304  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4306 
Ãxt_smp
 +ð
agg_size
;

4309  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4310 
	}
}

4312 
	$subn_£t_Ýa_agg»g©e
(
Ýa_smp
 *
smp
,

4313 
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4314 
u32
 *
»¥_Ën
, 
loÿl_mad
)

4316 
i
;

4317 
u32
 
num_©Œ
 = 
	`be32_to_ýu
(
smp
->
©Œ_mod
) & 0x000000ff;

4318 
u8
 *
Ãxt_smp
 = 
	`Ýa_g‘_smp_d©a
(
smp
);

4320 ià(
num_©Œ
 < 1 ||‚um_attr > 117) {

4321 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4322  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4325 
i
 = 0; i < 
num_©Œ
; i++) {

4326 
Ýa_agg»g©e
 *
agg
;

4327 
size_t
 
agg_d©a_Ën
;

4328 
size_t
 
agg_size
;

4329 
u32
 
am
;

4331 
agg
 = (
Ýa_agg»g©e
 *)
Ãxt_smp
;

4332 
agg_d©a_Ën
 = (
	`be16_to_ýu
(
agg
->
”r_»qËngth
) & 0x007f) * 8;

4333 
agg_size
 = (*
agg
è+ 
agg_d©a_Ën
;

4334 
am
 = 
	`be32_to_ýu
(
agg
->
©Œ_mod
);

4336 *
»¥_Ën
 +ð
agg_size
;

4338 ià(
Ãxt_smp
 + 
agg_size
 > ((
u8
 *)
smp
) + (*smp)) {

4339 
smp
->
¡©us
 |ð
IB_SMP_INVALID_FIELD
;

4340  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4343 ()
	`subn_£t_Ýa_sma
(
agg
->
©Œ_id
, 
smp
, 
am
,‡gg->
d©a
,

4344 
ibdev
, 
pÜt
, 
NULL
, (
u32
)
agg_d©a_Ën
,

4345 
loÿl_mad
);

4347 ià(
smp
->
¡©us
 & 
IB_SMP_INVALID_FIELD
)

4349 ià(
smp
->
¡©us
 & ~
IB_SMP_DIRECTION
) {

4350 
	`£t_aggr_”rÜ
(
agg
);

4351  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4353 
Ãxt_smp
 +ð
agg_size
;

4356  
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4357 
	}
}

4370 
	$þ—r_lškup_couÁ”s
(
hfi1_devd©a
 *
dd
)

4373 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RCV_ERR
, 
CNTR_INVALID_VL
, 0);

4374 
dd
->
”r_šfo_rcvpÜt
.
¡©us_ªd_code
 &ð~
OPA_EI_STATUS_SMASK
;

4376 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_SEQ_CRC_CNT
, 
CNTR_INVALID_VL
, 0);

4377 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_REINIT_FROM_PEER_CNT
, 
CNTR_INVALID_VL
, 0);

4379 
	`wr™e_dev_úŒ
(
dd
, 
C_DC_RX_REPLAY
, 
CNTR_INVALID_VL
, 0);

4381 
	`wr™e_dev_úŒ
(
dd
, 
C_RCV_OVF
, 
CNTR_INVALID_VL
, 0);

4382 
dd
->
rcv_ovæ_út
 = 0;

4383 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¡©us
 &ð~
OPA_EI_STATUS_SMASK
;

4384 
	}
}

4386 
	$is_fuÎ_mgmt_pkey_š_bË
(
hfi1_ibpÜt
 *
ibp
)

4388 
i
;

4389 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

4391 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); ++i)

4392 ià(
µd
->
pkeys
[
i
] =ð
FULL_MGMT_P_KEY
)

4396 
	}
}

4402 
	$is_loÿl_mad
(
hfi1_ibpÜt
 *
ibp
, cÚ¡ 
Ýa_mad
 *
mad
,

4403 cÚ¡ 
ib_wc
 *
š_wc
)

4405 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

4406 cÚ¡ 
Ýa_smp
 *
smp
 = (cÚ¡ Ýa_sm°*)
mad
;

4408 ià(
smp
->
mgmt_þass
 =ð
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
) {

4409  (
smp
->
hÝ_út
 == 0 &&

4410 
smp
->
rou‹
.
dr
.
dr_¦id
 =ð
OPA_LID_PERMISSIVE
 &&

4411 
smp
->
rou‹
.
dr
.
dr_dlid
 =ð
OPA_LID_PERMISSIVE
);

4414  (
š_wc
->
¦id
 =ð
µd
->
lid
);

4415 
	}
}

4427 
	$Ýa_loÿl_smp_check
(
hfi1_ibpÜt
 *
ibp
,

4428 cÚ¡ 
ib_wc
 *
š_wc
)

4430 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

4431 
u16
 
pkey
;

4433 ià(
š_wc
->
pkey_šdex
 >ð
	`ARRAY_SIZE
(
µd
->
pkeys
))

4436 
pkey
 = 
µd
->
pkeys
[
š_wc
->
pkey_šdex
];

4455 ià(
pkey
 =ð
LIM_MGMT_P_KEY
 ||…key =ð
FULL_MGMT_P_KEY
)

4457 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
š_wc
->
¦id
);

4459 
	}
}

4498 
	$hfi1_pkey_v®id©iÚ_pma
(
hfi1_ibpÜt
 *
ibp
,

4499 cÚ¡ 
Ýa_mad
 *
š_mad
,

4500 cÚ¡ 
ib_wc
 *
š_wc
)

4502 
u16
 
pkey_v®ue
 = 
	`hfi1_lookup_pkey_v®ue
(
ibp
, 
š_wc
->
pkey_šdex
);

4505 ià(!
	`is_loÿl_mad
(
ibp
, 
š_mad
, 
š_wc
) &&

4506 
pkey_v®ue
 !ð
LIM_MGMT_P_KEY
 &&

4507 
pkey_v®ue
 !ð
FULL_MGMT_P_KEY
)

4508  -
EINVAL
;

4511 ià(
pkey_v®ue
 =ð
LIM_MGMT_P_KEY
 &&

4512 
	`is_fuÎ_mgmt_pkey_š_bË
(
ibp
))

4513  -
EINVAL
;

4516 
	}
}

4518 
	$´oûss_subn_Ýa
(
ib_deviû
 *
ibdev
, 
mad_æags
,

4519 
u8
 
pÜt
, cÚ¡ 
Ýa_mad
 *
š_mad
,

4520 
Ýa_mad
 *
out_mad
,

4521 
u32
 *
»¥_Ën
, 
loÿl_mad
)

4523 
Ýa_smp
 *
smp
 = (Ýa_sm°*)
out_mad
;

4524 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

4525 
u8
 *
d©a
;

4526 
u32
 
am
, 
d©a_size
;

4527 
__be16
 
©Œ_id
;

4528 
»t
;

4530 *
out_mad
 = *
š_mad
;

4531 
d©a
 = 
	`Ýa_g‘_smp_d©a
(
smp
);

4532 
d©a_size
 = (
u32
)
	`Ýa_g‘_smp_d©a_size
(
smp
);

4534 
am
 = 
	`be32_to_ýu
(
smp
->
©Œ_mod
);

4535 
©Œ_id
 = 
smp
->attr_id;

4536 ià(
smp
->
þass_v”siÚ
 !ð
OPA_SM_CLASS_VERSION
) {

4537 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_VERSION
;

4538 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4539  
»t
;

4541 
»t
 = 
	`check_mkey
(
ibp
, (
ib_mad_hdr
 *)
smp
, 
mad_æags
, smp->
mkey
,

4542 
smp
->
rou‹
.
dr
.
dr_¦id
, smp->rou‹.dr.
»tuº_·th
,

4543 
smp
->
hÝ_út
);

4544 ià(
»t
) {

4545 
u32
 
pÜt_num
 = 
	`be32_to_ýu
(
smp
->
©Œ_mod
);

4554 ià(
©Œ_id
 =ð
IB_SMP_ATTR_PORT_INFO
 &&

4555 (
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_GET
 ||

4556 
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_SET
) &&

4557 
pÜt_num
 &&…Üt_num <ð
ibdev
->
phys_pÜt_út
 &&

4558 
pÜt
 !ð
pÜt_num
)

4559 ()
	`check_mkey
(
	`to_Üt
(
ibdev
, 
pÜt_num
),

4560 (
ib_mad_hdr
 *)
smp
, 0,

4561 
smp
->
mkey
, smp->
rou‹
.
dr
.
dr_¦id
,

4562 
smp
->
rou‹
.
dr
.
»tuº_·th
,

4563 
smp
->
hÝ_út
);

4564 
»t
 = 
IB_MAD_RESULT_FAILURE
;

4565  
»t
;

4568 *
»¥_Ën
 = 
	`Ýa_g‘_smp_h—d”_size
(
smp
);

4570 
smp
->
m‘hod
) {

4571 
IB_MGMT_METHOD_GET
:

4572 
©Œ_id
) {

4574 
	`þ—r_Ýa_smp_d©a
(
smp
);

4575 
»t
 = 
	`subn_g‘_Ýa_sma
(
©Œ_id
, 
smp
, 
am
, 
d©a
,

4576 
ibdev
, 
pÜt
, 
»¥_Ën
,

4577 
d©a_size
);

4579 
OPA_ATTRIB_ID_AGGREGATE
:

4580 
»t
 = 
	`subn_g‘_Ýa_agg»g©e
(
smp
, 
ibdev
, 
pÜt
,

4581 
»¥_Ën
);

4585 
IB_MGMT_METHOD_SET
:

4586 
©Œ_id
) {

4588 
»t
 = 
	`subn_£t_Ýa_sma
(
©Œ_id
, 
smp
, 
am
, 
d©a
,

4589 
ibdev
, 
pÜt
, 
»¥_Ën
,

4590 
d©a_size
, 
loÿl_mad
);

4592 
OPA_ATTRIB_ID_AGGREGATE
:

4593 
»t
 = 
	`subn_£t_Ýa_agg»g©e
(
smp
, 
ibdev
, 
pÜt
,

4594 
»¥_Ën
, 
loÿl_mad
);

4598 
IB_MGMT_METHOD_TRAP
:

4599 
IB_MGMT_METHOD_REPORT
:

4600 
IB_MGMT_METHOD_REPORT_RESP
:

4601 
IB_MGMT_METHOD_GET_RESP
:

4607 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4609 
IB_MGMT_METHOD_TRAP_REPRESS
:

4610 
	`subn_hªdË_Ýa_Œ­_»´ess
(
ibp
, 
smp
);

4612 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4615 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METHOD
;

4616 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4620  
»t
;

4621 
	}
}

4623 
	$´oûss_subn
(
ib_deviû
 *
ibdev
, 
mad_æags
,

4624 
u8
 
pÜt
, cÚ¡ 
ib_mad
 *
š_mad
,

4625 
ib_mad
 *
out_mad
)

4627 
ib_smp
 *
smp
 = (ib_sm°*)
out_mad
;

4628 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

4629 
»t
;

4631 *
out_mad
 = *
š_mad
;

4632 ià(
smp
->
þass_v”siÚ
 != 1) {

4633 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_VERSION
;

4634 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4635  
»t
;

4638 
»t
 = 
	`check_mkey
(
ibp
, (
ib_mad_hdr
 *)
smp
, 
mad_æags
,

4639 
smp
->
mkey
, (
__fÜû
 
__be32
)smp->
dr_¦id
,

4640 
smp
->
»tuº_·th
, smp->
hÝ_út
);

4641 ià(
»t
) {

4642 
u32
 
pÜt_num
 = 
	`be32_to_ýu
(
smp
->
©Œ_mod
);

4651 ià(
š_mad
->
mad_hdr
.
©Œ_id
 =ð
IB_SMP_ATTR_PORT_INFO
 &&

4652 (
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_GET
 ||

4653 
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_SET
) &&

4654 
pÜt_num
 &&…Üt_num <ð
ibdev
->
phys_pÜt_út
 &&

4655 
pÜt
 !ð
pÜt_num
)

4656 ()
	`check_mkey
(
	`to_Üt
(
ibdev
, 
pÜt_num
),

4657 (
ib_mad_hdr
 *)
smp
, 0,

4658 
smp
->
mkey
,

4659 (
__fÜû
 
__be32
)
smp
->
dr_¦id
,

4660 
smp
->
»tuº_·th
, smp->
hÝ_út
);

4661 
»t
 = 
IB_MAD_RESULT_FAILURE
;

4662  
»t
;

4665 
smp
->
m‘hod
) {

4666 
IB_MGMT_METHOD_GET
:

4667 
smp
->
©Œ_id
) {

4668 
IB_SMP_ATTR_NODE_INFO
:

4669 
»t
 = 
	`subn_g‘_nodešfo
(
smp
, 
ibdev
, 
pÜt
);

4672 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4673 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
smp
);

4679  
»t
;

4680 
	}
}

4682 
	$´oûss_³rf
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4683 cÚ¡ 
ib_mad
 *
š_mad
,

4684 
ib_mad
 *
out_mad
)

4686 
ib_pma_mad
 *
pmp
 = (ib_pma_mad *)
out_mad
;

4687 
ib_þass_pÜt_šfo
 *
ýi
 = (ib_class_port_info *)

4688 &
pmp
->
d©a
;

4689 
»t
 = 
IB_MAD_RESULT_FAILURE
;

4691 *
out_mad
 = *
š_mad
;

4692 ià(
pmp
->
mad_hdr
.
þass_v”siÚ
 != 1) {

4693 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_VERSION
;

4694 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4695  
»t
;

4698 
pmp
->
mad_hdr
.
m‘hod
) {

4699 
IB_MGMT_METHOD_GET
:

4700 
pmp
->
mad_hdr
.
©Œ_id
) {

4701 
IB_PMA_PORT_COUNTERS
:

4702 
»t
 = 
	`pma_g‘_ib_pÜtcouÁ”s
(
pmp
, 
ibdev
, 
pÜt
);

4704 
IB_PMA_PORT_COUNTERS_EXT
:

4705 
»t
 = 
	`pma_g‘_ib_pÜtcouÁ”s_ext
(
pmp
, 
ibdev
, 
pÜt
);

4707 
IB_PMA_CLASS_PORT_INFO
:

4708 
ýi
->
ÿ·bž™y_mask
 = 
IB_PMA_CLASS_CAP_EXT_WIDTH
;

4709 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4712 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4713 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4718 
IB_MGMT_METHOD_SET
:

4719 ià(
pmp
->
mad_hdr
.
©Œ_id
) {

4720 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4721 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4725 
IB_MGMT_METHOD_TRAP
:

4726 
IB_MGMT_METHOD_GET_RESP
:

4732 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4736 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METHOD
;

4737 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4741  
»t
;

4742 
	}
}

4744 
	$´oûss_³rf_Ýa
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt
,

4745 cÚ¡ 
Ýa_mad
 *
š_mad
,

4746 
Ýa_mad
 *
out_mad
, 
u32
 *
»¥_Ën
)

4748 
Ýa_pma_mad
 *
pmp
 = (Ýa_pma_mad *)
out_mad
;

4749 
»t
;

4751 *
out_mad
 = *
š_mad
;

4753 ià(
pmp
->
mad_hdr
.
þass_v”siÚ
 !ð
OPA_SM_CLASS_VERSION
) {

4754 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_VERSION
;

4755  
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4758 *
»¥_Ën
 = (
pmp
->
mad_hdr
);

4760 
pmp
->
mad_hdr
.
m‘hod
) {

4761 
IB_MGMT_METHOD_GET
:

4762 
pmp
->
mad_hdr
.
©Œ_id
) {

4763 
IB_PMA_CLASS_PORT_INFO
:

4764 
»t
 = 
	`pma_g‘_Ýa_þas¥Ütšfo
(
pmp
, 
ibdev
, 
»¥_Ën
);

4766 
OPA_PM_ATTRIB_ID_PORT_STATUS
:

4767 
»t
 = 
	`pma_g‘_Ýa_pÜt¡©us
(
pmp
, 
ibdev
, 
pÜt
,

4768 
»¥_Ën
);

4770 
OPA_PM_ATTRIB_ID_DATA_PORT_COUNTERS
:

4771 
»t
 = 
	`pma_g‘_Ýa_d©acouÁ”s
(
pmp
, 
ibdev
, 
pÜt
,

4772 
»¥_Ën
);

4774 
OPA_PM_ATTRIB_ID_ERROR_PORT_COUNTERS
:

4775 
»t
 = 
	`pma_g‘_Ýa_pÜ‹¼Üs
(
pmp
, 
ibdev
, 
pÜt
,

4776 
»¥_Ën
);

4778 
OPA_PM_ATTRIB_ID_ERROR_INFO
:

4779 
»t
 = 
	`pma_g‘_Ýa_”rÜšfo
(
pmp
, 
ibdev
, 
pÜt
,

4780 
»¥_Ën
);

4783 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4784 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4789 
IB_MGMT_METHOD_SET
:

4790 
pmp
->
mad_hdr
.
©Œ_id
) {

4791 
OPA_PM_ATTRIB_ID_CLEAR_PORT_STATUS
:

4792 
»t
 = 
	`pma_£t_Ýa_pÜt¡©us
(
pmp
, 
ibdev
, 
pÜt
,

4793 
»¥_Ën
);

4795 
OPA_PM_ATTRIB_ID_ERROR_INFO
:

4796 
»t
 = 
	`pma_£t_Ýa_”rÜšfo
(
pmp
, 
ibdev
, 
pÜt
,

4797 
»¥_Ën
);

4800 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METH_ATTR
;

4801 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4806 
IB_MGMT_METHOD_TRAP
:

4807 
IB_MGMT_METHOD_GET_RESP
:

4813 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4817 
pmp
->
mad_hdr
.
¡©us
 |ð
IB_SMP_UNSUP_METHOD
;

4818 
»t
 = 
	`»¶y
((
ib_mad_hdr
 *)
pmp
);

4822  
»t
;

4823 
	}
}

4825 
	$hfi1_´oûss_Ýa_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
,

4826 
u8
 
pÜt
, cÚ¡ 
ib_wc
 *
š_wc
,

4827 cÚ¡ 
ib_grh
 *
š_grh
,

4828 cÚ¡ 
Ýa_mad
 *
š_mad
,

4829 
Ýa_mad
 *
out_mad
, 
size_t
 *
out_mad_size
,

4830 
u16
 *
out_mad_pkey_šdex
)

4832 
»t
;

4833 
pkey_idx
;

4834 
loÿl_mad
 = 0;

4835 
u32
 
»¥_Ën
 = 
š_wc
->
by‹_Ën
 - (*
š_grh
);

4836 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

4838 
pkey_idx
 = 
	`hfi1_lookup_pkey_idx
(
ibp
, 
LIM_MGMT_P_KEY
);

4839 ià(
pkey_idx
 < 0) {

4840 
	`´_w¬n
("failedo find†imited mgmt…key, defaulting 0x%x\n",

4841 
	`hfi1_g‘_pkey
(
ibp
, 1));

4842 
pkey_idx
 = 1;

4844 *
out_mad_pkey_šdex
 = (
u16
)
pkey_idx
;

4846 
š_mad
->
mad_hdr
.
mgmt_þass
) {

4847 
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
:

4848 
IB_MGMT_CLASS_SUBN_LID_ROUTED
:

4849 
loÿl_mad
 = 
	`is_loÿl_mad
(
ibp
, 
š_mad
, 
š_wc
);

4850 ià(
loÿl_mad
) {

4851 
»t
 = 
	`Ýa_loÿl_smp_check
(
ibp
, 
š_wc
);

4852 ià(
»t
)

4853  
IB_MAD_RESULT_FAILURE
;

4855 
»t
 = 
	`´oûss_subn_Ýa
(
ibdev
, 
mad_æags
, 
pÜt
, 
š_mad
,

4856 
out_mad
, &
»¥_Ën
, 
loÿl_mad
);

4857 
baž
;

4858 
IB_MGMT_CLASS_PERF_MGMT
:

4859 
»t
 = 
	`hfi1_pkey_v®id©iÚ_pma
(
ibp
, 
š_mad
, 
š_wc
);

4860 ià(
»t
)

4861  
IB_MAD_RESULT_FAILURE
;

4863 
»t
 = 
	`´oûss_³rf_Ýa
(
ibdev
, 
pÜt
, 
š_mad
, 
out_mad
, &
»¥_Ën
);

4864 
baž
;

4867 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4870 
baž
:

4871 ià(
»t
 & 
IB_MAD_RESULT_REPLY
)

4872 *
out_mad_size
 = 
	`round_up
(
»¥_Ën
, 8);

4873 ià(
»t
 & 
IB_MAD_RESULT_SUCCESS
)

4874 *
out_mad_size
 = 
š_wc
->
by‹_Ën
 - (
ib_grh
);

4876  
»t
;

4877 
	}
}

4879 
	$hfi1_´oûss_ib_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
, 
u8
 
pÜt
,

4880 cÚ¡ 
ib_wc
 *
š_wc
,

4881 cÚ¡ 
ib_grh
 *
š_grh
,

4882 cÚ¡ 
ib_mad
 *
š_mad
,

4883 
ib_mad
 *
out_mad
)

4885 
»t
;

4887 
š_mad
->
mad_hdr
.
mgmt_þass
) {

4888 
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
:

4889 
IB_MGMT_CLASS_SUBN_LID_ROUTED
:

4890 
»t
 = 
	`´oûss_subn
(
ibdev
, 
mad_æags
, 
pÜt
, 
š_mad
, 
out_mad
);

4892 
IB_MGMT_CLASS_PERF_MGMT
:

4893 
»t
 = 
	`´oûss_³rf
(
ibdev
, 
pÜt
, 
š_mad
, 
out_mad
);

4896 
»t
 = 
IB_MAD_RESULT_SUCCESS
;

4900  
»t
;

4901 
	}
}

4922 
	$hfi1_´oûss_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
, 
u8
 
pÜt
,

4923 cÚ¡ 
ib_wc
 *
š_wc
, cÚ¡ 
ib_grh
 *
š_grh
,

4924 cÚ¡ 
ib_mad
 *
š_mad
, ib_mad *
out_mad
,

4925 
size_t
 *
out_mad_size
, 
u16
 *
out_mad_pkey_šdex
)

4927 
š_mad
->
mad_hdr
.
ba£_v”siÚ
) {

4928 
OPA_MGMT_BASE_VERSION
:

4929  
	`hfi1_´oûss_Ýa_mad
(
ibdev
, 
mad_æags
, 
pÜt
,

4930 
š_wc
, 
š_grh
,

4931 (
Ýa_mad
 *)
š_mad
,

4932 (
Ýa_mad
 *)
out_mad
,

4933 
out_mad_size
,

4934 
out_mad_pkey_šdex
);

4935 
IB_MGMT_BASE_VERSION
:

4936  
	`hfi1_´oûss_ib_mad
(
ibdev
, 
mad_æags
, 
pÜt
, 
š_wc
,

4937 
š_grh
, 
š_mad
, 
out_mad
);

4942  
IB_MAD_RESULT_FAILURE
;

4943 
	}
}

4945 #iâdeà
HAVE_NEW_PROCESS_MAD_FUNCTION


4946 
	$com·t_hfi1_´oûss_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
, 
u8
 
pÜt
,

4947 cÚ¡ 
ib_wc
 *
š_wc
,

4948 cÚ¡ 
ib_grh
 *
š_grh
,

4949 cÚ¡ 
ib_mad_hdr
 *
š_mad
,

4950 
size_t
 
š_mad_size
, 
ib_mad_hdr
 *
out_mad
,

4951 
size_t
 *
out_mad_size
, 
u16
 *
out_mad_pkey_šdex
)

4953 ià(
š_mad
->
ba£_v”siÚ
 =ð
OPA_MGMT_BASE_VERSION
 &&

4954 
	`uÆik–y
(
š_mad_size
 !ð(
Ýa_mad
))) {

4955 
	`dev_”r
(
ibdev
->
dev
.
·»Á
, "invalid in_mad_size\n");

4956  
IB_MAD_RESULT_FAILURE
;

4959  
	`hfi1_´oûss_mad
(
ibdev
, 
mad_æags
, 
pÜt
, 
š_wc
, 
š_grh
,

4960 (cÚ¡ 
ib_mad
 *)
š_mad
,

4961 (
ib_mad
 *)
out_mad
, 
out_mad_size
,

4962 
out_mad_pkey_šdex
);

4963 
	}
}

	@mad.h

47 #iâdeà
_HFI1_MAD_H


48 
	#_HFI1_MAD_H


	)

50 
	~<rdma/ib_pma.h
>

51 
	~<rdma/Ýa_smi.h
>

52 
	~<rdma/Ýa_pÜt_šfo.h
>

53 
	~"Ýa_com·t.h
"

58 
	#OPA_TRAP_GID_NOW_IN_SERVICE
 
	`ýu_to_be16
(64)

	)

59 
	#OPA_TRAP_GID_OUT_OF_SERVICE
 
	`ýu_to_be16
(65)

	)

60 
	#OPA_TRAP_ADD_MULTICAST_GROUP
 
	`ýu_to_be16
(66)

	)

61 
	#OPA_TRAL_DEL_MULTICAST_GROUP
 
	`ýu_to_be16
(67)

	)

62 
	#OPA_TRAP_UNPATH
 
	`ýu_to_be16
(68)

	)

63 
	#OPA_TRAP_REPATH
 
	`ýu_to_be16
(69)

	)

64 
	#OPA_TRAP_PORT_CHANGE_STATE
 
	`ýu_to_be16
(128)

	)

65 
	#OPA_TRAP_LINK_INTEGRITY
 
	`ýu_to_be16
(129)

	)

66 
	#OPA_TRAP_EXCESSIVE_BUFFER_OVERRUN
 
	`ýu_to_be16
(130)

	)

67 
	#OPA_TRAP_FLOW_WATCHDOG
 
	`ýu_to_be16
(131)

	)

68 
	#OPA_TRAP_CHANGE_CAPABILITY
 
	`ýu_to_be16
(144)

	)

69 
	#OPA_TRAP_CHANGE_SYSGUID
 
	`ýu_to_be16
(145)

	)

70 
	#OPA_TRAP_BAD_M_KEY
 
	`ýu_to_be16
(256)

	)

71 
	#OPA_TRAP_BAD_P_KEY
 
	`ýu_to_be16
(257)

	)

72 
	#OPA_TRAP_BAD_Q_KEY
 
	`ýu_to_be16
(258)

	)

73 
	#OPA_TRAP_SWITCH_BAD_PKEY
 
	`ýu_to_be16
(259)

	)

74 
	#OPA_SMA_TRAP_DATA_LINK_WIDTH
 
	`ýu_to_be16
(2048)

	)

79 
	#OPA_NOTICE_TRAP_LWDE_CHG
 0x08

	)

82 
	#OPA_NOTICE_TRAP_LSE_CHG
 0x04

	)

83 
	#OPA_NOTICE_TRAP_LWE_CHG
 0x02

	)

84 
	#OPA_NOTICE_TRAP_NODE_DESC_CHG
 0x01

	)

86 
	sÝa_mad_nÙiû_©Œ
 {

87 
u8
 
	mg’”ic_ty³
;

88 
u8
 
	m´od_ty³_msb
;

89 
__be16
 
	m´od_ty³_lsb
;

90 
__be16
 
	mŒ­_num
;

91 
__be16
 
	mtoggË_couÁ
;

92 
__be32
 
	missu”_lid
;

93 
__be32
 
	m»£rved1
;

94 
ib_gid
 
	missu”_gid
;

98 
u8
 
	md‘ažs
[64];

99 } 
	m¿w_d©a
;

102 
ib_gid
 
	mgid
;

103 } 
__·cked
 
	mÁc_64_65_66_67
;

106 
__be32
 
	mlid
;

107 } 
__·cked
 
	mÁc_128
;

110 
__be32
 
	mlid
;

111 
u8
 
	mpÜt_num
;

112 } 
__·cked
 
	mÁc_129_130_131
;

115 
__be32
 
	mlid
;

116 
__be32
 
	mÃw_ÿp_mask
;

117 
__be16
 
	m»£rved2
;

118 
__be16
 
	mÿp_mask3
;

119 
__be16
 
	mchªge_æags
;

120 } 
__·cked
 
	mÁc_144
;

123 
__be64
 
	mÃw_sys_guid
;

124 
__be32
 
	mlid
;

125 } 
__·cked
 
	mÁc_145
;

128 
__be32
 
	mlid
;

129 
__be32
 
	mdr_¦id
;

130 
u8
 
	mm‘hod
;

131 
u8
 
	mdr_Œunc_hÝ
;

132 
__be16
 
	m©Œ_id
;

133 
__be32
 
	m©Œ_mod
;

134 
__be64
 
	mmkey
;

135 
u8
 
	mdr_¹n_·th
[30];

136 } 
__·cked
 
	mÁc_256
;

139 
__be32
 
	mlid1
;

140 
__be32
 
	mlid2
;

141 
__be32
 
	mkey
;

142 
u8
 
	m¦
;

143 
u8
 
	m»£rved3
[3];

144 
ib_gid
 
	mgid1
;

145 
ib_gid
 
	mgid2
;

146 
__be32
 
	mqp1
;

147 
__be32
 
	mqp2
;

148 } 
__·cked
 
	mÁc_257_258
;

151 
__be16
 
	mæags
;

152 
__be16
 
	mpkey
;

153 
__be32
 
	mlid1
;

154 
__be32
 
	mlid2
;

155 
u8
 
	m¦
;

156 
u8
 
	m»£rved4
[3];

157 
ib_gid
 
	mgid1
;

158 
ib_gid
 
	mgid2
;

159 
__be32
 
	mqp1
;

160 
__be32
 
	mqp2
;

161 } 
__·cked
 
	mÁc_259
;

164 
__be32
 
	mlid
;

165 } 
__·cked
 
	mÁc_2048
;

168 
u8
 
	mþass_d©a
[0];

171 
	#IB_VLARB_LOWPRI_0_31
 1

	)

172 
	#IB_VLARB_LOWPRI_32_63
 2

	)

173 
	#IB_VLARB_HIGHPRI_0_31
 3

	)

174 
	#IB_VLARB_HIGHPRI_32_63
 4

	)

176 
	#OPA_MAX_PREEMPT_CAP
 32

	)

177 
	#OPA_VLARB_LOW_ELEMENTS
 0

	)

178 
	#OPA_VLARB_HIGH_ELEMENTS
 1

	)

179 
	#OPA_VLARB_PREEMPT_ELEMENTS
 2

	)

180 
	#OPA_VLARB_PREEMPT_MATRIX
 3

	)

182 
	#IB_PMA_PORT_COUNTERS_CONG
 
	`ýu_to_be16
(0xFF00)

	)

183 
	#LINK_SPEED_25G
 1

	)

184 
	#LINK_SPEED_12_5G
 2

	)

185 
	#LINK_WIDTH_DEFAULT
 4

	)

186 
	#DECIMAL_FACTORING
 1000

	)

191 
	#FACTOR_LINK_WIDTH
 (
LINK_WIDTH_DEFAULT
 * 
DECIMAL_FACTORING
)

	)

193 
	sib_pma_pÜtcouÁ”s_cÚg
 {

194 
u8
 
	m»£rved
;

195 
u8
 
	m»£rved1
;

196 
__be16
 
	mpÜt_check_¿‹
;

197 
__be16
 
	msymbÞ_”rÜ_couÁ”
;

198 
u8
 
	mlšk_”rÜ_»cov”y_couÁ”
;

199 
u8
 
	mlšk_dowÃd_couÁ”
;

200 
__be16
 
	mpÜt_rcv_”rÜs
;

201 
__be16
 
	mpÜt_rcv_»mphys_”rÜs
;

202 
__be16
 
	mpÜt_rcv_sw™ch_»Ïy_”rÜs
;

203 
__be16
 
	mpÜt_xm™_disÿrds
;

204 
u8
 
	mpÜt_xm™_cÚ¡¿št_”rÜs
;

205 
u8
 
	mpÜt_rcv_cÚ¡¿št_”rÜs
;

206 
u8
 
	m»£rved2
;

207 
u8
 
	mlšk_ov”run_”rÜs
;

208 
__be16
 
	m»£rved3
;

209 
__be16
 
	mvl15_drÝ³d
;

210 
__be64
 
	mpÜt_xm™_d©a
;

211 
__be64
 
	mpÜt_rcv_d©a
;

212 
__be64
 
	mpÜt_xm™_·ck‘s
;

213 
__be64
 
	mpÜt_rcv_·ck‘s
;

214 
__be64
 
	mpÜt_xm™_wa™
;

215 
__be64
 
	mpÜt_adr_ev’ts
;

216 } 
	g__·cked
;

218 
	#IB_SMP_UNSUP_VERSION
 
	`ýu_to_be16
(0x0004)

	)

219 
	#IB_SMP_UNSUP_METHOD
 
	`ýu_to_be16
(0x0008)

	)

220 
	#IB_SMP_UNSUP_METH_ATTR
 
	`ýu_to_be16
(0x000C)

	)

221 
	#IB_SMP_INVALID_FIELD
 
	`ýu_to_be16
(0x001C)

	)

223 
	#OPA_MAX_PREEMPT_CAP
 32

	)

224 
	#OPA_VLARB_LOW_ELEMENTS
 0

	)

225 
	#OPA_VLARB_HIGH_ELEMENTS
 1

	)

226 
	#OPA_VLARB_PREEMPT_ELEMENTS
 2

	)

227 
	#OPA_VLARB_PREEMPT_MATRIX
 3

	)

229 
	#HFI1_XMIT_RATE_UNSUPPORTED
 0x0

	)

230 
	#HFI1_XMIT_RATE_PICO
 0x7

	)

232 
	#HFI1_CONG_TIMER_PSINTERVAL
 0x1DCD64EC

	)

234 
	#IB_CC_SVCTYPE_RC
 0x0

	)

235 
	#IB_CC_SVCTYPE_UC
 0x1

	)

236 
	#IB_CC_SVCTYPE_RD
 0x2

	)

237 
	#IB_CC_SVCTYPE_UD
 0x3

	)

243 
	#OPA_CC_LOG_TYPE_HFI
 2

	)

245 
	sÝa_hfi1_cÚg_log_ev’t_š‹º®
 {

246 
u32
 
	mlq²
;

247 
u32
 
	mrq²
;

248 
u8
 
	m¦
;

249 
u8
 
	msvc_ty³
;

250 
u32
 
	m¾id
;

251 
u64
 
	mtime¡amp
;

254 
	sÝa_hfi1_cÚg_log_ev’t
 {

255 
u8
 
	mloÿl_qp_ú_’Œy
[3];

256 
u8
 
	m»mÙe_qp_numb”_ú_’Œy
[3];

257 
u8
 
	m¦_svc_ty³_ú_’Œy
;

258 
u8
 
	m»£rved
;

259 
__be32
 
	m»mÙe_lid_ú_’Œy
;

260 
__be32
 
	mtime¡amp_ú_’Œy
;

261 } 
	g__·cked
;

263 
	#OPA_CONG_LOG_ELEMS
 96

	)

265 
	sÝa_hfi1_cÚg_log
 {

266 
u8
 
	mlog_ty³
;

267 
u8
 
	mcÚge¡iÚ_æags
;

268 
__be16
 
	mth»shÞd_ev’t_couÁ”
;

269 
__be32
 
	mcu¼’t_time_¡amp
;

270 
u8
 
	mth»shÞd_cÚg_ev’t_m­
[
OPA_MAX_SLS
 / 8];

271 
Ýa_hfi1_cÚg_log_ev’t
 
	mev’ts
[
OPA_CONG_LOG_ELEMS
];

272 } 
	g__·cked
;

274 
	#IB_CC_TABLE_CAP_DEFAULT
 31

	)

277 
	#IB_CC_CCS_PC_SL_BASED
 0x01

	)

279 
	sÝa_cÚge¡iÚ_£‰šg_’Œy
 {

280 
u8
 
	mcùi_šü—£
;

281 
u8
 
	m»£rved
;

282 
__be16
 
	mcùi_tim”
;

283 
u8
 
	mŒigg”_th»shÞd
;

284 
u8
 
	mcùi_mš
;

285 } 
	g__·cked
;

287 
	sÝa_cÚge¡iÚ_£‰šg_’Œy_shadow
 {

288 
u8
 
	mcùi_šü—£
;

289 
u8
 
	m»£rved
;

290 
u16
 
	mcùi_tim”
;

291 
u8
 
	mŒigg”_th»shÞd
;

292 
u8
 
	mcùi_mš
;

293 } 
	g__·cked
;

295 
	sÝa_cÚge¡iÚ_£‰šg_©Œ
 {

296 
__be32
 
	mcÚŒÞ_m­
;

297 
__be16
 
	mpÜt_cÚŒÞ
;

298 
Ýa_cÚge¡iÚ_£‰šg_’Œy
 
	m’Œ›s
[
OPA_MAX_SLS
];

299 } 
	g__·cked
;

301 
	sÝa_cÚge¡iÚ_£‰šg_©Œ_shadow
 {

302 
u32
 
	mcÚŒÞ_m­
;

303 
u16
 
	mpÜt_cÚŒÞ
;

304 
Ýa_cÚge¡iÚ_£‰šg_’Œy_shadow
 
	m’Œ›s
[
OPA_MAX_SLS
];

305 } 
	g__·cked
;

307 
	#IB_CC_TABLE_ENTRY_INCREASE_DEFAULT
 1

	)

308 
	#IB_CC_TABLE_ENTRY_TIMER_DEFAULT
 1

	)

311 
	#IB_CCT_ENTRIES
 64

	)

312 
	#IB_CCT_MIN_ENTRIES
 (
IB_CCT_ENTRIES
 * 2)

	)

314 
	sib_cc_bË_’Œy
 {

315 
__be16
 
	m’Œy
;

318 
	sib_cc_bË_’Œy_shadow
 {

319 
u16
 
	m’Œy
;

322 
	sib_cc_bË_©Œ
 {

323 
__be16
 
	mcùi_lim™
;

324 
ib_cc_bË_’Œy
 
	mcùi_’Œ›s
[
IB_CCT_ENTRIES
];

325 } 
	g__·cked
;

327 
	sib_cc_bË_©Œ_shadow
 {

328 
u16
 
	mcùi_lim™
;

329 
ib_cc_bË_’Œy_shadow
 
	mcùi_’Œ›s
[
IB_CCT_ENTRIES
];

330 } 
	g__·cked
;

332 
	#CC_TABLE_SHADOW_MAX
 \

333 (
IB_CC_TABLE_CAP_DEFAULT
 * 
IB_CCT_ENTRIES
)

	)

335 
	scc_bË_shadow
 {

336 
u16
 
	mcùi_lim™
;

337 
ib_cc_bË_’Œy_shadow
 
	m’Œ›s
[
CC_TABLE_SHADOW_MAX
];

338 } 
	g__·cked
;

346 
	scc_¡©e
 {

347 
rcu_h—d
 
	mrcu
;

348 
cc_bË_shadow
 
	mcù
;

349 
Ýa_cÚge¡iÚ_£‰šg_©Œ_shadow
 
	mcÚg_£‰šg
;

357 
	#OPA_AM_NPORT_SHIFT
 24

	)

358 
	#OPA_AM_NPORT_MASK
 0xff

	)

359 
	#OPA_AM_NPORT_SMASK
 (
OPA_AM_NPORT_MASK
 << 
OPA_AM_NPORT_SHIFT
)

	)

360 
	#OPA_AM_NPORT
(
am
è((×mè>> 
OPA_AM_NPORT_SHIFT
) & \

361 
OPA_AM_NPORT_MASK
)

	)

363 
	#OPA_AM_NBLK_SHIFT
 24

	)

364 
	#OPA_AM_NBLK_MASK
 0xff

	)

365 
	#OPA_AM_NBLK_SMASK
 (
OPA_AM_NBLK_MASK
 << 
OPA_AM_NBLK_SHIFT
)

	)

366 
	#OPA_AM_NBLK
(
am
è((×mè>> 
OPA_AM_NBLK_SHIFT
) & \

367 
OPA_AM_NBLK_MASK
)

	)

369 
	#OPA_AM_START_BLK_SHIFT
 0

	)

370 
	#OPA_AM_START_BLK_MASK
 0xff

	)

371 
	#OPA_AM_START_BLK_SMASK
 (
OPA_AM_START_BLK_MASK
 << \

372 
OPA_AM_START_BLK_SHIFT
)

	)

373 
	#OPA_AM_START_BLK
(
am
è((×mè>> 
OPA_AM_START_BLK_SHIFT
) & \

374 
OPA_AM_START_BLK_MASK
)

	)

376 
	#OPA_AM_PORTNUM_SHIFT
 0

	)

377 
	#OPA_AM_PORTNUM_MASK
 0xff

	)

378 
	#OPA_AM_PORTNUM_SMASK
 (
OPA_AM_PORTNUM_MASK
 << 
OPA_AM_PORTNUM_SHIFT
)

	)

379 
	#OPA_AM_PORTNUM
(
am
è((×mè>> 
OPA_AM_PORTNUM_SHIFT
) & \

380 
OPA_AM_PORTNUM_MASK
)

	)

382 
	#OPA_AM_ASYNC_SHIFT
 12

	)

383 
	#OPA_AM_ASYNC_MASK
 0x1

	)

384 
	#OPA_AM_ASYNC_SMASK
 (
OPA_AM_ASYNC_MASK
 << 
OPA_AM_ASYNC_SHIFT
)

	)

385 
	#OPA_AM_ASYNC
(
am
è((×mè>> 
OPA_AM_ASYNC_SHIFT
) & \

386 
OPA_AM_ASYNC_MASK
)

	)

388 
	#OPA_AM_START_SM_CFG_SHIFT
 9

	)

389 
	#OPA_AM_START_SM_CFG_MASK
 0x1

	)

390 
	#OPA_AM_START_SM_CFG_SMASK
 (
OPA_AM_START_SM_CFG_MASK
 << \

391 
OPA_AM_START_SM_CFG_SHIFT
)

	)

392 
	#OPA_AM_START_SM_CFG
(
am
è((×mè>> 
OPA_AM_START_SM_CFG_SHIFT
) \

393 & 
OPA_AM_START_SM_CFG_MASK
)

	)

395 
	#OPA_AM_CI_ADDR_SHIFT
 19

	)

396 
	#OPA_AM_CI_ADDR_MASK
 0xfff

	)

397 
	#OPA_AM_CI_ADDR_SMASK
 (
OPA_AM_CI_ADDR_MASK
 << 
OPA_CI_ADDR_SHIFT
)

	)

398 
	#OPA_AM_CI_ADDR
(
am
è((×mè>> 
OPA_AM_CI_ADDR_SHIFT
) & \

399 
OPA_AM_CI_ADDR_MASK
)

	)

401 
	#OPA_AM_CI_LEN_SHIFT
 13

	)

402 
	#OPA_AM_CI_LEN_MASK
 0x3f

	)

403 
	#OPA_AM_CI_LEN_SMASK
 (
OPA_AM_CI_LEN_MASK
 << 
OPA_CI_LEN_SHIFT
)

	)

404 
	#OPA_AM_CI_LEN
(
am
è((×mè>> 
OPA_AM_CI_LEN_SHIFT
) & \

405 
OPA_AM_CI_LEN_MASK
)

	)

408 
	#OPA_EI_STATUS_SMASK
 0x80

	)

409 
	#OPA_EI_CODE_SMASK
 0x0f

	)

411 
	svl_lim™
 {

412 
__be16
 
	mdediÿ‹d
;

413 
__be16
 
	msh¬ed
;

416 
	sbufãr_cÚŒÞ
 {

417 
__be16
 
	m»£rved
;

418 
__be16
 
	mov”®l_sh¬ed_lim™
;

419 
vl_lim™
 
	mvl
[
OPA_MAX_VLS
];

422 
	ssc2vÊt
 {

423 
u8
 
	mvÊt
[32];

431 
	#COUNTER_MASK
(
q
, 
n
è(q << ((9 -‚è* 3))

	)

432 
	#COUNTER_MASK0_9
 \

433 
	`ýu_to_be32
(
	`COUNTER_MASK
(1, 0) | \

434 
	`COUNTER_MASK
(1, 1) | \

435 
	`COUNTER_MASK
(1, 2) | \

436 
	`COUNTER_MASK
(1, 3) | \

437 
	`COUNTER_MASK
(1, 4))

	)

439 
hfi1_ev’t_pkey_chªge
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
);

440 
hfi1_hªdË_Œ­_tim”
(
tim”_li¡
 *
t
);

441 
u16
 
tx_lšk_width
(u16 
lšk_width
);

442 
u64
 
g‘_xm™_wa™_couÁ”s
(
hfi1_µÜtd©a
 *
µd
, 
u16
 
lšk_width
,

443 
u16
 
lšk_¥“d
, 
vl
);

458 
šlše
 
u16
 
	$g‘_lšk_¥“d
(
u16
 
lšk_¥“d
)

460  (
lšk_¥“d
 == 1) ?

461 
LINK_SPEED_12_5G
 : 
LINK_SPEED_25G
;

462 
	}
}

472 
šlše
 
u64
 
	$cÚv”t_xm™_couÁ”
(
u64
 
xm™_wa™_v®
, 
u16
 
lšk_width
,

473 
u16
 
lšk_¥“d
)

475  (
xm™_wa™_v®
 * 2 * (
FACTOR_LINK_WIDTH
 / 
lšk_width
)

476 * 
lšk_¥“d
è/ 
DECIMAL_FACTORING
;

477 
	}
}

	@mmu_rb.c

47 
	~<lšux/li¡.h
>

48 
	~<lšux/rculi¡.h
>

49 
	~<lšux/mmu_nÙif›r.h
>

50 
	~<lšux/š‹rv®_Œ“_g’”ic.h
>

52 
	~"mmu_rb.h
"

53 
	~"Œaû.h
"

55 
	smmu_rb_hªdËr
 {

56 
mmu_nÙif›r
 
	mmn
;

57 #ifdeà
NO_RB_ROOT_CACHE


58 
rb_roÙ
 
	mroÙ
;

60 
rb_roÙ_ÿched
 
	mroÙ
;

62 *
	mÝs_¬g
;

63 
¥šlock_t
 
	mlock
;

64 
mmu_rb_Ýs
 *
	mÝs
;

65 
mm_¡ruù
 *
	mmm
;

66 
li¡_h—d
 
	mÌu_li¡
;

67 
wÜk_¡ruù
 
	md–_wÜk
;

68 
li¡_h—d
 
	md–_li¡
;

69 
wÜkqueue_¡ruù
 *
	mwq
;

72 
mmu_node_¡¬t
(
mmu_rb_node
 *);

73 
mmu_node_Ï¡
(
mmu_rb_node
 *);

74 
mmu_nÙif›r_¿nge_¡¬t
(
mmu_nÙif›r
 *,

75 cÚ¡ 
mmu_nÙif›r_¿nge
 *);

76 #iâdeà
HAVE_MMU_NOTIFIER_RANGE


77 
	$com·t_mmu_nÙif›r_¿nge_¡¬t
(
mmu_nÙif›r
 *
mn
,

78 
mm_¡ruù
 *
mm
,

79 
¡¬t
,

80 
’d
)

82 
mmu_nÙif›r_¿nge
 
r
 = {

83 .
mm
 = mm,

84 .
¡¬t
 = start,

85 .
’d
 =ƒnd,

88 ()
	`mmu_nÙif›r_¿nge_¡¬t
(
mn
, &
r
);

89 
	}
}

91 
mmu_rb_node
 *
__mmu_rb_£¬ch
(
mmu_rb_hªdËr
 *,

93 
do_»move
(
mmu_rb_hªdËr
 *
hªdËr
,

94 
li¡_h—d
 *
d–_li¡
);

95 
hªdË_»move
(
wÜk_¡ruù
 *
wÜk
);

97 cÚ¡ 
mmu_nÙif›r_Ýs
 
	gmn_Ýts
 = {

98 #ifdeà
HAVE_MMU_NOTIFIER_RANGE


99 .
šv®id©e_¿nge_¡¬t
 = 
mmu_nÙif›r_¿nge_¡¬t
,

101 .
	gšv®id©e_¿nge_¡¬t
 = 
com·t_mmu_nÙif›r_¿nge_¡¬t
,

105 
INTERVAL_TREE_DEFINE
(
mmu_rb_node
, 
node
, , 
__Ï¡
,

106 
mmu_node_¡¬t
, 
mmu_node_Ï¡
, , 
__mmu_št_rb
);

108 
	$mmu_node_¡¬t
(
mmu_rb_node
 *
node
)

110  
node
->
addr
 & 
PAGE_MASK
;

111 
	}
}

113 
	$mmu_node_Ï¡
(
mmu_rb_node
 *
node
)

115  
	`PAGE_ALIGN
(
node
->
addr
 +‚ode->
Ën
) - 1;

116 
	}
}

118 
	$hfi1_mmu_rb_»gi¡”
(*
Ýs_¬g
, 
mm_¡ruù
 *
mm
,

119 
mmu_rb_Ýs
 *
Ýs
,

120 
wÜkqueue_¡ruù
 *
wq
,

121 
mmu_rb_hªdËr
 **
hªdËr
)

123 
mmu_rb_hªdËr
 *
hªdÌ
;

124 
»t
;

126 
hªdÌ
 = 
	`km®loc
((*hªdÌ), 
GFP_KERNEL
);

127 ià(!
hªdÌ
)

128  -
ENOMEM
;

129 #ifdeà
NO_RB_ROOT_CACHE


130 
hªdÌ
->
roÙ
 = 
RB_ROOT
;

132 
hªdÌ
->
roÙ
 = 
RB_ROOT_CACHED
;

134 
hªdÌ
->
Ýs
 = ops;

135 
hªdÌ
->
Ýs_¬g
 = ops_arg;

136 
	`INIT_HLIST_NODE
(&
hªdÌ
->
mn
.
hli¡
);

137 
	`¥š_lock_š™
(&
hªdÌ
->
lock
);

138 
hªdÌ
->
mn
.
Ýs
 = &
mn_Ýts
;

139 
hªdÌ
->
mm
 = mm;

140 
	`INIT_WORK
(&
hªdÌ
->
d–_wÜk
, 
hªdË_»move
);

141 
	`INIT_LIST_HEAD
(&
hªdÌ
->
d–_li¡
);

142 
	`INIT_LIST_HEAD
(&
hªdÌ
->
Ìu_li¡
);

143 
hªdÌ
->
wq
 = wq;

146 ià(
mm
) {

147 
»t
 = 
	`mmu_nÙif›r_»gi¡”
(&
hªdÌ
->
mn
, hªdÌ->
mm
);

148 ià(
»t
) {

149 
	`kä“
(
hªdÌ
);

150  
»t
;

154 *
hªdËr
 = 
hªdÌ
;

156 
	}
}

158 
	$hfi1_mmu_rb_uÄegi¡”
(
mmu_rb_hªdËr
 *
hªdËr
)

160 
mmu_rb_node
 *
rbnode
;

161 
rb_node
 *
node
;

162 
æags
;

163 
li¡_h—d
 
d–_li¡
;

166 ià(
hªdËr
->
mm
)

167 
	`mmu_nÙif›r_uÄegi¡”
(&
hªdËr
->
mn
, hªdËr->
mm
);

173 
	`æush_wÜk
(&
hªdËr
->
d–_wÜk
);

175 
	`INIT_LIST_HEAD
(&
d–_li¡
);

177 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

178 #ifdeà
NO_RB_ROOT_CACHE


179 (
node
 = 
	`rb_fœ¡
(&
hªdËr
->
roÙ
))) {

181 (
node
 = 
	`rb_fœ¡_ÿched
(&
hªdËr
->
roÙ
))) {

183 
rbnode
 = 
	`rb_’Œy
(
node
, 
mmu_rb_node
,‚ode);

184 #ifdeà
NO_RB_ROOT_CACHE


185 
	`rb_”a£
(
node
, &
hªdËr
->
roÙ
);

187 
	`rb_”a£_ÿched
(
node
, &
hªdËr
->
roÙ
);

190 
	`li¡_move
(&
rbnode
->
li¡
, &
d–_li¡
);

192 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

194 
	`do_»move
(
hªdËr
, &
d–_li¡
);

196 
	`kä“
(
hªdËr
);

197 
	}
}

199 
	$hfi1_mmu_rb_š£¹
(
mmu_rb_hªdËr
 *
hªdËr
,

200 
mmu_rb_node
 *
mnode
)

202 
mmu_rb_node
 *
node
;

203 
æags
;

204 
»t
 = 0;

206 
	`Œaû_hfi1_mmu_rb_š£¹
(
mnode
->
addr
, mnode->
Ën
);

207 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

208 
node
 = 
	`__mmu_rb_£¬ch
(
hªdËr
, 
mnode
->
addr
, mnode->
Ën
);

209 ià(
node
) {

210 
»t
 = -
EINVAL
;

211 
uÆock
;

213 
	`__mmu_št_rb_š£¹
(
mnode
, &
hªdËr
->
roÙ
);

214 
	`li¡_add
(&
mnode
->
li¡
, &
hªdËr
->
Ìu_li¡
);

216 
»t
 = 
hªdËr
->
Ýs
->
	`š£¹
(hªdËr->
Ýs_¬g
, 
mnode
);

217 ià(
»t
) {

218 
	`__mmu_št_rb_»move
(
mnode
, &
hªdËr
->
roÙ
);

219 
	`li¡_d–
(&
mnode
->
li¡
);

221 
uÆock
:

222 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

223  
»t
;

224 
	}
}

227 
mmu_rb_node
 *
	$__mmu_rb_£¬ch
(
mmu_rb_hªdËr
 *
hªdËr
,

228 
addr
,

229 
Ën
)

231 
mmu_rb_node
 *
node
 = 
NULL
;

233 
	`Œaû_hfi1_mmu_rb_£¬ch
(
addr
, 
Ën
);

234 ià(!
hªdËr
->
Ýs
->
fž‹r
) {

235 
node
 = 
	`__mmu_št_rb_™”_fœ¡
(&
hªdËr
->
roÙ
, 
addr
,

236 (
addr
 + 
Ën
) - 1);

238 
node
 = 
	`__mmu_št_rb_™”_fœ¡
(&
hªdËr
->
roÙ
, 
addr
,

239 (
addr
 + 
Ën
) - 1);

240 
node
;

241 
node
 = 
	`__mmu_št_rb_™”_Ãxt
Òode, 
addr
,

242 (
addr
 + 
Ën
) - 1)) {

243 ià(
hªdËr
->
Ýs
->
	`fž‹r
(
node
, 
addr
, 
Ën
))

244  
node
;

247  
node
;

248 
	}
}

250 
boÞ
 
	$hfi1_mmu_rb_»move_uÆess_exaù
(
mmu_rb_hªdËr
 *
hªdËr
,

251 
addr
, 
Ën
,

252 
mmu_rb_node
 **
rb_node
)

254 
mmu_rb_node
 *
node
;

255 
æags
;

256 
boÞ
 
»t
 = 
çl£
;

258 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

259 
node
 = 
	`__mmu_rb_£¬ch
(
hªdËr
, 
addr
, 
Ën
);

260 ià(
node
) {

261 ià(
node
->
addr
 =ðadd¸&&‚ode->
Ën
 ==†en)

262 
uÆock
;

263 
	`__mmu_št_rb_»move
(
node
, &
hªdËr
->
roÙ
);

264 
	`li¡_d–
(&
node
->
li¡
);

265 
»t
 = 
Œue
;

267 
uÆock
:

268 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

269 *
rb_node
 = 
node
;

270  
»t
;

271 
	}
}

273 
	$hfi1_mmu_rb_eviù
(
mmu_rb_hªdËr
 *
hªdËr
, *
eviù_¬g
)

275 
mmu_rb_node
 *
rbnode
, *
±r
;

276 
li¡_h—d
 
d–_li¡
;

277 
æags
;

278 
boÞ
 
¡Ý
 = 
çl£
;

280 
	`INIT_LIST_HEAD
(&
d–_li¡
);

282 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

283 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
rbnode
, 
±r
, &
hªdËr
->
Ìu_li¡
,

284 
li¡
) {

285 ià(
hªdËr
->
Ýs
->
	`eviù
(hªdËr->
Ýs_¬g
, 
rbnode
, 
eviù_¬g
,

286 &
¡Ý
)) {

287 
	`__mmu_št_rb_»move
(
rbnode
, &
hªdËr
->
roÙ
);

289 
	`li¡_move
(&
rbnode
->
li¡
, &
d–_li¡
);

291 ià(
¡Ý
)

294 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

296 !
	`li¡_em±y
(&
d–_li¡
)) {

297 
rbnode
 = 
	`li¡_fœ¡_’Œy
(&
d–_li¡
, 
mmu_rb_node
, 
li¡
);

298 
	`li¡_d–
(&
rbnode
->
li¡
);

299 
hªdËr
->
Ýs
->
	`»move
(hªdËr->
Ýs_¬g
, 
rbnode
);

301 
	}
}

308 
	$hfi1_mmu_rb_»move
(
mmu_rb_hªdËr
 *
hªdËr
,

309 
mmu_rb_node
 *
node
)

311 
æags
;

314 
	`Œaû_hfi1_mmu_rb_»move
(
node
->
addr
,‚ode->
Ën
);

315 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

316 
	`__mmu_št_rb_»move
(
node
, &
hªdËr
->
roÙ
);

317 
	`li¡_d–
(&
node
->
li¡
);

318 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

320 
hªdËr
->
Ýs
->
	`»move
(hªdËr->
Ýs_¬g
, 
node
);

321 
	}
}

323 
	$mmu_nÙif›r_¿nge_¡¬t
(
mmu_nÙif›r
 *
mn
,

324 cÚ¡ 
mmu_nÙif›r_¿nge
 *
¿nge
)

326 
mmu_rb_hªdËr
 *
hªdËr
 =

327 
	`cÚš”_of
(
mn
, 
mmu_rb_hªdËr
, mn);

328 #ifdeà
NO_RB_ROOT_CACHE


329 
rb_roÙ
 *
roÙ
 = &
hªdËr
->root;

331 
rb_roÙ_ÿched
 *
roÙ
 = &
hªdËr
->root;

333 
mmu_rb_node
 *
node
, *
±r
 = 
NULL
;

334 
æags
;

335 
boÞ
 
added
 = 
çl£
;

337 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

338 
node
 = 
	`__mmu_št_rb_™”_fœ¡
(
roÙ
, 
¿nge
->
¡¬t
,„ªge->
’d
-1);

339 
node
;‚odð
±r
) {

341 
±r
 = 
	`__mmu_št_rb_™”_Ãxt
(
node
, 
¿nge
->
¡¬t
,

342 
¿nge
->
’d
 - 1);

343 
	`Œaû_hfi1_mmu_mem_šv®id©e
(
node
->
addr
,‚ode->
Ën
);

344 ià(
hªdËr
->
Ýs
->
	`šv®id©e
(hªdËr->
Ýs_¬g
, 
node
)) {

345 
	`__mmu_št_rb_»move
(
node
, 
roÙ
);

347 
	`li¡_move
(&
node
->
li¡
, &
hªdËr
->
d–_li¡
);

348 
added
 = 
Œue
;

351 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

353 ià(
added
)

354 
	`queue_wÜk
(
hªdËr
->
wq
, &hªdËr->
d–_wÜk
);

357 
	}
}

364 
	$do_»move
(
mmu_rb_hªdËr
 *
hªdËr
,

365 
li¡_h—d
 *
d–_li¡
)

367 
mmu_rb_node
 *
node
;

369 !
	`li¡_em±y
(
d–_li¡
)) {

370 
node
 = 
	`li¡_fœ¡_’Œy
(
d–_li¡
, 
mmu_rb_node
, 
li¡
);

371 
	`li¡_d–
(&
node
->
li¡
);

372 
hªdËr
->
Ýs
->
	`»move
(hªdËr->
Ýs_¬g
, 
node
);

374 
	}
}

381 
	$hªdË_»move
(
wÜk_¡ruù
 *
wÜk
)

383 
mmu_rb_hªdËr
 *
hªdËr
 = 
	`cÚš”_of
(
wÜk
,

384 
mmu_rb_hªdËr
,

385 
d–_wÜk
);

386 
li¡_h—d
 
d–_li¡
;

387 
æags
;

390 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

391 
	`li¡_»¶aû_š™
(&
hªdËr
->
d–_li¡
, &del_list);

392 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

394 
	`do_»move
(
hªdËr
, &
d–_li¡
);

395 
	}
}

397 #ifdeà
NVIDIA_GPU_DIRECT


410 
mmu_rb_node
 *
	$hfi1_mmu_rb_fœ¡_ÿched
(
mmu_rb_hªdËr
 *
hªdËr
)

412 
mmu_rb_node
 *
rbnode
 = 
NULL
;

413 
rb_node
 *
node
;

414 
æags
;

416 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

417 #ifdeà
NO_RB_ROOT_CACHE


418 
node
 = 
	`rb_fœ¡
(&
hªdËr
->
roÙ
);

420 
node
 = 
	`rb_fœ¡_ÿched
(&
hªdËr
->
roÙ
);

422 ià(
node
)

423 
rbnode
 = 
	`rb_’Œy
(
node
, 
mmu_rb_node
,‚ode);

424 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

426  
rbnode
;

427 
	}
}

444 
mmu_rb_node
 *
	$hfi1_mmu_rb_£¬ch_addr
(
mmu_rb_hªdËr
 *
hªdËr
,

445 
addr
,

446 
Ën
)

448 
mmu_rb_node
 *
»t_node
 = 
NULL
;

449 
æags
;

451 
	`¥š_lock_œq§ve
(&
hªdËr
->
lock
, 
æags
);

452 
»t_node
 = 
	`__mmu_rb_£¬ch
(
hªdËr
, 
addr
, 
Ën
);

453 
	`¥š_uÆock_œq»¡Üe
(&
hªdËr
->
lock
, 
æags
);

455  
»t_node
;

456 
	}
}

470 
	$hfi1_gpu_ÿche_šv®id©e
(
mmu_rb_hªdËr
 *
hªdËr
,

471 
¡¬t
, 
’d
)

473 
mmu_nÙif›r_¿nge
 
r
 = {

474 .
mm
 = 
hªdËr
->mm,

475 .
¡¬t
 = start,

476 .
’d
 =ƒnd,

479 ()
	`mmu_nÙif›r_¿nge_¡¬t
(&
hªdËr
->
mn
, &
r
);

480 
	}
}

	@mmu_rb.h

47 #iâdeà
_HFI1_MMU_RB_H


48 
	#_HFI1_MMU_RB_H


	)

50 
	~"hfi.h
"

52 
	smmu_rb_node
 {

53 
	maddr
;

54 
	mËn
;

55 
	m__Ï¡
;

56 
rb_node
 
	mnode
;

57 
li¡_h—d
 
	mli¡
;

64 
	smmu_rb_Ýs
 {

65 
boÞ
 (*
fž‹r
)(
mmu_rb_node
 *
	mnode
, 
	maddr
,

66 
	mËn
);

67 (*
	mš£¹
)(*
	mÝs_¬g
, 
mmu_rb_node
 *
	mmnode
);

68 (*
	m»move
)(*
	mÝs_¬g
, 
mmu_rb_node
 *
	mmnode
);

69 (*
	mšv®id©e
)(*
	mÝs_¬g
, 
mmu_rb_node
 *
	mnode
);

70 (*
	meviù
)(*
	mÝs_¬g
, 
mmu_rb_node
 *
	mmnode
,

71 *
	meviù_¬g
, 
boÞ
 *
	m¡Ý
);

74 
hfi1_mmu_rb_»gi¡”
(*
Ýs_¬g
, 
mm_¡ruù
 *
mm
,

75 
mmu_rb_Ýs
 *
Ýs
,

76 
wÜkqueue_¡ruù
 *
wq
,

77 
mmu_rb_hªdËr
 **
hªdËr
);

78 
hfi1_mmu_rb_uÄegi¡”
(
mmu_rb_hªdËr
 *
hªdËr
);

79 
hfi1_mmu_rb_š£¹
(
mmu_rb_hªdËr
 *
hªdËr
,

80 
mmu_rb_node
 *
mnode
);

81 
hfi1_mmu_rb_eviù
(
mmu_rb_hªdËr
 *
hªdËr
, *
eviù_¬g
);

82 
hfi1_mmu_rb_»move
(
mmu_rb_hªdËr
 *
hªdËr
,

83 
mmu_rb_node
 *
mnode
);

84 
boÞ
 
hfi1_mmu_rb_»move_uÆess_exaù
(
mmu_rb_hªdËr
 *
hªdËr
,

85 
addr
, 
Ën
,

86 
mmu_rb_node
 **
rb_node
);

89 #ifdeà
NVIDIA_GPU_DIRECT


90 
mmu_rb_node
 *
hfi1_mmu_rb_fœ¡_ÿched
(
mmu_rb_hªdËr
 *
hªdËr
);

91 
mmu_rb_node
 *
hfi1_mmu_rb_£¬ch_addr
(
mmu_rb_hªdËr
 *
hªdËr
,

92 
addr
,

93 
Ën
);

94 
hfi1_gpu_ÿche_šv®id©e
(
mmu_rb_hªdËr
 *
hªdËr
,

95 
¡¬t
, 
’d
);

	@msix.c

49 
	~"hfi.h
"

50 
	~"affš™y.h
"

51 
	~"sdma.h
"

52 
	~"Ãtdev.h
"

53 
	~"ch.h
"

60 
	$msix_š™Ÿlize
(
hfi1_devd©a
 *
dd
)

62 
u32
 
tÙ®
;

63 
»t
;

64 
hfi1_msix_’Œy
 *
’Œ›s
;

74 
tÙ®
 = 1 + 
dd
->
num_sdma
 + dd->
n_krcv_queues
 + dd->
num_Ãtdev_cÚ‹xts
;

76 ià(
tÙ®
 >ð
CCE_NUM_MSIX_VECTORS
)

77  -
EINVAL
;

79 
»t
 = 
	`pci_®loc_œq_veùÜs
(
dd
->
pcidev
, 
tÙ®
,Ù®, 
PCI_IRQ_MSIX
);

80 ià(
»t
 < 0) {

81 
	`dd_dev_”r
(
dd
, "pci_®loc_œq_veùÜs(èçžed: %d\n", 
»t
);

82  
»t
;

85 
’Œ›s
 = 
	`kÿÎoc
(
tÙ®
, (*
dd
->
msix_šfo
.
msix_’Œ›s
),

86 
GFP_KERNEL
);

87 ià(!
’Œ›s
) {

88 
	`pci_ä“_œq_veùÜs
(
dd
->
pcidev
);

89  -
ENOMEM
;

92 
dd
->
msix_šfo
.
msix_’Œ›s
 = 
’Œ›s
;

93 
	`¥š_lock_š™
(&
dd
->
msix_šfo
.
msix_lock
);

94 
	`b™m­_z”o
(
dd
->
msix_šfo
.
š_u£_msix
, 
tÙ®
);

95 
dd
->
msix_šfo
.
max_»que¡ed
 = 
tÙ®
;

96 
	`dd_dev_šfo
(
dd
, "%u MSI-X iÁ”ru± ®loÿ‹d\n", 
tÙ®
);

99 
	}
}

118 
	$msix_»que¡_œq
(
hfi1_devd©a
 *
dd
, *
¬g
,

119 
œq_hªdËr_t
 
hªdËr
, irq_hªdËr_ˆ
th»ad
,

120 
œq_ty³
 
ty³
, cÚ¡ *
Çme
)

122 
Ä
;

123 
œq
;

124 
»t
;

125 
hfi1_msix_’Œy
 *
me
;

128 
	`¥š_lock
(&
dd
->
msix_šfo
.
msix_lock
);

129 
Ä
 = 
	`fšd_fœ¡_z”o_b™
(
dd
->
msix_šfo
.
š_u£_msix
,

130 
dd
->
msix_šfo
.
max_»que¡ed
);

131 ià(
Ä
 < 
dd
->
msix_šfo
.
max_»que¡ed
)

132 
	`__£t_b™
(
Ä
, 
dd
->
msix_šfo
.
š_u£_msix
);

133 
	`¥š_uÆock
(&
dd
->
msix_šfo
.
msix_lock
);

135 ià(
Ä
 =ð
dd
->
msix_šfo
.
max_»que¡ed
)

136  -
ENOSPC
;

138 ià(
ty³
 < 
IRQ_SDMA
 &&y³ >ð
IRQ_OTHER
)

139  -
EINVAL
;

141 
œq
 = 
	`pci_œq_veùÜ
(
dd
->
pcidev
, 
Ä
);

142 
»t
 = 
	`pci_»que¡_œq
(
dd
->
pcidev
, 
Ä
, 
hªdËr
, 
th»ad
, 
¬g
, 
Çme
);

143 ià(
»t
) {

144 
	`dd_dev_”r
(
dd
,

146 
Çme
, 
œq
, 
Ä
, 
»t
);

147 
	`¥š_lock
(&
dd
->
msix_šfo
.
msix_lock
);

148 
	`__þ—r_b™
(
Ä
, 
dd
->
msix_šfo
.
š_u£_msix
);

149 
	`¥š_uÆock
(&
dd
->
msix_šfo
.
msix_lock
);

150  
»t
;

157 
me
 = &
dd
->
msix_šfo
.
msix_’Œ›s
[
Ä
];

158 
me
->
œq
 = irq;

159 
me
->
¬g
 =‡rg;

160 
me
->
ty³
 =ype;

163 
»t
 = 
	`hfi1_g‘_œq_affš™y
(
dd
, 
me
);

164 ià(
»t
)

165 
	`dd_dev_”r
(
dd
, "%s: uÇbËØpš IRQ %d\n", 
Çme
, 
»t
);

167  
Ä
;

168 
	}
}

170 
	$msix_»que¡_rcd_œq_commÚ
(
hfi1_ùxtd©a
 *
rcd
,

171 
œq_hªdËr_t
 
hªdËr
,

172 
œq_hªdËr_t
 
th»ad
,

173 cÚ¡ *
Çme
)

175 
Ä
 = 
	`msix_»que¡_œq
(
rcd
->
dd
,„cd, 
hªdËr
, 
th»ad
,

176 
rcd
->
is_vnic
 ? 
IRQ_NETDEVCTXT
 : 
IRQ_RCVCTXT
,

177 
Çme
);

178 ià(
Ä
 < 0)

179  
Ä
;

185 
rcd
->
œeg
 = (
IS_RCVAVAIL_START
 +„cd->
ùxt
) / 64;

186 
rcd
->
imask
 = ((
u64
)1è<< ((
IS_RCVAVAIL_START
 +„cd->
ùxt
) % 64);

187 
rcd
->
msix_šŒ
 = 
Ä
;

188 
	`»m­_šŒ
(
rcd
->
dd
, 
IS_RCVAVAIL_START
 +„cd->
ùxt
, 
Ä
);

191 
	}
}

197 
	$msix_»que¡_rcd_œq
(
hfi1_ùxtd©a
 *
rcd
)

199 
Çme
[
MAX_NAME_SIZE
];

201 
	`¢´štf
(
Çme
, Òame), 
DRIVER_NAME
 "_%d kctxt%d",

202 
rcd
->
dd
->
un™
,„cd->
ùxt
);

204  
	`msix_»que¡_rcd_œq_commÚ
(
rcd
, 
»ûive_cÚ‹xt_š‹¼u±
,

205 
»ûive_cÚ‹xt_th»ad
, 
Çme
);

206 
	}
}

213 
	$msix_Ãtdev_»que¡_rcd_œq
(
hfi1_ùxtd©a
 *
rcd
)

215 
Çme
[
MAX_NAME_SIZE
];

217 
	`¢´štf
(
Çme
, Òame), 
DRIVER_NAME
 "_%d‚d kctxt%d",

218 
rcd
->
dd
->
un™
,„cd->
ùxt
);

219  
	`msix_»que¡_rcd_œq_commÚ
(
rcd
, 
»ûive_cÚ‹xt_š‹¼u±_Çpi
,

220 
NULL
, 
Çme
);

221 
	}
}

228 
	$msix_»que¡_sdma_œq
(
sdma_’gše
 *
sde
)

230 
Ä
;

231 
Çme
[
MAX_NAME_SIZE
];

233 
	`¢´štf
(
Çme
, Òame), 
DRIVER_NAME
 "_%d sdma%d",

234 
sde
->
dd
->
un™
, sde->
this_idx
);

235 
Ä
 = 
	`msix_»que¡_œq
(
sde
->
dd
, sde, 
sdma_š‹¼u±
, 
NULL
,

236 
IRQ_SDMA
, 
Çme
);

237 ià(
Ä
 < 0)

238  
Ä
;

239 
sde
->
msix_šŒ
 = 
Ä
;

240 
	`»m­_sdma_š‹¼u±s
(
sde
->
dd
, sde->
this_idx
, 
Ä
);

243 
	}
}

250 
	$msix_»que¡_g’”®_œq
(
hfi1_devd©a
 *
dd
)

252 
Ä
;

253 
Çme
[
MAX_NAME_SIZE
];

255 
	`¢´štf
(
Çme
, Òame), 
DRIVER_NAME
 "_%d", 
dd
->
un™
);

256 
Ä
 = 
	`msix_»que¡_œq
(
dd
, dd, 
g’”®_š‹¼u±
, 
NULL
, 
IRQ_GENERAL
,

257 
Çme
);

258 ià(
Ä
 < 0)

259  
Ä
;

262 ià(
Ä
) {

263 
	`msix_ä“_œq
(
dd
, (
u8
)
Ä
);

264 
	`dd_dev_”r
(
dd
, "Inv®id index %d fÜ GENERAL IRQ\n", 
Ä
);

265  -
EINVAL
;

269 
	}
}

276 
	$’abË_sdma_¤cs
(
hfi1_devd©a
 *
dd
, 
i
)

278 
	`£t_šŒ_b™s
(
dd
, 
IS_SDMA_START
 + 
i
, IS_SDMA_START + i, 
Œue
);

279 
	`£t_šŒ_b™s
(
dd
, 
IS_SDMA_PROGRESS_START
 + 
i
,

280 
IS_SDMA_PROGRESS_START
 + 
i
, 
Œue
);

281 
	`£t_šŒ_b™s
(
dd
, 
IS_SDMA_IDLE_START
 + 
i
, IS_SDMA_IDLE_START + i, 
Œue
);

282 
	`£t_šŒ_b™s
(
dd
, 
IS_SDMAENG_ERR_START
 + 
i
, IS_SDMAENG_ERR_START + i,

283 
Œue
);

284 
	}
}

293 
	$msix_»que¡_œqs
(
hfi1_devd©a
 *
dd
)

295 
i
;

296 
»t
 = 
	`msix_»que¡_g’”®_œq
(
dd
);

298 ià(
»t
)

299  
»t
;

301 
i
 = 0; i < 
dd
->
num_sdma
; i++) {

302 
sdma_’gše
 *
sde
 = &
dd
->
³r_sdma
[
i
];

304 
»t
 = 
	`msix_»que¡_sdma_œq
(
sde
);

305 ià(
»t
)

306  
»t
;

307 
	`’abË_sdma_¤cs
(
sde
->
dd
, 
i
);

310 
i
 = 0; i < 
dd
->
n_krcv_queues
; i++) {

311 
hfi1_ùxtd©a
 *
rcd
 = 
	`hfi1_rcd_g‘_by_šdex_§ã
(
dd
, 
i
);

313 ià(
rcd
)

314 
»t
 = 
	`msix_»que¡_rcd_œq
(
rcd
);

315 
	`hfi1_rcd_put
(
rcd
);

316 ià(
»t
)

317  
»t
;

321 
	}
}

329 
	$msix_ä“_œq
(
hfi1_devd©a
 *
dd
, 
u8
 
msix_šŒ
)

331 
hfi1_msix_’Œy
 *
me
;

333 ià(
msix_šŒ
 >ð
dd
->
msix_šfo
.
max_»que¡ed
)

336 
me
 = &
dd
->
msix_šfo
.
msix_’Œ›s
[
msix_šŒ
];

338 ià(!
me
->
¬g
)

341 
	`hfi1_put_œq_affš™y
(
dd
, 
me
);

342 
	`pci_ä“_œq
(
dd
->
pcidev
, 
msix_šŒ
, 
me
->
¬g
);

344 
me
->
¬g
 = 
NULL
;

346 
	`¥š_lock
(&
dd
->
msix_šfo
.
msix_lock
);

347 
	`__þ—r_b™
(
msix_šŒ
, 
dd
->
msix_šfo
.
š_u£_msix
);

348 
	`¥š_uÆock
(&
dd
->
msix_šfo
.
msix_lock
);

349 
	}
}

357 
	$msix_þ—n_up_š‹¼u±s
(
hfi1_devd©a
 *
dd
)

359 
i
;

360 
hfi1_msix_’Œy
 *
me
 = 
dd
->
msix_šfo
.
msix_’Œ›s
;

363 
i
 = 0; i < 
dd
->
msix_šfo
.
max_»que¡ed
; i++, 
me
++)

364 
	`msix_ä“_œq
(
dd
, 
i
);

367 
	`kä“
(
dd
->
msix_šfo
.
msix_’Œ›s
);

368 
dd
->
msix_šfo
.
msix_’Œ›s
 = 
NULL
;

369 
dd
->
msix_šfo
.
max_»que¡ed
 = 0;

371 
	`pci_ä“_œq_veùÜs
(
dd
->
pcidev
);

372 
	}
}

378 
	$msix_Ãtdev_synchrÚize_œq
(
hfi1_devd©a
 *
dd
)

380 
i
;

381 
ùxt_couÁ
 = 
	`hfi1_Ãtdev_ùxt_couÁ
(
dd
);

383 
i
 = 0; i < 
ùxt_couÁ
; i++) {

384 
hfi1_ùxtd©a
 *
rcd
 = 
	`hfi1_Ãtdev_g‘_ùxt
(
dd
, 
i
);

385 
hfi1_msix_’Œy
 *
me
;

387 
me
 = &
dd
->
msix_šfo
.
msix_’Œ›s
[
rcd
->
msix_šŒ
];

389 
	`synchrÚize_œq
(
me
->
œq
);

391 
	}
}

	@msix.h

48 #iâdeà
_HFI1_MSIX_H


49 
	#_HFI1_MSIX_H


	)

51 
	~"hfi.h
"

54 
msix_š™Ÿlize
(
hfi1_devd©a
 *
dd
);

55 
msix_»que¡_œqs
(
hfi1_devd©a
 *
dd
);

56 
msix_þ—n_up_š‹¼u±s
(
hfi1_devd©a
 *
dd
);

57 
msix_»que¡_g’”®_œq
(
hfi1_devd©a
 *
dd
);

58 
msix_»que¡_rcd_œq
(
hfi1_ùxtd©a
 *
rcd
);

59 
msix_»que¡_sdma_œq
(
sdma_’gše
 *
sde
);

60 
msix_ä“_œq
(
hfi1_devd©a
 *
dd
, 
u8
 
msix_šŒ
);

61 
msix_»que¡_œq
(
hfi1_devd©a
 *
dd
, *
¬g
,

62 
œq_hªdËr_t
 
hªdËr
, irq_hªdËr_ˆ
th»ad
,

63 
œq_ty³
 
ty³
, cÚ¡ *
Çme
);

66 
msix_Ãtdev_synchrÚize_œq
(
hfi1_devd©a
 *
dd
);

67 
msix_Ãtdev_»que¡_rcd_œq
(
hfi1_ùxtd©a
 *
rcd
);

	@netdev.h

49 #iâdeà
HFI1_NETDEV_H


50 
	#HFI1_NETDEV_H


	)

52 
	~"hfi.h
"

54 
	~<lšux/Ãtdeviû.h
>

55 
	~<lšux/idr.h
>

65 
	shfi1_Ãtdev_rxq
 {

66 
Çpi_¡ruù
 
	mÇpi
;

67 
hfi1_Ãtdev_´iv
 *
	m´iv
;

68 
hfi1_ùxtd©a
 *
	mrcd
;

71 
	#HFI1_NETDEV_MAX
 255

	)

76 
	#HFI1_NUM_NETDEV_CTXT
 8

	)

79 
	#NUM_NETDEV_MAP_ENTRIES
 8

	)

96 
	shfi1_Ãtdev_´iv
 {

97 
hfi1_devd©a
 *
	mdd
;

98 
hfi1_Ãtdev_rxq
 *
	mrxq
;

99 
	mnum_rx_q
;

100 
	mrmt_¡¬t
;

102 
mu‹x
 
	midr_lock
;

103 
idr
 
	midr
;

105 
©omic_t
 
	m’abËd
;

107 
©omic_t
 
	mÃtdevs
;

110 
šlše


111 
hfi1_Ãtdev_´iv
 *
	$hfi1_Ãtdev_´iv
(
Ãt_deviû
 *
dev
)

113  (
hfi1_Ãtdev_´iv
 *)&
dev
[1];

114 
	}
}

116 
šlše


117 
	$hfi1_Ãtdev_ùxt_couÁ
(
hfi1_devd©a
 *
dd
)

119 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

121  
´iv
->
num_rx_q
;

122 
	}
}

124 
šlše


125 
hfi1_ùxtd©a
 *
	$hfi1_Ãtdev_g‘_ùxt
(
hfi1_devd©a
 *
dd
, 
ùxt
)

127 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

129  
´iv
->
rxq
[
ùxt
].
rcd
;

130 
	}
}

132 
šlše


133 
	$hfi1_Ãtdev_g‘_ä“_rmt_idx
(
hfi1_devd©a
 *
dd
)

135 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

137  
´iv
->
rmt_¡¬t
;

138 
	}
}

140 
šlše


141 
	$hfi1_Ãtdev_£t_ä“_rmt_idx
(
hfi1_devd©a
 *
dd
, 
rmt_idx
)

143 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

145 
´iv
->
rmt_¡¬t
 = 
rmt_idx
;

146 
	}
}

157 
hfi1_Ãtdev_’abË_queues
(
hfi1_devd©a
 *
dd
);

158 
hfi1_Ãtdev_di§bË_queues
(
hfi1_devd©a
 *
dd
);

167 
hfi1_Ãtdev_rx_š™
(
hfi1_devd©a
 *
dd
);

175 
hfi1_Ãtdev_rx_de¡roy
(
hfi1_devd©a
 *
dd
);

184 
hfi1_Ãtdev_®loc
(
hfi1_devd©a
 *
dd
);

185 
hfi1_Ãtdev_ä“
(
hfi1_devd©a
 *
dd
);

197 
hfi1_Ãtdev_add_d©a
(
hfi1_devd©a
 *
dd
, 
id
, *
d©a
);

206 
hfi1_Ãtdev_»move_d©a
(
hfi1_devd©a
 *
dd
, 
id
);

214 *
hfi1_Ãtdev_g‘_d©a
(
hfi1_devd©a
 *
dd
, 
id
);

222 *
hfi1_Ãtdev_g‘_fœ¡_d©a
(
hfi1_devd©a
 *
dd
, *
¡¬t_id
);

231 
hfi1_Ãtdev_rx_Çpi
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
);

	@netdev_rx.c

53 
	~"sdma.h
"

54 
	~"v”bs.h
"

55 
	~"Ãtdev.h
"

56 
	~"hfi.h
"

57 
	~"com·t_commÚ.h
"

59 
	~<lšux/©omic.h
>

60 
	~<lšux/Ãtdeviû.h
>

61 
	~<lšux/‘h”deviû.h
>

62 
	~<rdma/ib_v”bs.h
>

64 
	$hfi1_Ãtdev_£tup_ùxt
(
hfi1_Ãtdev_´iv
 *
´iv
,

65 
hfi1_ùxtd©a
 *
uùxt
)

67 
rcvù¾_Ýs
 = 
HFI1_RCVCTRL_CTXT_DIS
 |

68 
HFI1_RCVCTRL_INTRAVAIL_DIS
;

69 
hfi1_devd©a
 *
dd
 = 
´iv
->dd;

70 
»t
;

72 
uùxt
->
rhf_rcv_funùiÚ_m­
 = 
Ãtdev_rhf_rcv_funùiÚs
;

73 
uùxt
->
do_š‹¼u±
 = &
hªdË_»ûive_š‹¼u±_Çpi_¥
;

76 
»t
 = 
	`hfi1_ü—‹_rcvhdrq
(
dd
, 
uùxt
);

77 ià(
»t
)

78 
dÚe
;

80 
»t
 = 
	`hfi1_£tup_—g”bufs
(
uùxt
);

81 ià(
»t
)

82 
dÚe
;

84 
	`þ—r_rcvhd¹až
(
uùxt
);

86 ià(!
	`HFI1_CAP_KGET_MASK
(
uùxt
->
æags
, 
MULTI_PKT_EGR
))

87 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_ONE_PKT_EGR_ENB
;

88 ià(
	`HFI1_CAP_KGET_MASK
(
uùxt
->
æags
, 
NODROP_EGR_FULL
))

89 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_NO_EGR_DROP_ENB
;

90 ià(
	`HFI1_CAP_KGET_MASK
(
uùxt
->
æags
, 
NODROP_RHQ_FULL
))

91 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_NO_RHQ_DROP_ENB
;

92 ià(
	`HFI1_CAP_KGET_MASK
(
uùxt
->
æags
, 
DMA_RTAIL
))

93 
rcvù¾_Ýs
 |ð
HFI1_RCVCTRL_TAILUPD_ENB
;

95 
	`hfi1_rcvù¾
(
uùxt
->
dd
, 
rcvù¾_Ýs
, uctxt);

96 
dÚe
:

97  
»t
;

98 
	}
}

100 
	$hfi1_Ãtdev_®loÿ‹_ùxt
(
hfi1_devd©a
 *
dd
,

101 
hfi1_ùxtd©a
 **
ùxt
)

103 
hfi1_ùxtd©a
 *
uùxt
;

104 
»t
;

106 ià(
dd
->
æags
 & 
HFI1_FROZEN
)

107  -
EIO
;

109 
»t
 = 
	`hfi1_ü—‹_ùxtd©a
(
dd
->
µÜt
, dd->
node
, &
uùxt
);

110 ià(
»t
 < 0) {

111 
	`dd_dev_”r
(
dd
, "Unableo create ctxtdata, failing open\n");

112  -
ENOMEM
;

115 
uùxt
->
æags
 = 
	`HFI1_CAP_KGET
(
MULTI_PKT_EGR
) |

116 
	`HFI1_CAP_KGET
(
NODROP_RHQ_FULL
) |

117 
	`HFI1_CAP_KGET
(
NODROP_EGR_FULL
) |

118 
	`HFI1_CAP_KGET
(
DMA_RTAIL
);

120 
uùxt
->
ç¡_hªdËr
 = 
hªdË_»ûive_š‹¼u±_Çpi_å
;

121 
uùxt
->
¦ow_hªdËr
 = 
hªdË_»ûive_š‹¼u±_Çpi_¥
;

122 
	`hfi1_£t_£q_út
(
uùxt
, 1);

123 
uùxt
->
is_vnic
 = 
Œue
;

125 
hfi1_¡©s
.
¥s_ùxts
++;

127 
	`dd_dev_šfo
(
dd
, "ü—‹d‚‘dev cÚ‹xˆ%d\n", 
uùxt
->
ùxt
);

128 *
ùxt
 = 
uùxt
;

131 
	}
}

133 
	$hfi1_Ãtdev_d—Îoÿ‹_ùxt
(
hfi1_devd©a
 *
dd
,

134 
hfi1_ùxtd©a
 *
uùxt
)

136 
	`æush_wc
();

142 
	`hfi1_rcvù¾
(
dd
, 
HFI1_RCVCTRL_CTXT_DIS
 |

143 
HFI1_RCVCTRL_TIDFLOW_DIS
 |

144 
HFI1_RCVCTRL_INTRAVAIL_DIS
 |

145 
HFI1_RCVCTRL_ONE_PKT_EGR_DIS
 |

146 
HFI1_RCVCTRL_NO_RHQ_DROP_DIS
 |

147 
HFI1_RCVCTRL_NO_EGR_DROP_DIS
, 
uùxt
);

149 ià(
uùxt
->
msix_šŒ
 !ð
CCE_NUM_MSIX_VECTORS
)

150 
	`msix_ä“_œq
(
dd
, 
uùxt
->
msix_šŒ
);

152 
uùxt
->
msix_šŒ
 = 
CCE_NUM_MSIX_VECTORS
;

153 
uùxt
->
ev’t_æags
 = 0;

155 
	`hfi1_þ—r_tids
(
uùxt
);

156 
	`hfi1_þ—r_ùxt_pkey
(
dd
, 
uùxt
);

158 
hfi1_¡©s
.
¥s_ùxts
--;

160 
	`hfi1_ä“_ùxt
(
uùxt
);

161 
	}
}

163 
	$hfi1_Ãtdev_®lÙ_ùxt
(
hfi1_Ãtdev_´iv
 *
´iv
,

164 
hfi1_ùxtd©a
 **
ùxt
)

166 
rc
;

167 
hfi1_devd©a
 *
dd
 = 
´iv
->dd;

169 
rc
 = 
	`hfi1_Ãtdev_®loÿ‹_ùxt
(
dd
, 
ùxt
);

170 ià(
rc
) {

171 
	`dd_dev_”r
(
dd
, "Ãtdev ctxˆ®loøçžed %d\n", 
rc
);

172  
rc
;

175 
rc
 = 
	`hfi1_Ãtdev_£tup_ùxt
(
´iv
, *
ùxt
);

176 ià(
rc
) {

177 
	`dd_dev_”r
(
dd
, "Ãtdev ctxˆ£tu°çžed %d\n", 
rc
);

178 
	`hfi1_Ãtdev_d—Îoÿ‹_ùxt
(
dd
, *
ùxt
);

179 *
ùxt
 = 
NULL
;

182  
rc
;

183 
	}
}

185 
	$hfi1_Ãtdev_rxq_š™
(
Ãt_deviû
 *
dev
)

187 
i
;

188 
rc
;

189 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dev
);

190 
hfi1_devd©a
 *
dd
 = 
´iv
->dd;

192 
´iv
->
num_rx_q
 = 
dd
->
num_Ãtdev_cÚ‹xts
;

193 
´iv
->
rxq
 = 
	`kÿÎoc_node
Õriv->
num_rx_q
, (
hfi1_Ãtdev_rxq
),

194 
GFP_KERNEL
, 
dd
->
node
);

196 ià(!
´iv
->
rxq
) {

197 
	`dd_dev_”r
(
dd
, "Unableo‡llocate‚etdev queue data\n");

198  (-
ENOMEM
);

201 
i
 = 0; i < 
´iv
->
num_rx_q
; i++) {

202 
hfi1_Ãtdev_rxq
 *
rxq
 = &
´iv
->rxq[
i
];

204 
rc
 = 
	`hfi1_Ãtdev_®lÙ_ùxt
(
´iv
, &
rxq
->
rcd
);

205 ià(
rc
)

206 
baž_cÚ‹xt_œq_çžu»
;

208 
	`hfi1_rcd_g‘
(
rxq
->
rcd
);

209 
rxq
->
´iv
 =…riv;

210 
rxq
->
rcd
->
Çpi
 = &rxq->napi;

211 
	`dd_dev_šfo
(
dd
, "Setting„cv queue %d‚apio context %d\n",

212 
i
, 
rxq
->
rcd
->
ùxt
);

217 
	`£t_b™
(
NAPI_STATE_NO_BUSY_POLL
, &
rxq
->
Çpi
.
¡©e
);

218 
	`Ãtif_Çpi_add
(
dev
, &
rxq
->
Çpi
, 
hfi1_Ãtdev_rx_Çpi
, 64);

219 
rc
 = 
	`msix_Ãtdev_»que¡_rcd_œq
(
rxq
->
rcd
);

220 ià(
rc
)

221 
baž_cÚ‹xt_œq_çžu»
;

226 
baž_cÚ‹xt_œq_çžu»
:

227 
	`dd_dev_”r
(
dd
, "Unableo‡llot„eceive context\n");

228 ; 
i
 >= 0; i--) {

229 
hfi1_Ãtdev_rxq
 *
rxq
 = &
´iv
->rxq[
i
];

231 ià(
rxq
->
rcd
) {

232 
	`hfi1_Ãtdev_d—Îoÿ‹_ùxt
(
dd
, 
rxq
->
rcd
);

233 
	`hfi1_rcd_put
(
rxq
->
rcd
);

234 
rxq
->
rcd
 = 
NULL
;

237 
	`kä“
(
´iv
->
rxq
);

238 
´iv
->
rxq
 = 
NULL
;

240  
rc
;

241 
	}
}

243 
	$hfi1_Ãtdev_rxq_deš™
(
Ãt_deviû
 *
dev
)

245 
i
;

246 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dev
);

247 
hfi1_devd©a
 *
dd
 = 
´iv
->dd;

249 
i
 = 0; i < 
´iv
->
num_rx_q
; i++) {

250 
hfi1_Ãtdev_rxq
 *
rxq
 = &
´iv
->rxq[
i
];

252 
	`Ãtif_Çpi_d–
(&
rxq
->
Çpi
);

253 
	`hfi1_Ãtdev_d—Îoÿ‹_ùxt
(
dd
, 
rxq
->
rcd
);

254 
	`hfi1_rcd_put
(
rxq
->
rcd
);

255 
rxq
->
rcd
 = 
NULL
;

258 
	`kä“
(
´iv
->
rxq
);

259 
´iv
->
rxq
 = 
NULL
;

260 
´iv
->
num_rx_q
 = 0;

261 
	}
}

263 
	$’abË_queues
(
hfi1_Ãtdev_´iv
 *
´iv
)

265 
i
;

267 
i
 = 0; i < 
´iv
->
num_rx_q
; i++) {

268 
hfi1_Ãtdev_rxq
 *
rxq
 = &
´iv
->rxq[
i
];

270 
	`dd_dev_šfo
(
´iv
->
dd
, "’ablšg queu%d oÀcÚ‹xˆ%d\n", 
i
,

271 
rxq
->
rcd
->
ùxt
);

272 
	`Çpi_’abË
(&
rxq
->
Çpi
);

273 
	`hfi1_rcvù¾
(
´iv
->
dd
,

274 
HFI1_RCVCTRL_CTXT_ENB
 | 
HFI1_RCVCTRL_INTRAVAIL_ENB
,

275 
rxq
->
rcd
);

277 
	}
}

279 
	$di§bË_queues
(
hfi1_Ãtdev_´iv
 *
´iv
)

281 
i
;

283 
	`msix_Ãtdev_synchrÚize_œq
(
´iv
->
dd
);

285 
i
 = 0; i < 
´iv
->
num_rx_q
; i++) {

286 
hfi1_Ãtdev_rxq
 *
rxq
 = &
´iv
->rxq[
i
];

288 
	`dd_dev_šfo
(
´iv
->
dd
, "di§blšg queu%d oÀcÚ‹xˆ%d\n", 
i
,

289 
rxq
->
rcd
->
ùxt
);

292 
	`hfi1_rcvù¾
(
´iv
->
dd
,

293 
HFI1_RCVCTRL_CTXT_DIS
 | 
HFI1_RCVCTRL_INTRAVAIL_DIS
,

294 
rxq
->
rcd
);

295 
	`Çpi_synchrÚize
(&
rxq
->
Çpi
);

296 
	`Çpi_di§bË
(&
rxq
->
Çpi
);

298 
	}
}

300 
	$hfi1_Ãtdev_rx_š™
(
hfi1_devd©a
 *
dd
)

302 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

303 
»s
;

305 #ifdeà
©omic_ãtch_šc


306 ià(
	`©omic_ãtch_šc
(&
´iv
->
Ãtdevs
))

308 ià(
	`©omic_šc_»tuº
(&
´iv
->
Ãtdevs
) - 1)

312 
	`mu‹x_lock
(&
hfi1_mu‹x
);

313 
	`š™_dummy_Ãtdev
(
dd
->
dummy_Ãtdev
);

314 
»s
 = 
	`hfi1_Ãtdev_rxq_š™
(
dd
->
dummy_Ãtdev
);

315 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

316  
»s
;

317 
	}
}

319 
	$hfi1_Ãtdev_rx_de¡roy
(
hfi1_devd©a
 *
dd
)

321 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

324 ià(
	`©omic_ãtch_add_uÆess
(&
´iv
->
Ãtdevs
, -1, 0) == 1) {

325 
	`mu‹x_lock
(&
hfi1_mu‹x
);

326 
	`hfi1_Ãtdev_rxq_deš™
(
dd
->
dummy_Ãtdev
);

327 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

331 
	}
}

333 
	$hfi1_Ãtdev_®loc
(
hfi1_devd©a
 *
dd
)

335 
hfi1_Ãtdev_´iv
 *
´iv
;

336 cÚ¡ 
Ãtdev_size
 = (*
dd
->
dummy_Ãtdev
) +

337 (
hfi1_Ãtdev_´iv
);

339 
	`dd_dev_šfo
(
dd
, "®loÿtšg‚‘dev siz%d\n", 
Ãtdev_size
);

340 
dd
->
dummy_Ãtdev
 = 
	`kÿÎoc_node
(1, 
Ãtdev_size
, 
GFP_KERNEL
, dd->
node
);

342 ià(!
dd
->
dummy_Ãtdev
)

343  -
ENOMEM
;

345 
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

346 
´iv
->
dd
 = dd;

347 
	`idr_š™
(&
´iv
->
idr
);

348 
	`mu‹x_š™
(&
´iv
->
idr_lock
);

349 
	`©omic_£t
(&
´iv
->
’abËd
, 0);

350 
	`©omic_£t
(&
´iv
->
Ãtdevs
, 0);

353 
	}
}

355 
	$hfi1_Ãtdev_ä“
(
hfi1_devd©a
 *
dd
)

357 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

359 ià(
dd
->
dummy_Ãtdev
) {

360 
	`dd_dev_šfo
(
dd
, "hfi1‚etdev freed\n");

361 
	`idr_de¡roy
(&
´iv
->
idr
);

362 
	`mu‹x_de¡roy
(&
´iv
->
idr_lock
);

363 
	`kä“
(
dd
->
dummy_Ãtdev
);

364 
dd
->
dummy_Ãtdev
 = 
NULL
;

366 
	}
}

368 
	$hfi1_Ãtdev_’abË_queues
(
hfi1_devd©a
 *
dd
)

370 
hfi1_Ãtdev_´iv
 *
´iv
;

372 ià(!
dd
->
dummy_Ãtdev
)

375 
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

376 #ifdeà
©omic_ãtch_šc


377 ià(
	`©omic_ãtch_šc
(&
´iv
->
’abËd
))

379 ià(
	`©omic_šc_»tuº
(&
´iv
->
’abËd
) - 1)

383 
	`mu‹x_lock
(&
hfi1_mu‹x
);

384 
	`’abË_queues
(
´iv
);

385 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

386 
	}
}

388 
	$hfi1_Ãtdev_di§bË_queues
(
hfi1_devd©a
 *
dd
)

390 
hfi1_Ãtdev_´iv
 *
´iv
;

392 ià(!
dd
->
dummy_Ãtdev
)

395 
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

396 ià(
	`©omic_dec_if_pos™ive
(&
´iv
->
’abËd
))

399 
	`mu‹x_lock
(&
hfi1_mu‹x
);

400 
	`di§bË_queues
(
´iv
);

401 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

402 
	}
}

404 
	$hfi1_Ãtdev_add_d©a
(
hfi1_devd©a
 *
dd
, 
id
, *
d©a
)

406 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

407 
rc
;

409 
	`mu‹x_lock
(&
´iv
->
idr_lock
);

410 
rc
 = 
	`idr_®loc
(&
´iv
->
idr
, 
d©a
, 
id
, id + 1, 
GFP_NOWAIT
);

411 
	`mu‹x_uÆock
(&
´iv
->
idr_lock
);

412  
rc
;

413 
	}
}

415 
	$hfi1_Ãtdev_»move_d©a
(
hfi1_devd©a
 *
dd
, 
id
)

417 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

419 
	`mu‹x_lock
(&
´iv
->
idr_lock
);

420 
	`idr_»move
(&
´iv
->
idr
, 
id
);

421 
	`mu‹x_uÆock
(&
´iv
->
idr_lock
);

422 
	}
}

424 *
	$hfi1_Ãtdev_g‘_d©a
(
hfi1_devd©a
 *
dd
, 
id
)

426 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

427 *
p
;

429 
	`rcu_»ad_lock
();

430 
p
 = 
	`idr_fšd
(&
´iv
->
idr
, 
id
);

431 
	`rcu_»ad_uÆock
();

432  
p
;

433 
	}
}

435 *
	$hfi1_Ãtdev_g‘_fœ¡_d©a
(
hfi1_devd©a
 *
dd
, *
¡¬t_id
)

437 
hfi1_Ãtdev_´iv
 *
´iv
 = 
	`hfi1_Ãtdev_´iv
(
dd
->
dummy_Ãtdev
);

439  
	`idr_g‘_Ãxt
(&
´iv
->
idr
, 
¡¬t_id
);

440 
	}
}

	@opa_compat.h

1 #iâdeà
_LINUX_H


2 
	#_LINUX_H


	)

58 
	#OPA_ATTRIB_ID_CONGESTION_INFO
 
	`ýu_to_be16
(0x008b)

	)

59 
	#OPA_ATTRIB_ID_HFI_CONGESTION_LOG
 
	`ýu_to_be16
(0x008f)

	)

60 
	#OPA_ATTRIB_ID_HFI_CONGESTION_SETTING
 
	`ýu_to_be16
(0x0090)

	)

61 
	#OPA_ATTRIB_ID_CONGESTION_CONTROL_TABLE
 
	`ýu_to_be16
(0x0091)

	)

64 
	#OPA_PM_ATTRIB_ID_PORT_STATUS
 
	`ýu_to_be16
(0x0040)

	)

65 
	#OPA_PM_ATTRIB_ID_CLEAR_PORT_STATUS
 
	`ýu_to_be16
(0x0041)

	)

66 
	#OPA_PM_ATTRIB_ID_DATA_PORT_COUNTERS
 
	`ýu_to_be16
(0x0042)

	)

67 
	#OPA_PM_ATTRIB_ID_ERROR_PORT_COUNTERS
 
	`ýu_to_be16
(0x0043)

	)

68 
	#OPA_PM_ATTRIB_ID_ERROR_INFO
 
	`ýu_to_be16
(0x0044)

	)

71 
	#OPA_PM_STATUS_REQUEST_TOO_LARGE
 
	`ýu_to_be16
(0x100)

	)

73 
šlše
 
u8
 
	$pÜt_¡©es_to_logiÿl_¡©e
(
Ýa_pÜt_¡©es
 *
ps
)

75  
ps
->
pÜhys¡©e_pÜt¡©e
 & 
OPA_PI_MASK_PORT_STATE
;

76 
	}
}

78 
šlše
 
u8
 
	$pÜt_¡©es_to_phys_¡©e
(
Ýa_pÜt_¡©es
 *
ps
)

80  ((
ps
->
pÜhys¡©e_pÜt¡©e
 &

81 
OPA_PI_MASK_PORT_PHYSICAL_STATE
) >> 4) & 0xf;

82 
	}
}

95 
	eÝa_pÜt_phys_¡©e
 {

98 
	mIB_PORTPHYSSTATE_NOP
 = 0,

100 
	mIB_PORTPHYSSTATE_POLLING
 = 2,

101 
	mIB_PORTPHYSSTATE_DISABLED
 = 3,

102 
	mIB_PORTPHYSSTATE_TRAINING
 = 4,

103 
	mIB_PORTPHYSSTATE_LINKUP
 = 5,

104 
	mIB_PORTPHYSSTATE_LINK_ERROR_RECOVERY
 = 6,

105 
	mIB_PORTPHYSSTATE_PHY_TEST
 = 7,

113 
	mOPA_PORTPHYSSTATE_OFFLINE
 = 9,

122 
	mOPA_PORTPHYSSTATE_TEST
 = 11,

124 
	mOPA_PORTPHYSSTATE_MAX
 = 11,

	@opfn.c

47 
	~"hfi.h
"

48 
	~"Œaû.h
"

49 
	~"qp.h
"

51 
	#IB_BTHE_E
 
	`BIT
(
IB_BTHE_E_SHIFT
)

	)

53 
	#OPFN_CODE
(
code
è
	`BIT
((cod- 1))

	)

54 
	#OPFN_MASK
(
code
è
	`OPFN_CODE
(
STL_VERBS_EXTD_
##code)

	)

56 
	shfi1_Ýâ_ty³
 {

57 
boÞ
 (*
»que¡
)(
rvt_qp
 *
	mqp
, 
u64
 *
	md©a
);

58 
boÞ
 (*
»¥Ú£
)(
rvt_qp
 *
	mqp
, 
u64
 *
	md©a
);

59 
boÞ
 (*
»¶y
)(
rvt_qp
 *
	mqp
, 
u64
 
	md©a
);

60 (*
	m”rÜ
)(
rvt_qp
 *
	mqp
);

63 
hfi1_Ýâ_ty³
 
	ghfi1_Ýâ_hªdËrs
[
STL_VERBS_EXTD_MAX
] = {

65 { 
tid_rdma_cÚn_»q
, 
tid_rdma_cÚn_»¥
, 
tid_rdma_cÚn_»¶y
,

66 
tid_rdma_cÚn_”rÜ
 },

69 
Ýâ_scheduË_cÚn_»que¡
(
rvt_qp
 *
qp
);

71 
boÞ
 
	$hfi1_Ýâ_ex‹nded
(
u32
 
bth1
)

73  !!(
bth1
 & 
IB_BTHE_E
);

74 
	}
}

76 
	$Ýâ_cÚn_»que¡
(
rvt_qp
 *
qp
)

78 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

79 
ib_©omic_wr
 
wr
;

80 
u16
 
mask
, 
ÿpcode
;

81 
hfi1_Ýâ_ty³
 *
extd
;

82 
u64
 
d©a
;

83 
æags
;

84 
»t
 = 0;

86 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»que¡
(
qp
);

87 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

93 ià(!
´iv
->
Ýâ
.
ex‹nded
 || !´iv->Ýâ.
»que¡ed
 ||

94 
´iv
->
Ýâ
.
»que¡ed
 =ð´iv->Ýâ.
com¶‘ed
 ||…riv->Ýâ.
cu¼
)

95 
dÚe
;

97 
mask
 = 
´iv
->
Ýâ
.
»que¡ed
 & ~´iv->Ýâ.
com¶‘ed
;

98 
ÿpcode
 = 
	`žog2
(
mask
 & ~(mask - 1)) + 1;

99 ià(
ÿpcode
 >ð
STL_VERBS_EXTD_MAX
) {

100 
´iv
->
Ýâ
.
com¶‘ed
 |ð
	`OPFN_CODE
(
ÿpcode
);

101 
dÚe
;

104 
extd
 = &
hfi1_Ýâ_hªdËrs
[
ÿpcode
];

105 ià(!
extd
 || !extd->
»que¡
 || !extd->
	`»que¡
(
qp
, &
d©a
)) {

111 
´iv
->
Ýâ
.
com¶‘ed
 |ð
	`OPFN_CODE
(
ÿpcode
);

112 
dÚe
;

115 
	`Œaû_hfi1_Ýâ_d©a_cÚn_»que¡
(
qp
, 
ÿpcode
, 
d©a
);

116 
d©a
 = (d©¨& ~0xfè| 
ÿpcode
;

118 
	`mem£t
(&
wr
, 0, (wr));

119 
wr
.wr.
Ýcode
 = 
IB_WR_OPFN
;

120 
wr
.
»mÙe_addr
 = 
HFI1_VERBS_E_ATOMIC_VADDR
;

121 
wr
.
com·»_add
 = 
d©a
;

123 
´iv
->
Ýâ
.
cu¼
 = 
ÿpcode
;

125 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

127 
»t
 = 
	`ib_po¡_£nd
(&
qp
->
ibqp
, &
wr
.wr, 
NULL
);

128 ià(
»t
)

129 
”r
;

130 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»que¡
(
qp
);

132 
”r
:

133 
	`Œaû_hfi1_msg_Ýâ_cÚn_»que¡
(
qp
, "ib_ost_send failed:„et = ",

134 (
u64
)
»t
);

135 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

140 
´iv
->
Ýâ
.
cu¼
 = 
STL_VERBS_EXTD_NONE
;

141 
	`Ýâ_scheduË_cÚn_»que¡
(
qp
);

142 
dÚe
:

143 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

144 
	}
}

146 
	$Ýâ_£nd_cÚn_»que¡
(
wÜk_¡ruù
 *
wÜk
)

148 
hfi1_Ýâ_d©a
 *
od
;

149 
hfi1_qp_´iv
 *
q´iv
;

151 
od
 = 
	`cÚš”_of
(
wÜk
, 
hfi1_Ýâ_d©a
, 
Ýâ_wÜk
);

152 
q´iv
 = 
	`cÚš”_of
(
od
, 
hfi1_qp_´iv
, 
Ýâ
);

154 
	`Ýâ_cÚn_»que¡
(
q´iv
->
owÃr
);

155 
	}
}

162 
	$Ýâ_scheduË_cÚn_»que¡
(
rvt_qp
 *
qp
)

164 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

166 
	`Œaû_hfi1_Ýâ_¡©e_sched_cÚn_»que¡
(
qp
);

168 
	`scheduË_wÜk
(&
´iv
->
Ýâ
.
Ýâ_wÜk
);

169 
	}
}

171 
	$Ýâ_cÚn_»¥Ú£
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

172 
ib_©omic_‘h
 *
©‘h
)

174 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

175 
u64
 
d©a
 = 
	`be64_to_ýu
(
©‘h
->
com·»_d©a
);

176 
hfi1_Ýâ_ty³
 *
extd
;

177 
u8
 
ÿpcode
;

178 
æags
;

180 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»¥Ú£
(
qp
);

181 
ÿpcode
 = 
d©a
 & 0xf;

182 
	`Œaû_hfi1_Ýâ_d©a_cÚn_»¥Ú£
(
qp
, 
ÿpcode
, 
d©a
);

183 ià(!
ÿpcode
 || c­cod>ð
STL_VERBS_EXTD_MAX
)

186 
extd
 = &
hfi1_Ýâ_hªdËrs
[
ÿpcode
];

188 ià(!
extd
 || !extd->
»¥Ú£
) {

189 
e
->
©omic_d©a
 = 
ÿpcode
;

193 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

194 ià(
´iv
->
Ýâ
.
com¶‘ed
 & 
	`OPFN_CODE
(
ÿpcode
)) {

199 
´iv
->
Ýâ
.
com¶‘ed
 &ð~
	`OPFN_CODE
(
ÿpcode
);

200 ià(
extd
->
”rÜ
)

201 
extd
->
	`”rÜ
(
qp
);

204 ià(
extd
->
	`»¥Ú£
(
qp
, &
d©a
))

205 
´iv
->
Ýâ
.
com¶‘ed
 |ð
	`OPFN_CODE
(
ÿpcode
);

206 
e
->
©omic_d©a
 = (
d©a
 & ~0xfè| 
ÿpcode
;

207 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»¥Ú£
(
qp
);

208 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

209 
	}
}

211 
	$Ýâ_cÚn_»¶y
(
rvt_qp
 *
qp
, 
u64
 
d©a
)

213 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

214 
hfi1_Ýâ_ty³
 *
extd
;

215 
u8
 
ÿpcode
;

216 
æags
;

218 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»¶y
(
qp
);

219 
ÿpcode
 = 
d©a
 & 0xf;

220 
	`Œaû_hfi1_Ýâ_d©a_cÚn_»¶y
(
qp
, 
ÿpcode
, 
d©a
);

221 ià(!
ÿpcode
 || c­cod>ð
STL_VERBS_EXTD_MAX
)

224 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

229 ià(!
´iv
->
Ýâ
.
cu¼
 || 
ÿpcode
 !=…riv->opfn.curr)

230 
dÚe
;

232 
extd
 = &
hfi1_Ýâ_hªdËrs
[
ÿpcode
];

234 ià(!
extd
 || !extd->
»¶y
)

235 
þ—r
;

237 ià(
extd
->
	`»¶y
(
qp
, 
d©a
))

238 
´iv
->
Ýâ
.
com¶‘ed
 |ð
	`OPFN_CODE
(
ÿpcode
);

239 
þ—r
:

244 
´iv
->
Ýâ
.
cu¼
 = 
STL_VERBS_EXTD_NONE
;

245 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_»¶y
(
qp
);

246 
dÚe
:

247 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

248 
	}
}

250 
	$Ýâ_cÚn_”rÜ
(
rvt_qp
 *
qp
)

252 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

253 
hfi1_Ýâ_ty³
 *
extd
 = 
NULL
;

254 
æags
;

255 
u16
 
ÿpcode
;

257 
	`Œaû_hfi1_Ýâ_¡©e_cÚn_”rÜ
(
qp
);

263 
	`Œaû_hfi1_msg_Ýâ_cÚn_”rÜ
(
qp
, "”rÜ. q°¡©", (
u64
)qp->
¡©e
);

264 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

265 
´iv
->
Ýâ
.
com¶‘ed
) {

266 
ÿpcode
 = 
´iv
->
Ýâ
.
com¶‘ed
 & ~(priv->opfn.completed - 1);

267 
extd
 = &
hfi1_Ýâ_hªdËrs
[
	`žog2
(
ÿpcode
) + 1];

268 ià(
extd
->
”rÜ
)

269 
extd
->
	`”rÜ
(
qp
);

270 
´iv
->
Ýâ
.
com¶‘ed
 &ð~
	`OPFN_CODE
(
ÿpcode
);

272 
´iv
->
Ýâ
.
ex‹nded
 = 
çl£
;

273 
´iv
->
Ýâ
.
»que¡ed
 = 0;

274 
´iv
->
Ýâ
.
cu¼
 = 
STL_VERBS_EXTD_NONE
;

275 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

276 
	}
}

278 
	$Ýâ_š™
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
, 
©Œ_mask
)

280 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

281 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

282 
æags
;

284 ià(
©Œ_mask
 & 
IB_QP_RETRY_CNT
)

285 
´iv
->
s_»Œy
 = 
©Œ
->
»Œy_út
;

287 
	`¥š_lock_œq§ve
(&
´iv
->
Ýâ
.
lock
, 
æags
);

288 ià(
ibqp
->
qp_ty³
 =ð
IB_QPT_RC
 && 
	`HFI1_CAP_IS_KSET
(
TID_RDMA
)) {

289 
tid_rdma_·¿ms
 *
loÿl
 = &
´iv
->
tid_rdma
.local;

291 ià(
©Œ_mask
 & 
IB_QP_TIMEOUT
)

292 
´iv
->
tid_»Œy_timeout_jiff›s
 = 
qp
->
timeout_jiff›s
;

293 ià(
qp
->
pmtu
 =ð
	`’um_to_mtu
(
OPA_MTU_4096
) ||

294 
qp
->
pmtu
 =ð
	`’um_to_mtu
(
OPA_MTU_8192
)) {

295 
	`tid_rdma_Ýâ_š™
(
qp
, 
loÿl
);

300 ià(
©Œ_mask
 & 
IB_QP_STATE
 &&

301 
©Œ
->
qp_¡©e
 =ð
IB_QPS_RTS
) {

302 
´iv
->
Ýâ
.
»que¡ed
 |ð
	`OPFN_MASK
(
TID_RDMA
);

310 ià(
´iv
->
Ýâ
.
com¶‘ed
 &

311 
	`OPFN_MASK
(
TID_RDMA
)) {

312 
´iv
->
Ýâ
.
com¶‘ed
 &=

313 ~
	`OPFN_MASK
(
TID_RDMA
);

319 
	`Ýâ_scheduË_cÚn_»que¡
(
qp
);

323 
	`mem£t
(
loÿl
, 0, (*local));

326 
	`¥š_uÆock_œq»¡Üe
(&
´iv
->
Ýâ
.
lock
, 
æags
);

327 
	}
}

329 
	$Ýâ_Œigg”_cÚn_»que¡
(
rvt_qp
 *
qp
, 
u32
 
bth1
)

331 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

333 ià(!
´iv
->
Ýâ
.
ex‹nded
 && 
	`hfi1_Ýâ_ex‹nded
(
bth1
) &&

334 
	`HFI1_CAP_IS_KSET
(
OPFN
)) {

335 
´iv
->
Ýâ
.
ex‹nded
 = 
Œue
;

336 ià(
qp
->
¡©e
 =ð
IB_QPS_RTS
)

337 
	`Ýâ_cÚn_»que¡
(
qp
);

339 
	}
}

	@opfn.h

47 #iâdeà
_HFI1_OPFN_H


48 
	#_HFI1_OPFN_H


	)

50 
	~<lšux/wÜkqueue.h
>

51 
	~<rdma/ib_v”bs.h
>

52 
	~<rdma/rdmavt_qp.h
>

55 
	#IB_BTHE_E_SHIFT
 24

	)

56 
	#HFI1_VERBS_E_ATOMIC_VADDR
 
U64_MAX


	)

58 
	ehfi1_Ýâ_codes
 {

59 
	mSTL_VERBS_EXTD_NONE
 = 0,

60 
	mSTL_VERBS_EXTD_TID_RDMA
,

61 
	mSTL_VERBS_EXTD_MAX


64 
	shfi1_Ýâ_d©a
 {

65 
boÞ
 
	mex‹nded
;

66 
u16
 
	m»que¡ed
;

67 
u16
 
	mcom¶‘ed
;

68 
hfi1_Ýâ_codes
 
	mcu¼
;

70 
¥šlock_t
 
	mlock
;

71 
wÜk_¡ruù
 
	mÝâ_wÜk
;

75 
	#IB_WR_OPFN
 
IB_WR_RESERVED3


	)

77 
Ýâ_£nd_cÚn_»que¡
(
wÜk_¡ruù
 *
wÜk
);

78 
Ýâ_cÚn_»¥Ú£
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

79 
ib_©omic_‘h
 *
©‘h
);

80 
Ýâ_cÚn_»¶y
(
rvt_qp
 *
qp
, 
u64
 
d©a
);

81 
Ýâ_cÚn_”rÜ
(
rvt_qp
 *
qp
);

82 
Ýâ_š™
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
, 
©Œ_mask
);

83 
Ýâ_Œigg”_cÚn_»que¡
(
rvt_qp
 *
qp
, 
u32
 
bth1
);

	@pcie.c

48 
	~<lšux/pci.h
>

49 
	~<lšux/io.h
>

50 
	~<lšux/d–ay.h
>

51 
	~<lšux/vm®loc.h
>

52 
	~<lšux/«r.h
>

53 
	~<lšux/moduË.h
>

54 
	~"com·t_commÚ.h
"

56 
	~"hfi.h
"

57 
	~"ch_»gi¡”s.h
"

58 
	~"a¥m.h
"

67 
	$hfi1_pc›_š™
(
hfi1_devd©a
 *
dd
)

69 
»t
;

70 
«r
;

71 
u32
 
d©a
;

72 
pci_dev
 *
pdev
 = 
dd
->
pcidev
;

74 
»t
 = 
	`pci_’abË_deviû
(
pdev
);

75 ià(
»t
) {

88 
	`dd_dev_”r
(
dd
, "pc˜’abË fažed:ƒ¼Ü %d\n", -
»t
);

89  
»t
;

92 
»t
 = 
	`pci_»que¡_»giÚs
(
pdev
, 
DRIVER_NAME
);

93 ià(
»t
) {

94 
	`dd_dev_”r
(
dd
, "pci_»que¡_»giÚ çžs:ƒ¼ %d\n", -
»t
);

95 
baž
;

98 
»t
 = 
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64));

99 ià(
»t
) {

105 
»t
 = 
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

106 ià(
»t
) {

107 
	`dd_dev_”r
(
dd
, "UÇbËØ£ˆDMA mask: %d\n", 
»t
);

108 
baž
;

110 
»t
 = 
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

112 
»t
 = 
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64));

114 ià(
»t
) {

115 
	`dd_dev_”r
(
dd
, "UÇbËØ£ˆDMA cÚsi¡’ˆmask: %d\n", 
»t
);

116 
baž
;

119 
	`pci_£t_ma¡”
(
pdev
);

121 
«r
 = 
	`pci_fšd_ext_ÿ·bž™y
(
pdev
, 
PCI_EXT_CAP_ID_ERR
);

122 ià(!
«r
)

123  
«r
;

124 
	`pci_»ad_cÚfig_dwÜd
(
pdev
, 
«r
 + 
PCI_ERR_UNCOR_MASK
, &
d©a
);

125 ià(!(
d©a
 & 
PCI_ERR_UNC_UNSUP
)) {

126 
d©a
 |ð
PCI_ERR_UNC_UNSUP
;

127 ià(!
	`pci_wr™e_cÚfig_dwÜd
(
pdev
, 
«r
 + 
PCI_ERR_UNCOR_MASK
,

128 
d©a
))

129 
	`dd_dev_”r
(
dd
, "Masking Unsupported Requestƒrror\n");

132 ()
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

135 
baž
:

136 
	`hfi1_pc›_þ—nup
(
pdev
);

137  
»t
;

138 
	}
}

143 
	$hfi1_pc›_þ—nup
(
pci_dev
 *
pdev
)

145 
	`pci_di§bË_deviû
(
pdev
);

150 
	`pci_»Ëa£_»giÚs
(
pdev
);

151 
	}
}

158 
	$hfi1_pc›_ddš™
(
hfi1_devd©a
 *
dd
, 
pci_dev
 *
pdev
)

160 
Ën
;

161 
»sourû_size_t
 
addr
;

162 
»t
 = 0;

163 
u32
 
rcv_¬¿y_couÁ
;

165 
addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 0);

166 
Ën
 = 
	`pci_»sourû_Ën
(
pdev
, 0);

174 ià(
Ën
 !ð
TXE_PIO_SEND
 + 
TXE_PIO_SIZE
) {

175 
	`dd_dev_”r
(
dd
, "chip PIO„ange does‚ot match\n");

176  -
EINVAL
;

179 
dd
->
k»gba£1
 = 
	`iÜem­_noÿche
(
addr
, 
RCV_ARRAY
);

180 ià(!
dd
->
k»gba£1
) {

181 
	`dd_dev_”r
(
dd
, "UC mapping of kregbase1 failed\n");

182  -
ENOMEM
;

184 
	`dd_dev_šfo
(
dd
, "UC ba£1: %°fÜ %x\n", dd->
k»gba£1
, 
RCV_ARRAY
);

187 
dd
->
»visiÚ
 = 
	`»adq
(dd->
k»gba£1
 + 
CCE_REVISION
);

188 ià(
dd
->
»visiÚ
 =ð~(
u64
)0) {

189 
	`dd_dev_”r
(
dd
, "Cannot„ead chip CSRs\n");

190 
nomem
;

193 
rcv_¬¿y_couÁ
 = 
	`»adq
(
dd
->
k»gba£1
 + 
RCV_ARRAY_CNT
);

194 
	`dd_dev_šfo
(
dd
, "RcvA¼ay couÁ: %u\n", 
rcv_¬¿y_couÁ
);

195 
dd
->
ba£2_¡¬t
 = 
RCV_ARRAY
 + 
rcv_¬¿y_couÁ
 * 8;

197 
dd
->
k»gba£2
 = 
	`iÜem­_noÿche
(

198 
addr
 + 
dd
->
ba£2_¡¬t
,

199 
TXE_PIO_SEND
 - 
dd
->
ba£2_¡¬t
);

200 ià(!
dd
->
k»gba£2
) {

201 
	`dd_dev_”r
(
dd
, "UC mapping of kregbase2 failed\n");

202 
nomem
;

204 
	`dd_dev_šfo
(
dd
, "UC ba£2: %°fÜ %x\n", dd->
k»gba£2
,

205 
TXE_PIO_SEND
 - 
dd
->
ba£2_¡¬t
);

207 
dd
->
pioba£
 = 
	`iÜem­_wc
(
addr
 + 
TXE_PIO_SEND
, 
TXE_PIO_SIZE
);

208 ià(!
dd
->
pioba£
) {

209 
	`dd_dev_”r
(
dd
, "WC mapping of send buffers failed\n");

210 
nomem
;

212 
	`dd_dev_šfo
(
dd
, "WC…ioba£: %°fÜ %x\n", dd->
pioba£
, 
TXE_PIO_SIZE
);

214 
dd
->
phy§ddr
 = 
addr
;

220 
dd
->
rcv¬¿y_wc
 = 
	`iÜem­_wc
(
addr
 + 
RCV_ARRAY
,

221 
rcv_¬¿y_couÁ
 * 8);

222 ià(!
dd
->
rcv¬¿y_wc
) {

223 
	`dd_dev_”r
(
dd
, "WC mapping of„eceive‡rray failed\n");

224 
nomem
;

226 
	`dd_dev_šfo
(
dd
, "WC RcvArray: %p for %x\n",

227 
dd
->
rcv¬¿y_wc
, 
rcv_¬¿y_couÁ
 * 8);

229 
dd
->
æags
 |ð
HFI1_PRESENT
;

231 
nomem
:

232 
»t
 = -
ENOMEM
;

233 
	`hfi1_pc›_ddþ—nup
(
dd
);

234  
»t
;

235 
	}
}

242 
	$hfi1_pc›_ddþ—nup
(
hfi1_devd©a
 *
dd
)

244 
dd
->
æags
 &ð~
HFI1_PRESENT
;

245 ià(
dd
->
k»gba£1
)

246 
	`iounm­
(
dd
->
k»gba£1
);

247 
dd
->
k»gba£1
 = 
NULL
;

248 ià(
dd
->
k»gba£2
)

249 
	`iounm­
(
dd
->
k»gba£2
);

250 
dd
->
k»gba£2
 = 
NULL
;

251 ià(
dd
->
rcv¬¿y_wc
)

252 
	`iounm­
(
dd
->
rcv¬¿y_wc
);

253 
dd
->
rcv¬¿y_wc
 = 
NULL
;

254 ià(
dd
->
pioba£
)

255 
	`iounm­
(
dd
->
pioba£
);

256 
dd
->
pioba£
 = 
NULL
;

257 
	}
}

260 
u32
 
	$exŒaù_¥“d
(
u16
 
lšk¡©
)

262 
u32
 
¥“d
;

264 
lšk¡©
 & 
PCI_EXP_LNKSTA_CLS
) {

266 
PCI_EXP_LNKSTA_CLS_2_5GB
:

267 
¥“d
 = 2500;

269 
PCI_EXP_LNKSTA_CLS_5_0GB
:

270 
¥“d
 = 5000;

272 
PCI_EXP_LNKSTA_CLS_8_0GB
:

273 
¥“d
 = 8000;

276  
¥“d
;

277 
	}
}

280 
u32
 
	$exŒaù_width
(
u16
 
lšk¡©
)

282  (
lšk¡©
 & 
PCI_EXP_LNKSTA_NLW
è>> 
PCI_EXP_LNKSTA_NLW_SHIFT
;

283 
	}
}

286 
	$upd©e_lbus_šfo
(
hfi1_devd©a
 *
dd
)

288 
u16
 
lšk¡©
;

289 
»t
;

291 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKSTA
, &
lšk¡©
);

292 ià(
»t
) {

293 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

297 
dd
->
lbus_width
 = 
	`exŒaù_width
(
lšk¡©
);

298 
dd
->
lbus_¥“d
 = 
	`exŒaù_¥“d
(
lšk¡©
);

299 
	`¢´štf
(
dd
->
lbus_šfo
, (dd->lbus_info),

300 "PCIe,%uMHz,x%u", 
dd
->
lbus_¥“d
, dd->
lbus_width
);

301 
	}
}

307 
	$pc›_¥“ds
(
hfi1_devd©a
 *
dd
)

309 
u32
 
lškÿp
;

310 
pci_dev
 *
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

311 
»t
;

313 ià(!
	`pci_is_pc›
(
dd
->
pcidev
)) {

314 
	`dd_dev_”r
(
dd
, "Can't find PCI Express capability!\n");

315  -
EINVAL
;

319 
dd
->
lšk_g’3_ÿ·bË
 = 1;

321 
»t
 = 
	`pc›_ÿ·bž™y_»ad_dwÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCAP
, &
lškÿp
);

322 ià(
»t
) {

323 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

324  
»t
;

327 ià((
lškÿp
 & 
PCI_EXP_LNKCAP_SLS
è!ð
PCI_EXP_LNKCAP_SLS_8_0GB
) {

328 
	`dd_dev_šfo
(
dd
,

330 
lškÿp
 & 
PCI_EXP_LNKCAP_SLS
);

331 
dd
->
lšk_g’3_ÿ·bË
 = 0;

337 ià(
·»Á
 &&

338 (
dd
->
pcidev
->
bus
->
max_bus_¥“d
 =ð
PCIE_SPEED_2_5GT
 ||

339 
dd
->
pcidev
->
bus
->
max_bus_¥“d
 =ð
PCIE_SPEED_5_0GT
)) {

340 
	`dd_dev_šfo
(
dd
, "Parent PCIe bridge does‚ot support Gen3\n");

341 
dd
->
lšk_g’3_ÿ·bË
 = 0;

345 
	`upd©e_lbus_šfo
(
dd
);

347 
	`dd_dev_šfo
(
dd
, "%s\n", dd->
lbus_šfo
);

350 
	}
}

353 
	$»¡Üe_pci_v¬ŸbËs
(
hfi1_devd©a
 *
dd
)

355 
»t
 = 0;

357 
»t
 = 
	`pci_wr™e_cÚfig_wÜd
(
dd
->
pcidev
, 
PCI_COMMAND
, dd->
pci_commªd
);

358 ià(
»t
)

359 
”rÜ
;

361 
»t
 = 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_BASE_ADDRESS_0
,

362 
dd
->
pcib¬0
);

363 ià(
»t
)

364 
”rÜ
;

366 
»t
 = 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_BASE_ADDRESS_1
,

367 
dd
->
pcib¬1
);

368 ià(
»t
)

369 
”rÜ
;

371 
»t
 = 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_ROM_ADDRESS
, dd->
pci_rom
);

372 ià(
»t
)

373 
”rÜ
;

375 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
dd
->
pcidev
, 
PCI_EXP_DEVCTL
,

376 
dd
->
pc›_devùl
);

377 ià(
»t
)

378 
”rÜ
;

380 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL
,

381 
dd
->
pc›_Êkùl
);

382 ià(
»t
)

383 
”rÜ
;

385 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
dd
->
pcidev
, 
PCI_EXP_DEVCTL2
,

386 
dd
->
pc›_devùl2
);

387 ià(
»t
)

388 
”rÜ
;

390 
»t
 = 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_CFG_MSIX0
, dd->
pci_msix0
);

391 ià(
»t
)

392 
”rÜ
;

394 ià(
	`pci_fšd_ext_ÿ·bž™y
(
dd
->
pcidev
, 
PCI_EXT_CAP_ID_TPH
)) {

395 
»t
 = 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_TPH2
,

396 
dd
->
pci_h2
);

397 ià(
»t
)

398 
”rÜ
;

402 
”rÜ
:

403 
	`dd_dev_”r
(
dd
, "Unableo writeo PCI config\n");

404  
»t
;

405 
	}
}

408 
	$§ve_pci_v¬ŸbËs
(
hfi1_devd©a
 *
dd
)

410 
»t
 = 0;

412 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_BASE_ADDRESS_0
,

413 &
dd
->
pcib¬0
);

414 ià(
»t
)

415 
”rÜ
;

417 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_BASE_ADDRESS_1
,

418 &
dd
->
pcib¬1
);

419 ià(
»t
)

420 
”rÜ
;

422 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_ROM_ADDRESS
, &dd->
pci_rom
);

423 ià(
»t
)

424 
”rÜ
;

426 
»t
 = 
	`pci_»ad_cÚfig_wÜd
(
dd
->
pcidev
, 
PCI_COMMAND
, &dd->
pci_commªd
);

427 ià(
»t
)

428 
”rÜ
;

430 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_DEVCTL
,

431 &
dd
->
pc›_devùl
);

432 ià(
»t
)

433 
”rÜ
;

435 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL
,

436 &
dd
->
pc›_Êkùl
);

437 ià(
»t
)

438 
”rÜ
;

440 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_DEVCTL2
,

441 &
dd
->
pc›_devùl2
);

442 ià(
»t
)

443 
”rÜ
;

445 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCI_CFG_MSIX0
, &dd->
pci_msix0
);

446 ià(
»t
)

447 
”rÜ
;

449 ià(
	`pci_fšd_ext_ÿ·bž™y
(
dd
->
pcidev
, 
PCI_EXT_CAP_ID_TPH
)) {

450 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_TPH2
,

451 &
dd
->
pci_h2
);

452 ià(
»t
)

453 
”rÜ
;

457 
”rÜ
:

458 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

459  
»t
;

460 
	}
}

466 
	ghfi1_pc›_ÿps
;

467 
moduË_·¿m_Çmed
(
pc›_ÿps
, 
hfi1_pc›_ÿps
, , 0444);

468 
MODULE_PARM_DESC
(
pc›_ÿps
, "Max PCIeuning: Payload (0..3), ReadReq (4..7)");

475 
	$tuÃ_pc›_ÿps
(
hfi1_devd©a
 *
dd
)

477 
pci_dev
 *
·»Á
;

478 
u16
 
rc_mpss
, 
rc_mps
, 
•_mpss
, 
•_mps
;

479 
u16
 
rc_m¼s
, 
•_m¼s
, 
max_m¼s
, 
eùl
;

480 
»t
;

486 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_DEVCTL
, &
eùl
);

487 ià((!
»t
è&& !(
eùl
 & 
PCI_EXP_DEVCTL_EXT_TAG
)) {

488 
	`dd_dev_šfo
(
dd
, "Enabling PCIeƒxtendedags\n");

489 
eùl
 |ð
PCI_EXP_DEVCTL_EXT_TAG
;

490 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
dd
->
pcidev
,

491 
PCI_EXP_DEVCTL
, 
eùl
);

492 ià(
»t
)

493 
	`dd_dev_šfo
(
dd
, "Unableo writeo PCI config\n");

496 
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

501 ià(!
·»Á
) {

502 
	`dd_dev_šfo
(
dd
, "Parent‚ot found\n");

505 ià(!
	`pci_is_roÙ_bus
(
·»Á
->
bus
)) {

506 
	`dd_dev_šfo
(
dd
, "Parent‚ot„oot\n");

509 ià(!
	`pci_is_pc›
(
·»Á
)) {

510 
	`dd_dev_šfo
(
dd
, "Parent is‚ot PCI Express capable\n");

513 ià(!
	`pci_is_pc›
(
dd
->
pcidev
)) {

514 
	`dd_dev_šfo
(
dd
, "PCI device is‚ot PCI Express capable\n");

517 
rc_mpss
 = 
·»Á
->
pc›_mpss
;

518 
rc_mps
 = 
	`ffs
(
	`pc›_g‘_mps
(
·»Á
)) - 8;

520 
•_mpss
 = 
dd
->
pcidev
->
pc›_mpss
;

521 
•_mps
 = 
	`ffs
(
	`pc›_g‘_mps
(
dd
->
pcidev
)) - 8;

524 ià(
rc_mpss
 > 
•_mpss
)

525 
rc_mpss
 = 
•_mpss
;

528 ià(
rc_mpss
 > (
hfi1_pc›_ÿps
 & 7))

529 
rc_mpss
 = 
hfi1_pc›_ÿps
 & 7;

531 ià(
rc_mpss
 > 
rc_mps
) {

532 
rc_mps
 = 
rc_mpss
;

533 
	`pc›_£t_mps
(
·»Á
, 128 << 
rc_mps
);

536 ià(
rc_mpss
 > 
•_mps
) {

537 
•_mps
 = 
rc_mpss
;

538 
	`pc›_£t_mps
(
dd
->
pcidev
, 128 << 
•_mps
);

546 
max_m¼s
 = 5;

547 ià(
max_m¼s
 > ((
hfi1_pc›_ÿps
 >> 4) & 7))

548 
max_m¼s
 = (
hfi1_pc›_ÿps
 >> 4) & 7;

550 
max_m¼s
 = 128 << max_mrrs;

551 
rc_m¼s
 = 
	`pc›_g‘_»adrq
(
·»Á
);

552 
•_m¼s
 = 
	`pc›_g‘_»adrq
(
dd
->
pcidev
);

554 ià(
max_m¼s
 > 
rc_m¼s
) {

555 
rc_m¼s
 = 
max_m¼s
;

556 
	`pc›_£t_»adrq
(
·»Á
, 
rc_m¼s
);

558 ià(
max_m¼s
 > 
•_m¼s
) {

559 
•_m¼s
 = 
max_m¼s
;

560 
	`pc›_£t_»adrq
(
dd
->
pcidev
, 
•_m¼s
);

562 
	}
}

570 
pci_”s_»suÉ_t


571 
	$pci_”rÜ_d‘eùed
(
pci_dev
 *
pdev
, 
pci_chªÃl_¡©e_t
 
¡©e
)

573 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

574 
pci_”s_»suÉ_t
 
»t
 = 
PCI_ERS_RESULT_RECOVERED
;

576 
¡©e
) {

577 
pci_chªÃl_io_nÜm®
:

578 
	`dd_dev_šfo
(
dd
, "State Normal, ignoring\n");

581 
pci_chªÃl_io_äoz’
:

582 
	`dd_dev_šfo
(
dd
, "State Frozen,„equesting„eset\n");

583 
	`pci_di§bË_deviû
(
pdev
);

584 
»t
 = 
PCI_ERS_RESULT_NEED_RESET
;

587 
pci_chªÃl_io_³rm_çžu»
:

588 ià(
dd
) {

589 
	`dd_dev_šfo
(
dd
, "State Permanent Failure, disabling\n");

591 
dd
->
æags
 &ð~
HFI1_PRESENT
;

592 
	`hfi1_di§bË_aá”_”rÜ
(
dd
);

595 
»t
 = 
PCI_ERS_RESULT_DISCONNECT
;

599 
	`dd_dev_šfo
(
dd
, "HFI1 PCIƒrrors detected (state %d)\n",

600 
¡©e
);

603  
»t
;

604 
	}
}

606 
pci_”s_»suÉ_t


607 
	$pci_mmio_’abËd
(
pci_dev
 *
pdev
)

609 
u64
 
wÜds
 = 0U;

610 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

611 
pci_”s_»suÉ_t
 
»t
 = 
PCI_ERS_RESULT_RECOVERED
;

613 ià(
dd
 && dd->
µÜt
) {

614 
wÜds
 = 
	`»ad_pÜt_úŒ
(
dd
->
µÜt
, 
C_RX_WORDS
, 
CNTR_INVALID_VL
);

615 ià(
wÜds
 == ~0ULL)

616 
»t
 = 
PCI_ERS_RESULT_NEED_RESET
;

617 
	`dd_dev_šfo
(
dd
,

619 
wÜds
, 
»t
);

621  
»t
;

622 
	}
}

624 
pci_”s_»suÉ_t


625 
	$pci_¦Ù_»£t
(
pci_dev
 *
pdev
)

627 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

629 
	`dd_dev_šfo
(
dd
, "HFI1 slot_reset function called, ignored\n");

630  
PCI_ERS_RESULT_CAN_RECOVER
;

631 
	}
}

634 
	$pci_»sume
(
pci_dev
 *
pdev
)

636 
hfi1_devd©a
 *
dd
 = 
	`pci_g‘_drvd©a
(
pdev
);

638 
	`dd_dev_šfo
(
dd
, "HFI1„esume function called\n");

639 #iâdeà
HAVE_PCI_CORE_AER_CLEAR


640 
	`pci_þ—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

647 
	`hfi1_š™
(
dd
, 1);

648 
	}
}

650 cÚ¡ 
pci_”rÜ_hªdËrs
 
	ghfi1_pci_”r_hªdËr
 = {

651 .
”rÜ_d‘eùed
 = 
pci_”rÜ_d‘eùed
,

652 .
	gmmio_’abËd
 = 
pci_mmio_’abËd
,

653 .
	g¦Ù_»£t
 = 
pci_¦Ù_»£t
,

654 .
	g»sume
 = 
pci_»sume
,

667 
	#DL_STATUS_HFI0
 0x1

	)

668 
	#DL_STATUS_HFI1
 0x2

	)

669 
	#DL_STATUS_BOTH
 0x3

	)

672 
	#DL_ERR_NONE
 0x0

	)

673 
	#DL_ERR_SWAP_PARITY
 0x1

	)

675 
	#DL_ERR_DISABLED
 0x2

	)

676 
	#DL_ERR_SECURITY
 0x3

	)

677 
	#DL_ERR_SBUS
 0x4

	)

678 
	#DL_ERR_XFR_PARITY
 0x5

	)

681 
	#SBR_DELAY_US
 200000

	)

683 
ušt
 
	gpc›_rg‘
 = 3;

684 
moduË_·¿m
(
pc›_rg‘
, 
ušt
, 
S_IRUGO
);

685 
MODULE_PARM_DESC
(
pc›_rg‘
, "PCIearget speed (0 skip, 1-3 Gen1-3)");

687 
ušt
 
	gpc›_fÜû
;

688 
moduË_·¿m
(
pc›_fÜû
, 
ušt
, 
S_IRUGO
);

689 
MODULE_PARM_DESC
(
pc›_fÜû
, "Force drivero do‡ PCIe firmware downloadƒven if‡lready‡target speed");

691 
ušt
 
	gpc›_»Œy
 = 5;

692 
moduË_·¿m
(
pc›_»Œy
, 
ušt
, 
S_IRUGO
);

693 
MODULE_PARM_DESC
(
pc›_»Œy
, "Driver willryhis manyimeso„each„equested speed");

695 
	#UNSET_PSET
 255

	)

696 
	#DEFAULT_DISCRETE_PSET
 2

	)

697 
	#DEFAULT_MCP_PSET
 6

	)

698 
ušt
 
	gpc›_p£t
 = 
UNSET_PSET
;

699 
moduË_·¿m
(
pc›_p£t
, 
ušt
, 
S_IRUGO
);

700 
MODULE_PARM_DESC
(
pc›_p£t
, "PCIe Eq Pset valueo use,„ange is 0-10");

702 
ušt
 
	gpc›_ùË
 = 3;

703 
moduË_·¿m
(
pc›_ùË
, 
ušt
, 
S_IRUGO
);

704 
MODULE_PARM_DESC
(
pc›_ùË
, "PCIe static CTLE mode, bit 0 - discrete on/off, bit 1 - integrated on/off");

707 
	#PREC
 0

	)

708 
	#ATTN
 1

	)

709 
	#POST
 2

	)

712 cÚ¡ 
u8
 
	gdisü‘e_´–imš¬y_eq
[11][3] = {

728 cÚ¡ 
u8
 
	gš‹g¿‹d_´–imš¬y_eq
[11][3] = {

743 cÚ¡ 
u8
 
	gdisü‘e_ùË_tunšgs
[11][4] = {

758 cÚ¡ 
u8
 
	gš‹g¿‹d_ùË_tunšgs
[11][4] = {

774 
	#eq_v®ue
(
´e
, 
cu¼
, 
po¡
) \

775 ((((
u32
)(
´e
)) << \

776 
PCIE_CFG_REG_PL102_GEN3_EQ_PRE_CURSOR_PSET_SHIFT
) \

777 | (((
u32
)(
cu¼
)è<< 
PCIE_CFG_REG_PL102_GEN3_EQ_CURSOR_PSET_SHIFT
) \

778 | (((
u32
)(
po¡
)) << \

779 
PCIE_CFG_REG_PL102_GEN3_EQ_POST_CURSOR_PSET_SHIFT
))

	)

784 
	$lßd_eq_bË
(
hfi1_devd©a
 *
dd
, cÚ¡ 
u8
 
eq
[11][3], u8 
fs
,

785 
u8
 
div
)

787 
pci_dev
 *
pdev
 = 
dd
->
pcidev
;

788 
u32
 
h™_”rÜ
 = 0;

789 
u32
 
viÞ©iÚ
;

790 
u32
 
i
;

791 
u8
 
c_mšus1
, 
c0
, 
c_¶us1
;

792 
»t
;

794 
i
 = 0; i < 11; i++) {

796 
	`pci_wr™e_cÚfig_dwÜd
(
pdev
, 
PCIE_CFG_REG_PL103
, 
i
);

798 
c_mšus1
 = 
eq
[
i
][
PREC
] / 
div
;

799 
c0
 = 
fs
 - (
eq
[
i
][
PREC
] / 
div
è- (eq[i][
POST
] / div);

800 
c_¶us1
 = 
eq
[
i
][
POST
] / 
div
;

801 
	`pci_wr™e_cÚfig_dwÜd
(
pdev
, 
PCIE_CFG_REG_PL102
,

802 
	`eq_v®ue
(
c_mšus1
, 
c0
, 
c_¶us1
));

804 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
,

805 
PCIE_CFG_REG_PL105
, &
viÞ©iÚ
);

806 ià(
»t
) {

807 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

808 
h™_”rÜ
 = 1;

812 ià(
viÞ©iÚ


813 & 
PCIE_CFG_REG_PL105_GEN3_EQ_VIOLATE_COEF_RULES_SMASK
){

814 ià(
h™_”rÜ
 == 0) {

815 
	`dd_dev_”r
(
dd
,

817 
	`dd_dev_”r
(
dd
, "…rec‡ttn…ost\n");

819 
	`dd_dev_”r
(
dd
, "…%02d: %02x %02x %02x\n",

820 
i
, (
u32
)
eq
[i][0], (u32)eq[i][1],

821 (
u32
)
eq
[
i
][2]);

822 
	`dd_dev_”r
(
dd
, " %02x %02x %02x\n",

823 (
u32
)
c_mšus1
, (u32)
c0
, (u32)
c_¶us1
);

824 
h™_”rÜ
 = 1;

827 ià(
h™_”rÜ
)

828  -
EINVAL
;

830 
	}
}

837 
	$pc›_po¡_¡•s
(
hfi1_devd©a
 *
dd
)

839 
i
;

841 
	`£t_sbus_ç¡_mode
(
dd
);

849 
i
 = 0; i < 
NUM_PCIE_SERDES
; i++) {

850 
	`sbus_»que¡
(
dd
, 
pc›_pcs_addrs
[dd->
hfi1_id
][
i
],

851 0x03, 
WRITE_SBUS_RECEIVER
, 0x00022132);

854 
	`þ—r_sbus_ç¡_mode
(
dd
);

855 
	}
}

863 
	$Œigg”_sbr
(
hfi1_devd©a
 *
dd
)

865 
pci_dev
 *
dev
 = 
dd
->
pcidev
;

866 
pci_dev
 *
pdev
;

869 ià(!
dev
->
bus
->
£lf
) {

870 
	`dd_dev_”r
(
dd
, "%s:‚Ø·»Á deviû\n", 
__func__
);

871  -
ENOTTY
;

875 
	`li¡_fÜ_—ch_’Œy
(
pdev
, &
dev
->
bus
->
deviûs
, 
bus_li¡
)

876 ià(
pdev
 !ð
dev
) {

877 
	`dd_dev_”r
(
dd
,

879 
__func__
);

880  -
ENOTTY
;

888  
	`pci_bridge_£cÚd¬y_bus_»£t
(
dev
->
bus
->
£lf
);

889 
	}
}

894 
	$wr™e_gask‘_š‹¼u±
(
hfi1_devd©a
 *
dd
, 
šdex
,

895 
u16
 
code
, u16 
d©a
)

897 
	`wr™e_c¤
(
dd
, 
ASIC_PCIE_SD_INTRPT_LIST
 + (
šdex
 * 8),

898 (((
u64
)
code
 << 
ASIC_PCIE_SD_INTRPT_LIST_INTRPT_CODE_SHIFT
) |

899 ((
u64
)
d©a
 << 
ASIC_PCIE_SD_INTRPT_LIST_INTRPT_DATA_SHIFT
)));

900 
	}
}

905 
	$¬m_gask‘_logic
(
hfi1_devd©a
 *
dd
)

907 
u64
 
»g
;

909 
»g
 = (((
u64
)1 << 
dd
->
hfi1_id
) <<

910 
ASIC_PCIE_SD_HOST_CMD_INTRPT_CMD_SHIFT
) |

911 ((
u64
)
pc›_£rdes_brßdÿ¡
[
dd
->
hfi1_id
] <<

912 
ASIC_PCIE_SD_HOST_CMD_SBUS_RCVR_ADDR_SHIFT
 |

913 
ASIC_PCIE_SD_HOST_CMD_SBR_MODE_SMASK
 |

914 ((
u64
)
SBR_DELAY_US
 & 
ASIC_PCIE_SD_HOST_CMD_TIMER_MASK
) <<

915 
ASIC_PCIE_SD_HOST_CMD_TIMER_SHIFT
);

916 
	`wr™e_c¤
(
dd
, 
ASIC_PCIE_SD_HOST_CMD
, 
»g
);

918 
	`»ad_c¤
(
dd
, 
ASIC_PCIE_SD_HOST_CMD
);

919 
	}
}

926 
	#LANE_BUNDLE_MASK
 
CCE_PCIE_CTRL_PCIE_LANE_BUNDLE_MASK


	)

927 
	#LANE_BUNDLE_SHIFT
 
CCE_PCIE_CTRL_PCIE_LANE_BUNDLE_SHIFT


	)

928 
	#LANE_DELAY_MASK
 
CCE_PCIE_CTRL_PCIE_LANE_DELAY_MASK


	)

929 
	#LANE_DELAY_SHIFT
 
CCE_PCIE_CTRL_PCIE_LANE_DELAY_SHIFT


	)

930 
	#MARGIN_OVERWRITE_ENABLE_SHIFT
 
CCE_PCIE_CTRL_XMT_MARGIN_OVERWRITE_ENABLE_SHIFT


	)

931 
	#MARGIN_SHIFT
 
CCE_PCIE_CTRL_XMT_MARGIN_SHIFT


	)

932 
	#MARGIN_G1_G2_OVERWRITE_MASK
 
CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_OVERWRITE_ENABLE_MASK


	)

933 
	#MARGIN_G1_G2_OVERWRITE_SHIFT
 
CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_OVERWRITE_ENABLE_SHIFT


	)

934 
	#MARGIN_GEN1_GEN2_MASK
 
CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_MASK


	)

935 
	#MARGIN_GEN1_GEN2_SHIFT
 
CCE_PCIE_CTRL_XMT_MARGIN_GEN1_GEN2_SHIFT


	)

940 
	$wr™e_xmt_m¬gš
(
hfi1_devd©a
 *
dd
, cÚ¡ *
âame
)

942 
u64
 
pc›_ù¾
;

943 
u64
 
xmt_m¬gš
;

944 
u64
 
xmt_m¬gš_Û
;

945 
u64
 
ÏÃ_d–ay
;

946 
u64
 
ÏÃ_bundË
;

948 
pc›_ù¾
 = 
	`»ad_c¤
(
dd
, 
CCE_PCIE_CTRL
);

958 ià(
dd
->
pcidev
->
deviû
 =ð
PCI_DEVICE_ID_INTEL1
) {

960 
xmt_m¬gš
 = (
pc›_ù¾
 >> 
MARGIN_GEN1_GEN2_SHIFT
)

961 & 
MARGIN_GEN1_GEN2_MASK
;

962 
xmt_m¬gš_Û
 = (
pc›_ù¾
 >> 
MARGIN_G1_G2_OVERWRITE_SHIFT
)

963 & 
MARGIN_G1_G2_OVERWRITE_MASK
;

964 
ÏÃ_d–ay
 = (
pc›_ù¾
 >> 
LANE_DELAY_SHIFT
è& 
LANE_DELAY_MASK
;

965 
ÏÃ_bundË
 = (
pc›_ù¾
 >> 
LANE_BUNDLE_SHIFT
)

966 & 
LANE_BUNDLE_MASK
;

972 ià(
	`is_ax
(
dd
)) {

977 
xmt_m¬gš
 = 0x5;

978 
xmt_m¬gš_Û
 = 0x1;

979 
ÏÃ_d–ay
 = 0xF;

980 
ÏÃ_bundË
 = 0x0;

984 
pc›_ù¾
 = (
xmt_m¬gš
 << 
MARGIN_GEN1_GEN2_SHIFT
)

985 | (
xmt_m¬gš_Û
 << 
MARGIN_G1_G2_OVERWRITE_SHIFT
)

986 | (
xmt_m¬gš
 << 
MARGIN_SHIFT
)

987 | (
xmt_m¬gš_Û
 << 
MARGIN_OVERWRITE_ENABLE_SHIFT
)

988 | (
ÏÃ_d–ay
 << 
LANE_DELAY_SHIFT
)

989 | (
ÏÃ_bundË
 << 
LANE_BUNDLE_SHIFT
);

991 
	`wr™e_c¤
(
dd
, 
CCE_PCIE_CTRL
, 
pc›_ù¾
);

994 
	`dd_dev_dbg
(
dd
, "%s:…rogram XMT margin, CcePcieCtrl 0x%llx\n",

995 
âame
, 
pc›_ù¾
);

996 
	}
}

1001 
	$do_pc›_g’3_Œªs™iÚ
(
hfi1_devd©a
 *
dd
)

1003 
pci_dev
 *
·»Á
 = 
dd
->
pcidev
->
bus
->
£lf
;

1004 
u64
 
fw_ù¾
;

1005 
u64
 
»g
, 
th”m
;

1006 
u32
 
»g32
, 
fs
, 
lf
;

1007 
u32
 
¡©us
, 
”r
;

1008 
»t
;

1009 
do_»Œy
, 
»Œy_couÁ
 = 0;

1010 
šŠum
 = 0;

1011 
ušt
 
deçuÉ_p£t
;

1012 
ušt
 
p£t
 = 
pc›_p£t
;

1013 
u16
 
rg‘_veùÜ
, 
rg‘_¥“d
;

1014 
u16
 
Êkùl2
, 
v’dÜ
;

1015 
u8
 
div
;

1016 cÚ¡ 
	`u8
 (*
eq
)[3];

1017 cÚ¡ 
	`u8
 (*
ùË_tunšgs
)[4];

1018 
ušt
 
¡©ic_ùË_mode
;

1019 
»tuº_”rÜ
 = 0;

1020 
u32
 
rg‘_width
;

1023 ià(
dd
->
icode
 !ð
ICODE_RTL_SILICON
)

1026 ià(
pc›_rg‘
 == 1) {

1027 
rg‘_veùÜ
 = 
PCI_EXP_LNKCTL2_TLS_2_5GT
;

1028 
rg‘_¥“d
 = 2500;

1029 } ià(
pc›_rg‘
 == 2) {

1030 
rg‘_veùÜ
 = 
PCI_EXP_LNKCTL2_TLS_5_0GT
;

1031 
rg‘_¥“d
 = 5000;

1032 } ià(
pc›_rg‘
 == 3) {

1033 
rg‘_veùÜ
 = 
PCI_EXP_LNKCTL2_TLS_8_0GT
;

1034 
rg‘_¥“d
 = 8000;

1037 
	`dd_dev_šfo
(
dd
, "%s: Skpšg PCIŒªs™iÚ\n", 
__func__
);

1042 ià(
dd
->
lbus_¥“d
 =ð
rg‘_¥“d
) {

1043 
	`dd_dev_šfo
(
dd
, "%s: PCI®»ady‡ˆg’%d, %s\n", 
__func__
,

1044 
pc›_rg‘
,

1045 
pc›_fÜû
 ? "re-doing‡nyway" : "skipping");

1046 ià(!
pc›_fÜû
)

1054 ià(!
·»Á
) {

1055 
	`dd_dev_šfo
(
dd
, "%s: No upstream, Can't do gen3ransition\n",

1056 
__func__
);

1061 
rg‘_width
 = 
dd
->
lbus_width
;

1071 ià(
pc›_rg‘
 =ð3 && !
dd
->
lšk_g’3_ÿ·bË
) {

1072 
	`dd_dev_”r
(
dd
, "The PCIe†ink is‚ot Gen3 capable\n");

1073 
»t
 = -
ENOSYS
;

1074 
dÚe_no_mu‹x
;

1078 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
CR_SBUS
, 
SBUS_TIMEOUT
);

1079 ià(
»t
) {

1080 
	`dd_dev_”r
(
dd
, "%s: unableo‡cquire SBus„esource\n",

1081 
__func__
);

1082  
»t
;

1086 
th”m
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_THERM_POLL_EN
);

1087 ià(
th”m
) {

1088 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_THERM_POLL_EN
, 0x0);

1089 
	`m¦“p
(100);

1090 
	`dd_dev_šfo
(
dd
, "%s: Disabledherm…olling\n",

1091 
__func__
);

1094 
»Œy
:

1099 
	`dd_dev_šfo
(
dd
, "%s: dowÆßdšg fœmw¬e\n", 
__func__
);

1100 
»t
 = 
	`lßd_pc›_fœmw¬e
(
dd
);

1101 ià(
»t
) {

1103 
»tuº_”rÜ
 = 1;

1104 
dÚe
;

1108 
	`dd_dev_šfo
(
dd
, "%s: s‘tšg PCI»gi¡”s\n", 
__func__
);

1118 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_SPCIE2
, 0xffff);

1128 
»g32
 = 0x10uÈ<< 
PCIE_CFG_REG_PL2_LOW_PWR_ENT_CNT_SHIFT
;

1129 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL2
, 
»g32
);

1138 
»g32
 = 
PCIE_CFG_REG_PL100_EQ_EIEOS_CNT_SMASK
;

1139 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL100
, 
»g32
);

1149 ià(
dd
->
pcidev
->
deviû
 =ð
PCI_DEVICE_ID_INTEL0
) {

1151 
fs
 = 24;

1152 
lf
 = 8;

1153 
div
 = 3;

1154 
eq
 = 
disü‘e_´–imš¬y_eq
;

1155 
deçuÉ_p£t
 = 
DEFAULT_DISCRETE_PSET
;

1156 
ùË_tunšgs
 = 
disü‘e_ùË_tunšgs
;

1158 
¡©ic_ùË_mode
 = 
pc›_ùË
 & 0x1;

1161 
fs
 = 29;

1162 
lf
 = 9;

1163 
div
 = 1;

1164 
eq
 = 
š‹g¿‹d_´–imš¬y_eq
;

1165 
deçuÉ_p£t
 = 
DEFAULT_MCP_PSET
;

1166 
ùË_tunšgs
 = 
š‹g¿‹d_ùË_tunšgs
;

1168 
¡©ic_ùË_mode
 = (
pc›_ùË
 >> 1) & 0x1;

1170 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL101
,

1171 (
fs
 <<

1172 
PCIE_CFG_REG_PL101_GEN3_EQ_LOCAL_FS_SHIFT
) |

1173 (
lf
 <<

1174 
PCIE_CFG_REG_PL101_GEN3_EQ_LOCAL_LF_SHIFT
));

1175 
»t
 = 
	`lßd_eq_bË
(
dd
, 
eq
, 
fs
, 
div
);

1176 ià(
»t
)

1177 
dÚe
;

1184 ià(
p£t
 =ð
UNSET_PSET
)

1185 
p£t
 = 
deçuÉ_p£t
;

1186 ià(
p£t
 > 10) {

1187 
	`dd_dev_”r
(
dd
, "%s: Invalid Eq Pset %u, settingo %d\n",

1188 
__func__
, 
p£t
, 
deçuÉ_p£t
);

1189 
p£t
 = 
deçuÉ_p£t
;

1191 
	`dd_dev_šfo
(
dd
, "%s: usšg EQ P£ˆ%u\n", 
__func__
, 
p£t
);

1192 
	`pci_wr™e_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_REG_PL106
,

1193 ((1 << 
p£t
) <<

1194 
PCIE_CFG_REG_PL106_GEN3_EQ_PSET_REQ_VEC_SHIFT
) |

1195 
PCIE_CFG_REG_PL106_GEN3_EQ_EVAL2MS_DISABLE_SMASK
 |

1196 
PCIE_CFG_REG_PL106_GEN3_EQ_PHASE23_EXIT_MODE_SMASK
);

1201 
	`dd_dev_šfo
(
dd
, "%s: došg…c›…o¡ s‹ps\n", 
__func__
);

1202 
	`pc›_po¡_¡•s
(
dd
);

1208 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0006, 0x0050);

1211 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026,

1212 0x5b01 | (
¡©ic_ùË_mode
 << 3));

1217 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026, 0x5202);

1219 ià(
¡©ic_ùË_mode
) {

1221 
u8
 
pc›_dc
, 
pc›_lf
, 
pc›_hf
, 
pc›_bw
;

1223 
pc›_dc
 = 
ùË_tunšgs
[
p£t
][0];

1224 
pc›_lf
 = 
ùË_tunšgs
[
p£t
][1];

1225 
pc›_hf
 = 
ùË_tunšgs
[
p£t
][2];

1226 
pc›_bw
 = 
ùË_tunšgs
[
p£t
][3];

1227 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026, 0x0200 | 
pc›_dc
);

1228 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026, 0x0100 | 
pc›_lf
);

1229 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026, 0x0000 | 
pc›_hf
);

1230 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0026, 0x5500 | 
pc›_bw
);

1234 
	`wr™e_gask‘_š‹¼u±
(
dd
, 
šŠum
++, 0x0000, 0x0000);

1239 
	`wr™e_xmt_m¬gš
(
dd
, 
__func__
);

1245 
	`dd_dev_šfo
(
dd
, "%s: cË¬šg ASPM\n", 
__func__
);

1246 
	`a¥m_hw_di§bË_l1
(
dd
);

1264 
	`dd_dev_šfo
(
dd
, "%s: s‘tšg…¬’ˆrg‘†šk s³ed\n", 
__func__
);

1265 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
·»Á
, 
PCI_EXP_LNKCTL2
, &
Êkùl2
);

1266 ià(
»t
) {

1267 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

1268 
»tuº_”rÜ
 = 1;

1269 
dÚe
;

1272 
	`dd_dev_šfo
(
dd
, "%s: ..Þd†šk cÚŒÞ2: 0x%x\n", 
__func__
,

1273 (
u32
)
Êkùl2
);

1275 ià((
Êkùl2
 & 
PCI_EXP_LNKCTL2_TLS
è< 
rg‘_veùÜ
) {

1276 
Êkùl2
 &ð~
PCI_EXP_LNKCTL2_TLS
;

1277 
Êkùl2
 |ð
rg‘_veùÜ
;

1278 
	`dd_dev_šfo
(
dd
, "%s: ..Ãw†šk cÚŒÞ2: 0x%x\n", 
__func__
,

1279 (
u32
)
Êkùl2
);

1280 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
·»Á
,

1281 
PCI_EXP_LNKCTL2
, 
Êkùl2
);

1282 ià(
»t
) {

1283 
	`dd_dev_”r
(
dd
, "Unableo writeo PCI config\n");

1284 
»tuº_”rÜ
 = 1;

1285 
dÚe
;

1288 
	`dd_dev_šfo
(
dd
, "%s: ..rg‘ s³ed i OK\n", 
__func__
);

1291 
	`dd_dev_šfo
(
dd
, "%s: s‘tšg¬g‘†šk s³ed\n", 
__func__
);

1292 
»t
 = 
	`pc›_ÿ·bž™y_»ad_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL2
, &
Êkùl2
);

1293 ià(
»t
) {

1294 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

1295 
»tuº_”rÜ
 = 1;

1296 
dÚe
;

1299 
	`dd_dev_šfo
(
dd
, "%s: ..Þd†šk cÚŒÞ2: 0x%x\n", 
__func__
,

1300 (
u32
)
Êkùl2
);

1301 
Êkùl2
 &ð~
PCI_EXP_LNKCTL2_TLS
;

1302 
Êkùl2
 |ð
rg‘_veùÜ
;

1303 
	`dd_dev_šfo
(
dd
, "%s: ..Ãw†šk cÚŒÞ2: 0x%x\n", 
__func__
,

1304 (
u32
)
Êkùl2
);

1305 
»t
 = 
	`pc›_ÿ·bž™y_wr™e_wÜd
(
dd
->
pcidev
, 
PCI_EXP_LNKCTL2
, 
Êkùl2
);

1306 ià(
»t
) {

1307 
	`dd_dev_”r
(
dd
, "Unableo writeo PCI config\n");

1308 
»tuº_”rÜ
 = 1;

1309 
dÚe
;

1314 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 
CCE_DC_CTRL_DC_RESET_SMASK
);

1315 ()
	`»ad_c¤
(
dd
, 
CCE_DC_CTRL
);

1317 
fw_ù¾
 = 
	`»ad_c¤
(
dd
, 
MISC_CFG_FW_CTRL
);

1319 
	`dd_dev_šfo
(
dd
, "%s:‡rmšg gask‘†ogic\n", 
__func__
);

1320 
	`¬m_gask‘_logic
(
dd
);

1335 
	`dd_dev_šfo
(
dd
, "%s: c®lšgrigg”_sbr\n", 
__func__
);

1336 
»t
 = 
	`Œigg”_sbr
(
dd
);

1337 ià(
»t
)

1338 
dÚe
;

1343 
»t
 = 
	`pci_»ad_cÚfig_wÜd
(
dd
->
pcidev
, 
PCI_VENDOR_ID
, &
v’dÜ
);

1344 ià(
»t
) {

1345 
	`dd_dev_šfo
(
dd
,

1347 
__func__
, 
»t
);

1348 
»tuº_”rÜ
 = 1;

1349 
dÚe
;

1351 ià(
v’dÜ
 == 0xffff) {

1352 
	`dd_dev_šfo
(
dd
, "%s: V’dÜID i ®È1 aá” SBR\n", 
__func__
);

1353 
»tuº_”rÜ
 = 1;

1354 
»t
 = -
EIO
;

1355 
dÚe
;

1359 
	`dd_dev_šfo
(
dd
, "%s: c®lšg„e¡Üe_pci_v¬ŸbËs\n", 
__func__
);

1360 
»t
 = 
	`»¡Üe_pci_v¬ŸbËs
(
dd
);

1361 ià(
»t
) {

1362 
	`dd_dev_”r
(
dd
, "%s: Could‚ot„estore PCI variables\n",

1363 
__func__
);

1364 
»tuº_”rÜ
 = 1;

1365 
dÚe
;

1369 
	`wr™e_c¤
(
dd
, 
MISC_CFG_FW_CTRL
, 
fw_ù¾
);

1381 
»g
 = 
	`»ad_c¤
(
dd
, 
ASIC_PCIE_SD_HOST_STATUS
);

1382 
	`dd_dev_šfo
(
dd
, "%s: gask‘ block stus: 0x%Îx\n", 
__func__
, 
»g
);

1383 ià(
»g
 == ~0ull) {

1384 
	`dd_dev_”r
(
dd
, "SBR failed - unableo„ead from device\n");

1385 
»tuº_”rÜ
 = 1;

1386 
»t
 = -
ENOSYS
;

1387 
dÚe
;

1391 
	`wr™e_c¤
(
dd
, 
CCE_DC_CTRL
, 0);

1394 
	`£‹xŽed
(
dd
, 0);

1397 
»t
 = 
	`pci_»ad_cÚfig_dwÜd
(
dd
->
pcidev
, 
PCIE_CFG_SPCIE2
, &
»g32
);

1398 ià(
»t
) {

1399 
	`dd_dev_”r
(
dd
, "Unableo„ead from PCI config\n");

1400 
»tuº_”rÜ
 = 1;

1401 
dÚe
;

1404 
	`dd_dev_šfo
(
dd
, "%s:…”-ÏÃƒ¼Üs: 0x%x\n", 
__func__
, 
»g32
);

1407 
¡©us
 = (
»g
 >> 
ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_STS_SHIFT
)

1408 & 
ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_STS_MASK
;

1409 ià((
¡©us
 & (1 << 
dd
->
hfi1_id
)) == 0) {

1410 
	`dd_dev_”r
(
dd
,

1412 
__func__
, 
¡©us
, 1 << 
dd
->
hfi1_id
);

1413 
»t
 = -
EIO
;

1414 
dÚe
;

1418 
”r
 = (
»g
 >> 
ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_ERR_SHIFT
)

1419 & 
ASIC_PCIE_SD_HOST_STATUS_FW_DNLD_ERR_MASK
;

1420 ià(
”r
) {

1421 
	`dd_dev_”r
(
dd
, "%s: gask‘ƒ¼Ü %d\n", 
__func__
, 
”r
);

1422 
»t
 = -
EIO
;

1423 
dÚe
;

1427 
	`upd©e_lbus_šfo
(
dd
);

1428 
	`dd_dev_šfo
(
dd
, "%s:‚ew s³ed‡nd width: %s\n", 
__func__
,

1429 
dd
->
lbus_šfo
);

1431 ià(
dd
->
lbus_¥“d
 !ð
rg‘_¥“d
 ||

1432 
dd
->
lbus_width
 < 
rg‘_width
) {

1434 
do_»Œy
 = 
»Œy_couÁ
 < 
pc›_»Œy
;

1435 
	`dd_dev_”r
(
dd
, "PCIe†ink speed or width did‚ot matcharget%s\n",

1436 
do_»Œy
 ? ",„etrying" : "");

1437 
»Œy_couÁ
++;

1438 ià(
do_»Œy
) {

1439 
	`m¦“p
(100);

1440 
»Œy
;

1442 
»t
 = -
EIO
;

1445 
dÚe
:

1446 ià(
th”m
) {

1447 
	`wr™e_c¤
(
dd
, 
ASIC_CFG_THERM_POLL_EN
, 0x1);

1448 
	`m¦“p
(100);

1449 
	`dd_dev_šfo
(
dd
, "%s: Re-enableherm…olling\n",

1450 
__func__
);

1452 
	`»Ëa£_ch_»sourû
(
dd
, 
CR_SBUS
);

1453 
dÚe_no_mu‹x
:

1455 ià(
»t
 && !
»tuº_”rÜ
) {

1456 
	`dd_dev_”r
(
dd
, "Proceeding‡t current speed PCIe speed\n");

1457 
»t
 = 0;

1460 
	`dd_dev_šfo
(
dd
, "%s: dÚe\n", 
__func__
);

1461  
»t
;

1462 
	}
}

	@pio.c

48 
	~<lšux/d–ay.h
>

49 
	~"hfi.h
"

50 
	~"qp.h
"

51 
	~"Œaû.h
"

53 
	#SC
(
Çme
è
SEND_CTXT_
##
	)
name

57 
sc_wa™_fÜ_·ck‘_eg»ss
(
£nd_cÚ‹xt
 *
sc
, 
·u£
);

63 
	$__cm_»£t
(
hfi1_devd©a
 *
dd
, 
u64
 
£ndù¾
)

65 
	`wr™e_c¤
(
dd
, 
SEND_CTRL
, 
£ndù¾
 | 
SEND_CTRL_CM_RESET_SMASK
);

67 
	`ud–ay
(1);

68 
£ndù¾
 = 
	`»ad_c¤
(
dd
, 
SEND_CTRL
);

69 ià((
£ndù¾
 & 
SEND_CTRL_CM_RESET_SMASK
) == 0)

72 
	}
}

75 
	$pio_£nd_cÚŒÞ
(
hfi1_devd©a
 *
dd
, 
Ý
)

77 
u64
 
»g
, 
mask
;

78 
æags
;

79 
wr™e
 = 1;

80 
æush
 = 0;

81 
i
;

83 
	`¥š_lock_œq§ve
(&
dd
->
£ndù¾_lock
, 
æags
);

85 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_CTRL
);

86 
Ý
) {

87 
PSC_GLOBAL_ENABLE
:

88 
»g
 |ð
SEND_CTRL_SEND_ENABLE_SMASK
;

90 
PSC_DATA_VL_ENABLE
:

91 
mask
 = 0;

92 
i
 = 0; i < 
	`ARRAY_SIZE
(
dd
->
vld
); i++)

93 ià(!
dd
->
vld
[
i
].
mtu
)

94 
mask
 |ð
	`BIT_ULL
(
i
);

96 
mask
 = (mask & 
SEND_CTRL_UNSUPPORTED_VL_MASK
) <<

97 
SEND_CTRL_UNSUPPORTED_VL_SHIFT
;

98 
»g
 = (»g & ~
SEND_CTRL_UNSUPPORTED_VL_SMASK
è| 
mask
;

100 
PSC_GLOBAL_DISABLE
:

101 
»g
 &ð~
SEND_CTRL_SEND_ENABLE_SMASK
;

103 
PSC_GLOBAL_VLARB_ENABLE
:

104 
»g
 |ð
SEND_CTRL_VL_ARBITER_ENABLE_SMASK
;

106 
PSC_GLOBAL_VLARB_DISABLE
:

107 
»g
 &ð~
SEND_CTRL_VL_ARBITER_ENABLE_SMASK
;

109 
PSC_CM_RESET
:

110 
	`__cm_»£t
(
dd
, 
»g
);

111 
wr™e
 = 0;

113 
PSC_DATA_VL_DISABLE
:

114 
»g
 |ð
SEND_CTRL_UNSUPPORTED_VL_SMASK
;

115 
æush
 = 1;

118 
	`dd_dev_”r
(
dd
, "%s: inv®id cÚŒÞ %d\n", 
__func__
, 
Ý
);

122 ià(
wr™e
) {

123 
	`wr™e_c¤
(
dd
, 
SEND_CTRL
, 
»g
);

124 ià(
æush
)

125 ()
	`»ad_c¤
(
dd
, 
SEND_CTRL
);

128 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
£ndù¾_lock
, 
æags
);

129 
	}
}

132 
	#NUM_SC_POOLS
 2

	)

135 
	#SCS_POOL_0
 -1

	)

136 
	#SCS_POOL_1
 -2

	)

139 
	#SCC_PER_VL
 -1

	)

140 
	#SCC_PER_CPU
 -2

	)

141 
	#SCC_PER_KRCVQ
 -3

	)

144 
	#SCS_ACK_CREDITS
 32

	)

145 
	#SCS_VL15_CREDITS
 102

	)

147 
	#PIO_THRESHOLD_CEILING
 4096

	)

149 
	#PIO_WAIT_BATCH_SIZE
 5

	)

152 
sc_cÚfig_sizes
 
	gsc_cÚfig_sizes
[
SC_MAX
] = {

153 [
SC_KERNEL
] = { .
size
 = 
SCS_POOL_0
,

154 .
	gcouÁ
 = 
SCC_PER_VL
 },

155 [
SC_ACK
] = { .
size
 = 
SCS_ACK_CREDITS
,

156 .
	gcouÁ
 = 
SCC_PER_KRCVQ
 },

157 [
SC_USER
] = { .
size
 = 
SCS_POOL_0
,

158 .
	gcouÁ
 = 
SCC_PER_CPU
 },

159 [
SC_VL15
] = { .
size
 = 
SCS_VL15_CREDITS
,

160 .
	gcouÁ
 = 1 },

165 
	smem_poÞ_cÚfig
 {

166 
	mûÁ”ûÁ
;

167 
	mabsÞu‹_blocks
;

171 
mem_poÞ_cÚfig
 
	gsc_mem_poÞ_cÚfig
[
NUM_SC_POOLS
] = {

178 
	smem_poÞ_šfo
 {

179 
	mûÁ”ûÁ
;

183 
	mcouÁ
;

184 
	mblocks
;

185 
	msize
;

197 
	$wždÿrd_to_poÞ
(
wc
)

199 ià(
wc
 >= 0)

201  -
wc
 - 1;

202 
	}
}

204 cÚ¡ *
	gsc_ty³_Çmes
[
SC_MAX
] = {

211 cÚ¡ *
	$sc_ty³_Çme
(
šdex
)

213 ià(
šdex
 < 0 || index >ð
SC_MAX
)

215  
sc_ty³_Çmes
[
šdex
];

216 
	}
}

223 
	$š™_sc_poÞs_ªd_sizes
(
hfi1_devd©a
 *
dd
)

225 
mem_poÞ_šfo
 mem_poÞ_šfo[
NUM_SC_POOLS
] = { { 0 } };

226 
tÙ®_blocks
 = (
	`ch_pio_mem_size
(
dd
è/ 
PIO_BLOCK_SIZE
) - 1;

227 
tÙ®_cÚ‹xts
 = 0;

228 
fixed_blocks
;

229 
poÞ_blocks
;

230 
u£d_blocks
;

231 
ý_tÙ®
;

232 
ab_tÙ®
;

233 
exŒa
;

234 
i
;

245 ià(
	`HFI1_CAP_IS_KSET
(
SDMA
)) {

246 
u16
 
max_pkt_size
 = (
piÙh»shÞd
 < 
PIO_THRESHOLD_CEILING
) ?

247 
piÙh»shÞd
 : 
PIO_THRESHOLD_CEILING
;

248 
sc_cÚfig_sizes
[
SC_KERNEL
].
size
 =

249 3 * (
max_pkt_size
 + 128è/ 
PIO_BLOCK_SIZE
;

259 
ý_tÙ®
 = 0;

260 
ab_tÙ®
 = 0;

261 
i
 = 0; i < 
NUM_SC_POOLS
; i++) {

262 
ý
 = 
sc_mem_poÞ_cÚfig
[
i
].
ûÁ”ûÁ
;

263 
ab
 = 
sc_mem_poÞ_cÚfig
[
i
].
absÞu‹_blocks
;

269 ià(
ý
 >= 0) {

270 
ý_tÙ®
 +ð
ý
;

271 } ià(
ab
 >= 0) {

272 
ab_tÙ®
 +ð
ab
;

274 
	`dd_dev_”r
(

275 
dd
,

277 
i
);

278  -
EINVAL
;

281 
mem_poÞ_šfo
[
i
].
ûÁ”ûÁ
 = 
ý
;

282 
mem_poÞ_šfo
[
i
].
blocks
 = 
ab
;

286 ià(
ý_tÙ®
 !ð0 && 
ab_tÙ®
 != 0) {

287 
	`dd_dev_”r
(

288 
dd
,

290  -
EINVAL
;

294 ià(
ý_tÙ®
 != 0 && cp_total != 10000) {

295 
	`dd_dev_”r
(

296 
dd
,

298 
ý_tÙ®
);

299  -
EINVAL
;

303 ià(
ab_tÙ®
 > 
tÙ®_blocks
) {

304 
	`dd_dev_”r
(

305 
dd
,

307 
ab_tÙ®
, 
tÙ®_blocks
);

308  -
EINVAL
;

318 
fixed_blocks
 = 0;

319 
i
 = 0; i < 
SC_MAX
; i++) {

320 
couÁ
 = 
sc_cÚfig_sizes
[
i
].count;

321 
size
 = 
sc_cÚfig_sizes
[
i
].size;

322 
poÞ
;

330 ià(
i
 =ð
SC_ACK
) {

331 
couÁ
 = 
dd
->
n_krcv_queues
;

332 } ià(
i
 =ð
SC_KERNEL
) {

333 
couÁ
 = 
INIT_SC_PER_VL
 * 
num_vls
;

334 } ià(
couÁ
 =ð
SCC_PER_CPU
) {

335 
couÁ
 = 
dd
->
num_rcv_cÚ‹xts
 - dd->
n_krcv_queues
;

336 } ià(
couÁ
 < 0) {

337 
	`dd_dev_”r
(

338 
dd
,

340 
	`sc_ty³_Çme
(
i
), 
couÁ
);

341  -
EINVAL
;

343 ià(
tÙ®_cÚ‹xts
 + 
couÁ
 > 
	`ch_£nd_cÚ‹xts
(
dd
))

344 
couÁ
 = 
	`ch_£nd_cÚ‹xts
(
dd
è- 
tÙ®_cÚ‹xts
;

346 
tÙ®_cÚ‹xts
 +ð
couÁ
;

354 
poÞ
 = 
	`wždÿrd_to_poÞ
(
size
);

355 ià(
poÞ
 == -1) {

356 
fixed_blocks
 +ð
size
 * 
couÁ
;

357 } ià(
poÞ
 < 
NUM_SC_POOLS
) {

358 
mem_poÞ_šfo
[
poÞ
].
couÁ
 += count;

360 
	`dd_dev_”r
(

361 
dd
,

363 
	`sc_ty³_Çme
(
i
), 
size
);

364  -
EINVAL
;

367 
dd
->
sc_sizes
[
i
].
couÁ
 = count;

368 
dd
->
sc_sizes
[
i
].
size
 = size;

370 ià(
fixed_blocks
 > 
tÙ®_blocks
) {

371 
	`dd_dev_”r
(

372 
dd
,

374 
fixed_blocks
, 
tÙ®_blocks
);

375  -
EINVAL
;

379 
poÞ_blocks
 = 
tÙ®_blocks
 - 
fixed_blocks
;

380 ià(
ab_tÙ®
 > 
poÞ_blocks
) {

381 
	`dd_dev_”r
(

382 
dd
,

384 
ab_tÙ®
, 
poÞ_blocks
);

385  -
EINVAL
;

388 
poÞ_blocks
 -ð
ab_tÙ®
;

390 
i
 = 0; i < 
NUM_SC_POOLS
; i++) {

391 
mem_poÞ_šfo
 *
pi
 = &mem_poÞ_šfo[
i
];

394 ià(
pi
->
ûÁ”ûÁ
 >= 0)

395 
pi
->
blocks
 = (
poÞ_blocks
 *…i->
ûÁ”ûÁ
) / 10000;

397 ià(
pi
->
blocks
 =ð0 &&…i->
couÁ
 != 0) {

398 
	`dd_dev_”r
(

399 
dd
,

401 
i
, 
pi
->
couÁ
);

402  -
EINVAL
;

404 ià(
pi
->
couÁ
 == 0) {

406 ià(
pi
->
blocks
 != 0)

407 
	`dd_dev_”r
(

408 
dd
,

410 
i
, 
pi
->
blocks
);

411 
pi
->
size
 = 0;

413 
pi
->
size
 =…i->
blocks
 /…i->
couÁ
;

418 
u£d_blocks
 = 0;

419 
i
 = 0; i < 
SC_MAX
; i++) {

420 ià(
dd
->
sc_sizes
[
i
].
size
 < 0) {

421 
poÞ
 = 
	`wždÿrd_to_poÞ
(
dd
->
sc_sizes
[
i
].
size
);

423 
	`WARN_ON_ONCE
(
poÞ
 >ð
NUM_SC_POOLS
);

424 
dd
->
sc_sizes
[
i
].
size
 = 
mem_poÞ_šfo
[
poÞ
].size;

427 
	#PIO_MAX_BLOCKS
 1024

	)

428 ià(
dd
->
sc_sizes
[
i
].
size
 > 
PIO_MAX_BLOCKS
)

429 
dd
->
sc_sizes
[
i
].
size
 = 
PIO_MAX_BLOCKS
;

432 
u£d_blocks
 +ð
dd
->
sc_sizes
[
i
].
size
 * dd->sc_sizes[i].
couÁ
;

434 
exŒa
 = 
tÙ®_blocks
 - 
u£d_blocks
;

435 ià(
exŒa
 != 0)

436 
	`dd_dev_šfo
(
dd
, "unu£d s’d cÚ‹xˆblocks: %d\n", 
exŒa
);

438  
tÙ®_cÚ‹xts
;

439 
	}
}

441 
	$š™_£nd_cÚ‹xts
(
hfi1_devd©a
 *
dd
)

443 
u16
 
ba£
;

444 
»t
, 
i
, 
j
, 
cÚ‹xt
;

446 
»t
 = 
	`š™_üed™_»tuº
(
dd
);

447 ià(
»t
)

448  
»t
;

450 
dd
->
hw_to_sw
 = 
	`km®loc_¬¿y
(
TXE_NUM_CONTEXTS
, (
u8
),

451 
GFP_KERNEL
);

452 
dd
->
£nd_cÚ‹xts
 = 
	`kÿÎoc
(dd->
num_£nd_cÚ‹xts
,

453 (
£nd_cÚ‹xt_šfo
),

454 
GFP_KERNEL
);

455 ià(!
dd
->
£nd_cÚ‹xts
 || !dd->
hw_to_sw
) {

456 
	`kä“
(
dd
->
hw_to_sw
);

457 
	`kä“
(
dd
->
£nd_cÚ‹xts
);

458 
	`ä“_üed™_»tuº
(
dd
);

459  -
ENOMEM
;

463 
i
 = 0; i < 
TXE_NUM_CONTEXTS
; i++)

464 
dd
->
hw_to_sw
[
i
] = 
INVALID_SCI
;

470 
cÚ‹xt
 = 0;

471 
ba£
 = 1;

472 
i
 = 0; i < 
SC_MAX
; i++) {

473 
sc_cÚfig_sizes
 *
scs
 = &
dd
->
sc_sizes
[
i
];

475 
j
 = 0; j < 
scs
->
couÁ
; j++) {

476 
£nd_cÚ‹xt_šfo
 *
sci
 =

477 &
dd
->
£nd_cÚ‹xts
[
cÚ‹xt
];

478 
sci
->
ty³
 = 
i
;

479 
sci
->
ba£
 = base;

480 
sci
->
üed™s
 = 
scs
->
size
;

482 
cÚ‹xt
++;

483 
ba£
 +ð
scs
->
size
;

488 
	}
}

495 
	$sc_hw_®loc
(
hfi1_devd©a
 *
dd
, 
ty³
, 
u32
 *
sw_šdex
,

496 
u32
 *
hw_cÚ‹xt
)

498 
£nd_cÚ‹xt_šfo
 *
sci
;

499 
u32
 
šdex
;

500 
u32
 
cÚ‹xt
;

502 
šdex
 = 0, 
sci
 = &
dd
->
£nd_cÚ‹xts
[0];

503 
šdex
 < 
dd
->
num_£nd_cÚ‹xts
; index++, 
sci
++) {

504 ià(
sci
->
ty³
 =ðty³ && sci->
®loÿ‹d
 == 0) {

505 
sci
->
®loÿ‹d
 = 1;

507 
cÚ‹xt
 = 
	`ch_£nd_cÚ‹xts
(
dd
è- 
šdex
 - 1;

508 
dd
->
hw_to_sw
[
cÚ‹xt
] = 
šdex
;

509 *
sw_šdex
 = 
šdex
;

510 *
hw_cÚ‹xt
 = 
cÚ‹xt
;

514 
	`dd_dev_”r
(
dd
, "UÇbËØloÿ‹‡ f»ty³ %d s’d cÚ‹xt\n", 
ty³
);

515  -
ENOSPC
;

516 
	}
}

523 
	$sc_hw_ä“
(
hfi1_devd©a
 *
dd
, 
u32
 
sw_šdex
, u32 
hw_cÚ‹xt
)

525 
£nd_cÚ‹xt_šfo
 *
sci
;

527 
sci
 = &
dd
->
£nd_cÚ‹xts
[
sw_šdex
];

528 ià(!
sci
->
®loÿ‹d
) {

529 
	`dd_dev_”r
(
dd
, "%s: sw_index %u‚ot‡llocated? hw_context %u\n",

530 
__func__
, 
sw_šdex
, 
hw_cÚ‹xt
);

532 
sci
->
®loÿ‹d
 = 0;

533 
dd
->
hw_to_sw
[
hw_cÚ‹xt
] = 
INVALID_SCI
;

534 
	}
}

537 
šlše
 
u32
 
	$group_cÚ‹xt
(
u32
 
cÚ‹xt
, u32 
group
)

539  (
cÚ‹xt
 >> 
group
) << group;

540 
	}
}

543 
šlše
 
u32
 
	$group_size
(
u32
 
group
)

545  1 << 
group
;

546 
	}
}

561 
	$ü_group_add»s£s
(
£nd_cÚ‹xt
 *
sc
, 
dma_addr_t
 *
dma
)

563 
u32
 
gc
 = 
	`group_cÚ‹xt
(
sc
->
hw_cÚ‹xt
, sc->
group
);

564 
u32
 
šdex
 = 
sc
->
hw_cÚ‹xt
 & 0x7;

566 
sc
->
hw_ä“
 = &sc->
dd
->
ü_ba£
[sc->
node
].
va
[
gc
].
ü
[
šdex
];

567 *
dma
 = ()

568 &((
üed™_»tuº
 *)
sc
->
dd
->
ü_ba£
[sc->
node
].
dma
)[
gc
];

569 
	}
}

575 
	$sc_h®‹d
(
wÜk_¡ruù
 *
wÜk
)

577 
£nd_cÚ‹xt
 *
sc
;

579 
sc
 = 
	`cÚš”_of
(
wÜk
, 
£nd_cÚ‹xt
, 
h®t_wÜk
);

580 
	`sc_»¡¬t
(
sc
);

581 
	}
}

593 
u32
 
	$sc_mtu_to_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
mtu
, u32 
hdrq’tsize
)

595 
u32
 
»Ëa£_üed™s
;

596 
u32
 
th»shÞd
;

599 
mtu
 +ð
hdrq’tsize
 << 2;

600 
»Ëa£_üed™s
 = 
	`DIV_ROUND_UP
(
mtu
, 
PIO_BLOCK_SIZE
);

603 ià(
sc
->
üed™s
 <ð
»Ëa£_üed™s
)

604 
th»shÞd
 = 1;

606 
th»shÞd
 = 
sc
->
üed™s
 - 
»Ëa£_üed™s
;

608  
th»shÞd
;

609 
	}
}

618 
u32
 
	$sc_³rûÁ_to_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
³rûÁ
)

620  (
sc
->
üed™s
 * 
³rûÁ
) / 100;

621 
	}
}

626 
	$sc_£t_ü_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
Ãw_th»shÞd
)

628 
æags
;

629 
u32
 
Þd_th»shÞd
;

630 
fÜû_»tuº
 = 0;

632 
	`¥š_lock_œq§ve
(&
sc
->
üed™_ù¾_lock
, 
æags
);

634 
Þd_th»shÞd
 = (
sc
->
üed™_ù¾
 >>

635 
	`SC
(
CREDIT_CTRL_THRESHOLD_SHIFT
))

636 & 
	`SC
(
CREDIT_CTRL_THRESHOLD_MASK
);

638 ià(
Ãw_th»shÞd
 !ð
Þd_th»shÞd
) {

639 
sc
->
üed™_ù¾
 =

640 (
sc
->
üed™_ù¾


641 & ~
	`SC
(
CREDIT_CTRL_THRESHOLD_SMASK
))

642 | ((
Ãw_th»shÞd


643 & 
	`SC
(
CREDIT_CTRL_THRESHOLD_MASK
))

644 << 
	`SC
(
CREDIT_CTRL_THRESHOLD_SHIFT
));

645 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
,

646 
	`SC
(
CREDIT_CTRL
), 
sc
->
üed™_ù¾
);

649 
fÜû_»tuº
 = 1;

652 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
üed™_ù¾_lock
, 
æags
);

654 ià(
fÜû_»tuº
)

655 
	`sc_»tuº_üed™s
(
sc
);

656 
	}
}

663 
	$£t_pio_š‹gr™y
(
£nd_cÚ‹xt
 *
sc
)

665 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

666 
u32
 
hw_cÚ‹xt
 = 
sc
->hw_context;

667 
ty³
 = 
sc
->type;

669 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
,

670 
	`SC
(
CHECK_ENABLE
),

671 
	`hfi1_pkt_deçuÉ_£nd_ùxt_mask
(
dd
, 
ty³
));

672 
	}
}

674 
u32
 
	$g‘_bufãrs_®loÿ‹d
(
£nd_cÚ‹xt
 *
sc
)

676 
ýu
;

677 
u32
 
»t
 = 0;

679 
	`fÜ_—ch_possibË_ýu
(
ýu
)

680 
»t
 +ð*
	`³r_ýu_±r
(
sc
->
bufãrs_®loÿ‹d
, 
ýu
);

681  
»t
;

682 
	}
}

684 
	$»£t_bufãrs_®loÿ‹d
(
£nd_cÚ‹xt
 *
sc
)

686 
ýu
;

688 
	`fÜ_—ch_possibË_ýu
(
ýu
)

689 (*
	`³r_ýu_±r
(
sc
->
bufãrs_®loÿ‹d
, 
ýu
)) = 0;

690 
	}
}

696 
£nd_cÚ‹xt
 *
	$sc_®loc
(
hfi1_devd©a
 *
dd
, 
ty³
,

697 
ušt
 
hdrq’tsize
, 
numa
)

699 
£nd_cÚ‹xt_šfo
 *
sci
;

700 
£nd_cÚ‹xt
 *
sc
 = 
NULL
;

701 
dma_addr_t
 
dma
;

702 
æags
;

703 
u64
 
»g
;

704 
u32
 
th»sh
;

705 
u32
 
sw_šdex
;

706 
u32
 
hw_cÚ‹xt
;

707 
»t
;

708 
u8
 
Ýv®
, 
Ýmask
;

711 ià(
dd
->
æags
 & 
HFI1_FROZEN
)

712  
NULL
;

714 
sc
 = 
	`kz®loc_node
((*sc), 
GFP_KERNEL
, 
numa
);

715 ià(!
sc
)

716  
NULL
;

718 
sc
->
bufãrs_®loÿ‹d
 = 
	`®loc_³rýu
(
u32
);

719 ià(!
sc
->
bufãrs_®loÿ‹d
) {

720 
	`kä“
(
sc
);

721 
	`dd_dev_”r
(
dd
,

724  
NULL
;

727 
	`¥š_lock_œq§ve
(&
dd
->
sc_lock
, 
æags
);

728 
»t
 = 
	`sc_hw_®loc
(
dd
, 
ty³
, &
sw_šdex
, &
hw_cÚ‹xt
);

729 ià(
»t
) {

730 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
æags
);

731 
	`ä“_³rýu
(
sc
->
bufãrs_®loÿ‹d
);

732 
	`kä“
(
sc
);

733  
NULL
;

736 
sci
 = &
dd
->
£nd_cÚ‹xts
[
sw_šdex
];

737 
sci
->
sc
 = sc;

739 
sc
->
dd
 = dd;

740 
sc
->
node
 = 
numa
;

741 
sc
->
ty³
 =ype;

742 
	`¥š_lock_š™
(&
sc
->
®loc_lock
);

743 
	`¥š_lock_š™
(&
sc
->
»Ëa£_lock
);

744 
	`¥š_lock_š™
(&
sc
->
üed™_ù¾_lock
);

745 
	`£qlock_š™
(&
sc
->
wa™lock
);

746 
	`INIT_LIST_HEAD
(&
sc
->
piowa™
);

747 
	`INIT_WORK
(&
sc
->
h®t_wÜk
, 
sc_h®‹d
);

748 
	`š™_wa™queue_h—d
(&
sc
->
h®t_wa™
);

751 
sc
->
group
 = 0;

753 
sc
->
sw_šdex
 = sw_index;

754 
sc
->
hw_cÚ‹xt
 = hw_context;

755 
	`ü_group_add»s£s
(
sc
, &
dma
);

756 
sc
->
üed™s
 = 
sci
->credits;

757 
sc
->
size
 = sc->
üed™s
 * 
PIO_BLOCK_SIZE
;

760 
	#PIO_ADDR_CONTEXT_MASK
 0xfful

	)

761 
	#PIO_ADDR_CONTEXT_SHIFT
 16

	)

762 
sc
->
ba£_addr
 = 
dd
->
pioba£
 + ((
hw_cÚ‹xt
 & 
PIO_ADDR_CONTEXT_MASK
)

763 << 
PIO_ADDR_CONTEXT_SHIFT
);

766 
»g
 = ((
sci
->
üed™s
 & 
	`SC
(
CTRL_CTXT_DEPTH_MASK
))

767 << 
	`SC
(
CTRL_CTXT_DEPTH_SHIFT
))

768 | ((
sci
->
ba£
 & 
	`SC
(
CTRL_CTXT_BASE_MASK
))

769 << 
	`SC
(
CTRL_CTXT_BASE_SHIFT
));

770 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CTRL
), 
»g
);

772 
	`£t_pio_š‹gr™y
(
sc
);

775 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
ERR_MASK
), (
u64
)-1);

778 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_PARTITION_KEY
),

779 (
	`SC
(
CHECK_PARTITION_KEY_VALUE_MASK
) &

780 
DEFAULT_PKEY
) <<

781 
	`SC
(
CHECK_PARTITION_KEY_VALUE_SHIFT
));

784 ià(
ty³
 =ð
SC_USER
) {

785 
Ýv®
 = 
USER_OPCODE_CHECK_VAL
;

786 
Ýmask
 = 
USER_OPCODE_CHECK_MASK
;

788 
Ýv®
 = 
OPCODE_CHECK_VAL_DISABLED
;

789 
Ýmask
 = 
OPCODE_CHECK_MASK_DISABLED
;

793 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_OPCODE
),

794 ((
u64
)
Ýmask
 << 
	`SC
(
CHECK_OPCODE_MASK_SHIFT
)) |

795 ((
u64
)
Ýv®
 << 
	`SC
(
CHECK_OPCODE_VALUE_SHIFT
)));

798 
»g
 = 
dma
 & 
	`SC
(
CREDIT_RETURN_ADDR_ADDRESS_SMASK
);

799 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CREDIT_RETURN_ADDR
), 
»g
);

812 ià(
ty³
 =ð
SC_ACK
) {

813 
th»sh
 = 
	`sc_³rûÁ_to_th»shÞd
(
sc
, 50);

814 } ià(
ty³
 =ð
SC_USER
) {

815 
th»sh
 = 
	`sc_³rûÁ_to_th»shÞd
(
sc
,

816 
u£r_üed™_»tuº_th»shÞd
);

818 
th»sh
 = 
	`mš
(
	`sc_³rûÁ_to_th»shÞd
(
sc
, 50),

819 
	`sc_mtu_to_th»shÞd
(
sc
, 
hfi1_max_mtu
,

820 
hdrq’tsize
));

822 
»g
 = 
th»sh
 << 
	`SC
(
CREDIT_CTRL_THRESHOLD_SHIFT
);

824 ià(
ty³
 =ð
SC_USER
 && 
	`HFI1_CAP_IS_USET
(
EARLY_CREDIT_RETURN
))

825 
»g
 |ð
	`SC
(
CREDIT_CTRL_EARLY_RETURN_SMASK
);

826 ià(
	`HFI1_CAP_IS_KSET
(
EARLY_CREDIT_RETURN
))

827 
»g
 |ð
	`SC
(
CREDIT_CTRL_EARLY_RETURN_SMASK
);

830 
sc
->
üed™_ù¾
 = 
»g
;

831 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CREDIT_CTRL
), 
»g
);

834 ià(
ty³
 =ð
SC_USER
) {

835 
»g
 = 1ULL << 15;

836 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_VL
), 
»g
);

839 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
æags
);

849 ià(
ty³
 !ð
SC_USER
) {

854 
sc
->
¤_size
 = 
sci
->
üed™s
 + 1;

855 
sc
->
¤
 = 
	`kÿÎoc_node
(sc->
¤_size
,

856 (
pio_shadow_ršg
),

857 
GFP_KERNEL
, 
numa
);

858 ià(!
sc
->
¤
) {

859 
	`sc_ä“
(
sc
);

860  
NULL
;

864 
	`hfi1_cdbg
(
PIO
,

866 
sw_šdex
,

867 
hw_cÚ‹xt
,

868 
	`sc_ty³_Çme
(
ty³
),

869 
sc
->
group
,

870 
sc
->
üed™s
,

871 
sc
->
üed™_ù¾
,

872 
th»sh
);

874  
sc
;

875 
	}
}

878 
	$sc_ä“
(
£nd_cÚ‹xt
 *
sc
)

880 
hfi1_devd©a
 *
dd
;

881 
æags
;

882 
u32
 
sw_šdex
;

883 
u32
 
hw_cÚ‹xt
;

885 ià(!
sc
)

888 
sc
->
æags
 |ð
SCF_IN_FREE
;

889 
dd
 = 
sc
->dd;

890 ià(!
	`li¡_em±y
(&
sc
->
piowa™
))

891 
	`dd_dev_”r
(
dd
, "piowait†ist‚otƒmpty!\n");

892 
sw_šdex
 = 
sc
->sw_index;

893 
hw_cÚ‹xt
 = 
sc
->hw_context;

894 
	`sc_di§bË
(
sc
);

895 
	`æush_wÜk
(&
sc
->
h®t_wÜk
);

897 
	`¥š_lock_œq§ve
(&
dd
->
sc_lock
, 
æags
);

898 
dd
->
£nd_cÚ‹xts
[
sw_šdex
].
sc
 = 
NULL
;

901 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CTRL
), 0);

902 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_ENABLE
), 0);

903 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
ERR_MASK
), 0);

904 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_PARTITION_KEY
), 0);

905 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CHECK_OPCODE
), 0);

906 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CREDIT_RETURN_ADDR
), 0);

907 
	`wr™e_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
CREDIT_CTRL
), 0);

910 
	`sc_hw_ä“
(
dd
, 
sw_šdex
, 
hw_cÚ‹xt
);

911 
	`¥š_uÆock_œq»¡Üe
(&
dd
->
sc_lock
, 
æags
);

913 
	`kä“
(
sc
->
¤
);

914 
	`ä“_³rýu
(
sc
->
bufãrs_®loÿ‹d
);

915 
	`kä“
(
sc
);

916 
	}
}

919 
	$sc_di§bË
(
£nd_cÚ‹xt
 *
sc
)

921 
u64
 
»g
;

922 
pio_buf
 *
pbuf
;

924 ià(!
sc
)

928 
	`¥š_lock_œq
(&
sc
->
®loc_lock
);

929 
»g
 = 
	`»ad_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CTRL
));

930 
»g
 &ð~
	`SC
(
CTRL_CTXT_ENABLE_SMASK
);

931 
sc
->
æags
 &ð~
SCF_ENABLED
;

932 
	`sc_wa™_fÜ_·ck‘_eg»ss
(
sc
, 1);

933 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CTRL
), 
»g
);

942 
	`ud–ay
(1);

943 
	`¥š_lock
(&
sc
->
»Ëa£_lock
);

944 ià(
sc
->
¤
) {

945 
sc
->
¤_ž
 !ðsc->
¤_h—d
) {

946 
pbuf
 = &
sc
->
¤
[sc->
¤_ž
].pbuf;

947 ià(
pbuf
->
cb
)

948 (*
pbuf
->
cb
)Õbuf->
¬g
, 
PRC_SC_DISABLE
);

949 
sc
->
¤_ž
++;

950 ià(
sc
->
¤_ž
 >ðsc->
¤_size
)

951 
sc
->
¤_ž
 = 0;

954 
	`¥š_uÆock
(&
sc
->
»Ëa£_lock
);

956 
	`wr™e_£qlock
(&
sc
->
wa™lock
);

957 !
	`li¡_em±y
(&
sc
->
piowa™
)) {

958 
iowa™
 *
wa™
;

959 
rvt_qp
 *
qp
;

960 
hfi1_qp_´iv
 *
´iv
;

962 
wa™
 = 
	`li¡_fœ¡_’Œy
(&
sc
->
piowa™
, 
iowa™
, 
li¡
);

963 
qp
 = 
	`iowa™_to_qp
(
wa™
);

964 
´iv
 = 
qp
->priv;

965 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

966 
´iv
->
s_iowa™
.
lock
 = 
NULL
;

967 
	`hfi1_qp_wakeup
(
qp
, 
RVT_S_WAIT_PIO
 | 
HFI1_S_WAIT_PIO_DRAIN
);

969 
	`wr™e_£quÆock
(&
sc
->
wa™lock
);

971 
	`¥š_uÆock_œq
(&
sc
->
®loc_lock
);

972 
	}
}

975 
u64
 
	$·ck‘_occu·ncy
(
u64
 
»g
)

977  (
»g
 &

978 
SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_PACKET_OCCUPANCY_SMASK
)

979 >> 
SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_PACKET_OCCUPANCY_SHIFT
;

980 
	}
}

983 
boÞ
 
	$eg»ss_h®‹d
(
u64
 
»g
)

985  !!(
»g
 & 
SEND_EGRESS_CTXT_STATUS_CTXT_EGRESS_HALT_STATUS_SMASK
);

986 
	}
}

989 
boÞ
 
	$is_sc_h®‹d
(
hfi1_devd©a
 *
dd
, 
u32
 
hw_cÚ‹xt
)

991  !!(
	`»ad_kùxt_c¤
(
dd
, 
hw_cÚ‹xt
, 
	`SC
(
STATUS
)) &

992 
	`SC
(
STATUS_CTXT_HALTED_SMASK
));

993 
	}
}

1009 
	$sc_wa™_fÜ_·ck‘_eg»ss
(
£nd_cÚ‹xt
 *
sc
, 
·u£
)

1011 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

1012 
u64
 
»g
 = 0;

1013 
u64
 
»g_´ev
;

1014 
u32
 
loÝ
 = 0;

1017 
»g_´ev
 = 
»g
;

1018 
»g
 = 
	`»ad_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
 * 8 +

1019 
SEND_EGRESS_CTXT_STATUS
);

1021 ià(
sc
->
æags
 & 
SCF_HALTED
 ||

1022 
	`is_sc_h®‹d
(
dd
, 
sc
->
hw_cÚ‹xt
è|| 
	`eg»ss_h®‹d
(
»g
))

1024 
»g
 = 
	`·ck‘_occu·ncy
(reg);

1025 ià(
»g
 == 0)

1028 ià(
»g
 !ð
»g_´ev
)

1029 
loÝ
 = 0;

1030 ià(
loÝ
 > 50000) {

1032 
	`dd_dev_”r
(
dd
,

1034 
__func__
, 
sc
->
sw_šdex
,

1035 
sc
->
hw_cÚ‹xt
, (
u32
)
»g
);

1036 
	`queue_wÜk
(
dd
->
µÜt
->
lšk_wq
,

1037 &
dd
->
µÜt
->
lšk_bounû_wÜk
);

1040 
loÝ
++;

1041 
	`ud–ay
(1);

1044 ià(
·u£
)

1046 
	`·u£_fÜ_üed™_»tuº
(
dd
);

1047 
	}
}

1049 
	$sc_wa™
(
hfi1_devd©a
 *
dd
)

1051 
i
;

1053 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

1054 
£nd_cÚ‹xt
 *
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

1056 ià(!
sc
)

1058 
	`sc_wa™_fÜ_·ck‘_eg»ss
(
sc
, 0);

1060 
	}
}

1071 
	$sc_»¡¬t
(
£nd_cÚ‹xt
 *
sc
)

1073 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

1074 
u64
 
»g
;

1075 
u32
 
loÝ
;

1076 
couÁ
;

1079 ià(!(
sc
->
æags
 & 
SCF_HALTED
è|| (sc->æag & 
SCF_IN_FREE
))

1080  -
EINVAL
;

1082 
	`dd_dev_šfo
(
dd
, "»¡¬tšg s’d cÚ‹xˆ%u(%u)\n", 
sc
->
sw_šdex
,

1083 
sc
->
hw_cÚ‹xt
);

1091 
loÝ
 = 0;

1093 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
STATUS
));

1094 ià(
»g
 & 
	`SC
(
STATUS_CTXT_HALTED_SMASK
))

1096 ià(
loÝ
 > 100) {

1097 
	`dd_dev_”r
(
dd
, "%s: context %u(%u)‚ot halting, skipping\n",

1098 
__func__
, 
sc
->
sw_šdex
, sc->
hw_cÚ‹xt
);

1099  -
ETIME
;

1101 
loÝ
++;

1102 
	`ud–ay
(1);

1115 ià(
sc
->
ty³
 !ð
SC_USER
) {

1117 
loÝ
 = 0;

1119 
couÁ
 = 
	`g‘_bufãrs_®loÿ‹d
(
sc
);

1120 ià(
couÁ
 == 0)

1122 ià(
loÝ
 > 100) {

1123 
	`dd_dev_”r
(
dd
,

1125 
__func__
, 
sc
->
sw_šdex
,

1126 
sc
->
hw_cÚ‹xt
, 
couÁ
);

1128 
loÝ
++;

1129 
	`ud–ay
(1);

1142 
	`sc_di§bË
(
sc
);

1150  
	`sc_’abË
(
sc
);

1151 
	}
}

1158 
	$pio_ä“ze
(
hfi1_devd©a
 *
dd
)

1160 
£nd_cÚ‹xt
 *
sc
;

1161 
i
;

1163 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

1164 
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

1170 ià(!
sc
 || !(sc->
æags
 & 
SCF_FROZEN
è|| sc->
ty³
 =ð
SC_USER
)

1174 
	`sc_di§bË
(
sc
);

1176 
	}
}

1185 
	$pio_k”Ãl_unä“ze
(
hfi1_devd©a
 *
dd
)

1187 
£nd_cÚ‹xt
 *
sc
;

1188 
i
;

1190 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

1191 
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

1192 ià(!
sc
 || !(sc->
æags
 & 
SCF_FROZEN
è|| sc->
ty³
 =ð
SC_USER
)

1194 ià(
sc
->
æags
 & 
SCF_LINK_DOWN
)

1197 
	`sc_’abË
(
sc
);

1199 
	}
}

1213 
	$pio_k”Ãl_lškup
(
hfi1_devd©a
 *
dd
)

1215 
£nd_cÚ‹xt
 *
sc
;

1216 
i
;

1218 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++) {

1219 
sc
 = 
dd
->
£nd_cÚ‹xts
[
i
].sc;

1220 ià(!
sc
 || !(sc->
æags
 & 
SCF_LINK_DOWN
è|| sc->
ty³
 =ð
SC_USER
)

1223 
	`sc_’abË
(
sc
);

1225 
	}
}

1233 
	$pio_š™_wa™_´og»ss
(
hfi1_devd©a
 *
dd
)

1235 
u64
 
»g
;

1236 
max
, 
couÁ
 = 0;

1239 
max
 = (
dd
->
icode
 =ð
ICODE_FPGA_EMULATION
) ? 120 : 5;

1241 
»g
 = 
	`»ad_c¤
(
dd
, 
SEND_PIO_INIT_CTXT
);

1242 ià(!(
»g
 & 
SEND_PIO_INIT_CTXT_PIO_INIT_IN_PROGRESS_SMASK
))

1244 ià(
couÁ
 >ð
max
)

1245  -
ETIMEDOUT
;

1246 
	`ud–ay
(5);

1247 
couÁ
++;

1250  
»g
 & 
SEND_PIO_INIT_CTXT_PIO_INIT_ERR_SMASK
 ? -
EIO
 : 0;

1251 
	}
}

1257 
	$pio_»£t_®l
(
hfi1_devd©a
 *
dd
)

1259 
»t
;

1262 
»t
 = 
	`pio_š™_wa™_´og»ss
(
dd
);

1264 ià(
»t
 =ð-
EIO
) {

1266 
	`wr™e_c¤
(
dd
, 
SEND_PIO_ERR_CLEAR
,

1267 
SEND_PIO_ERR_CLEAR_PIO_INIT_SM_IN_ERR_SMASK
);

1271 
	`wr™e_c¤
(
dd
, 
SEND_PIO_INIT_CTXT
,

1272 
SEND_PIO_INIT_CTXT_PIO_ALL_CTXT_INIT_SMASK
);

1273 
	`ud–ay
(2);

1274 
»t
 = 
	`pio_š™_wa™_´og»ss
(
dd
);

1275 ià(
»t
 < 0) {

1276 
	`dd_dev_”r
(
dd
,

1278 
»t
 =ð-
ETIMEDOUT
 ? "is stuck" : "had‡nƒrror");

1280 
	}
}

1283 
	$sc_’abË
(
£nd_cÚ‹xt
 *
sc
)

1285 
u64
 
sc_ù¾
, 
»g
, 
pio
;

1286 
hfi1_devd©a
 *
dd
;

1287 
æags
;

1288 
»t
 = 0;

1290 ià(!
sc
)

1291  -
EINVAL
;

1292 
dd
 = 
sc
->dd;

1301 
	`¥š_lock_œq§ve
(&
sc
->
®loc_lock
, 
æags
);

1302 
sc_ù¾
 = 
	`»ad_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
CTRL
));

1303 ià((
sc_ù¾
 & 
	`SC
(
CTRL_CTXT_ENABLE_SMASK
)))

1304 
uÆock
;

1308 *
sc
->
hw_ä“
 = 0;

1309 
sc
->
ä“
 = 0;

1310 
sc
->
®loc_ä“
 = 0;

1311 
sc
->
fžl
 = 0;

1312 
sc
->
fžl_w¿p
 = 0;

1313 
sc
->
¤_h—d
 = 0;

1314 
sc
->
¤_ž
 = 0;

1315 
sc
->
æags
 = 0;

1317 
	`»£t_bufãrs_®loÿ‹d
(
sc
);

1325 
»g
 = 
	`»ad_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
ERR_STATUS
));

1326 ià(
»g
)

1327 
	`wr™e_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
ERR_CLEAR
), 
»g
);

1333 
	`¥š_lock
(&
dd
->
sc_š™_lock
);

1341 
pio
 = ((
sc
->
hw_cÚ‹xt
 & 
SEND_PIO_INIT_CTXT_PIO_CTXT_NUM_MASK
) <<

1342 
SEND_PIO_INIT_CTXT_PIO_CTXT_NUM_SHIFT
) |

1343 
SEND_PIO_INIT_CTXT_PIO_SINGLE_CTXT_INIT_SMASK
;

1344 
	`wr™e_c¤
(
dd
, 
SEND_PIO_INIT_CTXT
, 
pio
);

1349 
	`ud–ay
(2);

1350 
»t
 = 
	`pio_š™_wa™_´og»ss
(
dd
);

1351 
	`¥š_uÆock
(&
dd
->
sc_š™_lock
);

1352 ià(
»t
) {

1353 
	`dd_dev_”r
(
dd
,

1355 
sc
->
sw_šdex
, sc->
hw_cÚ‹xt
, 
»t
);

1356 
uÆock
;

1362 
sc_ù¾
 |ð
	`SC
(
CTRL_CTXT_ENABLE_SMASK
);

1363 
	`wr™e_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
CTRL
), 
sc_ù¾
);

1368 
	`»ad_kùxt_c¤
(
dd
, 
sc
->
hw_cÚ‹xt
, 
	`SC
(
CTRL
));

1369 
sc
->
æags
 |ð
SCF_ENABLED
;

1371 
uÆock
:

1372 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
®loc_lock
, 
æags
);

1374  
»t
;

1375 
	}
}

1378 
	$sc_»tuº_üed™s
(
£nd_cÚ‹xt
 *
sc
)

1380 ià(!
sc
)

1384 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CREDIT_FORCE
),

1385 
	`SC
(
CREDIT_FORCE_FORCE_RETURN_SMASK
));

1390 
	`»ad_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CREDIT_FORCE
));

1392 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CREDIT_FORCE
), 0);

1393 
	}
}

1396 
	$sc_æush
(
£nd_cÚ‹xt
 *
sc
)

1398 ià(!
sc
)

1401 
	`sc_wa™_fÜ_·ck‘_eg»ss
(
sc
, 1);

1402 
	}
}

1405 
	$sc_drÝ
(
£nd_cÚ‹xt
 *
sc
)

1407 ià(!
sc
)

1410 
	`dd_dev_šfo
(
sc
->
dd
, "%s: context %u(%u) -‚ot implemented\n",

1411 
__func__
, 
sc
->
sw_šdex
, sc->
hw_cÚ‹xt
);

1412 
	}
}

1422 
	$sc_¡Ý
(
£nd_cÚ‹xt
 *
sc
, 
æag
)

1424 
æags
;

1427 
	`¥š_lock_œq§ve
(&
sc
->
®loc_lock
, 
æags
);

1429 
sc
->
æags
 |ð
æag
;

1430 
sc
->
æags
 &ð~
SCF_ENABLED
;

1431 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
®loc_lock
, 
æags
);

1432 
	`wake_up
(&
sc
->
h®t_wa™
);

1433 
	}
}

1435 
	#BLOCK_DWORDS
 (
PIO_BLOCK_SIZE
 / (
u32
))

	)

1436 
	#dwÜds_to_blocks
(
x
è
	`DIV_ROUND_UP
(x, 
BLOCK_DWORDS
)

	)

1449 
pio_buf
 *
	$sc_bufãr_®loc
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
dw_Ën
,

1450 
pio_»Ëa£_cb
 
cb
, *
¬g
)

1452 
pio_buf
 *
pbuf
 = 
NULL
;

1453 
æags
;

1454 
avaž
;

1455 
blocks
 = 
	`dwÜds_to_blocks
(
dw_Ën
);

1456 
u32
 
fžl_w¿p
;

1457 
ŒycouÁ
 = 0;

1458 
u32
 
h—d
, 
Ãxt
;

1460 
	`¥š_lock_œq§ve
(&
sc
->
®loc_lock
, 
æags
);

1461 ià(!(
sc
->
æags
 & 
SCF_ENABLED
)) {

1462 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
®loc_lock
, 
æags
);

1463  
	`ERR_PTR
(-
ECOMM
);

1466 
»Œy
:

1467 
avaž
 = ()
sc
->
üed™s
 - (sc->
fžl
 - sc->
®loc_ä“
);

1468 ià(
blocks
 > 
avaž
) {

1470 ià(
	`uÆik–y
(
ŒycouÁ
)) {

1471 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
®loc_lock
, 
æags
);

1472 
dÚe
;

1475 
sc
->
®loc_ä“
 = 
	`READ_ONCE
(sc->
ä“
);

1476 
avaž
 =

1477 ()
sc
->
üed™s
 -

1478 (
sc
->
fžl
 - sc->
®loc_ä“
);

1479 ià(
blocks
 > 
avaž
) {

1481 
	`sc_»Ëa£_upd©e
(
sc
);

1482 
sc
->
®loc_ä“
 = 
	`READ_ONCE
(sc->
ä“
);

1483 
ŒycouÁ
++;

1484 
»Œy
;

1490 
	`´“m±_di§bË
();

1491 
	`this_ýu_šc
(*
sc
->
bufãrs_®loÿ‹d
);

1494 
h—d
 = 
sc
->
¤_h—d
;

1497 
sc
->
fžl
 +ð
blocks
;

1498 
fžl_w¿p
 = 
sc
->fill_wrap;

1499 
sc
->
fžl_w¿p
 +ð
blocks
;

1500 ià(
sc
->
fžl_w¿p
 >ðsc->
üed™s
)

1501 
sc
->
fžl_w¿p
 = sc->fžl_w¿°- sc->
üed™s
;

1510 
pbuf
 = &
sc
->
¤
[
h—d
].pbuf;

1511 
pbuf
->
£Á_©
 = 
sc
->
fžl
;

1512 
pbuf
->
cb
 = cb;

1513 
pbuf
->
¬g
 =‡rg;

1514 
pbuf
->
sc
 = sc;

1518 
Ãxt
 = 
h—d
 + 1;

1519 ià(
Ãxt
 >ð
sc
->
¤_size
)

1520 
Ãxt
 = 0;

1525 
	`smp_wmb
();

1526 
sc
->
¤_h—d
 = 
Ãxt
;

1527 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
®loc_lock
, 
æags
);

1530 
pbuf
->
¡¬t
 = 
sc
->
ba£_addr
 + 
fžl_w¿p
 * 
PIO_BLOCK_SIZE
;

1531 
pbuf
->
’d
 = 
sc
->
ba£_addr
 + sc->
size
;

1532 
pbuf
->
qw_wr™‹n
 = 0;

1533 
pbuf
->
ÿ¼y_by‹s
 = 0;

1534 
pbuf
->
ÿ¼y
.
v®64
 = 0;

1535 
dÚe
:

1536  
pbuf
;

1537 
	}
}

1550 
	$sc_add_üed™_»tuº_šŒ
(
£nd_cÚ‹xt
 *
sc
)

1552 
æags
;

1555 
	`¥š_lock_œq§ve
(&
sc
->
üed™_ù¾_lock
, 
æags
);

1556 ià(
sc
->
üed™_šŒ_couÁ
 == 0) {

1557 
sc
->
üed™_ù¾
 |ð
	`SC
(
CREDIT_CTRL_CREDIT_INTR_SMASK
);

1558 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
,

1559 
	`SC
(
CREDIT_CTRL
), 
sc
->
üed™_ù¾
);

1561 
sc
->
üed™_šŒ_couÁ
++;

1562 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
üed™_ù¾_lock
, 
æags
);

1563 
	}
}

1569 
	$sc_d–_üed™_»tuº_šŒ
(
£nd_cÚ‹xt
 *
sc
)

1571 
æags
;

1573 
	`WARN_ON
(
sc
->
üed™_šŒ_couÁ
 == 0);

1576 
	`¥š_lock_œq§ve
(&
sc
->
üed™_ù¾_lock
, 
æags
);

1577 
sc
->
üed™_šŒ_couÁ
--;

1578 ià(
sc
->
üed™_šŒ_couÁ
 == 0) {

1579 
sc
->
üed™_ù¾
 &ð~
	`SC
(
CREDIT_CTRL_CREDIT_INTR_SMASK
);

1580 
	`wr™e_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
,

1581 
	`SC
(
CREDIT_CTRL
), 
sc
->
üed™_ù¾
);

1583 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
üed™_ù¾_lock
, 
æags
);

1584 
	}
}

1590 
	$hfi1_sc_wªiobuf_šŒ
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
Ãedšt
)

1592 ià(
Ãedšt
)

1593 
	`sc_add_üed™_»tuº_šŒ
(
sc
);

1595 
	`sc_d–_üed™_»tuº_šŒ
(
sc
);

1596 
	`Œaû_hfi1_wªiošŒ
(
sc
, 
Ãedšt
, sc->
üed™_ù¾
);

1597 ià(
Ãedšt
)

1598 
	`sc_»tuº_üed™s
(
sc
);

1599 
	}
}

1609 
	$sc_piobuçvaž
(
£nd_cÚ‹xt
 *
sc
)

1611 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

1612 
li¡_h—d
 *
li¡
;

1613 
rvt_qp
 *
qps
[
PIO_WAIT_BATCH_SIZE
];

1614 
rvt_qp
 *
qp
;

1615 
hfi1_qp_´iv
 *
´iv
;

1616 
æags
;

1617 
ušt
 
i
, 
n
 = 0, 
tÝ_idx
 = 0;

1619 ià(
dd
->
£nd_cÚ‹xts
[
sc
->
sw_šdex
].
ty³
 !ð
SC_KERNEL
 &&

1620 
dd
->
£nd_cÚ‹xts
[
sc
->
sw_šdex
].
ty³
 !ð
SC_VL15
)

1622 
li¡
 = &
sc
->
piowa™
;

1629 
	`wr™e_£qlock_œq§ve
(&
sc
->
wa™lock
, 
æags
);

1630 !
	`li¡_em±y
(
li¡
)) {

1631 
iowa™
 *
wa™
;

1633 ià(
n
 =ð
	`ARRAY_SIZE
(
qps
))

1635 
wa™
 = 
	`li¡_fœ¡_’Œy
(
li¡
, 
iowa™
,†ist);

1636 
	`iowa™_g‘_´iÜ™y
(
wa™
);

1637 
qp
 = 
	`iowa™_to_qp
(
wa™
);

1638 
´iv
 = 
qp
->priv;

1639 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

1640 
´iv
->
s_iowa™
.
lock
 = 
NULL
;

1641 ià(
n
) {

1642 
´iv
 = 
qps
[
tÝ_idx
]->priv;

1643 
tÝ_idx
 = 
	`iowa™_´iÜ™y_upd©e_tÝ
(
wa™
,

1644 &
´iv
->
s_iowa™
,

1645 
n
, 
tÝ_idx
);

1649 
qps
[
n
++] = 
qp
;

1655 ià(
n
) {

1656 
	`hfi1_sc_wªiobuf_šŒ
(
sc
, 0);

1657 ià(!
	`li¡_em±y
(
li¡
))

1658 
	`hfi1_sc_wªiobuf_šŒ
(
sc
, 1);

1660 
	`wr™e_£quÆock_œq»¡Üe
(&
sc
->
wa™lock
, 
æags
);

1663 ià(
n
)

1664 
	`hfi1_qp_wakeup
(
qps
[
tÝ_idx
],

1665 
RVT_S_WAIT_PIO
 | 
HFI1_S_WAIT_PIO_DRAIN
);

1666 
i
 = 0; i < 
n
; i++)

1667 ià(
i
 !ð
tÝ_idx
)

1668 
	`hfi1_qp_wakeup
(
qps
[
i
],

1669 
RVT_S_WAIT_PIO
 | 
HFI1_S_WAIT_PIO_DRAIN
);

1670 
	}
}

1673 
šlše
 
	$fžl_code
(
u64
 
hw_ä“
)

1675 
code
 = 0;

1677 ià(
hw_ä“
 & 
CR_STATUS_SMASK
)

1678 
code
 |ð
PRC_STATUS_ERR
;

1679 ià(
hw_ä“
 & 
CR_CREDIT_RETURN_DUE_TO_PBC_SMASK
)

1680 
code
 |ð
PRC_PBC
;

1681 ià(
hw_ä“
 & 
CR_CREDIT_RETURN_DUE_TO_THRESHOLD_SMASK
)

1682 
code
 |ð
PRC_THRESHOLD
;

1683 ià(
hw_ä“
 & 
CR_CREDIT_RETURN_DUE_TO_ERR_SMASK
)

1684 
code
 |ð
PRC_FILL_ERR
;

1685 ià(
hw_ä“
 & 
CR_CREDIT_RETURN_DUE_TO_FORCE_SMASK
)

1686 
code
 |ð
PRC_SC_DISABLE
;

1687  
code
;

1688 
	}
}

1691 
	#£Á_befÜe
(
a
, 
b
è
	`time_befÜe
×, bè

	)

1696 
	$sc_»Ëa£_upd©e
(
£nd_cÚ‹xt
 *
sc
)

1698 
pio_buf
 *
pbuf
;

1699 
u64
 
hw_ä“
;

1700 
u32
 
h—d
, 
ž
;

1701 
Þd_ä“
;

1702 
ä“
;

1703 
exŒa
;

1704 
æags
;

1705 
code
;

1707 ià(!
sc
)

1710 
	`¥š_lock_œq§ve
(&
sc
->
»Ëa£_lock
, 
æags
);

1712 
hw_ä“
 = 
	`Ë64_to_ýu
(*
sc
->hw_free);

1713 
Þd_ä“
 = 
sc
->
ä“
;

1714 
exŒa
 = (((
hw_ä“
 & 
CR_COUNTER_SMASK
è>> 
CR_COUNTER_SHIFT
)

1715 - (
Þd_ä“
 & 
CR_COUNTER_MASK
))

1716 & 
CR_COUNTER_MASK
;

1717 
ä“
 = 
Þd_ä“
 + 
exŒa
;

1718 
	`Œaû_hfi1_pioä“
(
sc
, 
exŒa
);

1721 
code
 = -1;

1722 
h—d
 = 
	`READ_ONCE
(
sc
->
¤_h—d
);

1723 
ž
 = 
sc
->
¤_ž
;

1724 
h—d
 !ð
ž
) {

1725 
pbuf
 = &
sc
->
¤
[
ž
].pbuf;

1727 ià(
	`£Á_befÜe
(
ä“
, 
pbuf
->
£Á_©
)) {

1731 ià(
pbuf
->
cb
) {

1732 ià(
code
 < 0)

1733 
code
 = 
	`fžl_code
(
hw_ä“
);

1734 (*
pbuf
->
cb
)Õbuf->
¬g
, 
code
);

1737 
ž
++;

1738 ià(
ž
 >ð
sc
->
¤_size
)

1739 
ž
 = 0;

1741 
sc
->
¤_ž
 = 
ž
;

1743 
	`smp_wmb
();

1744 
sc
->
ä“
 = free;

1745 
	`¥š_uÆock_œq»¡Üe
(&
sc
->
»Ëa£_lock
, 
æags
);

1746 
	`sc_piobuçvaž
(
sc
);

1747 
	}
}

1758 
	$sc_group_»Ëa£_upd©e
(
hfi1_devd©a
 *
dd
, 
u32
 
hw_cÚ‹xt
)

1760 
£nd_cÚ‹xt
 *
sc
;

1761 
u32
 
sw_šdex
;

1762 
u32
 
gc
, 
gc_’d
;

1764 
	`¥š_lock
(&
dd
->
sc_lock
);

1765 
sw_šdex
 = 
dd
->
hw_to_sw
[
hw_cÚ‹xt
];

1766 ià(
	`uÆik–y
(
sw_šdex
 >ð
dd
->
num_£nd_cÚ‹xts
)) {

1767 
	`dd_dev_”r
(
dd
, "%s: invalid hw (%u)o sw (%u) mapping\n",

1768 
__func__
, 
hw_cÚ‹xt
, 
sw_šdex
);

1769 
dÚe
;

1771 
sc
 = 
dd
->
£nd_cÚ‹xts
[
sw_šdex
].sc;

1772 ià(
	`uÆik–y
(!
sc
))

1773 
dÚe
;

1775 
gc
 = 
	`group_cÚ‹xt
(
hw_cÚ‹xt
, 
sc
->
group
);

1776 
gc_’d
 = 
gc
 + 
	`group_size
(
sc
->
group
);

1777 ; 
gc
 < 
gc_’d
; gc++) {

1778 
sw_šdex
 = 
dd
->
hw_to_sw
[
gc
];

1779 ià(
	`uÆik–y
(
sw_šdex
 >ð
dd
->
num_£nd_cÚ‹xts
)) {

1780 
	`dd_dev_”r
(
dd
,

1782 
__func__
, 
hw_cÚ‹xt
, 
sw_šdex
);

1785 
	`sc_»Ëa£_upd©e
(
dd
->
£nd_cÚ‹xts
[
sw_šdex
].
sc
);

1787 
dÚe
:

1788 
	`¥š_uÆock
(&
dd
->
sc_lock
);

1789 
	}
}

1800 
£nd_cÚ‹xt
 *
	$pio_£Ëù_£nd_cÚ‹xt_vl
(
hfi1_devd©a
 *
dd
,

1801 
u32
 
£ËùÜ
, 
u8
 
vl
)

1803 
pio_vl_m­
 *
m
;

1804 
pio_m­_–em
 *
e
;

1805 
£nd_cÚ‹xt
 *
rv®
;

1812 ià(
	`uÆik–y
(
vl
 >ð
num_vls
)) {

1813 
rv®
 = 
NULL
;

1814 
dÚe
;

1817 
	`rcu_»ad_lock
();

1818 
m
 = 
	`rcu_d”eã»nû
(
dd
->
pio_m­
);

1819 ià(
	`uÆik–y
(!
m
)) {

1820 
	`rcu_»ad_uÆock
();

1821  
dd
->
vld
[0].
sc
;

1823 
e
 = 
m
->
m­
[
vl
 & m->
mask
];

1824 
rv®
 = 
e
->
ksc
[
£ËùÜ
 &ƒ->
mask
];

1825 
	`rcu_»ad_uÆock
();

1827 
dÚe
:

1828 
rv®
 = !rv® ? 
dd
->
vld
[0].
sc
 :„val;

1829  
rv®
;

1830 
	}
}

1840 
£nd_cÚ‹xt
 *
	$pio_£Ëù_£nd_cÚ‹xt_sc
(
hfi1_devd©a
 *
dd
,

1841 
u32
 
£ËùÜ
, 
u8
 
sc5
)

1843 
u8
 
vl
 = 
	`sc_to_vÉ
(
dd
, 
sc5
);

1845  
	`pio_£Ëù_£nd_cÚ‹xt_vl
(
dd
, 
£ËùÜ
, 
vl
);

1846 
	}
}

1851 
	$pio_m­_ä“
(
pio_vl_m­
 *
m
)

1853 
i
;

1855 
i
 = 0; 
m
 && i < m->
aùu®_vls
; i++)

1856 
	`kä“
(
m
->
m­
[
i
]);

1857 
	`kä“
(
m
);

1858 
	}
}

1863 
	$pio_m­_rcu_ÿÎback
(
rcu_h—d
 *
li¡
)

1865 
pio_vl_m­
 *
m
 = 
	`cÚš”_of
(
li¡
, pio_vl_map,†ist);

1867 
	`pio_m­_ä“
(
m
);

1868 
	}
}

1873 
	$£t_th»shÞd
(
hfi1_devd©a
 *
dd
, 
scÚ‹xt
, 
i
)

1875 
u32
 
th»s
;

1877 
th»s
 = 
	`mš
(
	`sc_³rûÁ_to_th»shÞd
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
scÚ‹xt
],

1879 
	`sc_mtu_to_th»shÞd
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
scÚ‹xt
],

1880 
dd
->
vld
[
i
].
mtu
,

1881 
dd
->
rcd
[0]->
rcvhdrq’tsize
));

1882 
	`sc_£t_ü_th»shÞd
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
scÚ‹xt
], 
th»s
);

1883 
	}
}

1913 
	$pio_m­_š™
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
, u8 
num_vls
, u8 *
vl_scÚ‹xts
)

1915 
i
, 
j
;

1916 
exŒa
, 
sc_³r_vl
;

1917 
scÚ‹xt
 = 1;

1918 
num_k”Ãl_£nd_cÚ‹xts
 = 0;

1919 
u8
 
lvl_scÚ‹xts
[
OPA_MAX_VLS
];

1920 
pio_vl_m­
 *
Þdm­
, *
Ãwm­
;

1922 ià(!
vl_scÚ‹xts
) {

1923 
i
 = 0; i < 
dd
->
num_£nd_cÚ‹xts
; i++)

1924 ià(
dd
->
£nd_cÚ‹xts
[
i
].
ty³
 =ð
SC_KERNEL
)

1925 
num_k”Ãl_£nd_cÚ‹xts
++;

1927 
sc_³r_vl
 = 
num_k”Ãl_£nd_cÚ‹xts
 / 
num_vls
;

1929 
exŒa
 = 
num_k”Ãl_£nd_cÚ‹xts
 % 
num_vls
;

1930 
vl_scÚ‹xts
 = 
lvl_scÚ‹xts
;

1932 
i
 = 
num_vls
 - 1; i >ð0; i--, 
exŒa
--)

1933 
vl_scÚ‹xts
[
i
] = 
sc_³r_vl
 + (
exŒa
 > 0 ? 1 : 0);

1936 
Ãwm­
 = 
	`kz®loc
((*newmap) +

1937 
	`roundup_pow_of_two
(
num_vls
) *

1938 (
pio_m­_–em
 *),

1939 
GFP_KERNEL
);

1940 ià(!
Ãwm­
)

1941 
baž
;

1942 
Ãwm­
->
aùu®_vls
 = 
num_vls
;

1943 
Ãwm­
->
vls
 = 
	`roundup_pow_of_two
(
num_vls
);

1944 
Ãwm­
->
mask
 = (1 << 
	`žog2
Òewm­->
vls
)) - 1;

1945 
i
 = 0; i < 
Ãwm­
->
vls
; i++) {

1947 
fœ¡_scÚ‹xt
 = 
scÚ‹xt
;

1949 ià(
i
 < 
Ãwm­
->
aùu®_vls
) {

1950 
sz
 = 
	`roundup_pow_of_two
(
vl_scÚ‹xts
[
i
]);

1953 
Ãwm­
->
m­
[
i
] = 
	`kz®loc
((*newmap->map[i]) +

1954 
sz
 * (

1955 
£nd_cÚ‹xt
 *),

1956 
GFP_KERNEL
);

1957 ià(!
Ãwm­
->
m­
[
i
])

1958 
baž
;

1959 
Ãwm­
->
m­
[
i
]->
mask
 = (1 << 
	`žog2
(
sz
)) - 1;

1964 
j
 = 0; j < 
sz
; j++) {

1965 ià(
dd
->
k”Ãl_£nd_cÚ‹xt
[
scÚ‹xt
]) {

1966 
Ãwm­
->
m­
[
i
]->
ksc
[
j
] =

1967 
dd
->
k”Ãl_£nd_cÚ‹xt
[
scÚ‹xt
];

1968 
	`£t_th»shÞd
(
dd
, 
scÚ‹xt
, 
i
);

1970 ià(++
scÚ‹xt
 >ð
fœ¡_scÚ‹xt
 +

1971 
vl_scÚ‹xts
[
i
])

1973 
scÚ‹xt
 = 
fœ¡_scÚ‹xt
;

1977 
Ãwm­
->
m­
[
i
] =‚ewm­->m­[˜% 
num_vls
];

1979 
scÚ‹xt
 = 
fœ¡_scÚ‹xt
 + 
vl_scÚ‹xts
[
i
];

1982 
	`¥š_lock_œq
(&
dd
->
pio_m­_lock
);

1983 
Þdm­
 = 
	`rcu_d”eã»nû_´Ùeùed
(
dd
->
pio_m­
,

1984 
	`lockd•_is_h–d
(&
dd
->
pio_m­_lock
));

1987 
	`rcu_assign_poš‹r
(
dd
->
pio_m­
, 
Ãwm­
);

1989 
	`¥š_uÆock_œq
(&
dd
->
pio_m­_lock
);

1991 ià(
Þdm­
)

1992 
	`ÿÎ_rcu
(&
Þdm­
->
li¡
, 
pio_m­_rcu_ÿÎback
);

1994 
baž
:

1996 
	`pio_m­_ä“
(
Ãwm­
);

1997  -
ENOMEM
;

1998 
	}
}

2000 
	$ä“_pio_m­
(
hfi1_devd©a
 *
dd
)

2003 ià(
	`rcu_acûss_poš‹r
(
dd
->
pio_m­
)) {

2004 
	`¥š_lock_œq
(&
dd
->
pio_m­_lock
);

2005 
	`pio_m­_ä“
(
	`rcu_acûss_poš‹r
(
dd
->
pio_m­
));

2006 
	`RCU_INIT_POINTER
(
dd
->
pio_m­
, 
NULL
);

2007 
	`¥š_uÆock_œq
(&
dd
->
pio_m­_lock
);

2008 
	`synchrÚize_rcu
();

2010 
	`kä“
(
dd
->
k”Ãl_£nd_cÚ‹xt
);

2011 
dd
->
k”Ãl_£nd_cÚ‹xt
 = 
NULL
;

2012 
	}
}

2014 
	$š™_³rvl_scs
(
hfi1_devd©a
 *
dd
)

2016 
i
;

2017 
u64
 
mask
, 
®l_vl_mask
 = (u64)0x80ff;

2018 
u64
 
d©a_vls_mask
 = (u64)0x00ff;

2019 
u32
 
ùxt
;

2020 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

2022 
dd
->
vld
[15].
sc
 = 
	`sc_®loc
(dd, 
SC_VL15
,

2023 
dd
->
rcd
[0]->
rcvhdrq’tsize
, dd->
node
);

2024 ià(!
dd
->
vld
[15].
sc
)

2025  -
ENOMEM
;

2027 
	`hfi1_š™_ùxt
(
dd
->
vld
[15].
sc
);

2028 
dd
->
vld
[15].
mtu
 = 
	`’um_to_mtu
(
OPA_MTU_2048
);

2030 
dd
->
k”Ãl_£nd_cÚ‹xt
 = 
	`kÿÎoc_node
(dd->
num_£nd_cÚ‹xts
,

2031 (
£nd_cÚ‹xt
 *),

2032 
GFP_KERNEL
, 
dd
->
node
);

2033 ià(!
dd
->
k”Ãl_£nd_cÚ‹xt
)

2034 
ä“sc15
;

2036 
dd
->
k”Ãl_£nd_cÚ‹xt
[0] = dd->
vld
[15].
sc
;

2038 
i
 = 0; i < 
num_vls
; i++) {

2046 
dd
->
vld
[
i
].
sc
 = 
	`sc_®loc
(dd, 
SC_KERNEL
,

2047 
dd
->
rcd
[0]->
rcvhdrq’tsize
, dd->
node
);

2048 ià(!
dd
->
vld
[
i
].
sc
)

2049 
nomem
;

2050 
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1] = dd->
vld
[i].
sc
;

2051 
	`hfi1_š™_ùxt
(
dd
->
vld
[
i
].
sc
);

2053 
dd
->
vld
[
i
].
mtu
 = 
hfi1_max_mtu
;

2055 
i
 = 
num_vls
; i < 
INIT_SC_PER_VL
 *‚um_vls; i++) {

2056 
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1] =

2057 
	`sc_®loc
(
dd
, 
SC_KERNEL
, dd->
rcd
[0]->
rcvhdrq’tsize
, dd->
node
);

2058 ià(!
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1])

2059 
nomem
;

2060 
	`hfi1_š™_ùxt
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1]);

2063 
	`sc_’abË
(
dd
->
vld
[15].
sc
);

2064 
ùxt
 = 
dd
->
vld
[15].
sc
->
hw_cÚ‹xt
;

2065 
mask
 = 
®l_vl_mask
 & ~(1LL << 15);

2066 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
	`SC
(
CHECK_VL
), 
mask
);

2067 
	`dd_dev_šfo
(
dd
,

2069 
dd
->
vld
[15].
sc
->
sw_šdex
, 
ùxt
);

2071 
i
 = 0; i < 
num_vls
; i++) {

2072 
	`sc_’abË
(
dd
->
vld
[
i
].
sc
);

2073 
ùxt
 = 
dd
->
vld
[
i
].
sc
->
hw_cÚ‹xt
;

2074 
mask
 = 
®l_vl_mask
 & ~(
d©a_vls_mask
);

2075 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
	`SC
(
CHECK_VL
), 
mask
);

2077 
i
 = 
num_vls
; i < 
INIT_SC_PER_VL
 *‚um_vls; i++) {

2078 
	`sc_’abË
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1]);

2079 
ùxt
 = 
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1]->
hw_cÚ‹xt
;

2080 
mask
 = 
®l_vl_mask
 & ~(
d©a_vls_mask
);

2081 
	`wr™e_kùxt_c¤
(
dd
, 
ùxt
, 
	`SC
(
CHECK_VL
), 
mask
);

2084 ià(
	`pio_m­_š™
(
dd
, 
µd
->
pÜt
 - 1, 
num_vls
, 
NULL
))

2085 
nomem
;

2088 
nomem
:

2089 
i
 = 0; i < 
num_vls
; i++) {

2090 
	`sc_ä“
(
dd
->
vld
[
i
].
sc
);

2091 
dd
->
vld
[
i
].
sc
 = 
NULL
;

2094 
i
 = 
num_vls
; i < 
INIT_SC_PER_VL
 *‚um_vls; i++)

2095 
	`sc_ä“
(
dd
->
k”Ãl_£nd_cÚ‹xt
[
i
 + 1]);

2097 
	`kä“
(
dd
->
k”Ãl_£nd_cÚ‹xt
);

2098 
dd
->
k”Ãl_£nd_cÚ‹xt
 = 
NULL
;

2100 
ä“sc15
:

2101 
	`sc_ä“
(
dd
->
vld
[15].
sc
);

2102  -
ENOMEM
;

2103 
	}
}

2105 
	$š™_üed™_»tuº
(
hfi1_devd©a
 *
dd
)

2107 
»t
;

2108 
i
;

2110 
dd
->
ü_ba£
 = 
	`kÿÎoc
(

2111 
node_affš™y
.
num_possibË_nodes
,

2112 (
üed™_»tuº_ba£
),

2113 
GFP_KERNEL
);

2114 ià(!
dd
->
ü_ba£
) {

2115 
»t
 = -
ENOMEM
;

2116 
dÚe
;

2118 
	`fÜ_—ch_node_w™h_ýus
(
i
) {

2119 
by‹s
 = 
TXE_NUM_CONTEXTS
 * (
üed™_»tuº
);

2121 
	`£t_dev_node
(&
dd
->
pcidev
->
dev
, 
i
);

2122 
dd
->
ü_ba£
[
i
].
va
 = 
	`dma_®loc_coh”’t
(&dd->
pcidev
->
dev
,

2123 
by‹s
,

2124 &
dd
->
ü_ba£
[
i
].
dma
,

2125 
GFP_KERNEL
);

2126 ià(!
dd
->
ü_ba£
[
i
].
va
) {

2127 
	`£t_dev_node
(&
dd
->
pcidev
->
dev
, dd->
node
);

2128 
	`dd_dev_”r
(
dd
,

2130 
i
);

2131 
»t
 = -
ENOMEM
;

2132 
dÚe
;

2135 
	`£t_dev_node
(&
dd
->
pcidev
->
dev
, dd->
node
);

2137 
»t
 = 0;

2138 
dÚe
:

2139  
»t
;

2140 
	}
}

2142 
	$ä“_üed™_»tuº
(
hfi1_devd©a
 *
dd
)

2144 
i
;

2146 ià(!
dd
->
ü_ba£
)

2148 
i
 = 0; i < 
node_affš™y
.
num_possibË_nodes
; i++) {

2149 ià(
dd
->
ü_ba£
[
i
].
va
) {

2150 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
,

2151 
TXE_NUM_CONTEXTS
 *

2152 (
üed™_»tuº
),

2153 
dd
->
ü_ba£
[
i
].
va
,

2154 
dd
->
ü_ba£
[
i
].
dma
);

2157 
	`kä“
(
dd
->
ü_ba£
);

2158 
dd
->
ü_ba£
 = 
NULL
;

2159 
	}
}

2161 
	$£qfže_dump_sci
(
£q_fže
 *
s
, 
u32
 
i
,

2162 
£nd_cÚ‹xt_šfo
 *
sci
)

2164 
£nd_cÚ‹xt
 *
sc
 = 
sci
->sc;

2165 
u64
 
»g
;

2167 
	`£q_´štf
(
s
, "SCI %u:ype %u base %u credits %u\n",

2168 
i
, 
sci
->
ty³
, sci->
ba£
, sci->
üed™s
);

2169 
	`£q_´štf
(
s
, " flags 0x%x sw_inx %u hw_ctxt %u grp %u\n",

2170 
sc
->
æags
, sc->
sw_šdex
, sc->
hw_cÚ‹xt
, sc->
group
);

2171 
	`£q_´štf
(
s
, " sr_size %u credits %u sr_head %u sr_tail %u\n",

2172 
sc
->
¤_size
, sc->
üed™s
, sc->
¤_h—d
, sc->
¤_ž
);

2173 
	`£q_´štf
(
s
, " fill %lu free %lu fill_wrap %u‡lloc_free %lu\n",

2174 
sc
->
fžl
, sc->
ä“
, sc->
fžl_w¿p
, sc->
®loc_ä“
);

2175 
	`£q_´štf
(
s
, " credit_intr_count %u credit_ctrl 0x%llx\n",

2176 
sc
->
üed™_šŒ_couÁ
, sc->
üed™_ù¾
);

2177 
»g
 = 
	`»ad_kùxt_c¤
(
sc
->
dd
, sc->
hw_cÚ‹xt
, 
	`SC
(
CREDIT_STATUS
));

2178 
	`£q_´štf
(
s
, " *hw_free %llu CurrentFree %llu LastReturned %llu\n",

2179 (
	`Ë64_to_ýu
(*
sc
->
hw_ä“
è& 
CR_COUNTER_SMASK
) >>

2180 
CR_COUNTER_SHIFT
,

2181 (
»g
 >> 
	`SC
(
CREDIT_STATUS_CURRENT_FREE_COUNTER_SHIFT
)) &

2182 
	`SC
(
CREDIT_STATUS_CURRENT_FREE_COUNTER_MASK
),

2183 
»g
 & 
	`SC
(
CREDIT_STATUS_LAST_RETURNED_COUNTER_SMASK
));

2184 
	}
}

	@pio.h

1 #iâdeà
_PIO_H


2 
	#_PIO_H


	)

51 
	#SC_KERNEL
 0

	)

52 
	#SC_VL15
 1

	)

53 
	#SC_ACK
 2

	)

54 
	#SC_USER
 3

	)

55 
	#SC_MAX
 4

	)

58 
	#INVALID_SCI
 0xff

	)

61 (*
	tpio_»Ëa£_cb
)(*
	t¬g
, 
	tcode
);

64 
	#PRC_OK
 0

	)

65 
	#PRC_STATUS_ERR
 0x01

	)

66 
	#PRC_PBC
 0x02

	)

67 
	#PRC_THRESHOLD
 0x04

	)

68 
	#PRC_FILL_ERR
 0x08

	)

69 
	#PRC_FORCE
 0x10

	)

70 
	#PRC_SC_DISABLE
 0x20

	)

73 
	umix
 {

74 
u64
 
v®64
;

75 
u32
 
v®32
[2];

76 
u8
 
v®8
[8];

80 
	spio_buf
 {

81 
£nd_cÚ‹xt
 *
sc
;

82 
pio_»Ëa£_cb
 
cb
;

83 *
¬g
;

84 
__iomem
 *
¡¬t
;

85 
__iomem
 *
’d
;

86 
£Á_©
;

87 
mix
 
ÿ¼y
;

88 
u16
 
qw_wr™‹n
;

89 
u8
 
ÿ¼y_by‹s
;

93 
	upio_shadow_ršg
 {

94 
pio_buf
 
pbuf
;

95 } 
____ÿch–še_®igÃd
;

98 
	s£nd_cÚ‹xt
 {

100 
hfi1_devd©a
 *
dd
;

101 
pio_shadow_ršg
 *
¤
;

102 
__iomem
 *
ba£_addr
;

103 
u32
 
__³rýu
 *
bufãrs_®loÿ‹d
;

104 
u32
 
size
;

106 
node
;

107 
u32
 
¤_size
;

108 
u16
 
æags
;

109 
u8
 
ty³
;

110 
u8
 
sw_šdex
;

111 
u8
 
hw_cÚ‹xt
;

112 
u8
 
group
;

115 
¥šlock_t
 
®loc_lock
 
____ÿch–še_®igÃd_š_smp
;

116 
u32
 
¤_h—d
;

117 
fžl
;

118 
®loc_ä“
;

119 
u32
 
fžl_w¿p
;

120 
u32
 
üed™s
;

124 
¥šlock_t
 
»Ëa£_lock
 
____ÿch–še_®igÃd_š_smp
;

125 
u32
 
¤_ž
;

126 
ä“
;

127 vÞ©ž
__Ë64
 *
hw_ä“
;

129 
li¡_h—d
 
piowa™
 
____ÿch–še_®igÃd_š_smp
;

130 
£qlock_t
 
wa™lock
;

132 
¥šlock_t
 
üed™_ù¾_lock
 
____ÿch–še_®igÃd_š_smp
;

133 
u32
 
üed™_šŒ_couÁ
;

134 
u64
 
üed™_ù¾
;

135 
wa™_queue_h—d_t
 
h®t_wa™
;

136 
wÜk_¡ruù
 
h®t_wÜk
;

140 
	#SCF_ENABLED
 0x01

	)

141 
	#SCF_IN_FREE
 0x02

	)

142 
	#SCF_HALTED
 0x04

	)

143 
	#SCF_FROZEN
 0x08

	)

144 
	#SCF_LINK_DOWN
 0x10

	)

146 
	s£nd_cÚ‹xt_šfo
 {

147 
£nd_cÚ‹xt
 *
sc
;

148 
u16
 
®loÿ‹d
;

149 
u16
 
ty³
;

150 
u16
 
ba£
;

151 
u16
 
üed™s
;

155 
	süed™_»tuº
 {

156 vÞ©ž
__Ë64
 
ü
[8];

160 
	süed™_»tuº_ba£
 {

161 
üed™_»tuº
 *
va
;

162 
dma_addr_t
 
dma
;

166 
	ssc_cÚfig_sizes
 {

167 
size
;

168 
couÁ
;

233 
	#INIT_SC_PER_VL
 2

	)

244 
	spio_m­_–em
 {

245 
u32
 
mask
;

246 
£nd_cÚ‹xt
 *
ksc
[0];

261 
	spio_vl_m­
 {

262 
rcu_h—d
 
li¡
;

263 
u32
 
mask
;

264 
u8
 
aùu®_vls
;

265 
u8
 
vls
;

266 
pio_m­_–em
 *
m­
[0];

269 
	`pio_m­_š™
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
, u8 
num_vls
,

270 
u8
 *
vl_scÚ‹xts
);

271 
	`ä“_pio_m­
(
hfi1_devd©a
 *
dd
);

272 
£nd_cÚ‹xt
 *
	`pio_£Ëù_£nd_cÚ‹xt_vl
(
hfi1_devd©a
 *
dd
,

273 
u32
 
£ËùÜ
, 
u8
 
vl
);

274 
£nd_cÚ‹xt
 *
	`pio_£Ëù_£nd_cÚ‹xt_sc
(
hfi1_devd©a
 *
dd
,

275 
u32
 
£ËùÜ
, 
u8
 
sc5
);

278 
	`š™_üed™_»tuº
(
hfi1_devd©a
 *
dd
);

279 
	`ä“_üed™_»tuº
(
hfi1_devd©a
 *
dd
);

280 
	`š™_sc_poÞs_ªd_sizes
(
hfi1_devd©a
 *
dd
);

281 
	`š™_£nd_cÚ‹xts
(
hfi1_devd©a
 *
dd
);

282 
	`š™_üed™_»tuº
(
hfi1_devd©a
 *
dd
);

283 
	`š™_³rvl_scs
(
hfi1_devd©a
 *
dd
);

284 
£nd_cÚ‹xt
 *
	`sc_®loc
(
hfi1_devd©a
 *
dd
, 
ty³
,

285 
ušt
 
hdrq’tsize
, 
numa
);

286 
	`sc_ä“
(
£nd_cÚ‹xt
 *
sc
);

287 
	`sc_’abË
(
£nd_cÚ‹xt
 *
sc
);

288 
	`sc_di§bË
(
£nd_cÚ‹xt
 *
sc
);

289 
	`sc_»¡¬t
(
£nd_cÚ‹xt
 *
sc
);

290 
	`sc_»tuº_üed™s
(
£nd_cÚ‹xt
 *
sc
);

291 
	`sc_æush
(
£nd_cÚ‹xt
 *
sc
);

292 
	`sc_drÝ
(
£nd_cÚ‹xt
 *
sc
);

293 
	`sc_¡Ý
(
£nd_cÚ‹xt
 *
sc
, 
b™
);

294 
pio_buf
 *
	`sc_bufãr_®loc
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
dw_Ën
,

295 
pio_»Ëa£_cb
 
cb
, *
¬g
);

296 
	`sc_»Ëa£_upd©e
(
£nd_cÚ‹xt
 *
sc
);

297 
	`sc_»tuº_üed™s
(
£nd_cÚ‹xt
 *
sc
);

298 
	`sc_group_»Ëa£_upd©e
(
hfi1_devd©a
 *
dd
, 
u32
 
hw_cÚ‹xt
);

299 
	`sc_add_üed™_»tuº_šŒ
(
£nd_cÚ‹xt
 *
sc
);

300 
	`sc_d–_üed™_»tuº_šŒ
(
£nd_cÚ‹xt
 *
sc
);

301 
	`sc_£t_ü_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
Ãw_th»shÞd
);

302 
u32
 
	`sc_³rûÁ_to_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, u32 
³rûÁ
);

303 
u32
 
	`sc_mtu_to_th»shÞd
(
£nd_cÚ‹xt
 *
sc
, u32 
mtu
, u32 
hdrq’tsize
);

304 
	`hfi1_sc_wªiobuf_šŒ
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
Ãedšt
);

305 
	`sc_wa™
(
hfi1_devd©a
 *
dd
);

306 
	`£t_pio_š‹gr™y
(
£nd_cÚ‹xt
 *
sc
);

309 
	`pio_»£t_®l
(
hfi1_devd©a
 *
dd
);

310 
	`pio_ä“ze
(
hfi1_devd©a
 *
dd
);

311 
	`pio_k”Ãl_unä“ze
(
hfi1_devd©a
 *
dd
);

312 
	`pio_k”Ãl_lškup
(
hfi1_devd©a
 *
dd
);

315 
	#PSC_GLOBAL_ENABLE
 0

	)

316 
	#PSC_GLOBAL_DISABLE
 1

	)

317 
	#PSC_GLOBAL_VLARB_ENABLE
 2

	)

318 
	#PSC_GLOBAL_VLARB_DISABLE
 3

	)

319 
	#PSC_CM_RESET
 4

	)

320 
	#PSC_DATA_VL_ENABLE
 5

	)

321 
	#PSC_DATA_VL_DISABLE
 6

	)

323 
	`__cm_»£t
(
hfi1_devd©a
 *
dd
, 
u64
 
£ndù¾
);

324 
	`pio_£nd_cÚŒÞ
(
hfi1_devd©a
 *
dd
, 
Ý
);

327 
	`pio_cÝy
(
hfi1_devd©a
 *
dd
, 
pio_buf
 *
pbuf
, 
u64
 
pbc
,

328 cÚ¡ *
äom
, 
size_t
 
couÁ
);

329 
	`£g_pio_cÝy_¡¬t
(
pio_buf
 *
pbuf
, 
u64
 
pbc
,

330 cÚ¡ *
äom
, 
size_t
 
nby‹s
);

331 
	`£g_pio_cÝy_mid
(
pio_buf
 *
pbuf
, cÚ¡ *
äom
, 
size_t
 
nby‹s
);

332 
	`£g_pio_cÝy_’d
(
pio_buf
 *
pbuf
);

334 
	`£qfže_dump_sci
(
£q_fže
 *
s
, 
u32
 
i
,

335 
£nd_cÚ‹xt_šfo
 *
sci
);

	@pio_copy.c

48 
	~"hfi.h
"

51 
	#SOP_DISTANCE
 (
TXE_PIO_SIZE
 / 2)

	)

52 
	#PIO_BLOCK_MASK
 (
PIO_BLOCK_SIZE
 - 1)

	)

54 
	#PIO_BLOCK_QWS
 (
PIO_BLOCK_SIZE
 / (
u64
))

	)

71 
	$pio_cÝy
(
hfi1_devd©a
 *
dd
, 
pio_buf
 *
pbuf
, 
u64
 
pbc
,

72 cÚ¡ *
äom
, 
size_t
 
couÁ
)

74 
__iomem
 *
de¡
 = 
pbuf
->
¡¬t
 + 
SOP_DISTANCE
;

75 
__iomem
 *
£nd
 = 
de¡
 + 
PIO_BLOCK_SIZE
;

76 
__iomem
 *
d’d
;

79 
	`wr™eq
(
pbc
, 
de¡
);

80 
de¡
 +ð(
u64
);

83 
d’d
 = 
de¡
 + ((
couÁ
 >> 1è* (
u64
));

85 ià(
d’d
 < 
£nd
) {

91 
de¡
 < 
d’d
) {

92 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

93 
äom
 +ð(
u64
);

94 
de¡
 +ð(
u64
);

107 
de¡
 < 
£nd
) {

108 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

109 
äom
 +ð(
u64
);

110 
de¡
 +ð(
u64
);

113 
de¡
 -ð
SOP_DISTANCE
;

114 
d’d
 -ð
SOP_DISTANCE
;

125 ià(
pbuf
->
’d
 <ð
d’d
) {

126 
de¡
 < 
pbuf
->
’d
) {

127 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

128 
äom
 +ð(
u64
);

129 
de¡
 +ð(
u64
);

132 
de¡
 -ð
pbuf
->
sc
->
size
;

133 
d’d
 -ð
pbuf
->
sc
->
size
;

137 
de¡
 < 
d’d
) {

138 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

139 
äom
 +ð(
u64
);

140 
de¡
 +ð(
u64
);

146 ià(
couÁ
 & 1) {

147 
mix
 
v®
;

149 
v®
.
v®64
 = 0;

150 
v®
.
v®32
[0] = *(
u32
 *)
äom
;

151 
	`wr™eq
(
v®
.
v®64
, 
de¡
);

152 
de¡
 +ð(
u64
);

158 (()
de¡
 & 
PIO_BLOCK_MASK
) != 0) {

159 
	`wr™eq
(0, 
de¡
);

160 
de¡
 +ð(
u64
);

164 
	`this_ýu_dec
(*
pbuf
->
sc
->
bufãrs_®loÿ‹d
);

165 
	`´“m±_’abË
();

166 
	}
}

178 
	#zshiá
(
x
è(8 * (8 - (x)))

	)

184 
	#mshiá
(
x
è(8 * (x))

	)

189 
šlše
 
	$jcÝy
(
u8
 *
de¡
, cÚ¡ u8 *
¤c
, 
u32
 
n
)

191 
n
) {

193 *
de¡
++ = *
¤c
++;

196 *
de¡
++ = *
¤c
++;

199 *
de¡
++ = *
¤c
++;

202 *
de¡
++ = *
¤c
++;

205 *
de¡
++ = *
¤c
++;

208 *
de¡
++ = *
¤c
++;

211 *
de¡
++ = *
¤c
++;

214 
	}
}

225 
šlše
 
	$»ad_low_by‹s
(
pio_buf
 *
pbuf
, cÚ¡ *
äom
,

226 
nby‹s
)

228 
pbuf
->
ÿ¼y
.
v®64
 = 0;

229 
	`jcÝy
(&
pbuf
->
ÿ¼y
.
v®8
[0], 
äom
, 
nby‹s
);

230 
pbuf
->
ÿ¼y_by‹s
 = 
nby‹s
;

231 
	}
}

241 
šlše
 
	$»ad_exŒa_by‹s
(
pio_buf
 *
pbuf
,

242 cÚ¡ *
äom
, 
nby‹s
)

244 
	`jcÝy
(&
pbuf
->
ÿ¼y
.
v®8
[pbuf->
ÿ¼y_by‹s
], 
äom
, 
nby‹s
);

245 
pbuf
->
ÿ¼y_by‹s
 +ð
nby‹s
;

246 
	}
}

257 
šlše
 
	$m”ge_wr™e8
(

258 
pio_buf
 *
pbuf
,

259 
__iomem
 *
de¡
,

260 cÚ¡ *
¤c
)

262 
u64
 
Ãw
, 
‹mp
;

264 
Ãw
 = *(
u64
 *)
¤c
;

265 
‹mp
 = 
pbuf
->
ÿ¼y
.
v®64
 | (
Ãw
 << 
	`mshiá
Õbuf->
ÿ¼y_by‹s
));

266 
	`wr™eq
(
‹mp
, 
de¡
);

267 
pbuf
->
ÿ¼y
.
v®64
 = 
Ãw
 >> 
	`zshiá
Õbuf->
ÿ¼y_by‹s
);

268 
	}
}

273 
šlše
 
	$ÿ¼y8_wr™e8
(
mix
 
ÿ¼y
, 
__iomem
 *
de¡
)

275 
	`wr™eq
(
ÿ¼y
.
v®64
, 
de¡
);

276 
	}
}

283 
šlše
 
	$ÿ¼y_wr™e8
(
pio_buf
 *
pbuf
, 
__iomem
 *
de¡
)

285 ià(
pbuf
->
ÿ¼y_by‹s
) {

287 
	`wr™eq
(
pbuf
->
ÿ¼y
.
v®64
, 
de¡
);

292 
	}
}

304 
	$£g_pio_cÝy_¡¬t
(
pio_buf
 *
pbuf
, 
u64
 
pbc
,

305 cÚ¡ *
äom
, 
size_t
 
nby‹s
)

307 
__iomem
 *
de¡
 = 
pbuf
->
¡¬t
 + 
SOP_DISTANCE
;

308 
__iomem
 *
£nd
 = 
de¡
 + 
PIO_BLOCK_SIZE
;

309 
__iomem
 *
d’d
;

311 
	`wr™eq
(
pbc
, 
de¡
);

312 
de¡
 +ð(
u64
);

315 
d’d
 = 
de¡
 + ((
nby‹s
 >> 3è* (
u64
));

317 ià(
d’d
 < 
£nd
) {

323 
de¡
 < 
d’d
) {

324 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

325 
äom
 +ð(
u64
);

326 
de¡
 +ð(
u64
);

339 
de¡
 < 
£nd
) {

340 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

341 
äom
 +ð(
u64
);

342 
de¡
 +ð(
u64
);

345 
de¡
 -ð
SOP_DISTANCE
;

346 
d’d
 -ð
SOP_DISTANCE
;

357 ià(
pbuf
->
’d
 <ð
d’d
) {

358 
de¡
 < 
pbuf
->
’d
) {

359 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

360 
äom
 +ð(
u64
);

361 
de¡
 +ð(
u64
);

364 
de¡
 -ð
pbuf
->
sc
->
size
;

365 
d’d
 -ð
pbuf
->
sc
->
size
;

369 
de¡
 < 
d’d
) {

370 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

371 
äom
 +ð(
u64
);

372 
de¡
 +ð(
u64
);

380 
	`»ad_low_by‹s
(
pbuf
, 
äom
, 
nby‹s
 & 0x7);

382 
pbuf
->
qw_wr™‹n
 = 1 + (
nby‹s
 >> 3);

383 
	}
}

397 
	$mid_cÝy_mix
(
pio_buf
 *
pbuf
, cÚ¡ *
äom
, 
size_t
 
nby‹s
)

399 
__iomem
 *
de¡
 = 
pbuf
->
¡¬t
 + (pbuf->
qw_wr™‹n
 * (
u64
));

400 
__iomem
 *
d’d
;

401 
qw_to_wr™e
 = 
nby‹s
 >> 3;

402 
by‹s_Ëá
 = 
nby‹s
 & 0x7;

405 
d’d
 = 
de¡
 + (
qw_to_wr™e
 * (
u64
));

407 ià(
pbuf
->
qw_wr™‹n
 < 
PIO_BLOCK_QWS
) {

413 
__iomem
 *
£nd
;

414 
__iomem
 *
x’d
;

420 
£nd
 = 
pbuf
->
¡¬t
 + 
PIO_BLOCK_SIZE
;

421 
x’d
 = 
	`mš
(
£nd
, 
d’d
);

424 
de¡
 +ð
SOP_DISTANCE
;

425 
x’d
 +ð
SOP_DISTANCE
;

428 
de¡
 < 
x’d
) {

429 
	`m”ge_wr™e8
(
pbuf
, 
de¡
, 
äom
);

430 
äom
 +ð(
u64
);

431 
de¡
 +ð(
u64
);

435 
de¡
 -ð
SOP_DISTANCE
;

454 ià(
pbuf
->
’d
 <ð
d’d
) {

455 
de¡
 < 
pbuf
->
’d
) {

456 
	`m”ge_wr™e8
(
pbuf
, 
de¡
, 
äom
);

457 
äom
 +ð(
u64
);

458 
de¡
 +ð(
u64
);

461 
de¡
 -ð
pbuf
->
sc
->
size
;

462 
d’d
 -ð
pbuf
->
sc
->
size
;

466 
de¡
 < 
d’d
) {

467 
	`m”ge_wr™e8
(
pbuf
, 
de¡
, 
äom
);

468 
äom
 +ð(
u64
);

469 
de¡
 +ð(
u64
);

472 
pbuf
->
qw_wr™‹n
 +ð
qw_to_wr™e
;

475 ià(
pbuf
->
ÿ¼y_by‹s
 + 
by‹s_Ëá
 >= 8) {

476 
Ä—d
;

479 
Ä—d
 = 8 - 
pbuf
->
ÿ¼y_by‹s
;

480 
	`»ad_exŒa_by‹s
(
pbuf
, 
äom
, 
Ä—d
);

494 ià(
de¡
 >ð
pbuf
->
’d
)

495 
de¡
 -ð
pbuf
->
sc
->
size
;

497 ià(
pbuf
->
qw_wr™‹n
 < 
PIO_BLOCK_QWS
)

498 
de¡
 +ð
SOP_DISTANCE
;

501 
	`ÿ¼y8_wr™e8
(
pbuf
->
ÿ¼y
, 
de¡
);

502 
pbuf
->
qw_wr™‹n
++;

505 
by‹s_Ëá
 -ð
Ä—d
;

506 
äom
 +ð
Ä—d
;

507 
	`»ad_low_by‹s
(
pbuf
, 
äom
, 
by‹s_Ëá
);

510 
	`»ad_exŒa_by‹s
(
pbuf
, 
äom
, 
by‹s_Ëá
);

512 
	}
}

524 
	$mid_cÝy_¡¿ight
(
pio_buf
 *
pbuf
,

525 cÚ¡ *
äom
, 
size_t
 
nby‹s
)

527 
__iomem
 *
de¡
 = 
pbuf
->
¡¬t
 + (pbuf->
qw_wr™‹n
 * (
u64
));

528 
__iomem
 *
d’d
;

531 
d’d
 = 
de¡
 + ((
nby‹s
 >> 3è* (
u64
));

533 ià(
pbuf
->
qw_wr™‹n
 < 
PIO_BLOCK_QWS
) {

539 
__iomem
 *
£nd
;

540 
__iomem
 *
x’d
;

546 
£nd
 = 
pbuf
->
¡¬t
 + 
PIO_BLOCK_SIZE
;

547 
x’d
 = 
	`mš
(
£nd
, 
d’d
);

550 
de¡
 +ð
SOP_DISTANCE
;

551 
x’d
 +ð
SOP_DISTANCE
;

554 
de¡
 < 
x’d
) {

555 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

556 
äom
 +ð(
u64
);

557 
de¡
 +ð(
u64
);

561 
de¡
 -ð
SOP_DISTANCE
;

580 ià(
pbuf
->
’d
 <ð
d’d
) {

581 
de¡
 < 
pbuf
->
’d
) {

582 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

583 
äom
 +ð(
u64
);

584 
de¡
 +ð(
u64
);

587 
de¡
 -ð
pbuf
->
sc
->
size
;

588 
d’d
 -ð
pbuf
->
sc
->
size
;

592 
de¡
 < 
d’d
) {

593 
	`wr™eq
(*(
u64
 *)
äom
, 
de¡
);

594 
äom
 +ð(
u64
);

595 
de¡
 +ð(
u64
);

599 
	`»ad_low_by‹s
(
pbuf
, 
äom
, 
nby‹s
 & 0x7);

601 
pbuf
->
qw_wr™‹n
 +ð
nby‹s
 >> 3;

602 
	}
}

613 
	$£g_pio_cÝy_mid
(
pio_buf
 *
pbuf
, cÚ¡ *
äom
, 
size_t
 
nby‹s
)

615 
äom_®ign
 = ()
äom
 & 0x7;

617 ià(
pbuf
->
ÿ¼y_by‹s
 + 
nby‹s
 < 8) {

619 
	`»ad_exŒa_by‹s
(
pbuf
, 
äom
, 
nby‹s
);

623 ià(
äom_®ign
) {

625 
to_®ign
;

628 
to_®ign
 = 8 - 
äom_®ign
;

636 ià(
pbuf
->
ÿ¼y_by‹s
 + 
to_®ign
 < 8) {

638 
	`»ad_exŒa_by‹s
(
pbuf
, 
äom
, 
to_®ign
);

639 
äom
 +ð
to_®ign
;

640 
nby‹s
 -ð
to_®ign
;

643 
to_fžl
 = 8 - 
pbuf
->
ÿ¼y_by‹s
;

645 
exŒa
 = 
to_®ign
 - 
to_fžl
;

646 
__iomem
 *
de¡
;

649 
	`»ad_exŒa_by‹s
(
pbuf
, 
äom
, 
to_fžl
);

650 
äom
 +ð
to_fžl
;

651 
nby‹s
 -ð
to_fžl
;

653 ià(
exŒa
 > 
nby‹s
)

654 
exŒa
 = 
nby‹s
;

657 
de¡
 = 
pbuf
->
¡¬t
 + (pbuf->
qw_wr™‹n
 * (
u64
));

668 ià(
de¡
 >ð
pbuf
->
’d
)

669 
de¡
 -ð
pbuf
->
sc
->
size
;

671 ià(
pbuf
->
qw_wr™‹n
 < 
PIO_BLOCK_QWS
)

672 
de¡
 +ð
SOP_DISTANCE
;

674 
	`ÿ¼y8_wr™e8
(
pbuf
->
ÿ¼y
, 
de¡
);

675 
pbuf
->
qw_wr™‹n
++;

679 
	`»ad_low_by‹s
(
pbuf
, 
äom
, 
exŒa
);

680 
äom
 +ð
exŒa
;

681 
nby‹s
 -ð
exŒa
;

689 ià(
nby‹s
 == 0)

696 ià(
pbuf
->
ÿ¼y_by‹s
)

697 
	`mid_cÝy_mix
(
pbuf
, 
äom
, 
nby‹s
);

699 
	`mid_cÝy_¡¿ight
(
pbuf
, 
äom
, 
nby‹s
);

700 
	}
}

709 
	$£g_pio_cÝy_’d
(
pio_buf
 *
pbuf
)

711 
__iomem
 *
de¡
 = 
pbuf
->
¡¬t
 + (pbuf->
qw_wr™‹n
 * (
u64
));

721 ià(
de¡
 >ð
pbuf
->
’d
)

722 
de¡
 -ð
pbuf
->
sc
->
size
;

724 ià(
pbuf
->
qw_wr™‹n
 < 
PIO_BLOCK_QWS
)

725 
de¡
 +ð
SOP_DISTANCE
;

728 ià(
	`ÿ¼y_wr™e8
(
pbuf
, 
de¡
)) {

729 
de¡
 +ð(
u64
);

749 (()
de¡
 & 
PIO_BLOCK_MASK
) != 0) {

750 
	`wr™eq
(0, 
de¡
);

751 
de¡
 +ð(
u64
);

755 
	`this_ýu_dec
(*
pbuf
->
sc
->
bufãrs_®loÿ‹d
);

756 
	`´“m±_’abË
();

757 
	}
}

	@platform.c

48 
	~<lšux/fœmw¬e.h
>

50 
	~"hfi.h
"

51 
	~"efiv¬.h
"

52 
	~"•rom.h
"

54 
	#DEFAULT_PLATFORM_CONFIG_NAME
 "hfi1_¶©fÜm.d©"

	)

56 
	$v®id©e_sü©ch_checksum
(
hfi1_devd©a
 *
dd
)

58 
u64
 
checksum
 = 0, 
‹mp_sü©ch
 = 0;

59 
i
, 
j
, 
v”siÚ
;

61 
‹mp_sü©ch
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

62 
v”siÚ
 = (
‹mp_sü©ch
 & 
BITMAP_VERSION_SMASK
è>> 
BITMAP_VERSION_SHIFT
;

65 ià(!
v”siÚ
) {

66 
	`dd_dev_”r
(
dd
, "%s: CÚfig b™m­ unš™Ÿlized\n", 
__func__
);

67 
	`dd_dev_”r
(
dd
,

69 
__func__
);

78 
checksum
 +ð
v”siÚ
;

79 
i
 = 1; i < 
ASIC_NUM_SCRATCH
; i++) {

80 
‹mp_sü©ch
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
 + (8 * 
i
));

81 
j
 = (
u64
); j != 0; j -= 2) {

82 
checksum
 +ð(
‹mp_sü©ch
 & 0xFFFF);

83 
‹mp_sü©ch
 >>= 16;

87 
checksum
 >> 16)

88 
checksum
 = (checksum & 
CHECKSUM_MASK
) + (checksum >> 16);

90 
‹mp_sü©ch
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH
);

91 
‹mp_sü©ch
 &ð
CHECKSUM_SMASK
;

92 
‹mp_sü©ch
 >>ð
CHECKSUM_SHIFT
;

94 ià(
checksum
 + 
‹mp_sü©ch
 == 0xFFFF)

97 
	`dd_dev_”r
(
dd
, "%s: CÚfigu¿tiÚ b™m­ cÜru±ed\n", 
__func__
);

99 
	}
}

101 
	$§ve_¶©fÜm_cÚfig_f›lds
(
hfi1_devd©a
 *
dd
)

103 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

104 
u64
 
‹mp_sü©ch
 = 0, 
‹mp_de¡
 = 0;

106 
‹mp_sü©ch
 = 
	`»ad_c¤
(
dd
, 
ASIC_CFG_SCRATCH_1
);

108 
‹mp_de¡
 = 
‹mp_sü©ch
 &

109 (
dd
->
hfi1_id
 ? 
PORT1_PORT_TYPE_SMASK
 :

110 
PORT0_PORT_TYPE_SMASK
);

111 
µd
->
pÜt_ty³
 = 
‹mp_de¡
 >>

112 (
dd
->
hfi1_id
 ? 
PORT1_PORT_TYPE_SHIFT
 :

113 
PORT0_PORT_TYPE_SHIFT
);

115 
‹mp_de¡
 = 
‹mp_sü©ch
 &

116 (
dd
->
hfi1_id
 ? 
PORT1_LOCAL_ATTEN_SMASK
 :

117 
PORT0_LOCAL_ATTEN_SMASK
);

118 
µd
->
loÿl_©‹n
 = 
‹mp_de¡
 >>

119 (
dd
->
hfi1_id
 ? 
PORT1_LOCAL_ATTEN_SHIFT
 :

120 
PORT0_LOCAL_ATTEN_SHIFT
);

122 
‹mp_de¡
 = 
‹mp_sü©ch
 &

123 (
dd
->
hfi1_id
 ? 
PORT1_REMOTE_ATTEN_SMASK
 :

124 
PORT0_REMOTE_ATTEN_SMASK
);

125 
µd
->
»mÙe_©‹n
 = 
‹mp_de¡
 >>

126 (
dd
->
hfi1_id
 ? 
PORT1_REMOTE_ATTEN_SHIFT
 :

127 
PORT0_REMOTE_ATTEN_SHIFT
);

129 
‹mp_de¡
 = 
‹mp_sü©ch
 &

130 (
dd
->
hfi1_id
 ? 
PORT1_DEFAULT_ATTEN_SMASK
 :

131 
PORT0_DEFAULT_ATTEN_SMASK
);

132 
µd
->
deçuÉ_©‹n
 = 
‹mp_de¡
 >>

133 (
dd
->
hfi1_id
 ? 
PORT1_DEFAULT_ATTEN_SHIFT
 :

134 
PORT0_DEFAULT_ATTEN_SHIFT
);

136 
‹mp_sü©ch
 = 
	`»ad_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_CFG_SCRATCH_3
 :

137 
ASIC_CFG_SCRATCH_2
);

139 
µd
->
tx_´e£t_eq
 = (
‹mp_sü©ch
 & 
TX_EQ_SMASK
è>> 
TX_EQ_SHIFT
;

140 
µd
->
tx_´e£t_nÛq
 = (
‹mp_sü©ch
 & 
TX_NO_EQ_SMASK
è>> 
TX_NO_EQ_SHIFT
;

141 
µd
->
rx_´e£t
 = (
‹mp_sü©ch
 & 
RX_SMASK
è>> 
RX_SHIFT
;

143 
µd
->
max_pow”_þass
 = (
‹mp_sü©ch
 & 
QSFP_MAX_POWER_SMASK
) >>

144 
QSFP_MAX_POWER_SHIFT
;

146 
µd
->
cÚfig_äom_sü©ch
 = 
Œue
;

147 
	}
}

149 
	$g‘_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
)

151 
»t
 = 0;

152 
u8
 *
‹mp_¶©fÜm_cÚfig
 = 
NULL
;

153 
u32
 
esize
;

154 cÚ¡ 
fœmw¬e
 *
¶©fÜm_cÚfig_fže
 = 
NULL
;

156 ià(
	`is_š‹g¿‹d
(
dd
)) {

157 ià(
	`v®id©e_sü©ch_checksum
(
dd
)) {

158 
	`§ve_¶©fÜm_cÚfig_f›lds
(
dd
);

162 
»t
 = 
	`•rom_»ad_¶©fÜm_cÚfig
(
dd
,

163 (**)&
‹mp_¶©fÜm_cÚfig
,

164 &
esize
);

165 ià(!
»t
) {

167 
dd
->
¶©fÜm_cÚfig
.
d©a
 = 
‹mp_¶©fÜm_cÚfig
;

168 
dd
->
¶©fÜm_cÚfig
.
size
 = 
esize
;

172 
	`dd_dev_”r
(
dd
,

174 
__func__
);

176 
»t
 = 
	`»que¡_fœmw¬e
(&
¶©fÜm_cÚfig_fže
,

177 
DEFAULT_PLATFORM_CONFIG_NAME
,

178 &
dd
->
pcidev
->
dev
);

179 ià(
»t
) {

180 
	`dd_dev_”r
(
dd
,

182 
__func__
);

191 
dd
->
¶©fÜm_cÚfig
.
d©a
 = 
	`kmemdup
(
¶©fÜm_cÚfig_fže
->data,

192 
¶©fÜm_cÚfig_fže
->
size
,

193 
GFP_KERNEL
);

194 
dd
->
¶©fÜm_cÚfig
.
size
 = 
¶©fÜm_cÚfig_fže
->size;

195 
	`»Ëa£_fœmw¬e
(
¶©fÜm_cÚfig_fže
);

196 
	}
}

198 
	$ä“_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
)

201 
	`kä“
(
dd
->
¶©fÜm_cÚfig
.
d©a
);

202 
dd
->
¶©fÜm_cÚfig
.
d©a
 = 
NULL
;

203 
	}
}

205 
	$g‘_pÜt_ty³
(
hfi1_µÜtd©a
 *
µd
)

207 
»t
;

208 
u32
 
‹mp
;

210 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

211 
PORT_TABLE_PORT_TYPE
, &
‹mp
,

213 ià(
»t
) {

214 
µd
->
pÜt_ty³
 = 
PORT_TYPE_UNKNOWN
;

217 
µd
->
pÜt_ty³
 = 
‹mp
;

218 
	}
}

220 
	$£t_qså_tx
(
hfi1_µÜtd©a
 *
µd
, 
Ú
)

222 
u8
 
tx_ù¾_by‹
 = 
Ú
 ? 0x0 : 0xF;

223 
»t
 = 0;

225 
»t
 = 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, 
QSFP_TX_CTRL_BYTE_OFFS
,

226 &
tx_ù¾_by‹
, 1);

228 ià(
»t
 == 0)

229 
»t
 = -
EIO
;

230 ià(
»t
 == 1)

231 
»t
 = 0;

232  
»t
;

233 
	}
}

235 
	$qu®_pow”
(
hfi1_µÜtd©a
 *
µd
)

237 
u32
 
ÿbË_pow”_þass
 = 0, 
pow”_þass_max
 = 0;

238 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

239 
»t
 = 0;

241 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

242 
µd
->
dd
, 
PLATFORM_CONFIG_SYSTEM_TABLE
, 0,

243 
SYSTEM_TABLE_QSFP_POWER_CLASS_MAX
, &
pow”_þass_max
, 4);

244 ià(
»t
)

245  
»t
;

247 
ÿbË_pow”_þass
 = 
	`g‘_qså_pow”_þass
(
ÿche
[
QSFP_MOD_PWR_OFFS
]);

249 ià(
ÿbË_pow”_þass
 > 
pow”_þass_max
)

250 
µd
->
ofæše_di§bËd_»asÚ
 =

251 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_POWER_POLICY
);

253 ià(
µd
->
ofæše_di§bËd_»asÚ
 ==

254 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_POWER_POLICY
)) {

255 
	`dd_dev_”r
(

256 
µd
->
dd
,

258 
__func__
);

259 
»t
 = -
EPERM
;

261  
»t
;

262 
	}
}

264 
	$qu®_b™¿‹
(
hfi1_µÜtd©a
 *
µd
)

266 
u16
 
lss
 = 
µd
->
lšk_¥“d_suµÜ‹d
, 
l£
 =…pd->
lšk_¥“d_’abËd
;

267 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

269 ià((
lss
 & 
OPA_LINK_SPEED_25G
è&& (
l£
 & OPA_LINK_SPEED_25G) &&

270 
ÿche
[
QSFP_NOM_BIT_RATE_250_OFFS
] < 0x64)

271 
µd
->
ofæše_di§bËd_»asÚ
 =

272 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_LINKSPEED_POLICY
);

274 ià((
lss
 & 
OPA_LINK_SPEED_12_5G
è&& (
l£
 & OPA_LINK_SPEED_12_5G) &&

275 
ÿche
[
QSFP_NOM_BIT_RATE_100_OFFS
] < 0x7D)

276 
µd
->
ofæše_di§bËd_»asÚ
 =

277 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_LINKSPEED_POLICY
);

279 ià(
µd
->
ofæše_di§bËd_»asÚ
 ==

280 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_LINKSPEED_POLICY
)) {

281 
	`dd_dev_”r
(

282 
µd
->
dd
,

284 
__func__
);

285  -
EPERM
;

288 
	}
}

290 
	$£t_qså_high_pow”
(
hfi1_µÜtd©a
 *
µd
)

292 
u8
 
ÿbË_pow”_þass
 = 0, 
pow”_ù¾_by‹
 = 0;

293 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

294 
»t
;

296 
ÿbË_pow”_þass
 = 
	`g‘_qså_pow”_þass
(
ÿche
[
QSFP_MOD_PWR_OFFS
]);

298 ià(
ÿbË_pow”_þass
 > 
QSFP_POWER_CLASS_1
) {

299 
pow”_ù¾_by‹
 = 
ÿche
[
QSFP_PWR_CTRL_BYTE_OFFS
];

301 
pow”_ù¾_by‹
 |= 1;

302 
pow”_ù¾_by‹
 &= ~(0x2);

304 
»t
 = 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
,

305 
QSFP_PWR_CTRL_BYTE_OFFS
,

306 &
pow”_ù¾_by‹
, 1);

307 ià(
»t
 != 1)

308  -
EIO
;

310 ià(
ÿbË_pow”_þass
 > 
QSFP_POWER_CLASS_4
) {

311 
pow”_ù¾_by‹
 |= (1 << 2);

312 
»t
 = 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
,

313 
QSFP_PWR_CTRL_BYTE_OFFS
,

314 &
pow”_ù¾_by‹
, 1);

315 ià(
»t
 != 1)

316  -
EIO
;

320 
	`m¦“p
(300);

323 
	}
}

325 
	$­¶y_rx_cdr
(
hfi1_µÜtd©a
 *
µd
,

326 
u32
 
rx_´e£t_šdex
,

327 
u8
 *
cdr_ù¾_by‹
)

329 
u32
 
rx_´e£t
;

330 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

331 
ÿbË_pow”_þass
;

333 ià(!((
ÿche
[
QSFP_MOD_PWR_OFFS
] & 0x4) &&

334 (
ÿche
[
QSFP_CDR_INFO_OFFS
] & 0x40)))

338 
ÿbË_pow”_þass
 = 
	`g‘_qså_pow”_þass
(
ÿche
[
QSFP_MOD_PWR_OFFS
]);

340 ià(
ÿbË_pow”_þass
 <ð
QSFP_POWER_CLASS_3
) {

342 *
cdr_ù¾_by‹
 |= 0xF;

346 
	`g‘_¶©fÜm_cÚfig_f›ld
(

347 
µd
->
dd
, 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

348 
rx_´e£t_šdex
, 
RX_PRESET_TABLE_QSFP_RX_CDR_APPLY
,

349 &
rx_´e£t
, 4);

351 ià(!
rx_´e£t
) {

352 
	`dd_dev_šfo
(

353 
µd
->
dd
,

355 
__func__
);

358 
	`g‘_¶©fÜm_cÚfig_f›ld
(

359 
µd
->
dd
, 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

360 
rx_´e£t_šdex
, 
RX_PRESET_TABLE_QSFP_RX_CDR
,

361 &
rx_´e£t
, 4);

364 
rx_´e£t
 = (rx_preset | (rx_preset << 1) |

365 (
rx_´e£t
 << 2) | (rx_preset << 3));

367 ià(
rx_´e£t
) {

368 *
cdr_ù¾_by‹
 |ð
rx_´e£t
;

370 *
cdr_ù¾_by‹
 &ð
rx_´e£t
;

372 *
cdr_ù¾_by‹
 |ð(
ÿche
[
QSFP_CDR_CTRL_BYTE_OFFS
] & 0xF0);

374 
	}
}

376 
	$­¶y_tx_cdr
(
hfi1_µÜtd©a
 *
µd
,

377 
u32
 
tx_´e£t_šdex
,

378 
u8
 *
cdr_ù¾_by‹
)

380 
u32
 
tx_´e£t
;

381 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

382 
ÿbË_pow”_þass
;

384 ià(!((
ÿche
[
QSFP_MOD_PWR_OFFS
] & 0x8) &&

385 (
ÿche
[
QSFP_CDR_INFO_OFFS
] & 0x80)))

389 
ÿbË_pow”_þass
 = 
	`g‘_qså_pow”_þass
(
ÿche
[
QSFP_MOD_PWR_OFFS
]);

391 ià(
ÿbË_pow”_þass
 <ð
QSFP_POWER_CLASS_3
) {

393 *
cdr_ù¾_by‹
 |= 0xF0;

397 
	`g‘_¶©fÜm_cÚfig_f›ld
(

398 
µd
->
dd
,

399 
PLATFORM_CONFIG_TX_PRESET_TABLE
, 
tx_´e£t_šdex
,

400 
TX_PRESET_TABLE_QSFP_TX_CDR_APPLY
, &
tx_´e£t
, 4);

402 ià(!
tx_´e£t
) {

403 
	`dd_dev_šfo
(

404 
µd
->
dd
,

406 
__func__
);

409 
	`g‘_¶©fÜm_cÚfig_f›ld
(

410 
µd
->
dd
,

411 
PLATFORM_CONFIG_TX_PRESET_TABLE
,

412 
tx_´e£t_šdex
,

413 
TX_PRESET_TABLE_QSFP_TX_CDR
, &
tx_´e£t
, 4);

416 
tx_´e£t
 = (tx_preset | (tx_preset << 1) |

417 (
tx_´e£t
 << 2) | (tx_preset << 3));

419 ià(
tx_´e£t
)

420 *
cdr_ù¾_by‹
 |ð(
tx_´e£t
 << 4);

423 *
cdr_ù¾_by‹
 &ð((
tx_´e£t
 << 4) | 0xF);

424 
	}
}

426 
	$­¶y_cdr_£‰šgs
(

427 
hfi1_µÜtd©a
 *
µd
, 
u32
 
rx_´e£t_šdex
,

428 
u32
 
tx_´e£t_šdex
)

430 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

431 
u8
 
cdr_ù¾_by‹
 = 
ÿche
[
QSFP_CDR_CTRL_BYTE_OFFS
];

433 
	`­¶y_rx_cdr
(
µd
, 
rx_´e£t_šdex
, &
cdr_ù¾_by‹
);

435 
	`­¶y_tx_cdr
(
µd
, 
tx_´e£t_šdex
, &
cdr_ù¾_by‹
);

437 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, 
QSFP_CDR_CTRL_BYTE_OFFS
,

438 &
cdr_ù¾_by‹
, 1);

439 
	}
}

441 
	$­¶y_tx_eq_auto
(
hfi1_µÜtd©a
 *
µd
)

443 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

444 
u8
 
tx_eq
;

446 ià(!(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x8))

449 
tx_eq
 = 
ÿche
[(128 * 3) + 241];

450 
tx_eq
 &= 0xF0;

451 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 241, &
tx_eq
, 1);

452 
	}
}

454 
	$­¶y_tx_eq_´og
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
tx_´e£t_šdex
)

456 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

457 
u32
 
tx_´e£t
;

458 
u8
 
tx_eq
;

460 ià(!(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x4))

463 
	`g‘_¶©fÜm_cÚfig_f›ld
(

464 
µd
->
dd
, 
PLATFORM_CONFIG_TX_PRESET_TABLE
,

465 
tx_´e£t_šdex
, 
TX_PRESET_TABLE_QSFP_TX_EQ_APPLY
,

466 &
tx_´e£t
, 4);

467 ià(!
tx_´e£t
) {

468 
	`dd_dev_šfo
(

469 
µd
->
dd
,

471 
__func__
);

474 
	`g‘_¶©fÜm_cÚfig_f›ld
(

475 
µd
->
dd
, 
PLATFORM_CONFIG_TX_PRESET_TABLE
,

476 
tx_´e£t_šdex
, 
TX_PRESET_TABLE_QSFP_TX_EQ
,

477 &
tx_´e£t
, 4);

479 ià(((
ÿche
[(128 * 3è+ 224] & 0xF0è>> 4è< 
tx_´e£t
) {

480 
	`dd_dev_šfo
(

481 
µd
->
dd
,

483 
__func__
, 
tx_´e£t
);

485 
	`dd_dev_šfo
(

486 
µd
->
dd
,

488 
__func__
, 
ÿche
[608] & 0xF0);

490 
tx_´e£t
 = (
ÿche
[608] & 0xF0) >> 4;

493 
tx_eq
 = 
tx_´e£t
 | (tx_preset << 4);

494 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 234, &
tx_eq
, 1);

495 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 235, &
tx_eq
, 1);

496 
	}
}

498 
	$­¶y_rx_eq_emp
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rx_´e£t_šdex
)

500 
u32
 
rx_´e£t
;

501 
u8
 
rx_eq
, *
ÿche
 = 
µd
->
qså_šfo
.cache;

503 ià(!(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x2))

505 
	`g‘_¶©fÜm_cÚfig_f›ld
(

506 
µd
->
dd
, 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

507 
rx_´e£t_šdex
, 
RX_PRESET_TABLE_QSFP_RX_EMP_APPLY
,

508 &
rx_´e£t
, 4);

510 ià(!
rx_´e£t
) {

511 
	`dd_dev_šfo
(

512 
µd
->
dd
,

514 
__func__
);

517 
	`g‘_¶©fÜm_cÚfig_f›ld
(

518 
µd
->
dd
, 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

519 
rx_´e£t_šdex
, 
RX_PRESET_TABLE_QSFP_RX_EMP
,

520 &
rx_´e£t
, 4);

522 ià((
ÿche
[(128 * 3è+ 224] & 0xFè< 
rx_´e£t
) {

523 
	`dd_dev_šfo
(

524 
µd
->
dd
,

526 
__func__
, 
rx_´e£t
);

528 
	`dd_dev_šfo
(

529 
µd
->
dd
,

531 
__func__
, 
ÿche
[608] & 0xF);

533 
rx_´e£t
 = 
ÿche
[608] & 0xF;

536 
rx_eq
 = 
rx_´e£t
 | (rx_preset << 4);

538 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 236, &
rx_eq
, 1);

539 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 237, &
rx_eq
, 1);

540 
	}
}

542 
	$­¶y_eq_£‰šgs
(
hfi1_µÜtd©a
 *
µd
,

543 
u32
 
rx_´e£t_šdex
, u32 
tx_´e£t_šdex
)

545 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

548 ià(
ÿche
[2] & 4) {

549 
	`dd_dev_šfo
(
µd
->
dd
,

551 
__func__
);

555 
	`­¶y_tx_eq_auto
(
µd
);

557 
	`­¶y_tx_eq_´og
(
µd
, 
tx_´e£t_šdex
);

559 
	`­¶y_rx_eq_emp
(
µd
, 
rx_´e£t_šdex
);

560 
	}
}

562 
	$­¶y_rx_am¶™ude_£‰šgs
(

563 
hfi1_µÜtd©a
 *
µd
, 
u32
 
rx_´e£t_šdex
,

564 
u32
 
tx_´e£t_šdex
)

566 
u32
 
rx_´e£t
;

567 
u8
 
rx_amp
 = 0, 
i
 = 0, 
´eã¼ed
 = 0, *
ÿche
 = 
µd
->
qså_šfo
.cache;

570 ià(
ÿche
[2] & 4) {

571 
	`dd_dev_šfo
(
µd
->
dd
,

573 
__func__
);

576 ià(!(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x1)) {

577 
	`dd_dev_šfo
(
µd
->
dd
,

579 
__func__
);

583 
	`g‘_¶©fÜm_cÚfig_f›ld
(
µd
->
dd
,

584 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

585 
rx_´e£t_šdex
,

586 
RX_PRESET_TABLE_QSFP_RX_AMP_APPLY
,

587 &
rx_´e£t
, 4);

589 ià(!
rx_´e£t
) {

590 
	`dd_dev_šfo
(
µd
->
dd
,

592 
__func__
);

595 
	`g‘_¶©fÜm_cÚfig_f›ld
(
µd
->
dd
,

596 
PLATFORM_CONFIG_RX_PRESET_TABLE
,

597 
rx_´e£t_šdex
,

598 
RX_PRESET_TABLE_QSFP_RX_AMP
,

599 &
rx_´e£t
, 4);

601 
	`dd_dev_šfo
(
µd
->
dd
,

603 
__func__
,

604 
rx_´e£t
);

606 
i
 = 0; i < 4; i++) {

607 ià(
ÿche
[(128 * 3è+ 225] & (1 << 
i
)) {

608 
´eã¼ed
 = 
i
;

609 ià(
´eã¼ed
 =ð
rx_´e£t
)

618 ià(!
´eã¼ed
 && !(
ÿche
[(128 * 3) + 225] & 0x1)) {

619 
	`dd_dev_šfo
(
µd
->
dd
, "No supported RX AMP,‚ot‡pplying\n");

623 
	`dd_dev_šfo
(
µd
->
dd
,

624 "%s: Aµlyšg RX AMP %x\n", 
__func__
, 
´eã¼ed
);

626 
rx_amp
 = 
´eã¼ed
 | (preferred << 4);

627 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 238, &
rx_amp
, 1);

628 
	`qså_wr™e
(
µd
,…pd->
dd
->
hfi1_id
, (256 * 3è+ 239, &
rx_amp
, 1);

629 
	}
}

631 
	#OPA_INVALID_INDEX
 0xFFF

	)

633 
	$­¶y_tx_ÏÃs
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
f›ld_id
,

634 
u32
 
cÚfig_d©a
, cÚ¡ *
mes§ge
)

636 
u8
 
i
;

637 
»t
 = 
HCMD_SUCCESS
;

639 
i
 = 0; i < 4; i++) {

640 
»t
 = 
	`lßd_8051_cÚfig
(
µd
->
dd
, 
f›ld_id
, 
i
, 
cÚfig_d©a
);

641 ià(
»t
 !ð
HCMD_SUCCESS
) {

642 
	`dd_dev_”r
(

643 
µd
->
dd
,

645 
mes§ge
, 
__func__
, 
i
);

648 
	}
}

660 
u8
 
	$aoc_low_pow”_£‰šg
(
hfi1_µÜtd©a
 *
µd
)

662 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

663 
pow”_þass
;

666 ià(
µd
->
pÜt_ty³
 !ð
PORT_TYPE_QSFP
)

670 (
ÿche
[
QSFP_MOD_TECH_OFFS
] & 0xF0) >> 4) {

675 
pow”_þass
 = 
	`g‘_qså_pow”_þass
(
ÿche
[
QSFP_MOD_PWR_OFFS
]);

676 ià(
pow”_þass
 < 
QSFP_POWER_CLASS_4
)

680 
	}
}

682 
	$­¶y_tunšgs
(

683 
hfi1_µÜtd©a
 *
µd
, 
u32
 
tx_´e£t_šdex
,

684 
u8
 
tunšg_m‘hod
, 
u32
 
tÙ®_©‹n
, u8 
lim™šg_aùive
)

686 
»t
 = 0;

687 
u32
 
cÚfig_d©a
 = 0, 
tx_´e£t
 = 0;

688 
u8
 
´ecur
 = 0, 
©Š
 = 0, 
po¡cur
 = 0, 
ex‹º®_deviû_cÚfig
 = 0;

689 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

692 
	`»ad_8051_cÚfig
(
µd
->
dd
, 
LINK_TUNING_PARAMETERS
, 
GENERAL_CONFIG
,

693 &
cÚfig_d©a
);

694 
cÚfig_d©a
 &ð~(0xfà<< 
TUNING_METHOD_SHIFT
);

695 
cÚfig_d©a
 |ð((
u32
)
tunšg_m‘hod
 << 
TUNING_METHOD_SHIFT
);

696 
»t
 = 
	`lßd_8051_cÚfig
(
µd
->
dd
, 
LINK_TUNING_PARAMETERS
, 
GENERAL_CONFIG
,

697 
cÚfig_d©a
);

698 ià(
»t
 !ð
HCMD_SUCCESS
)

699 
	`dd_dev_”r
(
µd
->
dd
, "%s: Failedo setuning method\n",

700 
__func__
);

703 
cÚfig_d©a
 = 0 | (
tÙ®_©‹n
 << 16) | (total_atten << 24);

704 
	`­¶y_tx_ÏÃs
(
µd
, 
CHANNEL_LOSS_SETTINGS
, 
cÚfig_d©a
,

708 ià(
µd
->
qså_šfo
.
ÿche_v®id
) {

709 
ex‹º®_deviû_cÚfig
 =

710 ((
ÿche
[
QSFP_MOD_PWR_OFFS
] & 0x4) << 3) |

711 ((
ÿche
[
QSFP_MOD_PWR_OFFS
] & 0x8) << 2) |

712 ((
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x2) << 1) |

713 (
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x4);

714 
»t
 = 
	`»ad_8051_cÚfig
(
µd
->
dd
, 
DC_HOST_COMM_SETTINGS
,

715 
GENERAL_CONFIG
, &
cÚfig_d©a
);

717 
cÚfig_d©a
 &ð~(
u32
)0xFF;

718 
cÚfig_d©a
 |ð
ex‹º®_deviû_cÚfig
;

719 
»t
 = 
	`lßd_8051_cÚfig
(
µd
->
dd
, 
DC_HOST_COMM_SETTINGS
,

720 
GENERAL_CONFIG
, 
cÚfig_d©a
);

721 ià(
»t
 !ð
HCMD_SUCCESS
)

722 
	`dd_dev_”r
(
µd
->
dd
,

724 
__func__
);

727 ià(
tx_´e£t_šdex
 =ð
OPA_INVALID_INDEX
) {

728 ià(
µd
->
pÜt_ty³
 =ð
PORT_TYPE_QSFP
 && 
lim™šg_aùive
)

729 
	`dd_dev_”r
(
µd
->
dd
, "%s: Invalid Tx…reset index\n",

730 
__func__
);

735 
	`g‘_¶©fÜm_cÚfig_f›ld
(

736 
µd
->
dd
, 
PLATFORM_CONFIG_TX_PRESET_TABLE
, 
tx_´e£t_šdex
,

737 
TX_PRESET_TABLE_PRECUR
, &
tx_´e£t
, 4);

738 
´ecur
 = 
tx_´e£t
;

740 
	`g‘_¶©fÜm_cÚfig_f›ld
(

741 
µd
->
dd
, 
PLATFORM_CONFIG_TX_PRESET_TABLE
,

742 
tx_´e£t_šdex
, 
TX_PRESET_TABLE_ATTN
, &
tx_´e£t
, 4);

743 
©Š
 = 
tx_´e£t
;

745 
	`g‘_¶©fÜm_cÚfig_f›ld
(

746 
µd
->
dd
, 
PLATFORM_CONFIG_TX_PRESET_TABLE
,

747 
tx_´e£t_šdex
, 
TX_PRESET_TABLE_POSTCUR
, &
tx_´e£t
, 4);

748 
po¡cur
 = 
tx_´e£t
;

759 
cÚfig_d©a
 = 
´ecur
 | (
©Š
 << 8è| (
po¡cur
 << 16) |

760 (
	`aoc_low_pow”_£‰šg
(
µd
) << 24);

762 
	`­¶y_tx_ÏÃs
(
µd
, 
TX_EQ_SETTINGS
, 
cÚfig_d©a
,

764 
	}
}

767 
	$tuÃ_aùive_qså
(
hfi1_µÜtd©a
 *
µd
, 
u32
 *
±r_tx_´e£t
,

768 
u32
 *
±r_rx_´e£t
, u32 *
±r_tÙ®_©‹n
)

770 
»t
;

771 
u16
 
lss
 = 
µd
->
lšk_¥“d_suµÜ‹d
, 
l£
 =…pd->
lšk_¥“d_’abËd
;

772 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

774 
µd
->
qså_šfo
.
lim™šg_aùive
 = 1;

776 
»t
 = 
	`£t_qså_tx
(
µd
, 0);

777 ià(
»t
)

778  
»t
;

780 
»t
 = 
	`qu®_pow”
(
µd
);

781 ià(
»t
)

782  
»t
;

784 
»t
 = 
	`qu®_b™¿‹
(
µd
);

785 ià(
»t
)

786  
»t
;

793 ià(
µd
->
qså_šfo
.
»£t_Ãeded
) {

794 
»t
 = 
	`»£t_qså
(
µd
);

795 ià(
»t
)

796  
»t
;

797 
	`»äesh_qså_ÿche
(
µd
, &µd->
qså_šfo
);

799 
µd
->
qså_šfo
.
»£t_Ãeded
 = 1;

802 
»t
 = 
	`£t_qså_high_pow”
(
µd
);

803 ià(
»t
)

804  
»t
;

806 ià(
ÿche
[
QSFP_EQ_INFO_OFFS
] & 0x4) {

807 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

808 
µd
->
dd
,

809 
PLATFORM_CONFIG_PORT_TABLE
, 0,

810 
PORT_TABLE_TX_PRESET_IDX_ACTIVE_EQ
,

811 
±r_tx_´e£t
, 4);

812 ià(
»t
) {

813 *
±r_tx_´e£t
 = 
OPA_INVALID_INDEX
;

814  
»t
;

817 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

818 
µd
->
dd
,

819 
PLATFORM_CONFIG_PORT_TABLE
, 0,

820 
PORT_TABLE_TX_PRESET_IDX_ACTIVE_NO_EQ
,

821 
±r_tx_´e£t
, 4);

822 ià(
»t
) {

823 *
±r_tx_´e£t
 = 
OPA_INVALID_INDEX
;

824  
»t
;

828 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

829 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

830 
PORT_TABLE_RX_PRESET_IDX
, 
±r_rx_´e£t
, 4);

831 ià(
»t
) {

832 *
±r_rx_´e£t
 = 
OPA_INVALID_INDEX
;

833  
»t
;

836 ià((
lss
 & 
OPA_LINK_SPEED_25G
è&& (
l£
 & OPA_LINK_SPEED_25G))

837 
	`g‘_¶©fÜm_cÚfig_f›ld
(

838 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

839 
PORT_TABLE_LOCAL_ATTEN_25G
, 
±r_tÙ®_©‹n
, 4);

840 ià((
lss
 & 
OPA_LINK_SPEED_12_5G
è&& (
l£
 & OPA_LINK_SPEED_12_5G))

841 
	`g‘_¶©fÜm_cÚfig_f›ld
(

842 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

843 
PORT_TABLE_LOCAL_ATTEN_12G
, 
±r_tÙ®_©‹n
, 4);

845 
	`­¶y_cdr_£‰šgs
(
µd
, *
±r_rx_´e£t
, *
±r_tx_´e£t
);

847 
	`­¶y_eq_£‰šgs
(
µd
, *
±r_rx_´e£t
, *
±r_tx_´e£t
);

849 
	`­¶y_rx_am¶™ude_£‰šgs
(
µd
, *
±r_rx_´e£t
, *
±r_tx_´e£t
);

851 
»t
 = 
	`£t_qså_tx
(
µd
, 1);

853  
»t
;

854 
	}
}

856 
	$tuÃ_qså
(
hfi1_µÜtd©a
 *
µd
,

857 
u32
 *
±r_tx_´e£t
, u32 *
±r_rx_´e£t
,

858 
u8
 *
±r_tunšg_m‘hod
, 
u32
 *
±r_tÙ®_©‹n
)

860 
u32
 
ÿbË_©‹n
 = 0, 
»mÙe_©‹n
 = 0, 
¶©fÜm_©‹n
 = 0;

861 
u16
 
lss
 = 
µd
->
lšk_¥“d_suµÜ‹d
, 
l£
 =…pd->
lšk_¥“d_’abËd
;

862 
»t
 = 0;

863 
u8
 *
ÿche
 = 
µd
->
qså_šfo
.cache;

865 (
ÿche
[
QSFP_MOD_TECH_OFFS
] & 0xF0) >> 4) {

867 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

868 
µd
->
dd
,

869 
PLATFORM_CONFIG_PORT_TABLE
, 0,

870 
PORT_TABLE_LOCAL_ATTEN_25G
,

871 &
¶©fÜm_©‹n
, 4);

872 ià(
»t
)

873  
»t
;

875 ià((
lss
 & 
OPA_LINK_SPEED_25G
è&& (
l£
 & OPA_LINK_SPEED_25G))

876 
ÿbË_©‹n
 = 
ÿche
[
QSFP_CU_ATTEN_12G_OFFS
];

877 ià((
lss
 & 
OPA_LINK_SPEED_12_5G
) &&

878 (
l£
 & 
OPA_LINK_SPEED_12_5G
))

879 
ÿbË_©‹n
 = 
ÿche
[
QSFP_CU_ATTEN_7G_OFFS
];

882 ià(
ÿbË_©‹n
 == 0 || cable_atten > 36) {

883 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

884 
µd
->
dd
,

885 
PLATFORM_CONFIG_SYSTEM_TABLE
, 0,

886 
SYSTEM_TABLE_QSFP_ATTENUATION_DEFAULT_25G
,

887 &
ÿbË_©‹n
, 4);

888 ià(
»t
)

889  
»t
;

892 
»t
 = 
	`g‘_¶©fÜm_cÚfig_f›ld
(

893 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

894 
PORT_TABLE_REMOTE_ATTEN_25G
, &
»mÙe_©‹n
, 4);

895 ià(
»t
)

896  
»t
;

898 *
±r_tÙ®_©‹n
 = 
¶©fÜm_©‹n
 + 
ÿbË_©‹n
 + 
»mÙe_©‹n
;

900 *
±r_tunšg_m‘hod
 = 
OPA_PASSIVE_TUNING
;

905 
»t
 = 
	`tuÃ_aùive_qså
(
µd
, 
±r_tx_´e£t
, 
±r_rx_´e£t
,

906 
±r_tÙ®_©‹n
);

907 ià(
»t
)

908  
»t
;

910 *
±r_tunšg_m‘hod
 = 
OPA_ACTIVE_TUNING
;

915 
	`dd_dev_w¬n
(
µd
->
dd
, "%s: Unknown/unsupported cable\n",

916 
__func__
);

919  
»t
;

920 
	}
}

928 
	$tuÃ_£rdes
(
hfi1_µÜtd©a
 *
µd
)

930 
»t
 = 0;

931 
u32
 
tÙ®_©‹n
 = 0;

932 
u32
 
»mÙe_©‹n
 = 0, 
¶©fÜm_©‹n
 = 0;

933 
u32
 
rx_´e£t_šdex
, 
tx_´e£t_šdex
;

934 
u8
 
tunšg_m‘hod
 = 0, 
lim™šg_aùive
 = 0;

935 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

937 
rx_´e£t_šdex
 = 
OPA_INVALID_INDEX
;

938 
tx_´e£t_šdex
 = 
OPA_INVALID_INDEX
;

941 
µd
->
lšk_’abËd
 = 1;

943 
µd
->
driv”_lšk_»ady
 = 0;

944 
µd
->
ofæše_di§bËd_»asÚ
 = 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
);

947 ià(
loÝback
 !ð
LOOPBACK_NONE
 ||

948 
µd
->
dd
->
icode
 =ð
ICODE_FUNCTIONAL_SIMULATOR
) {

949 
µd
->
driv”_lšk_»ady
 = 1;

951 ià(
	`qså_mod_´e£Á
(
µd
)) {

952 
»t
 = 
	`acquœe_ch_»sourû
(
µd
->
dd
,

953 
	`qså_»sourû
(
µd
->
dd
),

954 
QSFP_WAIT
);

955 ià(
»t
) {

956 
	`dd_dev_”r
(
µd
->
dd
, "%s: hfi%d: cannot†ock i2c chain\n",

957 
__func__
, ()
µd
->
dd
->
hfi1_id
);

958 
baž
;

961 
	`»äesh_qså_ÿche
(
µd
, &µd->
qså_šfo
);

962 
	`»Ëa£_ch_»sourû
(
µd
->
dd
, 
	`qså_»sourû
(ppd->dd));

968 
µd
->
pÜt_ty³
) {

969 
PORT_TYPE_DISCONNECTED
:

970 
µd
->
ofæše_di§bËd_»asÚ
 =

971 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_DISCONNECTED
);

972 
	`dd_dev_w¬n
(
dd
, "%s: Port disconnected, disabling…ort\n",

973 
__func__
);

974 
baž
;

975 
PORT_TYPE_FIXED
:

977 
	`g‘_¶©fÜm_cÚfig_f›ld
(

978 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

979 
PORT_TABLE_LOCAL_ATTEN_25G
, &
¶©fÜm_©‹n
, 4);

981 
	`g‘_¶©fÜm_cÚfig_f›ld
(

982 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

983 
PORT_TABLE_REMOTE_ATTEN_25G
, &
»mÙe_©‹n
, 4);

985 
tÙ®_©‹n
 = 
¶©fÜm_©‹n
 + 
»mÙe_©‹n
;

987 
tunšg_m‘hod
 = 
OPA_PASSIVE_TUNING
;

989 
PORT_TYPE_VARIABLE
:

990 ià(
	`qså_mod_´e£Á
(
µd
)) {

995 
	`g‘_¶©fÜm_cÚfig_f›ld
(

996 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

997 
PORT_TABLE_LOCAL_ATTEN_25G
,

998 &
¶©fÜm_©‹n
, 4);

1000 
	`g‘_¶©fÜm_cÚfig_f›ld
(

1001 
µd
->
dd
, 
PLATFORM_CONFIG_PORT_TABLE
, 0,

1002 
PORT_TABLE_REMOTE_ATTEN_25G
,

1003 &
»mÙe_©‹n
, 4);

1005 
tÙ®_©‹n
 = 
¶©fÜm_©‹n
 + 
»mÙe_©‹n
;

1007 
tunšg_m‘hod
 = 
OPA_PASSIVE_TUNING
;

1009 
µd
->
ofæše_di§bËd_»asÚ
 =

1010 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_CHASSIS_CONFIG
);

1011 
baž
;

1014 
PORT_TYPE_QSFP
:

1015 ià(
	`qså_mod_´e£Á
(
µd
)) {

1016 
»t
 = 
	`acquœe_ch_»sourû
(
µd
->
dd
,

1017 
	`qså_»sourû
(
µd
->
dd
),

1018 
QSFP_WAIT
);

1019 ià(
»t
) {

1020 
	`dd_dev_”r
(
µd
->
dd
, "%s: hfi%d: cannot†ock i2c chain\n",

1021 
__func__
, ()
µd
->
dd
->
hfi1_id
);

1022 
baž
;

1024 
	`»äesh_qså_ÿche
(
µd
, &µd->
qså_šfo
);

1026 ià(
µd
->
qså_šfo
.
ÿche_v®id
) {

1027 
»t
 = 
	`tuÃ_qså
(
µd
,

1028 &
tx_´e£t_šdex
,

1029 &
rx_´e£t_šdex
,

1030 &
tunšg_m‘hod
,

1031 &
tÙ®_©‹n
);

1037 
	`»äesh_qså_ÿche
(
µd
, &µd->
qså_šfo
);

1038 
lim™šg_aùive
 =

1039 
µd
->
qså_šfo
.
lim™šg_aùive
;

1041 
	`dd_dev_”r
(
dd
,

1043 
__func__
);

1044 
»t
 = -
EINVAL
;

1046 
	`»Ëa£_ch_»sourû
(
µd
->
dd
, 
	`qså_»sourû
(ppd->dd));

1047 ià(
»t
)

1048 
baž
;

1050 
µd
->
ofæše_di§bËd_»asÚ
 =

1051 
	`HFI1_ODR_MASK
(

1052 
OPA_LINKDOWN_REASON_LOCAL_MEDIA_NOT_INSTALLED
);

1053 
baž
;

1057 
	`dd_dev_w¬n
(
µd
->
dd
, "%s: UnknowÀpÜˆty³\n", 
__func__
);

1058 
µd
->
pÜt_ty³
 = 
PORT_TYPE_UNKNOWN
;

1059 
tunšg_m‘hod
 = 
OPA_UNKNOWN_TUNING
;

1060 
tÙ®_©‹n
 = 0;

1061 
lim™šg_aùive
 = 0;

1062 
tx_´e£t_šdex
 = 
OPA_INVALID_INDEX
;

1066 ià(
µd
->
ofæše_di§bËd_»asÚ
 ==

1067 
	`HFI1_ODR_MASK
(
OPA_LINKDOWN_REASON_NONE
))

1068 
	`­¶y_tunšgs
(
µd
, 
tx_´e£t_šdex
, 
tunšg_m‘hod
,

1069 
tÙ®_©‹n
, 
lim™šg_aùive
);

1071 ià(!
»t
)

1072 
µd
->
driv”_lšk_»ady
 = 1;

1075 
baž
:

1076 
µd
->
driv”_lšk_»ady
 = 0;

1077 
	}
}

	@platform.h

47 #iâdeà
__PLATFORM_H


48 
	#__PLATFORM_H


	)

50 
	#METADATA_TABLE_FIELD_START_SHIFT
 0

	)

51 
	#METADATA_TABLE_FIELD_START_LEN_BITS
 15

	)

52 
	#METADATA_TABLE_FIELD_LEN_SHIFT
 16

	)

53 
	#METADATA_TABLE_FIELD_LEN_LEN_BITS
 16

	)

56 
	#PLATFORM_CONFIG_HEADER_RECORD_IDX_SHIFT
 0

	)

57 
	#PLATFORM_CONFIG_HEADER_RECORD_IDX_LEN_BITS
 6

	)

58 
	#PLATFORM_CONFIG_HEADER_TABLE_LENGTH_SHIFT
 16

	)

59 
	#PLATFORM_CONFIG_HEADER_TABLE_LENGTH_LEN_BITS
 12

	)

60 
	#PLATFORM_CONFIG_HEADER_TABLE_TYPE_SHIFT
 28

	)

61 
	#PLATFORM_CONFIG_HEADER_TABLE_TYPE_LEN_BITS
 4

	)

63 
	e¶©fÜm_cÚfig_bË_ty³_’codšg
 {

64 
	mPLATFORM_CONFIG_TABLE_RESERVED
,

65 
	mPLATFORM_CONFIG_SYSTEM_TABLE
,

66 
	mPLATFORM_CONFIG_PORT_TABLE
,

67 
	mPLATFORM_CONFIG_RX_PRESET_TABLE
,

68 
	mPLATFORM_CONFIG_TX_PRESET_TABLE
,

69 
	mPLATFORM_CONFIG_QSFP_ATTEN_TABLE
,

70 
	mPLATFORM_CONFIG_VARIABLE_SETTINGS_TABLE
,

71 
	mPLATFORM_CONFIG_TABLE_MAX


74 
	e¶©fÜm_cÚfig_sy¡em_bË_f›lds
 {

75 
	mSYSTEM_TABLE_RESERVED
,

76 
	mSYSTEM_TABLE_NODE_STRING
,

77 
	mSYSTEM_TABLE_SYSTEM_IMAGE_GUID
,

78 
	mSYSTEM_TABLE_NODE_GUID
,

79 
	mSYSTEM_TABLE_REVISION
,

80 
	mSYSTEM_TABLE_VENDOR_OUI
,

81 
	mSYSTEM_TABLE_META_VERSION
,

82 
	mSYSTEM_TABLE_DEVICE_ID
,

83 
	mSYSTEM_TABLE_PARTITION_ENFORCEMENT_CAP
,

84 
	mSYSTEM_TABLE_QSFP_POWER_CLASS_MAX
,

85 
	mSYSTEM_TABLE_QSFP_ATTENUATION_DEFAULT_12G
,

86 
	mSYSTEM_TABLE_QSFP_ATTENUATION_DEFAULT_25G
,

87 
	mSYSTEM_TABLE_VARIABLE_TABLE_ENTRIES_PER_PORT
,

88 
	mSYSTEM_TABLE_MAX


91 
	e¶©fÜm_cÚfig_pÜt_bË_f›lds
 {

92 
	mPORT_TABLE_RESERVED
,

93 
	mPORT_TABLE_PORT_TYPE
,

94 
	mPORT_TABLE_LOCAL_ATTEN_12G
,

95 
	mPORT_TABLE_LOCAL_ATTEN_25G
,

96 
	mPORT_TABLE_LINK_SPEED_SUPPORTED
,

97 
	mPORT_TABLE_LINK_WIDTH_SUPPORTED
,

98 
	mPORT_TABLE_AUTO_LANE_SHEDDING_ENABLED
,

99 
	mPORT_TABLE_EXTERNAL_LOOPBACK_ALLOWED
,

100 
	mPORT_TABLE_VL_CAP
,

101 
	mPORT_TABLE_MTU_CAP
,

102 
	mPORT_TABLE_TX_LANE_ENABLE_MASK
,

103 
	mPORT_TABLE_LOCAL_MAX_TIMEOUT
,

104 
	mPORT_TABLE_REMOTE_ATTEN_12G
,

105 
	mPORT_TABLE_REMOTE_ATTEN_25G
,

106 
	mPORT_TABLE_TX_PRESET_IDX_ACTIVE_NO_EQ
,

107 
	mPORT_TABLE_TX_PRESET_IDX_ACTIVE_EQ
,

108 
	mPORT_TABLE_RX_PRESET_IDX
,

109 
	mPORT_TABLE_CABLE_REACH_CLASS
,

110 
	mPORT_TABLE_MAX


113 
	e¶©fÜm_cÚfig_rx_´e£t_bË_f›lds
 {

114 
	mRX_PRESET_TABLE_RESERVED
,

115 
	mRX_PRESET_TABLE_QSFP_RX_CDR_APPLY
,

116 
	mRX_PRESET_TABLE_QSFP_RX_EMP_APPLY
,

117 
	mRX_PRESET_TABLE_QSFP_RX_AMP_APPLY
,

118 
	mRX_PRESET_TABLE_QSFP_RX_CDR
,

119 
	mRX_PRESET_TABLE_QSFP_RX_EMP
,

120 
	mRX_PRESET_TABLE_QSFP_RX_AMP
,

121 
	mRX_PRESET_TABLE_MAX


124 
	e¶©fÜm_cÚfig_tx_´e£t_bË_f›lds
 {

125 
	mTX_PRESET_TABLE_RESERVED
,

126 
	mTX_PRESET_TABLE_PRECUR
,

127 
	mTX_PRESET_TABLE_ATTN
,

128 
	mTX_PRESET_TABLE_POSTCUR
,

129 
	mTX_PRESET_TABLE_QSFP_TX_CDR_APPLY
,

130 
	mTX_PRESET_TABLE_QSFP_TX_EQ_APPLY
,

131 
	mTX_PRESET_TABLE_QSFP_TX_CDR
,

132 
	mTX_PRESET_TABLE_QSFP_TX_EQ
,

133 
	mTX_PRESET_TABLE_MAX


136 
	e¶©fÜm_cÚfig_qså_©Š_bË_f›lds
 {

137 
	mQSFP_ATTEN_TABLE_RESERVED
,

138 
	mQSFP_ATTEN_TABLE_TX_PRESET_IDX
,

139 
	mQSFP_ATTEN_TABLE_RX_PRESET_IDX
,

140 
	mQSFP_ATTEN_TABLE_MAX


143 
	e¶©fÜm_cÚfig_v¬ŸbË_£‰šgs_bË_f›lds
 {

144 
	mVARIABLE_SETTINGS_TABLE_RESERVED
,

145 
	mVARIABLE_SETTINGS_TABLE_TX_PRESET_IDX
,

146 
	mVARIABLE_SETTINGS_TABLE_RX_PRESET_IDX
,

147 
	mVARIABLE_SETTINGS_TABLE_MAX


150 
	s¶©fÜm_cÚfig
 {

151 
size_t
 
	msize
;

152 cÚ¡ 
u8
 *
	md©a
;

155 
	s¶©fÜm_cÚfig_d©a
 {

156 
u32
 *
	mbË
;

157 
u32
 *
	mbË_m‘ad©a
;

158 
u32
 
	mnum_bË
;

166 
	s¶©fÜm_cÚfig_ÿche
 {

167 
u8
 
	mÿche_v®id
;

168 
¶©fÜm_cÚfig_d©a
 
	mcÚfig_bËs
[
PLATFORM_CONFIG_TABLE_MAX
];

180 
	#PLATFORM_CONFIG_MAGIC_NUM
 0x3d4f5041

	)

181 
	#PLATFORM_CONFIG_MAGIC_NUMBER_LEN
 4

	)

187 
	e¶©fÜm_cÚfig_qså_pow”_þass_’codšg
 {

188 
	mQSFP_POWER_CLASS_1
 = 1,

189 
	mQSFP_POWER_CLASS_2
,

190 
	mQSFP_POWER_CLASS_3
,

191 
	mQSFP_POWER_CLASS_4
,

192 
	mQSFP_POWER_CLASS_5
,

193 
	mQSFP_POWER_CLASS_6
,

194 
	mQSFP_POWER_CLASS_7


202 
	e¶©fÜm_cÚfig_pÜt_ty³_’codšg
 {

203 
	mPORT_TYPE_UNKNOWN
,

204 
	mPORT_TYPE_DISCONNECTED
,

205 
	mPORT_TYPE_FIXED
,

206 
	mPORT_TYPE_VARIABLE
,

207 
	mPORT_TYPE_QSFP
,

208 
	mPORT_TYPE_MAX


211 
	e¶©fÜm_cÚfig_lšk_¥“d_suµÜ‹d_’codšg
 {

212 
	mLINK_SPEED_SUPP_12G
 = 1,

213 
	mLINK_SPEED_SUPP_25G
,

214 
	mLINK_SPEED_SUPP_12G_25G
,

215 
	mLINK_SPEED_SUPP_MAX


224 
	e¶©fÜm_cÚfig_lšk_width_suµÜ‹d_’codšg
 {

225 
	mLINK_WIDTH_SUPP_1X
 = 1,

226 
	mLINK_WIDTH_SUPP_2X
,

227 
	mLINK_WIDTH_SUPP_2X_1X
,

228 
	mLINK_WIDTH_SUPP_3X
,

229 
	mLINK_WIDTH_SUPP_3X_1X
,

230 
	mLINK_WIDTH_SUPP_3X_2X
,

231 
	mLINK_WIDTH_SUPP_3X_2X_1X
,

232 
	mLINK_WIDTH_SUPP_4X
,

233 
	mLINK_WIDTH_SUPP_4X_1X
,

234 
	mLINK_WIDTH_SUPP_4X_2X
,

235 
	mLINK_WIDTH_SUPP_4X_2X_1X
,

236 
	mLINK_WIDTH_SUPP_4X_3X
,

237 
	mLINK_WIDTH_SUPP_4X_3X_1X
,

238 
	mLINK_WIDTH_SUPP_4X_3X_2X
,

239 
	mLINK_WIDTH_SUPP_4X_3X_2X_1X
,

240 
	mLINK_WIDTH_SUPP_MAX


243 
	e¶©fÜm_cÚfig_vœtu®_ÏÃ_ÿ·bž™y_’codšg
 {

244 
	mVL_CAP_VL0
 = 1,

245 
	mVL_CAP_VL0_1
,

246 
	mVL_CAP_VL0_2
,

247 
	mVL_CAP_VL0_3
,

248 
	mVL_CAP_VL0_4
,

249 
	mVL_CAP_VL0_5
,

250 
	mVL_CAP_VL0_6
,

251 
	mVL_CAP_VL0_7
,

252 
	mVL_CAP_VL0_8
,

253 
	mVL_CAP_VL0_9
,

254 
	mVL_CAP_VL0_10
,

255 
	mVL_CAP_VL0_11
,

256 
	mVL_CAP_VL0_12
,

257 
	mVL_CAP_VL0_13
,

258 
	mVL_CAP_VL0_14
,

259 
	mVL_CAP_MAX


263 
	e¶©fÜm_cÚfig_mtu_ÿ·bž™y_’codšg
 {

264 
	mMTU_CAP_256
 = 1,

265 
	mMTU_CAP_512
 = 2,

266 
	mMTU_CAP_1024
 = 3,

267 
	mMTU_CAP_2048
 = 4,

268 
	mMTU_CAP_4096
 = 5,

269 
	mMTU_CAP_8192
 = 6,

270 
	mMTU_CAP_10240
 = 7

273 
	e¶©fÜm_cÚfig_loÿl_max_timeout_’codšg
 {

274 
	mLOCAL_MAX_TIMEOUT_10_MS
 = 1,

275 
	mLOCAL_MAX_TIMEOUT_100_MS
,

276 
	mLOCAL_MAX_TIMEOUT_1_S
,

277 
	mLOCAL_MAX_TIMEOUT_10_S
,

278 
	mLOCAL_MAX_TIMEOUT_100_S
,

279 
	mLOCAL_MAX_TIMEOUT_1000_S


282 
	elšk_tunšg_’codšg
 {

283 
	mOPA_PASSIVE_TUNING
,

284 
	mOPA_ACTIVE_TUNING
,

285 
	mOPA_UNKNOWN_TUNING


292 
	#PORT0_PORT_TYPE_SHIFT
 0

	)

293 
	#PORT0_LOCAL_ATTEN_SHIFT
 4

	)

294 
	#PORT0_REMOTE_ATTEN_SHIFT
 10

	)

295 
	#PORT0_DEFAULT_ATTEN_SHIFT
 32

	)

297 
	#PORT1_PORT_TYPE_SHIFT
 16

	)

298 
	#PORT1_LOCAL_ATTEN_SHIFT
 20

	)

299 
	#PORT1_REMOTE_ATTEN_SHIFT
 26

	)

300 
	#PORT1_DEFAULT_ATTEN_SHIFT
 40

	)

302 
	#PORT0_PORT_TYPE_MASK
 0xFUL

	)

303 
	#PORT0_LOCAL_ATTEN_MASK
 0x3FUL

	)

304 
	#PORT0_REMOTE_ATTEN_MASK
 0x3FUL

	)

305 
	#PORT0_DEFAULT_ATTEN_MASK
 0xFFUL

	)

307 
	#PORT1_PORT_TYPE_MASK
 0xFUL

	)

308 
	#PORT1_LOCAL_ATTEN_MASK
 0x3FUL

	)

309 
	#PORT1_REMOTE_ATTEN_MASK
 0x3FUL

	)

310 
	#PORT1_DEFAULT_ATTEN_MASK
 0xFFUL

	)

312 
	#PORT0_PORT_TYPE_SMASK
 (
PORT0_PORT_TYPE_MASK
 << \

313 
PORT0_PORT_TYPE_SHIFT
)

	)

314 
	#PORT0_LOCAL_ATTEN_SMASK
 (
PORT0_LOCAL_ATTEN_MASK
 << \

315 
PORT0_LOCAL_ATTEN_SHIFT
)

	)

316 
	#PORT0_REMOTE_ATTEN_SMASK
 (
PORT0_REMOTE_ATTEN_MASK
 << \

317 
PORT0_REMOTE_ATTEN_SHIFT
)

	)

318 
	#PORT0_DEFAULT_ATTEN_SMASK
 (
PORT0_DEFAULT_ATTEN_MASK
 << \

319 
PORT0_DEFAULT_ATTEN_SHIFT
)

	)

321 
	#PORT1_PORT_TYPE_SMASK
 (
PORT1_PORT_TYPE_MASK
 << \

322 
PORT1_PORT_TYPE_SHIFT
)

	)

323 
	#PORT1_LOCAL_ATTEN_SMASK
 (
PORT1_LOCAL_ATTEN_MASK
 << \

324 
PORT1_LOCAL_ATTEN_SHIFT
)

	)

325 
	#PORT1_REMOTE_ATTEN_SMASK
 (
PORT1_REMOTE_ATTEN_MASK
 << \

326 
PORT1_REMOTE_ATTEN_SHIFT
)

	)

327 
	#PORT1_DEFAULT_ATTEN_SMASK
 (
PORT1_DEFAULT_ATTEN_MASK
 << \

328 
PORT1_DEFAULT_ATTEN_SHIFT
)

	)

330 
	#QSFP_MAX_POWER_SHIFT
 0

	)

331 
	#TX_NO_EQ_SHIFT
 4

	)

332 
	#TX_EQ_SHIFT
 25

	)

333 
	#RX_SHIFT
 46

	)

335 
	#QSFP_MAX_POWER_MASK
 0xFUL

	)

336 
	#TX_NO_EQ_MASK
 0x1FFFFFUL

	)

337 
	#TX_EQ_MASK
 0x1FFFFFUL

	)

338 
	#RX_MASK
 0xFFFFUL

	)

340 
	#QSFP_MAX_POWER_SMASK
 (
QSFP_MAX_POWER_MASK
 << \

341 
QSFP_MAX_POWER_SHIFT
)

	)

342 
	#TX_NO_EQ_SMASK
 (
TX_NO_EQ_MASK
 << 
TX_NO_EQ_SHIFT
)

	)

343 
	#TX_EQ_SMASK
 (
TX_EQ_MASK
 << 
TX_EQ_SHIFT
)

	)

344 
	#RX_SMASK
 (
RX_MASK
 << 
RX_SHIFT
)

	)

346 
	#TX_PRECUR_SHIFT
 0

	)

347 
	#TX_ATTN_SHIFT
 4

	)

348 
	#QSFP_TX_CDR_APPLY_SHIFT
 9

	)

349 
	#QSFP_TX_EQ_APPLY_SHIFT
 10

	)

350 
	#QSFP_TX_CDR_SHIFT
 11

	)

351 
	#QSFP_TX_EQ_SHIFT
 12

	)

352 
	#TX_POSTCUR_SHIFT
 16

	)

354 
	#TX_PRECUR_MASK
 0xFUL

	)

355 
	#TX_ATTN_MASK
 0x1FUL

	)

356 
	#QSFP_TX_CDR_APPLY_MASK
 0x1UL

	)

357 
	#QSFP_TX_EQ_APPLY_MASK
 0x1UL

	)

358 
	#QSFP_TX_CDR_MASK
 0x1UL

	)

359 
	#QSFP_TX_EQ_MASK
 0xFUL

	)

360 
	#TX_POSTCUR_MASK
 0x1FUL

	)

362 
	#TX_PRECUR_SMASK
 (
TX_PRECUR_MASK
 << 
TX_PRECUR_SHIFT
)

	)

363 
	#TX_ATTN_SMASK
 (
TX_ATTN_MASK
 << 
TX_ATTN_SHIFT
)

	)

364 
	#QSFP_TX_CDR_APPLY_SMASK
 (
QSFP_TX_CDR_APPLY_MASK
 << \

365 
QSFP_TX_CDR_APPLY_SHIFT
)

	)

366 
	#QSFP_TX_EQ_APPLY_SMASK
 (
QSFP_TX_EQ_APPLY_MASK
 << \

367 
QSFP_TX_EQ_APPLY_SHIFT
)

	)

368 
	#QSFP_TX_CDR_SMASK
 (
QSFP_TX_CDR_MASK
 << 
QSFP_TX_CDR_SHIFT
)

	)

369 
	#QSFP_TX_EQ_SMASK
 (
QSFP_TX_EQ_MASK
 << 
QSFP_TX_EQ_SHIFT
)

	)

370 
	#TX_POSTCUR_SMASK
 (
TX_POSTCUR_MASK
 << 
TX_POSTCUR_SHIFT
)

	)

372 
	#QSFP_RX_CDR_APPLY_SHIFT
 0

	)

373 
	#QSFP_RX_EMP_APPLY_SHIFT
 1

	)

374 
	#QSFP_RX_AMP_APPLY_SHIFT
 2

	)

375 
	#QSFP_RX_CDR_SHIFT
 3

	)

376 
	#QSFP_RX_EMP_SHIFT
 4

	)

377 
	#QSFP_RX_AMP_SHIFT
 8

	)

379 
	#QSFP_RX_CDR_APPLY_MASK
 0x1UL

	)

380 
	#QSFP_RX_EMP_APPLY_MASK
 0x1UL

	)

381 
	#QSFP_RX_AMP_APPLY_MASK
 0x1UL

	)

382 
	#QSFP_RX_CDR_MASK
 0x1UL

	)

383 
	#QSFP_RX_EMP_MASK
 0xFUL

	)

384 
	#QSFP_RX_AMP_MASK
 0x3UL

	)

386 
	#QSFP_RX_CDR_APPLY_SMASK
 (
QSFP_RX_CDR_APPLY_MASK
 << \

387 
QSFP_RX_CDR_APPLY_SHIFT
)

	)

388 
	#QSFP_RX_EMP_APPLY_SMASK
 (
QSFP_RX_EMP_APPLY_MASK
 << \

389 
QSFP_RX_EMP_APPLY_SHIFT
)

	)

390 
	#QSFP_RX_AMP_APPLY_SMASK
 (
QSFP_RX_AMP_APPLY_MASK
 << \

391 
QSFP_RX_AMP_APPLY_SHIFT
)

	)

392 
	#QSFP_RX_CDR_SMASK
 (
QSFP_RX_CDR_MASK
 << 
QSFP_RX_CDR_SHIFT
)

	)

393 
	#QSFP_RX_EMP_SMASK
 (
QSFP_RX_EMP_MASK
 << 
QSFP_RX_EMP_SHIFT
)

	)

394 
	#QSFP_RX_AMP_SMASK
 (
QSFP_RX_AMP_MASK
 << 
QSFP_RX_AMP_SHIFT
)

	)

396 
	#BITMAP_VERSION
 1

	)

397 
	#BITMAP_VERSION_SHIFT
 44

	)

398 
	#BITMAP_VERSION_MASK
 0xFUL

	)

399 
	#BITMAP_VERSION_SMASK
 (
BITMAP_VERSION_MASK
 << \

400 
BITMAP_VERSION_SHIFT
)

	)

401 
	#CHECKSUM_SHIFT
 48

	)

402 
	#CHECKSUM_MASK
 0xFFFFUL

	)

403 
	#CHECKSUM_SMASK
 (
CHECKSUM_MASK
 << 
CHECKSUM_SHIFT
)

	)

406 
g‘_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
);

407 
ä“_¶©fÜm_cÚfig
(
hfi1_devd©a
 *
dd
);

408 
g‘_pÜt_ty³
(
hfi1_µÜtd©a
 *
µd
);

409 
£t_qså_tx
(
hfi1_µÜtd©a
 *
µd
, 
Ú
);

410 
tuÃ_£rdes
(
hfi1_µÜtd©a
 *
µd
);

	@qp.c

48 
	~<lšux/”r.h
>

49 
	~<lšux/vm®loc.h
>

50 
	~<lšux/hash.h
>

51 
	~<lšux/moduË.h
>

52 
	~<lšux/£q_fže.h
>

53 
	~<rdma/rdma_vt.h
>

54 
	~<rdma/rdmavt_qp.h
>

55 
	~<rdma/ib_v”bs.h
>

57 
	~"hfi.h
"

58 
	~"qp.h
"

59 
	~"Œaû.h
"

60 
	~"v”bs_tx»q.h
"

61 
	~"u£r_exp_rcv.h
"

62 
	~"tid_rdma.h
"

64 
	ghfi1_qp_bË_size
 = 256;

65 
moduË_·¿m_Çmed
(
qp_bË_size
, 
hfi1_qp_bË_size
, 
ušt
, 
S_IRUGO
);

66 
MODULE_PARM_DESC
(
qp_bË_size
, "QPable size");

68 
æush_tx_li¡
(
rvt_qp
 *
qp
);

69 
iowa™_¦“p
(

70 
sdma_’gše
 *
sde
,

71 
iowa™_wÜk
 *
wa™
,

72 
sdma_tx»q
 *
¡x
,

73 
£q
,

74 
boÞ
 
pkts_£Á
);

75 
iowa™_wakeup
(
iowa™
 *
wa™
, 
»asÚ
);

76 
iowa™_sdma_d¿šed
(
iowa™
 *
wa™
);

77 
qp_pio_d¿š
(
rvt_qp
 *
qp
);

79 cÚ¡ 
rvt_Ý”©iÚ_·¿ms
 
	ghfi1_po¡_·rms
[
RVT_OPERATION_MAX
] = {

80 [
IB_WR_RDMA_WRITE
] = {

81 .
Ëngth
 = (
ib_rdma_wr
),

82 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

85 [
IB_WR_RDMA_READ
] = {

86 .
Ëngth
 = (
ib_rdma_wr
),

87 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

88 .
	gæags
 = 
RVT_OPERATION_ATOMIC
,

91 [
IB_WR_ATOMIC_CMP_AND_SWP
] = {

92 .
Ëngth
 = (
ib_©omic_wr
),

93 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

94 .
	gæags
 = 
RVT_OPERATION_ATOMIC
 | 
RVT_OPERATION_ATOMIC_SGE
,

97 [
IB_WR_ATOMIC_FETCH_AND_ADD
] = {

98 .
Ëngth
 = (
ib_©omic_wr
),

99 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

100 .
	gæags
 = 
RVT_OPERATION_ATOMIC
 | 
RVT_OPERATION_ATOMIC_SGE
,

103 [
IB_WR_RDMA_WRITE_WITH_IMM
] = {

104 .
Ëngth
 = (
ib_rdma_wr
),

105 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

108 [
IB_WR_SEND
] = {

109 .
Ëngth
 = (
ib_£nd_wr
),

110 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UD
è| BIT(
IB_QPT_SMI
è| BIT(
IB_QPT_GSI
) |

111 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

114 [
IB_WR_SEND_WITH_IMM
] = {

115 .
Ëngth
 = (
ib_£nd_wr
),

116 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UD
è| BIT(
IB_QPT_SMI
è| BIT(
IB_QPT_GSI
) |

117 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

120 [
IB_WR_REG_MR
] = {

121 .
Ëngth
 = (
ib_»g_wr
),

122 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

123 .
	gæags
 = 
RVT_OPERATION_LOCAL
,

126 [
IB_WR_LOCAL_INV
] = {

127 .
Ëngth
 = (
ib_£nd_wr
),

128 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_UC
è| BIT(
IB_QPT_RC
),

129 .
	gæags
 = 
RVT_OPERATION_LOCAL
,

132 [
IB_WR_SEND_WITH_INV
] = {

133 .
Ëngth
 = (
ib_£nd_wr
),

134 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

137 [
IB_WR_OPFN
] = {

138 .
Ëngth
 = (
ib_©omic_wr
),

139 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

140 .
	gæags
 = 
RVT_OPERATION_USE_RESERVE
,

143 [
IB_WR_TID_RDMA_WRITE
] = {

144 .
Ëngth
 = (
ib_rdma_wr
),

145 .
	gq±_suµÜt
 = 
BIT
(
IB_QPT_RC
),

146 .
	gæags
 = 
RVT_OPERATION_IGN_RNR_CNT
,

151 
	$æush_li¡_h—d
(
li¡_h—d
 *
l
)

153 !
	`li¡_em±y
(
l
)) {

154 
sdma_tx»q
 *
tx
;

156 
tx
 = 
	`li¡_fœ¡_’Œy
(

157 
l
,

158 
sdma_tx»q
,

159 
li¡
);

160 
	`li¡_d–_š™
(&
tx
->
li¡
);

161 
	`hfi1_put_tx»q
(

162 
	`cÚš”_of
(
tx
, 
v”bs_tx»q
, 
tx»q
));

164 
	}
}

166 
	$æush_tx_li¡
(
rvt_qp
 *
qp
)

168 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

170 
	`æush_li¡_h—d
(&
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
)->
tx_h—d
);

171 
	`æush_li¡_h—d
(&
	`iowa™_g‘_tid_wÜk
(&
´iv
->
s_iowa™
)->
tx_h—d
);

172 
	}
}

174 
	$æush_iowa™
(
rvt_qp
 *
qp
)

176 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

177 
æags
;

178 
£qlock_t
 *
lock
 = 
´iv
->
s_iowa™
.lock;

180 ià(!
lock
)

182 
	`wr™e_£qlock_œq§ve
(
lock
, 
æags
);

183 ià(!
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
)) {

184 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

185 
´iv
->
s_iowa™
.
lock
 = 
NULL
;

186 
	`rvt_put_qp
(
qp
);

188 
	`wr™e_£quÆock_œq»¡Üe
(
lock
, 
æags
);

189 
	}
}

196 
šlše
 
	$v”bs_mtu_’um_to_št
(
ib_deviû
 *
dev
, 
ib_mtu
 
mtu
)

199 ià(
mtu
 =ð(
ib_mtu
)
OPA_MTU_10240
)

200 
mtu
 = 
OPA_MTU_8192
;

201  
	`Ýa_mtu_’um_to_št
(
mtu
);

202 
	}
}

204 
	$hfi1_check_modify_qp
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
,

205 
©Œ_mask
, 
ib_ud©a
 *
ud©a
)

207 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

208 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
ibqp
->
deviû
);

209 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

210 
u8
 
sc
;

212 ià(
©Œ_mask
 & 
IB_QP_AV
) {

213 
sc
 = 
	`ah_to_sc
(
ibqp
->
deviû
, &
©Œ
->
ah_©Œ
);

214 ià(
sc
 == 0xf)

215  -
EINVAL
;

217 ià(!
	`qp_to_sdma_’gše
(
qp
, 
sc
) &&

218 
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
)

219  -
EINVAL
;

221 ià(!
	`qp_to_£nd_cÚ‹xt
(
qp
, 
sc
))

222  -
EINVAL
;

225 ià(
©Œ_mask
 & 
IB_QP_ALT_PATH
) {

226 
sc
 = 
	`ah_to_sc
(
ibqp
->
deviû
, &
©Œ
->
®t_ah_©Œ
);

227 ià(
sc
 == 0xf)

228  -
EINVAL
;

230 ià(!
	`qp_to_sdma_’gše
(
qp
, 
sc
) &&

231 
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
)

232  -
EINVAL
;

234 ià(!
	`qp_to_£nd_cÚ‹xt
(
qp
, 
sc
))

235  -
EINVAL
;

239 
	}
}

246 
šlše
 
	$qp_£t_16b
(
rvt_qp
 *
qp
)

248 
hfi1_µÜtd©a
 *
µd
;

249 
hfi1_ibpÜt
 *
ibp
;

250 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

253 
	`hfi1_upd©e_ah_©Œ
(
qp
->
ibqp
.
deviû
, &qp->
»mÙe_ah_©Œ
);

256 
	`hfi1_make_Ýa_lid
(&
qp
->
»mÙe_ah_©Œ
);

258 ià(!(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
))

261 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

262 
µd
 = 
	`µd_äom_ibp
(
ibp
);

263 
´iv
->
hdr_ty³
 = 
	`hfi1_g‘_hdr_ty³
(
µd
->
lid
, &
qp
->
»mÙe_ah_©Œ
);

264 
	}
}

266 
	$hfi1_modify_qp
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
,

267 
©Œ_mask
, 
ib_ud©a
 *
ud©a
)

269 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

270 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

272 ià(
©Œ_mask
 & 
IB_QP_AV
) {

273 
´iv
->
s_sc
 = 
	`ah_to_sc
(
ibqp
->
deviû
, &
qp
->
»mÙe_ah_©Œ
);

274 
´iv
->
s_sde
 = 
	`qp_to_sdma_’gše
(
qp
,…riv->
s_sc
);

275 
´iv
->
s_£ndcÚ‹xt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
,…riv->
s_sc
);

276 
	`qp_£t_16b
(
qp
);

279 ià(
©Œ_mask
 & 
IB_QP_PATH_MIG_STATE
 &&

280 
©Œ
->
·th_mig_¡©e
 =ð
IB_MIG_MIGRATED
 &&

281 
qp
->
s_mig_¡©e
 =ð
IB_MIG_ARMED
) {

282 
qp
->
s_æags
 |ð
HFI1_S_AHG_CLEAR
;

283 
´iv
->
s_sc
 = 
	`ah_to_sc
(
ibqp
->
deviû
, &
qp
->
»mÙe_ah_©Œ
);

284 
´iv
->
s_sde
 = 
	`qp_to_sdma_’gše
(
qp
,…riv->
s_sc
);

285 
´iv
->
s_£ndcÚ‹xt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
,…riv->
s_sc
);

286 
	`qp_£t_16b
(
qp
);

289 
	`Ýâ_š™
(
qp
, 
©Œ
, 
©Œ_mask
);

290 
	}
}

307 
	$hfi1_£tup_wqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
, 
boÞ
 *
ÿÎ_£nd
)

309 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

310 
rvt_ah
 *
ah
;

311 
hfi1_µÜtd©a
 *
µd
;

312 
hfi1_devd©a
 *
dd
;

314 
qp
->
ibqp
.
qp_ty³
) {

315 
IB_QPT_RC
:

316 
	`hfi1_£tup_tid_rdma_wqe
(
qp
, 
wqe
);

318 
IB_QPT_UC
:

319 ià(
wqe
->
Ëngth
 > 0x80000000U)

320  -
EINVAL
;

321 ià(
wqe
->
Ëngth
 > 
qp
->
pmtu
)

322 *
ÿÎ_£nd
 = 
çl£
;

324 
IB_QPT_SMI
:

332 
µd
 = 
	`µd_äom_ibp
(
ibp
);

333 
dd
 = 
	`dd_äom_µd
(
µd
);

334 ià(
wqe
->
Ëngth
 > 
dd
->
vld
[15].
mtu
)

335  -
EINVAL
;

337 
IB_QPT_GSI
:

338 
IB_QPT_UD
:

339 
ah
 = 
	`rvt_g‘_swqe_ah
(
wqe
);

340 ià(
wqe
->
Ëngth
 > (1 << 
ah
->
log_pmtu
))

341  -
EINVAL
;

342 ià(
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(&
ah
->
©Œ
)] == 0xf)

343  -
EINVAL
;

352 ià(
wqe
->
Ëngth
 <ð
piÙh»shÞd
)

353 *
ÿÎ_£nd
 = 
Œue
;

355 
	}
}

366 
boÞ
 
	$_hfi1_scheduË_£nd
(
rvt_qp
 *
qp
)

368 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

369 
hfi1_ibpÜt
 *
ibp
 =

370 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

371 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

372 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

374 ià(
dd
->
æags
 & 
HFI1_SHUTDOWN
)

375  
Œue
;

377  
	`iowa™_scheduË
(&
´iv
->
s_iowa™
, 
µd
->
hfi1_wq
,

378 
´iv
->
s_sde
 ?

379 
´iv
->
s_sde
->
ýu
 :

380 
	`ýumask_fœ¡
(
	`ýumask_of_node
(
dd
->
node
)));

381 
	}
}

383 
	$qp_pio_d¿š
(
rvt_qp
 *
qp
)

385 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

387 ià(!
´iv
->
s_£ndcÚ‹xt
)

389 
	`iowa™_pio_³ndšg
(&
´iv
->
s_iowa™
)) {

390 
	`wr™e_£qlock_œq
(&
´iv
->
s_£ndcÚ‹xt
->
wa™lock
);

391 
	`hfi1_sc_wªiobuf_šŒ
(
´iv
->
s_£ndcÚ‹xt
, 1);

392 
	`wr™e_£quÆock_œq
(&
´iv
->
s_£ndcÚ‹xt
->
wa™lock
);

393 
	`iowa™_pio_d¿š
(&
´iv
->
s_iowa™
);

394 
	`wr™e_£qlock_œq
(&
´iv
->
s_£ndcÚ‹xt
->
wa™lock
);

395 
	`hfi1_sc_wªiobuf_šŒ
(
´iv
->
s_£ndcÚ‹xt
, 0);

396 
	`wr™e_£quÆock_œq
(&
´iv
->
s_£ndcÚ‹xt
->
wa™lock
);

398 
	}
}

409 
boÞ
 
	$hfi1_scheduË_£nd
(
rvt_qp
 *
qp
)

411 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

412 ià(
	`hfi1_£nd_ok
(
qp
)) {

413 
	`_hfi1_scheduË_£nd
(
qp
);

414  
Œue
;

416 ià(
qp
->
s_æags
 & 
HFI1_S_ANY_WAIT_IO
)

417 
	`iowa™_£t_æag
(&((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_iowa™
,

418 
IOWAIT_PENDING_IB
);

419  
çl£
;

420 
	}
}

422 
	$hfi1_qp_scheduË
(
rvt_qp
 *
qp
)

424 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

425 
boÞ
 
»t
;

427 ià(
	`iowa™_æag_£t
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
)) {

428 
»t
 = 
	`hfi1_scheduË_£nd
(
qp
);

429 ià(
»t
)

430 
	`iowa™_þ—r_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
);

432 ià(
	`iowa™_æag_£t
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
)) {

433 
»t
 = 
	`hfi1_scheduË_tid_£nd
(
qp
);

434 ià(
»t
)

435 
	`iowa™_þ—r_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
);

437 
	}
}

439 
	$hfi1_qp_wakeup
(
rvt_qp
 *
qp
, 
u32
 
æag
)

441 
æags
;

443 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

444 ià(
qp
->
s_æags
 & 
æag
) {

445 
qp
->
s_æags
 &ð~
æag
;

446 
	`Œaû_hfi1_qpwakeup
(
qp
, 
æag
);

447 
	`hfi1_qp_scheduË
(
qp
);

449 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

451 
	`rvt_put_qp
(
qp
);

452 
	}
}

454 
	$hfi1_qp_unbusy
(
rvt_qp
 *
qp
, 
iowa™_wÜk
 *
wa™
)

456 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

458 ià(
	`iowa™_£t_wÜk_æag
(
wa™
è=ð
IOWAIT_IB_SE
) {

459 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

469 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_BUSY_SET
) {

470 
´iv
->
s_æags
 &ð~(
HFI1_S_TID_BUSY_SET
 |

471 
RVT_S_BUSY
);

472 
	`iowa™_£t_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
);

475 
´iv
->
s_æags
 &ð~
RVT_S_BUSY
;

477 
	}
}

479 
	$iowa™_¦“p
(

480 
sdma_’gše
 *
sde
,

481 
iowa™_wÜk
 *
wa™
,

482 
sdma_tx»q
 *
¡x
,

483 
ušt
 
£q
,

484 
boÞ
 
pkts_£Á
)

486 
v”bs_tx»q
 *
tx
 = 
	`cÚš”_of
(
¡x
, v”bs_tx»q, 
tx»q
);

487 
rvt_qp
 *
qp
;

488 
hfi1_qp_´iv
 *
´iv
;

489 
æags
;

490 
»t
 = 0;

492 
qp
 = 
tx
->qp;

493 
´iv
 = 
qp
->priv;

495 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

496 ià(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
) {

503 
	`li¡_add_ž
(&
¡x
->
li¡
, &
wa™
->
tx_h—d
);

504 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

505 ià(
	`sdma_´og»ss
(
sde
, 
£q
, 
¡x
))

506 
—gaš
;

507 ià(
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
)) {

508 
hfi1_ibpÜt
 *
ibp
 =

509 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

511 
ibp
->
rvp
.
n_dmawa™
++;

512 
qp
->
s_æags
 |ð
RVT_S_WAIT_DMA_DESC
;

513 
	`iowa™_g‘_´iÜ™y
(&
´iv
->
s_iowa™
);

514 
	`iowa™_queue
(
pkts_£Á
, &
´iv
->
s_iowa™
,

515 &
sde
->
dmawa™
);

516 
´iv
->
s_iowa™
.
lock
 = &
sde
->
wa™lock
;

517 
	`Œaû_hfi1_qp¦“p
(
qp
, 
RVT_S_WAIT_DMA_DESC
);

518 
	`rvt_g‘_qp
(
qp
);

520 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

521 
	`hfi1_qp_unbusy
(
qp
, 
wa™
);

522 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

523 
»t
 = -
EBUSY
;

525 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

526 
	`hfi1_put_tx»q
(
tx
);

528  
»t
;

529 
—gaš
:

530 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

531 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

532 
	`li¡_d–_š™
(&
¡x
->
li¡
);

533  -
EAGAIN
;

534 
	}
}

536 
	$iowa™_wakeup
(
iowa™
 *
wa™
, 
»asÚ
)

538 
rvt_qp
 *
qp
 = 
	`iowa™_to_qp
(
wa™
);

540 
	`WARN_ON
(
»asÚ
 !ð
SDMA_AVAIL_REASON
);

541 
	`hfi1_qp_wakeup
(
qp
, 
RVT_S_WAIT_DMA_DESC
);

542 
	}
}

544 
	$iowa™_sdma_d¿šed
(
iowa™
 *
wa™
)

546 
rvt_qp
 *
qp
 = 
	`iowa™_to_qp
(
wa™
);

547 
æags
;

555 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

556 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_DMA
) {

557 
qp
->
s_æags
 &ð~
RVT_S_WAIT_DMA
;

558 
	`hfi1_scheduË_£nd
(
qp
);

560 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

561 
	}
}

563 
	$hfi1_š™_´iÜ™y
(
iowa™
 *
w
)

565 
rvt_qp
 *
qp
 = 
	`iowa™_to_qp
(
w
);

566 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

568 ià(
qp
->
s_æags
 & 
RVT_S_ACK_PENDING
)

569 
w
->
´iÜ™y
++;

570 ià(
´iv
->
s_æags
 & 
RVT_S_ACK_PENDING
)

571 
w
->
´iÜ™y
++;

572 
	}
}

582 
sdma_’gše
 *
	$qp_to_sdma_’gše
(
rvt_qp
 *
qp
, 
u8
 
sc5
)

584 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

585 
sdma_’gše
 *
sde
;

587 ià(!(
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
))

588  
NULL
;

589 
qp
->
ibqp
.
qp_ty³
) {

590 
IB_QPT_SMI
:

591  
NULL
;

595 
sde
 = 
	`sdma_£Ëù_’gše_sc
(
dd
, 
qp
->
ibqp
.
qp_num
 >> dd->
qos_shiá
, 
sc5
);

596  
sde
;

597 
	}
}

607 
£nd_cÚ‹xt
 *
	$qp_to_£nd_cÚ‹xt
(
rvt_qp
 *
qp
, 
u8
 
sc5
)

609 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

611 
qp
->
ibqp
.
qp_ty³
) {

612 
IB_QPT_SMI
:

614  
dd
->
vld
[15].
sc
;

619  
	`pio_£Ëù_£nd_cÚ‹xt_sc
(
dd
, 
qp
->
ibqp
.
qp_num
 >> dd->
qos_shiá
,

620 
sc5
);

621 
	}
}

623 cÚ¡ * cÚ¡ 
	gqp_ty³_¡r
[] = {

627 
	$qp_idË
(
rvt_qp
 *
qp
)

630 
qp
->
s_Ï¡
 =ðqp->
s_acked
 &&

631 
qp
->
s_acked
 =ðqp->
s_cur
 &&

632 
qp
->
s_cur
 =ðqp->
s_ž
 &&

633 
qp
->
s_ž
 =ðqp->
s_h—d
;

634 
	}
}

641 
	$qp_™”_´št
(
£q_fže
 *
s
, 
rvt_qp_™”
 *
™”
)

643 
rvt_swqe
 *
wqe
;

644 
rvt_qp
 *
qp
 = 
™”
->qp;

645 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

646 
sdma_’gše
 *
sde
;

647 
£nd_cÚ‹xt
 *send_context;

648 
rvt_ack_’Œy
 *
e
 = 
NULL
;

649 
rvt_¤q
 *
¤q
 = 
qp
->
ibqp
.srq ?

650 
	`ib¤q_to_rvt¤q
(
qp
->
ibqp
.
¤q
è: 
NULL
;

652 
sde
 = 
	`qp_to_sdma_’gše
(
qp
, 
´iv
->
s_sc
);

653 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_Ï¡
);

654 
£nd_cÚ‹xt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
, 
´iv
->
s_sc
);

655 ià(
qp
->
s_ack_queue
)

656 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

657 
	`£q_´štf
(
s
,

659 
™”
->
n
,

660 
	`qp_idË
(
qp
) ? "I" : "B",

661 
qp
->
ibqp
.
qp_num
,

662 
	`©omic_»ad
(&
qp
->
»fcouÁ
),

663 
qp_ty³_¡r
[
qp
->
ibqp
.
qp_ty³
],

664 
qp
->
¡©e
,

666 
wqe
 ? wqe->
wr
.
Ýcode
 : 0,

667 
wqe
 ? wqe->
s¢
 : 0,

668 
wqe
 ? wqe->
p¢
 : 0,

669 
wqe
 ? wqe->
Í¢
 : 0,

671 
qp
->
s_æags
,

672 
´iv
->
s_iowa™
.
æags
,

673 
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
),

674 
	`iowa™_pio_³ndšg
(&
´iv
->
s_iowa™
),

675 !
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
),

676 !
	`li¡_em±y
(&
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
)->
tx_h—d
),

677 !
	`li¡_em±y
(&
	`iowa™_g‘_tid_wÜk
(&
´iv
->
s_iowa™
)->
tx_h—d
),

678 
qp
->
timeout
,

680 
qp
->
s_rdma_ack_út
,

682 
qp
->
s_l¢
,

683 
qp
->
s_s¢
,

685 
qp
->
s_Ï¡_p¢
,

686 
qp
->
s_p¢
, qp->
s_Ãxt_p¢
,

687 
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
,

689 
qp
->
r_p¢
,

691 
qp
->
s_Ï¡
, qp->
s_acked
, qp->
s_cur
,

692 
qp
->
s_ž
, qp->
s_h—d
, qp->
s_size
,

693 
qp
->
s_avaž
,

695 
qp
->
s_ž_ack_queue
, qp->
r_h—d_ack_queue
,

696 
	`rvt_max_©omic
(&
	`to_idev
(
qp
->
ibqp
.
deviû
)->
rdi
),

698 
qp
->
»mÙe_q²
,

699 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
),

700 
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
),

701 
qp
->
pmtu
,

702 
qp
->
s_»Œy
,

703 
qp
->
s_»Œy_út
,

704 
qp
->
s_ºr_»Œy_út
,

705 
qp
->
s_ºr_»Œy
,

706 
sde
,

707 
sde
 ? sde->
this_idx
 : 0,

708 
£nd_cÚ‹xt
,

709 
£nd_cÚ‹xt
 ? s’d_cÚ‹xt->
sw_šdex
 : 0,

710 
	`ib_cq_h—d
(
qp
->
ibqp
.
£nd_cq
),

711 
	`ib_cq_ž
(
qp
->
ibqp
.
£nd_cq
),

712 
qp
->
pid
,

713 
qp
->
s_¡©e
,

714 
qp
->
s_ack_¡©e
,

716 
e
 ?ƒ->
Ýcode
 : 0,

717 
e
 ?ƒ->
p¢
 : 0,

718 
e
 ?ƒ->
Í¢
 : 0,

719 
qp
->
r_mš_ºr_tim”
,

720 
¤q
 ? "SRQ" : "RQ",

721 
¤q
 ? srq->
rq
.
size
 : 
qp
->
r_rq
.size,

722 
´iv
->
rcd
 ?…riv->rcd->
ùxt
 : 0

725 
	`hfi1_qp_tid_´št
(
s
, 
qp
);

726 
	}
}

728 #ifdeà
HAVE_IB_QP_CREATE_USE_GFP_NOIO


729 *
	$qp_´iv_®loc
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
, 
gå_t
 
gå
)

731 *
	$qp_´iv_®loc
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
)

734 
hfi1_qp_´iv
 *
´iv
;

735 #iâdeà
HAVE_IB_QP_CREATE_USE_GFP_NOIO


736 
gå_t
 
gå
 = 
GFP_KERNEL
;

739 
´iv
 = 
	`kz®loc_node
((*´iv), 
gå
, 
rdi
->
d·rms
.
node
);

740 ià(!
´iv
)

741  
	`ERR_PTR
(-
ENOMEM
);

743 
´iv
->
owÃr
 = 
qp
;

745 
´iv
->
s_ahg
 = 
	`kz®loc_node
((*´iv->s_ahg), 
gå
,

746 
rdi
->
d·rms
.
node
);

747 ià(!
´iv
->
s_ahg
) {

748 
	`kä“
(
´iv
);

749  
	`ERR_PTR
(-
ENOMEM
);

751 
	`iowa™_š™
(

752 &
´iv
->
s_iowa™
,

754 
_hfi1_do_£nd
,

755 
_hfi1_do_tid_£nd
,

756 
iowa™_¦“p
,

757 
iowa™_wakeup
,

758 
iowa™_sdma_d¿šed
,

759 
hfi1_š™_´iÜ™y
);

761 
´iv
->
s_ruÂšg_pkt_size
 = 
piÙh»shÞd
 / 2;

762  
´iv
;

763 
	}
}

765 
	$qp_´iv_ä“
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
)

767 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

769 
	`hfi1_qp_´iv_tid_ä“
(
rdi
, 
qp
);

770 
	`kä“
(
´iv
->
s_ahg
);

771 
	`kä“
(
´iv
);

772 
	}
}

774 
	$ä“_®l_qps
(
rvt_dev_šfo
 *
rdi
)

776 
hfi1_ibdev
 *
v”bs_dev
 = 
	`cÚš”_of
(
rdi
,

777 
hfi1_ibdev
,

778 
rdi
);

779 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
v”bs_dev
,

780 
hfi1_devd©a
,

781 
v”bs_dev
);

782 
n
;

783 
qp_šu£
 = 0;

785 
n
 = 0;‚ < 
dd
->
num_µÜts
;‚++) {

786 
hfi1_ibpÜt
 *
ibp
 = &
dd
->
µÜt
[
n
].
ibpÜt_d©a
;

788 
	`rcu_»ad_lock
();

789 ià(
	`rcu_d”eã»nû
(
ibp
->
rvp
.
qp
[0]))

790 
qp_šu£
++;

791 ià(
	`rcu_d”eã»nû
(
ibp
->
rvp
.
qp
[1]))

792 
qp_šu£
++;

793 
	`rcu_»ad_uÆock
();

796  
qp_šu£
;

797 
	}
}

799 
	$æush_qp_wa™”s
(
rvt_qp
 *
qp
)

801 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

802 
	`æush_iowa™
(
qp
);

803 
	`hfi1_tid_rdma_æush_wa™
(
qp
);

804 
	}
}

806 
	$¡Ý_£nd_queue
(
rvt_qp
 *
qp
)

808 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

810 
	`iowa™_ÿnûl_wÜk
(&
´iv
->
s_iowa™
);

811 ià(
	`ÿnûl_wÜk_sync
(&
´iv
->
tid_rdma
.
Œigg”_wÜk
))

812 
	`rvt_put_qp
(
qp
);

813 
	}
}

815 
	$qu›sû_qp
(
rvt_qp
 *
qp
)

817 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

819 
	`hfi1_d–_tid_»­_tim”
(
qp
);

820 
	`hfi1_d–_tid_»Œy_tim”
(
qp
);

821 
	`iowa™_sdma_d¿š
(&
´iv
->
s_iowa™
);

822 
	`qp_pio_d¿š
(
qp
);

823 
	`æush_tx_li¡
(
qp
);

824 
	}
}

826 
	$nÙify_qp_»£t
(
rvt_qp
 *
qp
)

828 
	`hfi1_qp_k”n_exp_rcv_þ—r_®l
(
qp
);

829 
qp
->
r_adeã»d
 = 0;

830 
	`þ—r_ahg
(
qp
);

833 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
)

834 
	`Ýâ_cÚn_”rÜ
(
qp
);

835 
	}
}

841 
	$hfi1_mig¿‹_qp
(
rvt_qp
 *
qp
)

843 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

844 
ib_ev’t
 
ev
;

846 
qp
->
s_mig_¡©e
 = 
IB_MIG_MIGRATED
;

847 
qp
->
»mÙe_ah_©Œ
 = qp->
®t_ah_©Œ
;

848 
qp
->
pÜt_num
 = 
	`rdma_ah_g‘_pÜt_num
(&qp->
®t_ah_©Œ
);

849 
qp
->
s_pkey_šdex
 = qp->
s_®t_pkey_šdex
;

850 
qp
->
s_æags
 |ð
HFI1_S_AHG_CLEAR
;

851 
´iv
->
s_sc
 = 
	`ah_to_sc
(
qp
->
ibqp
.
deviû
, &qp->
»mÙe_ah_©Œ
);

852 
´iv
->
s_sde
 = 
	`qp_to_sdma_’gše
(
qp
,…riv->
s_sc
);

853 
	`qp_£t_16b
(
qp
);

855 
ev
.
deviû
 = 
qp
->
ibqp
.device;

856 
ev
.
–em’t
.
qp
 = &qp->
ibqp
;

857 
ev
.
ev’t
 = 
IB_EVENT_PATH_MIG
;

858 
qp
->
ibqp
.
	`ev’t_hªdËr
(&
ev
, qp->ibqp.
qp_cÚ‹xt
);

859 
	}
}

861 
	$mtu_to_·th_mtu
(
u32
 
mtu
)

863  
	`mtu_to_’um
(
mtu
, 
OPA_MTU_8192
);

864 
	}
}

866 
u32
 
	$mtu_äom_qp
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
, 
u32
 
pmtu
)

868 
u32
 
mtu
;

869 
hfi1_ibdev
 *
v”bs_dev
 = 
	`cÚš”_of
(
rdi
,

870 
hfi1_ibdev
,

871 
rdi
);

872 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
v”bs_dev
,

873 
hfi1_devd©a
,

874 
v”bs_dev
);

875 
hfi1_ibpÜt
 *
ibp
;

876 
u8
 
sc
, 
vl
;

878 
ibp
 = &
dd
->
µÜt
[
qp
->
pÜt_num
 - 1].
ibpÜt_d©a
;

879 
sc
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
)];

880 
vl
 = 
	`sc_to_vÉ
(
dd
, 
sc
);

882 
mtu
 = 
	`v”bs_mtu_’um_to_št
(
qp
->
ibqp
.
deviû
, 
pmtu
);

883 ià(
vl
 < 
PER_VL_SEND_CONTEXTS
)

884 
mtu
 = 
	`mš_t
(
u32
, mtu, 
dd
->
vld
[
vl
].mtu);

885  
mtu
;

886 
	}
}

888 
	$g‘_pmtu_äom_©Œ
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
,

889 
ib_qp_©Œ
 *
©Œ
)

891 
mtu
, 
pidx
 = 
qp
->
pÜt_num
 - 1;

892 
hfi1_ibdev
 *
v”bs_dev
 = 
	`cÚš”_of
(
rdi
,

893 
hfi1_ibdev
,

894 
rdi
);

895 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
v”bs_dev
,

896 
hfi1_devd©a
,

897 
v”bs_dev
);

898 
mtu
 = 
	`v”bs_mtu_’um_to_št
(
qp
->
ibqp
.
deviû
, 
©Œ
->
·th_mtu
);

899 ià(
mtu
 == -1)

902 ià(
mtu
 > 
dd
->
µÜt
[
pidx
].
ibmtu
)

903  
	`mtu_to_’um
(
dd
->
µÜt
[
pidx
].
ibmtu
, 
IB_MTU_2048
);

905  
©Œ
->
·th_mtu
;

906 
	}
}

908 
	$nÙify_”rÜ_qp
(
rvt_qp
 *
qp
)

910 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

911 
£qlock_t
 *
lock
 = 
´iv
->
s_iowa™
.lock;

913 ià(
lock
) {

914 
	`wr™e_£qlock
(
lock
);

915 ià(!
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
) &&

916 !(
qp
->
s_æags
 & 
RVT_S_BUSY
) &&

917 !(
´iv
->
s_æags
 & 
RVT_S_BUSY
)) {

918 
qp
->
s_æags
 &ð~
HFI1_S_ANY_WAIT_IO
;

919 
	`iowa™_þ—r_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
);

920 
	`iowa™_þ—r_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
);

921 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

922 
´iv
->
s_iowa™
.
lock
 = 
NULL
;

923 
	`rvt_put_qp
(
qp
);

925 
	`wr™e_£quÆock
(
lock
);

928 ià(!(
qp
->
s_æags
 & 
RVT_S_BUSY
è&& !(
´iv
->s_flags & RVT_S_BUSY)) {

929 
qp
->
s_hdrwÜds
 = 0;

930 ià(
qp
->
s_rdma_mr
) {

931 
	`rvt_put_mr
(
qp
->
s_rdma_mr
);

932 
qp
->
s_rdma_mr
 = 
NULL
;

934 
	`æush_tx_li¡
(
qp
);

936 
	}
}

946 
	$hfi1_qp_™”_cb
(
rvt_qp
 *
qp
, 
u64
 
v
)

948 
Ï¡wqe
;

949 
ib_ev’t
 
ev
;

950 
hfi1_ibpÜt
 *
ibp
 =

951 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

952 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

953 
u8
 
¦
 = (u8)
v
;

955 ià(
qp
->
pÜt_num
 !ð
µd
->
pÜt
 ||

956 (
qp
->
ibqp
.
qp_ty³
 !ð
IB_QPT_UC
 &&

957 
qp
->
ibqp
.
qp_ty³
 !ð
IB_QPT_RC
) ||

958 
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
è!ð
¦
 ||

959 !(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_POST_SEND_OK
))

962 
	`¥š_lock_œq
(&
qp
->
r_lock
);

963 
	`¥š_lock
(&
qp
->
s_hlock
);

964 
	`¥š_lock
(&
qp
->
s_lock
);

965 
Ï¡wqe
 = 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

966 
	`¥š_uÆock
(&
qp
->
s_lock
);

967 
	`¥š_uÆock
(&
qp
->
s_hlock
);

968 
	`¥š_uÆock_œq
(&
qp
->
r_lock
);

969 ià(
Ï¡wqe
) {

970 
ev
.
deviû
 = 
qp
->
ibqp
.device;

971 
ev
.
–em’t
.
qp
 = &qp->
ibqp
;

972 
ev
.
ev’t
 = 
IB_EVENT_QP_LAST_WQE_REACHED
;

973 
qp
->
ibqp
.
	`ev’t_hªdËr
(&
ev
, qp->ibqp.
qp_cÚ‹xt
);

975 
	}
}

986 
	$hfi1_”rÜ_pÜt_qps
(
hfi1_ibpÜt
 *
ibp
, 
u8
 
¦
)

988 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

989 
hfi1_ibdev
 *
dev
 = &
µd
->
dd
->
v”bs_dev
;

991 
	`rvt_qp_™”
(&
dev
->
rdi
, 
¦
, 
hfi1_qp_™”_cb
);

992 
	}
}

	@qp.h

1 #iâdeà
_QP_H


2 
	#_QP_H


	)

50 
	~<lšux/hash.h
>

51 
	~<rdma/rdmavt_qp.h
>

52 
	~"v”bs.h
"

53 
	~"sdma.h
"

54 
	~"v”bs_tx»q.h
"

56 
hfi1_qp_bË_size
;

58 cÚ¡ 
rvt_Ý”©iÚ_·¿ms
 
hfi1_po¡_·rms
[];

71 
	#HFI1_S_AHG_VALID
 0x80000000

	)

72 
	#HFI1_S_AHG_CLEAR
 0x40000000

	)

73 
	#HFI1_S_WAIT_PIO_DRAIN
 0x20000000

	)

74 
	#HFI1_S_WAIT_TID_RESP
 0x10000000

	)

75 
	#HFI1_S_WAIT_TID_SPACE
 0x08000000

	)

76 
	#HFI1_S_WAIT_HALT
 0x04000000

	)

77 
	#HFI1_S_MIN_BIT_MASK
 0x01000000

	)

83 
	#HFI1_S_ANY_WAIT_IO
 (
RVT_S_ANY_WAIT_IO
 | 
HFI1_S_WAIT_PIO_DRAIN
)

	)

84 
	#HFI1_S_ANY_WAIT
 (
HFI1_S_ANY_WAIT_IO
 | 
RVT_S_ANY_WAIT_SEND
)

	)

85 
	#HFI1_S_ANY_TID_WAIT_SEND
 (
RVT_S_WAIT_SSN_CREDIT
 | 
RVT_S_WAIT_DMA
)

	)

91 
šlše
 
	$hfi1_£nd_ok
(
rvt_qp
 *
qp
)

93 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

95  !(
qp
->
s_æags
 & (
RVT_S_BUSY
 | 
HFI1_S_ANY_WAIT_IO
)) &&

96 (
	`v”bs_tx»q_queued
(
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
)) ||

97 (
qp
->
s_æags
 & 
RVT_S_RESP_PENDING
) ||

98 !(
qp
->
s_æags
 & 
RVT_S_ANY_WAIT_SEND
));

99 
	}
}

109 
	#HFI1_S_AHG_VALID
 0x80000000

	)

110 
	#HFI1_S_AHG_CLEAR
 0x40000000

	)

111 
	#HFI1_S_WAIT_PIO_DRAIN
 0x20000000

	)

112 
	#HFI1_S_MIN_BIT_MASK
 0x01000000

	)

118 
	#HFI1_S_ANY_WAIT_IO
 (
RVT_S_ANY_WAIT_IO
 | 
HFI1_S_WAIT_PIO_DRAIN
)

	)

119 
	#HFI1_S_ANY_WAIT
 (
HFI1_S_ANY_WAIT_IO
 | 
RVT_S_ANY_WAIT_SEND
)

	)

124 
šlše
 
	$þ—r_ahg
(
rvt_qp
 *
qp
)

126 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

128 
´iv
->
s_ahg
->
ahgcouÁ
 = 0;

129 
qp
->
s_æags
 &ð~(
HFI1_S_AHG_VALID
 | 
HFI1_S_AHG_CLEAR
);

130 ià(
´iv
->
s_sde
 && 
qp
->
s_ahgidx
 >= 0)

131 
	`sdma_ahg_ä“
(
´iv
->
s_sde
, 
qp
->
s_ahgidx
);

132 
qp
->
s_ahgidx
 = -1;

133 
	}
}

145 
ib_qp
 *
hfi1_ü—‹_qp
(
ib_pd
 *
ibpd
,

146 
ib_qp_š™_©Œ
 *
š™_©Œ
,

147 
ib_ud©a
 *
ud©a
);

154 
hfi1_qp_wakeup
(
rvt_qp
 *
qp
, 
u32
 
æag
);

156 
sdma_’gše
 *
qp_to_sdma_’gše
(
rvt_qp
 *
qp
, 
u8
 
sc5
);

157 
£nd_cÚ‹xt
 *
qp_to_£nd_cÚ‹xt
(
rvt_qp
 *
qp
, 
u8
 
sc5
);

159 
qp_™”_´št
(
£q_fže
 *
s
, 
rvt_qp_™”
 *
™”
);

161 
boÞ
 
_hfi1_scheduË_£nd
(
rvt_qp
 *
qp
);

162 
boÞ
 
hfi1_scheduË_£nd
(
rvt_qp
 *
qp
);

164 
hfi1_mig¿‹_qp
(
rvt_qp
 *
qp
);

169 #ifdeà
HAVE_IB_QP_CREATE_USE_GFP_NOIO


170 *
qp_´iv_®loc
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
, 
gå_t
 
gå
);

172 *
qp_´iv_®loc
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
);

174 
qp_´iv_ä“
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
);

175 
ä“_®l_qps
(
rvt_dev_šfo
 *
rdi
);

176 
nÙify_qp_»£t
(
rvt_qp
 *
qp
);

177 
g‘_pmtu_äom_©Œ
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
,

178 
ib_qp_©Œ
 *
©Œ
);

179 
æush_qp_wa™”s
(
rvt_qp
 *
qp
);

180 
nÙify_”rÜ_qp
(
rvt_qp
 *
qp
);

181 
¡Ý_£nd_queue
(
rvt_qp
 *
qp
);

182 
qu›sû_qp
(
rvt_qp
 *
qp
);

183 
u32
 
mtu_äom_qp
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
, u32 
pmtu
);

184 
mtu_to_·th_mtu
(
u32
 
mtu
);

185 
hfi1_”rÜ_pÜt_qps
(
hfi1_ibpÜt
 *
ibp
, 
u8
 
¦
);

186 
hfi1_qp_unbusy
(
rvt_qp
 *
qp
, 
iowa™_wÜk
 *
wa™
);

	@qsfp.c

48 
	~<lšux/d–ay.h
>

49 
	~<lšux/pci.h
>

50 
	~<lšux/vm®loc.h
>

52 
	~"hfi.h
"

55 
šlše
 
u32
 
	$i2c_š_c¤
(
u32
 
bus_num
)

57  
bus_num
 ? 
ASIC_QSFP2_IN
 : 
ASIC_QSFP1_IN
;

58 
	}
}

61 
šlše
 
u32
 
	$i2c_Û_c¤
(
u32
 
bus_num
)

63  
bus_num
 ? 
ASIC_QSFP2_OE
 : 
ASIC_QSFP1_OE
;

64 
	}
}

66 
	$hfi1_£tsda
(*
d©a
, 
¡©e
)

68 
hfi1_i2c_bus
 *
bus
 = (hfi1_i2c_bu *)
d©a
;

69 
hfi1_devd©a
 *
dd
 = 
bus
->
cÚŒÞlšg_dd
;

70 
u64
 
»g
;

71 
u32
 
rg‘_Û
;

73 
rg‘_Û
 = 
	`i2c_Û_c¤
(
bus
->
num
);

74 
»g
 = 
	`»ad_c¤
(
dd
, 
rg‘_Û
);

81 ià(
¡©e
)

82 
»g
 &ð~
QSFP_HFI0_I2CDAT
;

84 
»g
 |ð
QSFP_HFI0_I2CDAT
;

85 
	`wr™e_c¤
(
dd
, 
rg‘_Û
, 
»g
);

87 ()
	`»ad_c¤
(
dd
, 
rg‘_Û
);

88 
	}
}

90 
	$hfi1_£tsþ
(*
d©a
, 
¡©e
)

92 
hfi1_i2c_bus
 *
bus
 = (hfi1_i2c_bu *)
d©a
;

93 
hfi1_devd©a
 *
dd
 = 
bus
->
cÚŒÞlšg_dd
;

94 
u64
 
»g
;

95 
u32
 
rg‘_Û
;

97 
rg‘_Û
 = 
	`i2c_Û_c¤
(
bus
->
num
);

98 
»g
 = 
	`»ad_c¤
(
dd
, 
rg‘_Û
);

105 ià(
¡©e
)

106 
»g
 &ð~
QSFP_HFI0_I2CCLK
;

108 
»g
 |ð
QSFP_HFI0_I2CCLK
;

109 
	`wr™e_c¤
(
dd
, 
rg‘_Û
, 
»g
);

111 ()
	`»ad_c¤
(
dd
, 
rg‘_Û
);

112 
	}
}

114 
	$hfi1_g‘sda
(*
d©a
)

116 
hfi1_i2c_bus
 *
bus
 = (hfi1_i2c_bu *)
d©a
;

117 
u64
 
»g
;

118 
u32
 
rg‘_š
;

120 
	`hfi1_£tsda
(
d©a
, 1);

121 
	`ud–ay
(2);

123 
rg‘_š
 = 
	`i2c_š_c¤
(
bus
->
num
);

124 
»g
 = 
	`»ad_c¤
(
bus
->
cÚŒÞlšg_dd
, 
rg‘_š
);

125  !!(
»g
 & 
QSFP_HFI0_I2CDAT
);

126 
	}
}

128 
	$hfi1_g‘sþ
(*
d©a
)

130 
hfi1_i2c_bus
 *
bus
 = (hfi1_i2c_bu *)
d©a
;

131 
u64
 
»g
;

132 
u32
 
rg‘_š
;

134 
	`hfi1_£tsþ
(
d©a
, 1);

135 
	`ud–ay
(2);

137 
rg‘_š
 = 
	`i2c_š_c¤
(
bus
->
num
);

138 
»g
 = 
	`»ad_c¤
(
bus
->
cÚŒÞlšg_dd
, 
rg‘_š
);

139  !!(
»g
 & 
QSFP_HFI0_I2CCLK
);

140 
	}
}

146 
hfi1_i2c_bus
 *
	$š™_i2c_bus
(
hfi1_devd©a
 *
dd
,

147 
hfi1_asic_d©a
 *
ad
, 
num
)

149 
hfi1_i2c_bus
 *
bus
;

150 
»t
;

152 
bus
 = 
	`kz®loc
((*bus), 
GFP_KERNEL
);

153 ià(!
bus
)

154  
NULL
;

156 
bus
->
cÚŒÞlšg_dd
 = 
dd
;

157 
bus
->
num
 =‚um;

159 
bus
->
®go
.
£tsda
 = 
hfi1_£tsda
;

160 
bus
->
®go
.
£tsþ
 = 
hfi1_£tsþ
;

161 
bus
->
®go
.
g‘sda
 = 
hfi1_g‘sda
;

162 
bus
->
®go
.
g‘sþ
 = 
hfi1_g‘sþ
;

163 
bus
->
®go
.
ud–ay
 = 5;

164 
bus
->
®go
.
timeout
 = 
	`u£cs_to_jiff›s
(100000);

165 
bus
->
®go
.
d©a
 = bus;

167 
bus
->
ad­‹r
.
owÃr
 = 
THIS_MODULE
;

168 
bus
->
ad­‹r
.
®go_d©a
 = &bus->
®go
;

169 
bus
->
ad­‹r
.
dev
.
·»Á
 = &
dd
->
pcidev
->dev;

170 
	`¢´štf
(
bus
->
ad­‹r
.
Çme
, (bus->adapter.name),

171 "hfi1_i2c%d", 
num
);

173 
»t
 = 
	`i2c_b™_add_bus
(&
bus
->
ad­‹r
);

174 ià(
»t
) {

175 
	`dd_dev_šfo
(
dd
, "%s: unableo‡dd i2c bus %d,ƒrr %d\n",

176 
__func__
, 
num
, 
»t
);

177 
	`kä“
(
bus
);

178  
NULL
;

181  
bus
;

182 
	}
}

188 
	$£t_up_i2c
(
hfi1_devd©a
 *
dd
, 
hfi1_asic_d©a
 *
ad
)

190 
ad
->
i2c_bus0
 = 
	`š™_i2c_bus
(
dd
,‡d, 0);

191 
ad
->
i2c_bus1
 = 
	`š™_i2c_bus
(
dd
,‡d, 1);

192 ià(!
ad
->
i2c_bus0
 || !ad->
i2c_bus1
)

193  -
ENOMEM
;

195 
	}
};

197 
	$þ—n_i2c_bus
(
hfi1_i2c_bus
 *
bus
)

199 ià(
bus
) {

200 
	`i2c_d–_ad­‹r
(&
bus
->
ad­‹r
);

201 
	`kä“
(
bus
);

203 
	}
}

205 
	$þ—n_up_i2c
(
hfi1_devd©a
 *
dd
, 
hfi1_asic_d©a
 *
ad
)

207 ià(!
ad
)

209 
	`þ—n_i2c_bus
(
ad
->
i2c_bus0
);

210 
ad
->
i2c_bus0
 = 
NULL
;

211 
	`þ—n_i2c_bus
(
ad
->
i2c_bus1
);

212 
ad
->
i2c_bus1
 = 
NULL
;

213 
	}
}

215 
	$i2c_bus_wr™e
(
hfi1_devd©a
 *
dd
, 
hfi1_i2c_bus
 *
i2c
,

216 
u8
 
¦ave_addr
, 
off£t
, 
off£t_size
,

217 
u8
 *
d©a
, 
u16
 
Ën
)

219 
»t
;

220 
num_msgs
;

221 
u8
 
off£t_by‹s
[2];

222 
i2c_msg
 
msgs
[2];

224 
off£t_size
) {

226 
num_msgs
 = 1;

227 
msgs
[0].
addr
 = 
¦ave_addr
;

228 
msgs
[0].
æags
 = 0;

229 
msgs
[0].
Ën
 =†en;

230 
msgs
[0].
buf
 = 
d©a
;

233 
off£t_by‹s
[1] = (
off£t
 >> 8) & 0xff;

236 
num_msgs
 = 2;

237 
off£t_by‹s
[0] = 
off£t
 & 0xff;

239 
msgs
[0].
addr
 = 
¦ave_addr
;

240 
msgs
[0].
æags
 = 0;

241 
msgs
[0].
Ën
 = 
off£t_size
;

242 
msgs
[0].
buf
 = 
off£t_by‹s
;

244 
msgs
[1].
addr
 = 
¦ave_addr
;

245 
msgs
[1].
æags
 = 
I2C_M_NOSTART
,

246 
msgs
[1].
Ën
 =†en;

247 
msgs
[1].
buf
 = 
d©a
;

250  -
EINVAL
;

253 
i2c
->
cÚŒÞlšg_dd
 = 
dd
;

254 
»t
 = 
	`i2c_Œªsãr
(&
i2c
->
ad­‹r
, 
msgs
, 
num_msgs
);

255 ià(
»t
 !ð
num_msgs
) {

256 
	`dd_dev_”r
(
dd
, "%s: bus %d, i2c slave 0x%x, offset 0x%x,†en 0x%x; write failed,„et %d\n",

257 
__func__
, 
i2c
->
num
, 
¦ave_addr
, 
off£t
, 
Ën
, 
»t
);

258  
»t
 < 0 ?„‘ : -
EIO
;

261 
	}
}

263 
	$i2c_bus_»ad
(
hfi1_devd©a
 *
dd
, 
hfi1_i2c_bus
 *
bus
,

264 
u8
 
¦ave_addr
, 
off£t
, 
off£t_size
,

265 
u8
 *
d©a
, 
u16
 
Ën
)

267 
»t
;

268 
num_msgs
;

269 
u8
 
off£t_by‹s
[2];

270 
i2c_msg
 
msgs
[2];

272 
off£t_size
) {

274 
num_msgs
 = 1;

275 
msgs
[0].
addr
 = 
¦ave_addr
;

276 
msgs
[0].
æags
 = 
I2C_M_RD
;

277 
msgs
[0].
Ën
 =†en;

278 
msgs
[0].
buf
 = 
d©a
;

281 
off£t_by‹s
[1] = (
off£t
 >> 8) & 0xff;

284 
num_msgs
 = 2;

285 
off£t_by‹s
[0] = 
off£t
 & 0xff;

287 
msgs
[0].
addr
 = 
¦ave_addr
;

288 
msgs
[0].
æags
 = 0;

289 
msgs
[0].
Ën
 = 
off£t_size
;

290 
msgs
[0].
buf
 = 
off£t_by‹s
;

292 
msgs
[1].
addr
 = 
¦ave_addr
;

293 
msgs
[1].
æags
 = 
I2C_M_RD
,

294 
msgs
[1].
Ën
 =†en;

295 
msgs
[1].
buf
 = 
d©a
;

298  -
EINVAL
;

301 
bus
->
cÚŒÞlšg_dd
 = 
dd
;

302 
»t
 = 
	`i2c_Œªsãr
(&
bus
->
ad­‹r
, 
msgs
, 
num_msgs
);

303 ià(
»t
 !ð
num_msgs
) {

304 
	`dd_dev_”r
(
dd
, "%s: bus %d, i2c slave 0x%x, offset 0x%x,†en 0x%x;„ead failed,„et %d\n",

305 
__func__
, 
bus
->
num
, 
¦ave_addr
, 
off£t
, 
Ën
, 
»t
);

306  
»t
 < 0 ?„‘ : -
EIO
;

309 
	}
}

316 
	$__i2c_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
,

317 
off£t
, *
bp
, 
Ën
)

319 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

320 
hfi1_i2c_bus
 *
bus
;

321 
u8
 
¦ave_addr
;

322 
off£t_size
;

324 
bus
 = 
rg‘
 ? 
dd
->
asic_d©a
->
i2c_bus1
 : dd->asic_d©a->
i2c_bus0
;

325 
¦ave_addr
 = (
i2c_addr
 & 0xff) >> 1;

326 
off£t_size
 = (
i2c_addr
 >> 8) & 0x3;

327  
	`i2c_bus_wr™e
(
dd
, 
bus
, 
¦ave_addr
, 
off£t
, 
off£t_size
, 
bp
, 
Ën
);

328 
	}
}

335 
	$i2c_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
, 
off£t
,

336 *
bp
, 
Ën
)

338 
»t
;

340 ià(!
	`check_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 
__func__
))

341  -
EACCES
;

343 
»t
 = 
	`__i2c_wr™e
(
µd
, 
rg‘
, 
i2c_addr
, 
off£t
, 
bp
, 
Ën
);

344 ià(
»t
)

345  
»t
;

347  
Ën
;

348 
	}
}

355 
	$__i2c_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
,

356 
off£t
, *
bp
, 
Ën
)

358 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

359 
hfi1_i2c_bus
 *
bus
;

360 
u8
 
¦ave_addr
;

361 
off£t_size
;

363 
bus
 = 
rg‘
 ? 
dd
->
asic_d©a
->
i2c_bus1
 : dd->asic_d©a->
i2c_bus0
;

364 
¦ave_addr
 = (
i2c_addr
 & 0xff) >> 1;

365 
off£t_size
 = (
i2c_addr
 >> 8) & 0x3;

366  
	`i2c_bus_»ad
(
dd
, 
bus
, 
¦ave_addr
, 
off£t
, 
off£t_size
, 
bp
, 
Ën
);

367 
	}
}

374 
	$i2c_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
, 
off£t
,

375 *
bp
, 
Ën
)

377 
»t
;

379 ià(!
	`check_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 
__func__
))

380  -
EACCES
;

382 
»t
 = 
	`__i2c_»ad
(
µd
, 
rg‘
, 
i2c_addr
, 
off£t
, 
bp
, 
Ën
);

383 ià(
»t
)

384  
»t
;

386  
Ën
;

387 
	}
}

397 
	$qså_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

398 
Ën
)

400 
couÁ
 = 0;

401 
off£t
;

402 
nwr™e
;

403 
»t
 = 0;

404 
u8
 
·ge
;

406 ià(!
	`check_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 
__func__
))

407  -
EACCES
;

409 
couÁ
 < 
Ën
) {

414 
·ge
 = (
u8
)(
addr
 / 
QSFP_PAGESIZE
);

416 
»t
 = 
	`__i2c_wr™e
(
µd
, 
rg‘
, 
QSFP_DEV
 | 
QSFP_OFFSET_SIZE
,

417 
QSFP_PAGE_SELECT_BYTE_OFFS
, &
·ge
, 1);

419 
	`md–ay
(5);

420 ià(
»t
) {

421 
	`hfi1_dev_pÜ‹¼
(
µd
->
dd
,…pd->
pÜt
,

423 
rg‘
, 
»t
);

427 
off£t
 = 
addr
 % 
QSFP_PAGESIZE
;

428 
nwr™e
 = 
Ën
 - 
couÁ
;

430 ià(((
addr
 % 
QSFP_RW_BOUNDARY
è+ 
nwr™e
) > QSFP_RW_BOUNDARY)

431 
nwr™e
 = 
QSFP_RW_BOUNDARY
 - (
addr
 % QSFP_RW_BOUNDARY);

433 
»t
 = 
	`__i2c_wr™e
(
µd
, 
rg‘
, 
QSFP_DEV
 | 
QSFP_OFFSET_SIZE
,

434 
off£t
, 
bp
 + 
couÁ
, 
nwr™e
);

436 
	`md–ay
(5);

437 ià(
»t
)

440 
couÁ
 +ð
nwr™e
;

441 
addr
 +ð
nwr™e
;

444 ià(
»t
 < 0)

445  
»t
;

446  
couÁ
;

447 
	}
}

453 
	$Úe_qså_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

454 
Ën
)

456 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

457 
u32
 
»sourû
 = 
	`qså_»sourû
(
dd
);

458 
»t
;

460 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
»sourû
, 
QSFP_WAIT
);

461 ià(
»t
)

462  
»t
;

463 
»t
 = 
	`qså_wr™e
(
µd
, 
rg‘
, 
addr
, 
bp
, 
Ën
);

464 
	`»Ëa£_ch_»sourû
(
dd
, 
»sourû
);

466  
»t
;

467 
	}
}

477 
	$qså_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

478 
Ën
)

480 
couÁ
 = 0;

481 
off£t
;

482 
Ä—d
;

483 
»t
 = 0;

484 
u8
 
·ge
;

486 ià(!
	`check_ch_»sourû
(
µd
->
dd
, 
	`i2c_rg‘
(
rg‘
), 
__func__
))

487  -
EACCES
;

489 
couÁ
 < 
Ën
) {

494 
·ge
 = (
u8
)(
addr
 / 
QSFP_PAGESIZE
);

495 
»t
 = 
	`__i2c_wr™e
(
µd
, 
rg‘
, 
QSFP_DEV
 | 
QSFP_OFFSET_SIZE
,

496 
QSFP_PAGE_SELECT_BYTE_OFFS
, &
·ge
, 1);

498 
	`md–ay
(5);

499 ià(
»t
) {

500 
	`hfi1_dev_pÜ‹¼
(
µd
->
dd
,…pd->
pÜt
,

502 
rg‘
, 
»t
);

506 
off£t
 = 
addr
 % 
QSFP_PAGESIZE
;

507 
Ä—d
 = 
Ën
 - 
couÁ
;

509 ià(((
addr
 % 
QSFP_RW_BOUNDARY
è+ 
Ä—d
) > QSFP_RW_BOUNDARY)

510 
Ä—d
 = 
QSFP_RW_BOUNDARY
 - (
addr
 % QSFP_RW_BOUNDARY);

512 
»t
 = 
	`__i2c_»ad
(
µd
, 
rg‘
, 
QSFP_DEV
 | 
QSFP_OFFSET_SIZE
,

513 
off£t
, 
bp
 + 
couÁ
, 
Ä—d
);

514 ià(
»t
)

517 
couÁ
 +ð
Ä—d
;

518 
addr
 +ð
Ä—d
;

521 ià(
»t
 < 0)

522  
»t
;

523  
couÁ
;

524 
	}
}

530 
	$Úe_qså_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

531 
Ën
)

533 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

534 
u32
 
»sourû
 = 
	`qså_»sourû
(
dd
);

535 
»t
;

537 
»t
 = 
	`acquœe_ch_»sourû
(
dd
, 
»sourû
, 
QSFP_WAIT
);

538 ià(
»t
)

539  
»t
;

540 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 
addr
, 
bp
, 
Ën
);

541 
	`»Ëa£_ch_»sourû
(
dd
, 
»sourû
);

543  
»t
;

544 
	}
}

558 
	$»äesh_qså_ÿche
(
hfi1_µÜtd©a
 *
µd
, 
qså_d©a
 *
ý
)

560 
u32
 
rg‘
 = 
µd
->
dd
->
hfi1_id
;

561 
»t
;

562 
æags
;

563 
u8
 *
ÿche
 = &
ý
->cache[0];

566 
	`mem£t
(
ÿche
, 0, (
QSFP_MAX_NUM_PAGES
 * 128));

567 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

568 
µd
->
qså_šfo
.
ÿche_v®id
 = 0;

569 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

571 ià(!
	`qså_mod_´e£Á
(
µd
)) {

572 
»t
 = -
ENODEV
;

573 
baž
;

576 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 0, 
ÿche
, 
QSFP_PAGESIZE
);

577 ià(
»t
 !ð
QSFP_PAGESIZE
) {

578 
	`dd_dev_šfo
(
µd
->
dd
,

580 
__func__
, 
QSFP_PAGESIZE
, 
»t
);

581 
baž
;

585 ià(!(
ÿche
[2] & 4)) {

587 ià((
ÿche
[195] & 0xC0) == 0xC0) {

589 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 384, 
ÿche
 + 256, 128);

590 ià(
»t
 <= 0 ||„et != 128) {

591 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

592 
baž
;

594 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 640, 
ÿche
 + 384, 128);

595 ià(
»t
 <= 0 ||„et != 128) {

596 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

597 
baž
;

599 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 896, 
ÿche
 + 512, 128);

600 ià(
»t
 <= 0 ||„et != 128) {

601 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

602 
baž
;

604 } ià((
ÿche
[195] & 0x80) == 0x80) {

606 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 640, 
ÿche
 + 384, 128);

607 ià(
»t
 <= 0 ||„et != 128) {

608 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

609 
baž
;

611 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 896, 
ÿche
 + 512, 128);

612 ià(
»t
 <= 0 ||„et != 128) {

613 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

614 
baž
;

616 } ià((
ÿche
[195] & 0x40) == 0x40) {

618 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 384, 
ÿche
 + 256, 128);

619 ià(
»t
 <= 0 ||„et != 128) {

620 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

621 
baž
;

623 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 896, 
ÿche
 + 512, 128);

624 ià(
»t
 <= 0 ||„et != 128) {

625 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

626 
baž
;

630 
»t
 = 
	`qså_»ad
(
µd
, 
rg‘
, 896, 
ÿche
 + 512, 128);

631 ià(
»t
 <= 0 ||„et != 128) {

632 
	`dd_dev_šfo
(
µd
->
dd
, "% çžed\n", 
__func__
);

633 
baž
;

638 
	`¥š_lock_œq§ve
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

639 
µd
->
qså_šfo
.
ÿche_v®id
 = 1;

640 
µd
->
qså_šfo
.
ÿche_»äesh_»quœed
 = 0;

641 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
qså_šfo
.
qså_lock
, 
æags
);

645 
baž
:

646 
	`mem£t
(
ÿche
, 0, (
QSFP_MAX_NUM_PAGES
 * 128));

647  
»t
;

648 
	}
}

650 cÚ¡ * cÚ¡ 
	ghfi1_qså_dev‹ch
[16] = {

657 
	#QSFP_DUMP_CHUNK
 16

	)

658 
	#QSFP_DEFAULT_HDR_CNT
 224

	)

660 
	#QSFP_PWR
(
pby‹
è((Õby‹è>> 6è& 3)

	)

661 
	#QSFP_HIGH_PWR
(
pby‹
è(Õby‹è& 3)

	)

663 
	#QSFP_HIGH_PWR_UNUSED
 0

	)

669 
	$g‘_qså_pow”_þass
(
u8
 
pow”_by‹
)

671 ià(
	`QSFP_HIGH_PWR
(
pow”_by‹
è=ð
QSFP_HIGH_PWR_UNUSED
)

673  (
	`QSFP_PWR
(
pow”_by‹
) + 1);

680  (
	`QSFP_HIGH_PWR
(
pow”_by‹
) + 4);

681 
	}
}

683 
	$qså_mod_´e£Á
(
hfi1_µÜtd©a
 *
µd
)

685 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

686 
u64
 
»g
;

688 
»g
 = 
	`»ad_c¤
(
dd
, dd->
hfi1_id
 ? 
ASIC_QSFP2_IN
 : 
ASIC_QSFP1_IN
);

689  !(
»g
 & 
QSFP_HFI0_MODPRST_N
);

690 
	}
}

707 
	$g‘_ÿbË_šfo
(
hfi1_devd©a
 *
dd
, 
u32
 
pÜt_num
, u32 
addr
, u32 
Ën
,

708 
u8
 *
d©a
)

710 
hfi1_µÜtd©a
 *
µd
;

711 
u32
 
exûss_Ën
 = 
Ën
;

712 
»t
 = 0, 
off£t
 = 0;

714 ià(
pÜt_num
 > 
dd
->
num_µÜts
 ||…ort_num < 1) {

715 
	`dd_dev_šfo
(
dd
, "%s: Invalid…ort‚umber %d\n",

716 
__func__
, 
pÜt_num
);

717 
»t
 = -
EINVAL
;

718 
£t_z”Ûs
;

721 
µd
 = 
dd
->
µÜt
 + (
pÜt_num
 - 1);

722 ià(!
	`qså_mod_´e£Á
(
µd
)) {

723 
»t
 = -
ENODEV
;

724 
£t_z”Ûs
;

727 ià(!
µd
->
qså_šfo
.
ÿche_v®id
) {

728 
»t
 = -
EINVAL
;

729 
£t_z”Ûs
;

732 ià(
addr
 >ð(
QSFP_MAX_NUM_PAGES
 * 128)) {

733 
»t
 = -
ERANGE
;

734 
£t_z”Ûs
;

737 ià((
addr
 + 
Ën
è> (
QSFP_MAX_NUM_PAGES
 * 128)) {

738 
exûss_Ën
 = (
addr
 + 
Ën
è- (
QSFP_MAX_NUM_PAGES
 * 128);

739 
	`memýy
(
d©a
, &
µd
->
qså_šfo
.
ÿche
[
addr
], (
Ën
 - 
exûss_Ën
));

740 
d©a
 +ð(
Ën
 - 
exûss_Ën
);

741 
£t_z”Ûs
;

744 
	`memýy
(
d©a
, &
µd
->
qså_šfo
.
ÿche
[
addr
], 
Ën
);

746 ià(
addr
 <ð
QSFP_MONITOR_VAL_END
 &&

747 (
addr
 + 
Ën
è>ð
QSFP_MONITOR_VAL_START
) {

749 ià(
addr
 < 
QSFP_MONITOR_VAL_START
) {

750 ià(
addr
 + 
Ën
 <ð
QSFP_MONITOR_VAL_END
)

751 
Ën
 = 
addr
 +†’ - 
QSFP_MONITOR_VAL_START
;

753 
Ën
 = 
QSFP_MONITOR_RANGE
;

754 
off£t
 = 
QSFP_MONITOR_VAL_START
 - 
addr
;

755 
addr
 = 
QSFP_MONITOR_VAL_START
;

756 } ià(
addr
 =ð
QSFP_MONITOR_VAL_START
) {

757 
off£t
 = 0;

758 ià(
addr
 + 
Ën
 > 
QSFP_MONITOR_VAL_END
)

759 
Ën
 = 
QSFP_MONITOR_RANGE
;

761 
off£t
 = 0;

762 ià(
addr
 + 
Ën
 > 
QSFP_MONITOR_VAL_END
)

763 
Ën
 = 
QSFP_MONITOR_VAL_END
 - 
addr
 + 1;

766 
»t
 = 
	`Úe_qså_»ad
(
µd
, 
dd
->
hfi1_id
, 
addr
, 
d©a
 + 
off£t
, 
Ën
);

767 ià(
»t
 !ð
Ën
) {

768 
»t
 = -
EAGAIN
;

769 
£t_z”Ûs
;

775 
£t_z”Ûs
:

776 
	`mem£t
(
d©a
, 0, 
exûss_Ën
);

777  
»t
;

778 
	}
}

780 cÚ¡ *
	gpwr_codes
[8] = {"N/AW",

790 
	$qså_dump
(
hfi1_µÜtd©a
 *
µd
, *
buf
, 
Ën
)

792 
u8
 *
ÿche
 = &
µd
->
qså_šfo
.cache[0];

793 
u8
 
bš_buff
[
QSFP_DUMP_CHUNK
];

794 
Ën¡r
[6];

795 
soçr
;

796 
bidx
 = 0;

797 
u8
 *
©‹n
 = &
ÿche
[
QSFP_ATTEN_OFFS
];

798 
u8
 *
v’dÜ_oui
 = &
ÿche
[
QSFP_VOUI_OFFS
];

799 
u8
 
pow”_by‹
 = 0;

801 
soçr
 = 0;

802 
Ën¡r
[0] = ' ';

803 
Ën¡r
[1] = '\0';

805 ià(
µd
->
qså_šfo
.
ÿche_v®id
) {

806 ià(
	`QSFP_IS_CU
(
ÿche
[
QSFP_MOD_TECH_OFFS
]))

807 
	`¢´štf
(
Ën¡r
, (lenstr), "%dM ",

808 
ÿche
[
QSFP_MOD_LEN_OFFS
]);

810 
pow”_by‹
 = 
ÿche
[
QSFP_MOD_PWR_OFFS
];

811 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "PWR:%.3sW\n",

812 
pwr_codes
[
	`g‘_qså_pow”_þass
(
pow”_by‹
)]);

814 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "TECH:%s%s\n",

815 
Ën¡r
,

816 
hfi1_qså_dev‹ch
[(
ÿche
[
QSFP_MOD_TECH_OFFS
]) >> 4]);

818 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Vendor:%.*s\n",

819 
QSFP_VEND_LEN
, &
ÿche
[
QSFP_VEND_OFFS
]);

821 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "OUI:%06X\n",

822 
	`QSFP_OUI
(
v’dÜ_oui
));

824 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Part#:%.*s\n",

825 
QSFP_PN_LEN
, &
ÿche
[
QSFP_PN_OFFS
]);

827 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Rev:%.*s\n",

828 
QSFP_REV_LEN
, &
ÿche
[
QSFP_REV_OFFS
]);

830 ià(
	`QSFP_IS_CU
(
ÿche
[
QSFP_MOD_TECH_OFFS
]))

831 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar,

833 
	`QSFP_ATTEN_SDR
(
©‹n
),

834 
	`QSFP_ATTEN_DDR
(
©‹n
));

836 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Serial:%.*s\n",

837 
QSFP_SN_LEN
, &
ÿche
[
QSFP_SN_OFFS
]);

839 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Date:%.*s\n",

840 
QSFP_DATE_LEN
, &
ÿche
[
QSFP_DATE_OFFS
]);

842 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "Lot:%.*s\n",

843 
QSFP_LOT_LEN
, &
ÿche
[
QSFP_LOT_OFFS
]);

845 
bidx
 < 
QSFP_DEFAULT_HDR_CNT
) {

846 
iidx
;

848 
	`memýy
(
bš_buff
, &
ÿche
[
bidx
], 
QSFP_DUMP_CHUNK
);

849 
iidx
 = 0; iidx < 
QSFP_DUMP_CHUNK
; ++iidx) {

850 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar,

851 " %02X", 
bš_buff
[
iidx
]);

853 
soçr
 +ð
	`sú´štf
(
buf
 + soçr, 
Ën
 - sofar, "\n");

854 
bidx
 +ð
QSFP_DUMP_CHUNK
;

857  
soçr
;

858 
	}
}

	@qsfp.h

49 
	#QSFP_DEV
 0xA0

	)

50 
	#QSFP_PWR_LAG_MSEC
 2000

	)

51 
	#QSFP_MODPRS_LAG_MSEC
 20

	)

53 
	#QSFP_MAX_NUM_PAGES
 5

	)

59 
	#QSFP_HFI0_I2CCLK
 
	`BIT
(0)

	)

60 
	#QSFP_HFI0_I2CDAT
 
	`BIT
(1)

	)

61 
	#QSFP_HFI0_RESET_N
 
	`BIT
(2)

	)

62 
	#QSFP_HFI0_INT_N
 
	`BIT
(3)

	)

63 
	#QSFP_HFI0_MODPRST_N
 
	`BIT
(4)

	)

66 
	#QSFP_PAGESIZE
 256

	)

68 
	#QSFP_RW_BOUNDARY
 128

	)

71 
	#__QSFP_OFFSET_SIZE
 1

	)

72 
	#QSFP_OFFSET_SIZE
 (
__QSFP_OFFSET_SIZE
 << 8è

	)

77 
	#QSFP_MONITOR_VAL_START
 22

	)

78 
	#QSFP_MONITOR_VAL_END
 81

	)

79 
	#QSFP_MONITOR_RANGE
 (
QSFP_MONITOR_VAL_END
 - 
QSFP_MONITOR_VAL_START
 + 1)

	)

80 
	#QSFP_TX_CTRL_BYTE_OFFS
 86

	)

81 
	#QSFP_PWR_CTRL_BYTE_OFFS
 93

	)

82 
	#QSFP_CDR_CTRL_BYTE_OFFS
 98

	)

84 
	#QSFP_PAGE_SELECT_BYTE_OFFS
 127

	)

86 
	#QSFP_MOD_ID_OFFS
 128

	)

92 
	#QSFP_MOD_PWR_OFFS
 129

	)

97 
	#QSFP_NOM_BIT_RATE_100_OFFS
 140

	)

101 
	#QSFP_MOD_LEN_OFFS
 146

	)

106 
	#QSFP_MOD_TECH_OFFS
 147

	)

107 cÚ¡ *cÚ¡ 
hfi1_qså_dev‹ch
[16];

109 
	#QSFP_IS_ACTIVE
(
‹ch
è((0xA2FF >> (Ñechè>> 4)è& 1)

	)

111 
	#QSFP_IS_ACTIVE_FAR
(
‹ch
è((0x32FF >> (Ñechè>> 4)è& 1)

	)

113 
	#QSFP_HAS_ATTEN
(
‹ch
è((0x4D00 >> (Ñechè>> 4)è& 1)

	)

115 
	#QSFP_IS_CU
(
‹ch
è((0xED00 >> (Ñechè>> 4)è& 1)

	)

116 
	#QSFP_TECH_1490
 9

	)

118 
	#QSFP_OUI
(
oui
) ((()oui[0] << 16) | (()oui[1] << 8) | \

119 
oui
[2])

	)

120 
	#QSFP_OUI_AMPHENOL
 0x415048

	)

121 
	#QSFP_OUI_FINISAR
 0x009065

	)

122 
	#QSFP_OUI_GORE
 0x002177

	)

125 
	#QSFP_VEND_OFFS
 148

	)

126 
	#QSFP_VEND_LEN
 16

	)

128 
	#QSFP_IBXCV_OFFS
 164

	)

130 
	#QSFP_VOUI_OFFS
 165

	)

131 
	#QSFP_VOUI_LEN
 3

	)

133 
	#QSFP_PN_OFFS
 168

	)

134 
	#QSFP_PN_LEN
 16

	)

136 
	#QSFP_REV_OFFS
 184

	)

137 
	#QSFP_REV_LEN
 2

	)

143 
	#QSFP_ATTEN_OFFS
 186

	)

144 
	#QSFP_ATTEN_LEN
 2

	)

150 
	#QSFP_CU_ATTEN_7G_OFFS
 188

	)

151 
	#QSFP_CU_ATTEN_12G_OFFS
 189

	)

154 
	#QSFP_CC_OFFS
 191

	)

155 
	#QSFP_EQ_INFO_OFFS
 193

	)

156 
	#QSFP_CDR_INFO_OFFS
 194

	)

158 
	#QSFP_SN_OFFS
 196

	)

159 
	#QSFP_SN_LEN
 16

	)

161 
	#QSFP_DATE_OFFS
 212

	)

162 
	#QSFP_DATE_LEN
 6

	)

164 
	#QSFP_LOT_OFFS
 218

	)

165 
	#QSFP_LOT_LEN
 2

	)

168 
	#QSFP_NOM_BIT_RATE_250_OFFS
 222

	)

170 
	#QSFP_CC_EXT_OFFS
 223

	)

175 
	#QSFP_DATA_NOT_READY
 0x01

	)

177 
	#QSFP_HIGH_TEMP_ALARM
 0x80

	)

178 
	#QSFP_LOW_TEMP_ALARM
 0x40

	)

179 
	#QSFP_HIGH_TEMP_WARNING
 0x20

	)

180 
	#QSFP_LOW_TEMP_WARNING
 0x10

	)

182 
	#QSFP_HIGH_VCC_ALARM
 0x80

	)

183 
	#QSFP_LOW_VCC_ALARM
 0x40

	)

184 
	#QSFP_HIGH_VCC_WARNING
 0x20

	)

185 
	#QSFP_LOW_VCC_WARNING
 0x10

	)

187 
	#QSFP_HIGH_POWER_ALARM
 0x88

	)

188 
	#QSFP_LOW_POWER_ALARM
 0x44

	)

189 
	#QSFP_HIGH_POWER_WARNING
 0x22

	)

190 
	#QSFP_LOW_POWER_WARNING
 0x11

	)

192 
	#QSFP_HIGH_BIAS_ALARM
 0x88

	)

193 
	#QSFP_LOW_BIAS_ALARM
 0x44

	)

194 
	#QSFP_HIGH_BIAS_WARNING
 0x22

	)

195 
	#QSFP_LOW_BIAS_WARNING
 0x11

	)

197 
	#QSFP_ATTEN_SDR
(
©‹Ç¼ay
è×‰’¬¿y[0])

	)

198 
	#QSFP_ATTEN_DDR
(
©‹Ç¼ay
è×‰’¬¿y[1])

	)

211 
	sqså_d©a
 {

213 
hfi1_µÜtd©a
 *
	mµd
;

214 
wÜk_¡ruù
 
	mqså_wÜk
;

215 
u8
 
	mÿche
[
QSFP_MAX_NUM_PAGES
 * 128];

217 
¥šlock_t
 
	mqså_lock
;

218 
u8
 
	mcheck_š‹¼u±_æags
;

219 
u8
 
	m»£t_Ãeded
;

220 
u8
 
	mlim™šg_aùive
;

221 
u8
 
	mÿche_v®id
;

222 
u8
 
	mÿche_»äesh_»quœed
;

225 
»äesh_qså_ÿche
(
hfi1_µÜtd©a
 *
µd
,

226 
qså_d©a
 *
ý
);

227 
g‘_qså_pow”_þass
(
u8
 
pow”_by‹
);

228 
qså_mod_´e£Á
(
hfi1_µÜtd©a
 *
µd
);

229 
g‘_ÿbË_šfo
(
hfi1_devd©a
 *
dd
, 
u32
 
pÜt_num
, u32 
addr
,

230 
u32
 
Ën
, 
u8
 *
d©a
);

232 
i2c_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
,

233 
off£t
, *
bp
, 
Ën
);

234 
i2c_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
i2c_addr
,

235 
off£t
, *
bp
, 
Ën
);

236 
qså_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

237 
Ën
);

238 
qså_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

239 
Ën
);

240 
Úe_qså_wr™e
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

241 
Ën
);

242 
Úe_qså_»ad
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
rg‘
, 
addr
, *
bp
,

243 
Ën
);

244 
	ghfi1_asic_d©a
;

245 
£t_up_i2c
(
hfi1_devd©a
 *
dd
, 
hfi1_asic_d©a
 *
ad
);

246 
þ—n_up_i2c
(
hfi1_devd©a
 *
dd
, 
hfi1_asic_d©a
 *
ad
);

	@rc.c

48 
	~<lšux/io.h
>

49 
	~<rdma/rdma_vt.h
>

50 
	~<rdma/rdmavt_qp.h
>

52 
	~"hfi.h
"

53 
	~"qp.h
"

54 
	~"rc.h
"

55 
	~"v”bs_tx»q.h
"

56 
	~"Œaû.h
"

69 
	$make_rc_ack
(
hfi1_ibdev
 *
dev
, 
rvt_qp
 *
qp
,

70 
ib_Ùh”_h—d”s
 *
ohdr
,

71 
hfi1_pkt_¡©e
 *
ps
)

73 
rvt_ack_’Œy
 *
e
;

74 
u32
 
hwÜds
, 
hd¾’
;

75 
u32
 
Ën
 = 0;

76 
u32
 
bth0
 = 0, 
bth2
 = 0;

77 
u32
 
bth1
 = 
qp
->
»mÙe_q²
 | (
	`HFI1_CAP_IS_KSET
(
OPFN
è<< 
IB_BTHE_E_SHIFT
);

78 
middË
 = 0;

79 
u32
 
pmtu
 = 
qp
->pmtu;

80 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

81 
tid_rdma_»que¡
 *
»q
;

82 
u8
 
Ãxt
 = 
qp
->
s_ž_ack_queue
;

83 
boÞ
 
Ï¡_pkt
;

84 
u32
 
d–
;

86 
	`Œaû_hfi1_r¥_make_rc_ack
(
qp
, 0);

87 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

89 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
))

90 
baž
;

92 ià(
q´iv
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_9B
)

94 
hwÜds
 = 5;

97 
hwÜds
 = 7;

99 
qp
->
s_ack_¡©e
) {

100 
	`OP
(
RDMA_READ_RESPONSE_LAST
):

101 
	`OP
(
RDMA_READ_RESPONSE_ONLY
):

102 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

103 
	`»Ëa£_rdma_sge_mr
(
e
);

105 
	`OP
(
ATOMIC_ACKNOWLEDGE
):

111 ià(++
Ãxt
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

112 
Ãxt
 = 0;

117 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

118 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
) &&

119 
qp
->
s_acked_ack_queue
 =ðqp->
s_ž_ack_queue
)

120 
qp
->
s_acked_ack_queue
 = 
Ãxt
;

121 
qp
->
s_ž_ack_queue
 = 
Ãxt
;

122 
	`Œaû_hfi1_r¥_make_rc_ack
(
qp
, 
e
->
p¢
);

124 
	`OP
(
SEND_ONLY
):

125 
	`OP
(
ACKNOWLEDGE
):

127 ià(
qp
->
r_h—d_ack_queue
 =ðqp->
s_ž_ack_queue
) {

128 ià(
qp
->
s_æags
 & 
RVT_S_ACK_PENDING
)

129 
nÜm®
;

130 
baž
;

133 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

135 ià((
q´iv
->
s_æags
 & 
HFI1_R_TID_WAIT_INTERLCK
) ||

136 
	`hfi1_tid_rdma_ack_š‹¾ock
(
qp
, 
e
)) {

137 
	`iowa™_£t_æag
(&
q´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
);

138 
baž
;

140 ià(
e
->
Ýcode
 =ð
	`OP
(
RDMA_READ_REQUEST
)) {

147 
Ën
 = 
e
->
rdma_sge
.
sge_Ëngth
;

148 ià(
Ën
 && !
e
->
rdma_sge
.
mr
) {

149 ià(
qp
->
s_acked_ack_queue
 ==

150 
qp
->
s_ž_ack_queue
)

151 
qp
->
s_acked_ack_queue
 =

152 
qp
->
r_h—d_ack_queue
;

153 
qp
->
s_ž_ack_queue
 = qp->
r_h—d_ack_queue
;

154 
baž
;

157 
ps
->
s_tx»q
->
mr
 = 
e
->
rdma_sge
.mr;

158 ià(
ps
->
s_tx»q
->
mr
)

159 
	`rvt_g‘_mr
(
ps
->
s_tx»q
->
mr
);

160 
qp
->
s_ack_rdma_sge
.
sge
 = 
e
->
rdma_sge
;

161 
qp
->
s_ack_rdma_sge
.
num_sge
 = 1;

162 
ps
->
s_tx»q
->
ss
 = &
qp
->
s_ack_rdma_sge
;

163 ià(
Ën
 > 
pmtu
) {

164 
Ën
 = 
pmtu
;

165 
qp
->
s_ack_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_FIRST
);

167 
qp
->
s_ack_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_ONLY
);

168 
e
->
£Á
 = 1;

170 
ohdr
->
u
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

171 
hwÜds
++;

172 
qp
->
s_ack_rdma_p¢
 = 
e
->
p¢
;

173 
bth2
 = 
	`mask_p¢
(
qp
->
s_ack_rdma_p¢
++);

174 } ià(
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
)) {

182 
»q
 = 
	`ack_to_tid_»q
(
e
);

183 ià(
»q
->
¡©e
 =ð
TID_REQUEST_RESEND
 ||

184 
»q
->
¡©e
 =ð
TID_REQUEST_INIT_RESEND
)

185 
baž
;

186 
qp
->
s_ack_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

187 
qp
->
s_ack_rdma_p¢
 = 
	`mask_p¢
(
e
->
p¢
 + 
»q
->
cur_£g
);

188 
wr™e_»¥
;

189 } ià(
e
->
Ýcode
 =ð
	`TID_OP
(
READ_REQ
)) {

196 
Ën
 = 
e
->
rdma_sge
.
sge_Ëngth
;

197 ià(
Ën
 && !
e
->
rdma_sge
.
mr
) {

198 ià(
qp
->
s_acked_ack_queue
 ==

199 
qp
->
s_ž_ack_queue
)

200 
qp
->
s_acked_ack_queue
 =

201 
qp
->
r_h—d_ack_queue
;

202 
qp
->
s_ž_ack_queue
 = qp->
r_h—d_ack_queue
;

203 
baž
;

206 
ps
->
s_tx»q
->
mr
 = 
e
->
rdma_sge
.mr;

207 ià(
ps
->
s_tx»q
->
mr
)

208 
	`rvt_g‘_mr
(
ps
->
s_tx»q
->
mr
);

209 
qp
->
s_ack_rdma_sge
.
sge
 = 
e
->
rdma_sge
;

210 
qp
->
s_ack_rdma_sge
.
num_sge
 = 1;

211 
qp
->
s_ack_¡©e
 = 
	`TID_OP
(
READ_RESP
);

212 
»ad_»¥
;

215 
ps
->
s_tx»q
->
ss
 = 
NULL
;

216 
Ën
 = 0;

217 
qp
->
s_ack_¡©e
 = 
	`OP
(
ATOMIC_ACKNOWLEDGE
);

218 
ohdr
->
u
.
©
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

219 
	`ib_u64_put
(
e
->
©omic_d©a
, &
ohdr
->
u
.
©
.
©omic_ack_‘h
);

220 
hwÜds
 +ð(
ohdr
->
u
.
©
è/ (
u32
);

221 
bth2
 = 
	`mask_p¢
(
e
->
p¢
);

222 
e
->
£Á
 = 1;

224 
	`Œaû_hfi1_tid_wr™e_r¥_make_rc_ack
(
qp
);

225 ià(!
bth0
)

226 
bth0
 = 
qp
->
s_ack_¡©e
 << 24;

229 
	`OP
(
RDMA_READ_RESPONSE_FIRST
):

230 
qp
->
s_ack_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
);

232 
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
):

233 
ps
->
s_tx»q
->
ss
 = &
qp
->
s_ack_rdma_sge
;

234 
ps
->
s_tx»q
->
mr
 = 
qp
->
s_ack_rdma_sge
.
sge
.mr;

235 ià(
ps
->
s_tx»q
->
mr
)

236 
	`rvt_g‘_mr
(
ps
->
s_tx»q
->
mr
);

237 
Ën
 = 
qp
->
s_ack_rdma_sge
.
sge
.
sge_Ëngth
;

238 ià(
Ën
 > 
pmtu
) {

239 
Ën
 = 
pmtu
;

240 
middË
 = 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
);

242 
ohdr
->
u
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

243 
hwÜds
++;

244 
qp
->
s_ack_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_LAST
);

245 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

246 
e
->
£Á
 = 1;

248 
bth0
 = 
qp
->
s_ack_¡©e
 << 24;

249 
bth2
 = 
	`mask_p¢
(
qp
->
s_ack_rdma_p¢
++);

252 
	`TID_OP
(
WRITE_RESP
):

253 
wr™e_»¥
:

273 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

274 
»q
 = 
	`ack_to_tid_»q
(
e
);

281 ià(
q´iv
->
ºr_Çk_¡©e
 =ð
TID_RNR_NAK_SEND
 &&

282 
qp
->
s_ž_ack_queue
 =ð
q´iv
->
r_tid_®loc
 &&

283 
»q
->
cur_£g
 =ð»q->
®loc_£g
) {

284 
q´iv
->
ºr_Çk_¡©e
 = 
TID_RNR_NAK_SENT
;

285 
nÜm®_no_¡©e
;

288 
bth2
 = 
	`mask_p¢
(
qp
->
s_ack_rdma_p¢
);

289 
hd¾’
 = 
	`hfi1_bužd_tid_rdma_wr™e_»¥
(
qp
, 
e
, 
ohdr
, &
bth1
,

290 
bth2
, &
Ën
,

291 &
ps
->
s_tx»q
->
ss
);

292 ià(!
hd¾’
)

295 
hwÜds
 +ð
hd¾’
;

296 
bth0
 = 
qp
->
s_ack_¡©e
 << 24;

297 
qp
->
s_ack_rdma_p¢
++;

298 
	`Œaû_hfi1_tid_»q_make_rc_ack_wr™e
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,

299 
e
->
Í¢
, 
»q
);

300 ià(
»q
->
cur_£g
 !ð»q->
tÙ®_£gs
)

303 
e
->
£Á
 = 1;

305 
qp
->
s_ack_¡©e
 = 
	`OP
(
ATOMIC_ACKNOWLEDGE
);

308 
	`TID_OP
(
READ_RESP
):

309 
»ad_»¥
:

310 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

311 
ps
->
s_tx»q
->
ss
 = &
qp
->
s_ack_rdma_sge
;

312 
d–
 = 
	`hfi1_bužd_tid_rdma_»ad_»¥
(
qp
, 
e
, 
ohdr
, &
bth0
,

313 &
bth1
, &
bth2
, &
Ën
,

314 &
Ï¡_pkt
);

315 ià(
d–
 == 0)

316 
”rÜ_qp
;

317 
hwÜds
 +ð
d–
;

318 ià(
Ï¡_pkt
) {

319 
e
->
£Á
 = 1;

324 
qp
->
s_ack_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_LAST
);

327 
	`TID_OP
(
READ_REQ
):

328 
baž
;

331 
nÜm®
:

332 
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

339 
qp
->
s_ack_¡©e
 = 
	`OP
(
SEND_ONLY
);

340 
nÜm®_no_¡©e
:

341 ià(
qp
->
s_Çk_¡©e
)

342 
ohdr
->
u
.
«th
 =

343 
	`ýu_to_be32
((
qp
->
r_m¢
 &

344 
IB_MSN_MASK
) |

345 (
qp
->
s_Çk_¡©e
 <<

346 
IB_AETH_CREDIT_SHIFT
));

348 
ohdr
->
u
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

349 
hwÜds
++;

350 
bth0
 = 
	`OP
(
ACKNOWLEDGE
) << 24;

351 
bth2
 = 
	`mask_p¢
(
qp
->
s_ack_p¢
);

352 
Ën
 = 0;

353 
qp
->
s_æags
 &ð~
RVT_S_ACK_PENDING
;

354 
ps
->
s_tx»q
->
tx»q
.
æags
 |ð
SDMA_TXREQ_F_VIP
;

355 
ps
->
s_tx»q
->
ss
 = 
NULL
;

357 
qp
->
s_rdma_ack_út
++;

358 
ps
->
s_tx»q
->
sde
 = 
q´iv
->
s_sde
;

359 
ps
->
s_tx»q
->
s_cur_size
 = 
Ën
;

360 
ps
->
s_tx»q
->
hdr_dwÜds
 = 
hwÜds
;

361 
	`hfi1_make_ruc_h—d”
(
qp
, 
ohdr
, 
bth0
, 
bth1
, 
bth2
, 
middË
, 
ps
);

363 
”rÜ_qp
:

364 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
->
æags
);

365 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
ps
->
æags
);

366 
	`¥š_lock
(&
qp
->
s_lock
);

367 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

368 
	`¥š_uÆock
(&
qp
->
s_lock
);

369 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
ps
->
æags
);

370 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
->
æags
);

371 
baž
:

372 
qp
->
s_ack_¡©e
 = 
	`OP
(
ACKNOWLEDGE
);

377 
	`smp_wmb
();

378 
qp
->
s_æags
 &ð~(
RVT_S_RESP_PENDING


379 | 
RVT_S_ACK_PENDING


380 | 
HFI1_S_AHG_VALID
);

382 
	}
}

392 
	$hfi1_make_rc_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
)

394 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

395 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

396 
ib_Ùh”_h—d”s
 *
ohdr
;

397 
rvt_sge_¡©e
 *
ss
 = 
NULL
;

398 
rvt_swqe
 *
wqe
;

399 
hfi1_swqe_´iv
 *
w´iv
;

400 
tid_rdma_»que¡
 *
»q
 = 
NULL
;

401 
tid_rdma_·¿ms
 *
»mÙe
;

403 
u32
 
hwÜds
 = 5;

404 
u32
 
Ën
 = 0;

405 
u32
 
bth0
 = 0, 
bth2
 = 0;

406 
u32
 
bth1
 = 
qp
->
»mÙe_q²
 | (
	`HFI1_CAP_IS_KSET
(
OPFN
è<< 
IB_BTHE_E_SHIFT
);

407 
u32
 
pmtu
 = 
qp
->pmtu;

408 
Ãw»q
;

409 
middË
 = 0;

410 
d–
;

411 
tid_rdma_æow
 *
æow
 = 
NULL
;

413 
	`Œaû_hfi1_£nd”_make_rc_»q
(
qp
);

414 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

415 
ps
->
s_tx»q
 = 
	`g‘_tx»q
Õs->
dev
, 
qp
);

416 ià(!
ps
->
s_tx»q
)

417 
baž_no_tx
;

419 ià(
´iv
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_9B
) {

421 
hwÜds
 = 5;

422 ià(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
)

423 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
l
.
Ùh
;

425 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
Ùh
;

428 
hwÜds
 = 7;

429 ià((
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
) &&

430 (
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
))))

431 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
l
.
Ùh
;

433 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
Ùh
;

437 ià((
qp
->
s_æags
 & 
RVT_S_RESP_PENDING
) &&

438 
	`make_rc_ack
(
dev
, 
qp
, 
ohdr
, 
ps
))

441 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_SEND_OK
)) {

442 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_FLUSH_SEND
))

443 
baž
;

445 ià(
qp
->
s_Ï¡
 =ð
	`READ_ONCE
(qp->
s_h—d
))

446 
baž
;

448 ià(
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
)) {

449 
qp
->
s_æags
 |ð
RVT_S_WAIT_DMA
;

450 
baž
;

452 
	`þ—r_ahg
(
qp
);

453 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_Ï¡
);

454 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
, qp->
s_Ï¡
 !ðqp->
s_acked
 ?

455 
IB_WC_SUCCESS
 : 
IB_WC_WR_FLUSH_ERR
);

457 
dÚe_ä“_tx
;

460 ià(
qp
->
s_æags
 & (
RVT_S_WAIT_RNR
 | 
RVT_S_WAIT_ACK
 | 
HFI1_S_WAIT_HALT
))

461 
baž
;

463 ià(
	`cmp_p¢
(
qp
->
s_p¢
, qp->
s_£ndšg_hp¢
) <= 0) {

464 ià(
	`cmp_p¢
(
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
) <= 0) {

465 
qp
->
s_æags
 |ð
RVT_S_WAIT_PSN
;

466 
baž
;

468 
qp
->
s_£ndšg_p¢
 = qp->
s_p¢
;

469 
qp
->
s_£ndšg_hp¢
 = qp->
s_p¢
 - 1;

473 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_cur
);

474 
check_s_¡©e
:

475 
qp
->
s_¡©e
) {

477 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_NEXT_SEND_OK
))

478 
baž
;

486 
Ãw»q
 = 0;

487 ià(
qp
->
s_cur
 =ðqp->
s_ž
) {

489 ià(
qp
->
s_ž
 =ð
	`READ_ONCE
(qp->
s_h—d
)) {

490 
	`þ—r_ahg
(
qp
);

491 
baž
;

499 ià((
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_FENCE
) &&

500 
qp
->
s_num_rd_©omic
 &&

501 (
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
 ||

502 
´iv
->
³ndšg_tid_r_£gs
 < 
qp
->
s_num_rd_©omic
)) {

503 
qp
->
s_æags
 |ð
RVT_S_WAIT_FENCE
;

504 
baž
;

510 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_REG_MR
 ||

511 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_LOCAL_INV
) {

512 
loÿl_Ýs
 = 0;

513 
”r
 = 0;

515 ià(
qp
->
s_Ï¡
 !ðqp->
s_cur
)

516 
baž
;

517 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

518 
qp
->
s_cur
 = 0;

519 ià(++
qp
->
s_ž
 =ðqp->
s_size
)

520 
qp
->
s_ž
 = 0;

521 ià(!(
wqe
->
wr
.
£nd_æags
 &

522 
RVT_SEND_COMPLETION_ONLY
)) {

523 
”r
 = 
	`rvt_šv®id©e_rkey
(

524 
qp
,

525 
wqe
->
wr
.
ex
.
šv®id©e_rkey
);

526 
loÿl_Ýs
 = 1;

528 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
,

529 
”r
 ? 
IB_WC_LOC_PROT_ERR


530 : 
IB_WC_SUCCESS
);

531 ià(
loÿl_Ýs
)

532 
	`©omic_dec
(&
qp
->
loÿl_Ýs_³ndšg
);

533 
dÚe_ä“_tx
;

536 
Ãw»q
 = 1;

537 
qp
->
s_p¢
 = 
wqe
->
p¢
;

544 
Ën
 = 
wqe
->
Ëngth
;

545 
ss
 = &
qp
->
s_sge
;

546 
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
);

552 ià((
´iv
->
s_æags
 & 
HFI1_S_TID_WAIT_INTERLCK
) ||

553 
	`hfi1_tid_rdma_wqe_š‹¾ock
(
qp
, 
wqe
))

554 
baž
;

556 
wqe
->
wr
.
Ýcode
) {

557 
IB_WR_SEND
:

558 
IB_WR_SEND_WITH_IMM
:

559 
IB_WR_SEND_WITH_INV
:

561 ià(!(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
) &&

562 
	`rvt_cmp_m¢
(
wqe
->
s¢
, 
qp
->
s_l¢
 + 1) > 0) {

563 
qp
->
s_æags
 |ð
RVT_S_WAIT_SSN_CREDIT
;

564 
baž
;

566 ià(
Ën
 > 
pmtu
) {

567 
qp
->
s_¡©e
 = 
	`OP
(
SEND_FIRST
);

568 
Ën
 = 
pmtu
;

571 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND
) {

572 
qp
->
s_¡©e
 = 
	`OP
(
SEND_ONLY
);

573 } ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
) {

574 
qp
->
s_¡©e
 = 
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
);

576 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

577 
hwÜds
 += 1;

579 
qp
->
s_¡©e
 = 
	`OP
(
SEND_ONLY_WITH_INVALIDATE
);

581 
ohdr
->
u
.
›th
 = 
	`ýu_to_be32
(

582 
wqe
->
wr
.
ex
.
šv®id©e_rkey
);

583 
hwÜds
 += 1;

585 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

586 
bth0
 |ð
IB_BTH_SOLICITED
;

587 
bth2
 |ð
IB_BTH_REQ_ACK
;

588 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

589 
qp
->
s_cur
 = 0;

592 
IB_WR_RDMA_WRITE
:

593 ià(
Ãw»q
 && !(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
))

594 
qp
->
s_l¢
++;

595 
no_æow_cÚŒÞ
;

596 
IB_WR_RDMA_WRITE_WITH_IMM
:

598 ià(!(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
) &&

599 
	`rvt_cmp_m¢
(
wqe
->
s¢
, 
qp
->
s_l¢
 + 1) > 0) {

600 
qp
->
s_æags
 |ð
RVT_S_WAIT_SSN_CREDIT
;

601 
baž
;

603 
no_æow_cÚŒÞ
:

604 
	`put_ib_»th_vaddr
(

605 
wqe
->
rdma_wr
.
»mÙe_addr
,

606 &
ohdr
->
u
.
rc
.
»th
);

607 
ohdr
->
u
.
rc
.
»th
.
rkey
 =

608 
	`ýu_to_be32
(
wqe
->
rdma_wr
.
rkey
);

609 
ohdr
->
u
.
rc
.
»th
.
Ëngth
 = 
	`ýu_to_be32
(
Ën
);

610 
hwÜds
 +ð(
ib_»th
è/ (
u32
);

611 ià(
Ën
 > 
pmtu
) {

612 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_FIRST
);

613 
Ën
 = 
pmtu
;

616 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) {

617 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_ONLY
);

619 
qp
->
s_¡©e
 =

620 
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
);

622 
ohdr
->
u
.
rc
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

623 
hwÜds
 += 1;

624 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

625 
bth0
 |ð
IB_BTH_SOLICITED
;

627 
bth2
 |ð
IB_BTH_REQ_ACK
;

628 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

629 
qp
->
s_cur
 = 0;

632 
IB_WR_TID_RDMA_WRITE
:

633 ià(
Ãw»q
) {

637 ià(
	`©omic_»ad
(&
´iv
->
n_tid_»que¡s
) >=

638 
HFI1_TID_RDMA_WRITE_CNT
)

639 
baž
;

641 ià(!(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
))

642 
qp
->
s_l¢
++;

645 
hwÜds
 +ð
	`hfi1_bužd_tid_rdma_wr™e_»q
(
qp
, 
wqe
, 
ohdr
,

646 &
bth1
, &
bth2
,

647 &
Ën
);

648 
ss
 = 
NULL
;

649 ià(
´iv
->
s_tid_cur
 =ð
HFI1_QP_WQE_INVALID
) {

650 
´iv
->
s_tid_cur
 = 
qp
->
s_cur
;

651 ià(
´iv
->
s_tid_ž
 =ð
HFI1_QP_WQE_INVALID
) {

652 
´iv
->
s_tid_ž
 = 
qp
->
s_cur
;

653 
´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

655 } ià(
´iv
->
s_tid_cur
 =ð´iv->
s_tid_h—d
) {

656 
rvt_swqe
 *
__w
;

657 
tid_rdma_»que¡
 *
__r
;

659 
__w
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
´iv
->
s_tid_cur
);

660 
__r
 = 
	`wqe_to_tid_»q
(
__w
);

682 ià(
__w
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
 ||

683 
__r
->
¡©e
 =ð
TID_REQUEST_INACTIVE
 ||

684 
__r
->
¡©e
 =ð
TID_REQUEST_COMPLETE
 ||

685 ((
__r
->
¡©e
 =ð
TID_REQUEST_ACTIVE
 ||

686 
__r
->
¡©e
 =ð
TID_REQUEST_SYNC
) &&

687 
__r
->
comp_£g
 =ð__r->
tÙ®_£gs
)) {

688 ià(
´iv
->
s_tid_ž
 ==

689 
´iv
->
s_tid_cur
 &&

690 
´iv
->
s_¡©e
 ==

691 
	`TID_OP
(
WRITE_DATA_LAST
)) {

692 
´iv
->
s_tid_ž
 = 
qp
->
s_cur
;

693 
´iv
->
s_¡©e
 =

694 
	`TID_OP
(
WRITE_RESP
);

696 
´iv
->
s_tid_cur
 = 
qp
->
s_cur
;

708 ià(
´iv
->
s_tid_ž
 =ð
qp
->
s_cur
 &&

709 
´iv
->
s_¡©e
 =ð
	`TID_OP
(
WRITE_DATA_LAST
))

710 
´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

712 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

713 ià(
Ãw»q
) {

714 
´iv
->
s_tid_h—d
 = 
qp
->
s_cur
;

715 
´iv
->
³ndšg_tid_w_»¥
 +ð
»q
->
tÙ®_£gs
;

716 
	`©omic_šc
(&
´iv
->
n_tid_»que¡s
);

717 
	`©omic_dec
(&
´iv
->
n_»que¡s
);

719 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

720 
»q
->
comp_£g
 = 
	`d–_p¢
(
bth2
, 
wqe
->
p¢
);

725 
»q
->
£tup_h—d
 =„eq->
þ—r_ž
;

726 
´iv
->
³ndšg_tid_w_»¥
 +=

727 
	`d–_p¢
(
wqe
->
Í¢
, 
bth2
) + 1;

730 
	`Œaû_hfi1_tid_wr™e_£nd”_make_»q
(
qp
, 
Ãw»q
);

731 
	`Œaû_hfi1_tid_»q_make_»q_wr™e
(
qp
, 
Ãw»q
,

732 
wqe
->
wr
.
Ýcode
,

733 
wqe
->
p¢
, wqe->
Í¢
,

734 
»q
);

735 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

736 
qp
->
s_cur
 = 0;

739 
IB_WR_RDMA_READ
:

744 ià(
qp
->
s_num_rd_©omic
 >=

745 
qp
->
s_max_rd_©omic
) {

746 
qp
->
s_æags
 |ð
RVT_S_WAIT_RDMAR
;

747 
baž
;

749 
qp
->
s_num_rd_©omic
++;

750 ià(
Ãw»q
 && !(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
))

751 
qp
->
s_l¢
++;

752 
	`put_ib_»th_vaddr
(

753 
wqe
->
rdma_wr
.
»mÙe_addr
,

754 &
ohdr
->
u
.
rc
.
»th
);

755 
ohdr
->
u
.
rc
.
»th
.
rkey
 =

756 
	`ýu_to_be32
(
wqe
->
rdma_wr
.
rkey
);

757 
ohdr
->
u
.
rc
.
»th
.
Ëngth
 = 
	`ýu_to_be32
(
Ën
);

758 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_REQUEST
);

759 
hwÜds
 +ð(
ohdr
->
u
.
rc
.
»th
è/ (
u32
);

760 
ss
 = 
NULL
;

761 
Ën
 = 0;

762 
bth2
 |ð
IB_BTH_REQ_ACK
;

763 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

764 
qp
->
s_cur
 = 0;

767 
IB_WR_TID_RDMA_READ
:

768 
	`Œaû_hfi1_tid_»ad_£nd”_make_»q
(
qp
, 
Ãw»q
);

769 
w´iv
 = 
wqe
->
´iv
;

770 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

771 
	`Œaû_hfi1_tid_»q_make_»q_»ad
(
qp
, 
Ãw»q
,

772 
wqe
->
wr
.
Ýcode
,

773 
wqe
->
p¢
, wqe->
Í¢
,

774 
»q
);

775 
d–
 = 
	`cmp_p¢
(
qp
->
s_p¢
, 
wqe
->
p¢
);

787 ià(
qp
->
s_num_rd_©omic
 >ðqp->
s_max_rd_©omic
) {

788 
qp
->
s_æags
 |ð
RVT_S_WAIT_RDMAR
;

789 
baž
;

791 ià(
Ãw»q
) {

792 
tid_rdma_æow
 *
æow
 =

793 &
»q
->
æows
[»q->
£tup_h—d
];

801 ià(!
æow
->
Åage£ts
) {

802 
qp
->
s_sge
.
sge
 = 
wqe
->
sg_li¡
[0];

803 
qp
->
s_sge
.
sg_li¡
 = 
wqe
->sg_list + 1;

804 
qp
->
s_sge
.
num_sge
 = 
wqe
->
wr
.num_sge;

805 
qp
->
s_sge
.
tÙ®_Ën
 = 
wqe
->
Ëngth
;

806 
qp
->
s_Ën
 = 
wqe
->
Ëngth
;

807 
»q
->
isge
 = 0;

808 
»q
->
þ—r_ž
 =„eq->
£tup_h—d
;

809 
»q
->
æow_idx
 =„eq->
£tup_h—d
;

810 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

812 } ià(
d–
 == 0) {

814 
»q
->
cur_£g
 = 0;

815 
»q
->
comp_£g
 = 0;

816 
»q
->
ack_³ndšg
 = 0;

817 
»q
->
æow_idx
 =„eq->
þ—r_ž
;

818 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

820 
»q
->
s_Ãxt_p¢
 = 
qp
->
s_p¢
;

822 
Ën
 = 
	`mš_t
(
u32
, 
»q
->
£g_Ën
,

823 
wqe
->
Ëngth
 - 
»q
->
£g_Ën
 *„eq->
cur_£g
);

824 
d–
 = 
	`hfi1_bužd_tid_rdma_»ad_»q
(
qp
, 
wqe
, 
ohdr
,

825 &
bth1
, &
bth2
,

826 &
Ën
);

827 ià(
d–
 <= 0) {

829 
baž
;

831 ià(
Ãw»q
 && !(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
))

832 
qp
->
s_l¢
++;

833 
hwÜds
 +ð
d–
;

834 
ss
 = &
w´iv
->ss;

836 ià(
»q
->
cur_£g
 >ð»q->
tÙ®_£gs
 &&

837 ++
qp
->
s_cur
 =ðqp->
s_size
)

838 
qp
->
s_cur
 = 0;

841 
IB_WR_ATOMIC_CMP_AND_SWP
:

842 
IB_WR_ATOMIC_FETCH_AND_ADD
:

847 ià(
qp
->
s_num_rd_©omic
 >=

848 
qp
->
s_max_rd_©omic
) {

849 
qp
->
s_æags
 |ð
RVT_S_WAIT_RDMAR
;

850 
baž
;

852 
qp
->
s_num_rd_©omic
++;

855 
IB_WR_OPFN
:

856 ià(
Ãw»q
 && !(
qp
->
s_æags
 & 
RVT_S_UNLIMITED_CREDIT
))

857 
qp
->
s_l¢
++;

858 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

859 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_OPFN
) {

860 
qp
->
s_¡©e
 = 
	`OP
(
COMPARE_SWAP
);

861 
	`put_ib_©‘h_sw­
(
wqe
->
©omic_wr
.
sw­
,

862 &
ohdr
->
u
.
©omic_‘h
);

863 
	`put_ib_©‘h_com·»
(
wqe
->
©omic_wr
.
com·»_add
,

864 &
ohdr
->
u
.
©omic_‘h
);

866 
qp
->
s_¡©e
 = 
	`OP
(
FETCH_ADD
);

867 
	`put_ib_©‘h_sw­
(
wqe
->
©omic_wr
.
com·»_add
,

868 &
ohdr
->
u
.
©omic_‘h
);

869 
	`put_ib_©‘h_com·»
(0, &
ohdr
->
u
.
©omic_‘h
);

871 
	`put_ib_©‘h_vaddr
(
wqe
->
©omic_wr
.
»mÙe_addr
,

872 &
ohdr
->
u
.
©omic_‘h
);

873 
ohdr
->
u
.
©omic_‘h
.
rkey
 = 
	`ýu_to_be32
(

874 
wqe
->
©omic_wr
.
rkey
);

875 
hwÜds
 +ð(
ib_©omic_‘h
è/ (
u32
);

876 
ss
 = 
NULL
;

877 
Ën
 = 0;

878 
bth2
 |ð
IB_BTH_REQ_ACK
;

879 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

880 
qp
->
s_cur
 = 0;

884 
baž
;

886 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
) {

887 
qp
->
s_sge
.
sge
 = 
wqe
->
sg_li¡
[0];

888 
qp
->
s_sge
.
sg_li¡
 = 
wqe
->sg_list + 1;

889 
qp
->
s_sge
.
num_sge
 = 
wqe
->
wr
.num_sge;

890 
qp
->
s_sge
.
tÙ®_Ën
 = 
wqe
->
Ëngth
;

891 
qp
->
s_Ën
 = 
wqe
->
Ëngth
;

893 ià(
Ãw»q
) {

894 
qp
->
s_ž
++;

895 ià(
qp
->
s_ž
 >ðqp->
s_size
)

896 
qp
->
s_ž
 = 0;

898 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

899 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
)

900 
qp
->
s_p¢
 = 
wqe
->
Í¢
 + 1;

901 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
)

902 
qp
->
s_p¢
 = 
»q
->
s_Ãxt_p¢
;

904 
qp
->
s_p¢
++;

907 
	`OP
(
RDMA_READ_RESPONSE_FIRST
):

917 
qp
->
s_Ën
 = 
	`»¡¬t_sge
(&qp->
s_sge
, 
wqe
, qp->
s_p¢
, 
pmtu
);

919 
	`OP
(
SEND_FIRST
):

920 
qp
->
s_¡©e
 = 
	`OP
(
SEND_MIDDLE
);

922 
	`OP
(
SEND_MIDDLE
):

923 
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
++);

924 
ss
 = &
qp
->
s_sge
;

925 
Ën
 = 
qp
->
s_Ën
;

926 ià(
Ën
 > 
pmtu
) {

927 
Ën
 = 
pmtu
;

928 
middË
 = 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
);

931 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND
) {

932 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

933 } ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
) {

934 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST_WITH_IMMEDIATE
);

936 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

937 
hwÜds
 += 1;

939 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST_WITH_INVALIDATE
);

941 
ohdr
->
u
.
›th
 = 
	`ýu_to_be32
(
wqe
->
wr
.
ex
.
šv®id©e_rkey
);

942 
hwÜds
 += 1;

944 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

945 
bth0
 |ð
IB_BTH_SOLICITED
;

946 
bth2
 |ð
IB_BTH_REQ_ACK
;

947 
qp
->
s_cur
++;

948 ià(
qp
->
s_cur
 >ðqp->
s_size
)

949 
qp
->
s_cur
 = 0;

952 
	`OP
(
RDMA_READ_RESPONSE_LAST
):

962 
qp
->
s_Ën
 = 
	`»¡¬t_sge
(&qp->
s_sge
, 
wqe
, qp->
s_p¢
, 
pmtu
);

964 
	`OP
(
RDMA_WRITE_FIRST
):

965 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_MIDDLE
);

967 
	`OP
(
RDMA_WRITE_MIDDLE
):

968 
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
++);

969 
ss
 = &
qp
->
s_sge
;

970 
Ën
 = 
qp
->
s_Ën
;

971 ià(
Ën
 > 
pmtu
) {

972 
Ën
 = 
pmtu
;

973 
middË
 = 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
);

976 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) {

977 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_LAST
);

979 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
);

981 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

982 
hwÜds
 += 1;

983 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

984 
bth0
 |ð
IB_BTH_SOLICITED
;

986 
bth2
 |ð
IB_BTH_REQ_ACK
;

987 
qp
->
s_cur
++;

988 ià(
qp
->
s_cur
 >ðqp->
s_size
)

989 
qp
->
s_cur
 = 0;

992 
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
):

1002 
Ën
 = (
	`d–_p¢
(
qp
->
s_p¢
, 
wqe
->
p¢
)è* 
pmtu
;

1003 
	`put_ib_»th_vaddr
(

1004 
wqe
->
rdma_wr
.
»mÙe_addr
 + 
Ën
,

1005 &
ohdr
->
u
.
rc
.
»th
);

1006 
ohdr
->
u
.
rc
.
»th
.
rkey
 =

1007 
	`ýu_to_be32
(
wqe
->
rdma_wr
.
rkey
);

1008 
ohdr
->
u
.
rc
.
»th
.
Ëngth
 = 
	`ýu_to_be32
(
wqe
->Ëngth - 
Ën
);

1009 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_REQUEST
);

1010 
hwÜds
 +ð(
ohdr
->
u
.
rc
.
»th
è/ (
u32
);

1011 
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
è| 
IB_BTH_REQ_ACK
;

1012 
qp
->
s_p¢
 = 
wqe
->
Í¢
 + 1;

1013 
ss
 = 
NULL
;

1014 
Ën
 = 0;

1015 
qp
->
s_cur
++;

1016 ià(
qp
->
s_cur
 =ðqp->
s_size
)

1017 
qp
->
s_cur
 = 0;

1020 
	`TID_OP
(
WRITE_RESP
):

1026 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1027 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

1028 
	`rcu_»ad_lock
();

1029 
»mÙe
 = 
	`rcu_d”eã»nû
(
´iv
->
tid_rdma
.remote);

1030 
»q
->
comp_£g
 = 
	`d–_p¢
(
qp
->
s_p¢
, 
wqe
->
p¢
);

1031 
Ën
 = 
wqe
->
Ëngth
 - (
»q
->
comp_£g
 * 
»mÙe
->
max_Ën
);

1032 
	`rcu_»ad_uÆock
();

1034 
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
);

1035 
hwÜds
 +ð
	`hfi1_bužd_tid_rdma_wr™e_»q
(
qp
, 
wqe
, 
ohdr
, &
bth1
,

1036 &
bth2
, &
Ën
);

1037 
qp
->
s_p¢
 = 
wqe
->
Í¢
 + 1;

1038 
ss
 = 
NULL
;

1039 
qp
->
s_¡©e
 = 
	`TID_OP
(
WRITE_REQ
);

1040 
´iv
->
³ndšg_tid_w_»¥
 +ð
	`d–_p¢
(
wqe
->
Í¢
, 
bth2
) + 1;

1041 
´iv
->
s_tid_cur
 = 
qp
->
s_cur
;

1042 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

1043 
qp
->
s_cur
 = 0;

1044 
	`Œaû_hfi1_tid_»q_make_»q_wr™e
(
qp
, 0, 
wqe
->
wr
.
Ýcode
,

1045 
wqe
->
p¢
, wqe->
Í¢
, 
»q
);

1048 
	`TID_OP
(
READ_RESP
):

1049 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
)

1050 
baž
;

1052 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1053 
w´iv
 = 
wqe
->
´iv
;

1059 
»q
->
cur_£g
 = 
	`d–_p¢
(
qp
->
s_p¢
, 
wqe
->
p¢
è/ 
´iv
->
pkts_ps
;

1067 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

1068 
	`hfi1_tid_rdma_»¡¬t_»q
(
qp
, 
wqe
, &
bth2
);

1069 ià(
»q
->
¡©e
 !ð
TID_REQUEST_ACTIVE
) {

1074 
	`hfi1_k”n_exp_rcv_þ—r_®l
(
»q
);

1075 
	`hfi1_k”n_þ—r_hw_æow
(
´iv
->
rcd
, 
qp
);

1076 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_LOC_QP_OP_ERR
);

1077 
baž
;

1079 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

1080 
Ën
 = 
	`mš_t
(
u32
, 
»q
->
£g_Ën
,

1081 
wqe
->
Ëngth
 - 
»q
->
£g_Ën
 *„eq->
cur_£g
);

1082 
æow
 = &
»q
->
æows
[»q->
æow_idx
];

1083 
Ën
 -ð
æow
->
£Á
;

1084 
»q
->
s_Ãxt_p¢
 = 
æow
->
æow_¡©e
.
ib_Í¢
 + 1;

1085 
d–
 = 
	`hfi1_bužd_tid_rdma_»ad_·ck‘
(
wqe
, 
ohdr
, &
bth1
,

1086 &
bth2
, &
Ën
);

1087 ià(
d–
 <= 0) {

1089 
baž
;

1091 
hwÜds
 +ð
d–
;

1092 
ss
 = &
w´iv
->ss;

1094 ià(
»q
->
cur_£g
 >ð»q->
tÙ®_£gs
 &&

1095 ++
qp
->
s_cur
 =ðqp->
s_size
)

1096 
qp
->
s_cur
 = 0;

1097 
qp
->
s_p¢
 = 
»q
->
s_Ãxt_p¢
;

1098 
	`Œaû_hfi1_tid_»q_make_»q_»ad
(
qp
, 0, 
wqe
->
wr
.
Ýcode
,

1099 
wqe
->
p¢
, wqe->
Í¢
, 
»q
);

1101 
	`TID_OP
(
READ_REQ
):

1102 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1103 
d–
 = 
	`cmp_p¢
(
qp
->
s_p¢
, 
wqe
->
p¢
);

1109 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
 || 
d–
 == 0 ||

1110 
qp
->
s_cur
 =ðqp->
s_ž
) {

1111 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_REQUEST
);

1112 ià(
d–
 =ð0 || 
qp
->
s_cur
 =ðqp->
s_ž
)

1113 
check_s_¡©e
;

1115 
baž
;

1119 ià(
qp
->
s_num_rd_©omic
 >ðqp->
s_max_rd_©omic
) {

1120 
qp
->
s_æags
 |ð
RVT_S_WAIT_RDMAR
;

1121 
baž
;

1124 
w´iv
 = 
wqe
->
´iv
;

1126 
Ën
 = 
	`mš_t
(
u32
, 
»q
->
£g_Ën
,

1127 
wqe
->
Ëngth
 - 
»q
->
£g_Ën
 *„eq->
cur_£g
);

1128 
d–
 = 
	`hfi1_bužd_tid_rdma_»ad_»q
(
qp
, 
wqe
, 
ohdr
, &
bth1
,

1129 &
bth2
, &
Ën
);

1130 ià(
d–
 <= 0) {

1132 
baž
;

1134 
hwÜds
 +ð
d–
;

1135 
ss
 = &
w´iv
->ss;

1137 ià(
»q
->
cur_£g
 >ð»q->
tÙ®_£gs
 &&

1138 ++
qp
->
s_cur
 =ðqp->
s_size
)

1139 
qp
->
s_cur
 = 0;

1140 
qp
->
s_p¢
 = 
»q
->
s_Ãxt_p¢
;

1141 
	`Œaû_hfi1_tid_»q_make_»q_»ad
(
qp
, 0, 
wqe
->
wr
.
Ýcode
,

1142 
wqe
->
p¢
, wqe->
Í¢
, 
»q
);

1145 
qp
->
s_£ndšg_hp¢
 = 
bth2
;

1146 
d–
 = 
	`d–_p¢
(
bth2
, 
wqe
->
p¢
);

1147 ià(
d–
 && d– % 
HFI1_PSN_CREDIT
 == 0 &&

1148 
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
)

1149 
bth2
 |ð
IB_BTH_REQ_ACK
;

1150 ià(
qp
->
s_æags
 & 
RVT_S_SEND_ONE
) {

1151 
qp
->
s_æags
 &ð~
RVT_S_SEND_ONE
;

1152 
qp
->
s_æags
 |ð
RVT_S_WAIT_ACK
;

1153 
bth2
 |ð
IB_BTH_REQ_ACK
;

1155 
qp
->
s_Ën
 -ð
Ën
;

1156 
ps
->
s_tx»q
->
hdr_dwÜds
 = 
hwÜds
;

1157 
ps
->
s_tx»q
->
sde
 = 
´iv
->
s_sde
;

1158 
ps
->
s_tx»q
->
ss
 = ss;

1159 
ps
->
s_tx»q
->
s_cur_size
 = 
Ën
;

1160 
	`hfi1_make_ruc_h—d”
(

1161 
qp
,

1162 
ohdr
,

1163 
bth0
 | (
qp
->
s_¡©e
 << 24),

1164 
bth1
,

1165 
bth2
,

1166 
middË
,

1167 
ps
);

1170 
dÚe_ä“_tx
:

1171 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

1172 
ps
->
s_tx»q
 = 
NULL
;

1175 
baž
:

1176 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

1178 
baž_no_tx
:

1179 
ps
->
s_tx»q
 = 
NULL
;

1180 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

1188 
	`iowa™_£t_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
);

1190 
	}
}

1192 
šlše
 
	$hfi1_make_bth_«th
(
rvt_qp
 *
qp
,

1193 
ib_Ùh”_h—d”s
 *
ohdr
,

1194 
u32
 
bth0
, u32 
bth1
)

1196 ià(
qp
->
r_Çk_¡©e
)

1197 
ohdr
->
u
.
«th
 = 
	`ýu_to_be32
((
qp
->
r_m¢
 & 
IB_MSN_MASK
) |

1198 (
qp
->
r_Çk_¡©e
 <<

1199 
IB_AETH_CREDIT_SHIFT
));

1201 
ohdr
->
u
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

1203 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

1204 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
bth1
 | 
qp
->
»mÙe_q²
);

1205 
ohdr
->
bth
[2] = 
	`ýu_to_be32
(
	`mask_p¢
(
qp
->
r_ack_p¢
));

1206 
	}
}

1208 
šlše
 
	$hfi1_queue_rc_ack
(
hfi1_·ck‘
 *
·ck‘
, 
boÞ
 
is_ãú
)

1210 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

1211 
hfi1_ibpÜt
 *
ibp
;

1212 
æags
;

1214 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

1215 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
))

1216 
uÆock
;

1217 
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

1218 
	`this_ýu_šc
(*
ibp
->
rvp
.
rc_qacks
);

1219 
qp
->
s_æags
 |ð
RVT_S_ACK_PENDING
 | 
RVT_S_RESP_PENDING
;

1220 
qp
->
s_Çk_¡©e
 = qp->
r_Çk_¡©e
;

1221 
qp
->
s_ack_p¢
 = qp->
r_ack_p¢
;

1222 ià(
is_ãú
)

1223 
qp
->
s_æags
 |ð
RVT_S_ECN
;

1226 
	`hfi1_scheduË_£nd
(
qp
);

1227 
uÆock
:

1228 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

1229 
	}
}

1231 
šlše
 
	$hfi1_make_rc_ack_9B
(
hfi1_·ck‘
 *
·ck‘
,

1232 
hfi1_Ýa_h—d”
 *
Ýa_hdr
,

1233 
u8
 
sc5
, 
boÞ
 
is_ãú
,

1234 
u64
 *
pbc_æags
, 
u32
 *
hwÜds
,

1235 
u32
 *
nwÜds
)

1237 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

1238 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

1239 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

1240 
ib_h—d”
 *
hdr
 = &
Ýa_hdr
->
ibh
;

1241 
ib_Ùh”_h—d”s
 *
ohdr
;

1242 
u16
 
Ìh0
 = 
HFI1_LRH_BTH
;

1243 
u16
 
pkey
;

1244 
u32
 
bth0
, 
bth1
;

1246 
Ýa_hdr
->
hdr_ty³
 = 
HFI1_PKT_TYPE_9B
;

1247 
ohdr
 = &
hdr
->
u
.
Ùh
;

1249 *
hwÜds
 = 6;

1251 ià(
	`uÆik–y
(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
)) {

1252 *
hwÜds
 +ð
	`hfi1_make_grh
(
ibp
, &
hdr
->
u
.
l
.
grh
,

1253 
	`rdma_ah_»ad_grh
(&
qp
->
»mÙe_ah_©Œ
),

1254 *
hwÜds
 - 2, 
SIZE_OF_CRC
);

1255 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1256 
Ìh0
 = 
HFI1_LRH_GRH
;

1259 *
pbc_æags
 |ð((!!(
sc5
 & 0x10)è<< 
PBC_DC_INFO_SHIFT
);

1262 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
qp
->
s_pkey_šdex
);

1264 
Ìh0
 |ð(
sc5
 & 
IB_SC_MASK
è<< 
IB_SC_SHIFT
 |

1265 (
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_SL_MASK
) <<

1266 
IB_SL_SHIFT
;

1268 
	`hfi1_make_ib_hdr
(
hdr
, 
Ìh0
, *
hwÜds
 + 
SIZE_OF_CRC
,

1269 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
), 9B),

1270 
µd
->
lid
 | 
	`rdma_ah_g‘_·th_b™s
(&
qp
->
»mÙe_ah_©Œ
));

1272 
bth0
 = 
pkey
 | (
	`OP
(
ACKNOWLEDGE
) << 24);

1273 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_MIGRATED
)

1274 
bth0
 |ð
IB_BTH_MIG_REQ
;

1275 
bth1
 = (!!
is_ãú
è<< 
IB_BECN_SHIFT
;

1280 
bth1
 |ð
	`HFI1_CAP_IS_KSET
(
OPFN
è<< 
IB_BTHE_E_SHIFT
;

1281 
	`hfi1_make_bth_«th
(
qp
, 
ohdr
, 
bth0
, 
bth1
);

1282 
	}
}

1284 
šlše
 
	$hfi1_make_rc_ack_16B
(
hfi1_·ck‘
 *
·ck‘
,

1285 
hfi1_Ýa_h—d”
 *
Ýa_hdr
,

1286 
u8
 
sc5
, 
boÞ
 
is_ãú
,

1287 
u64
 *
pbc_æags
, 
u32
 *
hwÜds
,

1288 
u32
 *
nwÜds
)

1290 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

1291 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

1292 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

1293 
hfi1_16b_h—d”
 *
hdr
 = &
Ýa_hdr
->
Ýah
;

1294 
ib_Ùh”_h—d”s
 *
ohdr
;

1295 
u32
 
bth0
, 
bth1
 = 0;

1296 
u16
 
Ën
, 
pkey
;

1297 
boÞ
 
beú
 = 
is_ãú
;

1298 
u8
 
l4
 = 
OPA_16B_L4_IB_LOCAL
;

1299 
u8
 
exŒa_by‹s
;

1301 
Ýa_hdr
->
hdr_ty³
 = 
HFI1_PKT_TYPE_16B
;

1302 
ohdr
 = &
hdr
->
u
.
Ùh
;

1304 *
hwÜds
 = 8;

1305 
exŒa_by‹s
 = 
	`hfi1_g‘_16b_·ddšg
(*
hwÜds
 << 2, 0);

1306 *
nwÜds
 = 
SIZE_OF_CRC
 + ((
exŒa_by‹s
 + 
SIZE_OF_LT
) >> 2);

1308 ià(
	`uÆik–y
(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
) &&

1309 
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
))) {

1310 *
hwÜds
 +ð
	`hfi1_make_grh
(
ibp
, &
hdr
->
u
.
l
.
grh
,

1311 
	`rdma_ah_»ad_grh
(&
qp
->
»mÙe_ah_©Œ
),

1312 *
hwÜds
 - 4, *
nwÜds
);

1313 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1314 
l4
 = 
OPA_16B_L4_IB_GLOBAL
;

1316 *
pbc_æags
 |ð
PBC_PACKET_BYPASS
 | 
PBC_INSERT_BYPASS_ICRC
;

1319 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
qp
->
s_pkey_šdex
);

1322 
Ën
 = (*
hwÜds
 + *
nwÜds
) >> 1;

1324 
	`hfi1_make_16b_hdr
(
hdr
, 
µd
->
lid
 |

1325 (
	`rdma_ah_g‘_·th_b™s
(&
qp
->
»mÙe_ah_©Œ
) &

1326 ((1 << 
µd
->
lmc
) - 1)),

1327 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
),

1328 16B), 
Ën
, 
pkey
, 
beú
, 0, 
l4
, 
sc5
);

1330 
bth0
 = 
pkey
 | (
	`OP
(
ACKNOWLEDGE
) << 24);

1331 
bth0
 |ð
exŒa_by‹s
 << 20;

1332 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_MIGRATED
)

1333 
bth1
 = 
OPA_BTH_MIG_REQ
;

1334 
	`hfi1_make_bth_«th
(
qp
, 
ohdr
, 
bth0
, 
bth1
);

1335 
	}
}

1337 (*
	thfi1_make_rc_ack
)(
	thfi1_·ck‘
 *
	t·ck‘
,

1338 
	thfi1_Ýa_h—d”
 *
	tÝa_hdr
,

1339 
	tu8
 
	tsc5
, 
	tboÞ
 
	tis_ãú
,

1340 
	tu64
 *
	tpbc_æags
, 
	tu32
 *
	thwÜds
,

1341 
	tu32
 *
	tnwÜds
);

1344 cÚ¡ 
hfi1_make_rc_ack
 
hfi1_make_rc_ack_tbl
[2] = {

1345 [
HFI1_PKT_TYPE_9B
] = &
hfi1_make_rc_ack_9B
,

1346 [
HFI1_PKT_TYPE_16B
] = &
hfi1_make_rc_ack_16B


1347 
	}
};

1357 
	$hfi1_£nd_rc_ack
(
hfi1_·ck‘
 *
·ck‘
, 
boÞ
 
is_ãú
)

1359 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

1360 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

1361 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

1362 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1363 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

1364 
u8
 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
)];

1365 
u64
 
pbc
, 
pbc_æags
 = 0;

1366 
u32
 
hwÜds
 = 0;

1367 
u32
 
nwÜds
 = 0;

1368 
u32
 
¶’
;

1369 
pio_buf
 *
pbuf
;

1370 
hfi1_Ýa_h—d”
 
Ýa_hdr
;

1373 
qp
->
r_adeã»d
 = 0;

1376 ià(
qp
->
s_æags
 & 
RVT_S_RESP_PENDING
) {

1377 
	`hfi1_queue_rc_ack
(
·ck‘
, 
is_ãú
);

1382 ià(
qp
->
s_rdma_ack_út
) {

1383 
	`hfi1_queue_rc_ack
(
·ck‘
, 
is_ãú
);

1388 ià(
	`driv”_l¡©e
(
µd
è!ð
IB_PORT_ACTIVE
)

1392 
hfi1_make_rc_ack_tbl
[
´iv
->
hdr_ty³
](
·ck‘
, &
Ýa_hdr
, 
sc5
, 
is_ãú
,

1393 &
pbc_æags
, &
hwÜds
, &
nwÜds
);

1395 
¶’
 = 2 + 
hwÜds
 + 
nwÜds
;

1396 
pbc
 = 
	`ü—‹_pbc
(
µd
, 
pbc_æags
, 
qp
->
¤©e_mbps
,

1397 
	`sc_to_vÉ
(
µd
->
dd
, 
sc5
), 
¶’
);

1398 
pbuf
 = 
	`sc_bufãr_®loc
(
rcd
->
sc
, 
¶’
, 
NULL
, NULL);

1399 ià(
	`IS_ERR_OR_NULL
(
pbuf
)) {

1406 
	`hfi1_queue_rc_ack
(
·ck‘
, 
is_ãú
);

1409 
	`Œaû_ack_ouut_ibhdr
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
),

1410 &
Ýa_hdr
, 
	`ib_is_sc5
(
sc5
));

1413 
µd
->
dd
->
	`pio_šlše_£nd
Õpd->dd, 
pbuf
, 
pbc
,

1414 (
´iv
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_9B
 ?

1415 (*)&
Ýa_hdr
.
ibh
 :

1416 (*)&
Ýa_hdr
.
Ýah
), 
hwÜds
);

1418 
	}
}

1430 
	$upd©e_num_rd_©omic
(
rvt_qp
 *
qp
, 
u32
 
p¢
,

1431 
rvt_swqe
 *
wqe
)

1433 
u32
 
Ýcode
 = 
wqe
->
wr
.opcode;

1435 ià(
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

1436 
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

1437 
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
) {

1438 
qp
->
s_num_rd_©omic
++;

1439 } ià(
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

1440 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1441 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1443 ià(
	`cmp_p¢
(
p¢
, 
wqe
->
Í¢
) <= 0) {

1444 
u32
 
cur_£g
;

1446 
cur_£g
 = (
p¢
 - 
wqe
->p¢è/ 
´iv
->
pkts_ps
;

1447 
»q
->
ack_³ndšg
 = 
cur_£g
 -„eq->
comp_£g
;

1448 
´iv
->
³ndšg_tid_r_£gs
 +ð
»q
->
ack_³ndšg
;

1449 
qp
->
s_num_rd_©omic
 +ð
»q
->
ack_³ndšg
;

1450 
	`Œaû_hfi1_tid_»q_upd©e_num_rd_©omic
(
qp
, 0,

1451 
wqe
->
wr
.
Ýcode
,

1452 
wqe
->
p¢
,

1453 
wqe
->
Í¢
,

1454 
»q
);

1456 
´iv
->
³ndšg_tid_r_£gs
 +ð
»q
->
tÙ®_£gs
;

1457 
qp
->
s_num_rd_©omic
 +ð
»q
->
tÙ®_£gs
;

1460 
	}
}

1471 
	$»£t_p¢
(
rvt_qp
 *
qp
, 
u32
 
p¢
)

1473 
u32
 
n
 = 
qp
->
s_acked
;

1474 
rvt_swqe
 *
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
n
);

1475 
u32
 
Ýcode
;

1476 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1478 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1479 
qp
->
s_cur
 = 
n
;

1480 
qp
->
s_timeout_shiá
 = 0;

1481 
´iv
->
³ndšg_tid_r_£gs
 = 0;

1482 
´iv
->
³ndšg_tid_w_»¥
 = 0;

1483 
qp
->
s_num_rd_©omic
 = 0;

1489 ià(
	`cmp_p¢
(
p¢
, 
wqe
->psn) <= 0) {

1490 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

1491 
dÚe
;

1493 
	`upd©e_num_rd_©omic
(
qp
, 
p¢
, 
wqe
);

1497 
diff
;

1499 ià(++
n
 =ð
qp
->
s_size
)

1500 
n
 = 0;

1501 ià(
n
 =ð
qp
->
s_ž
)

1503 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
n
);

1504 
diff
 = 
	`cmp_p¢
(
p¢
, 
wqe
->psn);

1505 ià(
diff
 < 0) {

1507 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_cur
);

1510 
qp
->
s_cur
 = 
n
;

1515 ià(
diff
 == 0) {

1516 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

1517 
dÚe
;

1520 
	`upd©e_num_rd_©omic
(
qp
, 
p¢
, 
wqe
);

1522 
Ýcode
 = 
wqe
->
wr
.opcode;

1529 
Ýcode
) {

1530 
IB_WR_SEND
:

1531 
IB_WR_SEND_WITH_IMM
:

1532 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_FIRST
);

1535 
IB_WR_RDMA_WRITE
:

1536 
IB_WR_RDMA_WRITE_WITH_IMM
:

1537 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_LAST
);

1540 
IB_WR_TID_RDMA_WRITE
:

1541 
qp
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

1544 
IB_WR_RDMA_READ
:

1545 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
);

1548 
IB_WR_TID_RDMA_READ
:

1549 
qp
->
s_¡©e
 = 
	`TID_OP
(
READ_RESP
);

1557 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

1559 
dÚe
:

1560 
´iv
->
s_æags
 &ð~
HFI1_S_TID_WAIT_INTERLCK
;

1561 
qp
->
s_p¢
 = 
p¢
;

1567 ià((
	`cmp_p¢
(
qp
->
s_p¢
, qp->
s_£ndšg_hp¢
) <= 0) &&

1568 (
	`cmp_p¢
(
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
) <= 0))

1569 
qp
->
s_æags
 |ð
RVT_S_WAIT_PSN
;

1570 
qp
->
s_æags
 &ð~
HFI1_S_AHG_VALID
;

1571 
	}
}

1577 
	$hfi1_»¡¬t_rc
(
rvt_qp
 *
qp
, 
u32
 
p¢
, 
wa™
)

1579 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1580 
rvt_swqe
 *
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

1581 
hfi1_ibpÜt
 *
ibp
;

1583 
	`lockd•_as£¹_h–d
(&
qp
->
r_lock
);

1584 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1585 ià(
qp
->
s_»Œy
 == 0) {

1586 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_ARMED
) {

1587 
	`hfi1_mig¿‹_qp
(
qp
);

1588 
qp
->
s_»Œy
 = qp->
s_»Œy_út
;

1589 } ià(
qp
->
s_Ï¡
 =ðqp->
s_acked
) {

1594 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_OPFN
) {

1595 
hfi1_ibpÜt
 *
ibp
 =

1596 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

1602 
	`Ýâ_cÚn_»¶y
(
qp
, 
´iv
->
Ýâ
.
cu¼
);

1603 
wqe
 = 
	`do_rc_com¶‘iÚ
(
qp
, wqe, 
ibp
);

1604 
qp
->
s_æags
 &ð~
RVT_S_WAIT_ACK
;

1606 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

1607 
tid_rdma_»que¡
 *
»q
;

1609 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1610 
	`hfi1_k”n_exp_rcv_þ—r_®l
(
»q
);

1611 
	`hfi1_k”n_þ—r_hw_æow
(
´iv
->
rcd
, 
qp
);

1614 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
,

1615 
IB_WC_RETRY_EXC_ERR
);

1616 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

1623 
qp
->
s_»Œy
--;

1626 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

1627 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

1628 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
)

1629 
ibp
->
rvp
.
n_rc_»£nds
++;

1631 
ibp
->
rvp
.
n_rc_»£nds
 +ð
	`d–_p¢
(
qp
->
s_p¢
, 
p¢
);

1633 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_FENCE
 | 
RVT_S_WAIT_RDMAR
 |

1634 
RVT_S_WAIT_SSN_CREDIT
 | 
RVT_S_WAIT_PSN
 |

1635 
RVT_S_WAIT_ACK
 | 
HFI1_S_WAIT_TID_RESP
);

1636 ià(
wa™
)

1637 
qp
->
s_æags
 |ð
RVT_S_SEND_ONE
;

1638 
	`»£t_p¢
(
qp
, 
p¢
);

1639 
	}
}

1646 
	$»£t_£ndšg_p¢
(
rvt_qp
 *
qp
, 
u32
 
p¢
, u32 
Ýcode
)

1648 
rvt_swqe
 *
wqe
;

1649 
u32
 
n
 = 
qp
->
s_Ï¡
;

1651 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1654 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
n
);

1655 ià(
	`cmp_p¢
(
p¢
, 
wqe
->
Í¢
) <= 0) {

1656 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

1657 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
 ||

1658 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
)

1659 
qp
->
s_£ndšg_p¢
 = 
wqe
->
Í¢
 + 1;

1661 
qp
->
s_£ndšg_p¢
 = 
p¢
 + 1;

1664 ià(++
n
 =ð
qp
->
s_size
)

1665 
n
 = 0;

1666 ià(
n
 =ð
qp
->
s_ž
)

1669 
	}
}

1683 
	$hfi1_rc_v”bs_abÜ‹d
(
rvt_qp
 *
qp
, 
hfi1_Ýa_h—d”
 *
Ýah
)

1685 
ib_Ùh”_h—d”s
 *
ohdr
 = 
	`hfi1_g‘_rc_ohdr
(
Ýah
);

1686 
u8
 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

1687 
u32
 
p¢
;

1690 ià((
Ýcode
 >ð
	`OP
(
RDMA_READ_RESPONSE_FIRST
) &&

1691 
Ýcode
 <ð
	`OP
(
ATOMIC_ACKNOWLEDGE
)) ||

1692 
Ýcode
 =ð
	`TID_OP
(
READ_RESP
) ||

1693 
Ýcode
 =ð
	`TID_OP
(
WRITE_RESP
))

1696 
p¢
 = 
	`ib_bth_g‘_p¢
(
ohdr
è| 
IB_BTH_REQ_ACK
;

1697 
ohdr
->
bth
[2] = 
	`ýu_to_be32
(
p¢
);

1698 
qp
->
s_æags
 |ð
RVT_S_SEND_ONE
;

1699 
	}
}

1704 
	$hfi1_rc_£nd_com¶‘e
(
rvt_qp
 *
qp
, 
hfi1_Ýa_h—d”
 *
Ýah
)

1706 
ib_Ùh”_h—d”s
 *
ohdr
;

1707 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1708 
rvt_swqe
 *
wqe
;

1709 
u32
 
Ýcode
, 
h—d
, 
ž
;

1710 
u32
 
p¢
;

1711 
tid_rdma_»que¡
 *
»q
;

1713 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1714 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_SEND_OR_FLUSH_OR_RECV_OK
))

1717 
ohdr
 = 
	`hfi1_g‘_rc_ohdr
(
Ýah
);

1718 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

1719 ià((
Ýcode
 >ð
	`OP
(
RDMA_READ_RESPONSE_FIRST
) &&

1720 
Ýcode
 <ð
	`OP
(
ATOMIC_ACKNOWLEDGE
)) ||

1721 
Ýcode
 =ð
	`TID_OP
(
WRITE_RESP
) ||

1722 
Ýcode
 =ð
	`TID_OP
(
READ_RESP
)) {

1723 
	`WARN_ON
(!
qp
->
s_rdma_ack_út
);

1724 
qp
->
s_rdma_ack_út
--;

1728 
p¢
 = 
	`ib_bth_g‘_p¢
(
ohdr
);

1733 ià(
Ýcode
 !ð
	`TID_OP
(
WRITE_DATA
) &&

1734 
Ýcode
 !ð
	`TID_OP
(
WRITE_DATA_LAST
) &&

1735 
Ýcode
 !ð
	`TID_OP
(
ACK
è&& opcod!ðTID_OP(
RESYNC
))

1736 
	`»£t_£ndšg_p¢
(
qp
, 
p¢
, 
Ýcode
);

1739 ià(
Ýcode
 >ð
	`TID_OP
(
WRITE_REQ
) &&

1740 
Ýcode
 <ð
	`TID_OP
(
WRITE_DATA_LAST
)) {

1741 
h—d
 = 
´iv
->
s_tid_h—d
;

1742 
ž
 = 
´iv
->
s_tid_cur
;

1751 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
ž
);

1752 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1753 ià(
h—d
 =ð
ž
 && 
»q
->
comp_£g
 <„eq->
tÙ®_£gs
)

1754 
ž
 -= 1;

1756 
h—d
 = 
qp
->
s_ž
;

1757 
ž
 = 
qp
->
s_acked
;

1764 ià((
p¢
 & 
IB_BTH_REQ_ACK
è&& 
ž
 !ð
h—d
 &&

1765 
Ýcode
 !ð
	`TID_OP
(
WRITE_DATA
è&& opcod!ðTID_OP(
WRITE_DATA_LAST
) &&

1766 
Ýcode
 !ð
	`TID_OP
(
RESYNC
) &&

1767 !(
qp
->
s_æags
 &

1768 (
RVT_S_TIMER
 | 
RVT_S_WAIT_RNR
 | 
RVT_S_WAIT_PSN
)) &&

1769 (
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
)) {

1770 ià(
Ýcode
 =ð
	`TID_OP
(
READ_REQ
))

1771 
qp
->
s_timeout_shiá
 = 
´iv
->
timeout_shiá
;

1773 
qp
->
s_timeout_shiá
 = 0;

1774 
	`rvt_add_»Œy_tim”
(
qp
);

1778 ià((
Ýcode
 =ð
	`TID_OP
(
WRITE_DATA
) ||

1779 
Ýcode
 =ð
	`TID_OP
(
WRITE_DATA_LAST
) ||

1780 
Ýcode
 =ð
	`TID_OP
(
RESYNC
)) &&

1781 (
p¢
 & 
IB_BTH_REQ_ACK
) &&

1782 !(
´iv
->
s_æags
 & 
HFI1_S_TID_RETRY_TIMER
) &&

1783 (
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
)) {

1789 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

1790 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1791 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 &&

1792 
»q
->
ack_£g
 <„eq->
cur_£g
)

1793 
	`hfi1_add_tid_»Œy_tim”
(
qp
);

1796 
qp
->
s_Ï¡
 !ðqp->
s_acked
) {

1797 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_Ï¡
);

1798 ià(
	`cmp_p¢
(
wqe
->
Í¢
, 
qp
->
s_£ndšg_p¢
) >= 0 &&

1799 
	`cmp_p¢
(
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
) <= 0)

1801 
	`Œdma_þ—n_swqe
(
qp
, 
wqe
);

1802 
	`Œaû_hfi1_qp_£nd_com¶‘iÚ
(
qp
, 
wqe
, qp->
s_Ï¡
);

1803 
	`rvt_qp_com¶‘e_swqe
(
qp
,

1804 
wqe
,

1805 
ib_hfi1_wc_Ýcode
[
wqe
->
wr
.
Ýcode
],

1806 
IB_WC_SUCCESS
);

1812 
	`Œaû_hfi1_£ndcom¶‘e
(
qp
, 
p¢
);

1813 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_PSN
 &&

1814 
	`cmp_p¢
(
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
) > 0) {

1815 
qp
->
s_æags
 &ð~
RVT_S_WAIT_PSN
;

1816 
qp
->
s_£ndšg_p¢
 = qp->
s_p¢
;

1817 
qp
->
s_£ndšg_hp¢
 = qp->
s_p¢
 - 1;

1818 
	`hfi1_scheduË_£nd
(
qp
);

1820 
	}
}

1822 
šlše
 
	$upd©e_Ï¡_p¢
(
rvt_qp
 *
qp
, 
u32
 
p¢
)

1824 
qp
->
s_Ï¡_p¢
 = 
p¢
;

1825 
	}
}

1832 
rvt_swqe
 *
	$do_rc_com¶‘iÚ
(
rvt_qp
 *
qp
,

1833 
rvt_swqe
 *
wqe
,

1834 
hfi1_ibpÜt
 *
ibp
)

1836 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1838 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1844 
	`Œaû_hfi1_rc_com¶‘iÚ
(
qp
, 
wqe
->
Í¢
);

1845 ià(
	`cmp_p¢
(
wqe
->
Í¢
, 
qp
->
s_£ndšg_p¢
) < 0 ||

1846 
	`cmp_p¢
(
qp
->
s_£ndšg_p¢
, qp->
s_£ndšg_hp¢
) > 0) {

1847 
	`Œdma_þ—n_swqe
(
qp
, 
wqe
);

1848 
	`Œaû_hfi1_qp_£nd_com¶‘iÚ
(
qp
, 
wqe
, qp->
s_Ï¡
);

1849 
	`rvt_qp_com¶‘e_swqe
(
qp
,

1850 
wqe
,

1851 
ib_hfi1_wc_Ýcode
[
wqe
->
wr
.
Ýcode
],

1852 
IB_WC_SUCCESS
);

1854 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

1856 
	`this_ýu_šc
(*
ibp
->
rvp
.
rc_d–ayed_comp
);

1861 ià(
µd
->
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
) {

1862 
sdma_’gše
 *
’gše
;

1863 
u8
 
¦
 = 
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
);

1864 
u8
 
sc5
;

1867 
sc5
 = 
ibp
->
¦_to_sc
[
¦
];

1868 
’gše
 = 
	`qp_to_sdma_’gše
(
qp
, 
sc5
);

1869 
	`sdma_’gše_´og»ss_scheduË
(
’gše
);

1873 
qp
->
s_»Œy
 = qp->
s_»Œy_út
;

1882 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
)

1883 
	`upd©e_Ï¡_p¢
(
qp
, 
wqe
->
Í¢
);

1890 ià(
qp
->
s_acked
 =ðqp->
s_cur
) {

1891 ià(++
qp
->
s_cur
 >ðqp->
s_size
)

1892 
qp
->
s_cur
 = 0;

1893 
qp
->
s_acked
 = qp->
s_cur
;

1894 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_cur
);

1895 ià(
qp
->
s_acked
 !ðqp->
s_ž
) {

1896 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

1897 
qp
->
s_p¢
 = 
wqe
->
p¢
;

1900 ià(++
qp
->
s_acked
 >ðqp->
s_size
)

1901 
qp
->
s_acked
 = 0;

1902 ià(
qp
->
¡©e
 =ð
IB_QPS_SQD
 && qp->
s_acked
 =ðqp->
s_cur
)

1903 
qp
->
s_d¿ššg
 = 0;

1904 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

1906 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_WAIT_INTERLCK
) {

1907 
´iv
->
s_æags
 &ð~
HFI1_S_TID_WAIT_INTERLCK
;

1908 
	`hfi1_scheduË_£nd
(
qp
);

1910  
wqe
;

1911 
	}
}

1913 
	$£t_»¡¬t_qp
(
rvt_qp
 *
qp
, 
hfi1_ùxtd©a
 *
rcd
)

1916 ià(!(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
)) {

1917 
qp
->
r_æags
 |ð
RVT_R_RDMAR_SEQ
;

1918 
	`hfi1_»¡¬t_rc
(
qp
, qp->
s_Ï¡_p¢
 + 1, 0);

1919 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
)) {

1920 
qp
->
r_æags
 |ð
RVT_R_RSP_SEND
;

1921 
	`rvt_g‘_qp
(
qp
);

1922 
	`li¡_add_ž
(&
qp
->
r¥wa™
, &
rcd
->
qp_wa™_li¡
);

1925 
	}
}

1938 
	$upd©e_qp_»Œy_¡©e
(
rvt_qp
 *
qp
, 
u32
 
p¢
, u32 
¥¢
,

1939 
u32
 
Í¢
)

1941 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1943 
qp
->
s_p¢
 = 
p¢
 + 1;

1950 ià(
	`cmp_p¢
(
p¢
, 
Í¢
) >= 0) {

1951 
qp
->
s_cur
 = 
q´iv
->
s_tid_cur
 + 1;

1952 ià(
qp
->
s_cur
 >ðqp->
s_size
)

1953 
qp
->
s_cur
 = 0;

1954 
qp
->
s_¡©e
 = 
	`TID_OP
(
WRITE_REQ
);

1955 } ià(!
	`cmp_p¢
(
p¢
, 
¥¢
)) {

1956 
qp
->
s_cur
 = 
q´iv
->
s_tid_cur
;

1957 
qp
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

1959 
	}
}

1972 
	$do_rc_ack
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
, 
Ýcode
, 
u64
 
v®
,

1973 
hfi1_ùxtd©a
 *
rcd
)

1975 
hfi1_ibpÜt
 *
ibp
;

1976 
ib_wc_¡©us
 
¡©us
;

1977 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1978 
rvt_swqe
 *
wqe
;

1979 
»t
 = 0;

1980 
u32
 
ack_p¢
;

1981 
diff
;

1982 
rvt_dev_šfo
 *
rdi
;

1984 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

1991 
ack_p¢
 = 
p¢
;

1992 ià(
«th
 >> 
IB_AETH_NAK_SHIFT
)

1993 
ack_p¢
--;

1994 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

1995 
ibp
 = 
	`rcd_to_Üt
(
rcd
);

2001 (
diff
 = 
	`d–_p¢
(
ack_p¢
, 
wqe
->
Í¢
)) >= 0) {

2008 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 &&

2009 
Ýcode
 =ð
	`OP
(
RDMA_READ_RESPONSE_ONLY
) &&

2010 
diff
 == 0) {

2011 
»t
 = 1;

2012 
baž_¡Ý
;

2023 ià((
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 &&

2024 (
Ýcode
 !ð
	`OP
(
RDMA_READ_RESPONSE_LAST
è|| 
diff
 != 0)) ||

2025 (
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
 &&

2026 (
Ýcode
 !ð
	`TID_OP
(
READ_RESP
è|| 
diff
 != 0)) ||

2027 ((
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

2028 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
) &&

2029 (
Ýcode
 !ð
	`OP
(
ATOMIC_ACKNOWLEDGE
è|| 
diff
 != 0)) ||

2030 (
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 &&

2031 (
	`d–_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
) != 1))) {

2032 
	`£t_»¡¬t_qp
(
qp
, 
rcd
);

2037 
baž_¡Ý
;

2039 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

2040 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
) {

2041 
u64
 *
vaddr
 = 
wqe
->
sg_li¡
[0].vaddr;

2042 *
vaddr
 = 
v®
;

2044 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_OPFN
)

2045 
	`Ýâ_cÚn_»¶y
(
qp
, 
v®
);

2047 ià(
qp
->
s_num_rd_©omic
 &&

2048 (
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

2049 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

2050 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
)) {

2051 
qp
->
s_num_rd_©omic
--;

2053 ià((
qp
->
s_æags
 & 
RVT_S_WAIT_FENCE
) &&

2054 !
qp
->
s_num_rd_©omic
) {

2055 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_FENCE
 |

2056 
RVT_S_WAIT_ACK
);

2057 
	`hfi1_scheduË_£nd
(
qp
);

2058 } ià(
qp
->
s_æags
 & 
RVT_S_WAIT_RDMAR
) {

2059 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_RDMAR
 |

2060 
RVT_S_WAIT_ACK
);

2061 
	`hfi1_scheduË_£nd
(
qp
);

2069 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
)

2072 
wqe
 = 
	`do_rc_com¶‘iÚ
(
qp
, wqe, 
ibp
);

2073 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

2077 
	`Œaû_hfi1_rc_ack_do
(
qp
, 
«th
, 
p¢
, 
wqe
);

2078 
	`Œaû_hfi1_£nd”_do_rc_ack
(
qp
);

2079 
«th
 >> 
IB_AETH_NAK_SHIFT
) {

2081 
	`this_ýu_šc
(*
ibp
->
rvp
.
rc_acks
);

2082 
qp
->
s_timeout_shiá
 = 0;

2083 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

2084 ià(
	`wqe_to_tid_»q
(
wqe
)->
ack_³ndšg
) {

2085 
qp
->
s_timeout_shiá
 = 
q´iv
->
timeout_shiá
;

2086 
	`rvt_mod_»Œy_tim”
(
qp
);

2088 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2090 } ià(
qp
->
s_acked
 !ðqp->
s_ž
) {

2091 
rvt_swqe
 *
__w
 = 
NULL
;

2093 ià(
q´iv
->
s_tid_cur
 !ð
HFI1_QP_WQE_INVALID
)

2094 
__w
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
q´iv
->
s_tid_cur
);

2100 ià(
__w
 && __w->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 &&

2101 
Ýcode
 =ð
	`TID_OP
(
WRITE_RESP
)) {

2114 ià(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
 + 1)) {

2115 
	`£t_»¡¬t_qp
(
qp
, 
rcd
);

2116 
baž_¡Ý
;

2122 ià(
qp
->
s_cur
 !ðqp->
s_ž
 &&

2123 
	`cmp_p¢
(
qp
->
s_p¢
, 
p¢
) <= 0)

2124 
	`upd©e_qp_»Œy_¡©e
(
qp
, 
p¢
,

2125 
__w
->
p¢
,

2126 
__w
->
Í¢
);

2127 ià(--
q´iv
->
³ndšg_tid_w_»¥
)

2128 
	`rvt_mod_»Œy_tim”
(
qp
);

2130 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2136 
	`rvt_mod_»Œy_tim”
(
qp
);

2142 ià(
	`cmp_p¢
(
qp
->
s_p¢
, 
p¢
) <= 0)

2143 
	`»£t_p¢
(
qp
, 
p¢
 + 1);

2147 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2148 ià(
	`cmp_p¢
(
qp
->
s_p¢
, 
p¢
) <= 0) {

2149 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

2150 
qp
->
s_p¢
 = 
p¢
 + 1;

2153 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_ACK
) {

2154 
qp
->
s_æags
 &ð~
RVT_S_WAIT_ACK
;

2155 
	`hfi1_scheduË_£nd
(
qp
);

2158 
	`rvt_g‘_üed™
(
qp
, 
«th
);

2159 
qp
->
s_ºr_»Œy
 = qp->
s_ºr_»Œy_út
;

2160 
qp
->
s_»Œy
 = qp->
s_»Œy_út
;

2166 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 &&

2167 
Ýcode
 !ð
	`TID_OP
(
WRITE_RESP
) &&

2168 
	`cmp_p¢
(
p¢
, 
wqe
->psn) >= 0)

2171 
	`upd©e_Ï¡_p¢
(
qp
, 
p¢
);

2175 
ibp
->
rvp
.
n_ºr_Çks
++;

2176 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

2177 
baž_¡Ý
;

2178 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_RNR
)

2179 
baž_¡Ý
;

2180 
rdi
 = 
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
);

2181 ià(!(
rdi
->
po¡_·rms
[
wqe
->
wr
.
Ýcode
].
æags
 &

2182 
RVT_OPERATION_IGN_RNR_CNT
)) {

2183 ià(
qp
->
s_ºr_»Œy
 == 0) {

2184 
¡©us
 = 
IB_WC_RNR_RETRY_EXC_ERR
;

2185 
þass_b
;

2187 ià(
qp
->
s_ºr_»Œy_út
 < 7 && qp->s_rnr_retry_cnt > 0)

2188 
qp
->
s_ºr_»Œy
--;

2197 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
) {

2198 
	`»£t_p¢
(
qp
, qp->
s_Ï¡_p¢
 + 1);

2200 
	`upd©e_Ï¡_p¢
(
qp
, 
p¢
 - 1);

2201 
	`»£t_p¢
(
qp
, 
p¢
);

2204 
ibp
->
rvp
.
n_rc_»£nds
 +ð
	`d–_p¢
(
qp
->
s_p¢
, 
p¢
);

2205 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_SSN_CREDIT
 | 
RVT_S_WAIT_ACK
);

2206 
qp
->
s_timeout_shiá
 = 0;

2207 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2208 
	`rvt_add_ºr_tim”
(
qp
, 
«th
);

2212 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

2213 
baž_¡Ý
;

2215 
	`upd©e_Ï¡_p¢
(
qp
, 
p¢
 - 1);

2216 (
«th
 >> 
IB_AETH_CREDIT_SHIFT
) &

2217 
IB_AETH_CREDIT_MASK
) {

2219 
ibp
->
rvp
.
n_£q_Çks
++;

2226 
	`hfi1_»¡¬t_rc
(
qp
, 
p¢
, 0);

2227 
	`hfi1_scheduË_£nd
(
qp
);

2231 
¡©us
 = 
IB_WC_REM_INV_REQ_ERR
;

2232 
ibp
->
rvp
.
n_Ùh”_Çks
++;

2233 
þass_b
;

2236 
¡©us
 = 
IB_WC_REM_ACCESS_ERR
;

2237 
ibp
->
rvp
.
n_Ùh”_Çks
++;

2238 
þass_b
;

2241 
¡©us
 = 
IB_WC_REM_OP_ERR
;

2242 
ibp
->
rvp
.
n_Ùh”_Çks
++;

2243 
þass_b
:

2244 ià(
qp
->
s_Ï¡
 =ðqp->
s_acked
) {

2245 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
)

2246 
	`hfi1_k”n_»ad_tid_æow_ä“
(
qp
);

2248 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
, 
¡©us
);

2249 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

2255 
»£rved
;

2257 
qp
->
s_»Œy
 = qp->
s_»Œy_út
;

2258 
qp
->
s_ºr_»Œy
 = qp->
s_ºr_»Œy_út
;

2259 
baž_¡Ý
;

2262 
»£rved
:

2264 
baž_¡Ý
;

2267 
baž_¡Ý
:

2268 
qp
->
s_timeout_shiá
 = 0;

2269 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2270  
»t
;

2271 
	}
}

2277 
	$rdma_£q_”r
(
rvt_qp
 *
qp
, 
hfi1_ibpÜt
 *
ibp
, 
u32
 
p¢
,

2278 
hfi1_ùxtd©a
 *
rcd
)

2280 
rvt_swqe
 *
wqe
;

2282 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

2284 
	`rvt_¡Ý_rc_tim”s
(
qp
);

2286 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

2288 
	`cmp_p¢
(
p¢
, 
wqe
->
Í¢
) > 0) {

2289 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

2290 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
 ||

2291 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 ||

2292 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

2293 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
)

2295 
wqe
 = 
	`do_rc_com¶‘iÚ
(
qp
, wqe, 
ibp
);

2298 
ibp
->
rvp
.
n_rdma_£q
++;

2299 
qp
->
r_æags
 |ð
RVT_R_RDMAR_SEQ
;

2300 
	`hfi1_»¡¬t_rc
(
qp
, qp->
s_Ï¡_p¢
 + 1, 0);

2301 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
)) {

2302 
qp
->
r_æags
 |ð
RVT_R_RSP_SEND
;

2303 
	`rvt_g‘_qp
(
qp
);

2304 
	`li¡_add_ž
(&
qp
->
r¥wa™
, &
rcd
->
qp_wa™_li¡
);

2306 
	}
}

2316 
	$rc_rcv_»¥
(
hfi1_·ck‘
 *
·ck‘
)

2318 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

2319 *
d©a
 = 
·ck‘
->
·ylßd
;

2320 
u32
 
Ž’
 = 
·ck‘
->tlen;

2321 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2322 
hfi1_ibpÜt
 *
ibp
;

2323 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

2324 
rvt_swqe
 *
wqe
;

2325 
ib_wc_¡©us
 
¡©us
;

2326 
æags
;

2327 
diff
;

2328 
u64
 
v®
;

2329 
u32
 
«th
;

2330 
u32
 
p¢
 = 
	`ib_bth_g‘_p¢
(
·ck‘
->
ohdr
);

2331 
u32
 
pmtu
 = 
qp
->pmtu;

2332 
u16
 
hdrsize
 = 
·ck‘
->
hËn
;

2333 
u8
 
Ýcode
 = 
·ck‘
->opcode;

2334 
u8
 
·d
 = 
·ck‘
->pad;

2335 
u8
 
exŒa_by‹s
 = 
·d
 + 
·ck‘
->
exŒa_by‹
 + (
SIZE_OF_CRC
 << 2);

2337 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

2338 
	`Œaû_hfi1_ack
(
qp
, 
p¢
);

2341 ià(
	`cmp_p¢
(
p¢
, 
	`READ_ONCE
(
qp
->
s_Ãxt_p¢
)) >= 0)

2342 
ack_dÚe
;

2345 
diff
 = 
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
);

2346 ià(
	`uÆik–y
(
diff
 <= 0)) {

2348 ià(
diff
 =ð0 && 
Ýcode
 =ð
	`OP
(
ACKNOWLEDGE
)) {

2349 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.aeth);

2350 ià((
«th
 >> 
IB_AETH_NAK_SHIFT
) == 0)

2351 
	`rvt_g‘_üed™
(
qp
, 
«th
);

2353 
ack_dÚe
;

2360 ià(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
) {

2361 ià(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
 + 1) != 0)

2362 
ack_dÚe
;

2363 
qp
->
r_æags
 &ð~
RVT_R_RDMAR_SEQ
;

2366 ià(
	`uÆik–y
(
qp
->
s_acked
 =ðqp->
s_ž
))

2367 
ack_dÚe
;

2368 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

2369 
¡©us
 = 
IB_WC_SUCCESS
;

2371 
Ýcode
) {

2372 
	`OP
(
ACKNOWLEDGE
):

2373 
	`OP
(
ATOMIC_ACKNOWLEDGE
):

2374 
	`OP
(
RDMA_READ_RESPONSE_FIRST
):

2375 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.aeth);

2376 ià(
Ýcode
 =ð
	`OP
(
ATOMIC_ACKNOWLEDGE
))

2377 
v®
 = 
	`ib_u64_g‘
(&
ohdr
->
u
.
©
.
©omic_ack_‘h
);

2379 
v®
 = 0;

2380 ià(!
	`do_rc_ack
(
qp
, 
«th
, 
p¢
, 
Ýcode
, 
v®
, 
rcd
) ||

2381 
Ýcode
 !ð
	`OP
(
RDMA_READ_RESPONSE_FIRST
))

2382 
ack_dÚe
;

2383 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

2384 ià(
	`uÆik–y
(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_RDMA_READ
))

2385 
ack_Ý_”r
;

2391 
qp
->
s_rdma_»ad_Ën
 = 
	`»¡¬t_sge
(&qp->
s_rdma_»ad_sge
,

2392 
wqe
, 
p¢
, 
pmtu
);

2393 
»ad_middË
;

2395 
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
):

2397 ià(
	`uÆik–y
(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
 + 1)))

2398 
ack_£q_”r
;

2399 ià(
	`uÆik–y
(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_RDMA_READ
))

2400 
ack_Ý_”r
;

2401 
»ad_middË
:

2402 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 
exŒa_by‹s
)))

2403 
ack_Ën_”r
;

2404 ià(
	`uÆik–y
(
pmtu
 >ð
qp
->
s_rdma_»ad_Ën
))

2405 
ack_Ën_”r
;

2411 
	`rvt_mod_»Œy_tim”
(
qp
);

2412 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_ACK
) {

2413 
qp
->
s_æags
 &ð~
RVT_S_WAIT_ACK
;

2414 
	`hfi1_scheduË_£nd
(
qp
);

2417 ià(
Ýcode
 =ð
	`OP
(
RDMA_READ_RESPONSE_MIDDLE
))

2418 
qp
->
s_»Œy
 = qp->
s_»Œy_út
;

2424 
qp
->
s_rdma_»ad_Ën
 -ð
pmtu
;

2425 
	`upd©e_Ï¡_p¢
(
qp
, 
p¢
);

2426 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2427 
	`rvt_cÝy_sge
(
qp
, &qp->
s_rdma_»ad_sge
,

2428 
d©a
, 
pmtu
, 
çl£
, false);

2429 
baž
;

2431 
	`OP
(
RDMA_READ_RESPONSE_ONLY
):

2432 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.aeth);

2433 ià(!
	`do_rc_ack
(
qp
, 
«th
, 
p¢
, 
Ýcode
, 0, 
rcd
))

2434 
ack_dÚe
;

2439 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
exŒa_by‹s
)))

2440 
ack_Ën_”r
;

2446 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

2447 
qp
->
s_rdma_»ad_Ën
 = 
	`»¡¬t_sge
(&qp->
s_rdma_»ad_sge
,

2448 
wqe
, 
p¢
, 
pmtu
);

2449 
»ad_Ï¡
;

2451 
	`OP
(
RDMA_READ_RESPONSE_LAST
):

2453 ià(
	`uÆik–y
(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
 + 1)))

2454 
ack_£q_”r
;

2455 ià(
	`uÆik–y
(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_RDMA_READ
))

2456 
ack_Ý_”r
;

2461 ià(
	`uÆik–y
(
Ž’
 <ð(
hdrsize
 + 
exŒa_by‹s
)))

2462 
ack_Ën_”r
;

2463 
»ad_Ï¡
:

2464 
Ž’
 -ð
hdrsize
 + 
exŒa_by‹s
;

2465 ià(
	`uÆik–y
(
Ž’
 !ð
qp
->
s_rdma_»ad_Ën
))

2466 
ack_Ën_”r
;

2467 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.aeth);

2468 
	`rvt_cÝy_sge
(
qp
, &qp->
s_rdma_»ad_sge
,

2469 
d©a
, 
Ž’
, 
çl£
, false);

2470 
	`WARN_ON
(
qp
->
s_rdma_»ad_sge
.
num_sge
);

2471 ()
	`do_rc_ack
(
qp
, 
«th
, 
p¢
,

2472 
	`OP
(
RDMA_READ_RESPONSE_LAST
), 0, 
rcd
);

2473 
ack_dÚe
;

2476 
ack_Ý_”r
:

2477 
¡©us
 = 
IB_WC_LOC_QP_OP_ERR
;

2478 
ack_”r
;

2480 
ack_£q_”r
:

2481 
ibp
 = 
	`rcd_to_Üt
(
rcd
);

2482 
	`rdma_£q_”r
(
qp
, 
ibp
, 
p¢
, 
rcd
);

2483 
ack_dÚe
;

2485 
ack_Ën_”r
:

2486 
¡©us
 = 
IB_WC_LOC_LEN_ERR
;

2487 
ack_”r
:

2488 ià(
qp
->
s_Ï¡
 =ðqp->
s_acked
) {

2489 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
¡©us
);

2490 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

2492 
ack_dÚe
:

2493 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2494 
baž
:

2496 
	}
}

2498 
šlše
 
	$rc_ÿnûl_ack
(
rvt_qp
 *
qp
)

2500 
qp
->
r_adeã»d
 = 0;

2501 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
))

2503 
	`li¡_d–_š™
(&
qp
->
r¥wa™
);

2504 
qp
->
r_æags
 &ð~
RVT_R_RSP_NAK
;

2505 
	`rvt_put_qp
(
qp
);

2506 
	}
}

2523 
nošlše
 
	$rc_rcv_”rÜ
(
ib_Ùh”_h—d”s
 *
ohdr
, *
d©a
,

2524 
rvt_qp
 *
qp
, 
u32
 
Ýcode
, u32 
p¢
,

2525 
diff
, 
hfi1_ùxtd©a
 *
rcd
)

2527 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

2528 
rvt_ack_’Œy
 *
e
;

2529 
æags
;

2530 
u8
 
´ev
;

2531 
u8
 
m¿
;

2532 
boÞ
 
Þd_»q
;

2534 
	`Œaû_hfi1_rcv_”rÜ
(
qp
, 
p¢
);

2535 ià(
diff
 > 0) {

2541 ià(!
qp
->
r_Çk_¡©e
) {

2542 
ibp
->
rvp
.
n_rc_£qÇk
++;

2543 
qp
->
r_Çk_¡©e
 = 
IB_NAK_PSN_ERROR
;

2545 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

2551 
	`rc_deã»d_ack
(
rcd
, 
qp
);

2553 
dÚe
;

2572 
e
 = 
NULL
;

2573 
Þd_»q
 = 1;

2574 
ibp
->
rvp
.
n_rc_du´eq
++;

2576 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

2578 
e
 = 
	`fšd_´ev_’Œy
(
qp
, 
p¢
, &
´ev
, &
m¿
, &
Þd_»q
);

2580 
Ýcode
) {

2581 
	`OP
(
RDMA_READ_REQUEST
): {

2582 
ib_»th
 *
»th
;

2583 
u32
 
off£t
;

2584 
u32
 
Ën
;

2590 ià(!
e
 ||ƒ->
Ýcode
 !ð
	`OP
(
RDMA_READ_REQUEST
))

2591 
uÆock_dÚe
;

2593 
»th
 = &
ohdr
->
u
.
rc
.reth;

2601 
off£t
 = 
	`d–_p¢
(
p¢
, 
e
->p¢è* 
qp
->
pmtu
;

2602 
Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

2603 ià(
	`uÆik–y
(
off£t
 + 
Ën
 !ð
e
->
rdma_sge
.
sge_Ëngth
))

2604 
uÆock_dÚe
;

2605 
	`»Ëa£_rdma_sge_mr
(
e
);

2606 ià(
Ën
 != 0) {

2607 
u32
 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

2608 
u64
 
vaddr
 = 
	`g‘_ib_»th_vaddr
(
»th
);

2609 
ok
;

2611 
ok
 = 
	`rvt_rkey_ok
(
qp
, &
e
->
rdma_sge
, 
Ën
, 
vaddr
, 
rkey
,

2612 
IB_ACCESS_REMOTE_READ
);

2613 ià(
	`uÆik–y
(!
ok
))

2614 
uÆock_dÚe
;

2616 
e
->
rdma_sge
.
vaddr
 = 
NULL
;

2617 
e
->
rdma_sge
.
Ëngth
 = 0;

2618 
e
->
rdma_sge
.
sge_Ëngth
 = 0;

2620 
e
->
p¢
 =…sn;

2621 ià(
Þd_»q
)

2622 
uÆock_dÚe
;

2623 ià(
qp
->
s_acked_ack_queue
 =ðqp->
s_ž_ack_queue
)

2624 
qp
->
s_acked_ack_queue
 = 
´ev
;

2625 
qp
->
s_ž_ack_queue
 = 
´ev
;

2629 
	`OP
(
COMPARE_SWAP
):

2630 
	`OP
(
FETCH_ADD
): {

2636 ià(!
e
 ||ƒ->
Ýcode
 !ð(
u8
)Ýcod|| 
Þd_»q
)

2637 
uÆock_dÚe
;

2638 ià(
qp
->
s_ž_ack_queue
 =ðqp->
s_acked_ack_queue
)

2639 
qp
->
s_acked_ack_queue
 = 
´ev
;

2640 
qp
->
s_ž_ack_queue
 = 
´ev
;

2649 ià(!(
p¢
 & 
IB_BTH_REQ_ACK
è|| 
Þd_»q
)

2650 
uÆock_dÚe
;

2655 ià(
m¿
 =ð
qp
->
r_h—d_ack_queue
) {

2656 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2657 
qp
->
r_Çk_¡©e
 = 0;

2658 
qp
->
r_ack_p¢
 = qp->
r_p¢
 - 1;

2659 
£nd_ack
;

2666 ià(
qp
->
s_ž_ack_queue
 =ðqp->
s_acked_ack_queue
)

2667 
qp
->
s_acked_ack_queue
 = 
m¿
;

2668 
qp
->
s_ž_ack_queue
 = 
m¿
;

2671 
qp
->
s_ack_¡©e
 = 
	`OP
(
ACKNOWLEDGE
);

2672 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

2673 
qp
->
r_Çk_¡©e
 = 0;

2674 
	`hfi1_scheduË_£nd
(
qp
);

2676 
uÆock_dÚe
:

2677 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2678 
dÚe
:

2681 
£nd_ack
:

2683 
	}
}

2685 
	$log_cÿ_ev’t
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
¦
, 
u32
 
¾id
,

2686 
u32
 
lq²
, u32 
rq²
, 
u8
 
svc_ty³
)

2688 
Ýa_hfi1_cÚg_log_ev’t_š‹º®
 *
cc_ev’t
;

2689 
æags
;

2691 ià(
¦
 >ð
OPA_MAX_SLS
)

2694 
	`¥š_lock_œq§ve
(&
µd
->
cc_log_lock
, 
æags
);

2696 
µd
->
th»shÞd_cÚg_ev’t_m­
[
¦
 / 8] |= 1 << (sl % 8);

2697 
µd
->
th»shÞd_ev’t_couÁ”
++;

2699 
cc_ev’t
 = &
µd
->
cc_ev’ts
[µd->
cc_log_idx
++];

2700 ià(
µd
->
cc_log_idx
 =ð
OPA_CONG_LOG_ELEMS
)

2701 
µd
->
cc_log_idx
 = 0;

2702 
cc_ev’t
->
lq²
 =†q² & 
RVT_QPN_MASK
;

2703 
cc_ev’t
->
rq²
 =„q² & 
RVT_QPN_MASK
;

2704 
cc_ev’t
->
¦
 = sl;

2705 
cc_ev’t
->
svc_ty³
 = svc_type;

2706 
cc_ev’t
->
¾id
 =„lid;

2708 
cc_ev’t
->
time¡amp
 = 
	`ktime_g‘_ns
() / 1024;

2710 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
cc_log_lock
, 
æags
);

2711 
	}
}

2713 
	$´oûss_beú
(
hfi1_µÜtd©a
 *
µd
, 
u8
 
¦
, 
u32
 
¾id
, u32 
lq²
,

2714 
u32
 
rq²
, 
u8
 
svc_ty³
)

2716 
cÿ_tim”
 *cca_timer;

2717 
u16
 
cùi
, 
cùi_šü
, 
cùi_tim”
, 
cùi_lim™
;

2718 
u8
 
Œigg”_th»shÞd
;

2719 
cc_¡©e
 *cc_state;

2720 
æags
;

2722 ià(
¦
 >ð
OPA_MAX_SLS
)

2725 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

2727 ià(!
cc_¡©e
)

2735 
cùi_lim™
 = 
cc_¡©e
->
cù
.ccti_limit;

2736 
cùi_šü
 = 
cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
[
¦
].
cùi_šü—£
;

2737 
cùi_tim”
 = 
cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
[
¦
].ccti_timer;

2738 
Œigg”_th»shÞd
 =

2739 
cc_¡©e
->
cÚg_£‰šg
.
’Œ›s
[
¦
].
Œigg”_th»shÞd
;

2741 
	`¥š_lock_œq§ve
(&
µd
->
cÿ_tim”_lock
, 
æags
);

2743 
cÿ_tim”
 = &
µd
->cÿ_tim”[
¦
];

2744 ià(
cÿ_tim”
->
cùi
 < 
cùi_lim™
) {

2745 ià(
cÿ_tim”
->
cùi
 + 
cùi_šü
 <ð
cùi_lim™
)

2746 
cÿ_tim”
->
cùi
 +ð
cùi_šü
;

2748 
cÿ_tim”
->
cùi
 = 
cùi_lim™
;

2749 
	`£t_lšk_g
(
µd
);

2752 
cùi
 = 
cÿ_tim”
->ccti;

2754 ià(!
	`h¹im”_aùive
(&
cÿ_tim”
->
h¹im”
)) {

2756 
n£c
 = 1024 * 
cùi_tim”
;

2758 
	`h¹im”_¡¬t
(&
cÿ_tim”
->
h¹im”
, 
	`ns_to_ktime
(
n£c
),

2759 
HRTIMER_MODE_REL_PINNED
);

2762 
	`¥š_uÆock_œq»¡Üe
(&
µd
->
cÿ_tim”_lock
, 
æags
);

2764 ià((
Œigg”_th»shÞd
 !ð0è&& (
cùi
 >=rigger_threshold))

2765 
	`log_cÿ_ev’t
(
µd
, 
¦
, 
¾id
, 
lq²
, 
rq²
, 
svc_ty³
);

2766 
	}
}

2776 
	$hfi1_rc_rcv
(
hfi1_·ck‘
 *
·ck‘
)

2778 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

2779 *
d©a
 = 
·ck‘
->
·ylßd
;

2780 
u32
 
Ž’
 = 
·ck‘
->tlen;

2781 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2782 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

2783 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

2784 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

2785 
u32
 
Ýcode
 = 
·ck‘
->opcode;

2786 
u32
 
bth1
 = 
	`be32_to_ýu
(
ohdr
->
bth
[1]);

2787 
u32
 
hdrsize
 = 
·ck‘
->
hËn
;

2788 
u32
 
p¢
 = 
	`ib_bth_g‘_p¢
(
·ck‘
->
ohdr
);

2789 
u32
 
·d
 = 
·ck‘
->pad;

2790 
ib_wc
 
wc
;

2791 
u32
 
pmtu
 = 
qp
->pmtu;

2792 
diff
;

2793 
ib_»th
 *
»th
;

2794 
æags
;

2795 
»t
;

2796 
boÞ
 
cÝy_Ï¡
 = 
çl£
, 
ãú
;

2797 
u32
 
rkey
;

2798 
u8
 
exŒa_by‹s
 = 
·d
 + 
·ck‘
->
exŒa_by‹
 + (
SIZE_OF_CRC
 << 2);

2800 
	`lockd•_as£¹_h–d
(&
qp
->
r_lock
);

2802 ià(
	`hfi1_ruc_check_hdr
(
ibp
, 
·ck‘
))

2805 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

2806 
	`Ýâ_Œigg”_cÚn_»que¡
(
qp
, 
bth1
);

2814 ià(
Ýcode
 >ð
	`OP
(
RDMA_READ_RESPONSE_FIRST
) &&

2815 
Ýcode
 <ð
	`OP
(
ATOMIC_ACKNOWLEDGE
)) {

2816 
	`rc_rcv_»¥
(
·ck‘
);

2821 
diff
 = 
	`d–_p¢
(
p¢
, 
qp
->
r_p¢
);

2822 ià(
	`uÆik–y
(
diff
)) {

2823 ià(
	`rc_rcv_”rÜ
(
ohdr
, 
d©a
, 
qp
, 
Ýcode
, 
p¢
, 
diff
, 
rcd
))

2825 
£nd_ack
;

2829 
qp
->
r_¡©e
) {

2830 
	`OP
(
SEND_FIRST
):

2831 
	`OP
(
SEND_MIDDLE
):

2832 ià(
Ýcode
 =ð
	`OP
(
SEND_MIDDLE
) ||

2833 
Ýcode
 =ð
	`OP
(
SEND_LAST
) ||

2834 
Ýcode
 =ð
	`OP
(
SEND_LAST_WITH_IMMEDIATE
) ||

2835 
Ýcode
 =ð
	`OP
(
SEND_LAST_WITH_INVALIDATE
))

2837 
Çck_šv
;

2839 
	`OP
(
RDMA_WRITE_FIRST
):

2840 
	`OP
(
RDMA_WRITE_MIDDLE
):

2841 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_MIDDLE
) ||

2842 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST
) ||

2843 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
))

2845 
Çck_šv
;

2848 ià(
Ýcode
 =ð
	`OP
(
SEND_MIDDLE
) ||

2849 
Ýcode
 =ð
	`OP
(
SEND_LAST
) ||

2850 
Ýcode
 =ð
	`OP
(
SEND_LAST_WITH_IMMEDIATE
) ||

2851 
Ýcode
 =ð
	`OP
(
SEND_LAST_WITH_INVALIDATE
) ||

2852 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_MIDDLE
) ||

2853 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST
) ||

2854 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
))

2855 
Çck_šv
;

2864 ià(
qp
->
¡©e
 =ð
IB_QPS_RTR
 && !(qp->
r_æags
 & 
RVT_R_COMM_EST
))

2865 
	`rvt_comm_e¡
(
qp
);

2868 
Ýcode
) {

2869 
	`OP
(
SEND_FIRST
):

2870 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
çl£
);

2871 ià(
»t
 < 0)

2872 
Çck_Ý_”r
;

2873 ià(!
»t
)

2874 
ºr_Çk
;

2875 
qp
->
r_rcv_Ën
 = 0;

2877 
	`OP
(
SEND_MIDDLE
):

2878 
	`OP
(
RDMA_WRITE_MIDDLE
):

2879 
£nd_middË
:

2886 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 
exŒa_by‹s
)))

2887 
Çck_šv
;

2888 
qp
->
r_rcv_Ën
 +ð
pmtu
;

2889 ià(
	`uÆik–y
(
qp
->
r_rcv_Ën
 > qp->
r_Ën
))

2890 
Çck_šv
;

2891 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
pmtu
, 
Œue
, 
çl£
);

2894 
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
):

2896 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
Œue
);

2897 ià(
»t
 < 0)

2898 
Çck_Ý_”r
;

2899 ià(!
»t
)

2900 
ºr_Çk
;

2901 
£nd_Ï¡_imm
;

2903 
	`OP
(
SEND_ONLY
):

2904 
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
):

2905 
	`OP
(
SEND_ONLY_WITH_INVALIDATE
):

2906 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
çl£
);

2907 ià(
»t
 < 0)

2908 
Çck_Ý_”r
;

2909 ià(!
»t
)

2910 
ºr_Çk
;

2911 
qp
->
r_rcv_Ën
 = 0;

2912 ià(
Ýcode
 =ð
	`OP
(
SEND_ONLY
))

2913 
no_immedŸ‹_d©a
;

2914 ià(
Ýcode
 =ð
	`OP
(
SEND_ONLY_WITH_INVALIDATE
))

2915 
£nd_Ï¡_šv
;

2917 
	`OP
(
SEND_LAST_WITH_IMMEDIATE
):

2918 
£nd_Ï¡_imm
:

2919 
wc
.
ex
.
imm_d©a
 = 
ohdr
->
u
.imm_data;

2920 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

2921 
£nd_Ï¡
;

2922 
	`OP
(
SEND_LAST_WITH_INVALIDATE
):

2923 
£nd_Ï¡_šv
:

2924 
rkey
 = 
	`be32_to_ýu
(
ohdr
->
u
.
›th
);

2925 ià(
	`rvt_šv®id©e_rkey
(
qp
, 
rkey
))

2926 
no_immedŸ‹_d©a
;

2927 
wc
.
ex
.
šv®id©e_rkey
 = 
rkey
;

2928 
wc
.
wc_æags
 = 
IB_WC_WITH_INVALIDATE
;

2929 
£nd_Ï¡
;

2930 
	`OP
(
RDMA_WRITE_LAST
):

2931 
cÝy_Ï¡
 = 
	`rvt_is_u£r_qp
(
qp
);

2933 
	`OP
(
SEND_LAST
):

2934 
no_immedŸ‹_d©a
:

2935 
wc
.
wc_æags
 = 0;

2936 
wc
.
ex
.
imm_d©a
 = 0;

2937 
£nd_Ï¡
:

2940 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
exŒa_by‹s
)))

2941 
Çck_šv
;

2943 
Ž’
 -ð(
hdrsize
 + 
exŒa_by‹s
);

2944 
wc
.
by‹_Ën
 = 
Ž’
 + 
qp
->
r_rcv_Ën
;

2945 ià(
	`uÆik–y
(
wc
.
by‹_Ën
 > 
qp
->
r_Ën
))

2946 
Çck_šv
;

2947 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
Ž’
, 
Œue
, 
cÝy_Ï¡
);

2948 
	`rvt_put_ss
(&
qp
->
r_sge
);

2949 
qp
->
r_m¢
++;

2950 ià(!
	`__‹¡_ªd_þ—r_b™
(
RVT_R_WRID_VALID
, &
qp
->
r_aæags
))

2952 
wc
.
wr_id
 = 
qp
->
r_wr_id
;

2953 
wc
.
¡©us
 = 
IB_WC_SUCCESS
;

2954 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
) ||

2955 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
))

2956 
wc
.
Ýcode
 = 
IB_WC_RECV_RDMA_WITH_IMM
;

2958 
wc
.
Ýcode
 = 
IB_WC_RECV
;

2959 
wc
.
qp
 = &qp->
ibqp
;

2960 
wc
.
¤c_qp
 = 
qp
->
»mÙe_q²
;

2961 
wc
.
¦id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
è& 
U16_MAX
;

2973 
wc
.
¦
 = 
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
);

2975 
wc
.
v’dÜ_”r
 = 0;

2976 
wc
.
pkey_šdex
 = 0;

2977 
wc
.
dlid_·th_b™s
 = 0;

2978 
wc
.
pÜt_num
 = 0;

2980 
	`rvt_»cv_cq
(
qp
, &
wc
, 
	`ib_bth_is_sÞic™ed
(
ohdr
));

2983 
	`OP
(
RDMA_WRITE_ONLY
):

2984 
cÝy_Ï¡
 = 
	`rvt_is_u£r_qp
(
qp
);

2986 
	`OP
(
RDMA_WRITE_FIRST
):

2987 
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
):

2988 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 & 
IB_ACCESS_REMOTE_WRITE
)))

2989 
Çck_šv
;

2991 
»th
 = &
ohdr
->
u
.
rc
.reth;

2992 
qp
->
r_Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

2993 
qp
->
r_rcv_Ën
 = 0;

2994 
qp
->
r_sge
.
sg_li¡
 = 
NULL
;

2995 ià(
qp
->
r_Ën
 != 0) {

2996 
u32
 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

2997 
u64
 
vaddr
 = 
	`g‘_ib_»th_vaddr
(
»th
);

2998 
ok
;

3001 
ok
 = 
	`rvt_rkey_ok
(
qp
, &qp->
r_sge
.
sge
, qp->
r_Ën
, 
vaddr
,

3002 
rkey
, 
IB_ACCESS_REMOTE_WRITE
);

3003 ià(
	`uÆik–y
(!
ok
))

3004 
Çck_acc
;

3005 
qp
->
r_sge
.
num_sge
 = 1;

3007 
qp
->
r_sge
.
num_sge
 = 0;

3008 
qp
->
r_sge
.
sge
.
mr
 = 
NULL
;

3009 
qp
->
r_sge
.
sge
.
vaddr
 = 
NULL
;

3010 
qp
->
r_sge
.
sge
.
Ëngth
 = 0;

3011 
qp
->
r_sge
.
sge
.
sge_Ëngth
 = 0;

3013 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_FIRST
))

3014 
£nd_middË
;

3015 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY
))

3016 
no_immedŸ‹_d©a
;

3017 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
Œue
);

3018 ià(
»t
 < 0)

3019 
Çck_Ý_”r
;

3020 ià(!
»t
) {

3022 
	`rvt_put_ss
(&
qp
->
r_sge
);

3023 
ºr_Çk
;

3025 
wc
.
ex
.
imm_d©a
 = 
ohdr
->
u
.
rc
.imm_data;

3026 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

3027 
£nd_Ï¡
;

3029 
	`OP
(
RDMA_READ_REQUEST
): {

3030 
rvt_ack_’Œy
 *
e
;

3031 
u32
 
Ën
;

3032 
u8
 
Ãxt
;

3034 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 & 
IB_ACCESS_REMOTE_READ
)))

3035 
Çck_šv
;

3036 
Ãxt
 = 
qp
->
r_h—d_ack_queue
 + 1;

3038 ià(
Ãxt
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

3039 
Ãxt
 = 0;

3040 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

3041 ià(
	`uÆik–y
(
Ãxt
 =ð
qp
->
s_acked_ack_queue
)) {

3042 ià(!
qp
->
s_ack_queue
[
Ãxt
].
£Á
)

3043 
Çck_šv_uÆck
;

3044 
	`upd©e_ack_queue
(
qp
, 
Ãxt
);

3046 
e
 = &
qp
->
s_ack_queue
[qp->
r_h—d_ack_queue
];

3047 
	`»Ëa£_rdma_sge_mr
(
e
);

3048 
»th
 = &
ohdr
->
u
.
rc
.reth;

3049 
Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

3050 ià(
Ën
) {

3051 
u32
 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

3052 
u64
 
vaddr
 = 
	`g‘_ib_»th_vaddr
(
»th
);

3053 
ok
;

3056 
ok
 = 
	`rvt_rkey_ok
(
qp
, &
e
->
rdma_sge
, 
Ën
, 
vaddr
,

3057 
rkey
, 
IB_ACCESS_REMOTE_READ
);

3058 ià(
	`uÆik–y
(!
ok
))

3059 
Çck_acc_uÆck
;

3064 
qp
->
r_p¢
 +ð
	`rvt_div_mtu
(qp, 
Ën
 - 1);

3066 
e
->
rdma_sge
.
mr
 = 
NULL
;

3067 
e
->
rdma_sge
.
vaddr
 = 
NULL
;

3068 
e
->
rdma_sge
.
Ëngth
 = 0;

3069 
e
->
rdma_sge
.
sge_Ëngth
 = 0;

3071 
e
->
Ýcode
 = opcode;

3072 
e
->
£Á
 = 0;

3073 
e
->
p¢
 =…sn;

3074 
e
->
Í¢
 = 
qp
->
r_p¢
;

3080 
qp
->
r_m¢
++;

3081 
qp
->
r_p¢
++;

3082 
qp
->
r_¡©e
 = 
Ýcode
;

3083 
qp
->
r_Çk_¡©e
 = 0;

3084 
qp
->
r_h—d_ack_queue
 = 
Ãxt
;

3085 
q´iv
->
r_tid_®loc
 = 
qp
->
r_h—d_ack_queue
;

3088 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

3089 ià(
ãú
)

3090 
qp
->
s_æags
 |ð
RVT_S_ECN
;

3091 
	`hfi1_scheduË_£nd
(
qp
);

3093 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3097 
	`OP
(
COMPARE_SWAP
):

3098 
	`OP
(
FETCH_ADD
): {

3099 
ib_©omic_‘h
 *
©‘h
 = &
ohdr
->
u
.
©omic_‘h
;

3100 
u64
 
vaddr
 = 
	`g‘_ib_©‘h_vaddr
(
©‘h
);

3101 
boÞ
 
Ýâ
 = 
Ýcode
 =ð
	`OP
(
COMPARE_SWAP
) &&

3102 
vaddr
 =ð
HFI1_VERBS_E_ATOMIC_VADDR
;

3103 
rvt_ack_’Œy
 *
e
;

3104 
©omic64_t
 *
maddr
;

3105 
u64
 
sd©a
;

3106 
u32
 
rkey
;

3107 
u8
 
Ãxt
;

3109 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 & 
IB_ACCESS_REMOTE_ATOMIC
) &&

3110 !
Ýâ
))

3111 
Çck_šv
;

3112 
Ãxt
 = 
qp
->
r_h—d_ack_queue
 + 1;

3113 ià(
Ãxt
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

3114 
Ãxt
 = 0;

3115 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

3116 ià(
	`uÆik–y
(
Ãxt
 =ð
qp
->
s_acked_ack_queue
)) {

3117 ià(!
qp
->
s_ack_queue
[
Ãxt
].
£Á
)

3118 
Çck_šv_uÆck
;

3119 
	`upd©e_ack_queue
(
qp
, 
Ãxt
);

3121 
e
 = &
qp
->
s_ack_queue
[qp->
r_h—d_ack_queue
];

3122 
	`»Ëa£_rdma_sge_mr
(
e
);

3124 ià(
Ýâ
) {

3125 
	`Ýâ_cÚn_»¥Ú£
(
qp
, 
e
, 
©‘h
);

3126 
ack
;

3128 ià(
	`uÆik–y
(
vaddr
 & ((
u64
) - 1)))

3129 
Çck_šv_uÆck
;

3130 
rkey
 = 
	`be32_to_ýu
(
©‘h
->rkey);

3132 ià(
	`uÆik–y
(!
	`rvt_rkey_ok
(
qp
, &qp->
r_sge
.
sge
, (
u64
),

3133 
vaddr
, 
rkey
,

3134 
IB_ACCESS_REMOTE_ATOMIC
)))

3135 
Çck_acc_uÆck
;

3137 
maddr
 = (
©omic64_t
 *)
qp
->
r_sge
.
sge
.
vaddr
;

3138 
sd©a
 = 
	`g‘_ib_©‘h_sw­
(
©‘h
);

3139 
e
->
©omic_d©a
 = (
Ýcode
 =ð
	`OP
(
FETCH_ADD
)) ?

3140 (
u64
)
	`©omic64_add_»tuº
(
sd©a
, 
maddr
) - sdata :

3141 (
u64
)
	`cmpxchg
((u64 *)
qp
->
r_sge
.
sge
.
vaddr
,

3142 
	`g‘_ib_©‘h_com·»
(
©‘h
),

3143 
sd©a
);

3144 
	`rvt_put_mr
(
qp
->
r_sge
.
sge
.
mr
);

3145 
qp
->
r_sge
.
num_sge
 = 0;

3146 
ack
:

3147 
e
->
Ýcode
 = opcode;

3148 
e
->
£Á
 = 0;

3149 
e
->
p¢
 =…sn;

3150 
e
->
Í¢
 = 
p¢
;

3151 
qp
->
r_m¢
++;

3152 
qp
->
r_p¢
++;

3153 
qp
->
r_¡©e
 = 
Ýcode
;

3154 
qp
->
r_Çk_¡©e
 = 0;

3155 
qp
->
r_h—d_ack_queue
 = 
Ãxt
;

3156 
q´iv
->
r_tid_®loc
 = 
qp
->
r_h—d_ack_queue
;

3159 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

3160 ià(
ãú
)

3161 
qp
->
s_æags
 |ð
RVT_S_ECN
;

3162 
	`hfi1_scheduË_£nd
(
qp
);

3164 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3170 
Çck_šv
;

3172 
qp
->
r_p¢
++;

3173 
qp
->
r_¡©e
 = 
Ýcode
;

3174 
qp
->
r_ack_p¢
 = 
p¢
;

3175 
qp
->
r_Çk_¡©e
 = 0;

3177 ià(
p¢
 & 
IB_BTH_REQ_ACK
 || 
ãú
) {

3178 ià(
·ck‘
->
numpkt
 =ð0 || 
ãú
 ||

3179 
qp
->
r_adeã»d
 >ð
HFI1_PSN_CREDIT
) {

3180 
	`rc_ÿnûl_ack
(
qp
);

3181 
£nd_ack
;

3183 
qp
->
r_adeã»d
++;

3184 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3188 
ºr_Çk
:

3189 
qp
->
r_Çk_¡©e
 = qp->
r_mš_ºr_tim”
 | 
IB_RNR_NAK
;

3190 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3192 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3195 
Çck_Ý_”r
:

3196 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

3197 
qp
->
r_Çk_¡©e
 = 
IB_NAK_REMOTE_OPERATIONAL_ERROR
;

3198 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3200 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3203 
Çck_šv_uÆck
:

3204 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3205 
Çck_šv
:

3206 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

3207 
qp
->
r_Çk_¡©e
 = 
IB_NAK_INVALID_REQUEST
;

3208 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3210 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3213 
Çck_acc_uÆck
:

3214 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3215 
Çck_acc
:

3216 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_PROT_ERR
);

3217 
qp
->
r_Çk_¡©e
 = 
IB_NAK_REMOTE_ACCESS_ERROR
;

3218 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3219 
£nd_ack
:

3220 
	`hfi1_£nd_rc_ack
(
·ck‘
, 
ãú
);

3221 
	}
}

3223 
	$hfi1_rc_hd»¼
(

3224 
hfi1_ùxtd©a
 *
rcd
,

3225 
hfi1_·ck‘
 *
·ck‘
,

3226 
rvt_qp
 *
qp
)

3228 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

3229 
diff
;

3230 
u32
 
Ýcode
;

3231 
u32
 
p¢
;

3233 ià(
	`hfi1_ruc_check_hdr
(
ibp
, 
·ck‘
))

3236 
p¢
 = 
	`ib_bth_g‘_p¢
(
·ck‘
->
ohdr
);

3237 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
·ck‘
->
ohdr
);

3240 ià(
Ýcode
 < 
IB_OPCODE_RC_RDMA_READ_RESPONSE_FIRST
) {

3241 
diff
 = 
	`d–_p¢
(
p¢
, 
qp
->
r_p¢
);

3242 ià(!
qp
->
r_Çk_¡©e
 && 
diff
 >= 0) {

3243 
ibp
->
rvp
.
n_rc_£qÇk
++;

3244 
qp
->
r_Çk_¡©e
 = 
IB_NAK_PSN_ERROR
;

3246 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3255 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3258 
	}
}

	@rc.h

48 #iâdeà
HFI1_RC_H


49 
	#HFI1_RC_H


	)

52 
	#OP
(
x
è
IB_OPCODE_RC_
##
	)
x

54 
šlše
 
	$upd©e_ack_queue
(
rvt_qp
 *
qp
, 
n
)

56 
Ãxt
;

58 
Ãxt
 = 
n
 + 1;

59 ià(
Ãxt
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

60 
Ãxt
 = 0;

61 
qp
->
s_ž_ack_queue
 = 
Ãxt
;

62 
qp
->
s_acked_ack_queue
 = 
Ãxt
;

63 
qp
->
s_ack_¡©e
 = 
	`OP
(
ACKNOWLEDGE
);

64 
	}
}

66 
šlše
 
	$rc_deã»d_ack
(
hfi1_ùxtd©a
 *
rcd
,

67 
rvt_qp
 *
qp
)

69 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
)) {

70 
qp
->
r_æags
 |ð
RVT_R_RSP_NAK
;

71 
	`rvt_g‘_qp
(
qp
);

72 
	`li¡_add_ž
(&
qp
->
r¥wa™
, &
rcd
->
qp_wa™_li¡
);

74 
	}
}

76 
šlše
 
rvt_ack_’Œy
 *
	$fšd_´ev_’Œy
(
rvt_qp
 *
qp
, 
u32
 
p¢
,

77 
u8
 *
´ev
, u8 *
´ev_ack
,

78 
boÞ
 *
scheduËd
)

79 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

81 
rvt_ack_’Œy
 *
e
 = 
NULL
;

82 
u8
 
i
, 
p
;

83 
boÞ
 
s
 = 
Œue
;

85 
i
 = 
qp
->
r_h—d_ack_queue
; ; i = 
p
) {

86 ià(
i
 =ð
qp
->
s_ž_ack_queue
)

87 
s
 = 
çl£
;

88 ià(
i
)

89 
p
 = 
i
 - 1;

91 
p
 = 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
));

92 ià(
p
 =ð
qp
->
r_h—d_ack_queue
) {

93 
e
 = 
NULL
;

96 
e
 = &
qp
->
s_ack_queue
[
p
];

97 ià(!
e
->
Ýcode
) {

98 
e
 = 
NULL
;

101 ià(
	`cmp_p¢
(
p¢
, 
e
->psn) >= 0) {

102 ià(
p
 =ð
qp
->
s_ž_ack_queue
 &&

103 
	`cmp_p¢
(
p¢
, 
e
->
Í¢
) <= 0)

104 
s
 = 
çl£
;

108 ià(
´ev
)

109 *
´ev
 = 
p
;

110 ià(
´ev_ack
)

111 *
´ev_ack
 = 
i
;

112 ià(
scheduËd
)

113 *
scheduËd
 = 
s
;

114  
e
;

115 
	}
}

117 
šlše
 
u32
 
	$»¡¬t_sge
(
rvt_sge_¡©e
 *
ss
, 
rvt_swqe
 *
wqe
,

118 
u32
 
p¢
, u32 
pmtu
)

120 
u32
 
Ën
;

122 
Ën
 = 
	`d–_p¢
(
p¢
, 
wqe
->p¢è* 
pmtu
;

123 
ss
->
sge
 = 
wqe
->
sg_li¡
[0];

124 
ss
->
sg_li¡
 = 
wqe
->sg_list + 1;

125 
ss
->
num_sge
 = 
wqe
->
wr
.num_sge;

126 
ss
->
tÙ®_Ën
 = 
wqe
->
Ëngth
;

127 
	`rvt_sk_sge
(
ss
, 
Ën
, 
çl£
);

128  
wqe
->
Ëngth
 - 
Ën
;

129 
	}
}

131 
šlše
 
	$»Ëa£_rdma_sge_mr
(
rvt_ack_’Œy
 *
e
)

133 ià(
e
->
rdma_sge
.
mr
) {

134 
	`rvt_put_mr
(
e
->
rdma_sge
.
mr
);

135 
e
->
rdma_sge
.
mr
 = 
NULL
;

137 
	}
}

139 
do_rc_ack
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
, 
Ýcode
, 
u64
 
v®
,

140 
hfi1_ùxtd©a
 *
rcd
);

141 
rvt_swqe
 *
do_rc_com¶‘iÚ
(
rvt_qp
 *
qp
, rvt_swq*
wqe
,

142 
hfi1_ibpÜt
 *
ibp
);

	@rcva.c

49 
	~<lšux/”r.h
>

50 
	~<lšux/”ºo.h
>

52 
	~"rcva.h
"

53 
	~"hfi.h
"

55 
	#GROUP_SIZE
 
RCV_INCREMENT


	)

56 
	#MAX_BUFFER_SIZE
 (256 * 1024)

	)

57 
	#MAX_PER_CONTEXT
 (2048 / 
GROUP_SIZE
)

	)

58 
	#MIN_NEE_CONTEXTS
 2

	)

59 
	#MIN_NEE_BUFFERS
 1024

	)

60 
	#MIN_TEE_BUFFERS
 2

	)

61 
	#MIN_EE_BUFFERS
 1024

	)

89 
	$rcva_size
(
rcva
 *
r
,

90 
rcva_ü—‹_©Œ
 *
©Œ
,

91 
u16
 *
tÙ®_“
,

92 
u16
 *
tÙ®_Ã
,

93 
u16
 *
tÙ®_‹
)

95 
hfi1_devd©a
 *
dd
 = 
r
->dd;

96 
u32
 
groups
 = 
	`ch_rcv_¬¿y_couÁ
(
dd
è/ 
GROUP_SIZE
;

98 
u32
 
“_cÚ‹xts
 = 
©Œ
->ee_contexts;

99 
u32
 
Ã_cÚ‹xts
 = 
©Œ
->ne_contexts;

100 
u32
 
‹_cÚ‹xts
 = 
©Œ
->te_contexts;

103 
u32
 
“_groups
, 
tÙ®_“_groups
;

104 
u32
 
‹_groups
, 
tÙ®_‹_groups
;

105 
u32
 
Ã_groups
, 
tÙ®_Ã_groups
;

106 
u32
 
exŒa_groups
;

107 
boÞ
 
muÉi_·ck‘
 = 
©Œ
->multi_packet;

110 
‹_groups
 = 
‹_cÚ‹xts
 ?

111 
	`mš_t
(
u32
, 
groups
 / 
‹_cÚ‹xts
, 
MAX_PER_CONTEXT
) : 0;

112 
tÙ®_‹_groups
 = 
‹_groups
 * 
‹_cÚ‹xts
;

113 
	`dd_dev_dbg
(
dd
, "ee_contexts %ue_contexts %u‚e_contexts %u\n",

114 
“_cÚ‹xts
, 
‹_cÚ‹xts
, 
Ã_cÚ‹xts
);

116 
“_groups
 = 
©Œ
->
max_bufãrs
 / 
GROUP_SIZE
;

117 
“_groups
 = 
	`mš_t
(
u32
,ƒe_groups, 
MAX_PER_CONTEXT
);

119 
tÙ®_“_groups
 = 
“_groups
 * 
“_cÚ‹xts
;

121 
Ã_groups
 = 
MAX_PER_CONTEXT
;

122 
tÙ®_Ã_groups
 = 
Ã_groups
 * 
Ã_cÚ‹xts
;

124 
	`dd_dev_dbg
(
dd
, "initial sizes:ƒe_groups %uotal_ee_groups %u‚e_groups %uotal_ne_groups %ue_groups %uotal_te_groups %u\n",

125 
“_groups
, 
tÙ®_“_groups
,

126 
Ã_groups
, 
tÙ®_Ã_groups
,

127 
‹_groups
, 
tÙ®_‹_groups
);

128 
Œue
) {

129 ià((
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
) <=

130 
groups
)

133 ià(
Ã_cÚ‹xts
 > 
MIN_NEE_CONTEXTS
) {

134 
Ã_cÚ‹xts
 /= 2;

135 
tÙ®_Ã_groups
 = 
Ã_groups
 * 
Ã_cÚ‹xts
;

137 ià((
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
) <=

138 
groups
)

140 ià(
Ã_groups
 > 
MIN_NEE_BUFFERS
 / 
GROUP_SIZE
) {

141 
Ã_groups
 /= 2;

142 
tÙ®_Ã_groups
 = 
Ã_groups
 * 
Ã_cÚ‹xts
;

144 ià((
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
) <=

145 
groups
)

147 ià(!
muÉi_·ck‘
) {

148 ià(
“_groups
 > 
MIN_EE_BUFFERS
)

149 
“_groups
 /= 2;

150 
tÙ®_“_groups
 = 
“_groups
 * 
“_cÚ‹xts
;

152 ià((
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
) <=

153 
groups
)

155 ià(
‹_groups
 > 
MIN_TEE_BUFFERS
)

156 
tÙ®_‹_groups
 = --
‹_groups
 * 
‹_cÚ‹xts
;

157 ià((
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
) <=

158 
groups
)

160 
	`dd_dev_dbg
(
dd
, "continue withƒe_groups %u‚e_groups %ue_groups %u‚e_contexts %u\n",

161 
“_groups
, 
Ã_groups
, 
‹_groups
, 
Ã_cÚ‹xts
);

163 
	`dd_dev_dbg
(
dd
, "after„eductions:ƒe_groups %uotal_ee_groups %u‚e_groups %uotal_ne_groups %ue_groups %uotal_te_groups %u\n",

164 
“_groups
, 
tÙ®_“_groups
,

165 
Ã_groups
, 
tÙ®_Ã_groups
,

166 
‹_groups
, 
tÙ®_‹_groups
);

167 
exŒa_groups
 = 
groups
 -

168 (
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
);

169 
	`dd_dev_dbg
(
dd
, "exŒa_group %u\n", 
exŒa_groups
);

171 ià(
‹_cÚ‹xts
) {

172 
‹_groups
 +ð
exŒa_groups
 / 
‹_cÚ‹xts
;

173 
‹_groups
 = 
	`mš_t
(
u32
, 
MAX_PER_CONTEXT
,e_groups);

174 
tÙ®_‹_groups
 = 
‹_groups
 * 
‹_cÚ‹xts
;

176 
exŒa_groups
 = 
groups
 -

177 (
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
);

179 ià(
Ã_cÚ‹xts
) {

180 
Ã_groups
 +ð
exŒa_groups
 / 
Ã_cÚ‹xts
;

181 
Ã_groups
 = 
	`mš_t
(
u32
, 
MAX_PER_CONTEXT
,‚e_groups);

182 
tÙ®_Ã_groups
 = 
Ã_groups
 * 
Ã_cÚ‹xts
;

184 
exŒa_groups
 = 
groups
 -

185 (
tÙ®_“_groups
 + 
tÙ®_‹_groups
 + 
tÙ®_Ã_groups
);

186 
“_groups
 +ð
exŒa_groups
 / 
“_cÚ‹xts
;

187 
	`dd_dev_dbg
(
dd
, "final sizing:‚e_contexts %uƒe_groups %uotal_ee_groups %u‚e_groups %uotal_ne_groups %ue_groups %uotal_te_groups %uƒxtra_groups %u\n",

188 
Ã_cÚ‹xts
, 
“_groups
, 
tÙ®_“_groups
,

189 
Ã_groups
, 
tÙ®_Ã_groups
,

190 
‹_groups
, 
tÙ®_‹_groups
, 
exŒa_groups
);

192 *
tÙ®_“
 = 
tÙ®_“_groups
;

193 *
tÙ®_Ã
 = 
tÙ®_Ã_groups
;

194 *
tÙ®_‹
 = 
tÙ®_‹_groups
;

196 
r
->
“_size
 = 
“_groups
;

197 
r
->
Ã_size
 = 
Ã_groups
;

198 
r
->
‹_size
 = 
‹_groups
;

199 
r
->
Ãtdev_cÚ‹xts
 = 
Ã_cÚ‹xts
;

200 
	}
}

219 
rcva
 *
	$rcva_ü—‹
(
hfi1_devd©a
 *
dd
,

220 
rcva_ü—‹_©Œ
 *
©Œ
)

222 
rcva
 *
r
;

223 
u16
 
tÙ®_“
, 
tÙ®_Ã
, 
tÙ®_‹
;

225 
u16
 
¡¬t_“
 = 0, 
¡¬t_Ã
, 
¡¬t_‹
;

227 
r
 = 
	`kz®loc_node
((*r), 
GFP_KERNEL
, 
dd
->
node
);

228 ià(!
r
)

229  
	`ERR_PTR
(-
ENOMEM
);

230 
r
->
dd
 = dd;

231 
	`rcva_size
(
r
, 
©Œ
, &
tÙ®_“
, &
tÙ®_Ã
, &
tÙ®_‹
);

232 
¡¬t_Ã
 = 
tÙ®_“
;

233 
¡¬t_‹
 = 
tÙ®_“
 + 
tÙ®_Ã
;

235 
r
->
“_poÞ
 = 
	`g’_poÞ_ü—‹
(0, 
dd
->
node
);

236 ià(!
r
->
“_poÞ
)

237 
baž
;

238 ià(
tÙ®_“
 &&

239 
	`g’_poÞ_add
(
r
->
“_poÞ
, 
¡¬t_“
 + 1, 
tÙ®_“
, 
dd
->
node
))

240 
baž
;

242 ià(
tÙ®_Ã
) {

243 
r
->
Ã_poÞ
 = 
	`g’_poÞ_ü—‹
(0, 
dd
->
node
);

244 ià(!
r
->
Ã_poÞ
)

245 
baž
;

246 ià(
	`g’_poÞ_add
(
r
->
Ã_poÞ
, 
¡¬t_Ã
 + 1, 
tÙ®_Ã
, 
dd
->
node
))

247 
baž
;

250 ià(
tÙ®_‹
) {

251 
r
->
‹_poÞ
 = 
	`g’_poÞ_ü—‹
(0, 
dd
->
node
);

252 ià(!
r
->
‹_poÞ
)

253 
baž
;

254 ià(
	`g’_poÞ_add
(
r
->
‹_poÞ
, 
¡¬t_‹
 + 1, 
tÙ®_‹
, 
dd
->
node
))

255 
baž
;

258  
r
;

259 
baž
:

260 
	`rcva_de¡roy
(
r
);

261  
	`ERR_PTR
(-
ENOMEM
);

262 
	}
}

268 
	$rcva_de¡roy
(
rcva
 *
r
)

270 ià(!
r
)

272 ià(
r
->
‹_poÞ
)

273 
	`g’_poÞ_de¡roy
(
r
->
‹_poÞ
);

274 
r
->
‹_poÞ
 = 
NULL
;

275 ià(
r
->
Ã_poÞ
)

276 
	`g’_poÞ_de¡roy
(
r
->
Ã_poÞ
);

277 
r
->
Ã_poÞ
 = 
NULL
;

278 ià(
r
->
“_poÞ
)

279 
	`g’_poÞ_de¡roy
(
r
->
“_poÞ
);

280 
r
->
“_poÞ
 = 
NULL
;

281 
	`kä“
(
r
);

282 
	}
}

289 
	$rvÿ_®loc_“_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

291 
»t
;

293 
»t
 = 
	`g’_poÞ_®loc
(
r
->
“_poÞ
,„->
“_size
);

294 ià(!
»t
)

295  -
ENOMEM
;

297 
s
->
ba£
 = 
»t
 - 1;

298 
s
->
size
 = 
r
->
“_size
;

300 
	}
}

307 
	$rvÿ_®loc_Ã_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

309 
»t
;

311 
»t
 = 
	`g’_poÞ_®loc
(
r
->
Ã_poÞ
,„->
Ã_size
);

312 ià(!
»t
)

313  -
ENOMEM
;

315 
s
->
ba£
 = 
»t
 - 1;

316 
s
->
size
 = 
r
->
Ã_size
;

318 
	}
}

325 
	$rvÿ_®loc_‹_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

327 
»t
;

329 
»t
 = 
	`g’_poÞ_®loc
(
r
->
‹_poÞ
,„->
‹_size
);

330 ià(!
»t
)

331  -
ENOMEM
;

333 
s
->
ba£
 = 
»t
 - 1;

334 
s
->
size
 = 
r
->
‹_size
;

336 
	}
}

343 
	$rvÿ_ä“_“_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

345 ià(
s
->
size
)

346 
	`g’_poÞ_ä“
(
r
->
“_poÞ
, 
s
->
ba£
 + 1, s->
size
);

347 
s
->
size
 = 0;

348 
	}
}

355 
	$rvÿ_ä“_Ã_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

357 ià(
s
->
size
)

358 
	`g’_poÞ_ä“
(
r
->
Ã_poÞ
, 
s
->
ba£
 + 1, s->
size
);

359 
s
->
size
 = 0;

360 
	}
}

367 
	$rvÿ_ä“_‹_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
)

369 ià(
s
->
size
)

370 
	`g’_poÞ_ä“
(
r
->
‹_poÞ
, 
s
->
ba£
 + 1, s->
size
);

371 
s
->
size
 = 0;

372 
	}
}

	@rcva.h

49 #iâdeà
_RCVA_H


50 
	#_RCVA_H


	)

52 
	~<lšux/ty³s.h
>

53 
	~<lšux/¥šlock_ty³s.h
>

54 
	~<lšux/g’®loc.h
>

68 
	ghfi1_devd©a
;

69 
	srcva
 {

70 
hfi1_devd©a
 *
	mdd
;

71 
g’_poÞ
 *
	m“_poÞ
;

72 
g’_poÞ
 *
	mÃ_poÞ
;

73 
g’_poÞ
 *
	m‹_poÞ
;

74 
u16
 
	m“_size
;

75 
u16
 
	mÃ_size
;

76 
u16
 
	m‹_size
;

77 
u8
 
	mÃtdev_cÚ‹xts
;

89 
	srcva_ü—‹_©Œ
 {

90 
u16
 
	mmax_bufãrs
;

91 
u8
 
	m‹_cÚ‹xts
;

92 
u8
 
	mÃ_cÚ‹xts
;

93 
u8
 
	m“_cÚ‹xts
;

94 
boÞ
 
	mmuÉi_·ck‘
;

102 
	srcva_¦iû
 {

103 
u16
 
	mba£
;

104 
u16
 
	msize
;

107 
rcva
 *
rcva_ü—‹
(
hfi1_devd©a
 *
dd
,

108 
rcva_ü—‹_©Œ
 *
©Œ
);

109 
rcva_de¡roy
(
rcva
 *
r
);

111 
rvÿ_®loc_“_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

112 
rvÿ_®loc_Ã_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

113 
rvÿ_®loc_‹_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

115 
rvÿ_ä“_“_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

116 
rvÿ_ä“_Ã_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

117 
rvÿ_ä“_‹_¦iû
(
rcva
 *
r
, 
rcva_¦iû
 *
s
);

	@ruc.c

48 
	~<lšux/¥šlock.h
>

50 
	~"hfi.h
"

51 
	~"mad.h
"

52 
	~"qp.h
"

53 
	~"v”bs_tx»q.h
"

54 
	~"Œaû.h
"

56 
	$gid_ok
(
ib_gid
 *
gid
, 
__be64
 
gid_´efix
, __be64 
id
)

58  (
gid
->
glob®
.
š‹rçû_id
 =ð
id
 &&

59 (
gid
->
glob®
.
subÃt_´efix
 =ð
gid_´efix
 ||

60 
gid
->
glob®
.
subÃt_´efix
 =ð
IB_DEFAULT_GID_PREFIX
));

61 
	}
}

69 
	$hfi1_ruc_check_hdr
(
hfi1_ibpÜt
 *
ibp
, 
hfi1_·ck‘
 *
·ck‘
)

71 
__be64
 
guid
;

72 
æags
;

73 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

74 
u8
 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
)];

75 
u32
 
dlid
 = 
·ck‘
->dlid;

76 
u32
 
¦id
 = 
·ck‘
->slid;

77 
u32
 
¦
 = 
·ck‘
->sl;

78 
boÞ
 
mig¿‹d
 = 
·ck‘
->migrated;

79 
u16
 
pkey
 = 
·ck‘
->pkey;

81 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_ARMED
 && 
mig¿‹d
) {

82 ià(!
·ck‘
->
grh
) {

83 ià((
	`rdma_ah_g‘_ah_æags
(&
qp
->
®t_ah_©Œ
) &

84 
IB_AH_GRH
) &&

85 (
·ck‘
->
‘y³
 !ð
RHF_RCV_TYPE_BYPASS
))

88 cÚ¡ 
ib_glob®_rou‹
 *
grh
;

90 ià(!(
	`rdma_ah_g‘_ah_æags
(&
qp
->
®t_ah_©Œ
) &

91 
IB_AH_GRH
))

93 
grh
 = 
	`rdma_ah_»ad_grh
(&
qp
->
®t_ah_©Œ
);

94 
guid
 = 
	`g‘_sguid
(
ibp
, 
grh
->
sgid_šdex
);

95 ià(!
	`gid_ok
(&
·ck‘
->
grh
->
dgid
, 
ibp
->
rvp
.
gid_´efix
,

96 
guid
))

98 ià(!
	`gid_ok
(

99 &
·ck‘
->
grh
->
sgid
,

100 
grh
->
dgid
.
glob®
.
subÃt_´efix
,

101 
grh
->
dgid
.
glob®
.
š‹rçû_id
))

104 ià(
	`uÆik–y
(
	`rcv_pkey_check
(
	`µd_äom_ibp
(
ibp
), 
pkey
,

105 
sc5
, 
¦id
))) {

106 
	`hfi1_bad_pkey
(
ibp
, 
pkey
, 
¦
, 0, 
qp
->
ibqp
.
qp_num
,

107 
¦id
, 
dlid
);

111 ià(
¦id
 !ð
	`rdma_ah_g‘_dlid
(&
qp
->
®t_ah_©Œ
) ||

112 
	`µd_äom_ibp
(
ibp
)->
pÜt
 !=

113 
	`rdma_ah_g‘_pÜt_num
(&
qp
->
®t_ah_©Œ
))

115 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

116 
	`hfi1_mig¿‹_qp
(
qp
);

117 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

119 ià(!
·ck‘
->
grh
) {

120 ià((
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
) &

121 
IB_AH_GRH
) &&

122 (
·ck‘
->
‘y³
 !ð
RHF_RCV_TYPE_BYPASS
))

125 cÚ¡ 
ib_glob®_rou‹
 *
grh
;

127 ià(!(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
) &

128 
IB_AH_GRH
))

130 
grh
 = 
	`rdma_ah_»ad_grh
(&
qp
->
»mÙe_ah_©Œ
);

131 
guid
 = 
	`g‘_sguid
(
ibp
, 
grh
->
sgid_šdex
);

132 ià(!
	`gid_ok
(&
·ck‘
->
grh
->
dgid
, 
ibp
->
rvp
.
gid_´efix
,

133 
guid
))

135 ià(!
	`gid_ok
(

136 &
·ck‘
->
grh
->
sgid
,

137 
grh
->
dgid
.
glob®
.
subÃt_´efix
,

138 
grh
->
dgid
.
glob®
.
š‹rçû_id
))

141 ià(
	`uÆik–y
(
	`rcv_pkey_check
(
	`µd_äom_ibp
(
ibp
), 
pkey
,

142 
sc5
, 
¦id
))) {

143 
	`hfi1_bad_pkey
(
ibp
, 
pkey
, 
¦
, 0, 
qp
->
ibqp
.
qp_num
,

144 
¦id
, 
dlid
);

148 ià((
¦id
 !ð
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
)) ||

149 
	`µd_äom_ibp
(
ibp
)->
pÜt
 !ð
qp
->
pÜt_num
)

151 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_REARM
 && !
mig¿‹d
)

152 
qp
->
s_mig_¡©e
 = 
IB_MIG_ARMED
;

156 
	}
}

168 
u32
 
	$hfi1_make_grh
(
hfi1_ibpÜt
 *
ibp
, 
ib_grh
 *
hdr
,

169 cÚ¡ 
ib_glob®_rou‹
 *
grh
, 
u32
 
hwÜds
, u32 
nwÜds
)

171 
hdr
->
v”siÚ_tþass_æow
 =

172 
	`ýu_to_be32
((
IB_GRH_VERSION
 << 
IB_GRH_VERSION_SHIFT
) |

173 (
grh
->
Œaffic_þass
 << 
IB_GRH_TCLASS_SHIFT
) |

174 (
grh
->
æow_Ïb–
 << 
IB_GRH_FLOW_SHIFT
));

175 
hdr
->
·yËn
 = 
	`ýu_to_be16
((
hwÜds
 + 
nwÜds
) << 2);

177 
hdr
->
Ãxt_hdr
 = 
IB_GRH_NEXT_HDR
;

178 
hdr
->
hÝ_lim™
 = 
grh
->hop_limit;

180 
hdr
->
sgid
.
glob®
.
subÃt_´efix
 = 
ibp
->
rvp
.
gid_´efix
;

181 
hdr
->
sgid
.
glob®
.
š‹rçû_id
 =

182 
grh
->
sgid_šdex
 < 
HFI1_GUIDS_PER_PORT
 ?

183 
	`g‘_sguid
(
ibp
, 
grh
->
sgid_šdex
) :

184 
	`g‘_sguid
(
ibp
, 
HFI1_PORT_GUID_INDEX
);

185 
hdr
->
dgid
 = 
grh
->dgid;

188  (
ib_grh
è/ (
u32
);

189 
	}
}

191 
	#BTH2_OFFSET
 (
	`off£tof
(
hfi1_sdma_h—d”
, \

192 
hdr
.
ibh
.
u
.
Ùh
.
bth
[2]è/ 4)

	)

205 
šlše
 
	$bužd_ahg
(
rvt_qp
 *
qp
, 
u32
 
Å¢
)

207 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

209 ià(
	`uÆik–y
(
qp
->
s_æags
 & 
HFI1_S_AHG_CLEAR
))

210 
	`þ—r_ahg
(
qp
);

211 ià(!(
qp
->
s_æags
 & 
HFI1_S_AHG_VALID
)) {

213 ià(
qp
->
s_ahgidx
 < 0)

214 
qp
->
s_ahgidx
 = 
	`sdma_ahg_®loc
(
´iv
->
s_sde
);

215 ià(
qp
->
s_ahgidx
 >= 0) {

216 
qp
->
s_ahgp¢
 = 
Å¢
;

217 
´iv
->
s_ahg
->
tx_æags
 |ð
SDMA_TXREQ_F_AHG_COPY
;

219 
´iv
->
s_ahg
->
ahgidx
 = 
qp
->
s_ahgidx
;

220 
qp
->
s_æags
 |ð
HFI1_S_AHG_VALID
;

224 ià(
qp
->
s_ahgidx
 >= 0) {

225 
´iv
->
s_ahg
->
tx_æags
 |ð
SDMA_TXREQ_F_USE_AHG
;

226 
´iv
->
s_ahg
->
ahgidx
 = 
qp
->
s_ahgidx
;

227 
´iv
->
s_ahg
->
ahgcouÁ
++;

228 
´iv
->
s_ahg
->
ahgdesc
[0] =

229 
	`sdma_bužd_ahg_desütÜ
(

230 (
__fÜû
 
u16
)
	`ýu_to_be16
((u16)
Å¢
),

231 
BTH2_OFFSET
,

234 ià((
Å¢
 & 0xffff0000) !=

235 (
qp
->
s_ahgp¢
 & 0xffff0000)) {

236 
´iv
->
s_ahg
->
ahgcouÁ
++;

237 
´iv
->
s_ahg
->
ahgdesc
[1] =

238 
	`sdma_bužd_ahg_desütÜ
(

239 (
__fÜû
 
u16
)
	`ýu_to_be16
(

240 (
u16
)(
Å¢
 >> 16)),

241 
BTH2_OFFSET
,

247 
	}
}

249 
šlše
 
	$hfi1_make_ruc_bth
(
rvt_qp
 *
qp
,

250 
ib_Ùh”_h—d”s
 *
ohdr
,

251 
u32
 
bth0
, u32 
bth1
, u32 
bth2
)

253 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

254 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
bth1
);

255 
ohdr
->
bth
[2] = 
	`ýu_to_be32
(
bth2
);

256 
	}
}

272 
šlše
 
	$hfi1_make_ruc_h—d”_16B
(
rvt_qp
 *
qp
,

273 
ib_Ùh”_h—d”s
 *
ohdr
,

274 
u32
 
bth0
, u32 
bth1
, u32 
bth2
,

275 
middË
,

276 
hfi1_pkt_¡©e
 *
ps
)

278 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

279 
hfi1_ibpÜt
 *
ibp
 = 
ps
->ibp;

280 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

281 
u32
 
¦id
;

282 
u16
 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
qp
->
s_pkey_šdex
);

283 
u8
 
l4
 = 
OPA_16B_L4_IB_LOCAL
;

284 
u8
 
exŒa_by‹s
 = 
	`hfi1_g‘_16b_·ddšg
(

285 (
ps
->
s_tx»q
->
hdr_dwÜds
 << 2),

286 
ps
->
s_tx»q
->
s_cur_size
);

287 
u32
 
nwÜds
 = 
SIZE_OF_CRC
 + ((
ps
->
s_tx»q
->
s_cur_size
 +

288 
exŒa_by‹s
 + 
SIZE_OF_LT
) >> 2);

289 
boÞ
 
beú
 = 
çl£
;

291 ià(
	`uÆik–y
(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
) &&

292 
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
))) {

293 
ib_grh
 *
grh
;

294 
ib_glob®_rou‹
 *
grd
 =

295 
	`rdma_ah_»Œ›ve_grh
(&
qp
->
»mÙe_ah_©Œ
);

300 ià(
grd
->
sgid_šdex
 =ð
OPA_GID_INDEX
)

301 
grd
->
sgid_šdex
 = 0;

302 
grh
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
l
.grh;

303 
l4
 = 
OPA_16B_L4_IB_GLOBAL
;

304 
ps
->
s_tx»q
->
hdr_dwÜds
 +=

305 
	`hfi1_make_grh
(
ibp
, 
grh
, 
grd
,

306 
ps
->
s_tx»q
->
hdr_dwÜds
 - 
LRH_16B_DWORDS
,

307 
nwÜds
);

308 
middË
 = 0;

311 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_MIGRATED
)

312 
bth1
 |ð
OPA_BTH_MIG_REQ
;

314 
middË
 = 0;

316 ià(
qp
->
s_æags
 & 
RVT_S_ECN
) {

317 
qp
->
s_æags
 &ð~
RVT_S_ECN
;

319 
beú
 = 
Œue
;

320 
middË
 = 0;

322 ià(
middË
)

323 
	`bužd_ahg
(
qp
, 
bth2
);

325 
qp
->
s_æags
 &ð~
HFI1_S_AHG_VALID
;

327 
bth0
 |ð
pkey
;

328 
bth0
 |ð
exŒa_by‹s
 << 20;

329 
	`hfi1_make_ruc_bth
(
qp
, 
ohdr
, 
bth0
, 
bth1
, 
bth2
);

331 ià(!
µd
->
lid
)

332 
¦id
 = 
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
);

334 
¦id
 = 
µd
->
lid
 |

335 (
	`rdma_ah_g‘_·th_b™s
(&
qp
->
»mÙe_ah_©Œ
) &

336 ((1 << 
µd
->
lmc
) - 1));

338 
	`hfi1_make_16b_hdr
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
,

339 
¦id
,

340 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
),

342 (
ps
->
s_tx»q
->
hdr_dwÜds
 + 
nwÜds
) >> 1,

343 
pkey
, 
beú
, 0, 
l4
, 
´iv
->
s_sc
);

344 
	}
}

360 
šlše
 
	$hfi1_make_ruc_h—d”_9B
(
rvt_qp
 *
qp
,

361 
ib_Ùh”_h—d”s
 *
ohdr
,

362 
u32
 
bth0
, u32 
bth1
, u32 
bth2
,

363 
middË
,

364 
hfi1_pkt_¡©e
 *
ps
)

366 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

367 
hfi1_ibpÜt
 *
ibp
 = 
ps
->ibp;

368 
u16
 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
qp
->
s_pkey_šdex
);

369 
u16
 
Ìh0
 = 
HFI1_LRH_BTH
;

370 
u8
 
exŒa_by‹s
 = -
ps
->
s_tx»q
->
s_cur_size
 & 3;

371 
u32
 
nwÜds
 = 
SIZE_OF_CRC
 + ((
ps
->
s_tx»q
->
s_cur_size
 +

372 
exŒa_by‹s
) >> 2);

374 ià(
	`uÆik–y
(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
)) {

375 
ib_grh
 *
grh
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
l
.grh;

377 
Ìh0
 = 
HFI1_LRH_GRH
;

378 
ps
->
s_tx»q
->
hdr_dwÜds
 +=

379 
	`hfi1_make_grh
(
ibp
, 
grh
,

380 
	`rdma_ah_»ad_grh
(&
qp
->
»mÙe_ah_©Œ
),

381 
ps
->
s_tx»q
->
hdr_dwÜds
 - 
LRH_9B_DWORDS
,

382 
nwÜds
);

383 
middË
 = 0;

385 
Ìh0
 |ð(
´iv
->
s_sc
 & 0xf) << 12 |

386 (
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
) & 0xf) << 4;

388 ià(
qp
->
s_mig_¡©e
 =ð
IB_MIG_MIGRATED
)

389 
bth0
 |ð
IB_BTH_MIG_REQ
;

391 
middË
 = 0;

393 ià(
qp
->
s_æags
 & 
RVT_S_ECN
) {

394 
qp
->
s_æags
 &ð~
RVT_S_ECN
;

396 
bth1
 |ð(
IB_BECN_MASK
 << 
IB_BECN_SHIFT
);

397 
middË
 = 0;

399 ià(
middË
)

400 
	`bužd_ahg
(
qp
, 
bth2
);

402 
qp
->
s_æags
 &ð~
HFI1_S_AHG_VALID
;

404 
bth0
 |ð
pkey
;

405 
bth0
 |ð
exŒa_by‹s
 << 20;

406 
	`hfi1_make_ruc_bth
(
qp
, 
ohdr
, 
bth0
, 
bth1
, 
bth2
);

407 
	`hfi1_make_ib_hdr
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
,

408 
Ìh0
,

409 
ps
->
s_tx»q
->
hdr_dwÜds
 + 
nwÜds
,

410 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
), 9B),

411 
	`µd_äom_ibp
(
ibp
)->
lid
 |

412 
	`rdma_ah_g‘_·th_b™s
(&
qp
->
»mÙe_ah_©Œ
));

413 
	}
}

415 (*
	thfi1_make_ruc_hdr
)(
	trvt_qp
 *
	tqp
,

416 
	tib_Ùh”_h—d”s
 *
	tohdr
,

417 
	tu32
 
	tbth0
, u32 
	tbth1
, u32 
	tbth2
, 
	tmiddË
,

418 
	thfi1_pkt_¡©e
 *
	tps
);

421 cÚ¡ 
hfi1_make_ruc_hdr
 
hfi1_ruc_h—d”_tbl
[2] = {

422 [
HFI1_PKT_TYPE_9B
] = &
hfi1_make_ruc_h—d”_9B
,

423 [
HFI1_PKT_TYPE_16B
] = &
hfi1_make_ruc_h—d”_16B


424 
	}
};

426 
	$hfi1_make_ruc_h—d”
(
rvt_qp
 *
qp
, 
ib_Ùh”_h—d”s
 *
ohdr
,

427 
u32
 
bth0
, u32 
bth1
, u32 
bth2
, 
middË
,

428 
hfi1_pkt_¡©e
 *
ps
)

430 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

443 
´iv
->
s_ahg
->
tx_æags
 = 0;

444 
´iv
->
s_ahg
->
ahgcouÁ
 = 0;

445 
´iv
->
s_ahg
->
ahgidx
 = 0;

448 
hfi1_ruc_h—d”_tbl
[
´iv
->
hdr_ty³
](
qp
, 
ohdr
, 
bth0
, 
bth1
, 
bth2
, 
middË
,

449 
ps
);

450 
	}
}

453 
	#SEND_RESCHED_TIMEOUT
 (5 * 
HZ
è

	)

469 
boÞ
 
	$hfi1_scheduË_£nd_y›ld
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

470 
boÞ
 
tid
)

472 
ps
->
pkts_£Á
 = 
Œue
;

474 ià(
	`uÆik–y
(
	`time_aá”
(
jiff›s
, 
ps
->
timeout
))) {

475 ià(!
ps
->
š_th»ad
 ||

476 
	`wÜkqueue_cÚge¡ed
(
ps
->
ýu
,…s->
µd
->
hfi1_wq
)) {

477 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
->
æags
);

478 ià(!
tid
) {

479 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

480 
	`hfi1_scheduË_£nd
(
qp
);

482 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

484 ià(
´iv
->
s_æags
 &

485 
HFI1_S_TID_BUSY_SET
) {

486 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

487 
´iv
->
s_æags
 &=

488 ~(
HFI1_S_TID_BUSY_SET
 |

489 
RVT_S_BUSY
);

491 
´iv
->
s_æags
 &ð~
RVT_S_BUSY
;

493 
	`hfi1_scheduË_tid_£nd
(
qp
);

495 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
->
æags
);

496 
	`this_ýu_šc
(*
ps
->
µd
->
dd
->
£nd_scheduË
);

497 
	`Œaû_hfi1_rc_expœed_time_¦iû
(
qp
, 
Œue
);

498  
Œue
;

501 
	`cÚd_»sched
();

502 
	`this_ýu_šc
(*
ps
->
µd
->
dd
->
£nd_scheduË
);

503 
ps
->
timeout
 = 
jiff›s
 +…s->
timeout_št
;

506 
	`Œaû_hfi1_rc_expœed_time_¦iû
(
qp
, 
çl£
);

507  
çl£
;

508 
	}
}

510 
	$hfi1_do_£nd_äom_rvt
(
rvt_qp
 *
qp
)

512 
	`hfi1_do_£nd
(
qp
, 
çl£
);

513 
	}
}

515 
	$_hfi1_do_£nd
(
wÜk_¡ruù
 *
wÜk
)

517 
iowa™_wÜk
 *
w
 = 
	`cÚš”_of
(
wÜk
, iowa™_wÜk, 
iowÜk
);

518 
rvt_qp
 *
qp
 = 
	`iowa™_to_qp
(
w
->
iow
);

520 
	`hfi1_do_£nd
(
qp
, 
Œue
);

521 
	}
}

532 
	$hfi1_do_£nd
(
rvt_qp
 *
qp
, 
boÞ
 
š_th»ad
)

534 
hfi1_pkt_¡©e
 
ps
;

535 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

536 (*
make_»q
)(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

538 
ps
.
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

539 
ps
.
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

540 
ps
.
µd
 = 
	`µd_äom_ibp
Õs.
ibp
);

541 
ps
.
š_th»ad
 = in_thread;

542 
ps
.
wa™
 = 
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
);

544 
	`Œaû_hfi1_rc_do_£nd
(
qp
, 
š_th»ad
);

546 
qp
->
ibqp
.
qp_ty³
) {

547 
IB_QPT_RC
:

548 ià(!
loÝback
 && ((
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
) &

549 ~((1 << 
ps
.
µd
->
lmc
) - 1)) ==

550 
ps
.
µd
->
lid
)) {

551 
	`rvt_ruc_loÝback
(
qp
);

554 
make_»q
 = 
hfi1_make_rc_»q
;

555 
ps
.
timeout_št
 = 
qp
->
timeout_jiff›s
;

557 
IB_QPT_UC
:

558 ià(!
loÝback
 && ((
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
) &

559 ~((1 << 
ps
.
µd
->
lmc
) - 1)) ==

560 
ps
.
µd
->
lid
)) {

561 
	`rvt_ruc_loÝback
(
qp
);

564 
make_»q
 = 
hfi1_make_uc_»q
;

565 
ps
.
timeout_št
 = 
SEND_RESCHED_TIMEOUT
;

568 
make_»q
 = 
hfi1_make_ud_»q
;

569 
ps
.
timeout_št
 = 
SEND_RESCHED_TIMEOUT
;

572 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
.
æags
);

575 ià(!
	`hfi1_£nd_ok
(
qp
)) {

576 ià(
qp
->
s_æags
 & 
HFI1_S_ANY_WAIT_IO
)

577 
	`iowa™_£t_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_IB
);

578 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

582 
qp
->
s_æags
 |ð
RVT_S_BUSY
;

584 
ps
.
timeout_št
 =…s.timeout_int / 8;

585 
ps
.
timeout
 = 
jiff›s
 +…s.
timeout_št
;

586 
ps
.
ýu
 = 
´iv
->
s_sde
 ?…riv->s_sde->cpu :

587 
	`ýumask_fœ¡
(
	`ýumask_of_node
(
ps
.
µd
->
dd
->
node
));

588 
ps
.
pkts_£Á
 = 
çl£
;

591 
ps
.
s_tx»q
 = 
	`g‘_wa™šg_v”bs_tx»q
Õs.
wa™
);

594 ià(
ps
.
s_tx»q
) {

595 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_BUSY_SET
)

596 
qp
->
s_æags
 |ð
RVT_S_BUSY
;

597 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

603 ià(
	`hfi1_v”bs_£nd
(
qp
, &
ps
))

607 ià(
	`hfi1_scheduË_£nd_y›ld
(
qp
, &
ps
, 
çl£
))

610 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
.
æags
);

612 } 
	`make_»q
(
qp
, &
ps
));

613 
	`iowa™_¡¬ve_þ—r
(
ps
.
pkts_£Á
, &
´iv
->
s_iowa™
);

614 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

615 
	}
}

	@sdma.c

48 
	~<lšux/¥šlock.h
>

49 
	~<lšux/£qlock.h
>

50 
	~<lšux/Ãtdeviû.h
>

51 
	~<lšux/moduË·¿m.h
>

52 
	~<lšux/b™Ýs.h
>

53 
	~<lšux/tim”.h
>

54 
	~<lšux/vm®loc.h
>

55 
	~<lšux/highmem.h
>

57 
	~"hfi.h
"

58 
	~"commÚ.h
"

59 
	~"qp.h
"

60 
	~"sdma.h
"

61 
	~"iowa™.h
"

62 
	~"Œaû.h
"

63 
	~"com·t.h
"

66 
	#SDMA_DESCQ_CNT
 2048

	)

67 
	#SDMA_DESC_INTR
 64

	)

68 
	#INVALID_TAIL
 0xffff

	)

69 
	#SDMA_PAD
 
	`max_t
(
size_t
, 
MAX_16B_PADDING
, (
u32
))

	)

71 
ušt
 
	gsdma_descq_út
 = 
SDMA_DESCQ_CNT
;

72 
moduË_·¿m
(
sdma_descq_út
, 
ušt
, 
S_IRUGO
);

73 
MODULE_PARM_DESC
(
sdma_descq_út
, "Number of SDMA descqƒntries");

75 
ušt
 
	gsdma_idË_út
 = 250;

76 
moduË_·¿m
(
sdma_idË_út
, 
ušt
, 
S_IRUGO
);

77 
MODULE_PARM_DESC
(
sdma_idË_út
, "sdma interrupt idle delay (ns,default 250)");

79 
ušt
 
	gmod_num_sdma
;

80 
moduË_·¿m_Çmed
(
num_sdma
, 
mod_num_sdma
, 
ušt
, 
S_IRUGO
);

81 
MODULE_PARM_DESC
(
num_sdma
, "Set max‚umber SDMAƒngineso use");

83 
ušt
 
	gsdma_desù_šŒ
 = 
SDMA_DESC_INTR
;

84 
moduË_·¿m_Çmed
(
desù_šŒ
, 
sdma_desù_šŒ
, 
ušt
, 
S_IRUGO
 | 
S_IWUSR
);

85 
MODULE_PARM_DESC
(
desù_šŒ
, "Number of SDMA descriptor before interrupt");

87 
	#SDMA_WAIT_BATCH_SIZE
 20

	)

89 
	#SDMA_ERR_HALT_TIMEOUT
 10

	)

92 
	#SD
(
Çme
è
SEND_DMA_
##
	)
name

93 
	#ALL_SDMA_ENG_HALT_ERRS
 \

94 (
	`SD
(
ENG_ERR_STATUS_SDMA_WRONG_DW_ERR_SMASK
) \

95 | 
	`SD
(
ENG_ERR_STATUS_SDMA_GEN_MISMATCH_ERR_SMASK
) \

96 | 
	`SD
(
ENG_ERR_STATUS_SDMA_TOO_LONG_ERR_SMASK
) \

97 | 
	`SD
(
ENG_ERR_STATUS_SDMA_TAIL_OUT_OF_BOUNDS_ERR_SMASK
) \

98 | 
	`SD
(
ENG_ERR_STATUS_SDMA_FIRST_DESC_ERR_SMASK
) \

99 | 
	`SD
(
ENG_ERR_STATUS_SDMA_MEM_READ_ERR_SMASK
) \

100 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HALT_ERR_SMASK
) \

101 | 
	`SD
(
ENG_ERR_STATUS_SDMA_LENGTH_MISMATCH_ERR_SMASK
) \

102 | 
	`SD
(
ENG_ERR_STATUS_SDMA_PACKET_DESC_OVERFLOW_ERR_SMASK
) \

103 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HEADER_SELECT_ERR_SMASK
) \

104 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HEADER_ADDRESS_ERR_SMASK
) \

105 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HEADER_LENGTH_ERR_SMASK
) \

106 | 
	`SD
(
ENG_ERR_STATUS_SDMA_TIMEOUT_ERR_SMASK
) \

107 | 
	`SD
(
ENG_ERR_STATUS_SDMA_DESC_TABLE_UNC_ERR_SMASK
) \

108 | 
	`SD
(
ENG_ERR_STATUS_SDMA_ASSEMBLY_UNC_ERR_SMASK
) \

109 | 
	`SD
(
ENG_ERR_STATUS_SDMA_PACKET_TRACKING_UNC_ERR_SMASK
) \

110 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HEADER_STORAGE_UNC_ERR_SMASK
) \

111 | 
	`SD
(
ENG_ERR_STATUS_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_SMASK
))

	)

114 
	#SDMA_SENDCTRL_OP_ENABLE
 
	`BIT
(0)

	)

115 
	#SDMA_SENDCTRL_OP_INTENABLE
 
	`BIT
(1)

	)

116 
	#SDMA_SENDCTRL_OP_HALT
 
	`BIT
(2)

	)

117 
	#SDMA_SENDCTRL_OP_CLEANUP
 
	`BIT
(3)

	)

120 
	#SDMA_EGRESS_PACKET_OCCUPANCY_SMASK
 \

121 
SEND_EGRESS_SEND_DMA_STATUS_SDMA_EGRESS_PACKET_OCCUPANCY_SMASK


	)

122 
	#SDMA_EGRESS_PACKET_OCCUPANCY_SHIFT
 \

123 
SEND_EGRESS_SEND_DMA_STATUS_SDMA_EGRESS_PACKET_OCCUPANCY_SHIFT


	)

125 cÚ¡ * cÚ¡ 
	gsdma_¡©e_Çmes
[] = {

126 [
sdma_¡©e_s00_hw_down
] = "s00_HwDown",

127 [
sdma_¡©e_s10_hw_¡¬t_up_h®t_wa™
] = "s10_HwStartUpHaltWait",

128 [
sdma_¡©e_s15_hw_¡¬t_up_þ—n_wa™
] = "s15_HwStartUpCleanWait",

129 [
sdma_¡©e_s20_idË
] = "s20_Idle",

130 [
sdma_¡©e_s30_sw_þ—n_up_wa™
] = "s30_SwCleanUpWait",

131 [
sdma_¡©e_s40_hw_þ—n_up_wa™
] = "s40_HwCleanUpWait",

132 [
sdma_¡©e_s50_hw_h®t_wa™
] = "s50_HwHaltWait",

133 [
sdma_¡©e_s60_idË_h®t_wa™
] = "s60_IdleHaltWait",

134 [
sdma_¡©e_s80_hw_ä“ze
] = "s80_HwFreeze",

135 [
sdma_¡©e_s82_ä“ze_sw_þ—n
] = "s82_FreezeSwClean",

136 [
sdma_¡©e_s99_ruÂšg
] = "s99_Running",

139 #ifdeà
CONFIG_SDMA_VERBOSITY


140 cÚ¡ * cÚ¡ 
	gsdma_ev’t_Çmes
[] = {

141 [
sdma_ev’t_e00_go_hw_down
] = "e00_GoHwDown",

142 [
sdma_ev’t_e10_go_hw_¡¬t
] = "e10_GoHwStart",

143 [
sdma_ev’t_e15_hw_h®t_dÚe
] = "e15_HwHaltDone",

144 [
sdma_ev’t_e25_hw_þ—n_up_dÚe
] = "e25_HwCleanUpDone",

145 [
sdma_ev’t_e30_go_ruÂšg
] = "e30_GoRunning",

146 [
sdma_ev’t_e40_sw_þ—Ãd
] = "e40_SwCleaned",

147 [
sdma_ev’t_e50_hw_þ—Ãd
] = "e50_HwCleaned",

148 [
sdma_ev’t_e60_hw_h®‹d
] = "e60_HwHalted",

149 [
sdma_ev’t_e70_go_idË
] = "e70_GoIdle",

150 [
sdma_ev’t_e80_hw_ä“ze
] = "e80_HwFreeze",

151 [
sdma_ev’t_e81_hw_äoz’
] = "e81_HwFrozen",

152 [
sdma_ev’t_e82_hw_unä“ze
] = "e82_HwUnfreeze",

153 [
sdma_ev’t_e85_lšk_down
] = "e85_LinkDown",

154 [
sdma_ev’t_e90_sw_h®‹d
] = "e90_SwHalted",

158 cÚ¡ 
sdma_£t_¡©e_aùiÚ
 
	gsdma_aùiÚ_bË
[] = {

159 [
sdma_¡©e_s00_hw_down
] = {

160 .
go_s99_ruÂšg_toçl£
 = 1,

161 .
	gÝ_’abË
 = 0,

162 .
	gÝ_š‹ÇbË
 = 0,

163 .
	gÝ_h®t
 = 0,

164 .
	gÝ_þ—nup
 = 0,

166 [
sdma_¡©e_s10_hw_¡¬t_up_h®t_wa™
] = {

167 .
Ý_’abË
 = 0,

168 .
	gÝ_š‹ÇbË
 = 0,

169 .
	gÝ_h®t
 = 1,

170 .
	gÝ_þ—nup
 = 0,

172 [
sdma_¡©e_s15_hw_¡¬t_up_þ—n_wa™
] = {

173 .
Ý_’abË
 = 0,

174 .
	gÝ_š‹ÇbË
 = 1,

175 .
	gÝ_h®t
 = 0,

176 .
	gÝ_þ—nup
 = 1,

178 [
sdma_¡©e_s20_idË
] = {

179 .
Ý_’abË
 = 0,

180 .
	gÝ_š‹ÇbË
 = 1,

181 .
	gÝ_h®t
 = 0,

182 .
	gÝ_þ—nup
 = 0,

184 [
sdma_¡©e_s30_sw_þ—n_up_wa™
] = {

185 .
Ý_’abË
 = 0,

186 .
	gÝ_š‹ÇbË
 = 0,

187 .
	gÝ_h®t
 = 0,

188 .
	gÝ_þ—nup
 = 0,

190 [
sdma_¡©e_s40_hw_þ—n_up_wa™
] = {

191 .
Ý_’abË
 = 0,

192 .
	gÝ_š‹ÇbË
 = 0,

193 .
	gÝ_h®t
 = 0,

194 .
	gÝ_þ—nup
 = 1,

196 [
sdma_¡©e_s50_hw_h®t_wa™
] = {

197 .
Ý_’abË
 = 0,

198 .
	gÝ_š‹ÇbË
 = 0,

199 .
	gÝ_h®t
 = 0,

200 .
	gÝ_þ—nup
 = 0,

202 [
sdma_¡©e_s60_idË_h®t_wa™
] = {

203 .
go_s99_ruÂšg_toçl£
 = 1,

204 .
	gÝ_’abË
 = 0,

205 .
	gÝ_š‹ÇbË
 = 0,

206 .
	gÝ_h®t
 = 1,

207 .
	gÝ_þ—nup
 = 0,

209 [
sdma_¡©e_s80_hw_ä“ze
] = {

210 .
Ý_’abË
 = 0,

211 .
	gÝ_š‹ÇbË
 = 0,

212 .
	gÝ_h®t
 = 0,

213 .
	gÝ_þ—nup
 = 0,

215 [
sdma_¡©e_s82_ä“ze_sw_þ—n
] = {

216 .
Ý_’abË
 = 0,

217 .
	gÝ_š‹ÇbË
 = 0,

218 .
	gÝ_h®t
 = 0,

219 .
	gÝ_þ—nup
 = 0,

221 [
sdma_¡©e_s99_ruÂšg
] = {

222 .
Ý_’abË
 = 1,

223 .
	gÝ_š‹ÇbË
 = 1,

224 .
	gÝ_h®t
 = 0,

225 .
	gÝ_þ—nup
 = 0,

226 .
	ggo_s99_ruÂšg_tÙrue
 = 1,

230 
	#SDMA_TAIL_UPDATE_THRESH
 0x1F

	)

233 
sdma_com¶‘e
(
k»f
 *);

234 
sdma_fš®put
(
sdma_¡©e
 *);

235 
sdma_g‘
(
sdma_¡©e
 *);

236 
sdma_hw_þ—n_up_sk
();

237 
sdma_put
(
sdma_¡©e
 *);

238 
sdma_£t_¡©e
(
sdma_’gše
 *, 
sdma_¡©es
);

239 
sdma_¡¬t_hw_þ—n_up
(
sdma_’gše
 *);

240 
sdma_sw_þ—n_up_sk
();

241 
sdma_£ndù¾
(
sdma_’gše
 *, );

242 
š™_sdma_»gs
(
sdma_’gše
 *, 
u32
, 
ušt
);

243 
sdma_´oûss_ev’t
(

244 
sdma_’gše
 *
sde
,

245 
sdma_ev’ts
 
ev’t
);

246 
__sdma_´oûss_ev’t
(

247 
sdma_’gše
 *
sde
,

248 
sdma_ev’ts
 
ev’t
);

249 
dump_sdma_¡©e
(
sdma_’gše
 *
sde
);

250 
sdma_make_´og»ss
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
);

251 
sdma_desc_avaž
(
sdma_’gše
 *
sde
, 
ušt
 
avaž
);

252 
sdma_æush_descq
(
sdma_’gše
 *
sde
);

258 cÚ¡ *
	$sdma_¡©e_Çme
(
sdma_¡©es
 
¡©e
)

260  
sdma_¡©e_Çmes
[
¡©e
];

261 
	}
}

263 
	$sdma_g‘
(
sdma_¡©e
 *
ss
)

265 
	`k»f_g‘
(&
ss
->
k»f
);

266 
	}
}

268 
	$sdma_com¶‘e
(
k»f
 *kref)

270 
sdma_¡©e
 *
ss
 =

271 
	`cÚš”_of
(
k»f
, 
sdma_¡©e
, kref);

273 
	`com¶‘e
(&
ss
->
comp
);

274 
	}
}

276 
	$sdma_put
(
sdma_¡©e
 *
ss
)

278 
	`k»f_put
(&
ss
->
k»f
, 
sdma_com¶‘e
);

279 
	}
}

281 
	$sdma_fš®put
(
sdma_¡©e
 *
ss
)

283 
	`sdma_put
(
ss
);

284 
	`wa™_fÜ_com¶‘iÚ
(&
ss
->
comp
);

285 
	}
}

287 
šlše
 
	$wr™e_sde_c¤
(

288 
sdma_’gše
 *
sde
,

289 
u32
 
off£t0
,

290 
u64
 
v®ue
)

292 
	`wr™e_kùxt_c¤
(
sde
->
dd
, sde->
this_idx
, 
off£t0
, 
v®ue
);

293 
	}
}

295 
šlše
 
u64
 
	$»ad_sde_c¤
(

296 
sdma_’gše
 *
sde
,

297 
u32
 
off£t0
)

299  
	`»ad_kùxt_c¤
(
sde
->
dd
, sde->
this_idx
, 
off£t0
);

300 
	}
}

306 
	$sdma_wa™_fÜ_·ck‘_eg»ss
(
sdma_’gše
 *
sde
,

307 
·u£
)

309 
u64
 
off
 = 8 * 
sde
->
this_idx
;

310 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

311 
lút
 = 0;

312 
u64
 
»g_´ev
;

313 
u64
 
»g
 = 0;

316 
»g_´ev
 = 
»g
;

317 
»g
 = 
	`»ad_c¤
(
dd
, 
off
 + 
SEND_EGRESS_SEND_DMA_STATUS
);

319 
»g
 &ð
SDMA_EGRESS_PACKET_OCCUPANCY_SMASK
;

320 
»g
 >>ð
SDMA_EGRESS_PACKET_OCCUPANCY_SHIFT
;

321 ià(
»g
 == 0)

324 ià(
»g
 !ð
»g_´ev
)

325 
lút
 = 0;

326 ià(
lút
++ > 500) {

328 
	`dd_dev_”r
(
dd
, "%s:ƒngine %uimeout waiting for…acketsoƒgress,„emaining count %u, bouncing†ink\n",

329 
__func__
, 
sde
->
this_idx
, (
u32
)
»g
);

330 
	`queue_wÜk
(
dd
->
µÜt
->
lšk_wq
,

331 &
dd
->
µÜt
->
lšk_bounû_wÜk
);

334 
	`ud–ay
(1);

336 
	}
}

342 
	$sdma_wa™
(
hfi1_devd©a
 *
dd
)

344 
i
;

346 
i
 = 0; i < 
dd
->
num_sdma
; i++) {

347 
sdma_’gše
 *
sde
 = &
dd
->
³r_sdma
[
i
];

349 
	`sdma_wa™_fÜ_·ck‘_eg»ss
(
sde
, 0);

351 
	}
}

353 
šlše
 
	$sdma_£t_desc_út
(
sdma_’gše
 *
sde
, 
út
)

355 
u64
 
»g
;

357 ià(!(
sde
->
dd
->
æags
 & 
HFI1_HAS_SDMA_TIMEOUT
))

359 
»g
 = 
út
;

360 
»g
 &ð
	`SD
(
DESC_CNT_CNT_MASK
);

361 
»g
 <<ð
	`SD
(
DESC_CNT_CNT_SHIFT
);

362 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
DESC_CNT
), 
»g
);

363 
	}
}

365 
šlše
 
	$com¶‘e_tx
(
sdma_’gše
 *
sde
,

366 
sdma_tx»q
 *
tx
,

367 
»s
)

370 
iowa™
 *
wa™
 = 
tx
->wait;

371 
ÿÎback_t
 
com¶‘e
 = 
tx
->complete;

373 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


374 
	`Œaû_hfi1_sdma_out_¢
(
sde
, 
tx
->
¢
);

375 ià(
	`WARN_ON_ONCE
(
sde
->
h—d_¢
 !ð
tx
->
¢
))

376 
	`dd_dev_”r
(
sde
->
dd
, "expected %llu got %llu\n",

377 
sde
->
h—d_¢
, 
tx
->
¢
);

378 
sde
->
h—d_¢
++;

380 
	`__sdma_txþ—n
(
sde
->
dd
, 
tx
);

381 ià(
com¶‘e
)

382 (*
com¶‘e
)(
tx
, 
»s
);

383 ià(
	`iowa™_sdma_dec
(
wa™
))

384 
	`iowa™_d¿š_wakeup
(
wa™
);

385 
	}
}

405 
	$sdma_æush
(
sdma_’gše
 *
sde
)

407 
sdma_tx»q
 *
txp
, *
txp_Ãxt
;

408 
	`LIST_HEAD
(
æushli¡
);

409 
æags
;

410 
ušt
 
£q
;

413 
	`sdma_æush_descq
(
sde
);

414 
	`¥š_lock_œq§ve
(&
sde
->
æushli¡_lock
, 
æags
);

416 
	`li¡_¥liû_š™
(&
sde
->
æushli¡
, &flushlist);

417 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
æushli¡_lock
, 
æags
);

419 
	`li¡_fÜ_—ch_’Œy_§ã
(
txp
, 
txp_Ãxt
, &
æushli¡
, 
li¡
)

420 
	`com¶‘e_tx
(
sde
, 
txp
, 
SDMA_TXREQ_S_ABORTED
);

423 
iowa™
 *
w
, *
nw
;

425 
£q
 = 
	`»ad_£qbegš
(&
sde
->
wa™lock
);

426 ià(!
	`li¡_em±y
(&
sde
->
dmawa™
)) {

427 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

428 
	`li¡_fÜ_—ch_’Œy_§ã
(
w
, 
nw
, &
sde
->
dmawa™
, 
li¡
) {

429 ià(
w
->
wakeup
) {

430 
w
->
	`wakeup
(w, 
SDMA_AVAIL_REASON
);

431 
	`li¡_d–_š™
(&
w
->
li¡
);

434 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

436 } 
	`»ad_£q»Œy
(&
sde
->
wa™lock
, 
£q
));

437 
	}
}

449 
	$sdma_f›ld_æush
(
wÜk_¡ruù
 *
wÜk
)

451 
æags
;

452 
sdma_’gše
 *
sde
 =

453 
	`cÚš”_of
(
wÜk
, 
sdma_’gše
, 
æush_wÜk”
);

455 
	`wr™e_£qlock_œq§ve
(&
sde
->
h—d_lock
, 
æags
);

456 ià(!
	`__sdma_ruÂšg
(
sde
))

457 
	`sdma_æush
(
sde
);

458 
	`wr™e_£quÆock_œq»¡Üe
(&
sde
->
h—d_lock
, 
æags
);

459 
	}
}

461 
	$sdma_”r_h®t_wa™
(
wÜk_¡ruù
 *
wÜk
)

463 
sdma_’gše
 *
sde
 = 
	`cÚš”_of
(
wÜk
, sdma_engine,

464 
”r_h®t_wÜk”
);

465 
u64
 
¡©usc¤
;

466 
timeout
;

468 
timeout
 = 
jiff›s
 + 
	`m£cs_to_jiff›s
(
SDMA_ERR_HALT_TIMEOUT
);

470 
¡©usc¤
 = 
	`»ad_sde_c¤
(
sde
, 
	`SD
(
STATUS
));

471 
¡©usc¤
 &ð
	`SD
(
STATUS_ENG_HALTED_SMASK
);

472 ià(
¡©usc¤
)

474 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

475 
	`dd_dev_”r
(
sde
->
dd
,

477 
sde
->
this_idx
);

484 
	`u¦“p_¿nge
(80, 120);

487 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e15_hw_h®t_dÚe
);

488 
	}
}

490 
	$sdma_”r_´og»ss_check_scheduË
(
sdma_’gše
 *
sde
)

492 ià(!
	`is_bx
(
sde
->
dd
è&& 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
)) {

493 
šdex
;

494 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

496 
šdex
 = 0; index < 
dd
->
num_sdma
; index++) {

497 
sdma_’gše
 *
cu¼_sdma
 = &
dd
->
³r_sdma
[
šdex
];

499 ià(
cu¼_sdma
 !ð
sde
)

500 
cu¼_sdma
->
´og»ss_check_h—d
 =

501 
cu¼_sdma
->
descq_h—d
;

503 
	`dd_dev_”r
(
sde
->
dd
,

505 
sde
->
this_idx
);

506 
	`mod_tim”
(&
sde
->
”r_´og»ss_check_tim”
, 
jiff›s
 + 10);

508 
	}
}

510 
	$sdma_”r_´og»ss_check
(
tim”_li¡
 *
t
)

512 
šdex
;

513 
sdma_’gše
 *
sde
 = 
	`äom_tim”
(sde, 
t
, 
”r_´og»ss_check_tim”
);

515 
	`dd_dev_”r
(
sde
->
dd
, "SDE…rogress checkƒvent\n");

516 
šdex
 = 0; index < 
sde
->
dd
->
num_sdma
; index++) {

517 
sdma_’gše
 *
cu¼_sde
 = &
sde
->
dd
->
³r_sdma
[
šdex
];

518 
æags
;

521 ià(
cu¼_sde
 =ð
sde
)

528 
	`¥š_lock_œq§ve
(&
cu¼_sde
->
ž_lock
, 
æags
);

529 
	`wr™e_£qlock
(&
cu¼_sde
->
h—d_lock
);

532 ià(
cu¼_sde
->
¡©e
.
cu¼’t_¡©e
 !ð
sdma_¡©e_s99_ruÂšg
) {

533 
	`wr™e_£quÆock
(&
cu¼_sde
->
h—d_lock
);

534 
	`¥š_uÆock_œq»¡Üe
(&
cu¼_sde
->
ž_lock
, 
æags
);

538 ià((
cu¼_sde
->
descq_h—d
 !ðcu¼_sde->
descq_ž
) &&

539 (
cu¼_sde
->
descq_h—d
 ==

540 
cu¼_sde
->
´og»ss_check_h—d
))

541 
	`__sdma_´oûss_ev’t
(
cu¼_sde
,

542 
sdma_ev’t_e90_sw_h®‹d
);

543 
	`wr™e_£quÆock
(&
cu¼_sde
->
h—d_lock
);

544 
	`¥š_uÆock_œq»¡Üe
(&
cu¼_sde
->
ž_lock
, 
æags
);

546 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

547 
	}
}

549 
	$sdma_hw_þ—n_up_sk
(
Ýaque
)

551 
sdma_’gše
 *
sde
 = (sdma_’gš*)
Ýaque
;

552 
u64
 
¡©usc¤
;

555 #ifdeà
CONFIG_SDMA_VERBOSITY


556 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) %s:%d %s()\n",

557 
sde
->
this_idx
, 
	`¦ash¡r
(
__FILE__
), 
__LINE__
,

558 
__func__
);

560 
¡©usc¤
 = 
	`»ad_sde_c¤
(
sde
, 
	`SD
(
STATUS
));

561 
¡©usc¤
 &ð
	`SD
(
STATUS_ENG_CLEANED_UP_SMASK
);

562 ià(
¡©usc¤
)

564 
	`ud–ay
(10);

567 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e25_hw_þ—n_up_dÚe
);

568 
	}
}

570 
šlše
 
sdma_tx»q
 *
	$g‘_txh—d
(
sdma_’gše
 *
sde
)

572  
sde
->
tx_ršg
[sde->
tx_h—d
 & sde->
sdma_mask
];

573 
	}
}

578 
	$sdma_æush_descq
(
sdma_’gše
 *
sde
)

580 
u16
 
h—d
, 
ž
;

581 
´og»ss
 = 0;

582 
sdma_tx»q
 *
txp
 = 
	`g‘_txh—d
(
sde
);

589 
h—d
 = 
sde
->
descq_h—d
 & sde->
sdma_mask
;

590 
ž
 = 
sde
->
descq_ž
 & sde->
sdma_mask
;

591 
h—d
 !ð
ž
) {

593 
h—d
 = ++
sde
->
descq_h—d
 & sde->
sdma_mask
;

595 ià(
txp
 &&xp->
Ãxt_descq_idx
 =ð
h—d
) {

597 
sde
->
tx_ršg
[sde->
tx_h—d
++ & sde->
sdma_mask
] = 
NULL
;

598 
	`com¶‘e_tx
(
sde
, 
txp
, 
SDMA_TXREQ_S_ABORTED
);

599 
	`Œaû_hfi1_sdma_´og»ss
(
sde
, 
h—d
, 
ž
, 
txp
);

600 
txp
 = 
	`g‘_txh—d
(
sde
);

602 
´og»ss
++;

604 ià(
´og»ss
)

605 
	`sdma_desc_avaž
(
sde
, 
	`sdma_descq_ä“út
(sde));

606 
	}
}

608 
	$sdma_sw_þ—n_up_sk
(
Ýaque
)

610 
sdma_’gše
 *
sde
 = (sdma_’gš*)
Ýaque
;

611 
æags
;

613 
	`¥š_lock_œq§ve
(&
sde
->
ž_lock
, 
æags
);

614 
	`wr™e_£qlock
(&
sde
->
h—d_lock
);

635 
	`sdma_make_´og»ss
(
sde
, 0);

637 
	`sdma_æush
(
sde
);

644 
sde
->
descq_ž
 = 0;

645 
sde
->
descq_h—d
 = 0;

646 
sde
->
desc_avaž
 = 
	`sdma_descq_ä“út
(sde);

647 *
sde
->
h—d_dma
 = 0;

649 
	`__sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e40_sw_þ—Ãd
);

651 
	`wr™e_£quÆock
(&
sde
->
h—d_lock
);

652 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
ž_lock
, 
æags
);

653 
	}
}

655 
	$sdma_sw_‹¬_down
(
sdma_’gše
 *
sde
)

657 
sdma_¡©e
 *
ss
 = &
sde
->
¡©e
;

660 
	`sdma_put
(
ss
);

663 
	`©omic_£t
(&
sde
->
dd
->
sdma_unä“ze_couÁ
, -1);

664 
	`wake_up_š‹¼u±ibË
(&
sde
->
dd
->
sdma_unä“ze_wq
);

665 
	}
}

667 
	$sdma_¡¬t_hw_þ—n_up
(
sdma_’gše
 *
sde
)

669 
	`skËt_hi_scheduË
(&
sde
->
sdma_hw_þ—n_up_sk
);

670 
	}
}

672 
	$sdma_£t_¡©e
(
sdma_’gše
 *
sde
,

673 
sdma_¡©es
 
Ãxt_¡©e
)

675 
sdma_¡©e
 *
ss
 = &
sde
->
¡©e
;

676 cÚ¡ 
sdma_£t_¡©e_aùiÚ
 *
aùiÚ
 = 
sdma_aùiÚ_bË
;

677 
Ý
 = 0;

679 
	`Œaû_hfi1_sdma_¡©e
(

680 
sde
,

681 
sdma_¡©e_Çmes
[
ss
->
cu¼’t_¡©e
],

682 
sdma_¡©e_Çmes
[
Ãxt_¡©e
]);

685 
ss
->
´evious_¡©e
 = ss->
cu¼’t_¡©e
;

686 
ss
->
´evious_Ý
 = ss->
cu¼’t_Ý
;

687 
ss
->
cu¼’t_¡©e
 = 
Ãxt_¡©e
;

689 ià(
ss
->
´evious_¡©e
 !ð
sdma_¡©e_s99_ruÂšg
 &&

690 
Ãxt_¡©e
 =ð
sdma_¡©e_s99_ruÂšg
)

691 
	`sdma_æush
(
sde
);

693 ià(
aùiÚ
[
Ãxt_¡©e
].
Ý_’abË
)

694 
Ý
 |ð
SDMA_SENDCTRL_OP_ENABLE
;

696 ià(
aùiÚ
[
Ãxt_¡©e
].
Ý_š‹ÇbË
)

697 
Ý
 |ð
SDMA_SENDCTRL_OP_INTENABLE
;

699 ià(
aùiÚ
[
Ãxt_¡©e
].
Ý_h®t
)

700 
Ý
 |ð
SDMA_SENDCTRL_OP_HALT
;

702 ià(
aùiÚ
[
Ãxt_¡©e
].
Ý_þ—nup
)

703 
Ý
 |ð
SDMA_SENDCTRL_OP_CLEANUP
;

705 ià(
aùiÚ
[
Ãxt_¡©e
].
go_s99_ruÂšg_toçl£
)

706 
ss
->
go_s99_ruÂšg
 = 0;

708 ià(
aùiÚ
[
Ãxt_¡©e
].
go_s99_ruÂšg_tÙrue
)

709 
ss
->
go_s99_ruÂšg
 = 1;

711 
ss
->
cu¼’t_Ý
 = 
Ý
;

712 
	`sdma_£ndù¾
(
sde
, 
ss
->
cu¼’t_Ý
);

713 
	}
}

727 
u16
 
	$sdma_g‘_descq_út
()

729 
u16
 
couÁ
 = 
sdma_descq_út
;

731 ià(!
couÁ
)

732  
SDMA_DESCQ_CNT
;

736 ià(!
	`is_pow”_of_2
(
couÁ
))

737  
SDMA_DESCQ_CNT
;

738 ià(
couÁ
 < 64 || count > 32768)

739  
SDMA_DESCQ_CNT
;

740  
couÁ
;

741 
	}
}

750 
	$sdma_’gše_g‘_vl
(
sdma_’gše
 *
sde
)

752 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

753 
sdma_vl_m­
 *
m
;

754 
u8
 
vl
;

756 ià(
sde
->
this_idx
 >ð
TXE_NUM_SDMA_ENGINES
)

757  -
EINVAL
;

759 
	`rcu_»ad_lock
();

760 
m
 = 
	`rcu_d”eã»nû
(
dd
->
sdma_m­
);

761 ià(
	`uÆik–y
(!
m
)) {

762 
	`rcu_»ad_uÆock
();

763  -
EINVAL
;

765 
vl
 = 
m
->
’gše_to_vl
[
sde
->
this_idx
];

766 
	`rcu_»ad_uÆock
();

768  
vl
;

769 
	}
}

781 
sdma_’gše
 *
	$sdma_£Ëù_’gše_vl
(

782 
hfi1_devd©a
 *
dd
,

783 
u32
 
£ËùÜ
,

784 
u8
 
vl
)

786 
sdma_vl_m­
 *
m
;

787 
sdma_m­_–em
 *
e
;

788 
sdma_’gše
 *
rv®
;

794 ià(
vl
 >ð
num_vls
) {

795 
rv®
 = 
NULL
;

796 
dÚe
;

799 
	`rcu_»ad_lock
();

800 
m
 = 
	`rcu_d”eã»nû
(
dd
->
sdma_m­
);

801 ià(
	`uÆik–y
(!
m
)) {

802 
	`rcu_»ad_uÆock
();

803  &
dd
->
³r_sdma
[0];

805 
e
 = 
m
->
m­
[
vl
 & m->
mask
];

806 
rv®
 = 
e
->
sde
[
£ËùÜ
 &ƒ->
mask
];

807 
	`rcu_»ad_uÆock
();

809 
dÚe
:

810 
rv®
 = !rv® ? &
dd
->
³r_sdma
[0] :„val;

811 
	`Œaû_hfi1_sdma_’gše_£Ëù
(
dd
, 
£ËùÜ
, 
vl
, 
rv®
->
this_idx
);

812  
rv®
;

813 
	}
}

824 
sdma_’gše
 *
	$sdma_£Ëù_’gše_sc
(

825 
hfi1_devd©a
 *
dd
,

826 
u32
 
£ËùÜ
,

827 
u8
 
sc5
)

829 
u8
 
vl
 = 
	`sc_to_vÉ
(
dd
, 
sc5
);

831  
	`sdma_£Ëù_’gše_vl
(
dd
, 
£ËùÜ
, 
vl
);

832 
	}
}

834 
	ssdma_rht_m­_–em
 {

835 
u32
 
	mmask
;

836 
u8
 
	mùr
;

837 
sdma_’gše
 *
	msde
[0];

840 
	ssdma_rht_node
 {

841 
	mýu_id
;

842 
sdma_rht_m­_–em
 *
	mm­
[
HFI1_MAX_VLS_SUPPORTED
];

843 
rhash_h—d
 
	mnode
;

846 
	#NR_CPUS_HINT
 192

	)

848 cÚ¡ 
rhashbË_·¿ms
 
	gsdma_rht_·¿ms
 = {

849 .
ÃËm_hšt
 = 
NR_CPUS_HINT
,

850 .
	gh—d_off£t
 = 
off£tof
(
sdma_rht_node
, 
node
),

851 .
	gkey_off£t
 = 
off£tof
(
sdma_rht_node
, 
ýu_id
),

852 .
	gkey_Ën
 = 
FIELD_SIZEOF
(
sdma_rht_node
, 
ýu_id
),

853 .
	gmax_size
 = 
NR_CPUS
,

854 .
	gmš_size
 = 8,

855 .
	gautom©ic_shrškšg
 = 
Œue
,

869 
sdma_’gše
 *
	$sdma_£Ëù_u£r_’gše
(
hfi1_devd©a
 *
dd
,

870 
u32
 
£ËùÜ
, 
u8
 
vl
)

872 
sdma_rht_node
 *
rht_node
;

873 
sdma_’gše
 *
sde
 = 
NULL
;

874 
ýu_id
;

880 ià(
cu¼’t
->
Ä_ýus_®lowed
 != 1)

881 
out
;

883 
ýu_id
 = 
	`smp_´oûssÜ_id
();

884 
	`rcu_»ad_lock
();

885 
rht_node
 = 
	`rhashbË_lookup_ç¡
(
dd
->
sdma_rht
, &
ýu_id
,

886 
sdma_rht_·¿ms
);

888 ià(
rht_node
 &&„ht_node->
m­
[
vl
]) {

889 
sdma_rht_m­_–em
 *
m­
 = 
rht_node
->m­[
vl
];

891 
sde
 = 
m­
->sde[
£ËùÜ
 & m­->
mask
];

893 
	`rcu_»ad_uÆock
();

895 ià(
sde
)

896  
sde
;

898 
out
:

899  
	`sdma_£Ëù_’gše_vl
(
dd
, 
£ËùÜ
, 
vl
);

900 
	}
}

902 
	$sdma_pÝuÏ‹_sde_m­
(
sdma_rht_m­_–em
 *
m­
)

904 
i
;

906 
i
 = 0; i < 
	`roundup_pow_of_two
(
m­
->
ùr
 ? : 1) - map->ctr; i++)

907 
m­
->
sde
[m­->
ùr
 + 
i
] = map->sde[i];

908 
	}
}

910 
	$sdma_þ—nup_sde_m­
(
sdma_rht_m­_–em
 *
m­
,

911 
sdma_’gše
 *
sde
)

913 
i
, 
pow
;

916 
i
 = 0; i < 
m­
->
ùr
; i++) {

917 ià(
m­
->
sde
[
i
] == sde) {

918 
	`memmove
(&
m­
->
sde
[
i
], &map->sde[i + 1],

919 (
m­
->
ùr
 - 
i
 - 1è* (m­->
sde
[0]));

920 
m­
->
ùr
--;

921 
pow
 = 
	`roundup_pow_of_two
(
m­
->
ùr
 ? : 1);

922 
m­
->
mask
 = 
pow
 - 1;

923 
	`sdma_pÝuÏ‹_sde_m­
(
m­
);

927 
	}
}

932 
DEFINE_MUTEX
(
´oûss_to_sde_mu‹x
);

934 
ssize_t
 
	$sdma_£t_ýu_to_sde_m­
(
sdma_’gše
 *
sde
, cÚ¡ *
buf
,

935 
size_t
 
couÁ
)

937 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

938 
ýumask_v¬_t
 
mask
, 
Ãw_mask
;

939 
ýu
;

940 
»t
, 
vl
, 
sz
;

941 
sdma_rht_node
 *
rht_node
;

943 
vl
 = 
	`sdma_’gše_g‘_vl
(
sde
);

944 ià(
	`uÆik–y
(
vl
 < 0 || vÈ>ð
	`ARRAY_SIZE
(
rht_node
->
m­
)))

945  -
EINVAL
;

947 
»t
 = 
	`z®loc_ýumask_v¬
(&
mask
, 
GFP_KERNEL
);

948 ià(!
»t
)

949  -
ENOMEM
;

951 
»t
 = 
	`z®loc_ýumask_v¬
(&
Ãw_mask
, 
GFP_KERNEL
);

952 ià(!
»t
) {

953 
	`ä“_ýumask_v¬
(
mask
);

954  -
ENOMEM
;

956 
»t
 = 
	`ýuli¡_·r£
(
buf
, 
mask
);

957 ià(
»t
)

958 
out_ä“
;

960 ià(!
	`ýumask_sub£t
(
mask
, 
ýu_Úlše_mask
)) {

961 
	`dd_dev_w¬n
(
sde
->
dd
, "Invalid CPU mask\n");

962 
»t
 = -
EINVAL
;

963 
out_ä“
;

966 
sz
 = (
sdma_rht_m­_–em
) +

967 (
TXE_NUM_SDMA_ENGINES
 * (
sdma_’gše
 *));

969 
	`mu‹x_lock
(&
´oûss_to_sde_mu‹x
);

971 
	`fÜ_—ch_ýu
(
ýu
, 
mask
) {

973 ià(
	`ýumask_‹¡_ýu
(
ýu
, &
sde
->
ýu_mask
)) {

974 
	`ýumask_£t_ýu
(
ýu
, 
Ãw_mask
);

978 
rht_node
 = 
	`rhashbË_lookup_ç¡
(
dd
->
sdma_rht
, &
ýu
,

979 
sdma_rht_·¿ms
);

980 ià(!
rht_node
) {

981 
rht_node
 = 
	`kz®loc
((*rht_node), 
GFP_KERNEL
);

982 ià(!
rht_node
) {

983 
»t
 = -
ENOMEM
;

984 
out
;

987 ià(
vl
 >ð
	`ARRAY_SIZE
(
rht_node
->
m­
)) {

988 
»t
 = -
EINVAL
;

989 
out
;

992 
rht_node
->
m­
[
vl
] = 
	`kz®loc
(
sz
, 
GFP_KERNEL
);

993 ià(!
rht_node
->
m­
[
vl
]) {

994 
	`kä“
(
rht_node
);

995 
»t
 = -
ENOMEM
;

996 
out
;

998 
rht_node
->
ýu_id
 = 
ýu
;

999 
rht_node
->
m­
[
vl
]->
mask
 = 0;

1000 
rht_node
->
m­
[
vl
]->
ùr
 = 1;

1001 
rht_node
->
m­
[
vl
]->
sde
[0] = sde;

1003 
»t
 = 
	`rhashbË_š£¹_ç¡
(
dd
->
sdma_rht
,

1004 &
rht_node
->
node
,

1005 
sdma_rht_·¿ms
);

1006 ià(
»t
) {

1007 
	`kä“
(
rht_node
->
m­
[
vl
]);

1008 
	`kä“
(
rht_node
);

1009 
	`dd_dev_”r
(
sde
->
dd
, "Failedo set…rocesso sde‡ffinity for cpu %lu\n",

1010 
ýu
);

1011 
out
;

1015 
ùr
, 
pow
;

1018 ià(!
rht_node
->
m­
[
vl
])

1019 
rht_node
->
m­
[
vl
] = 
	`kz®loc
(
sz
, 
GFP_KERNEL
);

1021 ià(!
rht_node
->
m­
[
vl
]) {

1022 
»t
 = -
ENOMEM
;

1023 
out
;

1026 
rht_node
->
m­
[
vl
]->
ùr
++;

1027 
ùr
 = 
rht_node
->
m­
[
vl
]->ctr;

1028 
rht_node
->
m­
[
vl
]->
sde
[
ùr
 - 1] = sde;

1029 
pow
 = 
	`roundup_pow_of_two
(
ùr
);

1030 
rht_node
->
m­
[
vl
]->
mask
 = 
pow
 - 1;

1033 
	`sdma_pÝuÏ‹_sde_m­
(
rht_node
->
m­
[
vl
]);

1035 
	`ýumask_£t_ýu
(
ýu
, 
Ãw_mask
);

1039 
	`fÜ_—ch_ýu
(
ýu
, 
ýu_Úlše_mask
) {

1040 
sdma_rht_node
 *
rht_node
;

1043 ià(
	`ýumask_‹¡_ýu
(
ýu
, 
mask
))

1046 
rht_node
 = 
	`rhashbË_lookup_ç¡
(
dd
->
sdma_rht
, &
ýu
,

1047 
sdma_rht_·¿ms
);

1048 ià(
rht_node
) {

1049 
boÞ
 
em±y
 = 
Œue
;

1050 
i
;

1053 
i
 = 0; i < 
HFI1_MAX_VLS_SUPPORTED
; i++)

1054 ià(
rht_node
->
m­
[
i
])

1055 
	`sdma_þ—nup_sde_m­
(
rht_node
->
m­
[
i
],

1056 
sde
);

1059 
i
 = 0; i < 
HFI1_MAX_VLS_SUPPORTED
; i++) {

1060 ià(!
rht_node
->
m­
[
i
])

1063 ià(
rht_node
->
m­
[
i
]->
ùr
) {

1064 
em±y
 = 
çl£
;

1069 ià(
em±y
) {

1070 
»t
 = 
	`rhashbË_»move_ç¡
(
dd
->
sdma_rht
,

1071 &
rht_node
->
node
,

1072 
sdma_rht_·¿ms
);

1073 
	`WARN_ON
(
»t
);

1075 
i
 = 0; i < 
HFI1_MAX_VLS_SUPPORTED
; i++)

1076 
	`kä“
(
rht_node
->
m­
[
i
]);

1078 
	`kä“
(
rht_node
);

1083 
	`ýumask_cÝy
(&
sde
->
ýu_mask
, 
Ãw_mask
);

1084 
out
:

1085 
	`mu‹x_uÆock
(&
´oûss_to_sde_mu‹x
);

1086 
out_ä“
:

1087 
	`ä“_ýumask_v¬
(
mask
);

1088 
	`ä“_ýumask_v¬
(
Ãw_mask
);

1089  
»t
 ? : 
	`¡ºËn
(
buf
, 
PAGE_SIZE
);

1090 
	}
}

1092 
ssize_t
 
	$sdma_g‘_ýu_to_sde_m­
(
sdma_’gše
 *
sde
, *
buf
)

1094 
	`mu‹x_lock
(&
´oûss_to_sde_mu‹x
);

1095 ià(
	`ýumask_em±y
(&
sde
->
ýu_mask
))

1096 
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", "empty");

1098 
	`ýum­_´št_to_·gebuf
(
Œue
, 
buf
, &
sde
->
ýu_mask
);

1099 
	`mu‹x_uÆock
(&
´oûss_to_sde_mu‹x
);

1100  
	`¡ºËn
(
buf
, 
PAGE_SIZE
);

1101 
	}
}

1103 
	$sdma_rht_ä“
(*
±r
, *
¬g
)

1105 
sdma_rht_node
 *
rht_node
 = 
±r
;

1106 
i
;

1108 
i
 = 0; i < 
HFI1_MAX_VLS_SUPPORTED
; i++)

1109 
	`kä“
(
rht_node
->
m­
[
i
]);

1111 
	`kä“
(
rht_node
);

1112 
	}
}

1122 
	$sdma_£qfže_dump_ýu_li¡
(
£q_fže
 *
s
,

1123 
hfi1_devd©a
 *
dd
,

1124 
ýuid
)

1126 
sdma_rht_node
 *
rht_node
;

1127 
i
, 
j
;

1129 
rht_node
 = 
	`rhashbË_lookup_ç¡
(
dd
->
sdma_rht
, &
ýuid
,

1130 
sdma_rht_·¿ms
);

1131 ià(!
rht_node
)

1134 
	`£q_´štf
(
s
, "ýu%3lu: ", 
ýuid
);

1135 
i
 = 0; i < 
HFI1_MAX_VLS_SUPPORTED
; i++) {

1136 ià(!
rht_node
->
m­
[
i
] || !rht_node->m­[i]->
ùr
)

1139 
	`£q_´štf
(
s
, " vl%d: [", 
i
);

1141 
j
 = 0; j < 
rht_node
->
m­
[
i
]->
ùr
; j++) {

1142 ià(!
rht_node
->
m­
[
i
]->
sde
[
j
])

1145 ià(
j
 > 0)

1146 
	`£q_puts
(
s
, ",");

1148 
	`£q_´štf
(
s
, " sdma%2d",

1149 
rht_node
->
m­
[
i
]->
sde
[
j
]->
this_idx
);

1151 
	`£q_puts
(
s
, " ]");

1154 
	`£q_puts
(
s
, "\n");

1155 
	}
}

1160 
	$sdma_m­_ä“
(
sdma_vl_m­
 *
m
)

1162 
i
;

1164 
i
 = 0; 
m
 && i < m->
aùu®_vls
; i++)

1165 
	`kä“
(
m
->
m­
[
i
]);

1166 
	`kä“
(
m
);

1167 
	}
}

1172 
	$sdma_m­_rcu_ÿÎback
(
rcu_h—d
 *
li¡
)

1174 
sdma_vl_m­
 *
m
 = 
	`cÚš”_of
(
li¡
, sdma_vl_map,†ist);

1176 
	`sdma_m­_ä“
(
m
);

1177 
	}
}

1206 
	$sdma_m­_š™
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
, u8 
num_vls
, u8 *
vl_’gšes
)

1208 
i
, 
j
;

1209 
exŒa
, 
sde_³r_vl
;

1210 
’gše
 = 0;

1211 
u8
 
lvl_’gšes
[
OPA_MAX_VLS
];

1212 
sdma_vl_m­
 *
Þdm­
, *
Ãwm­
;

1214 ià(!(
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
))

1217 ià(!
vl_’gšes
) {

1219 
sde_³r_vl
 = 
dd
->
num_sdma
 / 
num_vls
;

1221 
exŒa
 = 
dd
->
num_sdma
 % 
num_vls
;

1222 
vl_’gšes
 = 
lvl_’gšes
;

1224 
i
 = 
num_vls
 - 1; i >ð0; i--, 
exŒa
--)

1225 
vl_’gšes
[
i
] = 
sde_³r_vl
 + (
exŒa
 > 0 ? 1 : 0);

1228 
Ãwm­
 = 
	`kz®loc
(

1229 (
sdma_vl_m­
) +

1230 
	`roundup_pow_of_two
(
num_vls
) *

1231 (
sdma_m­_–em
 *),

1232 
GFP_KERNEL
);

1233 ià(!
Ãwm­
)

1234 
baž
;

1235 
Ãwm­
->
aùu®_vls
 = 
num_vls
;

1236 
Ãwm­
->
vls
 = 
	`roundup_pow_of_two
(
num_vls
);

1237 
Ãwm­
->
mask
 = (1 << 
	`žog2
Òewm­->
vls
)) - 1;

1239 
i
 = 0; i < 
TXE_NUM_SDMA_ENGINES
; i++)

1240 
Ãwm­
->
’gše_to_vl
[
i
] = -1;

1241 
i
 = 0; i < 
Ãwm­
->
vls
; i++) {

1243 
fœ¡_’gše
 = 
’gše
;

1245 ià(
i
 < 
Ãwm­
->
aùu®_vls
) {

1246 
sz
 = 
	`roundup_pow_of_two
(
vl_’gšes
[
i
]);

1249 
Ãwm­
->
m­
[
i
] = 
	`kz®loc
(

1250 (
sdma_m­_–em
) +

1251 
sz
 * (
sdma_’gše
 *),

1252 
GFP_KERNEL
);

1253 ià(!
Ãwm­
->
m­
[
i
])

1254 
baž
;

1255 
Ãwm­
->
m­
[
i
]->
mask
 = (1 << 
	`žog2
(
sz
)) - 1;

1257 
j
 = 0; j < 
sz
; j++) {

1258 
Ãwm­
->
m­
[
i
]->
sde
[
j
] =

1259 &
dd
->
³r_sdma
[
’gše
];

1260 ià(++
’gše
 >ð
fœ¡_’gše
 + 
vl_’gšes
[
i
])

1262 
’gše
 = 
fœ¡_’gše
;

1265 
j
 = 0; j < 
vl_’gšes
[
i
]; j++)

1266 
Ãwm­
->
’gše_to_vl
[
fœ¡_’gše
 + 
j
] = 
i
;

1269 
Ãwm­
->
m­
[
i
] =‚ewm­->m­[˜% 
num_vls
];

1271 
’gše
 = 
fœ¡_’gše
 + 
vl_’gšes
[
i
];

1274 
	`¥š_lock_œq
(&
dd
->
sde_m­_lock
);

1275 
Þdm­
 = 
	`rcu_d”eã»nû_´Ùeùed
(
dd
->
sdma_m­
,

1276 
	`lockd•_is_h–d
(&
dd
->
sde_m­_lock
));

1279 
	`rcu_assign_poš‹r
(
dd
->
sdma_m­
, 
Ãwm­
);

1281 
	`¥š_uÆock_œq
(&
dd
->
sde_m­_lock
);

1283 ià(
Þdm­
)

1284 
	`ÿÎ_rcu
(&
Þdm­
->
li¡
, 
sdma_m­_rcu_ÿÎback
);

1286 
baž
:

1288 
	`sdma_m­_ä“
(
Ãwm­
);

1289  -
ENOMEM
;

1290 
	}
}

1300 
	$sdma_þ—n
(
hfi1_devd©a
 *
dd
, 
size_t
 
num_’gšes
)

1302 
size_t
 
i
;

1303 
sdma_’gše
 *
sde
;

1305 ià(
dd
->
sdma_·d_dma
) {

1306 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, 
SDMA_PAD
,

1307 (*)
dd
->
sdma_·d_dma
,

1308 
dd
->
sdma_·d_phys
);

1309 
dd
->
sdma_·d_dma
 = 
NULL
;

1310 
dd
->
sdma_·d_phys
 = 0;

1312 ià(
dd
->
sdma_h—ds_dma
) {

1313 
	`dma_ä“_coh”’t
(&
dd
->
pcidev
->
dev
, dd->
sdma_h—ds_size
,

1314 (*)
dd
->
sdma_h—ds_dma
,

1315 
dd
->
sdma_h—ds_phys
);

1316 
dd
->
sdma_h—ds_dma
 = 
NULL
;

1317 
dd
->
sdma_h—ds_phys
 = 0;

1319 
i
 = 0; 
dd
->
³r_sdma
 && i < 
num_’gšes
; ++i) {

1320 
sde
 = &
dd
->
³r_sdma
[
i
];

1322 
sde
->
h—d_dma
 = 
NULL
;

1323 
sde
->
h—d_phys
 = 0;

1325 ià(
sde
->
descq
) {

1326 
	`dma_ä“_coh”’t
(

1327 &
dd
->
pcidev
->
dev
,

1328 
sde
->
descq_út
 * (
u64
[2]),

1329 
sde
->
descq
,

1330 
sde
->
descq_phys


1332 
sde
->
descq
 = 
NULL
;

1333 
sde
->
descq_phys
 = 0;

1335 
	`kvä“
(
sde
->
tx_ršg
);

1336 
sde
->
tx_ršg
 = 
NULL
;

1338 
	`¥š_lock_œq
(&
dd
->
sde_m­_lock
);

1339 
	`sdma_m­_ä“
(
	`rcu_acûss_poš‹r
(
dd
->
sdma_m­
));

1340 
	`RCU_INIT_POINTER
(
dd
->
sdma_m­
, 
NULL
);

1341 
	`¥š_uÆock_œq
(&
dd
->
sde_m­_lock
);

1342 
	`synchrÚize_rcu
();

1343 
	`kä“
(
dd
->
³r_sdma
);

1344 
dd
->
³r_sdma
 = 
NULL
;

1346 ià(
dd
->
sdma_rht
) {

1347 
	`rhashbË_ä“_ªd_de¡roy
(
dd
->
sdma_rht
, 
sdma_rht_ä“
, 
NULL
);

1348 
	`kä“
(
dd
->
sdma_rht
);

1349 
dd
->
sdma_rht
 = 
NULL
;

1351 
	}
}

1364 
	$sdma_š™
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
)

1366 
this_idx
;

1367 
sdma_’gše
 *
sde
;

1368 
rhashbË
 *
tmp_sdma_rht
;

1369 
u16
 
descq_út
;

1370 *
cu¼_h—d
;

1371 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
 + 
pÜt
;

1372 
u32
 
³r_sdma_üed™s
;

1373 
ušt
 
idË_út
 = 
sdma_idË_út
;

1374 
size_t
 
num_’gšes
 = 
	`ch_sdma_’gšes
(
dd
);

1375 
»t
 = -
ENOMEM
;

1377 ià(!
	`HFI1_CAP_IS_KSET
(
SDMA
)) {

1378 
	`HFI1_CAP_CLEAR
(
SDMA_AHG
);

1381 ià(
mod_num_sdma
 &&

1383 
mod_num_sdma
 <ð
	`ch_sdma_’gšes
(
dd
) &&

1385 
mod_num_sdma
 >ð
num_vls
)

1386 
num_’gšes
 = 
mod_num_sdma
;

1388 
	`dd_dev_šfo
(
dd
, "SDMA mod_num_sdma: %u\n", 
mod_num_sdma
);

1389 
	`dd_dev_šfo
(
dd
, "SDMA ch_sdma_’gšes: %u\n", 
	`ch_sdma_’gšes
(dd));

1390 
	`dd_dev_šfo
(
dd
, "SDMA chip_sdma_mem_size: %u\n",

1391 
	`ch_sdma_mem_size
(
dd
));

1393 
³r_sdma_üed™s
 =

1394 
	`ch_sdma_mem_size
(
dd
è/ (
num_’gšes
 * 
SDMA_BLOCK_SIZE
);

1397 
	`š™_wa™queue_h—d
(&
dd
->
sdma_unä“ze_wq
);

1398 
	`©omic_£t
(&
dd
->
sdma_unä“ze_couÁ
, 0);

1400 
descq_út
 = 
	`sdma_g‘_descq_út
();

1401 
	`dd_dev_šfo
(
dd
, "SDMAƒngines %zu descq_cnt %u\n",

1402 
num_’gšes
, 
descq_út
);

1405 
dd
->
³r_sdma
 = 
	`kÿÎoc_node
(
num_’gšes
, (*dd->per_sdma),

1406 
GFP_KERNEL
, 
dd
->
node
);

1407 ià(!
dd
->
³r_sdma
)

1408  
»t
;

1410 
idË_út
 = 
	`ns_to_cþock
(
dd
, idle_cnt);

1411 ià(
idË_út
)

1412 
dd
->
deçuÉ_desc1
 =

1413 
SDMA_DESC1_HEAD_TO_HOST_FLAG
;

1415 
dd
->
deçuÉ_desc1
 =

1416 
SDMA_DESC1_INT_REQ_FLAG
;

1418 ià(!
sdma_desù_šŒ
)

1419 
sdma_desù_šŒ
 = 
SDMA_DESC_INTR
;

1422 
this_idx
 = 0;his_idx < 
num_’gšes
; ++this_idx) {

1423 
sde
 = &
dd
->
³r_sdma
[
this_idx
];

1424 
sde
->
dd
 = dd;

1425 
sde
->
µd
 =…pd;

1426 
sde
->
this_idx
 =his_idx;

1427 
sde
->
descq_út
 = descq_cnt;

1428 
sde
->
desc_avaž
 = 
	`sdma_descq_ä“út
(sde);

1429 
sde
->
sdma_shiá
 = 
	`žog2
(
descq_út
);

1430 
sde
->
sdma_mask
 = (1 << sde->
sdma_shiá
) - 1;

1433 
sde
->
št_mask
 = (
u64
)1 << (0 * 
TXE_NUM_SDMA_ENGINES
 +

1434 
this_idx
);

1435 
sde
->
´og»ss_mask
 = (
u64
)1 << (1 * 
TXE_NUM_SDMA_ENGINES
 +

1436 
this_idx
);

1437 
sde
->
idË_mask
 = (
u64
)1 << (2 * 
TXE_NUM_SDMA_ENGINES
 +

1438 
this_idx
);

1440 
sde
->
imask
 = sde->
št_mask
 | sde->
´og»ss_mask
 |

1441 
sde
->
idË_mask
;

1443 
	`¥š_lock_š™
(&
sde
->
ž_lock
);

1444 
	`£qlock_š™
(&
sde
->
h—d_lock
);

1445 
	`¥š_lock_š™
(&
sde
->
£nddmaù¾_lock
);

1446 
	`¥š_lock_š™
(&
sde
->
æushli¡_lock
);

1447 
	`£qlock_š™
(&
sde
->
wa™lock
);

1449 
sde
->
ahg_b™s
 = 0xfffffffe00000000ULL;

1451 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

1454 
	`k»f_š™
(&
sde
->
¡©e
.
k»f
);

1455 
	`š™_com¶‘iÚ
(&
sde
->
¡©e
.
comp
);

1457 
	`INIT_LIST_HEAD
(&
sde
->
æushli¡
);

1458 
	`INIT_LIST_HEAD
(&
sde
->
dmawa™
);

1460 
sde
->
ž_c¤
 =

1461 
	`g‘_kùxt_c¤_addr
(
dd
, 
this_idx
, 
	`SD
(
TAIL
));

1463 
	`skËt_š™
(&
sde
->
sdma_hw_þ—n_up_sk
, sdma_hw_clean_up_task,

1464 ()
sde
);

1466 
	`skËt_š™
(&
sde
->
sdma_sw_þ—n_up_sk
, sdma_sw_clean_up_task,

1467 ()
sde
);

1468 
	`INIT_WORK
(&
sde
->
”r_h®t_wÜk”
, 
sdma_”r_h®t_wa™
);

1469 
	`INIT_WORK
(&
sde
->
æush_wÜk”
, 
sdma_f›ld_æush
);

1471 
sde
->
´og»ss_check_h—d
 = 0;

1473 
	`tim”_£tup
(&
sde
->
”r_´og»ss_check_tim”
,

1474 
sdma_”r_´og»ss_check
, 0);

1476 
sde
->
descq
 = 
	`dma_®loc_coh”’t
(&
dd
->
pcidev
->
dev
,

1477 
descq_út
 * (
u64
[2]),

1478 &
sde
->
descq_phys
, 
GFP_KERNEL
);

1479 ià(!
sde
->
descq
)

1480 
baž
;

1481 
sde
->
tx_ršg
 =

1482 
	`kvz®loc_node
(
	`¬¿y_size
(
descq_út
,

1483 (
sdma_tx»q
 *)),

1484 
GFP_KERNEL
, 
dd
->
node
);

1485 ià(!
sde
->
tx_ršg
)

1486 
baž
;

1489 
dd
->
sdma_h—ds_size
 = 
L1_CACHE_BYTES
 * 
num_’gšes
;

1491 
dd
->
sdma_h—ds_dma
 = 
	`dma_®loc_coh”’t
(&dd->
pcidev
->
dev
,

1492 
dd
->
sdma_h—ds_size
,

1493 &
dd
->
sdma_h—ds_phys
,

1494 
GFP_KERNEL
);

1495 ià(!
dd
->
sdma_h—ds_dma
) {

1496 
	`dd_dev_”r
(
dd
, "failedo‡llocate SendDMA head memory\n");

1497 
baž
;

1501 
dd
->
sdma_·d_dma
 = 
	`dma_®loc_coh”’t
(&dd->
pcidev
->
dev
, 
SDMA_PAD
,

1502 &
dd
->
sdma_·d_phys
, 
GFP_KERNEL
);

1503 ià(!
dd
->
sdma_·d_dma
) {

1504 
	`dd_dev_”r
(
dd
, "failedo‡llocate SendDMA…ad memory\n");

1505 
baž
;

1509 
cu¼_h—d
 = (*)
dd
->
sdma_h—ds_dma
;

1510 
this_idx
 = 0;his_idx < 
num_’gšes
; ++this_idx) {

1511 
phys_off£t
;

1513 
sde
 = &
dd
->
³r_sdma
[
this_idx
];

1515 
sde
->
h—d_dma
 = 
cu¼_h—d
;

1516 
cu¼_h—d
 +ð
L1_CACHE_BYTES
;

1517 
phys_off£t
 = ()
sde
->
h—d_dma
 -

1518 ()
dd
->
sdma_h—ds_dma
;

1519 
sde
->
h—d_phys
 = 
dd
->
sdma_h—ds_phys
 + 
phys_off£t
;

1520 
	`š™_sdma_»gs
(
sde
, 
³r_sdma_üed™s
, 
idË_út
);

1522 
dd
->
æags
 |ð
HFI1_HAS_SEND_DMA
;

1523 
dd
->
æags
 |ð
idË_út
 ? 
HFI1_HAS_SDMA_TIMEOUT
 : 0;

1524 
dd
->
num_sdma
 = 
num_’gšes
;

1525 
»t
 = 
	`sdma_m­_š™
(
dd
, 
pÜt
, 
µd
->
vls_Ý”©iÚ®
, 
NULL
);

1526 ià(
»t
 < 0)

1527 
baž
;

1529 
tmp_sdma_rht
 = 
	`kz®loc
((*tmp_sdma_rht), 
GFP_KERNEL
);

1530 ià(!
tmp_sdma_rht
) {

1531 
»t
 = -
ENOMEM
;

1532 
baž
;

1535 
»t
 = 
	`rhashbË_š™
(
tmp_sdma_rht
, &
sdma_rht_·¿ms
);

1536 ià(
»t
 < 0) {

1537 
	`kä“
(
tmp_sdma_rht
);

1538 
baž
;

1541 
dd
->
sdma_rht
 = 
tmp_sdma_rht
;

1543 
	`dd_dev_šfo
(
dd
, "SDMA‚um_sdma: %u\n", dd->
num_sdma
);

1546 
baž
:

1547 
	`sdma_þ—n
(
dd
, 
num_’gšes
);

1548  
»t
;

1549 
	}
}

1557 
	$sdma_®l_ruÂšg
(
hfi1_devd©a
 *
dd
)

1559 
sdma_’gše
 *
sde
;

1560 
i
;

1563 
i
 = 0; i < 
dd
->
num_sdma
; ++i) {

1564 
sde
 = &
dd
->
³r_sdma
[
i
];

1565 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e30_go_ruÂšg
);

1567 
	}
}

1575 
	$sdma_®l_idË
(
hfi1_devd©a
 *
dd
)

1577 
sdma_’gše
 *
sde
;

1578 
i
;

1581 
i
 = 0; i < 
dd
->
num_sdma
; ++i) {

1582 
sde
 = &
dd
->
³r_sdma
[
i
];

1583 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e70_go_idË
);

1585 
	}
}

1595 
	$sdma_¡¬t
(
hfi1_devd©a
 *
dd
)

1597 
i
;

1598 
sdma_’gše
 *
sde
;

1601 
i
 = 0; i < 
dd
->
num_sdma
; ++i) {

1602 
sde
 = &
dd
->
³r_sdma
[
i
];

1603 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e10_go_hw_¡¬t
);

1605 
	}
}

1611 
	$sdma_ex™
(
hfi1_devd©a
 *
dd
)

1613 
this_idx
;

1614 
sdma_’gše
 *
sde
;

1616 
this_idx
 = 0; 
dd
->
³r_sdma
 &&his_idx < dd->
num_sdma
;

1617 ++
this_idx
) {

1618 
sde
 = &
dd
->
³r_sdma
[
this_idx
];

1619 ià(!
	`li¡_em±y
(&
sde
->
dmawa™
))

1620 
	`dd_dev_”r
(
dd
, "sde %u: dmawait†ist‚otƒmpty!\n",

1621 
sde
->
this_idx
);

1622 
	`sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e00_go_hw_down
);

1624 
	`d–_tim”_sync
(&
sde
->
”r_´og»ss_check_tim”
);

1631 
	`sdma_fš®put
(&
sde
->
¡©e
);

1633 
	}
}

1638 
šlše
 
	$sdma_unm­_desc
(

1639 
hfi1_devd©a
 *
dd
,

1640 
sdma_desc
 *
desý
)

1642 
	`sdma_m­pšg_ty³
(
desý
)) {

1643 
SDMA_MAP_SINGLE
:

1644 
	`dma_unm­_sšgË
(

1645 &
dd
->
pcidev
->
dev
,

1646 
	`sdma_m­pšg_addr
(
desý
),

1647 
	`sdma_m­pšg_Ën
(
desý
),

1648 
DMA_TO_DEVICE
);

1650 
SDMA_MAP_PAGE
:

1651 
	`dma_unm­_·ge
(

1652 &
dd
->
pcidev
->
dev
,

1653 
	`sdma_m­pšg_addr
(
desý
),

1654 
	`sdma_m­pšg_Ën
(
desý
),

1655 
DMA_TO_DEVICE
);

1658 
	}
}

1664 
šlše
 
u8
 
	$ahg_mode
(
sdma_tx»q
 *
tx
)

1666  (
tx
->
desý
[0].
qw
[1] & 
SDMA_DESC1_HEADER_MODE_SMASK
)

1667 >> 
SDMA_DESC1_HEADER_MODE_SHIFT
;

1668 
	}
}

1681 
	$__sdma_txþ—n
(

1682 
hfi1_devd©a
 *
dd
,

1683 
sdma_tx»q
 *
tx
)

1685 
u16
 
i
;

1687 ià(
tx
->
num_desc
) {

1688 
u8
 
sk
 = 0, 
mode
 = 
	`ahg_mode
(
tx
);

1691 
	`sdma_unm­_desc
(
dd
, &
tx
->
desý
[0]);

1693 ià(
mode
 > 
SDMA_AHG_APPLY_UPDATE1
)

1694 
sk
 = 
mode
 >> 1;

1695 
i
 = 1 + 
sk
; i < 
tx
->
num_desc
; i++)

1696 
	`sdma_unm­_desc
(
dd
, &
tx
->
desý
[
i
]);

1697 
tx
->
num_desc
 = 0;

1699 
	`kä“
(
tx
->
cßËsû_buf
);

1700 
tx
->
cßËsû_buf
 = 
NULL
;

1702 ià(
	`uÆik–y
(
tx
->
desc_lim™
 > 
	`ARRAY_SIZE
Ñx->
descs
))) {

1703 
tx
->
desc_lim™
 = 
	`ARRAY_SIZE
Ñx->
descs
);

1704 
	`kä“
(
tx
->
desý
);

1706 
	}
}

1708 
šlše
 
u16
 
	$sdma_g‘h—d
(
sdma_’gše
 *
sde
)

1710 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

1711 
u£_dmah—d
;

1712 
u16
 
hwh—d
;

1714 #ifdeà
CONFIG_SDMA_VERBOSITY


1715 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) %s:%d %s()\n",

1716 
sde
->
this_idx
, 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

1719 
»Œy
:

1720 
u£_dmah—d
 = 
	`HFI1_CAP_IS_KSET
(
USE_SDMA_HEAD
è&& 
	`__sdma_ruÂšg
(
sde
) &&

1721 (
dd
->
æags
 & 
HFI1_HAS_SDMA_TIMEOUT
);

1722 
hwh—d
 = 
u£_dmah—d
 ?

1723 (
u16
)
	`Ë64_to_ýu
(*
sde
->
h—d_dma
) :

1724 (
u16
)
	`»ad_sde_c¤
(
sde
, 
	`SD
(
HEAD
));

1726 ià(
	`uÆik–y
(
	`HFI1_CAP_IS_KSET
(
SDMA_HEAD_CHECK
))) {

1727 
u16
 
út
;

1728 
u16
 
swž
;

1729 
u16
 
swh—d
;

1730 
§Ã
;

1732 
swh—d
 = 
sde
->
descq_h—d
 & sde->
sdma_mask
;

1734 
swž
 = 
	`READ_ONCE
(
sde
->
descq_ž
è& sde->
sdma_mask
;

1735 
út
 = 
sde
->
descq_út
;

1737 ià(
swh—d
 < 
swž
)

1739 
§Ã
 = (
hwh—d
 >ð
swh—d
è& (hwh—d <ð
swž
);

1740 ià(
swh—d
 > 
swž
)

1742 
§Ã
 = ((
hwh—d
 >ð
swh—d
è&& (hwh—d < 
út
)) ||

1743 (
hwh—d
 <ð
swž
);

1746 
§Ã
 = (
hwh—d
 =ð
swh—d
);

1748 ià(
	`uÆik–y
(!
§Ã
)) {

1749 
	`dd_dev_”r
(
dd
, "SDMA(%u) bad head (%s) hwhd=%hu swhd=%hu swtl=%hu cnt=%hu\n",

1750 
sde
->
this_idx
,

1751 
u£_dmah—d
 ? "dma" : "kreg",

1752 
hwh—d
, 
swh—d
, 
swž
, 
út
);

1753 ià(
u£_dmah—d
) {

1755 
u£_dmah—d
 = 0;

1756 
»Œy
;

1759 
hwh—d
 = 
swh—d
;

1762  
hwh—d
;

1763 
	}
}

1771 
	$sdma_desc_avaž
(
sdma_’gše
 *
sde
, 
ušt
 
avaž
)

1773 
iowa™
 *
wa™
, *
nw
, *
twa™
;

1774 
iowa™
 *
wa™s
[
SDMA_WAIT_BATCH_SIZE
];

1775 
ušt
 
i
, 
n
 = 0, 
£q
, 
tidx
 = 0;

1777 #ifdeà
CONFIG_SDMA_VERBOSITY


1778 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%uè%s:%d %s()\n", sde->
this_idx
,

1779 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

1780 
	`dd_dev_”r
(
sde
->
dd
, "avaž: %u\n", 
avaž
);

1784 
£q
 = 
	`»ad_£qbegš
(&
sde
->
wa™lock
);

1785 ià(!
	`li¡_em±y
(&
sde
->
dmawa™
)) {

1787 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

1789 
	`li¡_fÜ_—ch_’Œy_§ã
(

1790 
wa™
,

1791 
nw
,

1792 &
sde
->
dmawa™
,

1793 
li¡
) {

1794 
u32
 
num_desc
;

1796 ià(!
wa™
->
wakeup
)

1798 ià(
n
 =ð
	`ARRAY_SIZE
(
wa™s
))

1800 
	`iowa™_š™_´iÜ™y
(
wa™
);

1801 
num_desc
 = 
	`iowa™_g‘_®l_desc
(
wa™
);

1802 ià(
num_desc
 > 
avaž
)

1804 
avaž
 -ð
num_desc
;

1806 ià(
n
) {

1807 
twa™
 = 
wa™s
[
tidx
];

1808 
tidx
 =

1809 
	`iowa™_´iÜ™y_upd©e_tÝ
(
wa™
,

1810 
twa™
,

1811 
n
,

1812 
tidx
);

1814 
	`li¡_d–_š™
(&
wa™
->
li¡
);

1815 
wa™s
[
n
++] = 
wa™
;

1817 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

1820 } 
	`»ad_£q»Œy
(&
sde
->
wa™lock
, 
£q
));

1823 ià(
n
)

1824 
wa™s
[
tidx
]->
	`wakeup
(wa™s[tidx], 
SDMA_AVAIL_REASON
);

1826 
i
 = 0; i < 
n
; i++)

1827 ià(
i
 !ð
tidx
)

1828 
wa™s
[
i
]->
	`wakeup
(wa™s[i], 
SDMA_AVAIL_REASON
);

1829 
	}
}

1832 
	$sdma_make_´og»ss
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
)

1834 
sdma_tx»q
 *
txp
 = 
NULL
;

1835 
´og»ss
 = 0;

1836 
u16
 
hwh—d
, 
swh—d
;

1837 
idË_check_dÚe
 = 0;

1839 
hwh—d
 = 
	`sdma_g‘h—d
(
sde
);

1847 
»Œy
:

1848 
txp
 = 
	`g‘_txh—d
(
sde
);

1849 
swh—d
 = 
sde
->
descq_h—d
 & sde->
sdma_mask
;

1850 
	`Œaû_hfi1_sdma_´og»ss
(
sde
, 
hwh—d
, 
swh—d
, 
txp
);

1851 
swh—d
 !ð
hwh—d
) {

1853 
swh—d
 = ++
sde
->
descq_h—d
 & sde->
sdma_mask
;

1856 ià(
txp
 &&xp->
Ãxt_descq_idx
 =ð
swh—d
) {

1858 
sde
->
tx_ršg
[sde->
tx_h—d
++ & sde->
sdma_mask
] = 
NULL
;

1859 
	`com¶‘e_tx
(
sde
, 
txp
, 
SDMA_TXREQ_S_OK
);

1861 
txp
 = 
	`g‘_txh—d
(
sde
);

1863 
	`Œaû_hfi1_sdma_´og»ss
(
sde
, 
hwh—d
, 
swh—d
, 
txp
);

1864 
´og»ss
++;

1876 ià((
¡©us
 & 
sde
->
idË_mask
è&& !
idË_check_dÚe
) {

1877 
u16
 
swž
;

1879 
swž
 = 
	`READ_ONCE
(
sde
->
descq_ž
è& sde->
sdma_mask
;

1880 ià(
swž
 !ð
hwh—d
) {

1881 
hwh—d
 = (
u16
)
	`»ad_sde_c¤
(
sde
, 
	`SD
(
HEAD
));

1882 
idË_check_dÚe
 = 1;

1883 
»Œy
;

1887 
sde
->
Ï¡_¡©us
 = 
¡©us
;

1888 ià(
´og»ss
)

1889 
	`sdma_desc_avaž
(
sde
, 
	`sdma_descq_ä“út
(sde));

1890 
	}
}

1901 
	$sdma_’gše_š‹¼u±
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
)

1903 
	`Œaû_hfi1_sdma_’gše_š‹¼u±
(
sde
, 
¡©us
);

1904 
	`wr™e_£qlock
(&
sde
->
h—d_lock
);

1905 
	`sdma_£t_desc_út
(
sde
, 
sdma_desù_šŒ
);

1906 ià(
¡©us
 & 
sde
->
idË_mask
)

1907 
sde
->
idË_št_út
++;

1908 ià(
¡©us
 & 
sde
->
´og»ss_mask
)

1909 
sde
->
´og»ss_št_út
++;

1910 ià(
¡©us
 & 
sde
->
št_mask
)

1911 
sde
->
sdma_št_út
++;

1912 
	`sdma_make_´og»ss
(
sde
, 
¡©us
);

1913 
	`wr™e_£quÆock
(&
sde
->
h—d_lock
);

1914 
	}
}

1921 
	$sdma_’gše_”rÜ
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
)

1923 
æags
;

1925 #ifdeà
CONFIG_SDMA_VERBOSITY


1926 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u)ƒrror status 0x%llx state %s\n",

1927 
sde
->
this_idx
,

1928 ()
¡©us
,

1929 
sdma_¡©e_Çmes
[
sde
->
¡©e
.
cu¼’t_¡©e
]);

1931 
	`¥š_lock_œq§ve
(&
sde
->
ž_lock
, 
æags
);

1932 
	`wr™e_£qlock
(&
sde
->
h—d_lock
);

1933 ià(
¡©us
 & 
ALL_SDMA_ENG_HALT_ERRS
)

1934 
	`__sdma_´oûss_ev’t
(
sde
, 
sdma_ev’t_e60_hw_h®‹d
);

1935 ià(
¡©us
 & ~
	`SD
(
ENG_ERR_STATUS_SDMA_HALT_ERR_SMASK
)) {

1936 
	`dd_dev_”r
(
sde
->
dd
,

1938 
sde
->
this_idx
,

1939 ()
¡©us
,

1940 
sdma_¡©e_Çmes
[
sde
->
¡©e
.
cu¼’t_¡©e
]);

1941 
	`dump_sdma_¡©e
(
sde
);

1943 
	`wr™e_£quÆock
(&
sde
->
h—d_lock
);

1944 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
ž_lock
, 
æags
);

1945 
	}
}

1947 
	$sdma_£ndù¾
(
sdma_’gše
 *
sde
, 
Ý
)

1949 
u64
 
£t_£nddmaù¾
 = 0;

1950 
u64
 
þr_£nddmaù¾
 = 0;

1951 
æags
;

1953 #ifdeà
CONFIG_SDMA_VERBOSITY


1954 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) senddmactrl E=%d I=%d H=%d C=%d\n",

1955 
sde
->
this_idx
,

1956 (
Ý
 & 
SDMA_SENDCTRL_OP_ENABLE
) ? 1 : 0,

1957 (
Ý
 & 
SDMA_SENDCTRL_OP_INTENABLE
) ? 1 : 0,

1958 (
Ý
 & 
SDMA_SENDCTRL_OP_HALT
) ? 1 : 0,

1959 (
Ý
 & 
SDMA_SENDCTRL_OP_CLEANUP
) ? 1 : 0);

1962 ià(
Ý
 & 
SDMA_SENDCTRL_OP_ENABLE
)

1963 
£t_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_ENABLE_SMASK
);

1965 
þr_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_ENABLE_SMASK
);

1967 ià(
Ý
 & 
SDMA_SENDCTRL_OP_INTENABLE
)

1968 
£t_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_INT_ENABLE_SMASK
);

1970 
þr_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_INT_ENABLE_SMASK
);

1972 ià(
Ý
 & 
SDMA_SENDCTRL_OP_HALT
)

1973 
£t_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_HALT_SMASK
);

1975 
þr_£nddmaù¾
 |ð
	`SD
(
CTRL_SDMA_HALT_SMASK
);

1977 
	`¥š_lock_œq§ve
(&
sde
->
£nddmaù¾_lock
, 
æags
);

1979 
sde
->
p_£nddmaù¾
 |ð
£t_£nddmaù¾
;

1980 
sde
->
p_£nddmaù¾
 &ð~
þr_£nddmaù¾
;

1982 ià(
Ý
 & 
SDMA_SENDCTRL_OP_CLEANUP
)

1983 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
CTRL
),

1984 
sde
->
p_£nddmaù¾
 |

1985 
	`SD
(
CTRL_SDMA_CLEANUP_SMASK
));

1987 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
CTRL
), sde->
p_£nddmaù¾
);

1989 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
£nddmaù¾_lock
, 
æags
);

1991 #ifdeà
CONFIG_SDMA_VERBOSITY


1992 
	`sdma_dump¡©e
(
sde
);

1994 
	}
}

1996 
	$sdma_£Ž’g’
(
sdma_’gše
 *
sde
)

1998 #ifdeà
CONFIG_SDMA_VERBOSITY


1999 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) %s:%d %s()\n",

2000 
sde
->
this_idx
, 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

2008 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
LEN_GEN
),

2009 (
sde
->
descq_út
 / 64è<< 
	`SD
(
LEN_GEN_LENGTH_SHIFT
));

2010 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
LEN_GEN
),

2011 ((
sde
->
descq_út
 / 64è<< 
	`SD
(
LEN_GEN_LENGTH_SHIFT
)) |

2012 (4ULL << 
	`SD
(
LEN_GEN_GENERATION_SHIFT
)));

2013 
	}
}

2015 
šlše
 
	$sdma_upd©e_ž
(
sdma_’gše
 *
sde
, 
u16
 
ž
)

2018 
	`smp_wmb
();

2019 
	`wr™eq
(
ž
, 
sde
->
ž_c¤
);

2020 
	}
}

2026 
	$sdma_hw_¡¬t_up
(
sdma_’gše
 *
sde
)

2028 
u64
 
»g
;

2030 #ifdeà
CONFIG_SDMA_VERBOSITY


2031 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%u) %s:%d %s()\n",

2032 
sde
->
this_idx
, 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

2035 
	`sdma_£Ž’g’
(
sde
);

2036 
	`sdma_upd©e_ž
(
sde
, 0);

2037 *
sde
->
h—d_dma
 = 0;

2039 
»g
 = 
	`SD
(
ENG_ERR_CLEAR_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_MASK
) <<

2040 
	`SD
(
ENG_ERR_CLEAR_SDMA_HEADER_REQUEST_FIFO_UNC_ERR_SHIFT
);

2041 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
ENG_ERR_CLEAR
), 
»g
);

2042 
	}
}

2049 
	$£t_sdma_š‹gr™y
(
sdma_’gše
 *
sde
)

2051 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

2053 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
CHECK_ENABLE
),

2054 
	`hfi1_pkt_ba£_sdma_š‹gr™y
(
dd
));

2055 
	}
}

2057 
	$š™_sdma_»gs
(

2058 
sdma_’gše
 *
sde
,

2059 
u32
 
üed™s
,

2060 
ušt
 
idË_út
)

2062 
u8
 
Ýv®
, 
Ýmask
;

2063 #ifdeà
CONFIG_SDMA_VERBOSITY


2064 
hfi1_devd©a
 *
dd
 = 
sde
->dd;

2066 
	`dd_dev_”r
(
dd
, "CONFIG SDMA(%u) %s:%d %s()\n",

2067 
sde
->
this_idx
, 
	`¦ash¡r
(
__FILE__
), 
__LINE__
, 
__func__
);

2070 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
BASE_ADDR
), sde->
descq_phys
);

2071 
	`sdma_£Ž’g’
(
sde
);

2072 
	`sdma_upd©e_ž
(
sde
, 0);

2073 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
RELOAD_CNT
), 
idË_út
);

2074 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
DESC_CNT
), 0);

2075 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
HEAD_ADDR
), sde->
h—d_phys
);

2076 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
MEMORY
),

2077 ((
u64
)
üed™s
 << 
	`SD
(
MEMORY_SDMA_MEMORY_CNT_SHIFT
)) |

2078 ((
u64
)(
üed™s
 * 
sde
->
this_idx
) <<

2079 
	`SD
(
MEMORY_SDMA_MEMORY_INDEX_SHIFT
)));

2080 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
ENG_ERR_MASK
), ~0ull);

2081 
	`£t_sdma_š‹gr™y
(
sde
);

2082 
Ýmask
 = 
OPCODE_CHECK_MASK_DISABLED
;

2083 
Ýv®
 = 
OPCODE_CHECK_VAL_DISABLED
;

2084 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
CHECK_OPCODE
),

2085 (
Ýmask
 << 
SEND_CTXT_CHECK_OPCODE_MASK_SHIFT
) |

2086 (
Ýv®
 << 
SEND_CTXT_CHECK_OPCODE_VALUE_SHIFT
));

2087 
	}
}

2089 #ifdeà
CONFIG_SDMA_VERBOSITY


2091 
	#sdma_dump¡©e_h–³r0
(
»g
) do { \

2092 
c¤
 = 
	`»ad_c¤
(
sde
->
dd
, 
»g
); \

2093 
	`dd_dev_”r
(
sde
->
dd
, "%36  0x%016Îx\n", #»g, 
c¤
); \

2094 } 0)

	)

2096 
	#sdma_dump¡©e_h–³r
(
»g
) do { \

2097 
c¤
 = 
	`»ad_sde_c¤
(
sde
, 
»g
); \

2098 
	`dd_dev_”r
(
sde
->
dd
, "%36s[%02u] 0x%016llx\n", \

2099 #»g, 
sde
->
this_idx
, 
c¤
); \

2100 } 0)

	)

2102 
	#sdma_dump¡©e_h–³r2
(
»g
) do { \

2103 
c¤
 = 
	`»ad_c¤
(
sde
->
dd
, 
»g
 + (8 * 
i
)); \

2104 
	`dd_dev_”r
(
sde
->
dd
, "%33s_%02u 0x%016llx\n", \

2105 #»g, 
i
, 
c¤
); \

2106 } 0)

	)

2108 
	$sdma_dump¡©e
(
sdma_’gše
 *
sde
)

2110 
u64
 
c¤
;

2111 
i
;

2113 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CTRL
));

2114 
	`sdma_dump¡©e_h–³r
(
	`SD
(
STATUS
));

2115 
	`sdma_dump¡©e_h–³r0
(
	`SD
(
ERR_STATUS
));

2116 
	`sdma_dump¡©e_h–³r0
(
	`SD
(
ERR_MASK
));

2117 
	`sdma_dump¡©e_h–³r
(
	`SD
(
ENG_ERR_STATUS
));

2118 
	`sdma_dump¡©e_h–³r
(
	`SD
(
ENG_ERR_MASK
));

2120 
i
 = 0; i < 
CCE_NUM_INT_CSRS
; ++i) {

2121 
	`sdma_dump¡©e_h–³r2
(
CCE_INT_STATUS
);

2122 
	`sdma_dump¡©e_h–³r2
(
CCE_INT_MASK
);

2123 
	`sdma_dump¡©e_h–³r2
(
CCE_INT_BLOCKED
);

2126 
	`sdma_dump¡©e_h–³r
(
	`SD
(
TAIL
));

2127 
	`sdma_dump¡©e_h–³r
(
	`SD
(
HEAD
));

2128 
	`sdma_dump¡©e_h–³r
(
	`SD
(
PRIORITY_THLD
));

2129 
	`sdma_dump¡©e_h–³r
(
	`SD
(
IDLE_CNT
));

2130 
	`sdma_dump¡©e_h–³r
(
	`SD
(
RELOAD_CNT
));

2131 
	`sdma_dump¡©e_h–³r
(
	`SD
(
DESC_CNT
));

2132 
	`sdma_dump¡©e_h–³r
(
	`SD
(
DESC_FETCHED_CNT
));

2133 
	`sdma_dump¡©e_h–³r
(
	`SD
(
MEMORY
));

2134 
	`sdma_dump¡©e_h–³r0
(
	`SD
(
ENGINES
));

2135 
	`sdma_dump¡©e_h–³r0
(
	`SD
(
MEM_SIZE
));

2137 
	`sdma_dump¡©e_h–³r
(
	`SD
(
BASE_ADDR
));

2138 
	`sdma_dump¡©e_h–³r
(
	`SD
(
LEN_GEN
));

2139 
	`sdma_dump¡©e_h–³r
(
	`SD
(
HEAD_ADDR
));

2140 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_ENABLE
));

2141 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_VL
));

2142 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_JOB_KEY
));

2143 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_PARTITION_KEY
));

2144 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_SLID
));

2145 
	`sdma_dump¡©e_h–³r
(
	`SD
(
CHECK_OPCODE
));

2146 
	}
}

2149 
	$dump_sdma_¡©e
(
sdma_’gše
 *
sde
)

2151 
hw_sdma_desc
 *
descqp
;

2152 
u64
 
desc
[2];

2153 
u64
 
addr
;

2154 
u8
 
g’
;

2155 
u16
 
Ën
;

2156 
u16
 
h—d
, 
ž
, 
út
;

2158 
h—d
 = 
sde
->
descq_h—d
 & sde->
sdma_mask
;

2159 
ž
 = 
sde
->
descq_ž
 & sde->
sdma_mask
;

2160 
út
 = 
	`sdma_descq_ä“út
(
sde
);

2162 
	`dd_dev_”r
(
sde
->
dd
,

2164 
sde
->
this_idx
, 
h—d
, 
ž
, 
út
,

2165 !
	`li¡_em±y
(&
sde
->
æushli¡
));

2168 
h—d
 !ð
ž
) {

2169 
æags
[6] = { 'x', 'x', 'x', 'x', 0 };

2171 
descqp
 = &
sde
->
descq
[
h—d
];

2172 
desc
[0] = 
	`Ë64_to_ýu
(
descqp
->
qw
[0]);

2173 
desc
[1] = 
	`Ë64_to_ýu
(
descqp
->
qw
[1]);

2174 
æags
[0] = (
desc
[1] & 
SDMA_DESC1_INT_REQ_FLAG
) ? 'I' : '-';

2175 
æags
[1] = (
desc
[1] & 
SDMA_DESC1_HEAD_TO_HOST_FLAG
) ?

2177 
æags
[2] = (
desc
[0] & 
SDMA_DESC0_FIRST_DESC_FLAG
) ? 'F' : '-';

2178 
æags
[3] = (
desc
[0] & 
SDMA_DESC0_LAST_DESC_FLAG
) ? 'L' : '-';

2179 
addr
 = (
desc
[0] >> 
SDMA_DESC0_PHY_ADDR_SHIFT
)

2180 & 
SDMA_DESC0_PHY_ADDR_MASK
;

2181 
g’
 = (
desc
[1] >> 
SDMA_DESC1_GENERATION_SHIFT
)

2182 & 
SDMA_DESC1_GENERATION_MASK
;

2183 
Ën
 = (
desc
[0] >> 
SDMA_DESC0_BYTE_COUNT_SHIFT
)

2184 & 
SDMA_DESC0_BYTE_COUNT_MASK
;

2185 
	`dd_dev_”r
(
sde
->
dd
,

2187 
h—d
, 
æags
, 
addr
, 
g’
, 
Ën
);

2188 
	`dd_dev_”r
(
sde
->
dd
,

2190 
desc
[0], desc[1]);

2191 ià(
desc
[0] & 
SDMA_DESC0_FIRST_DESC_FLAG
)

2192 
	`dd_dev_”r
(
sde
->
dd
,

2194 (
u8
)((
desc
[1] &

2195 
SDMA_DESC1_HEADER_INDEX_SMASK
) >>

2196 
SDMA_DESC1_HEADER_INDEX_SHIFT
),

2197 (
u8
)((
desc
[1] &

2198 
SDMA_DESC1_HEADER_MODE_SMASK
) >>

2199 
SDMA_DESC1_HEADER_MODE_SHIFT
),

2200 (
u8
)((
desc
[1] &

2201 
SDMA_DESC1_HEADER_DWS_SMASK
) >>

2202 
SDMA_DESC1_HEADER_DWS_SHIFT
));

2203 
h—d
++;

2204 
h—d
 &ð
sde
->
sdma_mask
;

2206 
	}
}

2208 
	#SDE_FMT
 \

2209 "SDE %u CPU %d STE % C 0x%Îx S 0x%016Îx E 0x%Îx T(HWè0x%Îx T(SWè0x%x H(HWè0x%Îx H(SWè0x%x H(Dè0x%Îx DM 0x%Îx GL 0x%Îx R 0x%Îx LIS 0x%Îx AHGI 0x%Îx TXT %u TXH %u DT %u DH %u FLNE %d DQF %u SLC 0x%Îx\n"

	)

2217 
	$sdma_£qfže_dump_sde
(
£q_fže
 *
s
, 
sdma_’gše
 *
sde
)

2219 
u16
 
h—d
, 
ž
;

2220 
hw_sdma_desc
 *
descqp
;

2221 
u64
 
desc
[2];

2222 
u64
 
addr
;

2223 
u8
 
g’
;

2224 
u16
 
Ën
;

2226 
h—d
 = 
sde
->
descq_h—d
 & sde->
sdma_mask
;

2227 
ž
 = 
	`READ_ONCE
(
sde
->
descq_ž
è& sde->
sdma_mask
;

2228 
	`£q_´štf
(
s
, 
SDE_FMT
, 
sde
->
this_idx
,

2229 
sde
->
ýu
,

2230 
	`sdma_¡©e_Çme
(
sde
->
¡©e
.
cu¼’t_¡©e
),

2231 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
CTRL
)),

2232 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
STATUS
)),

2233 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
ENG_ERR_STATUS
)),

2234 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
TAIL
)), 
ž
,

2235 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
HEAD
)), 
h—d
,

2236 ()
	`Ë64_to_ýu
(*
sde
->
h—d_dma
),

2237 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
MEMORY
)),

2238 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
LEN_GEN
)),

2239 ()
	`»ad_sde_c¤
(
sde
, 
	`SD
(
RELOAD_CNT
)),

2240 ()
sde
->
Ï¡_¡©us
,

2241 ()
sde
->
ahg_b™s
,

2242 
sde
->
tx_ž
,

2243 
sde
->
tx_h—d
,

2244 
sde
->
descq_ž
,

2245 
sde
->
descq_h—d
,

2246 !
	`li¡_em±y
(&
sde
->
æushli¡
),

2247 
sde
->
descq_fuÎ_couÁ
,

2248 ()
	`»ad_sde_c¤
(
sde
, 
SEND_DMA_CHECK_SLID
));

2251 
h—d
 !ð
ž
) {

2252 
æags
[6] = { 'x', 'x', 'x', 'x', 0 };

2254 
descqp
 = &
sde
->
descq
[
h—d
];

2255 
desc
[0] = 
	`Ë64_to_ýu
(
descqp
->
qw
[0]);

2256 
desc
[1] = 
	`Ë64_to_ýu
(
descqp
->
qw
[1]);

2257 
æags
[0] = (
desc
[1] & 
SDMA_DESC1_INT_REQ_FLAG
) ? 'I' : '-';

2258 
æags
[1] = (
desc
[1] & 
SDMA_DESC1_HEAD_TO_HOST_FLAG
) ?

2260 
æags
[2] = (
desc
[0] & 
SDMA_DESC0_FIRST_DESC_FLAG
) ? 'F' : '-';

2261 
æags
[3] = (
desc
[0] & 
SDMA_DESC0_LAST_DESC_FLAG
) ? 'L' : '-';

2262 
addr
 = (
desc
[0] >> 
SDMA_DESC0_PHY_ADDR_SHIFT
)

2263 & 
SDMA_DESC0_PHY_ADDR_MASK
;

2264 
g’
 = (
desc
[1] >> 
SDMA_DESC1_GENERATION_SHIFT
)

2265 & 
SDMA_DESC1_GENERATION_MASK
;

2266 
Ën
 = (
desc
[0] >> 
SDMA_DESC0_BYTE_COUNT_SHIFT
)

2267 & 
SDMA_DESC0_BYTE_COUNT_MASK
;

2268 
	`£q_´štf
(
s
,

2270 
h—d
, 
æags
, 
addr
, 
g’
, 
Ën
);

2271 ià(
desc
[0] & 
SDMA_DESC0_FIRST_DESC_FLAG
)

2272 
	`£q_´štf
(
s
, "\t\tahgidx: %u‡hgmode: %u\n",

2273 (
u8
)((
desc
[1] &

2274 
SDMA_DESC1_HEADER_INDEX_SMASK
) >>

2275 
SDMA_DESC1_HEADER_INDEX_SHIFT
),

2276 (
u8
)((
desc
[1] &

2277 
SDMA_DESC1_HEADER_MODE_SMASK
) >>

2278 
SDMA_DESC1_HEADER_MODE_SHIFT
));

2279 
h—d
 = (h—d + 1è& 
sde
->
sdma_mask
;

2281 
	}
}

2287 
šlše
 
u64
 
	$add_g’
(
sdma_’gše
 *
sde
, 
u64
 
qw1
)

2289 
u8
 
g’”©iÚ
 = (
sde
->
descq_ž
 >> sde->
sdma_shiá
) & 3;

2291 
qw1
 &ð~
SDMA_DESC1_GENERATION_SMASK
;

2292 
qw1
 |ð((
u64
)
g’”©iÚ
 & 
SDMA_DESC1_GENERATION_MASK
)

2293 << 
SDMA_DESC1_GENERATION_SHIFT
;

2294  
qw1
;

2295 
	}
}

2313 
šlše
 
u16
 
	$subm™_tx
(
sdma_’gše
 *
sde
, 
sdma_tx»q
 *
tx
)

2315 
i
;

2316 
u16
 
ž
;

2317 
sdma_desc
 *
desý
 = 
tx
->descp;

2318 
u8
 
sk
 = 0, 
mode
 = 
	`ahg_mode
(
tx
);

2320 
ž
 = 
sde
->
descq_ž
 & sde->
sdma_mask
;

2321 
sde
->
descq
[
ž
].
qw
[0] = 
	`ýu_to_Ë64
(
desý
->qw[0]);

2322 
sde
->
descq
[
ž
].
qw
[1] = 
	`ýu_to_Ë64
(
	`add_g’
(sde, 
desý
->qw[1]));

2323 
	`Œaû_hfi1_sdma_desütÜ
(
sde
, 
desý
->
qw
[0], descp->qw[1],

2324 
ž
, &
sde
->
descq
[tail]);

2325 
ž
 = ++
sde
->
descq_ž
 & sde->
sdma_mask
;

2326 
desý
++;

2327 ià(
mode
 > 
SDMA_AHG_APPLY_UPDATE1
)

2328 
sk
 = 
mode
 >> 1;

2329 
i
 = 1; i < 
tx
->
num_desc
; i++, 
desý
++) {

2330 
u64
 
qw1
;

2332 
sde
->
descq
[
ž
].
qw
[0] = 
	`ýu_to_Ë64
(
desý
->qw[0]);

2333 ià(
sk
) {

2335 
qw1
 = 
desý
->
qw
[1];

2336 
sk
--;

2339 
qw1
 = 
	`add_g’
(
sde
, 
desý
->
qw
[1]);

2341 
sde
->
descq
[
ž
].
qw
[1] = 
	`ýu_to_Ë64
(
qw1
);

2342 
	`Œaû_hfi1_sdma_desütÜ
(
sde
, 
desý
->
qw
[0], 
qw1
,

2343 
ž
, &
sde
->
descq
[tail]);

2344 
ž
 = ++
sde
->
descq_ž
 & sde->
sdma_mask
;

2346 
tx
->
Ãxt_descq_idx
 = 
ž
;

2347 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


2348 
tx
->
¢
 = 
sde
->
ž_¢
++;

2349 
	`Œaû_hfi1_sdma_š_¢
(
sde
, 
tx
->
¢
);

2350 
	`WARN_ON_ONCE
(
sde
->
tx_ršg
[sde->
tx_ž
 & sde->
sdma_mask
]);

2352 
sde
->
tx_ršg
[sde->
tx_ž
++ & sde->
sdma_mask
] = 
tx
;

2353 
sde
->
desc_avaž
 -ð
tx
->
num_desc
;

2354  
ž
;

2355 
	}
}

2360 
	$sdma_check_´og»ss
(

2361 
sdma_’gše
 *
sde
,

2362 
iowa™_wÜk
 *
wa™
,

2363 
sdma_tx»q
 *
tx
,

2364 
boÞ
 
pkts_£Á
)

2366 
»t
;

2368 
sde
->
desc_avaž
 = 
	`sdma_descq_ä“út
(sde);

2369 ià(
tx
->
num_desc
 <ð
sde
->
desc_avaž
)

2370  -
EAGAIN
;

2372 ià(
wa™
 && 
	`iowa™_ioww_to_iow
(wa™)->
¦“p
) {

2373 
£q
;

2375 
£q
 = 
	`¿w_£qcouÁ_begš
(

2376 (cÚ¡ 
£qcouÁ_t
 *)&
sde
->
h—d_lock
.
£qcouÁ
);

2377 
»t
 = 
wa™
->
iow
->
	`¦“p
(
sde
, wa™, 
tx
, 
£q
, 
pkts_£Á
);

2378 ià(
»t
 =ð-
EAGAIN
)

2379 
sde
->
desc_avaž
 = 
	`sdma_descq_ä“út
(sde);

2381 
»t
 = -
EBUSY
;

2383  
»t
;

2384 
	}
}

2401 
	$sdma_£nd_tx»q
(
sdma_’gše
 *
sde
,

2402 
iowa™_wÜk
 *
wa™
,

2403 
sdma_tx»q
 *
tx
,

2404 
boÞ
 
pkts_£Á
)

2406 
»t
 = 0;

2407 
u16
 
ž
;

2408 
æags
;

2411 ià(
	`uÆik–y
(
tx
->
Ž’
))

2412  -
EINVAL
;

2413 
tx
->
wa™
 = 
	`iowa™_ioww_to_iow
(wait);

2414 
	`¥š_lock_œq§ve
(&
sde
->
ž_lock
, 
æags
);

2415 
»Œy
:

2416 ià(
	`uÆik–y
(!
	`__sdma_ruÂšg
(
sde
)))

2417 
uÆock_nocÚn
;

2418 ià(
	`uÆik–y
(
tx
->
num_desc
 > 
sde
->
desc_avaž
))

2419 
nodesc
;

2420 
ž
 = 
	`subm™_tx
(
sde
, 
tx
);

2421 ià(
wa™
)

2422 
	`iowa™_sdma_šc
(
	`iowa™_ioww_to_iow
(
wa™
));

2423 
	`sdma_upd©e_ž
(
sde
, 
ž
);

2424 
uÆock
:

2425 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
ž_lock
, 
æags
);

2426  
»t
;

2427 
uÆock_nocÚn
:

2428 ià(
wa™
)

2429 
	`iowa™_sdma_šc
(
	`iowa™_ioww_to_iow
(
wa™
));

2430 
tx
->
Ãxt_descq_idx
 = 0;

2431 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


2432 
tx
->
¢
 = 
sde
->
ž_¢
++;

2433 
	`Œaû_hfi1_sdma_š_¢
(
sde
, 
tx
->
¢
);

2435 
	`¥š_lock
(&
sde
->
æushli¡_lock
);

2436 
	`li¡_add_ž
(&
tx
->
li¡
, &
sde
->
æushli¡
);

2437 
	`¥š_uÆock
(&
sde
->
æushli¡_lock
);

2438 
	`iowa™_šc_wa™_couÁ
(
wa™
, 
tx
->
num_desc
);

2439 
	`queue_wÜk_Ú
(
sde
->
ýu
, 
sy¡em_high´i_wq
, &sde->
æush_wÜk”
);

2440 
»t
 = -
ECOMM
;

2441 
uÆock
;

2442 
nodesc
:

2443 
»t
 = 
	`sdma_check_´og»ss
(
sde
, 
wa™
, 
tx
, 
pkts_£Á
);

2444 ià(
»t
 =ð-
EAGAIN
) {

2445 
»t
 = 0;

2446 
»Œy
;

2448 
sde
->
descq_fuÎ_couÁ
++;

2449 
uÆock
;

2450 
	}
}

2480 
	$sdma_£nd_txli¡
(
sdma_’gše
 *
sde
, 
iowa™_wÜk
 *
wa™
,

2481 
li¡_h—d
 *
tx_li¡
, 
u16
 *
couÁ_out
)

2483 
sdma_tx»q
 *
tx
, *
tx_Ãxt
;

2484 
»t
 = 0;

2485 
æags
;

2486 
u16
 
ž
 = 
INVALID_TAIL
;

2487 
u32
 
subm™_couÁ
 = 0, 
æush_couÁ
 = 0, 
tÙ®_couÁ
;

2489 
	`¥š_lock_œq§ve
(&
sde
->
ž_lock
, 
æags
);

2490 
»Œy
:

2491 
	`li¡_fÜ_—ch_’Œy_§ã
(
tx
, 
tx_Ãxt
, 
tx_li¡
, 
li¡
) {

2492 
tx
->
wa™
 = 
	`iowa™_ioww_to_iow
(wait);

2493 ià(
	`uÆik–y
(!
	`__sdma_ruÂšg
(
sde
)))

2494 
uÆock_nocÚn
;

2495 ià(
	`uÆik–y
(
tx
->
num_desc
 > 
sde
->
desc_avaž
))

2496 
nodesc
;

2497 ià(
	`uÆik–y
(
tx
->
Ž’
)) {

2498 
»t
 = -
EINVAL
;

2499 
upd©e_ž
;

2501 
	`li¡_d–_š™
(&
tx
->
li¡
);

2502 
ž
 = 
	`subm™_tx
(
sde
, 
tx
);

2503 
subm™_couÁ
++;

2504 ià(
ž
 !ð
INVALID_TAIL
 &&

2505 (
subm™_couÁ
 & 
SDMA_TAIL_UPDATE_THRESH
) == 0) {

2506 
	`sdma_upd©e_ž
(
sde
, 
ž
);

2507 
ž
 = 
INVALID_TAIL
;

2510 
upd©e_ž
:

2511 
tÙ®_couÁ
 = 
subm™_couÁ
 + 
æush_couÁ
;

2512 ià(
wa™
) {

2513 
	`iowa™_sdma_add
(
	`iowa™_ioww_to_iow
(
wa™
), 
tÙ®_couÁ
);

2514 
	`iowa™_¡¬ve_þ—r
(
subm™_couÁ
 > 0,

2515 
	`iowa™_ioww_to_iow
(
wa™
));

2517 ià(
ž
 !ð
INVALID_TAIL
)

2518 
	`sdma_upd©e_ž
(
sde
, 
ž
);

2519 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
ž_lock
, 
æags
);

2520 *
couÁ_out
 = 
tÙ®_couÁ
;

2521  
»t
;

2522 
uÆock_nocÚn
:

2523 
	`¥š_lock
(&
sde
->
æushli¡_lock
);

2524 
	`li¡_fÜ_—ch_’Œy_§ã
(
tx
, 
tx_Ãxt
, 
tx_li¡
, 
li¡
) {

2525 
tx
->
wa™
 = 
	`iowa™_ioww_to_iow
(wait);

2526 
	`li¡_d–_š™
(&
tx
->
li¡
);

2527 
tx
->
Ãxt_descq_idx
 = 0;

2528 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


2529 
tx
->
¢
 = 
sde
->
ž_¢
++;

2530 
	`Œaû_hfi1_sdma_š_¢
(
sde
, 
tx
->
¢
);

2532 
	`li¡_add_ž
(&
tx
->
li¡
, &
sde
->
æushli¡
);

2533 
æush_couÁ
++;

2534 
	`iowa™_šc_wa™_couÁ
(
wa™
, 
tx
->
num_desc
);

2536 
	`¥š_uÆock
(&
sde
->
æushli¡_lock
);

2537 
	`queue_wÜk_Ú
(
sde
->
ýu
, 
sy¡em_high´i_wq
, &sde->
æush_wÜk”
);

2538 
»t
 = -
ECOMM
;

2539 
upd©e_ž
;

2540 
nodesc
:

2541 
»t
 = 
	`sdma_check_´og»ss
(
sde
, 
wa™
, 
tx
, 
subm™_couÁ
 > 0);

2542 ià(
»t
 =ð-
EAGAIN
) {

2543 
»t
 = 0;

2544 
»Œy
;

2546 
sde
->
descq_fuÎ_couÁ
++;

2547 
upd©e_ž
;

2548 
	}
}

2550 
	$sdma_´oûss_ev’t
(
sdma_’gše
 *
sde
, 
sdma_ev’ts
 
ev’t
)

2552 
æags
;

2554 
	`¥š_lock_œq§ve
(&
sde
->
ž_lock
, 
æags
);

2555 
	`wr™e_£qlock
(&
sde
->
h—d_lock
);

2557 
	`__sdma_´oûss_ev’t
(
sde
, 
ev’t
);

2559 ià(
sde
->
¡©e
.
cu¼’t_¡©e
 =ð
sdma_¡©e_s99_ruÂšg
)

2560 
	`sdma_desc_avaž
(
sde
, 
	`sdma_descq_ä“út
(sde));

2562 
	`wr™e_£quÆock
(&
sde
->
h—d_lock
);

2563 
	`¥š_uÆock_œq»¡Üe
(&
sde
->
ž_lock
, 
æags
);

2564 
	}
}

2566 
	$__sdma_´oûss_ev’t
(
sdma_’gše
 *
sde
,

2567 
sdma_ev’ts
 
ev’t
)

2569 
sdma_¡©e
 *
ss
 = &
sde
->
¡©e
;

2570 
Ãed_´og»ss
 = 0;

2573 #ifdeà
CONFIG_SDMA_VERBOSITY


2574 
	`dd_dev_”r
(
sde
->
dd
, "CONFIG SDMA(%uè[%s] %s\n", sde->
this_idx
,

2575 
sdma_¡©e_Çmes
[
ss
->
cu¼’t_¡©e
],

2576 
sdma_ev’t_Çmes
[
ev’t
]);

2579 
ss
->
cu¼’t_¡©e
) {

2580 
sdma_¡©e_s00_hw_down
:

2581 
ev’t
) {

2582 
sdma_ev’t_e00_go_hw_down
:

2584 
sdma_ev’t_e30_go_ruÂšg
:

2592 
ss
->
go_s99_ruÂšg
 = 1;

2594 
sdma_ev’t_e10_go_hw_¡¬t
:

2596 
	`sdma_g‘
(&
sde
->
¡©e
);

2597 
	`sdma_£t_¡©e
(
sde
,

2598 
sdma_¡©e_s10_hw_¡¬t_up_h®t_wa™
);

2600 
sdma_ev’t_e15_hw_h®t_dÚe
:

2602 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2604 
sdma_ev’t_e40_sw_þ—Ãd
:

2605 
	`sdma_sw_‹¬_down
(
sde
);

2607 
sdma_ev’t_e50_hw_þ—Ãd
:

2609 
sdma_ev’t_e60_hw_h®‹d
:

2611 
sdma_ev’t_e70_go_idË
:

2613 
sdma_ev’t_e80_hw_ä“ze
:

2615 
sdma_ev’t_e81_hw_äoz’
:

2617 
sdma_ev’t_e82_hw_unä“ze
:

2619 
sdma_ev’t_e85_lšk_down
:

2621 
sdma_ev’t_e90_sw_h®‹d
:

2626 
sdma_¡©e_s10_hw_¡¬t_up_h®t_wa™
:

2627 
ev’t
) {

2628 
sdma_ev’t_e00_go_hw_down
:

2629 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2630 
	`sdma_sw_‹¬_down
(
sde
);

2632 
sdma_ev’t_e10_go_hw_¡¬t
:

2634 
sdma_ev’t_e15_hw_h®t_dÚe
:

2635 
	`sdma_£t_¡©e
(
sde
,

2636 
sdma_¡©e_s15_hw_¡¬t_up_þ—n_wa™
);

2637 
	`sdma_¡¬t_hw_þ—n_up
(
sde
);

2639 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2641 
sdma_ev’t_e30_go_ruÂšg
:

2642 
ss
->
go_s99_ruÂšg
 = 1;

2644 
sdma_ev’t_e40_sw_þ—Ãd
:

2646 
sdma_ev’t_e50_hw_þ—Ãd
:

2648 
sdma_ev’t_e60_hw_h®‹d
:

2649 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

2651 
sdma_ev’t_e70_go_idË
:

2652 
ss
->
go_s99_ruÂšg
 = 0;

2654 
sdma_ev’t_e80_hw_ä“ze
:

2656 
sdma_ev’t_e81_hw_äoz’
:

2658 
sdma_ev’t_e82_hw_unä“ze
:

2660 
sdma_ev’t_e85_lšk_down
:

2662 
sdma_ev’t_e90_sw_h®‹d
:

2667 
sdma_¡©e_s15_hw_¡¬t_up_þ—n_wa™
:

2668 
ev’t
) {

2669 
sdma_ev’t_e00_go_hw_down
:

2670 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2671 
	`sdma_sw_‹¬_down
(
sde
);

2673 
sdma_ev’t_e10_go_hw_¡¬t
:

2675 
sdma_ev’t_e15_hw_h®t_dÚe
:

2677 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2678 
	`sdma_hw_¡¬t_up
(
sde
);

2679 
	`sdma_£t_¡©e
(
sde
, 
ss
->
go_s99_ruÂšg
 ?

2680 
sdma_¡©e_s99_ruÂšg
 :

2681 
sdma_¡©e_s20_idË
);

2683 
sdma_ev’t_e30_go_ruÂšg
:

2684 
ss
->
go_s99_ruÂšg
 = 1;

2686 
sdma_ev’t_e40_sw_þ—Ãd
:

2688 
sdma_ev’t_e50_hw_þ—Ãd
:

2690 
sdma_ev’t_e60_hw_h®‹d
:

2692 
sdma_ev’t_e70_go_idË
:

2693 
ss
->
go_s99_ruÂšg
 = 0;

2695 
sdma_ev’t_e80_hw_ä“ze
:

2697 
sdma_ev’t_e81_hw_äoz’
:

2699 
sdma_ev’t_e82_hw_unä“ze
:

2701 
sdma_ev’t_e85_lšk_down
:

2703 
sdma_ev’t_e90_sw_h®‹d
:

2708 
sdma_¡©e_s20_idË
:

2709 
ev’t
) {

2710 
sdma_ev’t_e00_go_hw_down
:

2711 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2712 
	`sdma_sw_‹¬_down
(
sde
);

2714 
sdma_ev’t_e10_go_hw_¡¬t
:

2716 
sdma_ev’t_e15_hw_h®t_dÚe
:

2718 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2720 
sdma_ev’t_e30_go_ruÂšg
:

2721 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s99_ruÂšg
);

2722 
ss
->
go_s99_ruÂšg
 = 1;

2724 
sdma_ev’t_e40_sw_þ—Ãd
:

2726 
sdma_ev’t_e50_hw_þ—Ãd
:

2728 
sdma_ev’t_e60_hw_h®‹d
:

2729 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s50_hw_h®t_wa™
);

2730 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

2732 
sdma_ev’t_e70_go_idË
:

2734 
sdma_ev’t_e85_lšk_down
:

2736 
sdma_ev’t_e80_hw_ä“ze
:

2737 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s80_hw_ä“ze
);

2738 
	`©omic_dec
(&
sde
->
dd
->
sdma_unä“ze_couÁ
);

2739 
	`wake_up_š‹¼u±ibË
(&
sde
->
dd
->
sdma_unä“ze_wq
);

2741 
sdma_ev’t_e81_hw_äoz’
:

2743 
sdma_ev’t_e82_hw_unä“ze
:

2745 
sdma_ev’t_e90_sw_h®‹d
:

2750 
sdma_¡©e_s30_sw_þ—n_up_wa™
:

2751 
ev’t
) {

2752 
sdma_ev’t_e00_go_hw_down
:

2753 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2755 
sdma_ev’t_e10_go_hw_¡¬t
:

2757 
sdma_ev’t_e15_hw_h®t_dÚe
:

2759 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2761 
sdma_ev’t_e30_go_ruÂšg
:

2762 
ss
->
go_s99_ruÂšg
 = 1;

2764 
sdma_ev’t_e40_sw_þ—Ãd
:

2765 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s40_hw_þ—n_up_wa™
);

2766 
	`sdma_¡¬t_hw_þ—n_up
(
sde
);

2768 
sdma_ev’t_e50_hw_þ—Ãd
:

2770 
sdma_ev’t_e60_hw_h®‹d
:

2772 
sdma_ev’t_e70_go_idË
:

2773 
ss
->
go_s99_ruÂšg
 = 0;

2775 
sdma_ev’t_e80_hw_ä“ze
:

2777 
sdma_ev’t_e81_hw_äoz’
:

2779 
sdma_ev’t_e82_hw_unä“ze
:

2781 
sdma_ev’t_e85_lšk_down
:

2782 
ss
->
go_s99_ruÂšg
 = 0;

2784 
sdma_ev’t_e90_sw_h®‹d
:

2789 
sdma_¡©e_s40_hw_þ—n_up_wa™
:

2790 
ev’t
) {

2791 
sdma_ev’t_e00_go_hw_down
:

2792 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2793 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2795 
sdma_ev’t_e10_go_hw_¡¬t
:

2797 
sdma_ev’t_e15_hw_h®t_dÚe
:

2799 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2800 
	`sdma_hw_¡¬t_up
(
sde
);

2801 
	`sdma_£t_¡©e
(
sde
, 
ss
->
go_s99_ruÂšg
 ?

2802 
sdma_¡©e_s99_ruÂšg
 :

2803 
sdma_¡©e_s20_idË
);

2805 
sdma_ev’t_e30_go_ruÂšg
:

2806 
ss
->
go_s99_ruÂšg
 = 1;

2808 
sdma_ev’t_e40_sw_þ—Ãd
:

2810 
sdma_ev’t_e50_hw_þ—Ãd
:

2812 
sdma_ev’t_e60_hw_h®‹d
:

2814 
sdma_ev’t_e70_go_idË
:

2815 
ss
->
go_s99_ruÂšg
 = 0;

2817 
sdma_ev’t_e80_hw_ä“ze
:

2819 
sdma_ev’t_e81_hw_äoz’
:

2821 
sdma_ev’t_e82_hw_unä“ze
:

2823 
sdma_ev’t_e85_lšk_down
:

2824 
ss
->
go_s99_ruÂšg
 = 0;

2826 
sdma_ev’t_e90_sw_h®‹d
:

2831 
sdma_¡©e_s50_hw_h®t_wa™
:

2832 
ev’t
) {

2833 
sdma_ev’t_e00_go_hw_down
:

2834 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2835 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2837 
sdma_ev’t_e10_go_hw_¡¬t
:

2839 
sdma_ev’t_e15_hw_h®t_dÚe
:

2840 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s30_sw_þ—n_up_wa™
);

2841 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2843 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2845 
sdma_ev’t_e30_go_ruÂšg
:

2846 
ss
->
go_s99_ruÂšg
 = 1;

2848 
sdma_ev’t_e40_sw_þ—Ãd
:

2850 
sdma_ev’t_e50_hw_þ—Ãd
:

2852 
sdma_ev’t_e60_hw_h®‹d
:

2853 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

2855 
sdma_ev’t_e70_go_idË
:

2856 
ss
->
go_s99_ruÂšg
 = 0;

2858 
sdma_ev’t_e80_hw_ä“ze
:

2860 
sdma_ev’t_e81_hw_äoz’
:

2862 
sdma_ev’t_e82_hw_unä“ze
:

2864 
sdma_ev’t_e85_lšk_down
:

2865 
ss
->
go_s99_ruÂšg
 = 0;

2867 
sdma_ev’t_e90_sw_h®‹d
:

2872 
sdma_¡©e_s60_idË_h®t_wa™
:

2873 
ev’t
) {

2874 
sdma_ev’t_e00_go_hw_down
:

2875 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2876 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2878 
sdma_ev’t_e10_go_hw_¡¬t
:

2880 
sdma_ev’t_e15_hw_h®t_dÚe
:

2881 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s30_sw_þ—n_up_wa™
);

2882 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2884 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2886 
sdma_ev’t_e30_go_ruÂšg
:

2887 
ss
->
go_s99_ruÂšg
 = 1;

2889 
sdma_ev’t_e40_sw_þ—Ãd
:

2891 
sdma_ev’t_e50_hw_þ—Ãd
:

2893 
sdma_ev’t_e60_hw_h®‹d
:

2894 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

2896 
sdma_ev’t_e70_go_idË
:

2897 
ss
->
go_s99_ruÂšg
 = 0;

2899 
sdma_ev’t_e80_hw_ä“ze
:

2901 
sdma_ev’t_e81_hw_äoz’
:

2903 
sdma_ev’t_e82_hw_unä“ze
:

2905 
sdma_ev’t_e85_lšk_down
:

2907 
sdma_ev’t_e90_sw_h®‹d
:

2912 
sdma_¡©e_s80_hw_ä“ze
:

2913 
ev’t
) {

2914 
sdma_ev’t_e00_go_hw_down
:

2915 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2916 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2918 
sdma_ev’t_e10_go_hw_¡¬t
:

2920 
sdma_ev’t_e15_hw_h®t_dÚe
:

2922 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2924 
sdma_ev’t_e30_go_ruÂšg
:

2925 
ss
->
go_s99_ruÂšg
 = 1;

2927 
sdma_ev’t_e40_sw_þ—Ãd
:

2929 
sdma_ev’t_e50_hw_þ—Ãd
:

2931 
sdma_ev’t_e60_hw_h®‹d
:

2933 
sdma_ev’t_e70_go_idË
:

2934 
ss
->
go_s99_ruÂšg
 = 0;

2936 
sdma_ev’t_e80_hw_ä“ze
:

2938 
sdma_ev’t_e81_hw_äoz’
:

2939 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s82_ä“ze_sw_þ—n
);

2940 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2942 
sdma_ev’t_e82_hw_unä“ze
:

2944 
sdma_ev’t_e85_lšk_down
:

2946 
sdma_ev’t_e90_sw_h®‹d
:

2951 
sdma_¡©e_s82_ä“ze_sw_þ—n
:

2952 
ev’t
) {

2953 
sdma_ev’t_e00_go_hw_down
:

2954 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2955 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

2957 
sdma_ev’t_e10_go_hw_¡¬t
:

2959 
sdma_ev’t_e15_hw_h®t_dÚe
:

2961 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

2963 
sdma_ev’t_e30_go_ruÂšg
:

2964 
ss
->
go_s99_ruÂšg
 = 1;

2966 
sdma_ev’t_e40_sw_þ—Ãd
:

2968 
	`©omic_dec
(&
sde
->
dd
->
sdma_unä“ze_couÁ
);

2969 
	`wake_up_š‹¼u±ibË
(&
sde
->
dd
->
sdma_unä“ze_wq
);

2971 
sdma_ev’t_e50_hw_þ—Ãd
:

2973 
sdma_ev’t_e60_hw_h®‹d
:

2975 
sdma_ev’t_e70_go_idË
:

2976 
ss
->
go_s99_ruÂšg
 = 0;

2978 
sdma_ev’t_e80_hw_ä“ze
:

2980 
sdma_ev’t_e81_hw_äoz’
:

2982 
sdma_ev’t_e82_hw_unä“ze
:

2983 
	`sdma_hw_¡¬t_up
(
sde
);

2984 
	`sdma_£t_¡©e
(
sde
, 
ss
->
go_s99_ruÂšg
 ?

2985 
sdma_¡©e_s99_ruÂšg
 :

2986 
sdma_¡©e_s20_idË
);

2988 
sdma_ev’t_e85_lšk_down
:

2990 
sdma_ev’t_e90_sw_h®‹d
:

2995 
sdma_¡©e_s99_ruÂšg
:

2996 
ev’t
) {

2997 
sdma_ev’t_e00_go_hw_down
:

2998 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s00_hw_down
);

2999 
	`skËt_hi_scheduË
(&
sde
->
sdma_sw_þ—n_up_sk
);

3001 
sdma_ev’t_e10_go_hw_¡¬t
:

3003 
sdma_ev’t_e15_hw_h®t_dÚe
:

3005 
sdma_ev’t_e25_hw_þ—n_up_dÚe
:

3007 
sdma_ev’t_e30_go_ruÂšg
:

3009 
sdma_ev’t_e40_sw_þ—Ãd
:

3011 
sdma_ev’t_e50_hw_þ—Ãd
:

3013 
sdma_ev’t_e60_hw_h®‹d
:

3014 
Ãed_´og»ss
 = 1;

3015 
	`sdma_”r_´og»ss_check_scheduË
(
sde
);

3017 
sdma_ev’t_e90_sw_h®‹d
:

3022 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s50_hw_h®t_wa™
);

3023 
	`scheduË_wÜk
(&
sde
->
”r_h®t_wÜk”
);

3025 
sdma_ev’t_e70_go_idË
:

3026 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s60_idË_h®t_wa™
);

3028 
sdma_ev’t_e85_lšk_down
:

3029 
ss
->
go_s99_ruÂšg
 = 0;

3031 
sdma_ev’t_e80_hw_ä“ze
:

3032 
	`sdma_£t_¡©e
(
sde
, 
sdma_¡©e_s80_hw_ä“ze
);

3033 
	`©omic_dec
(&
sde
->
dd
->
sdma_unä“ze_couÁ
);

3034 
	`wake_up_š‹¼u±ibË
(&
sde
->
dd
->
sdma_unä“ze_wq
);

3036 
sdma_ev’t_e81_hw_äoz’
:

3038 
sdma_ev’t_e82_hw_unä“ze
:

3044 
ss
->
Ï¡_ev’t
 = 
ev’t
;

3045 ià(
Ãed_´og»ss
)

3046 
	`sdma_make_´og»ss
(
sde
, 0);

3047 
	}
}

3062 
	$_ex‹nd_sdma_tx_descs
(
hfi1_devd©a
 *
dd
, 
sdma_tx»q
 *
tx
)

3064 
i
;

3067 ià(
	`uÆik–y
((
tx
->
num_desc
 =ð(
MAX_DESC
 - 1)))) {

3069 ià(!
tx
->
Ž’
) {

3070 
tx
->
desc_lim™
 = 
MAX_DESC
;

3071 } ià(!
tx
->
cßËsû_buf
) {

3073 
tx
->
cßËsû_buf
 = 
	`km®loc
Ñx->
Ž’
 + (
u32
),

3074 
GFP_ATOMIC
);

3075 ià(!
tx
->
cßËsû_buf
)

3076 
’omem
;

3077 
tx
->
cßËsû_idx
 = 0;

3082 ià(
	`uÆik–y
(
tx
->
num_desc
 =ð
MAX_DESC
))

3083 
’omem
;

3085 
tx
->
desý
 = 
	`km®loc_¬¿y
(

3086 
MAX_DESC
,

3087 (
sdma_desc
),

3088 
GFP_ATOMIC
);

3089 ià(!
tx
->
desý
)

3090 
’omem
;

3093 
tx
->
desc_lim™
 = 
MAX_DESC
 - 1;

3095 
i
 = 0; i < 
tx
->
num_desc
; i++)

3096 
tx
->
desý
[
i
] =x->
descs
[i];

3098 
’omem
:

3099 
	`__sdma_txþ—n
(
dd
, 
tx
);

3100  -
ENOMEM
;

3101 
	}
}

3119 
	$ext_cßl_sdma_tx_descs
(
hfi1_devd©a
 *
dd
, 
sdma_tx»q
 *
tx
,

3120 
ty³
, *
kvaddr
, 
·ge
 *page,

3121 
off£t
, 
u16
 
Ën
)

3123 
·d_Ën
, 
rv®
;

3124 
dma_addr_t
 
addr
;

3126 
rv®
 = 
	`_ex‹nd_sdma_tx_descs
(
dd
, 
tx
);

3127 ià(
rv®
) {

3128 
	`__sdma_txþ—n
(
dd
, 
tx
);

3129  
rv®
;

3133 ià(
tx
->
cßËsû_buf
) {

3134 ià(
ty³
 =ð
SDMA_MAP_NONE
) {

3135 
	`__sdma_txþ—n
(
dd
, 
tx
);

3136  -
EINVAL
;

3139 ià(
ty³
 =ð
SDMA_MAP_PAGE
) {

3140 
kvaddr
 = 
	`km­
(
·ge
);

3141 
kvaddr
 +ð
off£t
;

3142 } ià(
	`WARN_ON
(!
kvaddr
)) {

3143 
	`__sdma_txþ—n
(
dd
, 
tx
);

3144  -
EINVAL
;

3147 
	`memýy
(
tx
->
cßËsû_buf
 +x->
cßËsû_idx
, 
kvaddr
, 
Ën
);

3148 
tx
->
cßËsû_idx
 +ð
Ën
;

3149 ià(
ty³
 =ð
SDMA_MAP_PAGE
)

3150 
	`kunm­
(
·ge
);

3153 ià(
tx
->
Ž’
 -x->
cßËsû_idx
)

3157 
·d_Ën
 = 
tx
->
·ck‘_Ën
 & ((
u32
) - 1);

3158 ià(
·d_Ën
) {

3159 
·d_Ën
 = (
u32
) -…ad_len;

3160 
	`mem£t
(
tx
->
cßËsû_buf
 +x->
cßËsû_idx
, 0, 
·d_Ën
);

3162 
tx
->
·ck‘_Ën
 +ð
·d_Ën
;

3163 
tx
->
Ž’
 +ð
·d_Ën
;

3167 
addr
 = 
	`dma_m­_sšgË
(&
dd
->
pcidev
->
dev
,

3168 
tx
->
cßËsû_buf
,

3169 
tx
->
Ž’
,

3170 
DMA_TO_DEVICE
);

3172 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(&
dd
->
pcidev
->
dev
, 
addr
))) {

3173 
	`__sdma_txþ—n
(
dd
, 
tx
);

3174  -
ENOSPC
;

3178 
tx
->
desc_lim™
 = 
MAX_DESC
;

3179  
	`_sdma_txadd_daddr
(
dd
, 
SDMA_MAP_SINGLE
, 
tx
,

3180 
addr
, 
tx
->
Ž’
);

3184 
	}
}

3187 
	$sdma_upd©e_lmc
(
hfi1_devd©a
 *
dd
, 
u64
 
mask
, 
u32
 
lid
)

3189 
sdma_’gše
 *
sde
;

3190 
i
;

3191 
u64
 
¤eg
;

3193 
¤eg
 = ((
mask
 & 
	`SD
(
CHECK_SLID_MASK_MASK
)) <<

3194 
	`SD
(
CHECK_SLID_MASK_SHIFT
)) |

3195 (((
lid
 & 
mask
è& 
	`SD
(
CHECK_SLID_VALUE_MASK
)) <<

3196 
	`SD
(
CHECK_SLID_VALUE_SHIFT
));

3198 
i
 = 0; i < 
dd
->
num_sdma
; i++) {

3199 
	`hfi1_cdbg
(
LINKVERB
, "SendDmaEngine[%d].SLID_CHECK = 0x%x",

3200 
i
, (
u32
)
¤eg
);

3201 
sde
 = &
dd
->
³r_sdma
[
i
];

3202 
	`wr™e_sde_c¤
(
sde
, 
	`SD
(
CHECK_SLID
), 
¤eg
);

3204 
	}
}

3207 
	$_·d_sdma_tx_descs
(
hfi1_devd©a
 *
dd
, 
sdma_tx»q
 *
tx
)

3209 
rv®
 = 0;

3211 
tx
->
num_desc
++;

3212 ià((
	`uÆik–y
(
tx
->
num_desc
 =ðtx->
desc_lim™
))) {

3213 
rv®
 = 
	`_ex‹nd_sdma_tx_descs
(
dd
, 
tx
);

3214 ià(
rv®
) {

3215 
	`__sdma_txþ—n
(
dd
, 
tx
);

3216  
rv®
;

3220 
	`make_tx_sdma_desc
(

3221 
tx
,

3222 
SDMA_MAP_NONE
,

3223 
dd
->
sdma_·d_phys
,

3224 (
u32
è- (
tx
->
·ck‘_Ën
 & ((u32) - 1)));

3225 
	`_sdma_þo£_tx
(
dd
, 
tx
);

3226  
rv®
;

3227 
	}
}

3236 
	$_sdma_tx»q_ahgadd
(

3237 
sdma_tx»q
 *
tx
,

3238 
u8
 
num_ahg
,

3239 
u8
 
ahg_’Œy
,

3240 
u32
 *
ahg
,

3241 
u8
 
ahg_hËn
)

3243 
u32
 
i
, 
shiá
 = 0, 
desc
 = 0;

3244 
u8
 
mode
;

3246 
	`WARN_ON_ONCE
(
num_ahg
 > 9 || (
ahg_hËn
 & 3) ||‡hg_hlen == 4);

3248 ià(
num_ahg
 == 1)

3249 
mode
 = 
SDMA_AHG_APPLY_UPDATE1
;

3250 ià(
num_ahg
 <= 5)

3251 
mode
 = 
SDMA_AHG_APPLY_UPDATE2
;

3253 
mode
 = 
SDMA_AHG_APPLY_UPDATE3
;

3254 
tx
->
num_desc
++;

3256 
mode
) {

3257 
SDMA_AHG_APPLY_UPDATE3
:

3258 
tx
->
num_desc
++;

3259 
tx
->
descs
[2].
qw
[0] = 0;

3260 
tx
->
descs
[2].
qw
[1] = 0;

3262 
SDMA_AHG_APPLY_UPDATE2
:

3263 
tx
->
num_desc
++;

3264 
tx
->
descs
[1].
qw
[0] = 0;

3265 
tx
->
descs
[1].
qw
[1] = 0;

3268 
ahg_hËn
 >>= 2;

3269 
tx
->
descs
[0].
qw
[1] |=

3270 (((
u64
)
ahg_’Œy
 & 
SDMA_DESC1_HEADER_INDEX_MASK
)

3271 << 
SDMA_DESC1_HEADER_INDEX_SHIFT
) |

3272 (((
u64
)
ahg_hËn
 & 
SDMA_DESC1_HEADER_DWS_MASK
)

3273 << 
SDMA_DESC1_HEADER_DWS_SHIFT
) |

3274 (((
u64
)
mode
 & 
SDMA_DESC1_HEADER_MODE_MASK
)

3275 << 
SDMA_DESC1_HEADER_MODE_SHIFT
) |

3276 (((
u64
)
ahg
[0] & 
SDMA_DESC1_HEADER_UPDATE1_MASK
)

3277 << 
SDMA_DESC1_HEADER_UPDATE1_SHIFT
);

3278 
i
 = 0; i < (
num_ahg
 - 1); i++) {

3279 ià(!
shiá
 && !(
i
 & 2))

3280 
desc
++;

3281 
tx
->
descs
[
desc
].
qw
[!!(
i
 & 2)] |=

3282 (((
u64
)
ahg
[
i
 + 1])

3283 << 
shiá
);

3284 
shiá
 = (shift + 32) & 63;

3286 
	}
}

3296 
	$sdma_ahg_®loc
(
sdma_’gše
 *
sde
)

3298 
Ä
;

3299 
Þdb™
;

3301 ià(!
sde
) {

3302 
	`Œaû_hfi1_ahg_®loÿ‹
(
sde
, -
EINVAL
);

3303  -
EINVAL
;

3306 
Ä
 = 
	`ffz
(
	`READ_ONCE
(
sde
->
ahg_b™s
));

3307 ià(
Ä
 > 31) {

3308 
	`Œaû_hfi1_ahg_®loÿ‹
(
sde
, -
ENOSPC
);

3309  -
ENOSPC
;

3311 
Þdb™
 = 
	`‹¡_ªd_£t_b™
(
Ä
, &
sde
->
ahg_b™s
);

3312 ià(!
Þdb™
)

3314 
	`ýu_»Ïx
();

3316 
	`Œaû_hfi1_ahg_®loÿ‹
(
sde
, 
Ä
);

3317  
Ä
;

3318 
	}
}

3327 
	$sdma_ahg_ä“
(
sdma_’gše
 *
sde
, 
ahg_šdex
)

3329 ià(!
sde
)

3331 
	`Œaû_hfi1_ahg_d—Îoÿ‹
(
sde
, 
ahg_šdex
);

3332 ià(
ahg_šdex
 < 0 ||‡hg_index > 31)

3334 
	`þ—r_b™
(
ahg_šdex
, &
sde
->
ahg_b™s
);

3335 
	}
}

3345 
	$sdma_ä“ze_nÙify
(
hfi1_devd©a
 *
dd
, 
lšk_down
)

3347 
i
;

3348 
sdma_ev’ts
 
ev’t
 = 
lšk_down
 ? 
sdma_ev’t_e85_lšk_down
 :

3349 
sdma_ev’t_e80_hw_ä“ze
;

3352 
	`©omic_£t
(&
dd
->
sdma_unä“ze_couÁ
, dd->
num_sdma
);

3355 
i
 = 0; i < 
dd
->
num_sdma
; i++)

3356 
	`sdma_´oûss_ev’t
(&
dd
->
³r_sdma
[
i
], 
ev’t
);

3359 
	}
}

3365 
	$sdma_ä“ze
(
hfi1_devd©a
 *
dd
)

3367 
i
;

3368 
»t
;

3374 
»t
 = 
	`wa™_ev’t_š‹¼u±ibË
(
dd
->
sdma_unä“ze_wq
,

3375 
	`©omic_»ad
(&
dd
->
sdma_unä“ze_couÁ
) <=

3378 ià(
»t
 || 
	`©omic_»ad
(&
dd
->
sdma_unä“ze_couÁ
) < 0)

3382 
	`©omic_£t
(&
dd
->
sdma_unä“ze_couÁ
, dd->
num_sdma
);

3385 
i
 = 0; i < 
dd
->
num_sdma
; i++)

3386 
	`sdma_´oûss_ev’t
(&
dd
->
³r_sdma
[
i
], 
sdma_ev’t_e81_hw_äoz’
);

3393 ()
	`wa™_ev’t_š‹¼u±ibË
(
dd
->
sdma_unä“ze_wq
,

3394 
	`©omic_»ad
(&
dd
->
sdma_unä“ze_couÁ
) <= 0);

3396 
	}
}

3406 
	$sdma_unä“ze
(
hfi1_devd©a
 *
dd
)

3408 
i
;

3411 
i
 = 0; i < 
dd
->
num_sdma
; i++)

3412 
	`sdma_´oûss_ev’t
(&
dd
->
³r_sdma
[
i
],

3413 
sdma_ev’t_e82_hw_unä“ze
);

3414 
	}
}

3421 
	$_sdma_’gše_´og»ss_scheduË
(

3422 
sdma_’gše
 *
sde
)

3424 
	`Œaû_hfi1_sdma_’gše_´og»ss
(
sde
, sde->
´og»ss_mask
);

3426 
	`wr™e_c¤
(
sde
->
dd
,

3427 
CCE_INT_FORCE
 + (8 * (
IS_SDMA_START
 / 64)),

3428 
sde
->
´og»ss_mask
);

3429 
	}
}

	@sdma.h

1 #iâdeà
_HFI1_SDMA_H


2 
	#_HFI1_SDMA_H


	)

50 
	~<lšux/ty³s.h
>

51 
	~<lšux/li¡.h
>

52 
	~<asm/by‹Üd”.h
>

53 
	~<lšux/wÜkqueue.h
>

54 
	~<lšux/rculi¡.h
>

56 
	~"hfi.h
"

57 
	~"v”bs.h
"

58 
	~"sdma_tx»q.h
"

61 
	#MAX_DESC
 64

	)

63 
	#MAX_SDMA_PKT_SIZE
 ((16 * 1024è- 1)

	)

65 
	#SDMA_MAP_NONE
 0

	)

66 
	#SDMA_MAP_SINGLE
 1

	)

67 
	#SDMA_MAP_PAGE
 2

	)

69 
	#SDMA_AHG_VALUE_MASK
 0xffff

	)

70 
	#SDMA_AHG_VALUE_SHIFT
 0

	)

71 
	#SDMA_AHG_INDEX_MASK
 0xf

	)

72 
	#SDMA_AHG_INDEX_SHIFT
 16

	)

73 
	#SDMA_AHG_FIELD_LEN_MASK
 0xf

	)

74 
	#SDMA_AHG_FIELD_LEN_SHIFT
 20

	)

75 
	#SDMA_AHG_FIELD_START_MASK
 0x1f

	)

76 
	#SDMA_AHG_FIELD_START_SHIFT
 24

	)

77 
	#SDMA_AHG_UPDATE_ENABLE_MASK
 0x1

	)

78 
	#SDMA_AHG_UPDATE_ENABLE_SHIFT
 31

	)

88 
	#SDMA_AHG_NO_AHG
 0

	)

89 
	#SDMA_AHG_COPY
 1

	)

90 
	#SDMA_AHG_APPLY_UPDATE1
 2

	)

91 
	#SDMA_AHG_APPLY_UPDATE2
 3

	)

92 
	#SDMA_AHG_APPLY_UPDATE3
 4

	)

97 
	#SDMA_DESC0_FIRST_DESC_FLAG
 
	`BIT_ULL
(63)

	)

98 
	#SDMA_DESC0_LAST_DESC_FLAG
 
	`BIT_ULL
(62)

	)

99 
	#SDMA_DESC0_BYTE_COUNT_SHIFT
 48

	)

100 
	#SDMA_DESC0_BYTE_COUNT_WIDTH
 14

	)

101 
	#SDMA_DESC0_BYTE_COUNT_MASK
 \

102 ((1ULL << 
SDMA_DESC0_BYTE_COUNT_WIDTH
è- 1)

	)

103 
	#SDMA_DESC0_BYTE_COUNT_SMASK
 \

104 (
SDMA_DESC0_BYTE_COUNT_MASK
 << 
SDMA_DESC0_BYTE_COUNT_SHIFT
)

	)

105 
	#SDMA_DESC0_PHY_ADDR_SHIFT
 0

	)

106 
	#SDMA_DESC0_PHY_ADDR_WIDTH
 48

	)

107 
	#SDMA_DESC0_PHY_ADDR_MASK
 \

108 ((1ULL << 
SDMA_DESC0_PHY_ADDR_WIDTH
è- 1)

	)

109 
	#SDMA_DESC0_PHY_ADDR_SMASK
 \

110 (
SDMA_DESC0_PHY_ADDR_MASK
 << 
SDMA_DESC0_PHY_ADDR_SHIFT
)

	)

112 
	#SDMA_DESC1_HEADER_UPDATE1_SHIFT
 32

	)

113 
	#SDMA_DESC1_HEADER_UPDATE1_WIDTH
 32

	)

114 
	#SDMA_DESC1_HEADER_UPDATE1_MASK
 \

115 ((1ULL << 
SDMA_DESC1_HEADER_UPDATE1_WIDTH
è- 1)

	)

116 
	#SDMA_DESC1_HEADER_UPDATE1_SMASK
 \

117 (
SDMA_DESC1_HEADER_UPDATE1_MASK
 << 
SDMA_DESC1_HEADER_UPDATE1_SHIFT
)

	)

118 
	#SDMA_DESC1_HEADER_MODE_SHIFT
 13

	)

119 
	#SDMA_DESC1_HEADER_MODE_WIDTH
 3

	)

120 
	#SDMA_DESC1_HEADER_MODE_MASK
 \

121 ((1ULL << 
SDMA_DESC1_HEADER_MODE_WIDTH
è- 1)

	)

122 
	#SDMA_DESC1_HEADER_MODE_SMASK
 \

123 (
SDMA_DESC1_HEADER_MODE_MASK
 << 
SDMA_DESC1_HEADER_MODE_SHIFT
)

	)

124 
	#SDMA_DESC1_HEADER_INDEX_SHIFT
 8

	)

125 
	#SDMA_DESC1_HEADER_INDEX_WIDTH
 5

	)

126 
	#SDMA_DESC1_HEADER_INDEX_MASK
 \

127 ((1ULL << 
SDMA_DESC1_HEADER_INDEX_WIDTH
è- 1)

	)

128 
	#SDMA_DESC1_HEADER_INDEX_SMASK
 \

129 (
SDMA_DESC1_HEADER_INDEX_MASK
 << 
SDMA_DESC1_HEADER_INDEX_SHIFT
)

	)

130 
	#SDMA_DESC1_HEADER_DWS_SHIFT
 4

	)

131 
	#SDMA_DESC1_HEADER_DWS_WIDTH
 4

	)

132 
	#SDMA_DESC1_HEADER_DWS_MASK
 \

133 ((1ULL << 
SDMA_DESC1_HEADER_DWS_WIDTH
è- 1)

	)

134 
	#SDMA_DESC1_HEADER_DWS_SMASK
 \

135 (
SDMA_DESC1_HEADER_DWS_MASK
 << 
SDMA_DESC1_HEADER_DWS_SHIFT
)

	)

136 
	#SDMA_DESC1_GENERATION_SHIFT
 2

	)

137 
	#SDMA_DESC1_GENERATION_WIDTH
 2

	)

138 
	#SDMA_DESC1_GENERATION_MASK
 \

139 ((1ULL << 
SDMA_DESC1_GENERATION_WIDTH
è- 1)

	)

140 
	#SDMA_DESC1_GENERATION_SMASK
 \

141 (
SDMA_DESC1_GENERATION_MASK
 << 
SDMA_DESC1_GENERATION_SHIFT
)

	)

142 
	#SDMA_DESC1_INT_REQ_FLAG
 
	`BIT_ULL
(1)

	)

143 
	#SDMA_DESC1_HEAD_TO_HOST_FLAG
 
	`BIT_ULL
(0)

	)

145 
	esdma_¡©es
 {

146 
	msdma_¡©e_s00_hw_down
,

147 
	msdma_¡©e_s10_hw_¡¬t_up_h®t_wa™
,

148 
	msdma_¡©e_s15_hw_¡¬t_up_þ—n_wa™
,

149 
	msdma_¡©e_s20_idË
,

150 
	msdma_¡©e_s30_sw_þ—n_up_wa™
,

151 
	msdma_¡©e_s40_hw_þ—n_up_wa™
,

152 
	msdma_¡©e_s50_hw_h®t_wa™
,

153 
	msdma_¡©e_s60_idË_h®t_wa™
,

154 
	msdma_¡©e_s80_hw_ä“ze
,

155 
	msdma_¡©e_s82_ä“ze_sw_þ—n
,

156 
	msdma_¡©e_s99_ruÂšg
,

159 
	esdma_ev’ts
 {

160 
	msdma_ev’t_e00_go_hw_down
,

161 
	msdma_ev’t_e10_go_hw_¡¬t
,

162 
	msdma_ev’t_e15_hw_h®t_dÚe
,

163 
	msdma_ev’t_e25_hw_þ—n_up_dÚe
,

164 
	msdma_ev’t_e30_go_ruÂšg
,

165 
	msdma_ev’t_e40_sw_þ—Ãd
,

166 
	msdma_ev’t_e50_hw_þ—Ãd
,

167 
	msdma_ev’t_e60_hw_h®‹d
,

168 
	msdma_ev’t_e70_go_idË
,

169 
	msdma_ev’t_e80_hw_ä“ze
,

170 
	msdma_ev’t_e81_hw_äoz’
,

171 
	msdma_ev’t_e82_hw_unä“ze
,

172 
	msdma_ev’t_e85_lšk_down
,

173 
	msdma_ev’t_e90_sw_h®‹d
,

176 
	ssdma_£t_¡©e_aùiÚ
 {

177 
	mÝ_’abË
:1;

178 
	mÝ_š‹ÇbË
:1;

179 
	mÝ_h®t
:1;

180 
	mÝ_þ—nup
:1;

181 
	mgo_s99_ruÂšg_toçl£
:1;

182 
	mgo_s99_ruÂšg_tÙrue
:1;

185 
	ssdma_¡©e
 {

186 
k»f
 
	mk»f
;

187 
com¶‘iÚ
 
	mcomp
;

188 
sdma_¡©es
 
	mcu¼’t_¡©e
;

189 
	mcu¼’t_Ý
;

190 
	mgo_s99_ruÂšg
;

192 
sdma_¡©es
 
	m´evious_¡©e
;

193 
	m´evious_Ý
;

194 
sdma_ev’ts
 
	mÏ¡_ev’t
;

294 
	shw_sdma_desc
 {

296 
__Ë64
 
	mqw
[2];

311 
	ssdma_’gše
 {

313 
hfi1_devd©a
 *
	mdd
;

314 
hfi1_µÜtd©a
 *
	mµd
;

316 
__iomem
 *
	mž_c¤
;

317 
u64
 
	mimask
;

318 
u64
 
	midË_mask
;

319 
u64
 
	m´og»ss_mask
;

320 
u64
 
	mšt_mask
;

322 vÞ©ž
__Ë64
 *
	mh—d_dma
;

324 
dma_addr_t
 
	mh—d_phys
;

326 
hw_sdma_desc
 *
	mdescq
;

328 
	mdescq_fuÎ_couÁ
;

329 
sdma_tx»q
 **
	mtx_ršg
;

331 
dma_addr_t
 
	mdescq_phys
;

333 
u32
 
	msdma_mask
;

335 
sdma_¡©e
 
	m¡©e
;

337 
	mýu
;

339 
u8
 
	msdma_shiá
;

341 
u8
 
	mthis_idx
;

343 
¥šlock_t
 
	m£nddmaù¾_lock
;

345 
u64
 
	mp_£nddmaù¾
;

348 
¥šlock_t
 
ž_lock
 
	m____ÿch–še_®igÃd_š_smp
;

349 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


351 
u64
 
	mž_¢
;

354 
u32
 
	mdescq_ž
;

356 
	mahg_b™s
;

358 
u16
 
	mdesc_avaž
;

360 
u16
 
	mtx_ž
;

362 
u16
 
	mdescq_út
;

366 
£qlock_t
 
h—d_lock
 
	m____ÿch–še_®igÃd_š_smp
;

367 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


369 
u64
 
	mh—d_¢
;

372 
u32
 
	mdescq_h—d
;

374 
u16
 
	mtx_h—d
;

376 
u64
 
	mÏ¡_¡©us
;

378 
u64
 
	m”r_út
;

380 
u64
 
	msdma_št_út
;

381 
u64
 
	midË_št_út
;

382 
u64
 
	m´og»ss_št_út
;

385 
£qlock_t
 
	mwa™lock
;

386 
li¡_h—d
 
	mdmawa™
;

390 
skËt_¡ruù
 
sdma_hw_þ—n_up_sk


391 
	m____ÿch–še_®igÃd_š_smp
;

394 
skËt_¡ruù
 
sdma_sw_þ—n_up_sk


395 
	m____ÿch–še_®igÃd_š_smp
;

397 
wÜk_¡ruù
 
	m”r_h®t_wÜk”
;

399 
tim”_li¡
 
	m”r_´og»ss_check_tim”
;

400 
u32
 
	m´og»ss_check_h—d
;

402 
wÜk_¡ruù
 
	mæush_wÜk”
;

404 
¥šlock_t
 
	mæushli¡_lock
;

406 
li¡_h—d
 
	mæushli¡
;

407 
ýumask
 
	mýu_mask
;

408 
kobjeù
 
	mkobj
;

409 
u32
 
	mmsix_šŒ
;

412 
sdma_š™
(
hfi1_devd©a
 *
dd
, 
u8
 
pÜt
);

413 
sdma_¡¬t
(
hfi1_devd©a
 *
dd
);

414 
sdma_ex™
(
hfi1_devd©a
 *
dd
);

415 
sdma_þ—n
(
hfi1_devd©a
 *
dd
, 
size_t
 
num_’gšes
);

416 
sdma_®l_ruÂšg
(
hfi1_devd©a
 *
dd
);

417 
sdma_®l_idË
(
hfi1_devd©a
 *
dd
);

418 
sdma_ä“ze_nÙify
(
hfi1_devd©a
 *
dd
, 
go_idË
);

419 
sdma_ä“ze
(
hfi1_devd©a
 *
dd
);

420 
sdma_unä“ze
(
hfi1_devd©a
 *
dd
);

421 
sdma_wa™
(
hfi1_devd©a
 *
dd
);

432 
šlše
 
	$sdma_em±y
(
sdma_’gše
 *
sde
)

434  
sde
->
descq_ž
 =ðsde->
descq_h—d
;

435 
	}
}

437 
šlše
 
u16
 
	$sdma_descq_ä“út
(
sdma_’gše
 *
sde
)

439  
sde
->
descq_út
 -

440 (
sde
->
descq_ž
 -

441 
	`READ_ONCE
(
sde
->
descq_h—d
)) - 1;

442 
	}
}

444 
šlše
 
u16
 
	$sdma_descq_š´oûss
(
sdma_’gše
 *
sde
)

446  
sde
->
descq_út
 - 
	`sdma_descq_ä“út
(sde);

447 
	}
}

453 
šlše
 
	$__sdma_ruÂšg
(
sdma_’gše
 *
’gše
)

455  
’gše
->
¡©e
.
cu¼’t_¡©e
 =ð
sdma_¡©e_s99_ruÂšg
;

456 
	}
}

469 
šlše
 
	$sdma_ruÂšg
(
sdma_’gše
 *
’gše
)

471 
æags
;

472 
»t
;

474 
	`¥š_lock_œq§ve
(&
’gše
->
ž_lock
, 
æags
);

475 
»t
 = 
	`__sdma_ruÂšg
(
’gše
);

476 
	`¥š_uÆock_œq»¡Üe
(&
’gše
->
ž_lock
, 
æags
);

477  
»t
;

478 
	}
}

480 
_sdma_tx»q_ahgadd
(

481 
sdma_tx»q
 *
tx
,

482 
u8
 
num_ahg
,

483 
u8
 
ahg_’Œy
,

484 
u32
 *
ahg
,

485 
u8
 
ahg_hËn
);

539 
šlše
 
sdma_txš™_ahg
(

540 
sdma_tx»q
 *
tx
,

541 
u16
 
æags
,

542 
u16
 
Ž’
,

543 
u8
 
ahg_’Œy
,

544 
u8
 
num_ahg
,

545 
u32
 *
ahg
,

546 
u8
 
ahg_hËn
,

547 (*
cb
)(
sdma_tx»q
 *, ))

549 ià(
Ž’
 == 0)

550  -
ENODATA
;

551 ià(
Ž’
 > 
MAX_SDMA_PKT_SIZE
)

552  -
EMSGSIZE
;

553 
tx
->
desc_lim™
 = 
	`ARRAY_SIZE
Ñx->
descs
);

554 
tx
->
desý
 = &tx->
descs
[0];

555 
	`INIT_LIST_HEAD
(&
tx
->
li¡
);

556 
tx
->
num_desc
 = 0;

557 
tx
->
æags
 = flags;

558 
tx
->
com¶‘e
 = 
cb
;

559 
tx
->
cßËsû_buf
 = 
NULL
;

560 
tx
->
wa™
 = 
NULL
;

561 
tx
->
·ck‘_Ën
 = 
Ž’
;

562 
tx
->
Ž’
 =x->
·ck‘_Ën
;

563 
tx
->
descs
[0].
qw
[0] = 
SDMA_DESC0_FIRST_DESC_FLAG
;

564 
tx
->
descs
[0].
qw
[1] = 0;

565 ià(
æags
 & 
SDMA_TXREQ_F_AHG_COPY
)

566 
tx
->
descs
[0].
qw
[1] |=

567 (((
u64
)
ahg_’Œy
 & 
SDMA_DESC1_HEADER_INDEX_MASK
)

568 << 
SDMA_DESC1_HEADER_INDEX_SHIFT
) |

569 (((
u64
)
SDMA_AHG_COPY
 & 
SDMA_DESC1_HEADER_MODE_MASK
)

570 << 
SDMA_DESC1_HEADER_MODE_SHIFT
);

571 ià(
æags
 & 
SDMA_TXREQ_F_USE_AHG
 && 
num_ahg
)

572 
	`_sdma_tx»q_ahgadd
(
tx
, 
num_ahg
, 
ahg_’Œy
, 
ahg
, 
ahg_hËn
);

574 
	}
}

607 
šlše
 
sdma_txš™
(

608 
sdma_tx»q
 *
tx
,

609 
u16
 
æags
,

610 
u16
 
Ž’
,

611 (*
cb
)(
sdma_tx»q
 *, ))

613  
	`sdma_txš™_ahg
(
tx
, 
æags
, 
Ž’
, 0, 0, 
NULL
, 0, 
cb
);

614 
	}
}

617 
šlše
 
	$sdma_m­pšg_ty³
(
sdma_desc
 *
d
)

619  (
d
->
qw
[1] & 
SDMA_DESC1_GENERATION_SMASK
)

620 >> 
SDMA_DESC1_GENERATION_SHIFT
;

621 
	}
}

623 
šlše
 
size_t
 
	$sdma_m­pšg_Ën
(
sdma_desc
 *
d
)

625  (
d
->
qw
[0] & 
SDMA_DESC0_BYTE_COUNT_SMASK
)

626 >> 
SDMA_DESC0_BYTE_COUNT_SHIFT
;

627 
	}
}

629 
šlše
 
dma_addr_t
 
	$sdma_m­pšg_addr
(
sdma_desc
 *
d
)

631  (
d
->
qw
[0] & 
SDMA_DESC0_PHY_ADDR_SMASK
)

632 >> 
SDMA_DESC0_PHY_ADDR_SHIFT
;

633 
	}
}

635 
šlše
 
	$make_tx_sdma_desc
(

636 
sdma_tx»q
 *
tx
,

637 
ty³
,

638 
dma_addr_t
 
addr
,

639 
size_t
 
Ën
)

641 
sdma_desc
 *
desc
 = &
tx
->
desý
[tx->
num_desc
];

643 ià(!
tx
->
num_desc
) {

645 
desc
->
qw
[1] |ð((
u64
)
ty³
 & 
SDMA_DESC1_GENERATION_MASK
)

646 << 
SDMA_DESC1_GENERATION_SHIFT
;

648 
desc
->
qw
[0] = 0;

649 
desc
->
qw
[1] = ((
u64
)
ty³
 & 
SDMA_DESC1_GENERATION_MASK
)

650 << 
SDMA_DESC1_GENERATION_SHIFT
;

652 
desc
->
qw
[0] |ð(((
u64
)
addr
 & 
SDMA_DESC0_PHY_ADDR_MASK
)

653 << 
SDMA_DESC0_PHY_ADDR_SHIFT
) |

654 (((
u64
)
Ën
 & 
SDMA_DESC0_BYTE_COUNT_MASK
)

655 << 
SDMA_DESC0_BYTE_COUNT_SHIFT
);

656 
	}
}

659 
ext_cßl_sdma_tx_descs
(
hfi1_devd©a
 *
dd
, 
sdma_tx»q
 *
tx
,

660 
ty³
, *
kvaddr
, 
·ge
 *page,

661 
off£t
, 
u16
 
Ën
);

662 
_·d_sdma_tx_descs
(
hfi1_devd©a
 *, 
sdma_tx»q
 *);

663 
__sdma_txþ—n
(
hfi1_devd©a
 *, 
sdma_tx»q
 *);

665 
šlše
 
	$sdma_txþ—n
(
hfi1_devd©a
 *
dd
, 
sdma_tx»q
 *
tx
)

667 ià(
tx
->
num_desc
)

668 
	`__sdma_txþ—n
(
dd
, 
tx
);

669 
	}
}

672 
šlše
 
	$_sdma_þo£_tx
(
hfi1_devd©a
 *
dd
,

673 
sdma_tx»q
 *
tx
)

675 
tx
->
desý
[tx->
num_desc
].
qw
[0] |=

676 
SDMA_DESC0_LAST_DESC_FLAG
;

677 
tx
->
desý
[tx->
num_desc
].
qw
[1] |=

678 
dd
->
deçuÉ_desc1
;

679 ià(
tx
->
æags
 & 
SDMA_TXREQ_F_URGENT
)

680 
tx
->
desý
[tx->
num_desc
].
qw
[1] |=

681 (
SDMA_DESC1_HEAD_TO_HOST_FLAG
 |

682 
SDMA_DESC1_INT_REQ_FLAG
);

683 
	}
}

685 
šlše
 
	$_sdma_txadd_daddr
(

686 
hfi1_devd©a
 *
dd
,

687 
ty³
,

688 
sdma_tx»q
 *
tx
,

689 
dma_addr_t
 
addr
,

690 
u16
 
Ën
)

692 
rv®
 = 0;

694 
	`make_tx_sdma_desc
(

695 
tx
,

696 
ty³
,

697 
addr
, 
Ën
);

698 
	`WARN_ON
(
Ën
 > 
tx
->
Ž’
);

699 
tx
->
Ž’
 -ð
Ën
;

701 ià(!
tx
->
Ž’
) {

702 ià(
tx
->
·ck‘_Ën
 & ((
u32
) - 1)) {

703 
rv®
 = 
	`_·d_sdma_tx_descs
(
dd
, 
tx
);

704 ià(
rv®
)

705  
rv®
;

707 
	`_sdma_þo£_tx
(
dd
, 
tx
);

710 
tx
->
num_desc
++;

711  
rv®
;

712 
	}
}

730 
šlše
 
	$sdma_txadd_·ge
(

731 
hfi1_devd©a
 *
dd
,

732 
sdma_tx»q
 *
tx
,

733 
·ge
 *page,

734 
off£t
,

735 
u16
 
Ën
)

737 
dma_addr_t
 
addr
;

738 
rv®
;

740 ià((
	`uÆik–y
(
tx
->
num_desc
 =ðtx->
desc_lim™
))) {

741 
rv®
 = 
	`ext_cßl_sdma_tx_descs
(
dd
, 
tx
, 
SDMA_MAP_PAGE
,

742 
NULL
, 
·ge
, 
off£t
, 
Ën
);

743 ià(
rv®
 <= 0)

744  
rv®
;

747 
addr
 = 
	`dma_m­_·ge
(

748 &
dd
->
pcidev
->
dev
,

749 
·ge
,

750 
off£t
,

751 
Ën
,

752 
DMA_TO_DEVICE
);

754 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(&
dd
->
pcidev
->
dev
, 
addr
))) {

755 
	`__sdma_txþ—n
(
dd
, 
tx
);

756  -
ENOSPC
;

759  
	`_sdma_txadd_daddr
(

760 
dd
, 
SDMA_MAP_PAGE
, 
tx
, 
addr
, 
Ën
);

761 
	}
}

779 
šlše
 
	$sdma_txadd_daddr
(

780 
hfi1_devd©a
 *
dd
,

781 
sdma_tx»q
 *
tx
,

782 
dma_addr_t
 
addr
,

783 
u16
 
Ën
)

785 
rv®
;

787 ià((
	`uÆik–y
(
tx
->
num_desc
 =ðtx->
desc_lim™
))) {

788 
rv®
 = 
	`ext_cßl_sdma_tx_descs
(
dd
, 
tx
, 
SDMA_MAP_NONE
,

789 
NULL
, NULL, 0, 0);

790 ià(
rv®
 <= 0)

791  
rv®
;

794  
	`_sdma_txadd_daddr
(
dd
, 
SDMA_MAP_NONE
, 
tx
, 
addr
, 
Ën
);

795 
	}
}

813 
šlše
 
	$sdma_txadd_kvaddr
(

814 
hfi1_devd©a
 *
dd
,

815 
sdma_tx»q
 *
tx
,

816 *
kvaddr
,

817 
u16
 
Ën
)

819 
dma_addr_t
 
addr
;

820 
rv®
;

822 ià((
	`uÆik–y
(
tx
->
num_desc
 =ðtx->
desc_lim™
))) {

823 
rv®
 = 
	`ext_cßl_sdma_tx_descs
(
dd
, 
tx
, 
SDMA_MAP_SINGLE
,

824 
kvaddr
, 
NULL
, 0, 
Ën
);

825 ià(
rv®
 <= 0)

826  
rv®
;

829 
addr
 = 
	`dma_m­_sšgË
(

830 &
dd
->
pcidev
->
dev
,

831 
kvaddr
,

832 
Ën
,

833 
DMA_TO_DEVICE
);

835 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(&
dd
->
pcidev
->
dev
, 
addr
))) {

836 
	`__sdma_txþ—n
(
dd
, 
tx
);

837  -
ENOSPC
;

840  
	`_sdma_txadd_daddr
(

841 
dd
, 
SDMA_MAP_SINGLE
, 
tx
, 
addr
, 
Ën
);

842 
	}
}

844 
	giowa™_wÜk
;

846 
sdma_£nd_tx»q
(
sdma_’gše
 *
sde
,

847 
iowa™_wÜk
 *
wa™
,

848 
sdma_tx»q
 *
tx
,

849 
boÞ
 
pkts_£Á
);

850 
sdma_£nd_txli¡
(
sdma_’gše
 *
sde
,

851 
iowa™_wÜk
 *
wa™
,

852 
li¡_h—d
 *
tx_li¡
,

853 
u16
 *
couÁ
);

855 
sdma_ahg_®loc
(
sdma_’gše
 *
sde
);

856 
sdma_ahg_ä“
(
sdma_’gše
 *
sde
, 
ahg_šdex
);

867 
šlše
 
u32
 
	$sdma_bužd_ahg_desütÜ
(

868 
u16
 
d©a
,

869 
u8
 
dwšdex
,

870 
u8
 
¡¬tb™
,

871 
u8
 
b™s
)

873  (
u32
)(1UL << 
SDMA_AHG_UPDATE_ENABLE_SHIFT
 |

874 ((
¡¬tb™
 & 
SDMA_AHG_FIELD_START_MASK
) <<

875 
SDMA_AHG_FIELD_START_SHIFT
) |

876 ((
b™s
 & 
SDMA_AHG_FIELD_LEN_MASK
) <<

877 
SDMA_AHG_FIELD_LEN_SHIFT
) |

878 ((
dwšdex
 & 
SDMA_AHG_INDEX_MASK
) <<

879 
SDMA_AHG_INDEX_SHIFT
) |

880 ((
d©a
 & 
SDMA_AHG_VALUE_MASK
) <<

881 
SDMA_AHG_VALUE_SHIFT
));

882 
	}
}

898 
šlše
 
	$sdma_´og»ss
(
sdma_’gše
 *
sde
, 
£q
,

899 
sdma_tx»q
 *
tx
)

901 ià(
	`»ad_£q»Œy
(&
sde
->
h—d_lock
, 
£q
)) {

902 
sde
->
desc_avaž
 = 
	`sdma_descq_ä“út
(sde);

903 ià(
tx
->
num_desc
 > 
sde
->
desc_avaž
)

908 
	}
}

911 
sdma_’gše_”rÜ
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
);

912 
sdma_’gše_š‹¼u±
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
);

985 
	ssdma_m­_–em
 {

986 
u32
 
	mmask
;

987 
sdma_’gše
 *
	msde
[0];

1003 
	ssdma_vl_m­
 {

1004 
s8
 
	m’gše_to_vl
[
TXE_NUM_SDMA_ENGINES
];

1005 
rcu_h—d
 
	mli¡
;

1006 
u32
 
	mmask
;

1007 
u8
 
	maùu®_vls
;

1008 
u8
 
	mvls
;

1009 
sdma_m­_–em
 *
	mm­
[0];

1012 
sdma_m­_š™
(

1013 
hfi1_devd©a
 *
dd
,

1014 
u8
 
pÜt
,

1015 
u8
 
num_vls
,

1016 
u8
 *
vl_’gšes
);

1019 
_sdma_’gše_´og»ss_scheduË
(
sdma_’gše
 *
sde
);

1028 
šlše
 
	$sdma_’gše_´og»ss_scheduË
(

1029 
sdma_’gše
 *
sde
)

1031 ià(!
sde
 || 
	`sdma_descq_š´oûss
(sdeè< (sde->
descq_út
 / 8))

1033 
	`_sdma_’gše_´og»ss_scheduË
(
sde
);

1034 
	}
}

1036 
sdma_’gše
 *
sdma_£Ëù_’gše_sc
(

1037 
hfi1_devd©a
 *
dd
,

1038 
u32
 
£ËùÜ
,

1039 
u8
 
sc5
);

1041 
sdma_’gše
 *
sdma_£Ëù_’gše_vl
(

1042 
hfi1_devd©a
 *
dd
,

1043 
u32
 
£ËùÜ
,

1044 
u8
 
vl
);

1046 
sdma_’gše
 *
sdma_£Ëù_u£r_’gše
(
hfi1_devd©a
 *
dd
,

1047 
u32
 
£ËùÜ
, 
u8
 
vl
);

1048 
ssize_t
 
sdma_g‘_ýu_to_sde_m­
(
sdma_’gše
 *
sde
, *
buf
);

1049 
ssize_t
 
sdma_£t_ýu_to_sde_m­
(
sdma_’gše
 *
sde
, cÚ¡ *
buf
,

1050 
size_t
 
couÁ
);

1051 
sdma_’gše_g‘_vl
(
sdma_’gše
 *
sde
);

1052 
sdma_£qfže_dump_sde
(
£q_fže
 *
s
, 
sdma_’gše
 *);

1053 
sdma_£qfže_dump_ýu_li¡
(
£q_fže
 *
s
, 
hfi1_devd©a
 *
dd
,

1054 
ýuid
);

1056 #ifdeà
CONFIG_SDMA_VERBOSITY


1057 
sdma_dump¡©e
(
sdma_’gše
 *);

1059 
šlše
 *
	$¦ash¡r
(*
s
)

1061 *
r
 = 
s
;

1063 *
s
)

1064 ià(*
s
++ == '/')

1065 
r
 = 
s
;

1066  
r
;

1067 
	}
}

1069 
u16
 
sdma_g‘_descq_út
();

1071 
ušt
 
mod_num_sdma
;

1073 
sdma_upd©e_lmc
(
hfi1_devd©a
 *
dd
, 
u64
 
mask
, 
u32
 
lid
);

	@sdma_txreq.h

48 #iâdeà
HFI1_SDMA_TXREQ_H


49 
	#HFI1_SDMA_TXREQ_H


	)

52 
	#NUM_DESC
 6

	)

61 
	ssdma_desc
 {

63 
u64
 
	mqw
[2];

85 
	#SDMA_TXREQ_S_OK
 0

	)

86 
	#SDMA_TXREQ_S_SENDERROR
 1

	)

87 
	#SDMA_TXREQ_S_ABORTED
 2

	)

88 
	#SDMA_TXREQ_S_SHUTDOWN
 3

	)

91 
	#SDMA_TXREQ_F_URGENT
 0x0001

	)

92 
	#SDMA_TXREQ_F_AHG_COPY
 0x0002

	)

93 
	#SDMA_TXREQ_F_USE_AHG
 0x0004

	)

94 
	#SDMA_TXREQ_F_SGE_CORRUPT
 0x0008

	)

95 
	#SDMA_TXREQ_F_VIP
 0x0010

	)

97 
	gsdma_tx»q
;

98 (*
	tÿÎback_t
)(
	tsdma_tx»q
 *, );

100 
iowa™
;

101 
	ssdma_tx»q
 {

102 
li¡_h—d
 
li¡
;

104 
sdma_desc
 *
desý
;

106 *
cßËsû_buf
;

108 
iowa™
 *
wa™
;

110 
ÿÎback_t
 
com¶‘e
;

111 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


112 
u64
 
¢
;

115 
u16
 
·ck‘_Ën
;

117 
u16
 
Ž’
;

119 
u16
 
num_desc
;

121 
u16
 
desc_lim™
;

123 
u16
 
Ãxt_descq_idx
;

125 
u16
 
cßËsû_idx
;

127 
u16
 
æags
;

129 
sdma_desc
 
descs
[
NUM_DESC
];

132 
šlše
 
	$sdma_tx»q_bužt
(
sdma_tx»q
 *
tx
)

134  
tx
->
num_desc
;

135 
	}
}

	@sysfs.c

47 
	~<lšux/ùy³.h
>

49 
	~"hfi.h
"

50 
	~"mad.h
"

51 
	~"Œaû.h
"

60 
ssize_t
 
	$»ad_cc_bË_bš
(
fže
 *
fžp
, 
kobjeù
 *
kobj
,

61 
bš_©Œibu‹
 *
bš_©Œ
,

62 *
buf
, 
loff_t
 
pos
, 
size_t
 
couÁ
)

64 
»t
;

65 
hfi1_µÜtd©a
 *
µd
 =

66 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
µÜt_cc_kobj
);

67 
cc_¡©e
 *cc_state;

69 
»t
 = 
µd
->
tÙ®_cù_’Œy
 * (
ib_cc_bË_’Œy_shadow
)

70 + (
__be16
);

72 ià(
pos
 > 
»t
)

73  -
EINVAL
;

75 ià(
couÁ
 > 
»t
 - 
pos
)

76 
couÁ
 = 
»t
 - 
pos
;

78 ià(!
couÁ
)

79  
couÁ
;

81 
	`rcu_»ad_lock
();

82 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

83 ià(!
cc_¡©e
) {

84 
	`rcu_»ad_uÆock
();

85  -
EINVAL
;

87 
	`memýy
(
buf
, (*)&
cc_¡©e
->
cù
 + 
pos
, 
couÁ
);

88 
	`rcu_»ad_uÆock
();

90  
couÁ
;

91 
	}
}

93 
	$pÜt_»Ëa£
(
kobjeù
 *
kobj
)

96 
	}
}

98 cÚ¡ 
bš_©Œibu‹
 
	gcc_bË_bš_©Œ
 = {

99 .
©Œ
 = {.
Çme
 = "cc_bË_bš", .
	gmode
 = 0444},

100 .
	g»ad
 = 
»ad_cc_bË_bš
,

101 .
	gsize
 = 
PAGE_SIZE
,

109 
ssize_t
 
	$»ad_cc_£‰šg_bš
(
fže
 *
fžp
, 
kobjeù
 *
kobj
,

110 
bš_©Œibu‹
 *
bš_©Œ
,

111 *
buf
, 
loff_t
 
pos
, 
size_t
 
couÁ
)

113 
»t
;

114 
hfi1_µÜtd©a
 *
µd
 =

115 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
µÜt_cc_kobj
);

116 
cc_¡©e
 *cc_state;

118 
»t
 = (
Ýa_cÚge¡iÚ_£‰šg_©Œ_shadow
);

120 ià(
pos
 > 
»t
)

121  -
EINVAL
;

122 ià(
couÁ
 > 
»t
 - 
pos
)

123 
couÁ
 = 
»t
 - 
pos
;

125 ià(!
couÁ
)

126  
couÁ
;

128 
	`rcu_»ad_lock
();

129 
cc_¡©e
 = 
	`g‘_cc_¡©e
(
µd
);

130 ià(!
cc_¡©e
) {

131 
	`rcu_»ad_uÆock
();

132  -
EINVAL
;

134 
	`memýy
(
buf
, (*)&
cc_¡©e
->
cÚg_£‰šg
 + 
pos
, 
couÁ
);

135 
	`rcu_»ad_uÆock
();

137  
couÁ
;

138 
	}
}

140 cÚ¡ 
bš_©Œibu‹
 
	gcc_£‰šg_bš_©Œ
 = {

141 .
©Œ
 = {.
Çme
 = "cc_£‰šgs_bš", .
	gmode
 = 0444},

142 .
	g»ad
 = 
»ad_cc_£‰šg_bš
,

143 .
	gsize
 = 
PAGE_SIZE
,

146 
	shfi1_pÜt_©Œ
 {

147 
©Œibu‹
 
	m©Œ
;

148 
ssize_t
 (*
show
)(
	mhfi1_µÜtd©a
 *, *);

149 
ssize_t
 (*
¡Üe
)(
	mhfi1_µÜtd©a
 *, cÚ¡ *, 
	msize_t
);

152 
ssize_t
 
	$cc_´esÿn_show
(
hfi1_µÜtd©a
 *
µd
, *
buf
)

154  
	`¥rštf
(
buf
, "%s\n", 
µd
->
cc_´esÿn
 ? "on" : "off");

155 
	}
}

157 
ssize_t
 
	$cc_´esÿn_¡Üe
(
hfi1_µÜtd©a
 *
µd
, cÚ¡ *
buf
,

158 
size_t
 
couÁ
)

160 ià(!
	`memcmp
(
buf
, "on", 2))

161 
µd
->
cc_´esÿn
 = 
Œue
;

162 ià(!
	`memcmp
(
buf
, "off", 3))

163 
µd
->
cc_´esÿn
 = 
çl£
;

165  
couÁ
;

166 
	}
}

168 
hfi1_pÜt_©Œ
 
	gcc_´esÿn_©Œ
 =

169 
__ATTR
(
cc_´esÿn
, 0600, 
cc_´esÿn_show
, 
cc_´esÿn_¡Üe
);

171 
ssize_t
 
	$cc_©Œ_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

172 *
buf
)

174 
hfi1_pÜt_©Œ
 *
pÜt_©Œ
 =

175 
	`cÚš”_of
(
©Œ
, 
hfi1_pÜt_©Œ
,‡ttr);

176 
hfi1_µÜtd©a
 *
µd
 =

177 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
µÜt_cc_kobj
);

179  
pÜt_©Œ
->
	`show
(
µd
, 
buf
);

180 
	}
}

182 
ssize_t
 
	$cc_©Œ_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

183 cÚ¡ *
buf
, 
size_t
 
couÁ
)

185 
hfi1_pÜt_©Œ
 *
pÜt_©Œ
 =

186 
	`cÚš”_of
(
©Œ
, 
hfi1_pÜt_©Œ
,‡ttr);

187 
hfi1_µÜtd©a
 *
µd
 =

188 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
µÜt_cc_kobj
);

190  
pÜt_©Œ
->
	`¡Üe
(
µd
, 
buf
, 
couÁ
);

191 
	}
}

193 cÚ¡ 
sysfs_Ýs
 
	gpÜt_cc_sysfs_Ýs
 = {

194 .
show
 = 
cc_©Œ_show
,

195 .
	g¡Üe
 = 
cc_©Œ_¡Üe


198 
©Œibu‹
 *
	gpÜt_cc_deçuÉ_©Œibu‹s
[] = {

199 &
cc_´esÿn_©Œ
.
©Œ
,

200 
NULL


203 
kobj_ty³
 
	gpÜt_cc_kty³
 = {

204 .
»Ëa£
 = 
pÜt_»Ëa£
,

205 .
	gsysfs_Ýs
 = &
pÜt_cc_sysfs_Ýs
,

206 .
	gdeçuÉ_©Œs
 = 
pÜt_cc_deçuÉ_©Œibu‹s


210 
	#HFI1_SC2VL_ATTR
(
N
) \

211 
hfi1_sc2vl_©Œ
 
hfi1_sc2vl_©Œ_
##
N
 = { \

212 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
N
), .
mode
 = 0444 }, \

213 .
sc
 = 
N
 \

214 }

	)

216 
	shfi1_sc2vl_©Œ
 {

217 
©Œibu‹
 
	m©Œ
;

218 
	msc
;

221 
HFI1_SC2VL_ATTR
(0);

222 
HFI1_SC2VL_ATTR
(1);

223 
HFI1_SC2VL_ATTR
(2);

224 
HFI1_SC2VL_ATTR
(3);

225 
HFI1_SC2VL_ATTR
(4);

226 
HFI1_SC2VL_ATTR
(5);

227 
HFI1_SC2VL_ATTR
(6);

228 
HFI1_SC2VL_ATTR
(7);

229 
HFI1_SC2VL_ATTR
(8);

230 
HFI1_SC2VL_ATTR
(9);

231 
HFI1_SC2VL_ATTR
(10);

232 
HFI1_SC2VL_ATTR
(11);

233 
HFI1_SC2VL_ATTR
(12);

234 
HFI1_SC2VL_ATTR
(13);

235 
HFI1_SC2VL_ATTR
(14);

236 
HFI1_SC2VL_ATTR
(15);

237 
HFI1_SC2VL_ATTR
(16);

238 
HFI1_SC2VL_ATTR
(17);

239 
HFI1_SC2VL_ATTR
(18);

240 
HFI1_SC2VL_ATTR
(19);

241 
HFI1_SC2VL_ATTR
(20);

242 
HFI1_SC2VL_ATTR
(21);

243 
HFI1_SC2VL_ATTR
(22);

244 
HFI1_SC2VL_ATTR
(23);

245 
HFI1_SC2VL_ATTR
(24);

246 
HFI1_SC2VL_ATTR
(25);

247 
HFI1_SC2VL_ATTR
(26);

248 
HFI1_SC2VL_ATTR
(27);

249 
HFI1_SC2VL_ATTR
(28);

250 
HFI1_SC2VL_ATTR
(29);

251 
HFI1_SC2VL_ATTR
(30);

252 
HFI1_SC2VL_ATTR
(31);

254 
©Œibu‹
 *
	gsc2vl_deçuÉ_©Œibu‹s
[] = {

255 &
hfi1_sc2vl_©Œ_0
.
©Œ
,

256 &
hfi1_sc2vl_©Œ_1
.
©Œ
,

257 &
hfi1_sc2vl_©Œ_2
.
©Œ
,

258 &
hfi1_sc2vl_©Œ_3
.
©Œ
,

259 &
hfi1_sc2vl_©Œ_4
.
©Œ
,

260 &
hfi1_sc2vl_©Œ_5
.
©Œ
,

261 &
hfi1_sc2vl_©Œ_6
.
©Œ
,

262 &
hfi1_sc2vl_©Œ_7
.
©Œ
,

263 &
hfi1_sc2vl_©Œ_8
.
©Œ
,

264 &
hfi1_sc2vl_©Œ_9
.
©Œ
,

265 &
hfi1_sc2vl_©Œ_10
.
©Œ
,

266 &
hfi1_sc2vl_©Œ_11
.
©Œ
,

267 &
hfi1_sc2vl_©Œ_12
.
©Œ
,

268 &
hfi1_sc2vl_©Œ_13
.
©Œ
,

269 &
hfi1_sc2vl_©Œ_14
.
©Œ
,

270 &
hfi1_sc2vl_©Œ_15
.
©Œ
,

271 &
hfi1_sc2vl_©Œ_16
.
©Œ
,

272 &
hfi1_sc2vl_©Œ_17
.
©Œ
,

273 &
hfi1_sc2vl_©Œ_18
.
©Œ
,

274 &
hfi1_sc2vl_©Œ_19
.
©Œ
,

275 &
hfi1_sc2vl_©Œ_20
.
©Œ
,

276 &
hfi1_sc2vl_©Œ_21
.
©Œ
,

277 &
hfi1_sc2vl_©Œ_22
.
©Œ
,

278 &
hfi1_sc2vl_©Œ_23
.
©Œ
,

279 &
hfi1_sc2vl_©Œ_24
.
©Œ
,

280 &
hfi1_sc2vl_©Œ_25
.
©Œ
,

281 &
hfi1_sc2vl_©Œ_26
.
©Œ
,

282 &
hfi1_sc2vl_©Œ_27
.
©Œ
,

283 &
hfi1_sc2vl_©Œ_28
.
©Œ
,

284 &
hfi1_sc2vl_©Œ_29
.
©Œ
,

285 &
hfi1_sc2vl_©Œ_30
.
©Œ
,

286 &
hfi1_sc2vl_©Œ_31
.
©Œ
,

287 
NULL


290 
ssize_t
 
	$sc2vl_©Œ_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

291 *
buf
)

293 
hfi1_sc2vl_©Œ
 *
§‰r
 =

294 
	`cÚš”_of
(
©Œ
, 
hfi1_sc2vl_©Œ
,‡ttr);

295 
hfi1_µÜtd©a
 *
µd
 =

296 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
sc2vl_kobj
);

297 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

299  
	`¥rštf
(
buf
, "%u\n", *((
u8
 *)
dd
->
sc2vl
 + 
§‰r
->
sc
));

300 
	}
}

302 cÚ¡ 
sysfs_Ýs
 
	ghfi1_sc2vl_Ýs
 = {

303 .
show
 = 
sc2vl_©Œ_show
,

306 
kobj_ty³
 
	ghfi1_sc2vl_kty³
 = {

307 .
»Ëa£
 = 
pÜt_»Ëa£
,

308 .
	gsysfs_Ýs
 = &
hfi1_sc2vl_Ýs
,

309 .
	gdeçuÉ_©Œs
 = 
sc2vl_deçuÉ_©Œibu‹s


315 
	#HFI1_SL2SC_ATTR
(
N
) \

316 
hfi1_¦2sc_©Œ
 
hfi1_¦2sc_©Œ_
##
N
 = { \

317 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
N
), .
mode
 = 0444 }, \

318 .
¦
 = 
N
 \

319 }

	)

321 
	shfi1_¦2sc_©Œ
 {

322 
©Œibu‹
 
	m©Œ
;

323 
	m¦
;

326 
HFI1_SL2SC_ATTR
(0);

327 
HFI1_SL2SC_ATTR
(1);

328 
HFI1_SL2SC_ATTR
(2);

329 
HFI1_SL2SC_ATTR
(3);

330 
HFI1_SL2SC_ATTR
(4);

331 
HFI1_SL2SC_ATTR
(5);

332 
HFI1_SL2SC_ATTR
(6);

333 
HFI1_SL2SC_ATTR
(7);

334 
HFI1_SL2SC_ATTR
(8);

335 
HFI1_SL2SC_ATTR
(9);

336 
HFI1_SL2SC_ATTR
(10);

337 
HFI1_SL2SC_ATTR
(11);

338 
HFI1_SL2SC_ATTR
(12);

339 
HFI1_SL2SC_ATTR
(13);

340 
HFI1_SL2SC_ATTR
(14);

341 
HFI1_SL2SC_ATTR
(15);

342 
HFI1_SL2SC_ATTR
(16);

343 
HFI1_SL2SC_ATTR
(17);

344 
HFI1_SL2SC_ATTR
(18);

345 
HFI1_SL2SC_ATTR
(19);

346 
HFI1_SL2SC_ATTR
(20);

347 
HFI1_SL2SC_ATTR
(21);

348 
HFI1_SL2SC_ATTR
(22);

349 
HFI1_SL2SC_ATTR
(23);

350 
HFI1_SL2SC_ATTR
(24);

351 
HFI1_SL2SC_ATTR
(25);

352 
HFI1_SL2SC_ATTR
(26);

353 
HFI1_SL2SC_ATTR
(27);

354 
HFI1_SL2SC_ATTR
(28);

355 
HFI1_SL2SC_ATTR
(29);

356 
HFI1_SL2SC_ATTR
(30);

357 
HFI1_SL2SC_ATTR
(31);

359 
©Œibu‹
 *
	g¦2sc_deçuÉ_©Œibu‹s
[] = {

360 &
hfi1_¦2sc_©Œ_0
.
©Œ
,

361 &
hfi1_¦2sc_©Œ_1
.
©Œ
,

362 &
hfi1_¦2sc_©Œ_2
.
©Œ
,

363 &
hfi1_¦2sc_©Œ_3
.
©Œ
,

364 &
hfi1_¦2sc_©Œ_4
.
©Œ
,

365 &
hfi1_¦2sc_©Œ_5
.
©Œ
,

366 &
hfi1_¦2sc_©Œ_6
.
©Œ
,

367 &
hfi1_¦2sc_©Œ_7
.
©Œ
,

368 &
hfi1_¦2sc_©Œ_8
.
©Œ
,

369 &
hfi1_¦2sc_©Œ_9
.
©Œ
,

370 &
hfi1_¦2sc_©Œ_10
.
©Œ
,

371 &
hfi1_¦2sc_©Œ_11
.
©Œ
,

372 &
hfi1_¦2sc_©Œ_12
.
©Œ
,

373 &
hfi1_¦2sc_©Œ_13
.
©Œ
,

374 &
hfi1_¦2sc_©Œ_14
.
©Œ
,

375 &
hfi1_¦2sc_©Œ_15
.
©Œ
,

376 &
hfi1_¦2sc_©Œ_16
.
©Œ
,

377 &
hfi1_¦2sc_©Œ_17
.
©Œ
,

378 &
hfi1_¦2sc_©Œ_18
.
©Œ
,

379 &
hfi1_¦2sc_©Œ_19
.
©Œ
,

380 &
hfi1_¦2sc_©Œ_20
.
©Œ
,

381 &
hfi1_¦2sc_©Œ_21
.
©Œ
,

382 &
hfi1_¦2sc_©Œ_22
.
©Œ
,

383 &
hfi1_¦2sc_©Œ_23
.
©Œ
,

384 &
hfi1_¦2sc_©Œ_24
.
©Œ
,

385 &
hfi1_¦2sc_©Œ_25
.
©Œ
,

386 &
hfi1_¦2sc_©Œ_26
.
©Œ
,

387 &
hfi1_¦2sc_©Œ_27
.
©Œ
,

388 &
hfi1_¦2sc_©Œ_28
.
©Œ
,

389 &
hfi1_¦2sc_©Œ_29
.
©Œ
,

390 &
hfi1_¦2sc_©Œ_30
.
©Œ
,

391 &
hfi1_¦2sc_©Œ_31
.
©Œ
,

392 
NULL


395 
ssize_t
 
	$¦2sc_©Œ_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

396 *
buf
)

398 
hfi1_¦2sc_©Œ
 *
§‰r
 =

399 
	`cÚš”_of
(
©Œ
, 
hfi1_¦2sc_©Œ
,‡ttr);

400 
hfi1_µÜtd©a
 *
µd
 =

401 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
¦2sc_kobj
);

402 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

404  
	`¥rštf
(
buf
, "%u\n", 
ibp
->
¦_to_sc
[
§‰r
->
¦
]);

405 
	}
}

407 cÚ¡ 
sysfs_Ýs
 
	ghfi1_¦2sc_Ýs
 = {

408 .
show
 = 
¦2sc_©Œ_show
,

411 
kobj_ty³
 
	ghfi1_¦2sc_kty³
 = {

412 .
»Ëa£
 = 
pÜt_»Ëa£
,

413 .
	gsysfs_Ýs
 = &
hfi1_¦2sc_Ýs
,

414 .
	gdeçuÉ_©Œs
 = 
¦2sc_deçuÉ_©Œibu‹s


421 
	#HFI1_VL2MTU_ATTR
(
N
) \

422 
hfi1_vl2mtu_©Œ
 
hfi1_vl2mtu_©Œ_
##
N
 = { \

423 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
N
), .
mode
 = 0444 }, \

424 .
vl
 = 
N
 \

425 }

	)

427 
	shfi1_vl2mtu_©Œ
 {

428 
©Œibu‹
 
	m©Œ
;

429 
	mvl
;

432 
HFI1_VL2MTU_ATTR
(0);

433 
HFI1_VL2MTU_ATTR
(1);

434 
HFI1_VL2MTU_ATTR
(2);

435 
HFI1_VL2MTU_ATTR
(3);

436 
HFI1_VL2MTU_ATTR
(4);

437 
HFI1_VL2MTU_ATTR
(5);

438 
HFI1_VL2MTU_ATTR
(6);

439 
HFI1_VL2MTU_ATTR
(7);

440 
HFI1_VL2MTU_ATTR
(8);

441 
HFI1_VL2MTU_ATTR
(9);

442 
HFI1_VL2MTU_ATTR
(10);

443 
HFI1_VL2MTU_ATTR
(11);

444 
HFI1_VL2MTU_ATTR
(12);

445 
HFI1_VL2MTU_ATTR
(13);

446 
HFI1_VL2MTU_ATTR
(14);

447 
HFI1_VL2MTU_ATTR
(15);

449 
©Œibu‹
 *
	gvl2mtu_deçuÉ_©Œibu‹s
[] = {

450 &
hfi1_vl2mtu_©Œ_0
.
©Œ
,

451 &
hfi1_vl2mtu_©Œ_1
.
©Œ
,

452 &
hfi1_vl2mtu_©Œ_2
.
©Œ
,

453 &
hfi1_vl2mtu_©Œ_3
.
©Œ
,

454 &
hfi1_vl2mtu_©Œ_4
.
©Œ
,

455 &
hfi1_vl2mtu_©Œ_5
.
©Œ
,

456 &
hfi1_vl2mtu_©Œ_6
.
©Œ
,

457 &
hfi1_vl2mtu_©Œ_7
.
©Œ
,

458 &
hfi1_vl2mtu_©Œ_8
.
©Œ
,

459 &
hfi1_vl2mtu_©Œ_9
.
©Œ
,

460 &
hfi1_vl2mtu_©Œ_10
.
©Œ
,

461 &
hfi1_vl2mtu_©Œ_11
.
©Œ
,

462 &
hfi1_vl2mtu_©Œ_12
.
©Œ
,

463 &
hfi1_vl2mtu_©Œ_13
.
©Œ
,

464 &
hfi1_vl2mtu_©Œ_14
.
©Œ
,

465 &
hfi1_vl2mtu_©Œ_15
.
©Œ
,

466 
NULL


469 
ssize_t
 
	$vl2mtu_©Œ_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

470 *
buf
)

472 
hfi1_vl2mtu_©Œ
 *
vÏ‰r
 =

473 
	`cÚš”_of
(
©Œ
, 
hfi1_vl2mtu_©Œ
,‡ttr);

474 
hfi1_µÜtd©a
 *
µd
 =

475 
	`cÚš”_of
(
kobj
, 
hfi1_µÜtd©a
, 
vl2mtu_kobj
);

476 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

478  
	`¥rštf
(
buf
, "%u\n", 
dd
->
vld
[
vÏ‰r
->
vl
].
mtu
);

479 
	}
}

481 cÚ¡ 
sysfs_Ýs
 
	ghfi1_vl2mtu_Ýs
 = {

482 .
show
 = 
vl2mtu_©Œ_show
,

485 
kobj_ty³
 
	ghfi1_vl2mtu_kty³
 = {

486 .
»Ëa£
 = 
pÜt_»Ëa£
,

487 .
	gsysfs_Ýs
 = &
hfi1_vl2mtu_Ýs
,

488 .
	gdeçuÉ_©Œs
 = 
vl2mtu_deçuÉ_©Œibu‹s


497 
ssize_t
 
	$hw_»v_show
(
deviû
 *deviû, 
deviû_©Œibu‹
 *
©Œ
,

498 *
buf
)

500 
hfi1_ibdev
 *
dev
 =

501 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

503  
	`¥rštf
(
buf
, "%x\n", 
	`dd_äom_dev
(
dev
)->
mš»v
);

504 
	}
}

505 
DEVICE_ATTR_RO
(
hw_»v
);

507 
ssize_t
 
	$bßrd_id_show
(
deviû
 *device,

508 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

510 
hfi1_ibdev
 *
dev
 =

511 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

512 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

513 
»t
;

515 ià(!
dd
->
bßrdÇme
)

516 
»t
 = -
EINVAL
;

518 
»t
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
dd
->
bßrdÇme
);

519  
»t
;

520 
	}
}

521 
DEVICE_ATTR_RO
(
bßrd_id
);

523 
ssize_t
 
	$bßrdv”siÚ_show
(
deviû
 *device,

524 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

526 
hfi1_ibdev
 *
dev
 =

527 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

528 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

531  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s", 
dd
->
bßrdv”siÚ
);

532 
	}
}

533 
DEVICE_ATTR_RO
(
bßrdv”siÚ
);

535 
ssize_t
 
	$nùxts_show
(
deviû
 *device,

536 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

538 
hfi1_ibdev
 *
dev
 =

539 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

540 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

548  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

549 
	`mš
(
dd
->
num_u£r_cÚ‹xts
,

550 (
u32
)
dd
->
sc_sizes
[
SC_USER
].
couÁ
));

551 
	}
}

552 
DEVICE_ATTR_RO
(
nùxts
);

554 
ssize_t
 
	$nä“ùxts_show
(
deviû
 *device,

555 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

557 
hfi1_ibdev
 *
dev
 =

558 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

559 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

562  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n", 
dd
->
ä“ùxts
);

563 
	}
}

564 
DEVICE_ATTR_RO
(
nä“ùxts
);

566 
ssize_t
 
	$£rŸl_show
(
deviû
 *device,

567 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

569 
hfi1_ibdev
 *
dev
 =

570 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

571 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

573  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s", 
dd
->
£rŸl
);

574 
	}
}

575 
DEVICE_ATTR_RO
(
£rŸl
);

577 
ssize_t
 
	$ch_»£t_¡Üe
(
deviû
 *device,

578 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

579 
size_t
 
couÁ
)

581 
hfi1_ibdev
 *
dev
 =

582 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

583 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

584 
»t
;

586 ià(
couÁ
 < 5 || 
	`memcmp
(
buf
, "»£t", 5è|| !
dd
->
dŸg_þ›Á
) {

587 
»t
 = -
EINVAL
;

588 
baž
;

591 
»t
 = 
	`hfi1_»£t_deviû
(
dd
->
un™
);

592 
baž
:

593  
»t
 < 0 ?„‘ : 
couÁ
;

594 
	}
}

595 
DEVICE_ATTR_WO
(
ch_»£t
);

601 
	#‹mp2¡r
(
‹mp
, 
buf
, 
size
, 
idx
) \

602 
	`sú´štf
((
buf
è+ (
idx
), (
size
) - (idx), "%u.%02u ", \

603 ((
‹mp
è>> 2), (Ñempè& 0x3è* 25)

	)

608 
ssize_t
 
	$‹mp£n£_show
(
deviû
 *device,

609 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

611 
hfi1_ibdev
 *
dev
 =

612 
	`rdma_deviû_to_drv_deviû
(
deviû
, 
hfi1_ibdev
, 
rdi
.
ibdev
);

613 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

614 
hfi1_‹mp
 
‹mp
;

615 
»t
;

617 
»t
 = 
	`hfi1_‹mp£n£_rd
(
dd
, &
‹mp
);

618 ià(!
»t
) {

619 
idx
 = 0;

621 
idx
 +ð
	`‹mp2¡r
(
‹mp
.
cu¼
, 
buf
, 
PAGE_SIZE
, idx);

622 
idx
 +ð
	`‹mp2¡r
(
‹mp
.
lo_lim
, 
buf
, 
PAGE_SIZE
, idx);

623 
idx
 +ð
	`‹mp2¡r
(
‹mp
.
hi_lim
, 
buf
, 
PAGE_SIZE
, idx);

624 
idx
 +ð
	`‹mp2¡r
(
‹mp
.
ü™_lim
, 
buf
, 
PAGE_SIZE
, idx);

625 
idx
 +ð
	`sú´štf
(
buf
 + idx, 
PAGE_SIZE
 - idx,

626 "%u %u %u\n", 
‹mp
.
Œigg”s
 & 0x1,

627 
‹mp
.
Œigg”s
 & 0x2,emp.triggers & 0x4);

628 
»t
 = 
idx
;

630  
»t
;

631 
	}
}

632 
DEVICE_ATTR_RO
(
‹mp£n£
);

640 
©Œibu‹
 *
	ghfi1_©Œibu‹s
[] = {

641 &
dev_©Œ_hw_»v
.
©Œ
,

642 &
dev_©Œ_bßrd_id
.
©Œ
,

643 &
dev_©Œ_nùxts
.
©Œ
,

644 &
dev_©Œ_nä“ùxts
.
©Œ
,

645 &
dev_©Œ_£rŸl
.
©Œ
,

646 &
dev_©Œ_bßrdv”siÚ
.
©Œ
,

647 &
dev_©Œ_‹mp£n£
.
©Œ
,

648 &
dev_©Œ_ch_»£t
.
©Œ
,

649 
NULL
,

652 cÚ¡ 
©Œibu‹_group
 
	gib_hfi1_©Œ_group
 = {

653 .
©Œs
 = 
hfi1_©Œibu‹s
,

656 
	$hfi1_ü—‹_pÜt_fžes
(
ib_deviû
 *
ibdev
, 
u8
 
pÜt_num
,

657 
kobjeù
 *
kobj
)

659 
hfi1_µÜtd©a
 *
µd
;

660 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

661 
»t
;

663 ià(!
pÜt_num
 ||…Üt_num > 
dd
->
num_µÜts
) {

664 
	`dd_dev_”r
(
dd
,

666 
pÜt_num
);

667  -
ENODEV
;

669 
µd
 = &
dd
->
µÜt
[
pÜt_num
 - 1];

671 
»t
 = 
	`kobjeù_š™_ªd_add
(&
µd
->
sc2vl_kobj
, &
hfi1_sc2vl_kty³
, 
kobj
,

673 ià(
»t
) {

674 
	`dd_dev_”r
(
dd
,

676 
»t
, 
pÜt_num
);

681 
baž_sc2vl
;

683 
	`kobjeù_uev’t
(&
µd
->
sc2vl_kobj
, 
KOBJ_ADD
);

685 
»t
 = 
	`kobjeù_š™_ªd_add
(&
µd
->
¦2sc_kobj
, &
hfi1_¦2sc_kty³
, 
kobj
,

687 ià(
»t
) {

688 
	`dd_dev_”r
(
dd
,

690 
»t
, 
pÜt_num
);

691 
baž_¦2sc
;

693 
	`kobjeù_uev’t
(&
µd
->
¦2sc_kobj
, 
KOBJ_ADD
);

695 
»t
 = 
	`kobjeù_š™_ªd_add
(&
µd
->
vl2mtu_kobj
, &
hfi1_vl2mtu_kty³
, 
kobj
,

697 ià(
»t
) {

698 
	`dd_dev_”r
(
dd
,

700 
»t
, 
pÜt_num
);

701 
baž_vl2mtu
;

703 
	`kobjeù_uev’t
(&
µd
->
vl2mtu_kobj
, 
KOBJ_ADD
);

705 
»t
 = 
	`kobjeù_š™_ªd_add
(&
µd
->
µÜt_cc_kobj
, &
pÜt_cc_kty³
,

706 
kobj
, "CCMgtA");

707 ià(
»t
) {

708 
	`dd_dev_”r
(
dd
,

710 
»t
, 
pÜt_num
);

711 
baž_cc
;

714 
	`kobjeù_uev’t
(&
µd
->
µÜt_cc_kobj
, 
KOBJ_ADD
);

716 
»t
 = 
	`sysfs_ü—‹_bš_fže
(&
µd
->
µÜt_cc_kobj
, &
cc_£‰šg_bš_©Œ
);

717 ià(
»t
) {

718 
	`dd_dev_”r
(
dd
,

720 
»t
, 
pÜt_num
);

721 
baž_cc
;

724 
»t
 = 
	`sysfs_ü—‹_bš_fže
(&
µd
->
µÜt_cc_kobj
, &
cc_bË_bš_©Œ
);

725 ià(
»t
) {

726 
	`dd_dev_”r
(
dd
,

728 
»t
, 
pÜt_num
);

729 
baž_cc_’Œy_bš
;

732 
	`dd_dev_šfo
(
dd
,

734 
pÜt_num
);

738 
baž_cc_’Œy_bš
:

739 
	`sysfs_»move_bš_fže
(&
µd
->
µÜt_cc_kobj
,

740 &
cc_£‰šg_bš_©Œ
);

741 
baž_cc
:

742 
	`kobjeù_put
(&
µd
->
µÜt_cc_kobj
);

743 
baž_vl2mtu
:

744 
	`kobjeù_put
(&
µd
->
vl2mtu_kobj
);

745 
baž_¦2sc
:

746 
	`kobjeù_put
(&
µd
->
¦2sc_kobj
);

747 
baž_sc2vl
:

748 
	`kobjeù_put
(&
µd
->
sc2vl_kobj
);

749  
»t
;

750 
	}
}

752 
	ssde_©Œibu‹
 {

753 
©Œibu‹
 
	m©Œ
;

754 
ssize_t
 (*
show
)(
sdma_’gše
 *
	msde
, *
	mbuf
);

755 
ssize_t
 (*
¡Üe
)(
sdma_’gše
 *
	msde
, cÚ¡ *
	mbuf
, 
size_t
 
	mút
);

758 
ssize_t
 
	$sde_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

760 
sde_©Œibu‹
 *
sde_©Œ
 =

761 
	`cÚš”_of
(
©Œ
, 
sde_©Œibu‹
,‡ttr);

762 
sdma_’gše
 *
sde
 =

763 
	`cÚš”_of
(
kobj
, 
sdma_’gše
, kobj);

765 ià(!
sde_©Œ
->
show
)

766  -
EINVAL
;

768  
sde_©Œ
->
	`show
(
sde
, 
buf
);

769 
	}
}

771 
ssize_t
 
	$sde_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

772 cÚ¡ *
buf
, 
size_t
 
couÁ
)

774 
sde_©Œibu‹
 *
sde_©Œ
 =

775 
	`cÚš”_of
(
©Œ
, 
sde_©Œibu‹
,‡ttr);

776 
sdma_’gše
 *
sde
 =

777 
	`cÚš”_of
(
kobj
, 
sdma_’gše
, kobj);

779 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

780  -
EPERM
;

782 ià(!
sde_©Œ
->
¡Üe
)

783  -
EINVAL
;

785  
sde_©Œ
->
	`¡Üe
(
sde
, 
buf
, 
couÁ
);

786 
	}
}

788 cÚ¡ 
sysfs_Ýs
 
	gsde_sysfs_Ýs
 = {

789 .
show
 = 
sde_show
,

790 .
	g¡Üe
 = 
sde_¡Üe
,

793 
kobj_ty³
 
	gsde_kty³
 = {

794 .
sysfs_Ýs
 = &
sde_sysfs_Ýs
,

797 
	#SDE_ATTR
(
_Çme
, 
_mode
, 
_show
, 
_¡Üe
) \

798 
sde_©Œibu‹
 
sde_©Œ_
##
_Çme
 = \

799 
	`__ATTR
(
_Çme
, 
_mode
, 
_show
, 
_¡Üe
)

	)

801 
ssize_t
 
	$sde_show_ýu_to_sde_m­
(
sdma_’gše
 *
sde
, *
buf
)

803  
	`sdma_g‘_ýu_to_sde_m­
(
sde
, 
buf
);

804 
	}
}

806 
ssize_t
 
	$sde_¡Üe_ýu_to_sde_m­
(
sdma_’gše
 *
sde
,

807 cÚ¡ *
buf
, 
size_t
 
couÁ
)

809  
	`sdma_£t_ýu_to_sde_m­
(
sde
, 
buf
, 
couÁ
);

810 
	}
}

812 
ssize_t
 
	$sde_show_vl
(
sdma_’gše
 *
sde
, *
buf
)

814 
vl
;

816 
vl
 = 
	`sdma_’gše_g‘_vl
(
sde
);

817 ià(
vl
 < 0)

818  
vl
;

820  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n", 
vl
);

821 
	}
}

823 
SDE_ATTR
(
ýu_li¡
, 
S_IWUSR
 | 
S_IRUGO
,

824 
sde_show_ýu_to_sde_m­
,

825 
sde_¡Üe_ýu_to_sde_m­
);

826 
SDE_ATTR
(
vl
, 
S_IRUGO
, 
sde_show_vl
, 
NULL
);

828 
sde_©Œibu‹
 *
	gsde_©Œibs
[] = {

829 &
sde_©Œ_ýu_li¡
,

830 &
sde_©Œ_vl


836 
	$hfi1_v”bs_»gi¡”_sysfs
(
hfi1_devd©a
 *
dd
)

838 
ib_deviû
 *
dev
 = &
dd
->
v”bs_dev
.
rdi
.
ibdev
;

839 
deviû
 *
þass_dev
 = &
dev
->dev;

840 
i
, 
j
, 
»t
;

841 #iâdeà
HAVE_RDMA_SET_DEVICE_SYSFS_GROUP


842 
k
;

844 
k
 = 0; 
hfi1_©Œibu‹s
[k]; ++k) {

845 
deviû_©Œibu‹
 *
d
 =

846 
	`cÚš”_of
(
hfi1_©Œibu‹s
[
k
],

847 
deviû_©Œibu‹
, 
©Œ
);

849 
»t
 = 
	`deviû_ü—‹_fže
(&
dev
->dev, 
d
);

850 ià(
»t
)

851 
baž_©Œ
;

855 
i
 = 0; i < 
dd
->
num_sdma
; i++) {

856 
»t
 = 
	`kobjeù_š™_ªd_add
(&
dd
->
³r_sdma
[
i
].
kobj
,

857 &
sde_kty³
, &
þass_dev
->
kobj
,

858 "sdma%d", 
i
);

859 ià(
»t
)

860 
baž
;

862 
j
 = 0; j < 
	`ARRAY_SIZE
(
sde_©Œibs
); j++) {

863 
»t
 = 
	`sysfs_ü—‹_fže
(&
dd
->
³r_sdma
[
i
].
kobj
,

864 &
sde_©Œibs
[
j
]->
©Œ
);

865 ià(
»t
)

866 
baž
;

871 
baž
:

877 ; 
i
 >= 0; i--)

878 
	`kobjeù_put
(&
dd
->
³r_sdma
[
i
].
kobj
);

879 #iâdeà
HAVE_RDMA_SET_DEVICE_SYSFS_GROUP


880 
baž_©Œ
:

881 
i
 = 0; i < 
k
; ++i) {

882 
deviû_©Œibu‹
 *
d
 =

883 
	`cÚš”_of
(
hfi1_©Œibu‹s
[
i
],

884 
deviû_©Œibu‹
, 
©Œ
);

886 
	`deviû_»move_fže
(&
dev
->dev, 
d
);

889  
»t
;

890 
	}
}

895 
	$hfi1_v”bs_uÄegi¡”_sysfs
(
hfi1_devd©a
 *
dd
)

897 
hfi1_µÜtd©a
 *
µd
;

898 
i
;

901 
i
 = 0; i < 
dd
->
num_sdma
; i++)

902 
	`kobjeù_put
(&
dd
->
³r_sdma
[
i
].
kobj
);

904 
i
 = 0; i < 
dd
->
num_µÜts
; i++) {

905 
µd
 = &
dd
->
µÜt
[
i
];

907 
	`sysfs_»move_bš_fže
(&
µd
->
µÜt_cc_kobj
,

908 &
cc_£‰šg_bš_©Œ
);

909 
	`sysfs_»move_bš_fže
(&
µd
->
µÜt_cc_kobj
,

910 &
cc_bË_bš_©Œ
);

911 
	`kobjeù_put
(&
µd
->
µÜt_cc_kobj
);

912 
	`kobjeù_put
(&
µd
->
vl2mtu_kobj
);

913 
	`kobjeù_put
(&
µd
->
¦2sc_kobj
);

914 
	`kobjeù_put
(&
µd
->
sc2vl_kobj
);

916 
	}
}

	@tid_rdma.c

48 
	~"hfi.h
"

49 
	~"qp.h
"

50 
	~"rc.h
"

51 
	~"v”bs.h
"

52 
	~"tid_rdma.h
"

53 
	~"exp_rcv.h
"

54 
	~"Œaû.h
"

71 
	#RCV_TID_FLOW_TABLE_CTRL_FLOW_VALID_SMASK
 
	`BIT_ULL
(32)

	)

72 
	#RCV_TID_FLOW_TABLE_CTRL_HDR_SUPP_EN_SMASK
 
	`BIT_ULL
(33)

	)

73 
	#RCV_TID_FLOW_TABLE_CTRL_KEEP_AFTER_SEQ_ERR_SMASK
 
	`BIT_ULL
(34)

	)

74 
	#RCV_TID_FLOW_TABLE_CTRL_KEEP_ON_GEN_ERR_SMASK
 
	`BIT_ULL
(35)

	)

75 
	#RCV_TID_FLOW_TABLE_STATUS_SEQ_MISMATCH_SMASK
 
	`BIT_ULL
(37)

	)

76 
	#RCV_TID_FLOW_TABLE_STATUS_GEN_MISMATCH_SMASK
 
	`BIT_ULL
(38)

	)

79 
	#MAX_TID_FLOW_PSN
 
	`BIT
(
HFI1_KDETH_BTH_SEQ_SHIFT
)

	)

81 
	#GENERATION_MASK
 0xFFFFF

	)

83 
u32
 
	$mask_g’”©iÚ
(
u32
 
a
)

85  
a
 & 
GENERATION_MASK
;

86 
	}
}

89 
	#KERN_GENERATION_RESERVED
 
	`mask_g’”©iÚ
(
U32_MAX
)

	)

95 
	#TID_RDMA_JKEY
 32

	)

96 
	#HFI1_KERNEL_MIN_JKEY
 
HFI1_ADMIN_JKEY_RANGE


	)

97 
	#HFI1_KERNEL_MAX_JKEY
 (2 * 
HFI1_ADMIN_JKEY_RANGE
 - 1)

	)

100 
	#TID_RDMA_MAX_READ_SEGS_PER_REQ
 6

	)

101 
	#TID_RDMA_MAX_WRITE_SEGS_PER_REQ
 4

	)

102 
	#MAX_REQ
 
	`max_t
(
u16
, 
TID_RDMA_MAX_READ_SEGS_PER_REQ
, \

103 
TID_RDMA_MAX_WRITE_SEGS_PER_REQ
)

	)

104 
	#MAX_FLOWS
 
	`roundup_pow_of_two
(
MAX_REQ
 + 1)

	)

106 
	#MAX_EXPECTED_PAGES
 (
MAX_EXPECTED_BUFFER
 / 
PAGE_SIZE
)

	)

108 
	#TID_RDMA_DESTQP_FLOW_SHIFT
 11

	)

109 
	#TID_RDMA_DESTQP_FLOW_MASK
 0x1f

	)

111 
	#TID_OPFN_QP_CTXT_MASK
 0xff

	)

112 
	#TID_OPFN_QP_CTXT_SHIFT
 56

	)

113 
	#TID_OPFN_QP_KDETH_MASK
 0xff

	)

114 
	#TID_OPFN_QP_KDETH_SHIFT
 48

	)

115 
	#TID_OPFN_MAX_LEN_MASK
 0x7ff

	)

116 
	#TID_OPFN_MAX_LEN_SHIFT
 37

	)

117 
	#TID_OPFN_TIMEOUT_MASK
 0x1f

	)

118 
	#TID_OPFN_TIMEOUT_SHIFT
 32

	)

119 
	#TID_OPFN_RESERVED_MASK
 0x3f

	)

120 
	#TID_OPFN_RESERVED_SHIFT
 26

	)

121 
	#TID_OPFN_URG_MASK
 0x1

	)

122 
	#TID_OPFN_URG_SHIFT
 25

	)

123 
	#TID_OPFN_VER_MASK
 0x7

	)

124 
	#TID_OPFN_VER_SHIFT
 22

	)

125 
	#TID_OPFN_JKEY_MASK
 0x3f

	)

126 
	#TID_OPFN_JKEY_SHIFT
 16

	)

127 
	#TID_OPFN_MAX_READ_MASK
 0x3f

	)

128 
	#TID_OPFN_MAX_READ_SHIFT
 10

	)

129 
	#TID_OPFN_MAX_WRITE_MASK
 0x3f

	)

130 
	#TID_OPFN_MAX_WRITE_SHIFT
 4

	)

151 
	#KDETH_INVALID_PSN
 0x80000000

	)

153 
tid_rdma_Œigg”_»sume
(
wÜk_¡ruù
 *
wÜk
);

154 
hfi1_k”n_exp_rcv_ä“_æows
(
tid_rdma_»que¡
 *
»q
);

155 
hfi1_k”n_exp_rcv_®loc_æows
(
tid_rdma_»que¡
 *
»q
,

156 
gå_t
 
gå
);

157 
hfi1_š™_Œdma_»q
(
rvt_qp
 *
qp
,

158 
tid_rdma_»que¡
 *
»q
);

159 
hfi1_tid_wr™e_®loc_»sourûs
(
rvt_qp
 *
qp
, 
boÞ
 
šŒ_ùx
);

160 
hfi1_tid_timeout
(
tim”_li¡
 *
t
);

161 
hfi1_add_tid_»­_tim”
(
rvt_qp
 *
qp
);

162 
hfi1_mod_tid_»­_tim”
(
rvt_qp
 *
qp
);

163 
hfi1_mod_tid_»Œy_tim”
(
rvt_qp
 *
qp
);

164 
hfi1_¡Ý_tid_»Œy_tim”
(
rvt_qp
 *
qp
);

165 
hfi1_tid_»Œy_timeout
(
tim”_li¡
 *
t
);

166 
make_tid_rdma_ack
(
rvt_qp
 *
qp
,

167 
ib_Ùh”_h—d”s
 *
ohdr
,

168 
hfi1_pkt_¡©e
 *
ps
);

169 
hfi1_do_tid_£nd
(
rvt_qp
 *
qp
);

170 
u32
 
»ad_r_Ãxt_p¢
(
hfi1_devd©a
 *
dd
, 
u8
 
ùxt
, u8 
fidx
);

171 
tid_rdma_rcv_”r
(
hfi1_·ck‘
 *
·ck‘
,

172 
ib_Ùh”_h—d”s
 *
ohdr
,

173 
rvt_qp
 *
qp
, 
u32
 
p¢
, 
diff
, 
boÞ
 
ãú
);

174 
upd©e_r_Ãxt_p¢_ãú
(
hfi1_·ck‘
 *
·ck‘
,

175 
hfi1_qp_´iv
 *
´iv
,

176 
hfi1_ùxtd©a
 *
rcd
,

177 
tid_rdma_æow
 *
æow
,

178 
boÞ
 
ãú
);

180 
	$qp_tid_wqe_´št
(
£q_fže
 *
s
, cÚ¡ *
h—d”
,

181 
rvt_qp
 *
qp
, 
u32
 
i
)

183 
rvt_swqe
 *
wqe
;

184 
tid_rdma_»que¡
 *
»q
;

186 ià(
i
 !ð
HFI1_QP_WQE_INVALID
) {

187 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

188 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

189 
	`£q_´štf
(
s
,

191 
h—d”
, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
, wqe->
Í¢
,

192 
»q
->
¡©e
,„eq->
tÙ®_£gs
,„eq->
cur_£g
,

193 
»q
->
comp_£g
,„eq->
ack_£g
,„eq->
£tup_h—d
,

194 
»q
->
þ—r_ž
,„eq->
acked_ž
);

196 
	}
}

198 
	$qp_tid_ack_´št
(
£q_fže
 *
s
, cÚ¡ *
h—d”
,

199 
rvt_qp
 *
qp
, 
u32
 
i
)

201 
rvt_ack_’Œy
 *
e
;

202 
tid_rdma_»que¡
 *
»q
;

204 ià(
i
 !ð
HFI1_QP_WQE_INVALID
) {

205 
e
 = &
qp
->
s_ack_queue
[
i
];

206 
»q
 = 
	`ack_to_tid_»q
(
e
);

207 
	`£q_´štf
(
s
,

209 
h—d”
, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
, 
»q
->
¡©e
,

210 
»q
->
tÙ®_£gs
,„eq->
cur_£g
,„eq->
comp_£g
,

211 
»q
->
ack_£g
,„eq->
£tup_h—d
,„eq->
þ—r_ž
,

212 
»q
->
acked_ž
);

214 
	}
}

216 
	$hfi1_qp_tid_´št
(
£q_fže
 *
s
, 
rvt_qp
 *
qp
)

218 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

220 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
 && 
	`HFI1_CAP_IS_KSET
(
TID_RDMA
)) {

221 
	`£q_´štf
(
s
,

223 
´iv
->
s_æags
,

224 
´iv
->
s_¡©e
,

225 
´iv
->
s_tid_h—d
,

226 
´iv
->
s_tid_cur
,

227 
´iv
->
s_tid_ž
,

228 
´iv
->
r_tid_h—d
,

229 
´iv
->
r_tid_ž
,

230 
´iv
->
r_tid_ack
);

231 
	`qp_tid_wqe_´št
(
s
, "s_tid_h—d", 
qp
, 
´iv
->
s_tid_h—d
);

232 
	`qp_tid_wqe_´št
(
s
, "s_tid_cur", 
qp
, 
´iv
->
s_tid_cur
);

233 
	`qp_tid_wqe_´št
(
s
, "s_tid_ž", 
qp
, 
´iv
->
s_tid_ž
);

234 
	`qp_tid_ack_´št
(
s
, "r_tid_h—d", 
qp
, 
´iv
->
r_tid_h—d
);

235 
	`qp_tid_ack_´št
(
s
, "r_tid_ž", 
qp
, 
´iv
->
r_tid_ž
);

236 
	`qp_tid_ack_´št
(
s
, "r_tid_ack", 
qp
, 
´iv
->
r_tid_ack
);

238 
	}
}

240 
	$v®id©e_r_tid_ack
(
hfi1_qp_´iv
 *
´iv
)

242 ià(
´iv
->
r_tid_ack
 =ð
HFI1_QP_WQE_INVALID
)

243 
´iv
->
r_tid_ack
 =…riv->
r_tid_ž
;

244 
	}
}

246 
	$tid_rdma_scheduË_ack
(
rvt_qp
 *
qp
)

248 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

250 
´iv
->
s_æags
 |ð
RVT_S_ACK_PENDING
;

251 
	`hfi1_scheduË_tid_£nd
(
qp
);

252 
	}
}

254 
	$tid_rdma_Œigg”_ack
(
rvt_qp
 *
qp
)

256 
	`v®id©e_r_tid_ack
(
qp
->
´iv
);

257 
	`tid_rdma_scheduË_ack
(
qp
);

258 
	}
}

260 
u64
 
	$tid_rdma_Ýâ_’code
(
tid_rdma_·¿ms
 *
p
)

263 (((
u64
)
p
->
qp
 & 
TID_OPFN_QP_CTXT_MASK
) <<

264 
TID_OPFN_QP_CTXT_SHIFT
) |

265 ((((
u64
)
p
->
qp
 >> 16è& 
TID_OPFN_QP_KDETH_MASK
) <<

266 
TID_OPFN_QP_KDETH_SHIFT
) |

267 (((
u64
)((
p
->
max_Ën
 >> 
PAGE_SHIFT
) - 1) &

268 
TID_OPFN_MAX_LEN_MASK
è<< 
TID_OPFN_MAX_LEN_SHIFT
) |

269 (((
u64
)
p
->
timeout
 & 
TID_OPFN_TIMEOUT_MASK
) <<

270 
TID_OPFN_TIMEOUT_SHIFT
) |

271 (((
u64
)
p
->
urg
 & 
TID_OPFN_URG_MASK
è<< 
TID_OPFN_URG_SHIFT
) |

272 (((
u64
)
p
->
jkey
 & 
TID_OPFN_JKEY_MASK
è<< 
TID_OPFN_JKEY_SHIFT
) |

273 (((
u64
)
p
->
max_»ad
 & 
TID_OPFN_MAX_READ_MASK
) <<

274 
TID_OPFN_MAX_READ_SHIFT
) |

275 (((
u64
)
p
->
max_wr™e
 & 
TID_OPFN_MAX_WRITE_MASK
) <<

276 
TID_OPFN_MAX_WRITE_SHIFT
);

277 
	}
}

279 
	$tid_rdma_Ýâ_decode
(
tid_rdma_·¿ms
 *
p
, 
u64
 
d©a
)

281 
p
->
max_Ën
 = (((
d©a
 >> 
TID_OPFN_MAX_LEN_SHIFT
) &

282 
TID_OPFN_MAX_LEN_MASK
è+ 1è<< 
PAGE_SHIFT
;

283 
p
->
jkey
 = (
d©a
 >> 
TID_OPFN_JKEY_SHIFT
è& 
TID_OPFN_JKEY_MASK
;

284 
p
->
max_wr™e
 = (
d©a
 >> 
TID_OPFN_MAX_WRITE_SHIFT
) &

285 
TID_OPFN_MAX_WRITE_MASK
;

286 
p
->
max_»ad
 = (
d©a
 >> 
TID_OPFN_MAX_READ_SHIFT
) &

287 
TID_OPFN_MAX_READ_MASK
;

288 
p
->
qp
 =

289 ((((
d©a
 >> 
TID_OPFN_QP_KDETH_SHIFT
è& 
TID_OPFN_QP_KDETH_MASK
)

291 ((
d©a
 >> 
TID_OPFN_QP_CTXT_SHIFT
è& 
TID_OPFN_QP_CTXT_MASK
));

292 
p
->
urg
 = (
d©a
 >> 
TID_OPFN_URG_SHIFT
è& 
TID_OPFN_URG_MASK
;

293 
p
->
timeout
 = (
d©a
 >> 
TID_OPFN_TIMEOUT_SHIFT
è& 
TID_OPFN_TIMEOUT_MASK
;

294 
	}
}

296 
	$tid_rdma_Ýâ_š™
(
rvt_qp
 *
qp
, 
tid_rdma_·¿ms
 *
p
)

298 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

300 
p
->
qp
 = (
RVT_KDETH_QP_PREFIX
 << 16è| 
´iv
->
rcd
->
ùxt
;

301 
p
->
max_Ën
 = 
TID_RDMA_MAX_SEGMENT_SIZE
;

302 
p
->
jkey
 = 
´iv
->
rcd
->jkey;

303 
p
->
max_»ad
 = 
TID_RDMA_MAX_READ_SEGS_PER_REQ
;

304 
p
->
max_wr™e
 = 
TID_RDMA_MAX_WRITE_SEGS_PER_REQ
;

305 
p
->
timeout
 = 
qp
->timeout;

306 
p
->
urg
 = 
	`is_urg_masked
(
´iv
->
rcd
);

307 
	}
}

309 
boÞ
 
	$tid_rdma_cÚn_»q
(
rvt_qp
 *
qp
, 
u64
 *
d©a
)

311 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

313 *
d©a
 = 
	`tid_rdma_Ýâ_’code
(&
´iv
->
tid_rdma
.
loÿl
);

314  
Œue
;

315 
	}
}

317 
boÞ
 
	$tid_rdma_cÚn_»¶y
(
rvt_qp
 *
qp
, 
u64
 
d©a
)

319 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

320 
tid_rdma_·¿ms
 *
»mÙe
, *
Þd
;

321 
boÞ
 
»t
 = 
Œue
;

323 
Þd
 = 
	`rcu_d”eã»nû_´Ùeùed
(
´iv
->
tid_rdma
.
»mÙe
,

324 
	`lockd•_is_h–d
(&
´iv
->
Ýâ
.
lock
));

325 
d©a
 &= ~0xfULL;

330 ià(!
d©a
 || !
	`HFI1_CAP_IS_KSET
(
TID_RDMA
))

331 
nuÎ
;

339 
»mÙe
 = 
	`kz®loc
((*»mÙe), 
GFP_ATOMIC
);

340 ià(!
»mÙe
) {

341 
»t
 = 
çl£
;

342 
nuÎ
;

345 
	`tid_rdma_Ýâ_decode
(
»mÙe
, 
d©a
);

346 
´iv
->
tid_tim”_timeout_jiff›s
 =

347 
	`u£cs_to_jiff›s
((((4096UL * (1UL << 
»mÙe
->
timeout
)) /

349 
	`Œaû_hfi1_Ýâ_·¿m
(
qp
, 0, &
´iv
->
tid_rdma
.
loÿl
);

350 
	`Œaû_hfi1_Ýâ_·¿m
(
qp
, 1, 
»mÙe
);

351 
	`rcu_assign_poš‹r
(
´iv
->
tid_rdma
.
»mÙe
,„emote);

360 
´iv
->
pkts_ps
 = (
u16
)
	`rvt_div_mtu
(
qp
, 
»mÙe
->
max_Ën
);

361 
´iv
->
timeout_shiá
 = 
	`žog2
Õriv->
pkts_ps
 - 1) + 1;

362 
ä“
;

363 
nuÎ
:

364 
	`RCU_INIT_POINTER
(
´iv
->
tid_rdma
.
»mÙe
, 
NULL
);

365 
´iv
->
timeout_shiá
 = 0;

366 
ä“
:

367 ià(
Þd
)

368 
	`kä“_rcu
(
Þd
, 
rcu_h—d
);

369  
»t
;

370 
	}
}

372 
boÞ
 
	$tid_rdma_cÚn_»¥
(
rvt_qp
 *
qp
, 
u64
 *
d©a
)

374 
boÞ
 
»t
;

376 
»t
 = 
	`tid_rdma_cÚn_»¶y
(
qp
, *
d©a
);

377 *
d©a
 = 0;

383 ià(
»t
)

384 ()
	`tid_rdma_cÚn_»q
(
qp
, 
d©a
);

385  
»t
;

386 
	}
}

388 
	$tid_rdma_cÚn_”rÜ
(
rvt_qp
 *
qp
)

390 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

391 
tid_rdma_·¿ms
 *
Þd
;

393 
Þd
 = 
	`rcu_d”eã»nû_´Ùeùed
(
´iv
->
tid_rdma
.
»mÙe
,

394 
	`lockd•_is_h–d
(&
´iv
->
Ýâ
.
lock
));

395 
	`RCU_INIT_POINTER
(
´iv
->
tid_rdma
.
»mÙe
, 
NULL
);

396 ià(
Þd
)

397 
	`kä“_rcu
(
Þd
, 
rcu_h—d
);

398 
	}
}

401 
	$hfi1_k”n_exp_rcv_š™
(
hfi1_ùxtd©a
 *
rcd
, 
»š™
)

403 ià(
»š™
)

406 
	`BUILD_BUG_ON
(
TID_RDMA_JKEY
 < 
HFI1_KERNEL_MIN_JKEY
);

407 
	`BUILD_BUG_ON
(
TID_RDMA_JKEY
 > 
HFI1_KERNEL_MAX_JKEY
);

408 
rcd
->
jkey
 = 
TID_RDMA_JKEY
;

409 
	`hfi1_£t_ùxt_jkey
(
rcd
->
dd
,„cd,„cd->
jkey
);

410  
	`hfi1_®loc_ùxt_rcv_groups
(
rcd
);

411 
	}
}

422 
hfi1_ùxtd©a
 *
	$qp_to_rcd
(
rvt_dev_šfo
 *
rdi
,

423 
rvt_qp
 *
qp
)

425 
hfi1_ibdev
 *
v”bs_dev
 = 
	`cÚš”_of
(
rdi
,

426 
hfi1_ibdev
,

427 
rdi
);

428 
hfi1_devd©a
 *
dd
 = 
	`cÚš”_of
(
v”bs_dev
,

429 
hfi1_devd©a
,

430 
v”bs_dev
);

431 
ùxt
;

433 ià(
qp
->
ibqp
.
qp_num
 == 0)

434 
ùxt
 = 0;

436 
ùxt
 = 
	`hfi1_g‘_qp_m­
(
dd
, 
qp
->
ibqp
.
qp_num
 >> dd->
qos_shiá
);

437  
dd
->
rcd
[
ùxt
];

438 
	}
}

440 
	$hfi1_qp_´iv_š™
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
,

441 
ib_qp_š™_©Œ
 *
š™_©Œ
)

443 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

444 
i
, 
»t
;

446 
q´iv
->
rcd
 = 
	`qp_to_rcd
(
rdi
, 
qp
);

448 
	`¥š_lock_š™
(&
q´iv
->
Ýâ
.
lock
);

449 
	`INIT_WORK
(&
q´iv
->
Ýâ
.
Ýâ_wÜk
, 
Ýâ_£nd_cÚn_»que¡
);

450 
	`INIT_WORK
(&
q´iv
->
tid_rdma
.
Œigg”_wÜk
, 
tid_rdma_Œigg”_»sume
);

451 
q´iv
->
æow_¡©e
.
p¢
 = 0;

452 
q´iv
->
æow_¡©e
.
šdex
 = 
RXE_NUM_TID_FLOWS
;

453 
q´iv
->
æow_¡©e
.
Ï¡_šdex
 = 
RXE_NUM_TID_FLOWS
;

454 
q´iv
->
æow_¡©e
.
g’”©iÚ
 = 
KERN_GENERATION_RESERVED
;

455 
q´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

456 
q´iv
->
s_tid_cur
 = 
HFI1_QP_WQE_INVALID
;

457 
q´iv
->
s_tid_h—d
 = 
HFI1_QP_WQE_INVALID
;

458 
q´iv
->
s_tid_ž
 = 
HFI1_QP_WQE_INVALID
;

459 
q´iv
->
ºr_Çk_¡©e
 = 
TID_RNR_NAK_INIT
;

460 
q´iv
->
r_tid_h—d
 = 
HFI1_QP_WQE_INVALID
;

461 
q´iv
->
r_tid_ž
 = 
HFI1_QP_WQE_INVALID
;

462 
q´iv
->
r_tid_ack
 = 
HFI1_QP_WQE_INVALID
;

463 
q´iv
->
r_tid_®loc
 = 
HFI1_QP_WQE_INVALID
;

464 
	`©omic_£t
(&
q´iv
->
n_»que¡s
, 0);

465 
	`©omic_£t
(&
q´iv
->
n_tid_»que¡s
, 0);

466 
	`tim”_£tup
(&
q´iv
->
s_tid_tim”
, 
hfi1_tid_timeout
, 0);

467 
	`tim”_£tup
(&
q´iv
->
s_tid_»Œy_tim”
, 
hfi1_tid_»Œy_timeout
, 0);

468 
	`INIT_LIST_HEAD
(&
q´iv
->
tid_wa™
);

470 ià(
š™_©Œ
->
qp_ty³
 =ð
IB_QPT_RC
 && 
	`HFI1_CAP_IS_KSET
(
TID_RDMA
)) {

471 
hfi1_devd©a
 *
dd
 = 
q´iv
->
rcd
->dd;

473 
q´iv
->
·ges
 = 
	`kz®loc_node
(
TID_RDMA_MAX_PAGES
 *

474 (*
q´iv
->
·ges
),

475 
GFP_KERNEL
, 
dd
->
node
);

476 ià(!
q´iv
->
·ges
)

477  -
ENOMEM
;

478 
i
 = 0; i < 
qp
->
s_size
; i++) {

479 
hfi1_swqe_´iv
 *
´iv
;

480 
rvt_swqe
 *
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

482 
´iv
 = 
	`kz®loc_node
((*´iv), 
GFP_KERNEL
,

483 
dd
->
node
);

484 ià(!
´iv
)

485  -
ENOMEM
;

487 
	`hfi1_š™_Œdma_»q
(
qp
, &
´iv
->
tid_»q
);

488 
´iv
->
tid_»q
.
e
.
swqe
 = 
wqe
;

489 
wqe
->
´iv
 =…riv;

491 
i
 = 0; i < 
	`rvt_max_©omic
(
rdi
); i++) {

492 
hfi1_ack_´iv
 *
´iv
;

494 
´iv
 = 
	`kz®loc_node
((*´iv), 
GFP_KERNEL
,

495 
dd
->
node
);

496 ià(!
´iv
)

497  -
ENOMEM
;

499 
	`hfi1_š™_Œdma_»q
(
qp
, &
´iv
->
tid_»q
);

500 
´iv
->
tid_»q
.
e
.
ack
 = &
qp
->
s_ack_queue
[
i
];

502 
»t
 = 
	`hfi1_k”n_exp_rcv_®loc_æows
(&
´iv
->
tid_»q
,

503 
GFP_KERNEL
);

504 ià(
»t
) {

505 
	`kä“
(
´iv
);

506  
»t
;

508 
qp
->
s_ack_queue
[
i
].
´iv
 =…riv;

513 
	}
}

515 
	$hfi1_qp_´iv_tid_ä“
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
)

517 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

518 
rvt_swqe
 *
wqe
;

519 
u32
 
i
;

521 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
 && 
	`HFI1_CAP_IS_KSET
(
TID_RDMA
)) {

522 
i
 = 0; i < 
qp
->
s_size
; i++) {

523 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

524 
	`kä“
(
wqe
->
´iv
);

525 
wqe
->
´iv
 = 
NULL
;

527 
i
 = 0; i < 
	`rvt_max_©omic
(
rdi
); i++) {

528 
hfi1_ack_´iv
 *
´iv
 = 
qp
->
s_ack_queue
[
i
].priv;

530 ià(
´iv
)

531 
	`hfi1_k”n_exp_rcv_ä“_æows
(&
´iv
->
tid_»q
);

532 
	`kä“
(
´iv
);

533 
qp
->
s_ack_queue
[
i
].
´iv
 = 
NULL
;

535 
	`ÿnûl_wÜk_sync
(&
q´iv
->
Ýâ
.
Ýâ_wÜk
);

536 
	`kä“
(
q´iv
->
·ges
);

537 
q´iv
->
·ges
 = 
NULL
;

539 
	}
}

571 
rvt_qp
 *
	$fœ¡_qp
(
hfi1_ùxtd©a
 *
rcd
,

572 
tid_queue
 *
queue
)

573 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
)

575 
hfi1_qp_´iv
 *
´iv
;

577 
	`lockd•_as£¹_h–d
(&
rcd
->
exp_lock
);

578 
´iv
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
queue
->
queue_h—d
,

579 
hfi1_qp_´iv
,

580 
tid_wa™
);

581 ià(!
´iv
)

582  
NULL
;

583 
	`rvt_g‘_qp
(
´iv
->
owÃr
);

584  
´iv
->
owÃr
;

585 
	}
}

605 
boÞ
 
	$k”Ãl_tid_wa™”s
(
hfi1_ùxtd©a
 *
rcd
,

606 
tid_queue
 *
queue
, 
rvt_qp
 *
qp
)

607 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
è__mu¡_hÞd(&
qp
->
s_lock
)

609 
rvt_qp
 *
fqp
;

610 
boÞ
 
»t
 = 
Œue
;

612 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

613 
	`lockd•_as£¹_h–d
(&
rcd
->
exp_lock
);

614 
fqp
 = 
	`fœ¡_qp
(
rcd
, 
queue
);

615 ià(!
fqp
 || (fq°=ð
qp
 && (qp->
s_æags
 & 
HFI1_S_WAIT_TID_SPACE
)))

616 
»t
 = 
çl£
;

617 
	`rvt_put_qp
(
fqp
);

618  
»t
;

619 
	}
}

636 
	$dequeue_tid_wa™”
(
hfi1_ùxtd©a
 *
rcd
,

637 
tid_queue
 *
queue
, 
rvt_qp
 *
qp
)

638 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
è__mu¡_hÞd(&
qp
->
s_lock
)

640 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

642 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

643 
	`lockd•_as£¹_h–d
(&
rcd
->
exp_lock
);

644 ià(
	`li¡_em±y
(&
´iv
->
tid_wa™
))

646 
	`li¡_d–_š™
(&
´iv
->
tid_wa™
);

647 
qp
->
s_æags
 &ð~
HFI1_S_WAIT_TID_SPACE
;

648 
queue
->
dequeue
++;

649 
	`rvt_put_qp
(
qp
);

650 
	}
}

662 
	$queue_qp_fÜ_tid_wa™
(
hfi1_ùxtd©a
 *
rcd
,

663 
tid_queue
 *
queue
, 
rvt_qp
 *
qp
)

664 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
è__mu¡_hÞd(&
qp
->
s_lock
)

666 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

668 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

669 
	`lockd•_as£¹_h–d
(&
rcd
->
exp_lock
);

670 ià(
	`li¡_em±y
(&
´iv
->
tid_wa™
)) {

671 
qp
->
s_æags
 |ð
HFI1_S_WAIT_TID_SPACE
;

672 
	`li¡_add_ž
(&
´iv
->
tid_wa™
, &
queue
->
queue_h—d
);

673 
´iv
->
tid_’queue
 = ++
queue
->
’queue
;

674 
rcd
->
dd
->
v”bs_dev
.
n_tidwa™
++;

675 
	`Œaû_hfi1_qp¦“p
(
qp
, 
HFI1_S_WAIT_TID_SPACE
);

676 
	`rvt_g‘_qp
(
qp
);

678 
	}
}

687 
	$__Œigg”_tid_wa™”
(
rvt_qp
 *
qp
)

688 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

690 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

691 ià(!(
qp
->
s_æags
 & 
HFI1_S_WAIT_TID_SPACE
))

693 
	`Œaû_hfi1_qpwakeup
(
qp
, 
HFI1_S_WAIT_TID_SPACE
);

694 
	`hfi1_scheduË_£nd
(
qp
);

695 
	}
}

709 
	$tid_rdma_scheduË_tid_wakeup
(
rvt_qp
 *
qp
)

711 
hfi1_qp_´iv
 *
´iv
;

712 
hfi1_ibpÜt
 *
ibp
;

713 
hfi1_µÜtd©a
 *
µd
;

714 
hfi1_devd©a
 *
dd
;

715 
boÞ
 
rv®
;

717 ià(!
qp
)

720 
´iv
 = 
qp
->priv;

721 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

722 
µd
 = 
	`µd_äom_ibp
(
ibp
);

723 
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

725 
rv®
 = 
	`queue_wÜk_Ú
(
´iv
->
s_sde
 ?

726 
´iv
->
s_sde
->
ýu
 :

727 
	`ýumask_fœ¡
(
	`ýumask_of_node
(
dd
->
node
)),

728 
µd
->
hfi1_wq
,

729 &
´iv
->
tid_rdma
.
Œigg”_wÜk
);

730 ià(!
rv®
)

731 
	`rvt_put_qp
(
qp
);

732 
	}
}

741 
	$tid_rdma_Œigg”_»sume
(
wÜk_¡ruù
 *
wÜk
)

743 
tid_rdma_qp_·¿ms
 *
Œ
;

744 
hfi1_qp_´iv
 *
´iv
;

745 
rvt_qp
 *
qp
;

747 
Œ
 = 
	`cÚš”_of
(
wÜk
, 
tid_rdma_qp_·¿ms
, 
Œigg”_wÜk
);

748 
´iv
 = 
	`cÚš”_of
(
Œ
, 
hfi1_qp_´iv
, 
tid_rdma
);

749 
qp
 = 
´iv
->
owÃr
;

750 
	`¥š_lock_œq
(&
qp
->
s_lock
);

751 ià(
qp
->
s_æags
 & 
HFI1_S_WAIT_TID_SPACE
) {

752 
	`¥š_uÆock_œq
(&
qp
->
s_lock
);

753 
	`hfi1_do_£nd
(
´iv
->
owÃr
, 
Œue
);

755 
	`¥š_uÆock_œq
(&
qp
->
s_lock
);

757 
	`rvt_put_qp
(
qp
);

758 
	}
}

767 
	$_tid_rdma_æush_wa™
(
rvt_qp
 *
qp
, 
tid_queue
 *
queue
)

768 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

770 
hfi1_qp_´iv
 *
´iv
;

772 ià(!
qp
)

774 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

775 
´iv
 = 
qp
->priv;

776 
qp
->
s_æags
 &ð~
HFI1_S_WAIT_TID_SPACE
;

777 
	`¥š_lock
(&
´iv
->
rcd
->
exp_lock
);

778 ià(!
	`li¡_em±y
(&
´iv
->
tid_wa™
)) {

779 
	`li¡_d–_š™
(&
´iv
->
tid_wa™
);

780 
qp
->
s_æags
 &ð~
HFI1_S_WAIT_TID_SPACE
;

781 
queue
->
dequeue
++;

782 
	`rvt_put_qp
(
qp
);

784 
	`¥š_uÆock
(&
´iv
->
rcd
->
exp_lock
);

785 
	}
}

787 
	$hfi1_tid_rdma_æush_wa™
(
rvt_qp
 *
qp
)

788 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

790 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

792 
	`_tid_rdma_æush_wa™
(
qp
, &
´iv
->
rcd
->
æow_queue
);

793 
	`_tid_rdma_æush_wa™
(
qp
, &
´iv
->
rcd
->
¿¼_queue
);

794 
	}
}

814 
	$k”n_»£rve_æow
(
hfi1_ùxtd©a
 *
rcd
, 
Ï¡
)

815 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
)

817 
Ä
;

820 ià(
Ï¡
 >ð0 &&†a¡ < 
RXE_NUM_TID_FLOWS
 &&

821 !
	`‹¡_ªd_£t_b™
(
Ï¡
, &
rcd
->
æow_mask
))

822  
Ï¡
;

824 
Ä
 = 
	`ffz
(
rcd
->
æow_mask
);

825 
	`BUILD_BUG_ON
(
RXE_NUM_TID_FLOWS
 >=

826 ((
rcd
->
æow_mask
è* 
BITS_PER_BYTE
));

827 ià(
Ä
 > (
RXE_NUM_TID_FLOWS
 - 1))

828  -
EAGAIN
;

829 
	`£t_b™
(
Ä
, &
rcd
->
æow_mask
);

830  
Ä
;

831 
	}
}

833 
	$k”n_£t_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
g’”©iÚ
,

834 
u32
 
æow_idx
)

836 
u64
 
»g
;

838 
»g
 = ((
u64
)
g’”©iÚ
 << 
HFI1_KDETH_BTH_SEQ_SHIFT
) |

839 
RCV_TID_FLOW_TABLE_CTRL_FLOW_VALID_SMASK
 |

840 
RCV_TID_FLOW_TABLE_CTRL_KEEP_AFTER_SEQ_ERR_SMASK
 |

841 
RCV_TID_FLOW_TABLE_CTRL_KEEP_ON_GEN_ERR_SMASK
 |

842 
RCV_TID_FLOW_TABLE_STATUS_SEQ_MISMATCH_SMASK
 |

843 
RCV_TID_FLOW_TABLE_STATUS_GEN_MISMATCH_SMASK
;

845 ià(
g’”©iÚ
 !ð
KERN_GENERATION_RESERVED
)

846 
»g
 |ð
RCV_TID_FLOW_TABLE_CTRL_HDR_SUPP_EN_SMASK
;

848 
	`wr™e_uùxt_c¤
(
rcd
->
dd
,„cd->
ùxt
,

849 
RCV_TID_FLOW_TABLE
 + 8 * 
æow_idx
, 
»g
);

850 
	}
}

852 
u32
 
	$k”n_£tup_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
æow_idx
)

853 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
)

855 
u32
 
g’”©iÚ
 = 
rcd
->
æows
[
æow_idx
].generation;

857 
	`k”n_£t_hw_æow
(
rcd
, 
g’”©iÚ
, 
æow_idx
);

858  
g’”©iÚ
;

859 
	}
}

861 
u32
 
	$k”n_æow_g’”©iÚ_Ãxt
(
u32
 
g’
)

863 
u32
 
g’”©iÚ
 = 
	`mask_g’”©iÚ
(
g’
 + 1);

865 ià(
g’”©iÚ
 =ð
KERN_GENERATION_RESERVED
)

866 
g’”©iÚ
 = 
	`mask_g’”©iÚ
(generation + 1);

867  
g’”©iÚ
;

868 
	}
}

870 
	$k”n_þ—r_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
u32
 
æow_idx
)

871 
	`__mu¡_hÞd
(&
rcd
->
exp_lock
)

873 
rcd
->
æows
[
æow_idx
].
g’”©iÚ
 =

874 
	`k”n_æow_g’”©iÚ_Ãxt
(
rcd
->
æows
[
æow_idx
].
g’”©iÚ
);

875 
	`k”n_£t_hw_æow
(
rcd
, 
KERN_GENERATION_RESERVED
, 
æow_idx
);

876 
	}
}

878 
	$hfi1_k”n_£tup_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
rvt_qp
 *
qp
)

880 
hfi1_qp_´iv
 *
q´iv
 = (hfi1_qp_´iv *)
qp
->
´iv
;

881 
tid_æow_¡©e
 *
fs
 = &
q´iv
->
æow_¡©e
;

882 
rvt_qp
 *
fqp
;

883 
æags
;

884 
»t
 = 0;

887 ià(
fs
->
šdex
 !ð
RXE_NUM_TID_FLOWS
)

888  
»t
;

890 
	`¥š_lock_œq§ve
(&
rcd
->
exp_lock
, 
æags
);

891 ià(
	`k”Ãl_tid_wa™”s
(
rcd
, &rcd->
æow_queue
, 
qp
))

892 
queue
;

894 
»t
 = 
	`k”n_»£rve_æow
(
rcd
, 
fs
->
Ï¡_šdex
);

895 ià(
»t
 < 0)

896 
queue
;

897 
fs
->
šdex
 = 
»t
;

898 
fs
->
Ï¡_šdex
 = fs->
šdex
;

901 ià(
fs
->
g’”©iÚ
 !ð
KERN_GENERATION_RESERVED
)

902 
rcd
->
æows
[
fs
->
šdex
].
g’”©iÚ
 = fs->generation;

903 
fs
->
g’”©iÚ
 = 
	`k”n_£tup_hw_æow
(
rcd
, fs->
šdex
);

904 
fs
->
p¢
 = 0;

905 
	`dequeue_tid_wa™”
(
rcd
, &rcd->
æow_queue
, 
qp
);

907 
fqp
 = 
	`fœ¡_qp
(
rcd
, &rcd->
æow_queue
);

908 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

910 
	`tid_rdma_scheduË_tid_wakeup
(
fqp
);

912 
queue
:

913 
	`queue_qp_fÜ_tid_wa™
(
rcd
, &rcd->
æow_queue
, 
qp
);

914 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

915  -
EAGAIN
;

916 
	}
}

918 
	$hfi1_k”n_þ—r_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
rvt_qp
 *
qp
)

920 
hfi1_qp_´iv
 *
q´iv
 = (hfi1_qp_´iv *)
qp
->
´iv
;

921 
tid_æow_¡©e
 *
fs
 = &
q´iv
->
æow_¡©e
;

922 
rvt_qp
 *
fqp
;

923 
æags
;

925 ià(
fs
->
šdex
 >ð
RXE_NUM_TID_FLOWS
)

927 
	`¥š_lock_œq§ve
(&
rcd
->
exp_lock
, 
æags
);

928 
	`k”n_þ—r_hw_æow
(
rcd
, 
fs
->
šdex
);

929 
	`þ—r_b™
(
fs
->
šdex
, &
rcd
->
æow_mask
);

930 
fs
->
šdex
 = 
RXE_NUM_TID_FLOWS
;

931 
fs
->
p¢
 = 0;

932 
fs
->
g’”©iÚ
 = 
KERN_GENERATION_RESERVED
;

935 
fqp
 = 
	`fœ¡_qp
(
rcd
, &rcd->
æow_queue
);

936 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

938 ià(
fqp
 =ð
qp
) {

939 
	`__Œigg”_tid_wa™”
(
fqp
);

940 
	`rvt_put_qp
(
fqp
);

942 
	`tid_rdma_scheduË_tid_wakeup
(
fqp
);

944 
	}
}

946 
	$hfi1_k”n_š™_ùxt_g’”©iÚs
(
hfi1_ùxtd©a
 *
rcd
)

948 
i
;

950 
i
 = 0; i < 
RXE_NUM_TID_FLOWS
; i++) {

951 
rcd
->
æows
[
i
].
g’”©iÚ
 = 
	`mask_g’”©iÚ
(
	`´ªdom_u32
());

952 
	`k”n_£t_hw_æow
(
rcd
, 
KERN_GENERATION_RESERVED
, 
i
);

954 
	}
}

957 
u8
 
	$Œdma_p£t_Üd”
(
tid_rdma_·ge£t
 *
s
)

959 
u8
 
couÁ
 = 
s
->count;

961  
	`žog2
(
couÁ
) + 1;

962 
	}
}

978 
u32
 
	$tid_rdma_fšd_phys_blocks_4k
(
tid_rdma_æow
 *
æow
,

979 
·ge
 **
·ges
,

980 
u32
 
Åages
,

981 
tid_rdma_·ge£t
 *
li¡
)

983 
u32
 
·gecouÁ
, 
·geidx
, 
£tcouÁ
 = 0, 
i
;

984 *
vaddr
, *
this_vaddr
;

986 ià(!
Åages
)

994 
vaddr
 = 
	`·ge_add»ss
(
·ges
[0]);

995 
	`Œaû_hfi1_tid_æow_·ge
(
æow
->
»q
->
qp
, flow, 0, 0, 0, 
vaddr
);

996 
·geidx
 = 0, 
·gecouÁ
 = 1, 
i
 = 1; i <ð
Åages
; i++) {

997 
this_vaddr
 = 
i
 < 
Åages
 ? 
	`·ge_add»ss
(
·ges
[i]è: 
NULL
;

998 
	`Œaû_hfi1_tid_æow_·ge
(
æow
->
»q
->
qp
, flow, 
i
, 0, 0,

999 
this_vaddr
);

1004 ià(
this_vaddr
 !ð(
vaddr
 + 
PAGE_SIZE
)) {

1017 
·gecouÁ
) {

1018 
max·ges
 = 
·gecouÁ
;

1019 
u32
 
bufsize
 = 
·gecouÁ
 * 
PAGE_SIZE
;

1021 ià(
bufsize
 > 
MAX_EXPECTED_BUFFER
)

1022 
max·ges
 =

1023 
MAX_EXPECTED_BUFFER
 >>

1024 
PAGE_SHIFT
;

1025 ià(!
	`is_pow”_of_2
(
bufsize
))

1026 
max·ges
 =

1027 
	`rounddown_pow_of_two
(
bufsize
) >>

1028 
PAGE_SHIFT
;

1030 
li¡
[
£tcouÁ
].
idx
 = 
·geidx
;

1031 
li¡
[
£tcouÁ
].
couÁ
 = 
max·ges
;

1032 
	`Œaû_hfi1_tid_·ge£t
(
æow
->
»q
->
qp
, 
£tcouÁ
,

1033 
li¡
[
£tcouÁ
].
idx
,

1034 
li¡
[
£tcouÁ
].
couÁ
);

1035 
·gecouÁ
 -ð
max·ges
;

1036 
·geidx
 +ð
max·ges
;

1037 
£tcouÁ
++;

1039 
·geidx
 = 
i
;

1040 
·gecouÁ
 = 1;

1041 
vaddr
 = 
this_vaddr
;

1043 
vaddr
 +ð
PAGE_SIZE
;

1044 
·gecouÁ
++;

1048 ià(
£tcouÁ
 & 1)

1049 
li¡
[
£tcouÁ
++].
couÁ
 = 0;

1050  
£tcouÁ
;

1051 
	}
}

1073 
u32
 
	$tid_æush_·ges
(
tid_rdma_·ge£t
 *
li¡
,

1074 
u32
 *
idx
, u32 
·ges
, u32 
£ts
)

1076 
·ges
) {

1077 
u32
 
max·ges
 = 
·ges
;

1079 ià(
max·ges
 > 
MAX_EXPECTED_PAGES
)

1080 
max·ges
 = 
MAX_EXPECTED_PAGES
;

1081 ià(!
	`is_pow”_of_2
(
max·ges
))

1082 
max·ges
 = 
	`rounddown_pow_of_two
(maxpages);

1083 
li¡
[
£ts
].
idx
 = *idx;

1084 
li¡
[
£ts
++].
couÁ
 = 
max·ges
;

1085 *
idx
 +ð
max·ges
;

1086 
·ges
 -ð
max·ges
;

1089 ià(
£ts
 & 1)

1090 
li¡
[
£ts
++].
couÁ
 = 0;

1091  
£ts
;

1092 
	}
}

1116 
u32
 
	$tid_rdma_fšd_phys_blocks_8k
(
tid_rdma_æow
 *
æow
,

1117 
·ge
 **
·ges
,

1118 
u32
 
Åages
,

1119 
tid_rdma_·ge£t
 *
li¡
)

1121 
u32
 
idx
, 
£ts
 = 0, 
i
;

1122 
u32
 
·geút
 = 0;

1123 *
v0
, *
v1
, *
vm1
;

1125 ià(!
Åages
)

1127 
idx
 = 0, 
i
 = 0, 
vm1
 = 
NULL
; i < 
Åages
; i += 2) {

1129 
v0
 = 
	`·ge_add»ss
(
·ges
[
i
]);

1130 
	`Œaû_hfi1_tid_æow_·ge
(
æow
->
»q
->
qp
, flow, 
i
, 1, 0, 
v0
);

1131 
v1
 = 
i
 + 1 < 
Åages
 ?

1132 
	`·ge_add»ss
(
·ges
[
i
 + 1]è: 
NULL
;

1133 
	`Œaû_hfi1_tid_æow_·ge
(
æow
->
»q
->
qp
, flow, 
i
, 1, 1, 
v1
);

1135 ià(
v1
 !ð(
v0
 + 
PAGE_SIZE
)) {

1137 
£ts
 = 
	`tid_æush_·ges
(
li¡
, &
idx
, 
·geút
, sets);

1139 
li¡
[
£ts
].
idx
 = idx++;

1140 
li¡
[
£ts
++].
couÁ
 = 1;

1141 ià(
v1
) {

1142 
li¡
[
£ts
].
couÁ
 = 1;

1143 
li¡
[
£ts
++].
idx
 = idx++;

1145 
li¡
[
£ts
++].
couÁ
 = 0;

1147 
vm1
 = 
NULL
;

1148 
·geút
 = 0;

1152 ià(
vm1
 && 
v0
 !ð(vm1 + 
PAGE_SIZE
)) {

1154 
£ts
 = 
	`tid_æush_·ges
(
li¡
, &
idx
, 
·geút
, sets);

1155 
·geút
 = 0;

1158 
·geút
 += 2;

1160 
vm1
 = 
v1
;

1164 
£ts
 = 
	`tid_æush_·ges
(
li¡
, &
idx
, 
Åages
 - idx, sets);

1166 
	`WARN_ON
(
£ts
 & 1);

1167  
£ts
;

1168 
	}
}

1183 
u32
 
	$k”n_fšd_·ges
(
tid_rdma_æow
 *
æow
,

1184 
·ge
 **
·ges
,

1185 
rvt_sge_¡©e
 *
ss
, 
boÞ
 *
Ï¡
)

1187 
tid_rdma_»que¡
 *
»q
 = 
æow
->req;

1188 
rvt_sge
 *
sge
 = &
ss
->sge;

1189 
u32
 
Ëngth
 = 
æow
->
»q
->
£g_Ën
;

1190 
u32
 
Ën
 = 
PAGE_SIZE
;

1191 
u32
 
i
 = 0;

1193 
Ëngth
 && 
»q
->
isge
 < 
ss
->
num_sge
) {

1194 
·ges
[
i
++] = 
	`vœt_to_·ge
(
sge
->
vaddr
);

1196 
sge
->
vaddr
 +ð
Ën
;

1197 
sge
->
Ëngth
 -ð
Ën
;

1198 
sge
->
sge_Ëngth
 -ð
Ën
;

1199 ià(!
sge
->
sge_Ëngth
) {

1200 ià(++
»q
->
isge
 < 
ss
->
num_sge
)

1201 *
sge
 = 
ss
->
sg_li¡
[
»q
->
isge
 - 1];

1202 } ià(
sge
->
Ëngth
 =ð0 && sge->
mr
->
lkey
) {

1203 ià(++
sge
->
n
 >ð
RVT_SEGSZ
) {

1204 ++
sge
->
m
;

1205 
sge
->
n
 = 0;

1207 
sge
->
vaddr
 = sge->
mr
->
m­
[sge->
m
]->
£gs
[sge->
n
].vaddr;

1208 
sge
->
Ëngth
 = sge->
mr
->
m­
[sge->
m
]->
£gs
[sge->
n
].length;

1210 
Ëngth
 -ð
Ën
;

1213 
æow
->
Ëngth
 = flow->
»q
->
£g_Ën
 -†ength;

1214 *
Ï¡
 = 
»q
->
isge
 =ð
ss
->
num_sge
 ? 
çl£
 : 
Œue
;

1215  
i
;

1216 
	}
}

1218 
	$dma_unm­_æow
(
tid_rdma_æow
 *
æow
)

1220 
hfi1_devd©a
 *
dd
;

1221 
i
;

1222 
tid_rdma_·ge£t
 *
p£t
;

1224 
dd
 = 
æow
->
»q
->
rcd
->dd;

1225 
i
 = 0, 
p£t
 = &
æow
->
·ge£ts
[0]; i < flow->
Åage£ts
;

1226 
i
++, 
p£t
++) {

1227 ià(
p£t
->
couÁ
 &&…£t->
addr
) {

1228 
	`dma_unm­_·ge
(&
dd
->
pcidev
->
dev
,

1229 
p£t
->
addr
,

1230 
PAGE_SIZE
 * 
p£t
->
couÁ
,

1231 
DMA_FROM_DEVICE
);

1232 
p£t
->
m­³d
 = 0;

1235 
	}
}

1237 
	$dma_m­_æow
(
tid_rdma_æow
 *
æow
, 
·ge
 **
·ges
)

1239 
i
;

1240 
hfi1_devd©a
 *
dd
 = 
æow
->
»q
->
rcd
->dd;

1241 
tid_rdma_·ge£t
 *
p£t
;

1243 
i
 = 0, 
p£t
 = &
æow
->
·ge£ts
[0]; i < flow->
Åage£ts
;

1244 
i
++, 
p£t
++) {

1245 ià(
p£t
->
couÁ
) {

1246 
p£t
->
addr
 = 
	`dma_m­_·ge
(&
dd
->
pcidev
->
dev
,

1247 
·ges
[
p£t
->
idx
],

1249 
PAGE_SIZE
 * 
p£t
->
couÁ
,

1250 
DMA_FROM_DEVICE
);

1252 ià(
	`dma_m­pšg_”rÜ
(&
dd
->
pcidev
->
dev
, 
p£t
->
addr
)) {

1253 
	`dma_unm­_æow
(
æow
);

1254  -
ENOMEM
;

1256 
p£t
->
m­³d
 = 1;

1260 
	}
}

1262 
šlše
 
boÞ
 
	$dma_m­³d
(
tid_rdma_æow
 *
æow
)

1264  !!
æow
->
·ge£ts
[0].
m­³d
;

1265 
	}
}

1271 
	$k”n_g‘_phys_blocks
(
tid_rdma_æow
 *
æow
,

1272 
·ge
 **
·ges
,

1273 
rvt_sge_¡©e
 *
ss
, 
boÞ
 *
Ï¡
)

1275 
u8
 
Åages
;

1278 ià(
æow
->
Åage£ts
) {

1279 
	`Œaû_hfi1_tid_æow_®loc
(
æow
->
»q
->
qp
, flow->»q->
£tup_h—d
,

1280 
æow
);

1281 ià(!
	`dma_m­³d
(
æow
))

1282  
	`dma_m­_æow
(
æow
, 
·ges
);

1286 
Åages
 = 
	`k”n_fšd_·ges
(
æow
, 
·ges
, 
ss
, 
Ï¡
);

1288 ià(
æow
->
»q
->
qp
->
pmtu
 =ð
	`’um_to_mtu
(
OPA_MTU_4096
))

1289 
æow
->
Åage£ts
 =

1290 
	`tid_rdma_fšd_phys_blocks_4k
(
æow
, 
·ges
, 
Åages
,

1291 
æow
->
·ge£ts
);

1293 
æow
->
Åage£ts
 =

1294 
	`tid_rdma_fšd_phys_blocks_8k
(
æow
, 
·ges
, 
Åages
,

1295 
æow
->
·ge£ts
);

1297  
	`dma_m­_æow
(
æow
, 
·ges
);

1298 
	}
}

1300 
šlše
 
	$k”n_add_tid_node
(
tid_rdma_æow
 *
æow
,

1301 
hfi1_ùxtd©a
 *
rcd
, *
s
,

1302 
tid_group
 *
g½
, 
u8
 
út
)

1304 
k”n_tid_node
 *
node
 = &
æow
->
Šode
[æow->
Šode_út
++];

1306 
	`WARN_ON_ONCE
(
æow
->
Šode_út
 >=

1307 (
TID_RDMA_MAX_SEGMENT_SIZE
 >> 
PAGE_SHIFT
));

1308 ià(
	`WARN_ON_ONCE
(
út
 & 1))

1309 
	`dd_dev_”r
(
rcd
->
dd
,

1311 
út
, 
g½
->
m­
, g½->
u£d
);

1313 
node
->
g½
 = grp;

1314 
node
->
m­
 = 
g½
->map;

1315 
node
->
út
 = cnt;

1316 
	`Œaû_hfi1_tid_node_add
(
æow
->
»q
->
qp
, 
s
, flow->
Šode_út
 - 1,

1317 
g½
->
ba£
, g½->
m­
, g½->
u£d
, 
út
);

1318 
	}
}

1333 
	$k”n_®loc_tids
(
tid_rdma_æow
 *
æow
)

1335 
hfi1_ùxtd©a
 *
rcd
 = 
æow
->
»q
->rcd;

1336 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1337 
u32
 
ngroups
, 
·geidx
 = 0;

1338 
tid_group
 *
group
 = 
NULL
, *
u£d
;

1339 
u8
 
u£
;

1341 
æow
->
Šode_út
 = 0;

1342 
ngroups
 = 
æow
->
Åage£ts
 / 
dd
->
rcv_’Œ›s
.
group_size
;

1343 ià(!
ngroups
)

1344 
u£d_li¡
;

1347 
	`li¡_fÜ_—ch_’Œy
(
group
, &
rcd
->
tid_group_li¡
.
li¡
,†ist) {

1348 
	`k”n_add_tid_node
(
æow
, 
rcd
, "com¶‘groups", 
group
,

1349 
group
->
size
);

1351 
·geidx
 +ð
group
->
size
;

1352 ià(!--
ngroups
)

1356 ià(
·geidx
 >ð
æow
->
Åage£ts
)

1357 
ok
;

1359 
u£d_li¡
:

1361 
	`li¡_fÜ_—ch_’Œy
(
u£d
, &
rcd
->
tid_u£d_li¡
.
li¡
,†ist) {

1362 
u£
 = 
	`mš_t
(
u32
, 
æow
->
Åage£ts
 - 
·geidx
,

1363 
u£d
->
size
 - used->used);

1364 
	`k”n_add_tid_node
(
æow
, 
rcd
, "u£d groups", 
u£d
, 
u£
);

1366 
·geidx
 +ð
u£
;

1367 ià(
·geidx
 >ð
æow
->
Åage£ts
)

1368 
ok
;

1376 ià(
group
 && &group->
li¡
 =ð&
rcd
->
tid_group_li¡
.list)

1377 
baž_—gaš
;

1378 
group
 = 
	`li¡_´•¬e_’Œy
(group, &
rcd
->
tid_group_li¡
.
li¡
,

1379 
li¡
);

1380 ià(
	`li¡_is_Ï¡
(&
group
->
li¡
, &
rcd
->
tid_group_li¡
.list))

1381 
baž_—gaš
;

1382 
group
 = 
	`li¡_Ãxt_’Œy
(group, 
li¡
);

1383 
u£
 = 
	`mš_t
(
u32
, 
æow
->
Åage£ts
 - 
·geidx
, 
group
->
size
);

1384 
	`k”n_add_tid_node
(
æow
, 
rcd
, "com¶‘cÚtšue", 
group
, 
u£
);

1385 
·geidx
 +ð
u£
;

1386 ià(
·geidx
 >ð
æow
->
Åage£ts
)

1387 
ok
;

1388 
baž_—gaš
:

1389 
	`Œaû_hfi1_msg_®loc_tids
(
æow
->
»q
->
qp
, " insufficientids:‚eeded ",

1390 (
u64
)
æow
->
Åage£ts
);

1391  -
EAGAIN
;

1392 
ok
:

1394 
	}
}

1396 
	$k”n_´og¿m_rcv_group
(
tid_rdma_æow
 *
æow
, 
g½_num
,

1397 
u32
 *
p£t_idx
)

1399 
hfi1_ùxtd©a
 *
rcd
 = 
æow
->
»q
->rcd;

1400 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1401 
k”n_tid_node
 *
node
 = &
æow
->
Šode
[
g½_num
];

1402 
tid_group
 *
g½
 = 
node
->grp;

1403 
tid_rdma_·ge£t
 *
p£t
;

1404 
u32
 
pmtu_pg
 = 
æow
->
»q
->
qp
->
pmtu
 >> 
PAGE_SHIFT
;

1405 
u32
 
rcv’Œy
, 
Åages
 = 0, 
·œ
 = 0, 
tidù¾
;

1406 
u8
 
i
, 
út
 = 0;

1408 
i
 = 0; i < 
g½
->
size
; i++) {

1409 
rcv’Œy
 = 
g½
->
ba£
 + 
i
;

1411 ià(
node
->
m­
 & 
	`BIT
(
i
è|| 
út
 >=‚ode->cnt) {

1412 
	`rcv_¬¿y_wc_fžl
(
dd
, 
rcv’Œy
);

1415 
p£t
 = &
æow
->
·ge£ts
[(*
p£t_idx
)++];

1416 ià(
p£t
->
couÁ
) {

1417 
	`hfi1_put_tid
(
dd
, 
rcv’Œy
, 
PT_EXPECTED
,

1418 
p£t
->
addr
, 
	`Œdma_p£t_Üd”
(pset));

1420 
	`hfi1_put_tid
(
dd
, 
rcv’Œy
, 
PT_INVALID
, 0, 0);

1422 
Åages
 +ð
p£t
->
couÁ
;

1424 
rcv’Œy
 -ð
rcd
->
ex³ùed_ba£
;

1425 
tidù¾
 = 
·œ
 ? 0x3 : 
rcv’Œy
 & 0x1 ? 0x2 : 0x1;

1433 
·œ
 = !(
i
 & 0x1è&& !((
node
->
m­
 >> i) & 0x3) &&

1434 
node
->
út
 >= cnt + 2;

1435 ià(!
·œ
) {

1436 ià(!
p£t
->
couÁ
)

1437 
tidù¾
 = 0x1;

1438 
æow
->
tid_’Œy
[æow->
tidút
++] =

1439 
	`EXP_TID_SET
(
IDX
, 
rcv’Œy
 >> 1) |

1440 
	`EXP_TID_SET
(
CTRL
, 
tidù¾
) |

1441 
	`EXP_TID_SET
(
LEN
, 
Åages
);

1442 
	`Œaû_hfi1_tid_’Œy_®loc
(

1443 
æow
->
»q
->
qp
, flow->
tidút
 - 1,

1444 
æow
->
tid_’Œy
[æow->
tidút
 - 1]);

1447 
æow
->
Åkts
 +ð(
Åages
 + 
pmtu_pg
 - 1è>> 
	`žog2
(pmtu_pg);

1448 
Åages
 = 0;

1451 ià(
g½
->
u£d
 =ðg½->
size
 - 1)

1452 
	`tid_group_move
(
g½
, &
rcd
->
tid_u£d_li¡
,

1453 &
rcd
->
tid_fuÎ_li¡
);

1454 ià(!
g½
->
u£d
)

1455 
	`tid_group_move
(
g½
, &
rcd
->
tid_group_li¡
,

1456 &
rcd
->
tid_u£d_li¡
);

1458 
g½
->
u£d
++;

1459 
g½
->
m­
 |ð
	`BIT
(
i
);

1460 
út
++;

1462 
	}
}

1464 
	$k”n_uÅrog¿m_rcv_group
(
tid_rdma_æow
 *
æow
, 
g½_num
)

1466 
hfi1_ùxtd©a
 *
rcd
 = 
æow
->
»q
->rcd;

1467 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1468 
k”n_tid_node
 *
node
 = &
æow
->
Šode
[
g½_num
];

1469 
tid_group
 *
g½
 = 
node
->grp;

1470 
u32
 
rcv’Œy
;

1471 
u8
 
i
, 
út
 = 0;

1473 
i
 = 0; i < 
g½
->
size
; i++) {

1474 
rcv’Œy
 = 
g½
->
ba£
 + 
i
;

1476 ià(
node
->
m­
 & 
	`BIT
(
i
è|| 
út
 >=‚ode->cnt) {

1477 
	`rcv_¬¿y_wc_fžl
(
dd
, 
rcv’Œy
);

1481 
	`hfi1_put_tid
(
dd
, 
rcv’Œy
, 
PT_INVALID
, 0, 0);

1483 
g½
->
u£d
--;

1484 
g½
->
m­
 &ð~
	`BIT
(
i
);

1485 
út
++;

1487 ià(
g½
->
u£d
 =ðg½->
size
 - 1)

1488 
	`tid_group_move
(
g½
, &
rcd
->
tid_fuÎ_li¡
,

1489 &
rcd
->
tid_u£d_li¡
);

1490 ià(!
g½
->
u£d
)

1491 
	`tid_group_move
(
g½
, &
rcd
->
tid_u£d_li¡
,

1492 &
rcd
->
tid_group_li¡
);

1494 ià(
	`WARN_ON_ONCE
(
út
 & 1)) {

1495 
hfi1_ùxtd©a
 *
rcd
 = 
æow
->
»q
->rcd;

1496 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

1498 
	`dd_dev_”r
(
dd
, "unexpected odd free cnt %u map 0x%x used %u",

1499 
út
, 
g½
->
m­
, g½->
u£d
);

1501 
	}
}

1503 
	$k”n_´og¿m_rcv¬¿y
(
tid_rdma_æow
 *
æow
)

1505 
u32
 
p£t_idx
 = 0;

1506 
i
;

1508 
æow
->
Åkts
 = 0;

1509 
æow
->
tidút
 = 0;

1510 
i
 = 0; i < 
æow
->
Šode_út
; i++)

1511 
	`k”n_´og¿m_rcv_group
(
æow
, 
i
, &
p£t_idx
);

1512 
	`Œaû_hfi1_tid_æow_®loc
(
æow
->
»q
->
qp
, flow->»q->
£tup_h—d
, flow);

1513 
	}
}

1557 
	$hfi1_k”n_exp_rcv_£tup
(
tid_rdma_»que¡
 *
»q
,

1558 
rvt_sge_¡©e
 *
ss
, 
boÞ
 *
Ï¡
)

1559 
	`__mu¡_hÞd
(&
»q
->
qp
->
s_lock
)

1561 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[»q->
£tup_h—d
];

1562 
hfi1_ùxtd©a
 *
rcd
 = 
»q
->rcd;

1563 
hfi1_qp_´iv
 *
q´iv
 = 
»q
->
qp
->
´iv
;

1564 
æags
;

1565 
rvt_qp
 *
fqp
;

1566 
u16
 
þ—r_ž
 = 
»q
->clear_tail;

1568 
	`lockd•_as£¹_h–d
(&
»q
->
qp
->
s_lock
);

1575 ià(!
	`CIRC_SPACE
(
»q
->
£tup_h—d
, 
þ—r_ž
, 
MAX_FLOWS
) ||

1576 
	`CIRC_CNT
(
»q
->
£tup_h—d
, 
þ—r_ž
, 
MAX_FLOWS
) >=

1577 
»q
->
n_æows
)

1578  -
EINVAL
;

1585 ià(
	`k”n_g‘_phys_blocks
(
æow
, 
q´iv
->
·ges
, 
ss
, 
Ï¡
)) {

1586 
	`hfi1_wa™_kmem
(
æow
->
»q
->
qp
);

1587  -
ENOMEM
;

1590 
	`¥š_lock_œq§ve
(&
rcd
->
exp_lock
, 
æags
);

1591 ià(
	`k”Ãl_tid_wa™”s
(
rcd
, &rcd->
¿¼_queue
, 
æow
->
»q
->
qp
))

1592 
queue
;

1599 ià(
	`k”n_®loc_tids
(
æow
))

1600 
queue
;

1605 
	`k”n_´og¿m_rcv¬¿y
(
æow
);

1615 
	`mem£t
(&
æow
->
æow_¡©e
, 0x0, (flow->flow_state));

1616 
æow
->
idx
 = 
q´iv
->
æow_¡©e
.
šdex
;

1617 
æow
->
æow_¡©e
.
g’”©iÚ
 = 
q´iv
->flow_state.generation;

1618 
æow
->
æow_¡©e
.
¥¢
 = 
q´iv
->æow_¡©e.
p¢
;

1619 
æow
->
æow_¡©e
.
Í¢
 = flow->æow_¡©e.
¥¢
 + flow->
Åkts
 - 1;

1620 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

1621 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
¥¢
);

1622 
q´iv
->
æow_¡©e
.
p¢
 +ð
æow
->
Åkts
;

1624 
	`dequeue_tid_wa™”
(
rcd
, &rcd->
¿¼_queue
, 
æow
->
»q
->
qp
);

1626 
fqp
 = 
	`fœ¡_qp
(
rcd
, &rcd->
¿¼_queue
);

1627 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

1628 
	`tid_rdma_scheduË_tid_wakeup
(
fqp
);

1630 
»q
->
£tup_h—d
 = (»q->£tup_h—d + 1è& (
MAX_FLOWS
 - 1);

1632 
queue
:

1633 
	`queue_qp_fÜ_tid_wa™
(
rcd
, &rcd->
¿¼_queue
, 
æow
->
»q
->
qp
);

1634 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

1635  -
EAGAIN
;

1636 
	}
}

1638 
	$hfi1_tid_rdma_»£t_æow
(
tid_rdma_æow
 *
æow
)

1640 
æow
->
Åage£ts
 = 0;

1641 
	}
}

1649 
	$hfi1_k”n_exp_rcv_þ—r
(
tid_rdma_»que¡
 *
»q
)

1650 
	`__mu¡_hÞd
(&
»q
->
qp
->
s_lock
)

1652 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

1653 
hfi1_ùxtd©a
 *
rcd
 = 
»q
->rcd;

1654 
æags
;

1655 
i
;

1656 
rvt_qp
 *
fqp
;

1658 
	`lockd•_as£¹_h–d
(&
»q
->
qp
->
s_lock
);

1660 ià(!
	`CIRC_CNT
(
»q
->
£tup_h—d
,„eq->
þ—r_ž
, 
MAX_FLOWS
))

1661  -
EINVAL
;

1663 
	`¥š_lock_œq§ve
(&
rcd
->
exp_lock
, 
æags
);

1665 
i
 = 0; i < 
æow
->
Šode_út
; i++)

1666 
	`k”n_uÅrog¿m_rcv_group
(
æow
, 
i
);

1668 
æow
->
Šode_út
 = 0;

1670 
fqp
 = 
	`fœ¡_qp
(
rcd
, &rcd->
¿¼_queue
);

1671 
	`¥š_uÆock_œq»¡Üe
(&
rcd
->
exp_lock
, 
æags
);

1673 
	`dma_unm­_æow
(
æow
);

1675 
	`hfi1_tid_rdma_»£t_æow
(
æow
);

1676 
»q
->
þ—r_ž
 = (»q->þ—r_ž + 1è& (
MAX_FLOWS
 - 1);

1678 ià(
fqp
 =ð
»q
->
qp
) {

1679 
	`__Œigg”_tid_wa™”
(
fqp
);

1680 
	`rvt_put_qp
(
fqp
);

1682 
	`tid_rdma_scheduË_tid_wakeup
(
fqp
);

1686 
	}
}

1692 
	$hfi1_k”n_exp_rcv_þ—r_®l
(
tid_rdma_»que¡
 *
»q
)

1693 
	`__mu¡_hÞd
(&
»q
->
qp
->
s_lock
)

1696 
	`CIRC_CNT
(
»q
->
£tup_h—d
,„eq->
þ—r_ž
, 
MAX_FLOWS
)) {

1697 ià(
	`hfi1_k”n_exp_rcv_þ—r
(
»q
))

1700 
	}
}

1706 
	$hfi1_k”n_exp_rcv_ä“_æows
(
tid_rdma_»que¡
 *
»q
)

1708 
	`kä“
(
»q
->
æows
);

1709 
»q
->
æows
 = 
NULL
;

1710 
	}
}

1717 
	$__Œdma_þ—n_swqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
)

1719 
hfi1_swqe_´iv
 *
p
 = 
wqe
->
´iv
;

1721 
	`hfi1_k”n_exp_rcv_ä“_æows
(&
p
->
tid_»q
);

1722 
	}
}

1727 
	$hfi1_k”n_exp_rcv_®loc_æows
(
tid_rdma_»que¡
 *
»q
,

1728 
gå_t
 
gå
)

1730 
tid_rdma_æow
 *
æows
;

1731 
i
;

1733 ià(
	`lik–y
(
»q
->
æows
))

1735 
æows
 = 
	`km®loc_node
(
MAX_FLOWS
 * (*æows), 
gå
,

1736 
»q
->
rcd
->
numa_id
);

1737 ià(!
æows
)

1738  -
ENOMEM
;

1740 
i
 = 0; i < 
MAX_FLOWS
; i++) {

1741 
æows
[
i
].
»q
 =„eq;

1742 
æows
[
i
].
Åage£ts
 = 0;

1743 
æows
[
i
].
·ge£ts
[0].
m­³d
 = 0;

1744 
æows
[
i
].
»sync_Åkts
 = 0;

1746 
»q
->
æows
 = flows;

1748 
	}
}

1750 
	$hfi1_š™_Œdma_»q
(
rvt_qp
 *
qp
,

1751 
tid_rdma_»que¡
 *
»q
)

1753 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1765 
»q
->
qp
 = qp;

1766 
»q
->
rcd
 = 
q´iv
->rcd;

1767 
	}
}

1769 
u64
 
	$hfi1_acûss_sw_tid_wa™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

1770 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
)

1772 
hfi1_devd©a
 *
dd
 = 
cÚ‹xt
;

1774  
dd
->
v”bs_dev
.
n_tidwa™
;

1775 
	}
}

1777 
tid_rdma_æow
 *
	$fšd_æow_ib
(
tid_rdma_»que¡
 *
»q
,

1778 
u32
 
p¢
, 
u16
 *
fidx
)

1780 
u16
 
h—d
, 
ž
;

1781 
tid_rdma_æow
 *
æow
;

1783 
h—d
 = 
»q
->
£tup_h—d
;

1784 
ž
 = 
»q
->
þ—r_ž
;

1785  ; 
	`CIRC_CNT
(
h—d
, 
ž
, 
MAX_FLOWS
);

1786 
ž
 = 
	`CIRC_NEXT
Ñaž, 
MAX_FLOWS
)) {

1787 
æow
 = &
»q
->
æows
[
ž
];

1788 ià(
	`cmp_p¢
(
p¢
, 
æow
->
æow_¡©e
.
ib_¥¢
) >= 0 &&

1789 
	`cmp_p¢
(
p¢
, 
æow
->
æow_¡©e
.
ib_Í¢
) <= 0) {

1790 ià(
fidx
)

1791 *
fidx
 = 
ž
;

1792  
æow
;

1795  
NULL
;

1796 
	}
}

1799 
u32
 
	$hfi1_bužd_tid_rdma_»ad_·ck‘
(
rvt_swqe
 *
wqe
,

1800 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

1801 
u32
 *
bth2
, u32 *
Ën
)

1803 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1804 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[»q->
æow_idx
];

1805 
rvt_qp
 *
qp
 = 
»q
->qp;

1806 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1807 
hfi1_swqe_´iv
 *
w´iv
 = 
wqe
->
´iv
;

1808 
tid_rdma_»ad_»q
 *
¼eq
 = &
ohdr
->
u
.
tid_rdma
.
r_»q
;

1809 
tid_rdma_·¿ms
 *
»mÙe
;

1810 
u32
 
»q_Ën
 = 0;

1811 *
»q_addr
 = 
NULL
;

1814 *
bth2
 = 
	`mask_p¢
(
æow
->
æow_¡©e
.
ib_¥¢
 + flow->
pkt
);

1815 
	`Œaû_hfi1_tid_æow_bužd_»ad_pkt
(
qp
, 
»q
->
æow_idx
, 
æow
);

1818 
»q_addr
 = &
æow
->
tid_’Œy
[æow->
tid_idx
];

1819 
»q_Ën
 = (*
æow
->
tid_’Œy
) *

1820 (
æow
->
tidút
 - flow->
tid_idx
);

1822 
	`mem£t
(&
ohdr
->
u
.
tid_rdma
.
r_»q
, 0, (ohdr->u.tid_rdma.r_req));

1823 
w´iv
->
ss
.
sge
.
vaddr
 = 
»q_addr
;

1824 
w´iv
->
ss
.
sge
.
sge_Ëngth
 = 
»q_Ën
;

1825 
w´iv
->
ss
.
sge
.
Ëngth
 = w´iv->ss.sge.
sge_Ëngth
;

1830 
w´iv
->
ss
.
sge
.
mr
 = 
NULL
;

1831 
w´iv
->
ss
.
sge
.
m
 = 0;

1832 
w´iv
->
ss
.
sge
.
n
 = 0;

1834 
w´iv
->
ss
.
sg_li¡
 = 
NULL
;

1835 
w´iv
->
ss
.
tÙ®_Ën
 = w´iv->ss.
sge
.
sge_Ëngth
;

1836 
w´iv
->
ss
.
num_sge
 = 1;

1839 
	`rcu_»ad_lock
();

1840 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

1842 
	`KDETH_RESET
(
¼eq
->
kd‘h0
, 
KVER
, 0x1);

1843 
	`KDETH_RESET
(
¼eq
->
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

1844 
¼eq
->
»th
.
vaddr
 = 
	`ýu_to_be64
(
wqe
->
rdma_wr
.
»mÙe_addr
 +

1845 
»q
->
cur_£g
 *„eq->
£g_Ën
 + 
æow
->
£Á
);

1846 
¼eq
->
»th
.
rkey
 = 
	`ýu_to_be32
(
wqe
->
rdma_wr
.rkey);

1847 
¼eq
->
»th
.
Ëngth
 = 
	`ýu_to_be32
(*
Ën
);

1848 
¼eq
->
tid_æow_p¢
 =

1849 
	`ýu_to_be32
((
æow
->
æow_¡©e
.
g’”©iÚ
 <<

1850 
HFI1_KDETH_BTH_SEQ_SHIFT
) |

1851 ((
æow
->
æow_¡©e
.
¥¢
 + flow->
pkt
) &

1852 
HFI1_KDETH_BTH_SEQ_MASK
));

1853 
¼eq
->
tid_æow_qp
 =

1854 
	`ýu_to_be32
(
q´iv
->
tid_rdma
.
loÿl
.
qp
 |

1855 ((
æow
->
idx
 & 
TID_RDMA_DESTQP_FLOW_MASK
) <<

1856 
TID_RDMA_DESTQP_FLOW_SHIFT
) |

1857 
q´iv
->
rcd
->
ùxt
);

1858 
¼eq
->
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

1859 *
bth1
 &ð~
RVT_QPN_MASK
;

1860 *
bth1
 |ð
»mÙe
->
qp
;

1861 *
bth2
 |ð
IB_BTH_REQ_ACK
;

1862 
	`rcu_»ad_uÆock
();

1865 
æow
->
£Á
 +ð*
Ën
;

1866 
»q
->
cur_£g
++;

1867 
qp
->
s_¡©e
 = 
	`TID_OP
(
READ_REQ
);

1868 
»q
->
ack_³ndšg
++;

1869 
»q
->
æow_idx
 = (»q->æow_idx + 1è& (
MAX_FLOWS
 - 1);

1870 
q´iv
->
³ndšg_tid_r_£gs
++;

1871 
qp
->
s_num_rd_©omic
++;

1874 *
Ën
 = 
»q_Ën
;

1876  (
ohdr
->
u
.
tid_rdma
.
r_»q
è/ (
u32
);

1877 
	}
}

1883 
u32
 
	$hfi1_bužd_tid_rdma_»ad_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

1884 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

1885 
u32
 *
bth2
, u32 *
Ën
)

1886 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

1888 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1889 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

1890 
tid_rdma_æow
 *
æow
 = 
NULL
;

1891 
u32
 
hdwÜds
 = 0;

1892 
boÞ
 
Ï¡
;

1893 
boÞ
 
»Œy
 = 
Œue
;

1894 
u32
 
Åkts
 = 
	`rvt_div_round_up_mtu
(
qp
, *
Ën
);

1896 
	`Œaû_hfi1_tid_»q_bužd_»ad_»q
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

1897 
wqe
->
Í¢
, 
»q
);

1902 
sync_check
:

1903 ià(
»q
->
¡©e
 =ð
TID_REQUEST_SYNC
) {

1904 ià(
q´iv
->
³ndšg_tid_r_£gs
)

1905 
dÚe
;

1907 
	`hfi1_k”n_þ—r_hw_æow
(
»q
->
rcd
, 
qp
);

1908 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_SW_PSN
;

1909 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

1917 ià(
»q
->
æow_idx
 =ð»q->
£tup_h—d
) {

1918 
»Œy
 = 
çl£
;

1919 ià(
»q
->
¡©e
 =ð
TID_REQUEST_RESEND
) {

1925 
	`»¡¬t_sge
(&
qp
->
s_sge
, 
wqe
, 
»q
->
s_Ãxt_p¢
,

1926 
qp
->
pmtu
);

1927 
»q
->
isge
 = 0;

1928 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

1935 ià((
q´iv
->
æow_¡©e
.
p¢
 + 
Åkts
è> 
MAX_TID_FLOW_PSN
 - 1) {

1936 
»q
->
¡©e
 = 
TID_REQUEST_SYNC
;

1937 
sync_check
;

1941 ià(
	`hfi1_k”n_£tup_hw_æow
(
q´iv
->
rcd
, 
qp
))

1942 
dÚe
;

1948 ià(
	`hfi1_k”n_exp_rcv_£tup
(
»q
, &
qp
->
s_sge
, &
Ï¡
)) {

1949 
»q
->
¡©e
 = 
TID_REQUEST_QUEUED
;

1955 
dÚe
;

1960 
æow
 = &
»q
->
æows
[»q->
æow_idx
];

1961 
æow
->
pkt
 = 0;

1962 
æow
->
tid_idx
 = 0;

1963 
æow
->
£Á
 = 0;

1964 ià(!
»Œy
) {

1966 
æow
->
æow_¡©e
.
ib_¥¢
 = 
»q
->
s_Ãxt_p¢
;

1967 
æow
->
æow_¡©e
.
ib_Í¢
 =

1968 
æow
->
æow_¡©e
.
ib_¥¢
 + flow->
Åkts
 - 1;

1972 
»q
->
s_Ãxt_p¢
 +ð
æow
->
Åkts
;

1975 
hdwÜds
 = 
	`hfi1_bužd_tid_rdma_»ad_·ck‘
(
wqe
, 
ohdr
, 
bth1
, 
bth2
, 
Ën
);

1976 
dÚe
:

1977  
hdwÜds
;

1978 
	}
}

1985 
	$tid_rdma_rcv_»ad_»que¡
(
rvt_qp
 *
qp
,

1986 
rvt_ack_’Œy
 *
e
,

1987 
hfi1_·ck‘
 *
·ck‘
,

1988 
ib_Ùh”_h—d”s
 *
ohdr
,

1989 
u32
 
bth0
, u32 
p¢
, 
u64
 
vaddr
, u32 
Ën
)

1991 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

1992 
tid_rdma_»que¡
 *
»q
;

1993 
tid_rdma_æow
 *
æow
;

1994 
u32
 
æow_p¢
, 
i
, 
tidËn
 = 0, 
pkŽ’
, 
Ž’
;

1996 
»q
 = 
	`ack_to_tid_»q
(
e
);

1999 
æow
 = &
»q
->
æows
[»q->
£tup_h—d
];

2002 
pkŽ’
 = 
·ck‘
->
Ž’
 - (·ck‘->
hËn
 + 4);

2003 ià(
pkŽ’
 > (
æow
->
tid_’Œy
))

2005 
	`memýy
(
æow
->
tid_’Œy
, 
·ck‘
->
ebuf
, 
pkŽ’
);

2006 
æow
->
tidút
 = 
pkŽ’
 / (*æow->
tid_’Œy
);

2012 
æow
->
Åkts
 = 
	`rvt_div_round_up_mtu
(
qp
, 
Ën
);

2013 
i
 = 0; i < 
æow
->
tidút
; i++) {

2014 
	`Œaû_hfi1_tid_’Œy_rcv_»ad_»q
(
qp
, 
i
,

2015 
æow
->
tid_’Œy
[
i
]);

2016 
Ž’
 = 
	`EXP_TID_GET
(
æow
->
tid_’Œy
[
i
], 
LEN
);

2017 ià(!
Ž’
)

2026 
tidËn
 +ð
Ž’
;

2028 ià(
tidËn
 * 
PAGE_SIZE
 < 
Ën
)

2032 
»q
->
þ—r_ž
 =„eq->
£tup_h—d
;

2033 
æow
->
pkt
 = 0;

2034 
æow
->
tid_idx
 = 0;

2035 
æow
->
tid_off£t
 = 0;

2036 
æow
->
£Á
 = 0;

2037 
æow
->
tid_q²
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_»q
.
tid_æow_qp
);

2038 
æow
->
idx
 = (æow->
tid_q²
 >> 
TID_RDMA_DESTQP_FLOW_SHIFT
) &

2039 
TID_RDMA_DESTQP_FLOW_MASK
;

2040 
æow_p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_»q
.
tid_æow_p¢
));

2041 
æow
->
æow_¡©e
.
g’”©iÚ
 = 
æow_p¢
 >> 
HFI1_KDETH_BTH_SEQ_SHIFT
;

2042 
æow
->
æow_¡©e
.
¥¢
 = 
æow_p¢
 & 
HFI1_KDETH_BTH_SEQ_MASK
;

2043 
æow
->
Ëngth
 = 
Ën
;

2045 
æow
->
æow_¡©e
.
Í¢
 = flow->æow_¡©e.
¥¢
 +

2046 
æow
->
Åkts
 - 1;

2047 
æow
->
æow_¡©e
.
ib_¥¢
 = 
p¢
;

2048 
æow
->
æow_¡©e
.
ib_Í¢
 = flow->æow_¡©e.
ib_¥¢
 + flow->
Åkts
 - 1;

2050 
	`Œaû_hfi1_tid_æow_rcv_»ad_»q
(
qp
, 
»q
->
£tup_h—d
, 
æow
);

2052 
»q
->
æow_idx
 =„eq->
£tup_h—d
;

2055 
»q
->
£tup_h—d
 = (»q->£tup_h—d + 1è& (
MAX_FLOWS
 - 1);

2060 
e
->
Ýcode
 = (
bth0
 >> 24) & 0xff;

2061 
e
->
p¢
 =…sn;

2062 
e
->
Í¢
 = 
p¢
 + 
æow
->
Åkts
 - 1;

2063 
e
->
£Á
 = 0;

2065 
»q
->
n_æows
 = 
q´iv
->
tid_rdma
.
loÿl
.
max_»ad
;

2066 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

2067 
»q
->
cur_£g
 = 0;

2068 
»q
->
comp_£g
 = 0;

2069 
»q
->
ack_£g
 = 0;

2070 
»q
->
isge
 = 0;

2071 
»q
->
£g_Ën
 = 
q´iv
->
tid_rdma
.
loÿl
.
max_Ën
;

2072 
»q
->
tÙ®_Ën
 = 
Ën
;

2073 
»q
->
tÙ®_£gs
 = 1;

2074 
»q
->
r_æow_p¢
 = 
e
->
p¢
;

2076 
	`Œaû_hfi1_tid_»q_rcv_»ad_»q
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

2077 
»q
);

2079 
	}
}

2081 
	$tid_rdma_rcv_”rÜ
(
hfi1_·ck‘
 *
·ck‘
,

2082 
ib_Ùh”_h—d”s
 *
ohdr
,

2083 
rvt_qp
 *
qp
, 
u32
 
p¢
, 
diff
)

2085 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

2086 
hfi1_ùxtd©a
 *
rcd
 = ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->rcd;

2087 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

2088 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

2089 
rvt_ack_’Œy
 *
e
;

2090 
tid_rdma_»que¡
 *
»q
;

2091 
æags
;

2092 
u8
 
´ev
;

2093 
boÞ
 
Þd_»q
;

2095 
	`Œaû_hfi1_r¥_tid_rcv_”rÜ
(
qp
, 
p¢
);

2096 
	`Œaû_hfi1_tid_rdma_rcv_”r
(
qp
, 0, 
p¢
, 
diff
);

2097 ià(
diff
 > 0) {

2099 ià(!
qp
->
r_Çk_¡©e
) {

2100 
ibp
->
rvp
.
n_rc_£qÇk
++;

2101 
qp
->
r_Çk_¡©e
 = 
IB_NAK_PSN_ERROR
;

2102 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

2103 
	`rc_deã»d_ack
(
rcd
, 
qp
);

2105 
dÚe
;

2108 
ibp
->
rvp
.
n_rc_du´eq
++;

2110 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

2111 
e
 = 
	`fšd_´ev_’Œy
(
qp
, 
p¢
, &
´ev
, 
NULL
, &
Þd_»q
);

2112 ià(!
e
 || (e->
Ýcode
 !ð
	`TID_OP
(
READ_REQ
) &&

2113 
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
)))

2114 
uÆock
;

2116 
»q
 = 
	`ack_to_tid_»q
(
e
);

2117 
»q
->
r_æow_p¢
 = 
p¢
;

2118 
	`Œaû_hfi1_tid_»q_rcv_”r
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
, 
»q
);

2119 ià(
e
->
Ýcode
 =ð
	`TID_OP
(
READ_REQ
)) {

2120 
ib_»th
 *
»th
;

2121 
u32
 
Ën
;

2122 
u32
 
rkey
;

2123 
u64
 
vaddr
;

2124 
ok
;

2125 
u32
 
bth0
;

2127 
»th
 = &
ohdr
->
u
.
tid_rdma
.
r_»q
.reth;

2132 
Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

2133 ià(
p¢
 !ð
e
->p¢ || 
Ën
 !ð
»q
->
tÙ®_Ën
)

2134 
uÆock
;

2136 
	`»Ëa£_rdma_sge_mr
(
e
);

2138 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

2139 
vaddr
 = 
	`g‘_ib_»th_vaddr
(
»th
);

2141 
qp
->
r_Ën
 = 
Ën
;

2142 
ok
 = 
	`rvt_rkey_ok
(
qp
, &
e
->
rdma_sge
, 
Ën
, 
vaddr
, 
rkey
,

2143 
IB_ACCESS_REMOTE_READ
);

2144 ià(
	`uÆik–y
(!
ok
))

2145 
uÆock
;

2157 
bth0
 = 
	`be32_to_ýu
(
ohdr
->
bth
[0]);

2158 ià(
	`tid_rdma_rcv_»ad_»que¡
(
qp
, 
e
, 
·ck‘
, 
ohdr
, 
bth0
, 
p¢
,

2159 
vaddr
, 
Ën
))

2160 
uÆock
;

2166 ià(
Þd_»q
)

2167 
uÆock
;

2169 
æow_¡©e
 *
f¡©e
;

2170 
boÞ
 
scheduË
 = 
çl£
;

2171 
u8
 
i
;

2173 ià(
»q
->
¡©e
 =ð
TID_REQUEST_RESEND
) {

2174 
»q
->
¡©e
 = 
TID_REQUEST_RESEND_ACTIVE
;

2175 } ià(
»q
->
¡©e
 =ð
TID_REQUEST_INIT_RESEND
) {

2176 
»q
->
¡©e
 = 
TID_REQUEST_INIT
;

2177 
scheduË
 = 
Œue
;

2187 ià(
Þd_»q
 || 
»q
->
¡©e
 =ð
TID_REQUEST_INIT
 ||

2188 (
»q
->
¡©e
 =ð
TID_REQUEST_SYNC
 && !»q->
cur_£g
)) {

2189 
i
 = 
´ev
 + 1; ; i++) {

2190 ià(
i
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

2191 
i
 = 0;

2192 ià(
i
 =ð
qp
->
r_h—d_ack_queue
)

2194 
e
 = &
qp
->
s_ack_queue
[
i
];

2195 
»q
 = 
	`ack_to_tid_»q
(
e
);

2196 ià(
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
) &&

2197 
»q
->
¡©e
 =ð
TID_REQUEST_INIT
)

2198 
»q
->
¡©e
 = 
TID_REQUEST_INIT_RESEND
;

2206 ià(!
scheduË
)

2207 
uÆock
;

2214 ià(
»q
->
þ—r_ž
 =ð»q->
£tup_h—d
)

2215 
scheduË
;

2222 ià(
	`CIRC_CNT
(
»q
->
æow_idx
,„eq->
þ—r_ž
, 
MAX_FLOWS
)) {

2223 
f¡©e
 = &
»q
->
æows
[»q->
þ—r_ž
].
æow_¡©e
;

2224 
q´iv
->
³ndšg_tid_w_£gs
 -=

2225 
	`CIRC_CNT
(
»q
->
æow_idx
,„eq->
þ—r_ž
,

2226 
MAX_FLOWS
);

2227 
»q
->
æow_idx
 =

2228 
	`CIRC_ADD
(
»q
->
þ—r_ž
,

2229 
	`d–_p¢
(
p¢
, 
f¡©e
->
»¥_ib_p¢
),

2230 
MAX_FLOWS
);

2231 
q´iv
->
³ndšg_tid_w_£gs
 +=

2232 
	`d–_p¢
(
p¢
, 
f¡©e
->
»¥_ib_p¢
);

2240 ià(
	`CIRC_CNT
(
»q
->
£tup_h—d
,„eq->
æow_idx
,

2241 
MAX_FLOWS
)) {

2242 
»q
->
cur_£g
 = 
	`d–_p¢
(
p¢
, 
e
->psn);

2243 
»q
->
¡©e
 = 
TID_REQUEST_RESEND_ACTIVE
;

2247 
i
 = 
´ev
 + 1; ; i++) {

2252 ià(
i
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

2253 
i
 = 0;

2254 ià(
i
 =ð
qp
->
r_h—d_ack_queue
)

2256 
e
 = &
qp
->
s_ack_queue
[
i
];

2257 
»q
 = 
	`ack_to_tid_»q
(
e
);

2258 
	`Œaû_hfi1_tid_»q_rcv_”r
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,

2259 
e
->
Í¢
, 
»q
);

2260 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
) ||

2261 
»q
->
cur_£g
 =ð»q->
comp_£g
 ||

2262 
»q
->
¡©e
 =ð
TID_REQUEST_INIT
 ||

2263 
»q
->
¡©e
 =ð
TID_REQUEST_INIT_RESEND
) {

2264 ià(
»q
->
¡©e
 =ð
TID_REQUEST_INIT
)

2265 
»q
->
¡©e
 = 
TID_REQUEST_INIT_RESEND
;

2268 
q´iv
->
³ndšg_tid_w_£gs
 -=

2269 
	`CIRC_CNT
(
»q
->
æow_idx
,

2270 
»q
->
þ—r_ž
,

2271 
MAX_FLOWS
);

2272 
»q
->
æow_idx
 =„eq->
þ—r_ž
;

2273 
»q
->
¡©e
 = 
TID_REQUEST_RESEND
;

2274 
»q
->
cur_£g
 =„eq->
comp_£g
;

2276 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_WAIT_INTERLCK
;

2279 ià(
qp
->
s_acked_ack_queue
 =ðqp->
s_ž_ack_queue
)

2280 
qp
->
s_acked_ack_queue
 = 
´ev
;

2281 
qp
->
s_ž_ack_queue
 = 
´ev
;

2288 
qp
->
s_ack_¡©e
 = 
	`OP
(
ACKNOWLEDGE
);

2289 
scheduË
:

2294 ià(
q´iv
->
ºr_Çk_¡©e
) {

2295 
qp
->
s_Çk_¡©e
 = 0;

2296 
q´iv
->
ºr_Çk_¡©e
 = 
TID_RNR_NAK_INIT
;

2297 
qp
->
r_p¢
 = 
e
->
Í¢
 + 1;

2298 
	`hfi1_tid_wr™e_®loc_»sourûs
(
qp
, 
Œue
);

2301 
qp
->
r_¡©e
 = 
e
->
Ýcode
;

2302 
qp
->
r_Çk_¡©e
 = 0;

2303 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

2304 
	`hfi1_scheduË_£nd
(
qp
);

2305 
uÆock
:

2306 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2307 
dÚe
:

2309 
	}
}

2311 
	$hfi1_rc_rcv_tid_rdma_»ad_»q
(
hfi1_·ck‘
 *
·ck‘
)

2326 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

2327 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2328 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

2329 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

2330 
rvt_ack_’Œy
 *
e
;

2331 
æags
;

2332 
ib_»th
 *
»th
;

2333 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

2334 
u32
 
bth0
, 
p¢
, 
Ën
, 
rkey
;

2335 
boÞ
 
ãú
;

2336 
u8
 
Ãxt
;

2337 
u64
 
vaddr
;

2338 
diff
;

2339 
u8
 
Çck_¡©e
 = 
IB_NAK_INVALID_REQUEST
;

2341 
bth0
 = 
	`be32_to_ýu
(
ohdr
->
bth
[0]);

2342 ià(
	`hfi1_ruc_check_hdr
(
ibp
, 
·ck‘
))

2345 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

2346 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

2347 
	`Œaû_hfi1_r¥_rcv_tid_»ad_»q
(
qp
, 
p¢
);

2349 ià(
qp
->
¡©e
 =ð
IB_QPS_RTR
 && !(qp->
r_æags
 & 
RVT_R_COMM_EST
))

2350 
	`rvt_comm_e¡
(
qp
);

2352 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 & 
IB_ACCESS_REMOTE_READ
)))

2353 
Çck_šv
;

2355 
»th
 = &
ohdr
->
u
.
tid_rdma
.
r_»q
.reth;

2356 
vaddr
 = 
	`be64_to_ýu
(
»th
->vaddr);

2357 
Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

2359 ià(!
Ën
 ||†’ & ~
PAGE_MASK
 ||†’ > 
q´iv
->
tid_rdma
.
loÿl
.
max_Ën
)

2360 
Çck_šv
;

2362 
diff
 = 
	`d–_p¢
(
p¢
, 
qp
->
r_p¢
);

2363 ià(
	`uÆik–y
(
diff
)) {

2364 
	`tid_rdma_rcv_”r
(
·ck‘
, 
ohdr
, 
qp
, 
p¢
, 
diff
, 
ãú
);

2369 
Ãxt
 = 
qp
->
r_h—d_ack_queue
 + 1;

2370 ià(
Ãxt
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

2371 
Ãxt
 = 0;

2372 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

2373 ià(
	`uÆik–y
(
Ãxt
 =ð
qp
->
s_ž_ack_queue
)) {

2374 ià(!
qp
->
s_ack_queue
[
Ãxt
].
£Á
) {

2375 
Çck_¡©e
 = 
IB_NAK_REMOTE_OPERATIONAL_ERROR
;

2376 
Çck_šv_uÆock
;

2378 
	`upd©e_ack_queue
(
qp
, 
Ãxt
);

2380 
e
 = &
qp
->
s_ack_queue
[qp->
r_h—d_ack_queue
];

2381 
	`»Ëa£_rdma_sge_mr
(
e
);

2383 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

2384 
qp
->
r_Ën
 = 
Ën
;

2386 ià(
	`uÆik–y
(!
	`rvt_rkey_ok
(
qp
, &
e
->
rdma_sge
, qp->
r_Ën
, 
vaddr
,

2387 
rkey
, 
IB_ACCESS_REMOTE_READ
)))

2388 
Çck_acc
;

2391 ià(
	`tid_rdma_rcv_»ad_»que¡
(
qp
, 
e
, 
·ck‘
, 
ohdr
, 
bth0
, 
p¢
, 
vaddr
,

2392 
Ën
))

2393 
Çck_šv_uÆock
;

2395 
qp
->
r_¡©e
 = 
e
->
Ýcode
;

2396 
qp
->
r_Çk_¡©e
 = 0;

2402 
qp
->
r_m¢
++;

2403 
qp
->
r_p¢
 +ð
e
->
Í¢
 -ƒ->
p¢
 + 1;

2405 
qp
->
r_h—d_ack_queue
 = 
Ãxt
;

2413 
q´iv
->
r_tid_®loc
 = 
qp
->
r_h—d_ack_queue
;

2416 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

2417 ià(
ãú
)

2418 
qp
->
s_æags
 |ð
RVT_S_ECN
;

2419 
	`hfi1_scheduË_£nd
(
qp
);

2421 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2424 
Çck_šv_uÆock
:

2425 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2426 
Çck_šv
:

2427 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

2428 
qp
->
r_Çk_¡©e
 = 
Çck_¡©e
;

2429 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

2431 
	`rc_deã»d_ack
(
rcd
, 
qp
);

2433 
Çck_acc
:

2434 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2435 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_PROT_ERR
);

2436 
qp
->
r_Çk_¡©e
 = 
IB_NAK_REMOTE_ACCESS_ERROR
;

2437 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

2438 
	}
}

2440 
u32
 
	$hfi1_bužd_tid_rdma_»ad_»¥
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

2441 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth0
,

2442 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
, 
boÞ
 *
Ï¡
)

2444 
hfi1_ack_´iv
 *
•riv
 = 
e
->
´iv
;

2445 
tid_rdma_»que¡
 *
»q
 = &
•riv
->
tid_»q
;

2446 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

2447 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

2448 
u32
 
tid’Œy
 = 
æow
->
tid_’Œy
[æow->
tid_idx
];

2449 
u32
 
tidËn
 = 
	`EXP_TID_GET
(
tid’Œy
, 
LEN
è<< 
PAGE_SHIFT
;

2450 
tid_rdma_»ad_»¥
 *
»¥
 = &
ohdr
->
u
.
tid_rdma
.
r_r¥
;

2451 
u32
 
Ãxt_off£t
, 
om
 = 
KDETH_OM_LARGE
;

2452 
boÞ
 
Ï¡_pkt
;

2453 
u32
 
hdwÜds
 = 0;

2454 
tid_rdma_·¿ms
 *
»mÙe
;

2456 *
Ën
 = 
	`mš_t
(
u32
, 
qp
->
pmtu
, 
tidËn
 - 
æow
->
tid_off£t
);

2457 
æow
->
£Á
 +ð*
Ën
;

2458 
Ãxt_off£t
 = 
æow
->
tid_off£t
 + *
Ën
;

2459 
Ï¡_pkt
 = (
æow
->
£Á
 >ðæow->
Ëngth
);

2461 
	`Œaû_hfi1_tid_’Œy_bužd_»ad_»¥
(
qp
, 
æow
->
tid_idx
, 
tid’Œy
);

2462 
	`Œaû_hfi1_tid_æow_bužd_»ad_»¥
(
qp
, 
»q
->
þ—r_ž
, 
æow
);

2464 
	`rcu_»ad_lock
();

2465 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

2466 ià(!
»mÙe
) {

2467 
	`rcu_»ad_uÆock
();

2468 
dÚe
;

2470 
	`KDETH_RESET
(
»¥
->
kd‘h0
, 
KVER
, 0x1);

2471 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
SH
, !
Ï¡_pkt
);

2472 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
INTR
, !!(!
Ï¡_pkt
 && 
»mÙe
->
urg
));

2473 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
TIDCTRL
, 
	`EXP_TID_GET
(
tid’Œy
, 
CTRL
));

2474 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
TID
, 
	`EXP_TID_GET
(
tid’Œy
, 
IDX
));

2475 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
OM
, 
om
 =ð
KDETH_OM_LARGE
);

2476 
	`KDETH_SET
(
»¥
->
kd‘h0
, 
OFFSET
, 
æow
->
tid_off£t
 / 
om
);

2477 
	`KDETH_RESET
(
»¥
->
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

2478 
»¥
->
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

2479 
	`rcu_»ad_uÆock
();

2481 
»¥
->
«th
 = 
	`rvt_compu‹_«th
(
qp
);

2482 
»¥
->
v”bs_p¢
 = 
	`ýu_to_be32
(
	`mask_p¢
(
æow
->
æow_¡©e
.
ib_¥¢
 +

2483 
æow
->
pkt
));

2485 *
bth0
 = 
	`TID_OP
(
READ_RESP
) << 24;

2486 *
bth1
 = 
æow
->
tid_q²
;

2487 *
bth2
 = 
	`mask_p¢
(((
æow
->
æow_¡©e
.
¥¢
 + flow->
pkt
++) &

2488 
HFI1_KDETH_BTH_SEQ_MASK
) |

2489 (
æow
->
æow_¡©e
.
g’”©iÚ
 <<

2490 
HFI1_KDETH_BTH_SEQ_SHIFT
));

2491 *
Ï¡
 = 
Ï¡_pkt
;

2492 ià(
Ï¡_pkt
)

2494 
»q
->
þ—r_ž
 = (req->clear_tail + 1) &

2495 (
MAX_FLOWS
 - 1);

2497 ià(
Ãxt_off£t
 >ð
tidËn
) {

2498 
æow
->
tid_off£t
 = 0;

2499 
æow
->
tid_idx
++;

2501 
æow
->
tid_off£t
 = 
Ãxt_off£t
;

2504 
hdwÜds
 = (
ohdr
->
u
.
tid_rdma
.
r_r¥
è/ (
u32
);

2506 
dÚe
:

2507  
hdwÜds
;

2508 
	}
}

2510 
šlše
 
tid_rdma_»que¡
 *

2511 
	$fšd_tid_»que¡
(
rvt_qp
 *
qp
, 
u32
 
p¢
, 
ib_wr_Ýcode
 
Ýcode
)

2512 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

2514 
rvt_swqe
 *
wqe
;

2515 
tid_rdma_»que¡
 *
»q
 = 
NULL
;

2516 
u32
 
i
, 
’d
;

2518 
’d
 = 
qp
->
s_cur
 + 1;

2519 ià(
’d
 =ð
qp
->
s_size
)

2520 
’d
 = 0;

2521 
i
 = 
qp
->
s_acked
; i !ð
’d
;) {

2522 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

2523 ià(
	`cmp_p¢
(
p¢
, 
wqe
->psn) >= 0 &&

2524 
	`cmp_p¢
(
p¢
, 
wqe
->
Í¢
) <= 0) {

2525 ià(
wqe
->
wr
.
Ýcode
 == opcode)

2526 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

2529 ià(++
i
 =ð
qp
->
s_size
)

2530 
i
 = 0;

2533  
»q
;

2534 
	}
}

2536 
	$hfi1_rc_rcv_tid_rdma_»ad_»¥
(
hfi1_·ck‘
 *
·ck‘
)

2547 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

2548 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2549 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

2550 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

2551 
tid_rdma_»que¡
 *
»q
;

2552 
tid_rdma_æow
 *
æow
;

2553 
u32
 
Ýcode
, 
«th
;

2554 
boÞ
 
ãú
;

2555 
æags
;

2556 
u32
 
kp¢
, 
¢
;

2558 
	`Œaû_hfi1_£nd”_rcv_tid_»ad_»¥
(
qp
);

2559 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

2560 
kp¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

2561 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_r¥
.aeth);

2562 
Ýcode
 = (
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24) & 0xff;

2564 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

2565 
¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_r¥
.
v”bs_p¢
));

2566 
»q
 = 
	`fšd_tid_»que¡
(
qp
, 
¢
, 
IB_WR_TID_RDMA_READ
);

2567 ià(
	`uÆik–y
(!
»q
))

2568 
ack_Ý_”r
;

2570 
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

2572 ià(
	`cmp_p¢
(
¢
, 
æow
->
æow_¡©e
.
ib_Í¢
)) {

2573 
	`upd©e_r_Ãxt_p¢_ãú
(
·ck‘
, 
´iv
, 
rcd
, 
æow
, 
ãú
);

2575 ià(
	`cmp_p¢
(
kp¢
, 
æow
->
æow_¡©e
.
r_Ãxt_p¢
))

2576 
ack_dÚe
;

2577 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 = 
	`mask_p¢
(
kp¢
 + 1);

2585 ià(
ãú
 && 
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_EAGER
) {

2586 
rvt_sge_¡©e
 
ss
;

2587 
u32
 
Ën
;

2588 
u32
 
Ž’
 = 
·ck‘
->tlen;

2589 
u16
 
hdrsize
 = 
·ck‘
->
hËn
;

2590 
u8
 
·d
 = 
·ck‘
->pad;

2591 
u8
 
exŒa_by‹s
 = 
·d
 + 
·ck‘
->
exŒa_by‹
 +

2592 (
SIZE_OF_CRC
 << 2);

2593 
u32
 
pmtu
 = 
qp
->pmtu;

2595 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 
exŒa_by‹s
)))

2596 
ack_Ý_”r
;

2597 
Ën
 = 
	`»¡¬t_sge
(&
ss
, 
»q
->
e
.
swqe
, 
¢
, 
pmtu
);

2598 ià(
	`uÆik–y
(
Ën
 < 
pmtu
))

2599 
ack_Ý_”r
;

2600 
	`rvt_cÝy_sge
(
qp
, &
ss
, 
·ck‘
->
·ylßd
, 
pmtu
, 
çl£
,

2601 
çl£
);

2603 
´iv
->
s_æags
 |ð
HFI1_R_TID_SW_PSN
;

2606 
ack_dÚe
;

2608 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 = 
	`mask_p¢
(
kp¢
 + 1);

2609 
»q
->
ack_³ndšg
--;

2610 
´iv
->
³ndšg_tid_r_£gs
--;

2611 
qp
->
s_num_rd_©omic
--;

2612 ià((
qp
->
s_æags
 & 
RVT_S_WAIT_FENCE
) &&

2613 !
qp
->
s_num_rd_©omic
) {

2614 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_FENCE
 |

2615 
RVT_S_WAIT_ACK
);

2616 
	`hfi1_scheduË_£nd
(
qp
);

2618 ià(
qp
->
s_æags
 & 
RVT_S_WAIT_RDMAR
) {

2619 
qp
->
s_æags
 &ð~(
RVT_S_WAIT_RDMAR
 | 
RVT_S_WAIT_ACK
);

2620 
	`hfi1_scheduË_£nd
(
qp
);

2623 
	`Œaû_hfi1_ack
(
qp
, 
¢
);

2624 
	`Œaû_hfi1_tid_»q_rcv_»ad_»¥
(
qp
, 0, 
»q
->
e
.
swqe
->
wr
.
Ýcode
,

2625 
»q
->
e
.
swqe
->
p¢
,„eq->e.swqe->
Í¢
,

2626 
»q
);

2627 
	`Œaû_hfi1_tid_æow_rcv_»ad_»¥
(
qp
, 
»q
->
þ—r_ž
, 
æow
);

2630 
	`hfi1_k”n_exp_rcv_þ—r
(
»q
);

2632 ià(!
	`do_rc_ack
(
qp
, 
«th
, 
¢
, 
Ýcode
, 0, 
rcd
))

2633 
ack_dÚe
;

2636 ià(++
»q
->
comp_£g
 >ð»q->
tÙ®_£gs
) {

2637 
´iv
->
tid_r_comp
++;

2638 
»q
->
¡©e
 = 
TID_REQUEST_COMPLETE
;

2646 ià((
»q
->
¡©e
 =ð
TID_REQUEST_SYNC
 &&

2647 
»q
->
comp_£g
 =ð»q->
cur_£g
) ||

2648 
´iv
->
tid_r_comp
 =ð´iv->
tid_r_»qs
) {

2649 
	`hfi1_k”n_þ—r_hw_æow
(
´iv
->
rcd
, 
qp
);

2650 
´iv
->
s_æags
 &ð~
HFI1_R_TID_SW_PSN
;

2651 ià(
»q
->
¡©e
 =ð
TID_REQUEST_SYNC
)

2652 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

2655 
	`hfi1_scheduË_£nd
(
qp
);

2656 
ack_dÚe
;

2658 
ack_Ý_”r
:

2667 ià(
qp
->
s_Ï¡
 =ðqp->
s_acked
)

2668 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

2670 
ack_dÚe
:

2671 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

2672 
	}
}

2674 
	$hfi1_k”n_»ad_tid_æow_ä“
(
rvt_qp
 *
qp
)

2675 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

2677 
u32
 
n
 = 
qp
->
s_acked
;

2678 
rvt_swqe
 *
wqe
;

2679 
tid_rdma_»que¡
 *
»q
;

2680 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

2682 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

2684 
n
 !ð
qp
->
s_ž
) {

2685 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
n
);

2686 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

2687 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

2688 
	`hfi1_k”n_exp_rcv_þ—r_®l
(
»q
);

2691 ià(++
n
 =ð
qp
->
s_size
)

2692 
n
 = 0;

2695 
	`hfi1_k”n_þ—r_hw_æow
(
´iv
->
rcd
, 
qp
);

2696 
	}
}

2698 
boÞ
 
	$tid_rdma_tid_”r
(
hfi1_·ck‘
 *
·ck‘
, 
u8
 
rcv_ty³
)

2700 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2702 ià(
rcv_ty³
 >ð
RHF_RCV_TYPE_IB
)

2703 
dÚe
;

2705 
	`¥š_lock
(&
qp
->
s_lock
);

2714 ià(
rcv_ty³
 =ð
RHF_RCV_TYPE_EAGER
) {

2715 
	`hfi1_»¡¬t_rc
(
qp
, qp->
s_Ï¡_p¢
 + 1, 1);

2716 
	`hfi1_scheduË_£nd
(
qp
);

2720 
	`¥š_uÆock
(&
qp
->
s_lock
);

2721 
dÚe
:

2722  
Œue
;

2723 
	}
}

2725 
	$»¡¬t_tid_rdma_»ad_»q
(
hfi1_ùxtd©a
 *
rcd
,

2726 
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
)

2728 
tid_rdma_»que¡
 *
»q
;

2729 
tid_rdma_æow
 *
æow
;

2732 
qp
->
r_æags
 |ð
RVT_R_RDMAR_SEQ
;

2733 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

2734 
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

2735 
	`hfi1_»¡¬t_rc
(
qp
, 
æow
->
æow_¡©e
.
ib_¥¢
, 0);

2736 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
)) {

2737 
qp
->
r_æags
 |ð
RVT_R_RSP_SEND
;

2738 
	`rvt_g‘_qp
(
qp
);

2739 
	`li¡_add_ž
(&
qp
->
r¥wa™
, &
rcd
->
qp_wa™_li¡
);

2741 
	}
}

2751 
boÞ
 
	$hªdË_»ad_kd‘h_eæags
(
hfi1_ùxtd©a
 *
rcd
,

2752 
hfi1_·ck‘
 *
·ck‘
, 
u8
 
rcv_ty³
,

2753 
u8
 
¹e
, 
u32
 
p¢
, u32 
ibp¢
)

2754 
	`__mu¡_hÞd
(&
·ck‘
->
qp
->
r_lock
è
	$__mu¡_hÞd
(
RCU
)

2756 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

2757 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

2758 
hfi1_ibpÜt
 *
ibp
;

2759 
rvt_swqe
 *
wqe
;

2760 
tid_rdma_»que¡
 *
»q
;

2761 
tid_rdma_æow
 *
æow
;

2762 
u32
 
ack_p¢
;

2763 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2764 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

2765 
boÞ
 
»t
 = 
Œue
;

2766 
diff
 = 0;

2767 
u32
 
å¢
;

2769 
	`lockd•_as£¹_h–d
(&
qp
->
r_lock
);

2770 
	`Œaû_hfi1_r¥_»ad_kd‘h_eæags
(
qp
, 
ibp¢
);

2771 
	`Œaû_hfi1_£nd”_»ad_kd‘h_eæags
(
qp
);

2772 
	`Œaû_hfi1_tid_»ad_£nd”_kd‘h_eæags
(
qp
, 0);

2773 
	`¥š_lock
(&
qp
->
s_lock
);

2775 ià(
	`cmp_p¢
(
ibp¢
, 
qp
->
s_Ï¡_p¢
) < 0 ||

2776 
	`cmp_p¢
(
ibp¢
, 
qp
->
s_p¢
) > 0)

2777 
s_uÆock
;

2784 
ack_p¢
 = 
ibp¢
 - 1;

2785 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

2786 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

2789 ()
	`d–_p¢
(
ack_p¢
, 
wqe
->
Í¢
) >= 0) {

2795 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

2796 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
 ||

2797 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_CMP_AND_SWP
 ||

2798 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_ATOMIC_FETCH_AND_ADD
) {

2800 ià(!(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
)) {

2801 
qp
->
r_æags
 |ð
RVT_R_RDMAR_SEQ
;

2802 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

2803 
	`»¡¬t_tid_rdma_»ad_»q
(
rcd
, 
qp
,

2804 
wqe
);

2806 
	`hfi1_»¡¬t_rc
(
qp
, qp->
s_Ï¡_p¢
 + 1,

2808 ià(
	`li¡_em±y
(&
qp
->
r¥wa™
)) {

2809 
qp
->
r_æags
 |ð
RVT_R_RSP_SEND
;

2810 
	`rvt_g‘_qp
(
qp
);

2811 
	`li¡_add_ž
(

2812 &
qp
->
r¥wa™
,

2813 &
rcd
->
qp_wa™_li¡
);

2824 
wqe
 = 
	`do_rc_com¶‘iÚ
(
qp
, wqe, 
ibp
);

2825 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

2826 
s_uÆock
;

2829 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

2830 
s_uÆock
;

2833 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
)

2834 
s_uÆock
;

2836 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

2837 
	`Œaû_hfi1_tid_»q_»ad_kd‘h_eæags
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

2838 
wqe
->
Í¢
, 
»q
);

2839 
rcv_ty³
) {

2840 
RHF_RCV_TYPE_EXPECTED
:

2841 
¹e
) {

2842 
RHF_RTE_EXPECTED_FLOW_SEQ_ERR
:

2852 
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

2853 
	`Œaû_hfi1_tid_æow_»ad_kd‘h_eæags
(
qp
,

2854 
»q
->
þ—r_ž
,

2855 
æow
);

2856 ià(
´iv
->
s_æags
 & 
HFI1_R_TID_SW_PSN
) {

2857 
diff
 = 
	`cmp_p¢
(
p¢
,

2858 
æow
->
æow_¡©e
.
r_Ãxt_p¢
);

2859 ià(
diff
 > 0) {

2861 
s_uÆock
;

2862 } ià(
diff
 < 0) {

2868 ià(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
)

2869 
qp
->
r_æags
 &=

2870 ~
RVT_R_RDMAR_SEQ
;

2873 
s_uÆock
;

2881 
å¢
 = 
	`fuÎ_æow_p¢
(
æow
,

2882 
æow
->
æow_¡©e
.
Í¢
);

2883 ià(
	`cmp_p¢
(
å¢
, 
p¢
) == 0) {

2884 
»t
 = 
çl£
;

2885 ià(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
)

2886 
qp
->
r_æags
 &=

2887 ~
RVT_R_RDMAR_SEQ
;

2889 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

2890 
	`mask_p¢
(
p¢
 + 1);

2892 
u32
 
Ï¡_p¢
;

2894 
Ï¡_p¢
 = 
	`»ad_r_Ãxt_p¢
(
dd
, 
rcd
->
ùxt
,

2895 
æow
->
idx
);

2896 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 = 
Ï¡_p¢
;

2897 
´iv
->
s_æags
 |ð
HFI1_R_TID_SW_PSN
;

2902 ià(!(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
))

2903 
	`»¡¬t_tid_rdma_»ad_»q
(
rcd
, 
qp
,

2904 
wqe
);

2909 
RHF_RTE_EXPECTED_FLOW_GEN_ERR
:

2921 
RHF_RCV_TYPE_ERROR
:

2922 
¹e
) {

2923 
RHF_RTE_ERROR_OP_CODE_ERR
:

2924 
RHF_RTE_ERROR_KHDR_MIN_LEN_ERR
:

2925 
RHF_RTE_ERROR_KHDR_HCRC_ERR
:

2926 
RHF_RTE_ERROR_KHDR_KVER_ERR
:

2927 
RHF_RTE_ERROR_CONTEXT_ERR
:

2928 
RHF_RTE_ERROR_KHDR_TID_ERR
:

2935 
s_uÆock
:

2936 
	`¥š_uÆock
(&
qp
->
s_lock
);

2937  
»t
;

2938 
	}
}

2940 
boÞ
 
	$hfi1_hªdË_kd‘h_eæags
(
hfi1_ùxtd©a
 *
rcd
,

2941 
hfi1_µÜtd©a
 *
µd
,

2942 
hfi1_·ck‘
 *
·ck‘
)

2944 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

2945 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

2946 
rvt_dev_šfo
 *
rdi
 = &
dd
->
v”bs_dev
.rdi;

2947 
u8
 
rcv_ty³
 = 
	`rhf_rcv_ty³
(
·ck‘
->
rhf
);

2948 
u8
 
¹e
 = 
	`rhf_rcv_ty³_”r
(
·ck‘
->
rhf
);

2949 
ib_h—d”
 *
hdr
 = 
·ck‘
->hdr;

2950 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

2951 
Êh
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3;

2952 
u16
 
lid
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[1]);

2953 
u8
 
Ýcode
;

2954 
u32
 
qp_num
, 
p¢
, 
ibp¢
;

2955 
rvt_qp
 *
qp
;

2956 
hfi1_qp_´iv
 *
q´iv
;

2957 
æags
;

2958 
boÞ
 
»t
 = 
Œue
;

2959 
rvt_ack_’Œy
 *
e
;

2960 
tid_rdma_»que¡
 *
»q
;

2961 
tid_rdma_æow
 *
æow
;

2962 
diff
 = 0;

2964 
	`Œaû_hfi1_msg_hªdË_kd‘h_eæags
(
NULL
, "Kdethƒrror:„hf ",

2965 
·ck‘
->
rhf
);

2966 ià(
·ck‘
->
rhf
 & 
RHF_ICRC_ERR
)

2967  
»t
;

2969 
·ck‘
->
ohdr
 = &
hdr
->
u
.
Ùh
;

2970 
ohdr
 = 
·ck‘
->ohdr;

2971 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, !!(
	`rhf_dc_šfo
Õack‘->
rhf
)));

2974 
qp_num
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_r¥
.
v”bs_qp
) &

2975 
RVT_QPN_MASK
;

2976 ià(
lid
 >ð
	`be16_to_ýu
(
IB_MULTICAST_LID_BASE
))

2977 
drÝ
;

2979 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

2980 
Ýcode
 = (
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24) & 0xff;

2982 
	`rcu_»ad_lock
();

2983 
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
qp_num
);

2984 ià(!
qp
)

2985 
rcu_uÆock
;

2987 
·ck‘
->
qp
 = qp;

2990 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
æags
);

2991 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
)) {

2992 
ibp
->
rvp
.
n_pkt_drÝs
++;

2993 
r_uÆock
;

2996 ià(
·ck‘
->
rhf
 & 
RHF_TID_ERR
) {

2998 
u32
 
Ž’
 = 
	`rhf_pkt_Ën
(
·ck‘
->
rhf
);

3001 ià(
Ž’
 < 24)

3002 
r_uÆock
;

3008 ià(
Êh
 =ð
HFI1_LRH_GRH
)

3009 
r_uÆock
;

3011 ià(
	`tid_rdma_tid_”r
(
·ck‘
, 
rcv_ty³
))

3012 
r_uÆock
;

3016 ià(
Ýcode
 =ð
	`TID_OP
(
READ_RESP
)) {

3017 
ibp¢
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
r_r¥
.
v”bs_p¢
);

3018 
ibp¢
 = 
	`mask_p¢
(ibpsn);

3019 
»t
 = 
	`hªdË_»ad_kd‘h_eæags
(
rcd
, 
·ck‘
, 
rcv_ty³
, 
¹e
, 
p¢
,

3020 
ibp¢
);

3021 
r_uÆock
;

3029 
	`¥š_lock
(&
qp
->
s_lock
);

3030 
q´iv
 = 
qp
->
´iv
;

3031 ià(
q´iv
->
r_tid_ž
 =ð
HFI1_QP_WQE_INVALID
 ||

3032 
q´iv
->
r_tid_ž
 =ðq´iv->
r_tid_h—d
)

3033 
uÆock
;

3034 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ž
];

3035 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
))

3036 
uÆock
;

3037 
»q
 = 
	`ack_to_tid_»q
(
e
);

3038 ià(
»q
->
comp_£g
 =ð»q->
cur_£g
)

3039 
uÆock
;

3040 
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

3041 
	`Œaû_hfi1_eæags_”r_wr™e
(
qp
, 
rcv_ty³
, 
¹e
, 
p¢
);

3042 
	`Œaû_hfi1_r¥_hªdË_kd‘h_eæags
(
qp
, 
p¢
);

3043 
	`Œaû_hfi1_tid_wr™e_r¥_hªdË_kd‘h_eæags
(
qp
);

3044 
	`Œaû_hfi1_tid_»q_hªdË_kd‘h_eæags
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,

3045 
e
->
Í¢
, 
»q
);

3046 
	`Œaû_hfi1_tid_æow_hªdË_kd‘h_eæags
(
qp
, 
»q
->
þ—r_ž
, 
æow
);

3048 
rcv_ty³
) {

3049 
RHF_RCV_TYPE_EXPECTED
:

3050 
¹e
) {

3051 
RHF_RTE_EXPECTED_FLOW_SEQ_ERR
:

3052 ià(!(
q´iv
->
s_æags
 & 
HFI1_R_TID_SW_PSN
)) {

3053 
q´iv
->
s_æags
 |ð
HFI1_R_TID_SW_PSN
;

3054 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

3055 
	`»ad_r_Ãxt_p¢
(
dd
, 
rcd
->
ùxt
,

3056 
æow
->
idx
);

3057 
q´iv
->
r_Ãxt_p¢_kd‘h
 =

3058 
æow
->
æow_¡©e
.
r_Ãxt_p¢
;

3059 
Çk_p¢
;

3069 
diff
 = 
	`cmp_p¢
(
p¢
,

3070 
æow
->
æow_¡©e
.
r_Ãxt_p¢
);

3071 ià(
diff
 > 0)

3072 
Çk_p¢
;

3073 ià(
diff
 < 0)

3076 
q´iv
->
s_Çk_¡©e
 = 0;

3082 ià(
p¢
 =ð
	`fuÎ_æow_p¢
(
æow
,

3083 
æow
->
æow_¡©e
.
Í¢
))

3084 
»t
 = 
çl£
;

3085 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

3086 
	`mask_p¢
(
p¢
 + 1);

3087 
q´iv
->
r_Ãxt_p¢_kd‘h
 =

3088 
æow
->
æow_¡©e
.
r_Ãxt_p¢
;

3092 
RHF_RTE_EXPECTED_FLOW_GEN_ERR
:

3093 
Çk_p¢
;

3100 
RHF_RCV_TYPE_ERROR
:

3101 
¹e
) {

3102 
RHF_RTE_ERROR_OP_CODE_ERR
:

3103 
RHF_RTE_ERROR_KHDR_MIN_LEN_ERR
:

3104 
RHF_RTE_ERROR_KHDR_HCRC_ERR
:

3105 
RHF_RTE_ERROR_KHDR_KVER_ERR
:

3106 
RHF_RTE_ERROR_CONTEXT_ERR
:

3107 
RHF_RTE_ERROR_KHDR_TID_ERR
:

3115 
uÆock
:

3116 
	`¥š_uÆock
(&
qp
->
s_lock
);

3117 
r_uÆock
:

3118 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
æags
);

3119 
rcu_uÆock
:

3120 
	`rcu_»ad_uÆock
();

3121 
drÝ
:

3122  
»t
;

3123 
Çk_p¢
:

3124 
ibp
->
rvp
.
n_rc_£qÇk
++;

3125 ià(!
q´iv
->
s_Çk_¡©e
) {

3126 
q´iv
->
s_Çk_¡©e
 = 
IB_NAK_PSN_ERROR
;

3128 
q´iv
->
s_Çk_p¢
 = 
	`mask_p¢
(
æow
->
æow_¡©e
.
r_Ãxt_p¢
);

3129 
	`tid_rdma_Œigg”_ack
(
qp
);

3131 
uÆock
;

3132 
	}
}

3140 
	$hfi1_tid_rdma_»¡¬t_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

3141 
u32
 *
bth2
)

3143 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

3144 
tid_rdma_æow
 *
æow
;

3145 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3146 
diff
, 
d–_pkts
;

3147 
u32
 
tididx
 = 0, 
i
;

3148 
u16
 
fidx
;

3150 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

3151 *
bth2
 = 
	`mask_p¢
(
qp
->
s_p¢
);

3152 
æow
 = 
	`fšd_æow_ib
(
»q
, *
bth2
, &
fidx
);

3153 ià(!
æow
) {

3154 
	`Œaû_hfi1_msg_tid_»¡¬t_»q
(

3155 
qp
, "!!!!!! Could‚ot find flowo„estart: bth2 ",

3156 (
u64
)*
bth2
);

3157 
	`Œaû_hfi1_tid_»q_»¡¬t_»q
(
qp
, 0, 
wqe
->
wr
.
Ýcode
,

3158 
wqe
->
p¢
, wqe->
Í¢
,

3159 
»q
);

3163 
fidx
 = 
»q
->
acked_ž
;

3164 
æow
 = &
»q
->
æows
[
fidx
];

3165 *
bth2
 = 
	`mask_p¢
(
»q
->
r_ack_p¢
);

3168 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
)

3169 
d–_pkts
 = 
	`d–_p¢
(*
bth2
, 
æow
->
æow_¡©e
.
ib_¥¢
);

3171 
d–_pkts
 = 
	`d–_p¢
(*
bth2
,

3172 
	`fuÎ_æow_p¢
(
æow
,

3173 
æow
->
æow_¡©e
.
¥¢
));

3175 
	`Œaû_hfi1_tid_æow_»¡¬t_»q
(
qp
, 
fidx
, 
æow
);

3176 
diff
 = 
d–_pkts
 + 
æow
->
»sync_Åkts
;

3178 
æow
->
£Á
 = 0;

3179 
æow
->
pkt
 = 0;

3180 
æow
->
tid_idx
 = 0;

3181 
æow
->
tid_off£t
 = 0;

3182 ià(
diff
) {

3183 
tididx
 = 0;ididx < 
æow
->
tidút
;ididx++) {

3184 
u32
 
tid’Œy
 = 
æow
->
tid_’Œy
[
tididx
], 
tidËn
,

3185 
tidÅkts
, 
Åkts
;

3187 
æow
->
tid_off£t
 = 0;

3188 
tidËn
 = 
	`EXP_TID_GET
(
tid’Œy
, 
LEN
è* 
PAGE_SIZE
;

3189 
tidÅkts
 = 
	`rvt_div_round_up_mtu
(
qp
, 
tidËn
);

3190 
Åkts
 = 
	`mš_t
(
u32
, 
diff
, 
tidÅkts
);

3191 
æow
->
pkt
 +ð
Åkts
;

3192 
æow
->
£Á
 +ð(
Åkts
 =ð
tidÅkts
 ? 
tidËn
 :

3193 
Åkts
 * 
qp
->
pmtu
);

3194 
æow
->
tid_off£t
 +ð
Åkts
 * 
qp
->
pmtu
;

3195 
diff
 -ð
Åkts
;

3196 ià(!
diff
)

3200 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
) {

3201 
	`rvt_sk_sge
(&
q´iv
->
tid_ss
, (
»q
->
cur_£g
 *„eq->
£g_Ën
) +

3202 
æow
->
£Á
, 0);

3210 
æow
->
pkt
 -ðæow->
»sync_Åkts
;

3213 ià(
æow
->
tid_off£t
 ==

3214 
	`EXP_TID_GET
(
æow
->
tid_’Œy
[
tididx
], 
LEN
è* 
PAGE_SIZE
) {

3215 
tididx
++;

3216 
æow
->
tid_off£t
 = 0;

3218 
æow
->
tid_idx
 = 
tididx
;

3219 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
)

3221 
»q
->
æow_idx
 = 
fidx
;

3223 
»q
->
þ—r_ž
 = 
fidx
;

3225 
	`Œaû_hfi1_tid_æow_»¡¬t_»q
(
qp
, 
fidx
, 
æow
);

3226 
	`Œaû_hfi1_tid_»q_»¡¬t_»q
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

3227 
wqe
->
Í¢
, 
»q
);

3228 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

3229 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
) {

3231 
fidx
 = 
	`CIRC_NEXT
(fidx, 
MAX_FLOWS
);

3232 
i
 = 
q´iv
->
s_tid_ž
;

3234 ; 
	`CIRC_CNT
(
»q
->
£tup_h—d
, 
fidx
, 
MAX_FLOWS
);

3235 
fidx
 = 
	`CIRC_NEXT
(fidx, 
MAX_FLOWS
)) {

3236 
»q
->
æows
[
fidx
].
£Á
 = 0;

3237 
»q
->
æows
[
fidx
].
pkt
 = 0;

3238 
»q
->
æows
[
fidx
].
tid_idx
 = 0;

3239 
»q
->
æows
[
fidx
].
tid_off£t
 = 0;

3240 
»q
->
æows
[
fidx
].
»sync_Åkts
 = 0;

3242 ià(
i
 =ð
q´iv
->
s_tid_cur
)

3245 
i
 = (++˜=ð
qp
->
s_size
 ? 0 : i);

3246 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

3247 } 
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
);

3248 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

3249 
»q
->
cur_£g
 =„eq->
ack_£g
;

3250 
fidx
 = 
»q
->
acked_ž
;

3252 
»q
->
þ—r_ž
 = 
fidx
;

3255 
	}
}

3257 
	$hfi1_qp_k”n_exp_rcv_þ—r_®l
(
rvt_qp
 *
qp
)

3259 
i
, 
»t
;

3260 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3261 
tid_æow_¡©e
 *
fs
;

3263 ià(
qp
->
ibqp
.
qp_ty³
 !ð
IB_QPT_RC
 || !
	`HFI1_CAP_IS_KSET
(
TID_RDMA
))

3270 
fs
 = &
q´iv
->
æow_¡©e
;

3271 ià(
fs
->
šdex
 !ð
RXE_NUM_TID_FLOWS
)

3272 
	`hfi1_k”n_þ—r_hw_æow
(
q´iv
->
rcd
, 
qp
);

3274 
i
 = 
qp
->
s_acked
; i !ðqp->
s_h—d
;) {

3275 
rvt_swqe
 *
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

3277 ià(++
i
 =ð
qp
->
s_size
)

3278 
i
 = 0;

3280 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_READ
)

3283 
hfi1_swqe_´iv
 *
´iv
 = 
wqe
->priv;

3285 
»t
 = 
	`hfi1_k”n_exp_rcv_þ—r
(&
´iv
->
tid_»q
);

3286 } !
»t
);

3288 
i
 = 
qp
->
s_acked_ack_queue
; i !ðqp->
r_h—d_ack_queue
;) {

3289 
rvt_ack_’Œy
 *
e
 = &
qp
->
s_ack_queue
[
i
];

3291 ià(++
i
 =ð
	`rvt_max_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

3292 
i
 = 0;

3294 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
))

3297 
hfi1_ack_´iv
 *
´iv
 = 
e
->priv;

3299 
»t
 = 
	`hfi1_k”n_exp_rcv_þ—r
(&
´iv
->
tid_»q
);

3300 } !
»t
);

3302 
	}
}

3304 
boÞ
 
	$hfi1_tid_rdma_wqe_š‹¾ock
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
)

3306 
rvt_swqe
 *
´ev
;

3307 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

3308 
u32
 
s_´ev
;

3309 
tid_rdma_»que¡
 *
»q
;

3311 
s_´ev
 = (
qp
->
s_cur
 =ð0 ? qp->
s_size
 : qp->s_cur) - 1;

3312 
´ev
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
s_´ev
);

3314 
wqe
->
wr
.
Ýcode
) {

3315 
IB_WR_SEND
:

3316 
IB_WR_SEND_WITH_IMM
:

3317 
IB_WR_SEND_WITH_INV
:

3318 
IB_WR_ATOMIC_CMP_AND_SWP
:

3319 
IB_WR_ATOMIC_FETCH_AND_ADD
:

3320 
IB_WR_RDMA_WRITE
:

3321 
´ev
->
wr
.
Ýcode
) {

3322 
IB_WR_TID_RDMA_WRITE
:

3323 
»q
 = 
	`wqe_to_tid_»q
(
´ev
);

3324 ià(
»q
->
ack_£g
 !ð»q->
tÙ®_£gs
)

3325 
š‹¾ock
;

3330 
IB_WR_RDMA_READ
:

3331 ià(
´ev
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
)

3334 
IB_WR_TID_RDMA_READ
:

3335 
´ev
->
wr
.
Ýcode
) {

3336 
IB_WR_RDMA_READ
:

3337 ià(
qp
->
s_acked
 !ðqp->
s_cur
)

3338 
š‹¾ock
;

3340 
IB_WR_TID_RDMA_WRITE
:

3341 
»q
 = 
	`wqe_to_tid_»q
(
´ev
);

3342 ià(
»q
->
ack_£g
 !ð»q->
tÙ®_£gs
)

3343 
š‹¾ock
;

3350  
çl£
;

3352 
š‹¾ock
:

3353 
´iv
->
s_æags
 |ð
HFI1_S_TID_WAIT_INTERLCK
;

3354  
Œue
;

3355 
	}
}

3358 
šlše
 
boÞ
 
	$hfi1_check_sge_®ign
(
rvt_qp
 *
qp
,

3359 
rvt_sge
 *
sge
, 
num_sge
)

3361 
i
;

3363 
i
 = 0; i < 
num_sge
; i++, 
sge
++) {

3364 
	`Œaû_hfi1_sge_check_®ign
(
qp
, 
i
, 
sge
);

3365 ià((
u64
)
sge
->
vaddr
 & ~
PAGE_MASK
 ||

3366 
sge
->
sge_Ëngth
 & ~
PAGE_MASK
)

3367  
çl£
;

3369  
Œue
;

3370 
	}
}

3372 
	$£tup_tid_rdma_wqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
)

3374 
hfi1_qp_´iv
 *
q´iv
 = (hfi1_qp_´iv *)
qp
->
´iv
;

3375 
hfi1_swqe_´iv
 *
´iv
 = 
wqe
->priv;

3376 
tid_rdma_·¿ms
 *
»mÙe
;

3377 
ib_wr_Ýcode
 
Ãw_Ýcode
;

3378 
boÞ
 
do_tid_rdma
 = 
çl£
;

3379 
hfi1_µÜtd©a
 *
µd
 = 
q´iv
->
rcd
->ppd;

3381 ià((
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
è& ~((1 << 
µd
->
lmc
) - 1)) ==

3382 
µd
->
lid
)

3384 ià(
q´iv
->
hdr_ty³
 !ð
HFI1_PKT_TYPE_9B
)

3387 
	`rcu_»ad_lock
();

3388 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

3393 ià(!
»mÙe
)

3394 
ex™
;

3396 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
) {

3397 ià(
	`hfi1_check_sge_®ign
(
qp
, &
wqe
->
sg_li¡
[0],

3398 
wqe
->
wr
.
num_sge
)) {

3399 
Ãw_Ýcode
 = 
IB_WR_TID_RDMA_READ
;

3400 
do_tid_rdma
 = 
Œue
;

3402 } ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) {

3409 ià(!(
wqe
->
rdma_wr
.
»mÙe_addr
 & ~
PAGE_MASK
) &&

3410 !(
wqe
->
Ëngth
 & ~
PAGE_MASK
)) {

3411 
Ãw_Ýcode
 = 
IB_WR_TID_RDMA_WRITE
;

3412 
do_tid_rdma
 = 
Œue
;

3416 ià(
do_tid_rdma
) {

3417 ià(
	`hfi1_k”n_exp_rcv_®loc_æows
(&
´iv
->
tid_»q
, 
GFP_ATOMIC
))

3418 
ex™
;

3419 
wqe
->
wr
.
Ýcode
 = 
Ãw_Ýcode
;

3420 
´iv
->
tid_»q
.
£g_Ën
 =

3421 
	`mš_t
(
u32
, 
»mÙe
->
max_Ën
, 
wqe
->
Ëngth
);

3422 
´iv
->
tid_»q
.
tÙ®_£gs
 =

3423 
	`DIV_ROUND_UP
(
wqe
->
Ëngth
, 
´iv
->
tid_»q
.
£g_Ën
);

3425 
wqe
->
Í¢
 = wqe->
p¢
;

3426 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_READ
) {

3427 
´iv
->
tid_»q
.
n_æows
 = 
»mÙe
->
max_»ad
;

3428 
q´iv
->
tid_r_»qs
++;

3429 
wqe
->
Í¢
 +ð
	`rvt_div_round_up_mtu
(
qp
, wqe->
Ëngth
) - 1;

3431 
wqe
->
Í¢
 +ð
´iv
->
tid_»q
.
tÙ®_£gs
 - 1;

3432 
	`©omic_šc
(&
q´iv
->
n_»que¡s
);

3435 
´iv
->
tid_»q
.
cur_£g
 = 0;

3436 
´iv
->
tid_»q
.
comp_£g
 = 0;

3437 
´iv
->
tid_»q
.
ack_£g
 = 0;

3438 
´iv
->
tid_»q
.
¡©e
 = 
TID_REQUEST_INACTIVE
;

3445 
´iv
->
tid_»q
.
acked_ž
 =…riv->tid_»q.
£tup_h—d
;

3446 
	`Œaû_hfi1_tid_»q_£tup_tid_wqe
(
qp
, 1, 
wqe
->
wr
.
Ýcode
,

3447 
wqe
->
p¢
, wqe->
Í¢
,

3448 &
´iv
->
tid_»q
);

3450 
ex™
:

3451 
	`rcu_»ad_uÆock
();

3452 
	}
}

3456 
u32
 
	$hfi1_bužd_tid_rdma_wr™e_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

3457 
ib_Ùh”_h—d”s
 *
ohdr
,

3458 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
)

3460 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3461 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

3462 
tid_rdma_·¿ms
 *
»mÙe
;

3464 
	`rcu_»ad_lock
();

3465 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

3470 
»q
->
n_æows
 = 
»mÙe
->
max_wr™e
;

3471 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

3473 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
w_»q
.
kd‘h0
, 
KVER
, 0x1);

3474 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
w_»q
.
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

3475 
ohdr
->
u
.
tid_rdma
.
w_»q
.
»th
.
vaddr
 =

3476 
	`ýu_to_be64
(
wqe
->
rdma_wr
.
»mÙe_addr
 + (wqe->
Ëngth
 - *
Ën
));

3477 
ohdr
->
u
.
tid_rdma
.
w_»q
.
»th
.
rkey
 =

3478 
	`ýu_to_be32
(
wqe
->
rdma_wr
.
rkey
);

3479 
ohdr
->
u
.
tid_rdma
.
w_»q
.
»th
.
Ëngth
 = 
	`ýu_to_be32
(*
Ën
);

3480 
ohdr
->
u
.
tid_rdma
.
w_»q
.
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

3481 *
bth1
 &ð~
RVT_QPN_MASK
;

3482 *
bth1
 |ð
»mÙe
->
qp
;

3483 
qp
->
s_¡©e
 = 
	`TID_OP
(
WRITE_REQ
);

3484 
qp
->
s_æags
 |ð
HFI1_S_WAIT_TID_RESP
;

3485 *
bth2
 |ð
IB_BTH_REQ_ACK
;

3486 *
Ën
 = 0;

3488 
	`rcu_»ad_uÆock
();

3489  (
ohdr
->
u
.
tid_rdma
.
w_»q
è/ (
u32
);

3490 
	}
}

3492 
u32
 
	$hfi1_compu‹_tid_rdma_æow_wt
(
rvt_qp
 *
qp
)

3502  (
MAX_TID_FLOW_PSN
 * 
qp
->
pmtu
è>> 
TID_RDMA_SEGMENT_SHIFT
;

3503 
	}
}

3505 
u32
 
	$pos™iÚ_š_queue
(
hfi1_qp_´iv
 *
q´iv
,

3506 
tid_queue
 *
queue
)

3508  
q´iv
->
tid_’queue
 - 
queue
->
dequeue
;

3509 
	}
}

3516 
u32
 
	$hfi1_compu‹_tid_ºr_timeout
(
rvt_qp
 *
qp
, 
u32
 
to_£g
)

3518 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3519 
u64
 
timeout
;

3520 
u32
 
by‹s_³r_us
;

3521 
u8
 
i
;

3523 
by‹s_³r_us
 = 
	`aùive_eg»ss_¿‹
(
q´iv
->
rcd
->
µd
) / 8;

3524 
timeout
 = (
to_£g
 * 
TID_RDMA_MAX_SEGMENT_SIZE
è/ 
by‹s_³r_us
;

3529 
i
 = 1; i <ð
IB_AETH_CREDIT_MASK
; i++)

3530 ià(
	`rvt_ºr_tbl_to_u£c
(
i
è>ð
timeout
)

3531  
i
;

3533 
	}
}

3554 
	$hfi1_tid_wr™e_®loc_»sourûs
(
rvt_qp
 *
qp
, 
boÞ
 
šŒ_ùx
)

3556 
tid_rdma_»que¡
 *
»q
;

3557 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3558 
hfi1_ùxtd©a
 *
rcd
 = 
q´iv
->rcd;

3559 
tid_rdma_·¿ms
 *
loÿl
 = &
q´iv
->
tid_rdma
.local;

3560 
rvt_ack_’Œy
 *
e
;

3561 
u32
 
Åkts
, 
to_£g
;

3562 
boÞ
 
Ï¡
;

3563 
»t
 = 0;

3565 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

3568 
	`Œaû_hfi1_r¥_tid_wr™e_®loc_»s
(
qp
, 0);

3569 
	`Œaû_hfi1_tid_wr™e_r¥_®loc_»s
(
qp
);

3582 ià(
q´iv
->
ºr_Çk_¡©e
 =ð
TID_RNR_NAK_SEND
)

3586 ià(
q´iv
->
r_tid_®loc
 =ðq´iv->
r_tid_h—d
) {

3588 ià(
q´iv
->
æow_¡©e
.
šdex
 < 
RXE_NUM_TID_FLOWS
 &&

3589 !
q´iv
->
®loc_w_£gs
) {

3590 
	`hfi1_k”n_þ—r_hw_æow
(
rcd
, 
qp
);

3591 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_SW_PSN
;

3596 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_®loc
];

3597 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
))

3598 
Ãxt_»q
;

3599 
»q
 = 
	`ack_to_tid_»q
(
e
);

3600 
	`Œaû_hfi1_tid_»q_wr™e_®loc_»s
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,

3601 
e
->
Í¢
, 
»q
);

3603 ià(
»q
->
®loc_£g
 >ð»q->
tÙ®_£gs
)

3604 
Ãxt_»q
;

3607 ià(
q´iv
->
®loc_w_£gs
 >ð
loÿl
->
max_wr™e
)

3611 ià(
q´iv
->
sync_±
 && q´iv->
®loc_w_£gs
)

3615 ià(
q´iv
->
sync_±
 && !q´iv->
®loc_w_£gs
) {

3616 
	`hfi1_k”n_þ—r_hw_æow
(
rcd
, 
qp
);

3617 
q´iv
->
sync_±
 = 
çl£
;

3618 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_SW_PSN
;

3622 ià(
q´iv
->
æow_¡©e
.
šdex
 >ð
RXE_NUM_TID_FLOWS
) {

3623 
»t
 = 
	`hfi1_k”n_£tup_hw_æow
(
q´iv
->
rcd
, 
qp
);

3624 ià(
»t
) {

3625 
to_£g
 = 
	`hfi1_compu‹_tid_rdma_æow_wt
(
qp
) *

3626 
	`pos™iÚ_š_queue
(
q´iv
,

3627 &
rcd
->
æow_queue
);

3632 
Åkts
 = 
	`rvt_div_round_up_mtu
(
qp
, 
»q
->
£g_Ën
);

3638 ià(
q´iv
->
æow_¡©e
.
p¢
 + 
Åkts
 > 
MAX_TID_FLOW_PSN
 - 1) {

3639 
q´iv
->
sync_±
 = 
Œue
;

3650 ià(!
	`CIRC_SPACE
(
»q
->
£tup_h—d
,„eq->
acked_ž
,

3651 
MAX_FLOWS
)) {

3652 
»t
 = -
EAGAIN
;

3653 
to_£g
 = 
MAX_FLOWS
 >> 1;

3654 
	`tid_rdma_Œigg”_ack
(
qp
);

3659 
»t
 = 
	`hfi1_k”n_exp_rcv_£tup
(
»q
, &»q->
ss
, &
Ï¡
);

3660 ià(
»t
 =ð-
EAGAIN
)

3661 
to_£g
 = 
	`pos™iÚ_š_queue
(
q´iv
, &
rcd
->
¿¼_queue
);

3662 ià(
»t
)

3665 
q´iv
->
®loc_w_£gs
++;

3666 
»q
->
®loc_£g
++;

3668 
Ãxt_»q
:

3670 ià(++
q´iv
->
r_tid_®loc
 >

3671 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

3672 
q´iv
->
r_tid_®loc
 = 0;

3680 ià(
»t
 =ð-
EAGAIN
 && 
šŒ_ùx
 && !
qp
->
r_Çk_¡©e
)

3681 
£nd_ºr_Çk
;

3685 
£nd_ºr_Çk
:

3686 
	`lockd•_as£¹_h–d
(&
qp
->
r_lock
);

3689 
qp
->
r_Çk_¡©e
 = 
	`hfi1_compu‹_tid_ºr_timeout
(qp, 
to_£g
è| 
IB_RNR_NAK
;

3692 
qp
->
r_p¢
 = 
e
->
p¢
 + 
»q
->
®loc_£g
;

3693 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3699 
qp
->
r_h—d_ack_queue
 = 
q´iv
->
r_tid_®loc
 + 1;

3700 ià(
qp
->
r_h—d_ack_queue
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(qp->
ibqp
.
deviû
)))

3701 
qp
->
r_h—d_ack_queue
 = 0;

3702 
q´iv
->
r_tid_h—d
 = 
qp
->
r_h—d_ack_queue
;

3708 
qp
->
s_Çk_¡©e
 = qp->
r_Çk_¡©e
;

3709 
qp
->
s_ack_p¢
 = qp->
r_ack_p¢
;

3714 
qp
->
s_æags
 &ð~(
RVT_S_ACK_PENDING
);

3716 
	`Œaû_hfi1_r¥_tid_wr™e_®loc_»s
(
qp
, qp->
r_p¢
);

3724 
q´iv
->
ºr_Çk_¡©e
 = 
TID_RNR_NAK_SEND
;

3731 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3732 
	}
}

3734 
	$hfi1_rc_rcv_tid_rdma_wr™e_»q
(
hfi1_·ck‘
 *
·ck‘
)

3749 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

3750 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

3751 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

3752 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

3753 
rvt_ack_’Œy
 *
e
;

3754 
æags
;

3755 
ib_»th
 *
»th
;

3756 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3757 
tid_rdma_»que¡
 *
»q
;

3758 
u32
 
bth0
, 
p¢
, 
Ën
, 
rkey
, 
num_£gs
;

3759 
boÞ
 
ãú
;

3760 
u8
 
Ãxt
;

3761 
u64
 
vaddr
;

3762 
diff
;

3764 
bth0
 = 
	`be32_to_ýu
(
ohdr
->
bth
[0]);

3765 ià(
	`hfi1_ruc_check_hdr
(
ibp
, 
·ck‘
))

3768 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

3769 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

3770 
	`Œaû_hfi1_r¥_rcv_tid_wr™e_»q
(
qp
, 
p¢
);

3772 ià(
qp
->
¡©e
 =ð
IB_QPS_RTR
 && !(qp->
r_æags
 & 
RVT_R_COMM_EST
))

3773 
	`rvt_comm_e¡
(
qp
);

3775 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 & 
IB_ACCESS_REMOTE_WRITE
)))

3776 
Çck_šv
;

3778 
»th
 = &
ohdr
->
u
.
tid_rdma
.
w_»q
.reth;

3779 
vaddr
 = 
	`be64_to_ýu
(
»th
->vaddr);

3780 
Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

3782 
num_£gs
 = 
	`DIV_ROUND_UP
(
Ën
, 
q´iv
->
tid_rdma
.
loÿl
.
max_Ën
);

3783 
diff
 = 
	`d–_p¢
(
p¢
, 
qp
->
r_p¢
);

3784 ià(
	`uÆik–y
(
diff
)) {

3785 
	`tid_rdma_rcv_”r
(
·ck‘
, 
ohdr
, 
qp
, 
p¢
, 
diff
, 
ãú
);

3794 ià(
q´iv
->
ºr_Çk_¡©e
)

3795 
qp
->
r_h—d_ack_queue
 = qp->r_head_ack_queue ?

3796 
qp
->
r_h—d_ack_queue
 - 1 :

3797 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
));

3800 
Ãxt
 = 
qp
->
r_h—d_ack_queue
 + 1;

3801 ià(
Ãxt
 > 
	`rvt_size_©omic
(
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
)))

3802 
Ãxt
 = 0;

3803 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

3804 ià(
	`uÆik–y
(
Ãxt
 =ð
qp
->
s_acked_ack_queue
)) {

3805 ià(!
qp
->
s_ack_queue
[
Ãxt
].
£Á
)

3806 
Çck_šv_uÆock
;

3807 
	`upd©e_ack_queue
(
qp
, 
Ãxt
);

3809 
e
 = &
qp
->
s_ack_queue
[qp->
r_h—d_ack_queue
];

3810 
»q
 = 
	`ack_to_tid_»q
(
e
);

3813 ià(
q´iv
->
ºr_Çk_¡©e
) {

3814 
qp
->
r_Çk_¡©e
 = 0;

3815 
qp
->
s_Çk_¡©e
 = 0;

3816 
q´iv
->
ºr_Çk_¡©e
 = 
TID_RNR_NAK_INIT
;

3817 
qp
->
r_p¢
 = 
e
->
Í¢
 + 1;

3818 
»q
->
¡©e
 = 
TID_REQUEST_INIT
;

3819 
upd©e_h—d
;

3822 
	`»Ëa£_rdma_sge_mr
(
e
);

3825 ià(!
Ën
 ||†’ & ~
PAGE_MASK
)

3826 
Çck_šv_uÆock
;

3828 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

3829 
qp
->
r_Ën
 = 
Ën
;

3831 ià(
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
) &&

3832 (
»q
->
£tup_h—d
 !ð»q->
þ—r_ž
 ||

3833 
»q
->
þ—r_ž
 !ð»q->
acked_ž
))

3834 
Çck_šv_uÆock
;

3836 ià(
	`uÆik–y
(!
	`rvt_rkey_ok
(
qp
, &
e
->
rdma_sge
, qp->
r_Ën
, 
vaddr
,

3837 
rkey
, 
IB_ACCESS_REMOTE_WRITE
)))

3838 
Çck_acc
;

3840 
qp
->
r_p¢
 +ð
num_£gs
 - 1;

3842 
e
->
Ýcode
 = (
bth0
 >> 24) & 0xff;

3843 
e
->
p¢
 =…sn;

3844 
e
->
Í¢
 = 
qp
->
r_p¢
;

3845 
e
->
£Á
 = 0;

3847 
»q
->
n_æows
 = 
	`mš_t
(
u16
, 
num_£gs
, 
q´iv
->
tid_rdma
.
loÿl
.
max_wr™e
);

3848 
»q
->
¡©e
 = 
TID_REQUEST_INIT
;

3849 
»q
->
cur_£g
 = 0;

3850 
»q
->
comp_£g
 = 0;

3851 
»q
->
ack_£g
 = 0;

3852 
»q
->
®loc_£g
 = 0;

3853 
»q
->
isge
 = 0;

3854 
»q
->
£g_Ën
 = 
q´iv
->
tid_rdma
.
loÿl
.
max_Ën
;

3855 
»q
->
tÙ®_Ën
 = 
Ën
;

3856 
»q
->
tÙ®_£gs
 = 
num_£gs
;

3857 
»q
->
r_æow_p¢
 = 
e
->
p¢
;

3858 
»q
->
ss
.
sge
 = 
e
->
rdma_sge
;

3859 
»q
->
ss
.
num_sge
 = 1;

3861 
»q
->
æow_idx
 =„eq->
£tup_h—d
;

3862 
»q
->
þ—r_ž
 =„eq->
£tup_h—d
;

3863 
»q
->
acked_ž
 =„eq->
£tup_h—d
;

3865 
qp
->
r_¡©e
 = 
e
->
Ýcode
;

3866 
qp
->
r_Çk_¡©e
 = 0;

3872 
qp
->
r_m¢
++;

3873 
qp
->
r_p¢
++;

3875 
	`Œaû_hfi1_tid_»q_rcv_wr™e_»q
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

3876 
»q
);

3878 ià(
q´iv
->
r_tid_ž
 =ð
HFI1_QP_WQE_INVALID
) {

3879 
q´iv
->
r_tid_ž
 = 
qp
->
r_h—d_ack_queue
;

3880 } ià(
q´iv
->
r_tid_ž
 =ðq´iv->
r_tid_h—d
) {

3881 
tid_rdma_»que¡
 *
±r
;

3883 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ž
];

3884 
±r
 = 
	`ack_to_tid_»q
(
e
);

3886 ià(
e
->
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
) ||

3887 
±r
->
comp_£g
 =ð±r->
tÙ®_£gs
) {

3888 ià(
q´iv
->
r_tid_ž
 =ðq´iv->
r_tid_ack
)

3889 
q´iv
->
r_tid_ack
 = 
qp
->
r_h—d_ack_queue
;

3890 
q´iv
->
r_tid_ž
 = 
qp
->
r_h—d_ack_queue
;

3893 
upd©e_h—d
:

3894 
qp
->
r_h—d_ack_queue
 = 
Ãxt
;

3895 
q´iv
->
r_tid_h—d
 = 
qp
->
r_h—d_ack_queue
;

3897 
	`hfi1_tid_wr™e_®loc_»sourûs
(
qp
, 
Œue
);

3898 
	`Œaû_hfi1_tid_wr™e_r¥_rcv_»q
(
qp
);

3901 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

3902 ià(
ãú
)

3903 
qp
->
s_æags
 |ð
RVT_S_ECN
;

3904 
	`hfi1_scheduË_£nd
(
qp
);

3906 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3909 
Çck_šv_uÆock
:

3910 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3911 
Çck_šv
:

3912 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

3913 
qp
->
r_Çk_¡©e
 = 
IB_NAK_INVALID_REQUEST
;

3914 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3916 
	`rc_deã»d_ack
(
rcd
, 
qp
);

3918 
Çck_acc
:

3919 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

3920 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_PROT_ERR
);

3921 
qp
->
r_Çk_¡©e
 = 
IB_NAK_REMOTE_ACCESS_ERROR
;

3922 
qp
->
r_ack_p¢
 = qp->
r_p¢
;

3923 
	}
}

3925 
u32
 
	$hfi1_bužd_tid_rdma_wr™e_»¥
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

3926 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

3927 
u32
 
bth2
, u32 *
Ën
,

3928 
rvt_sge_¡©e
 **
ss
)

3930 
hfi1_ack_´iv
 *
•riv
 = 
e
->
´iv
;

3931 
tid_rdma_»que¡
 *
»q
 = &
•riv
->
tid_»q
;

3932 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

3933 
tid_rdma_æow
 *
æow
 = 
NULL
;

3934 
u32
 
»¥_Ën
 = 0, 
hdwÜds
 = 0;

3935 *
»¥_addr
 = 
NULL
;

3936 
tid_rdma_·¿ms
 *
»mÙe
;

3938 
	`Œaû_hfi1_tid_»q_bužd_wr™e_»¥
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

3939 
»q
);

3940 
	`Œaû_hfi1_tid_wr™e_r¥_bužd_»¥
(
qp
);

3941 
	`Œaû_hfi1_r¥_bužd_tid_wr™e_»¥
(
qp
, 
bth2
);

3942 
æow
 = &
»q
->
æows
[»q->
æow_idx
];

3943 
»q
->
¡©e
) {

3949 
	`hfi1_tid_wr™e_®loc_»sourûs
(
qp
, 
çl£
);

3952 ià(
»q
->
cur_£g
 >ð»q->
®loc_£g
)

3953 
dÚe
;

3959 ià(
q´iv
->
ºr_Çk_¡©e
 =ð
TID_RNR_NAK_SENT
)

3960 
dÚe
;

3962 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

3963 
	`Œaû_hfi1_tid_æow_bužd_wr™e_»¥
(
qp
, 
»q
->
æow_idx
, 
æow
);

3964 
»q
->
æow_idx
 = 
	`CIRC_NEXT
Ôeq->æow_idx, 
MAX_FLOWS
);

3965 
	`hfi1_add_tid_»­_tim”
(
qp
);

3968 
TID_REQUEST_RESEND_ACTIVE
:

3969 
TID_REQUEST_RESEND
:

3970 
	`Œaû_hfi1_tid_æow_bužd_wr™e_»¥
(
qp
, 
»q
->
æow_idx
, 
æow
);

3971 
»q
->
æow_idx
 = 
	`CIRC_NEXT
Ôeq->æow_idx, 
MAX_FLOWS
);

3972 ià(!
	`CIRC_CNT
(
»q
->
£tup_h—d
,„eq->
æow_idx
, 
MAX_FLOWS
))

3973 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

3975 
	`hfi1_mod_tid_»­_tim”
(
qp
);

3978 
æow
->
æow_¡©e
.
»¥_ib_p¢
 = 
bth2
;

3979 
»¥_addr
 = (*)
æow
->
tid_’Œy
;

3980 
»¥_Ën
 = (*
æow
->
tid_’Œy
è* flow->
tidút
;

3981 
»q
->
cur_£g
++;

3983 
	`mem£t
(&
ohdr
->
u
.
tid_rdma
.
w_r¥
, 0, (ohdr->u.tid_rdma.w_rsp));

3984 
•riv
->
ss
.
sge
.
vaddr
 = 
»¥_addr
;

3985 
•riv
->
ss
.
sge
.
sge_Ëngth
 = 
»¥_Ën
;

3986 
•riv
->
ss
.
sge
.
Ëngth
 =ƒ´iv->ss.sge.
sge_Ëngth
;

3991 
•riv
->
ss
.
sge
.
mr
 = 
NULL
;

3992 
•riv
->
ss
.
sge
.
m
 = 0;

3993 
•riv
->
ss
.
sge
.
n
 = 0;

3995 
•riv
->
ss
.
sg_li¡
 = 
NULL
;

3996 
•riv
->
ss
.
tÙ®_Ën
 =ƒ´iv->ss.
sge
.
sge_Ëngth
;

3997 
•riv
->
ss
.
num_sge
 = 1;

3999 *
ss
 = &
•riv
->ss;

4000 *
Ën
 = 
•riv
->
ss
.
tÙ®_Ën
;

4003 
	`rcu_»ad_lock
();

4004 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

4006 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
w_r¥
.
kd‘h0
, 
KVER
, 0x1);

4007 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
w_r¥
.
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

4008 
ohdr
->
u
.
tid_rdma
.
w_r¥
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

4009 
ohdr
->
u
.
tid_rdma
.
w_r¥
.
tid_æow_p¢
 =

4010 
	`ýu_to_be32
((
æow
->
æow_¡©e
.
g’”©iÚ
 <<

4011 
HFI1_KDETH_BTH_SEQ_SHIFT
) |

4012 (
æow
->
æow_¡©e
.
¥¢
 &

4013 
HFI1_KDETH_BTH_SEQ_MASK
));

4014 
ohdr
->
u
.
tid_rdma
.
w_r¥
.
tid_æow_qp
 =

4015 
	`ýu_to_be32
(
q´iv
->
tid_rdma
.
loÿl
.
qp
 |

4016 ((
æow
->
idx
 & 
TID_RDMA_DESTQP_FLOW_MASK
) <<

4017 
TID_RDMA_DESTQP_FLOW_SHIFT
) |

4018 
q´iv
->
rcd
->
ùxt
);

4019 
ohdr
->
u
.
tid_rdma
.
w_r¥
.
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

4020 *
bth1
 = 
»mÙe
->
qp
;

4021 
	`rcu_»ad_uÆock
();

4022 
hdwÜds
 = (
ohdr
->
u
.
tid_rdma
.
w_r¥
è/ (
u32
);

4023 
q´iv
->
³ndšg_tid_w_£gs
++;

4024 
dÚe
:

4025  
hdwÜds
;

4026 
	}
}

4028 
	$hfi1_add_tid_»­_tim”
(
rvt_qp
 *
qp
)

4030 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4032 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4033 ià(!(
q´iv
->
s_æags
 & 
HFI1_R_TID_RSC_TIMER
)) {

4034 
q´iv
->
s_æags
 |ð
HFI1_R_TID_RSC_TIMER
;

4035 
q´iv
->
s_tid_tim”
.
expœes
 = 
jiff›s
 +

4036 
q´iv
->
tid_tim”_timeout_jiff›s
;

4037 
	`add_tim”
(&
q´iv
->
s_tid_tim”
);

4039 
	}
}

4041 
	$hfi1_mod_tid_»­_tim”
(
rvt_qp
 *
qp
)

4043 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4045 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4046 
q´iv
->
s_æags
 |ð
HFI1_R_TID_RSC_TIMER
;

4047 
	`mod_tim”
(&
q´iv
->
s_tid_tim”
, 
jiff›s
 +

4048 
q´iv
->
tid_tim”_timeout_jiff›s
);

4049 
	}
}

4051 
	$hfi1_¡Ý_tid_»­_tim”
(
rvt_qp
 *
qp
)

4053 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4054 
rv®
 = 0;

4056 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4057 ià(
q´iv
->
s_æags
 & 
HFI1_R_TID_RSC_TIMER
) {

4058 
rv®
 = 
	`d–_tim”
(&
q´iv
->
s_tid_tim”
);

4059 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_RSC_TIMER
;

4061  
rv®
;

4062 
	}
}

4064 
	$hfi1_d–_tid_»­_tim”
(
rvt_qp
 *
qp
)

4066 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4068 
	`d–_tim”_sync
(&
q´iv
->
s_tid_tim”
);

4069 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_RSC_TIMER
;

4070 
	}
}

4072 
	$hfi1_tid_timeout
(
tim”_li¡
 *
t
)

4074 
hfi1_qp_´iv
 *
q´iv
 = 
	`äom_tim”
(q´iv, 
t
, 
s_tid_tim”
);

4075 
rvt_qp
 *
qp
 = 
q´iv
->
owÃr
;

4076 
rvt_dev_šfo
 *
rdi
 = 
	`ib_to_rvt
(
qp
->
ibqp
.
deviû
);

4077 
æags
;

4078 
u32
 
i
;

4080 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
æags
);

4081 
	`¥š_lock
(&
qp
->
s_lock
);

4082 ià(
q´iv
->
s_æags
 & 
HFI1_R_TID_RSC_TIMER
) {

4083 
	`dd_dev_w¬n
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
), "[QP%u] %s %d\n",

4084 
qp
->
ibqp
.
qp_num
, 
__func__
, 
__LINE__
);

4085 
	`Œaû_hfi1_msg_tid_timeout
(

4086 
qp
, "resourceimeout = ",

4087 (
u64
)
q´iv
->
tid_tim”_timeout_jiff›s
);

4088 
	`hfi1_¡Ý_tid_»­_tim”
(
qp
);

4093 
	`hfi1_k”n_þ—r_hw_æow
(
q´iv
->
rcd
, 
qp
);

4094 
i
 = 0; i < 
	`rvt_max_©omic
(
rdi
); i++) {

4095 
tid_rdma_»que¡
 *
»q
 =

4096 
	`ack_to_tid_»q
(&
qp
->
s_ack_queue
[
i
]);

4098 
	`hfi1_k”n_exp_rcv_þ—r_®l
(
»q
);

4100 
	`¥š_uÆock
(&
qp
->
s_lock
);

4101 ià(
qp
->
ibqp
.
ev’t_hªdËr
) {

4102 
ib_ev’t
 
ev
;

4104 
ev
.
deviû
 = 
qp
->
ibqp
.device;

4105 
ev
.
–em’t
.
qp
 = &qp->
ibqp
;

4106 
ev
.
ev’t
 = 
IB_EVENT_QP_FATAL
;

4107 
qp
->
ibqp
.
	`ev’t_hªdËr
(&
ev
, qp->ibqp.
qp_cÚ‹xt
);

4109 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_RESP_TIMEOUT_ERR
);

4110 
uÆock_r_lock
;

4112 
	`¥š_uÆock
(&
qp
->
s_lock
);

4113 
uÆock_r_lock
:

4114 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
æags
);

4115 
	}
}

4117 
	$hfi1_rc_rcv_tid_rdma_wr™e_»¥
(
hfi1_·ck‘
 *
·ck‘
)

4130 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

4131 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

4132 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4133 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

4134 
rvt_swqe
 *
wqe
;

4135 
tid_rdma_»que¡
 *
»q
;

4136 
tid_rdma_æow
 *
æow
;

4137 
ib_wc_¡©us
 
¡©us
;

4138 
u32
 
Ýcode
, 
«th
, 
p¢
, 
æow_p¢
, 
i
, 
tidËn
 = 0, 
pkŽ’
;

4139 
boÞ
 
ãú
;

4140 
æags
;

4142 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

4143 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

4144 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
w_r¥
.aeth);

4145 
Ýcode
 = (
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24) & 0xff;

4147 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

4150 ià(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ãxt_p¢
) >= 0)

4151 
ack_dÚe
;

4154 ià(
	`uÆik–y
(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
) <= 0))

4155 
ack_dÚe
;

4157 ià(
	`uÆik–y
(
qp
->
s_acked
 =ðqp->
s_ž
))

4158 
ack_dÚe
;

4165 ià(
qp
->
r_æags
 & 
RVT_R_RDMAR_SEQ
) {

4166 ià(
	`cmp_p¢
(
p¢
, 
qp
->
s_Ï¡_p¢
 + 1) != 0)

4167 
ack_dÚe
;

4168 
qp
->
r_æags
 &ð~
RVT_R_RDMAR_SEQ
;

4171 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
q´iv
->
s_tid_cur
);

4172 ià(
	`uÆik–y
(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
))

4173 
ack_Ý_”r
;

4175 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4181 ià(!
	`CIRC_SPACE
(
»q
->
£tup_h—d
,„eq->
acked_ž
, 
MAX_FLOWS
))

4182 
ack_dÚe
;

4191 ià(!
	`do_rc_ack
(
qp
, 
«th
, 
p¢
, 
Ýcode
, 0, 
rcd
))

4192 
ack_dÚe
;

4194 
	`Œaû_hfi1_ack
(
qp
, 
p¢
);

4196 
æow
 = &
»q
->
æows
[»q->
£tup_h—d
];

4197 
æow
->
pkt
 = 0;

4198 
æow
->
tid_idx
 = 0;

4199 
æow
->
tid_off£t
 = 0;

4200 
æow
->
£Á
 = 0;

4201 
æow
->
»sync_Åkts
 = 0;

4202 
æow
->
tid_q²
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
w_r¥
.
tid_æow_qp
);

4203 
æow
->
idx
 = (æow->
tid_q²
 >> 
TID_RDMA_DESTQP_FLOW_SHIFT
) &

4204 
TID_RDMA_DESTQP_FLOW_MASK
;

4205 
æow_p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
w_r¥
.
tid_æow_p¢
));

4206 
æow
->
æow_¡©e
.
g’”©iÚ
 = 
æow_p¢
 >> 
HFI1_KDETH_BTH_SEQ_SHIFT
;

4207 
æow
->
æow_¡©e
.
¥¢
 = 
æow_p¢
 & 
HFI1_KDETH_BTH_SEQ_MASK
;

4208 
æow
->
æow_¡©e
.
»¥_ib_p¢
 = 
p¢
;

4209 
æow
->
Ëngth
 = 
	`mš_t
(
u32
, 
»q
->
£g_Ën
,

4210 (
wqe
->
Ëngth
 - (
»q
->
comp_£g
 *„eq->
£g_Ën
)));

4212 
æow
->
Åkts
 = 
	`rvt_div_round_up_mtu
(
qp
, flow->
Ëngth
);

4213 
æow
->
æow_¡©e
.
Í¢
 = flow->æow_¡©e.
¥¢
 +

4214 
æow
->
Åkts
 - 1;

4216 
pkŽ’
 = 
·ck‘
->
Ž’
 - (·ck‘->
hËn
 + 4);

4217 ià(
pkŽ’
 > (
æow
->
tid_’Œy
)) {

4218 
¡©us
 = 
IB_WC_LOC_LEN_ERR
;

4219 
ack_”r
;

4221 
	`memýy
(
æow
->
tid_’Œy
, 
·ck‘
->
ebuf
, 
pkŽ’
);

4222 
æow
->
tidút
 = 
pkŽ’
 / (*æow->
tid_’Œy
);

4223 
	`Œaû_hfi1_tid_æow_rcv_wr™e_»¥
(
qp
, 
»q
->
£tup_h—d
, 
æow
);

4225 
»q
->
comp_£g
++;

4226 
	`Œaû_hfi1_tid_wr™e_£nd”_rcv_»¥
(
qp
, 0);

4231 
i
 = 0; i < 
æow
->
tidút
; i++) {

4232 
	`Œaû_hfi1_tid_’Œy_rcv_wr™e_»¥
(

4233 
qp
, 
i
, 
æow
->
tid_’Œy
[i]);

4234 ià(!
	`EXP_TID_GET
(
æow
->
tid_’Œy
[
i
], 
LEN
)) {

4235 
¡©us
 = 
IB_WC_LOC_LEN_ERR
;

4236 
ack_”r
;

4238 
tidËn
 +ð
	`EXP_TID_GET
(
æow
->
tid_’Œy
[
i
], 
LEN
);

4240 ià(
tidËn
 * 
PAGE_SIZE
 < 
æow
->
Ëngth
) {

4241 
¡©us
 = 
IB_WC_LOC_LEN_ERR
;

4242 
ack_”r
;

4245 
	`Œaû_hfi1_tid_»q_rcv_wr™e_»¥
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

4246 
wqe
->
Í¢
, 
»q
);

4251 ià(!
	`cmp_p¢
(
p¢
, 
wqe
->psn)) {

4252 
»q
->
r_Ï¡_acked
 = 
	`mask_p¢
(
wqe
->
p¢
 - 1);

4254 
»q
->
acked_ž
 =„eq->
£tup_h—d
;

4258 
»q
->
£tup_h—d
 = 
	`CIRC_NEXT
Ôeq->£tup_h—d, 
MAX_FLOWS
);

4259 
»q
->
¡©e
 = 
TID_REQUEST_ACTIVE
;

4268 ià(
q´iv
->
s_tid_cur
 !ðq´iv->
s_tid_h—d
 &&

4269 
»q
->
comp_£g
 =ð»q->
tÙ®_£gs
) {

4270 
i
 = 
q´iv
->
s_tid_cur
 + 1; ; i++) {

4271 ià(
i
 =ð
qp
->
s_size
)

4272 
i
 = 0;

4273 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

4274 ià(
i
 =ð
q´iv
->
s_tid_h—d
)

4276 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
)

4279 
q´iv
->
s_tid_cur
 = 
i
;

4281 
qp
->
s_æags
 &ð~
HFI1_S_WAIT_TID_RESP
;

4282 
	`hfi1_scheduË_tid_£nd
(
qp
);

4283 
ack_dÚe
;

4285 
ack_Ý_”r
:

4286 
¡©us
 = 
IB_WC_LOC_QP_OP_ERR
;

4287 
ack_”r
:

4288 
	`rvt_”rÜ_qp
(
qp
, 
¡©us
);

4289 
ack_dÚe
:

4290 ià(
ãú
)

4291 
qp
->
s_æags
 |ð
RVT_S_ECN
;

4292 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

4293 
	}
}

4295 
boÞ
 
	$hfi1_bužd_tid_rdma_·ck‘
(
rvt_swqe
 *
wqe
,

4296 
ib_Ùh”_h—d”s
 *
ohdr
,

4297 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
)

4299 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4300 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

4301 
tid_rdma_·¿ms
 *
»mÙe
;

4302 
rvt_qp
 *
qp
 = 
»q
->qp;

4303 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4304 
u32
 
tid’Œy
 = 
æow
->
tid_’Œy
[æow->
tid_idx
];

4305 
u32
 
tidËn
 = 
	`EXP_TID_GET
(
tid’Œy
, 
LEN
è<< 
PAGE_SHIFT
;

4306 
tid_rdma_wr™e_d©a
 *
wd
 = &
ohdr
->
u
.
tid_rdma
.
w_d©a
;

4307 
u32
 
Ãxt_off£t
, 
om
 = 
KDETH_OM_LARGE
;

4308 
boÞ
 
Ï¡_pkt
;

4310 ià(!
tidËn
) {

4311 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_REM_INV_RD_REQ_ERR
);

4312 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_REM_INV_RD_REQ_ERR
);

4315 *
Ën
 = 
	`mš_t
(
u32
, 
qp
->
pmtu
, 
tidËn
 - 
æow
->
tid_off£t
);

4316 
æow
->
£Á
 +ð*
Ën
;

4317 
Ãxt_off£t
 = 
æow
->
tid_off£t
 + *
Ën
;

4318 
Ï¡_pkt
 = (
æow
->
tid_idx
 =ð(æow->
tidút
 - 1) &&

4319 
Ãxt_off£t
 >ð
tidËn
è|| (
æow
->
£Á
 >ðæow->
Ëngth
);

4320 
	`Œaû_hfi1_tid_’Œy_bužd_wr™e_d©a
(
qp
, 
æow
->
tid_idx
, 
tid’Œy
);

4321 
	`Œaû_hfi1_tid_æow_bužd_wr™e_d©a
(
qp
, 
»q
->
þ—r_ž
, 
æow
);

4323 
	`rcu_»ad_lock
();

4324 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

4325 
	`KDETH_RESET
(
wd
->
kd‘h0
, 
KVER
, 0x1);

4326 
	`KDETH_SET
(
wd
->
kd‘h0
, 
SH
, !
Ï¡_pkt
);

4327 
	`KDETH_SET
(
wd
->
kd‘h0
, 
INTR
, !!(!
Ï¡_pkt
 && 
»mÙe
->
urg
));

4328 
	`KDETH_SET
(
wd
->
kd‘h0
, 
TIDCTRL
, 
	`EXP_TID_GET
(
tid’Œy
, 
CTRL
));

4329 
	`KDETH_SET
(
wd
->
kd‘h0
, 
TID
, 
	`EXP_TID_GET
(
tid’Œy
, 
IDX
));

4330 
	`KDETH_SET
(
wd
->
kd‘h0
, 
OM
, 
om
 =ð
KDETH_OM_LARGE
);

4331 
	`KDETH_SET
(
wd
->
kd‘h0
, 
OFFSET
, 
æow
->
tid_off£t
 / 
om
);

4332 
	`KDETH_RESET
(
wd
->
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

4333 
wd
->
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

4334 
	`rcu_»ad_uÆock
();

4336 *
bth1
 = 
æow
->
tid_q²
;

4337 *
bth2
 = 
	`mask_p¢
(((
æow
->
æow_¡©e
.
¥¢
 + flow->
pkt
++) &

4338 
HFI1_KDETH_BTH_SEQ_MASK
) |

4339 (
æow
->
æow_¡©e
.
g’”©iÚ
 <<

4340 
HFI1_KDETH_BTH_SEQ_SHIFT
));

4341 ià(
Ï¡_pkt
) {

4343 ià(
æow
->
æow_¡©e
.
Í¢
 + 1 +

4344 
	`rvt_div_round_up_mtu
(
qp
, 
»q
->
£g_Ën
) >

4345 
MAX_TID_FLOW_PSN
)

4346 
»q
->
¡©e
 = 
TID_REQUEST_SYNC
;

4347 *
bth2
 |ð
IB_BTH_REQ_ACK
;

4350 ià(
Ãxt_off£t
 >ð
tidËn
) {

4351 
æow
->
tid_off£t
 = 0;

4352 
æow
->
tid_idx
++;

4354 
æow
->
tid_off£t
 = 
Ãxt_off£t
;

4356  
Ï¡_pkt
;

4357 
	}
}

4359 
	$hfi1_rc_rcv_tid_rdma_wr™e_d©a
(
hfi1_·ck‘
 *
·ck‘
)

4361 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

4362 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

4363 
hfi1_ùxtd©a
 *
rcd
 = 
´iv
->rcd;

4364 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

4365 
rvt_ack_’Œy
 *
e
;

4366 
tid_rdma_»que¡
 *
»q
;

4367 
tid_rdma_æow
 *
æow
;

4368 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

4369 
æags
;

4370 
u32
 
p¢
, 
Ãxt
;

4371 
u8
 
Ýcode
;

4372 
boÞ
 
ãú
;

4374 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

4375 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

4376 
Ýcode
 = (
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24) & 0xff;

4382 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

4383 
e
 = &
qp
->
s_ack_queue
[
´iv
->
r_tid_ž
];

4384 
»q
 = 
	`ack_to_tid_»q
(
e
);

4385 
æow
 = &
»q
->
æows
[»q->
þ—r_ž
];

4386 ià(
	`cmp_p¢
(
p¢
, 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
Í¢
))) {

4387 
	`upd©e_r_Ãxt_p¢_ãú
(
·ck‘
, 
´iv
, 
rcd
, 
æow
, 
ãú
);

4389 ià(
	`cmp_p¢
(
p¢
, 
æow
->
æow_¡©e
.
r_Ãxt_p¢
))

4390 
£nd_Çk
;

4392 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 = 
	`mask_p¢
(
p¢
 + 1);

4400 ià(
ãú
 && 
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_EAGER
) {

4401 
rvt_sge_¡©e
 
ss
;

4402 
u32
 
Ën
;

4403 
u32
 
Ž’
 = 
·ck‘
->tlen;

4404 
u16
 
hdrsize
 = 
·ck‘
->
hËn
;

4405 
u8
 
·d
 = 
·ck‘
->pad;

4406 
u8
 
exŒa_by‹s
 = 
·d
 + 
·ck‘
->
exŒa_by‹
 +

4407 (
SIZE_OF_CRC
 << 2);

4408 
u32
 
pmtu
 = 
qp
->pmtu;

4410 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 
exŒa_by‹s
)))

4411 
£nd_Çk
;

4412 
Ën
 = 
»q
->
comp_£g
 *„eq->
£g_Ën
;

4413 
Ën
 +ð
	`d–_p¢
(
p¢
,

4414 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
¥¢
)) *

4415 
pmtu
;

4416 ià(
	`uÆik–y
(
»q
->
tÙ®_Ën
 - 
Ën
 < 
pmtu
))

4417 
£nd_Çk
;

4423 
ss
.
sge
 = 
e
->
rdma_sge
;

4424 
ss
.
sg_li¡
 = 
NULL
;

4425 
ss
.
num_sge
 = 1;

4426 
ss
.
tÙ®_Ën
 = 
»q
->total_len;

4427 
	`rvt_sk_sge
(&
ss
, 
Ën
, 
çl£
);

4428 
	`rvt_cÝy_sge
(
qp
, &
ss
, 
·ck‘
->
·ylßd
, 
pmtu
, 
çl£
,

4429 
çl£
);

4431 
´iv
->
r_Ãxt_p¢_kd‘h
 = 
	`mask_p¢
(
p¢
 + 1);

4432 
´iv
->
s_æags
 |ð
HFI1_R_TID_SW_PSN
;

4434 
ex™
;

4436 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 = 
	`mask_p¢
(
p¢
 + 1);

4437 
	`hfi1_k”n_exp_rcv_þ—r
(
»q
);

4438 
´iv
->
®loc_w_£gs
--;

4439 
rcd
->
æows
[
æow
->
idx
].
p¢
 =…¢ & 
HFI1_KDETH_BTH_SEQ_MASK
;

4440 
»q
->
comp_£g
++;

4441 
´iv
->
s_Çk_¡©e
 = 0;

4450 
	`Œaû_hfi1_r¥_rcv_tid_wr™e_d©a
(
qp
, 
p¢
);

4451 
	`Œaû_hfi1_tid_»q_rcv_wr™e_d©a
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

4452 
»q
);

4453 
	`Œaû_hfi1_tid_wr™e_r¥_rcv_d©a
(
qp
);

4454 
	`v®id©e_r_tid_ack
(
´iv
);

4456 ià(
Ýcode
 =ð
	`TID_OP
(
WRITE_DATA_LAST
)) {

4457 
	`»Ëa£_rdma_sge_mr
(
e
);

4458 
Ãxt
 = 
´iv
->
r_tid_ž
 + 1; ;‚ext++) {

4459 ià(
Ãxt
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

4460 
Ãxt
 = 0;

4461 ià(
Ãxt
 =ð
´iv
->
r_tid_h—d
)

4463 
e
 = &
qp
->
s_ack_queue
[
Ãxt
];

4464 ià(
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
))

4467 
´iv
->
r_tid_ž
 = 
Ãxt
;

4468 ià(++
qp
->
s_acked_ack_queue
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

4469 
qp
->
s_acked_ack_queue
 = 0;

4472 
	`hfi1_tid_wr™e_®loc_»sourûs
(
qp
, 
Œue
);

4478 ià(
»q
->
cur_£g
 <„eq->
tÙ®_£gs
 ||

4479 
qp
->
s_ž_ack_queue
 !ðqp->
r_h—d_ack_queue
) {

4480 
qp
->
s_æags
 |ð
RVT_S_RESP_PENDING
;

4481 
	`hfi1_scheduË_£nd
(
qp
);

4484 
´iv
->
³ndšg_tid_w_£gs
--;

4485 ià(
´iv
->
s_æags
 & 
HFI1_R_TID_RSC_TIMER
) {

4486 ià(
´iv
->
³ndšg_tid_w_£gs
)

4487 
	`hfi1_mod_tid_»­_tim”
(
»q
->
qp
);

4489 
	`hfi1_¡Ý_tid_»­_tim”
(
»q
->
qp
);

4492 
dÚe
:

4493 
	`tid_rdma_scheduË_ack
(
qp
);

4494 
ex™
:

4495 
´iv
->
r_Ãxt_p¢_kd‘h
 = 
æow
->
æow_¡©e
.
r_Ãxt_p¢
;

4496 ià(
ãú
)

4497 
qp
->
s_æags
 |ð
RVT_S_ECN
;

4498 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

4501 
£nd_Çk
:

4502 ià(!
´iv
->
s_Çk_¡©e
) {

4503 
´iv
->
s_Çk_¡©e
 = 
IB_NAK_PSN_ERROR
;

4504 
´iv
->
s_Çk_p¢
 = 
æow
->
æow_¡©e
.
r_Ãxt_p¢
;

4505 
	`tid_rdma_Œigg”_ack
(
qp
);

4507 
dÚe
;

4508 
	}
}

4510 
boÞ
 
	$hfi1_tid_rdma_is_»sync_p¢
(
u32
 
p¢
)

4512  (
boÞ
)((
p¢
 & 
HFI1_KDETH_BTH_SEQ_MASK
) ==

4513 
HFI1_KDETH_BTH_SEQ_MASK
);

4514 
	}
}

4516 
u32
 
	$hfi1_bužd_tid_rdma_wr™e_ack
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

4517 
ib_Ùh”_h—d”s
 *
ohdr
, 
u16
 
iæow
,

4518 
u32
 *
bth1
, u32 *
bth2
)

4520 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4521 
tid_æow_¡©e
 *
fs
 = &
q´iv
->
æow_¡©e
;

4522 
tid_rdma_»que¡
 *
»q
 = 
	`ack_to_tid_»q
(
e
);

4523 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[
iæow
];

4524 
tid_rdma_·¿ms
 *
»mÙe
;

4526 
	`rcu_»ad_lock
();

4527 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

4528 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
ack
.
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

4529 
ohdr
->
u
.
tid_rdma
.
ack
.
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

4530 *
bth1
 = 
»mÙe
->
qp
;

4531 
	`rcu_»ad_uÆock
();

4533 ià(
q´iv
->
»sync
) {

4534 *
bth2
 = 
	`mask_p¢
((
fs
->
g’”©iÚ
 <<

4535 
HFI1_KDETH_BTH_SEQ_SHIFT
) - 1);

4536 
ohdr
->
u
.
tid_rdma
.
ack
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

4537 } ià(
q´iv
->
s_Çk_¡©e
) {

4538 *
bth2
 = 
	`mask_p¢
(
q´iv
->
s_Çk_p¢
);

4539 
ohdr
->
u
.
tid_rdma
.
ack
.
«th
 =

4540 
	`ýu_to_be32
((
qp
->
r_m¢
 & 
IB_MSN_MASK
) |

4541 (
q´iv
->
s_Çk_¡©e
 <<

4542 
IB_AETH_CREDIT_SHIFT
));

4544 *
bth2
 = 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
Í¢
);

4545 
ohdr
->
u
.
tid_rdma
.
ack
.
«th
 = 
	`rvt_compu‹_«th
(
qp
);

4547 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
ack
.
kd‘h0
, 
KVER
, 0x1);

4548 
ohdr
->
u
.
tid_rdma
.
ack
.
tid_æow_qp
 =

4549 
	`ýu_to_be32
(
q´iv
->
tid_rdma
.
loÿl
.
qp
 |

4550 ((
æow
->
idx
 & 
TID_RDMA_DESTQP_FLOW_MASK
) <<

4551 
TID_RDMA_DESTQP_FLOW_SHIFT
) |

4552 
q´iv
->
rcd
->
ùxt
);

4554 
ohdr
->
u
.
tid_rdma
.
ack
.
tid_æow_p¢
 = 0;

4555 
ohdr
->
u
.
tid_rdma
.
ack
.
v”bs_p¢
 =

4556 
	`ýu_to_be32
(
æow
->
æow_¡©e
.
»¥_ib_p¢
);

4558 ià(
q´iv
->
»sync
) {

4565 ià(
	`hfi1_tid_rdma_is_»sync_p¢
(
q´iv
->
r_Ãxt_p¢_kd‘h
 - 1)) {

4566 
ohdr
->
u
.
tid_rdma
.
ack
.
tid_æow_p¢
 =

4567 
	`ýu_to_be32
(
q´iv
->
r_Ãxt_p¢_kd‘h_§ve
);

4575 
q´iv
->
r_Ãxt_p¢_kd‘h_§ve
 =

4576 
q´iv
->
r_Ãxt_p¢_kd‘h
 - 1;

4577 
ohdr
->
u
.
tid_rdma
.
ack
.
tid_æow_p¢
 =

4578 
	`ýu_to_be32
(
q´iv
->
r_Ãxt_p¢_kd‘h_§ve
);

4579 
q´iv
->
r_Ãxt_p¢_kd‘h
 = 
	`mask_p¢
(*
bth2
 + 1);

4581 
q´iv
->
»sync
 = 
çl£
;

4584  (
ohdr
->
u
.
tid_rdma
.
ack
è/ (
u32
);

4585 
	}
}

4587 
	$hfi1_rc_rcv_tid_rdma_ack
(
hfi1_·ck‘
 *
·ck‘
)

4589 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

4590 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

4591 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4592 
rvt_swqe
 *
wqe
;

4593 
tid_rdma_»que¡
 *
»q
;

4594 
tid_rdma_æow
 *
æow
;

4595 
u32
 
«th
, 
p¢
, 
»q_p¢
, 
ack_p¢
, 
æp¢
, 
»sync_p¢
, 
ack_kp¢
;

4596 
æags
;

4597 
u16
 
fidx
;

4599 
	`Œaû_hfi1_tid_wr™e_£nd”_rcv_tid_ack
(
qp
, 0);

4600 
	`´oûss_eú
(
qp
, 
·ck‘
);

4601 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

4602 
«th
 = 
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
ack
.aeth);

4603 
»q_p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
ack
.
v”bs_p¢
));

4604 
»sync_p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
u
.
tid_rdma
.
ack
.
tid_æow_p¢
));

4606 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

4607 
	`Œaû_hfi1_rcv_tid_ack
(
qp
, 
«th
, 
p¢
, 
»q_p¢
, 
»sync_p¢
);

4610 ià((
qp
->
s_æags
 & 
HFI1_S_WAIT_HALT
) &&

4611 
	`cmp_p¢
(
p¢
, 
q´iv
->
s_»sync_p¢
))

4612 
ack_Ý_”r
;

4614 
ack_p¢
 = 
»q_p¢
;

4615 ià(
	`hfi1_tid_rdma_is_»sync_p¢
(
p¢
))

4616 
ack_kp¢
 = 
»sync_p¢
;

4618 
ack_kp¢
 = 
p¢
;

4619 ià(
«th
 >> 29) {

4620 
ack_p¢
--;

4621 
ack_kp¢
--;

4624 ià(
	`uÆik–y
(
qp
->
s_acked
 =ðqp->
s_ž
))

4625 
ack_Ý_”r
;

4627 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

4629 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
)

4630 
ack_Ý_”r
;

4632 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4633 
	`Œaû_hfi1_tid_»q_rcv_tid_ack
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

4634 
wqe
->
Í¢
, 
»q
);

4635 
æow
 = &
»q
->
æows
[»q->
acked_ž
];

4636 
	`Œaû_hfi1_tid_æow_rcv_tid_ack
(
qp
, 
»q
->
acked_ž
, 
æow
);

4639 ià(
	`cmp_p¢
(
p¢
, 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
¥¢
)) < 0 ||

4640 
	`cmp_p¢
(
»q_p¢
, 
æow
->
æow_¡©e
.
»¥_ib_p¢
) < 0)

4641 
ack_Ý_”r
;

4643 
	`cmp_p¢
(
ack_kp¢
,

4644 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
Í¢
)) >= 0 &&

4645 
»q
->
ack_£g
 <„eq->
cur_£g
) {

4646 
»q
->
ack_£g
++;

4648 
»q
->
acked_ž
 = 
	`CIRC_NEXT
Ôeq->acked_ž, 
MAX_FLOWS
);

4649 
»q
->
r_Ï¡_acked
 = 
æow
->
æow_¡©e
.
»¥_ib_p¢
;

4650 
	`Œaû_hfi1_tid_»q_rcv_tid_ack
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

4651 
wqe
->
Í¢
, 
»q
);

4652 ià(
»q
->
ack_£g
 =ð»q->
tÙ®_£gs
) {

4653 
»q
->
¡©e
 = 
TID_REQUEST_COMPLETE
;

4654 
wqe
 = 
	`do_rc_com¶‘iÚ
(
qp
, wqe,

4655 
	`to_Üt
(
qp
->
ibqp
.
deviû
,

4656 
qp
->
pÜt_num
));

4657 
	`Œaû_hfi1_£nd”_rcv_tid_ack
(
qp
);

4658 
	`©omic_dec
(&
q´iv
->
n_tid_»que¡s
);

4659 ià(
qp
->
s_acked
 =ðqp->
s_ž
)

4661 ià(
wqe
->
wr
.
Ýcode
 !ð
IB_WR_TID_RDMA_WRITE
)

4663 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4665 
æow
 = &
»q
->
æows
[»q->
acked_ž
];

4666 
	`Œaû_hfi1_tid_æow_rcv_tid_ack
(
qp
, 
»q
->
acked_ž
, 
æow
);

4669 
	`Œaû_hfi1_tid_»q_rcv_tid_ack
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

4670 
wqe
->
Í¢
, 
»q
);

4671 
«th
 >> 29) {

4673 ià(
q´iv
->
s_æags
 & 
RVT_S_WAIT_ACK
)

4674 
q´iv
->
s_æags
 &ð~
RVT_S_WAIT_ACK
;

4675 ià(!
	`hfi1_tid_rdma_is_»sync_p¢
(
p¢
)) {

4677 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
 &&

4678 
»q
->
ack_£g
 <„eq->
cur_£g
)

4679 
	`hfi1_mod_tid_»Œy_tim”
(
qp
);

4681 
	`hfi1_¡Ý_tid_»Œy_tim”
(
qp
);

4682 
	`hfi1_scheduË_£nd
(
qp
);

4684 
u32
 
¥¢
, 
å¢
, 
Ï¡_acked
, 
g’”©iÚ
;

4685 
tid_rdma_»que¡
 *
½Œ
;

4688 
	`hfi1_¡Ý_tid_»Œy_tim”
(
qp
);

4690 
qp
->
s_æags
 &ð~
HFI1_S_WAIT_HALT
;

4697 
q´iv
->
s_æags
 &ð~
RVT_S_SEND_ONE
;

4698 
	`hfi1_scheduË_£nd
(
qp
);

4700 ià((
qp
->
s_acked
 =ð
q´iv
->
s_tid_ž
 &&

4701 
»q
->
ack_£g
 =ð»q->
tÙ®_£gs
) ||

4702 
qp
->
s_acked
 =ðqp->
s_ž
) {

4703 
q´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_DATA_LAST
);

4704 
dÚe
;

4707 ià(
»q
->
ack_£g
 =ð»q->
comp_£g
) {

4708 
q´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_DATA
);

4709 
dÚe
;

4716 
p¢
 = 
	`mask_p¢
(psn + 1);

4717 
g’”©iÚ
 = 
p¢
 >> 
HFI1_KDETH_BTH_SEQ_SHIFT
;

4718 
¥¢
 = 0;

4724 ià(
	`d–_p¢
(
ack_p¢
, 
wqe
->
Í¢
))

4725 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

4726 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4727 
æow
 = &
»q
->
æows
[»q->
acked_ž
];

4737 
å¢
 = 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
¥¢
);

4738 
»q
->
r_ack_p¢
 = 
p¢
;

4745 ià(
æow
->
æow_¡©e
.
g’”©iÚ
 !=

4746 (
»sync_p¢
 >> 
HFI1_KDETH_BTH_SEQ_SHIFT
))

4747 
»sync_p¢
 = 
	`mask_p¢
(
å¢
 - 1);

4748 
æow
->
»sync_Åkts
 +=

4749 
	`d–_p¢
(
	`mask_p¢
(
»sync_p¢
 + 1), 
å¢
);

4754 
Ï¡_acked
 = 
qp
->
s_acked
;

4755 
½Œ
 = 
»q
;

4758 
fidx
 = 
½Œ
->
acked_ž
;

4759 
	`CIRC_CNT
(
½Œ
->
£tup_h—d
, 
fidx
,

4760 
MAX_FLOWS
);

4761 
fidx
 = 
	`CIRC_NEXT
(fidx, 
MAX_FLOWS
)) {

4762 
u32
 
Í¢
;

4763 
u32
 
g’
;

4765 
æow
 = &
½Œ
->
æows
[
fidx
];

4766 
g’
 = 
æow
->
æow_¡©e
.
g’”©iÚ
;

4767 ià(
	`WARN_ON
(
g’
 =ð
g’”©iÚ
 &&

4768 
æow
->
æow_¡©e
.
¥¢
 !=

4769 
¥¢
))

4771 
Í¢
 = 
æow
->
æow_¡©e
.lpsn;

4772 
Í¢
 = 
	`fuÎ_æow_p¢
(
æow
,†psn);

4773 
æow
->
Åkts
 =

4774 
	`d–_p¢
(
Í¢
,

4775 
	`mask_p¢
(
»sync_p¢
)

4777 
æow
->
æow_¡©e
.
g’”©iÚ
 =

4778 
g’”©iÚ
;

4779 
æow
->
æow_¡©e
.
¥¢
 = spsn;

4780 
æow
->
æow_¡©e
.
Í¢
 =

4781 
æow
->
æow_¡©e
.
¥¢
 +

4782 
æow
->
Åkts
 - 1;

4783 
æow
->
pkt
 = 0;

4784 
¥¢
 +ð
æow
->
Åkts
;

4785 
»sync_p¢
 +ð
æow
->
Åkts
;

4786 
	`Œaû_hfi1_tid_æow_rcv_tid_ack
(
qp
,

4787 
fidx
,

4788 
æow
);

4790 ià(++
Ï¡_acked
 =ð
q´iv
->
s_tid_cur
 + 1)

4792 ià(
Ï¡_acked
 =ð
qp
->
s_size
)

4793 
Ï¡_acked
 = 0;

4794 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
Ï¡_acked
);

4795 
½Œ
 = 
	`wqe_to_tid_»q
(
wqe
);

4797 
»q
->
cur_£g
 =„eq->
ack_£g
;

4798 
q´iv
->
s_tid_ž
 = 
qp
->
s_acked
;

4799 
q´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_REQ
);

4800 
	`hfi1_scheduË_tid_£nd
(
qp
);

4802 
dÚe
:

4803 
q´iv
->
s_»Œy
 = 
qp
->
s_»Œy_út
;

4807 
	`hfi1_¡Ý_tid_»Œy_tim”
(
qp
);

4808 (
«th
 >> 
IB_AETH_CREDIT_SHIFT
) &

4809 
IB_AETH_CREDIT_MASK
) {

4811 ià(!
»q
->
æows
)

4813 
æow
 = &
»q
->
æows
[»q->
acked_ž
];

4814 
æp¢
 = 
	`fuÎ_æow_p¢
(
æow
, flow->
æow_¡©e
.
Í¢
);

4815 ià(
	`cmp_p¢
(
p¢
, 
æp¢
) > 0)

4817 
	`Œaû_hfi1_tid_æow_rcv_tid_ack
(
qp
, 
»q
->
acked_ž
,

4818 
æow
);

4819 
»q
->
r_ack_p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

4820 
»q
->
cur_£g
 =„eq->
ack_£g
;

4821 
q´iv
->
s_tid_ž
 = 
qp
->
s_acked
;

4822 
q´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_REQ
);

4823 
q´iv
->
s_»Œy
 = 
qp
->
s_»Œy_út
;

4824 
	`hfi1_scheduË_tid_£nd
(
qp
);

4836 
ack_Ý_”r
:

4837 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

4838 
	}
}

4840 
	$hfi1_add_tid_»Œy_tim”
(
rvt_qp
 *
qp
)

4842 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

4843 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

4844 
rvt_dev_šfo
 *
rdi
 = 
	`ib_to_rvt
(
ibqp
->
deviû
);

4846 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4847 ià(!(
´iv
->
s_æags
 & 
HFI1_S_TID_RETRY_TIMER
)) {

4848 
´iv
->
s_æags
 |ð
HFI1_S_TID_RETRY_TIMER
;

4849 
´iv
->
s_tid_»Œy_tim”
.
expœes
 = 
jiff›s
 +

4850 
´iv
->
tid_»Œy_timeout_jiff›s
 + 
rdi
->
busy_jiff›s
;

4851 
	`add_tim”
(&
´iv
->
s_tid_»Œy_tim”
);

4853 
	}
}

4855 
	$hfi1_mod_tid_»Œy_tim”
(
rvt_qp
 *
qp
)

4857 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

4858 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

4859 
rvt_dev_šfo
 *
rdi
 = 
	`ib_to_rvt
(
ibqp
->
deviû
);

4861 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4862 
´iv
->
s_æags
 |ð
HFI1_S_TID_RETRY_TIMER
;

4863 
	`mod_tim”
(&
´iv
->
s_tid_»Œy_tim”
, 
jiff›s
 +

4864 
´iv
->
tid_»Œy_timeout_jiff›s
 + 
rdi
->
busy_jiff›s
);

4865 
	}
}

4867 
	$hfi1_¡Ý_tid_»Œy_tim”
(
rvt_qp
 *
qp
)

4869 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

4870 
rv®
 = 0;

4872 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

4873 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_RETRY_TIMER
) {

4874 
rv®
 = 
	`d–_tim”
(&
´iv
->
s_tid_»Œy_tim”
);

4875 
´iv
->
s_æags
 &ð~
HFI1_S_TID_RETRY_TIMER
;

4877  
rv®
;

4878 
	}
}

4880 
	$hfi1_d–_tid_»Œy_tim”
(
rvt_qp
 *
qp
)

4882 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

4884 
	`d–_tim”_sync
(&
´iv
->
s_tid_»Œy_tim”
);

4885 
´iv
->
s_æags
 &ð~
HFI1_S_TID_RETRY_TIMER
;

4886 
	}
}

4888 
	$hfi1_tid_»Œy_timeout
(
tim”_li¡
 *
t
)

4890 
hfi1_qp_´iv
 *
´iv
 = 
	`äom_tim”
Õriv, 
t
, 
s_tid_»Œy_tim”
);

4891 
rvt_qp
 *
qp
 = 
´iv
->
owÃr
;

4892 
rvt_swqe
 *
wqe
;

4893 
æags
;

4894 
tid_rdma_»que¡
 *
»q
;

4896 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
æags
);

4897 
	`¥š_lock
(&
qp
->
s_lock
);

4898 
	`Œaû_hfi1_tid_wr™e_£nd”_»Œy_timeout
(
qp
, 0);

4899 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_RETRY_TIMER
) {

4900 
	`hfi1_¡Ý_tid_»Œy_tim”
(
qp
);

4901 ià(!
´iv
->
s_»Œy
) {

4902 
	`Œaû_hfi1_msg_tid_»Œy_timeout
(

4903 
qp
,

4905 (
u64
)
´iv
->
tid_»Œy_timeout_jiff›s
);

4907 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

4908 
	`hfi1_Œdma_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_RETRY_EXC_ERR
);

4909 
	`rvt_”rÜ_qp
(
qp
, 
IB_WC_WR_FLUSH_ERR
);

4911 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_acked
);

4912 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4913 
	`Œaû_hfi1_tid_»q_tid_»Œy_timeout
(

4914 
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
, wqe->
Í¢
, 
»q
);

4916 
´iv
->
s_æags
 &ð~
RVT_S_WAIT_ACK
;

4918 
´iv
->
s_æags
 |ð
RVT_S_SEND_ONE
;

4923 
qp
->
s_æags
 |ð
HFI1_S_WAIT_HALT
;

4924 
´iv
->
s_¡©e
 = 
	`TID_OP
(
RESYNC
);

4925 
´iv
->
s_»Œy
--;

4926 
	`hfi1_scheduË_tid_£nd
(
qp
);

4929 
	`¥š_uÆock
(&
qp
->
s_lock
);

4930 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
æags
);

4931 
	}
}

4933 
u32
 
	$hfi1_bužd_tid_rdma_»sync
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

4934 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

4935 
u32
 *
bth2
, 
u16
 
fidx
)

4937 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4938 
tid_rdma_·¿ms
 *
»mÙe
;

4939 
tid_rdma_»que¡
 *
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

4940 
tid_rdma_æow
 *
æow
 = &
»q
->
æows
[
fidx
];

4941 
u32
 
g’”©iÚ
;

4943 
	`rcu_»ad_lock
();

4944 
»mÙe
 = 
	`rcu_d”eã»nû
(
q´iv
->
tid_rdma
.remote);

4945 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
ack
.
kd‘h1
, 
JKEY
, 
»mÙe
->
jkey
);

4946 
ohdr
->
u
.
tid_rdma
.
ack
.
v”bs_qp
 = 
	`ýu_to_be32
(
qp
->
»mÙe_q²
);

4947 *
bth1
 = 
»mÙe
->
qp
;

4948 
	`rcu_»ad_uÆock
();

4950 
g’”©iÚ
 = 
	`k”n_æow_g’”©iÚ_Ãxt
(
æow
->
æow_¡©e
.generation);

4951 *
bth2
 = 
	`mask_p¢
((
g’”©iÚ
 << 
HFI1_KDETH_BTH_SEQ_SHIFT
) - 1);

4952 
q´iv
->
s_»sync_p¢
 = *
bth2
;

4953 *
bth2
 |ð
IB_BTH_REQ_ACK
;

4954 
	`KDETH_RESET
(
ohdr
->
u
.
tid_rdma
.
ack
.
kd‘h0
, 
KVER
, 0x1);

4956  (
ohdr
->
u
.
tid_rdma
.
»sync
è/ (
u32
);

4957 
	}
}

4959 
	$hfi1_rc_rcv_tid_rdma_»sync
(
hfi1_·ck‘
 *
·ck‘
)

4961 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

4962 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

4963 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

4964 
hfi1_ùxtd©a
 *
rcd
 = 
q´iv
->rcd;

4965 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

4966 
rvt_ack_’Œy
 *
e
;

4967 
tid_rdma_»que¡
 *
»q
;

4968 
tid_rdma_æow
 *
æow
;

4969 
tid_æow_¡©e
 *
fs
 = &
q´iv
->
æow_¡©e
;

4970 
u32
 
p¢
, 
g’”©iÚ
, 
idx
, 
g’_Ãxt
;

4971 
boÞ
 
ãú
;

4972 
æags
;

4974 
ãú
 = 
	`´oûss_eú
(
qp
, 
·ck‘
);

4975 
p¢
 = 
	`mask_p¢
(
	`be32_to_ýu
(
ohdr
->
bth
[2]));

4977 
g’”©iÚ
 = 
	`mask_p¢
(
p¢
 + 1è>> 
HFI1_KDETH_BTH_SEQ_SHIFT
;

4978 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

4980 
g’_Ãxt
 = (
fs
->
g’”©iÚ
 =ð
KERN_GENERATION_RESERVED
) ?

4981 
g’”©iÚ
 : 
	`k”n_æow_g’”©iÚ_Ãxt
(
fs
->generation);

4986 ià(
g’”©iÚ
 !ð
	`mask_g’”©iÚ
(
g’_Ãxt
 - 1) &&

4987 
g’”©iÚ
 !ð
g’_Ãxt
)

4988 
baž
;

4990 ià(
q´iv
->
»sync
)

4991 
baž
;

4993 
	`¥š_lock
(&
rcd
->
exp_lock
);

4994 ià(
fs
->
šdex
 >ð
RXE_NUM_TID_FLOWS
) {

4999 
fs
->
g’”©iÚ
 = generation;

5002 
rcd
->
æows
[
fs
->
šdex
].
g’”©iÚ
 = generation;

5003 
fs
->
g’”©iÚ
 = 
	`k”n_£tup_hw_æow
(
rcd
, fs->
šdex
);

5005 
fs
->
p¢
 = 0;

5010 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_SW_PSN
;

5011 
	`Œaû_hfi1_tid_wr™e_r¥_rcv_»sync
(
qp
);

5018 
idx
 = 
q´iv
->
r_tid_ž
; ; idx++) {

5019 
u16
 
æow_idx
;

5021 ià(
idx
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

5022 
idx
 = 0;

5023 
e
 = &
qp
->
s_ack_queue
[
idx
];

5024 ià(
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
)) {

5025 
»q
 = 
	`ack_to_tid_»q
(
e
);

5026 
	`Œaû_hfi1_tid_»q_rcv_»sync
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,

5027 
e
->
Í¢
, 
»q
);

5030 
æow_idx
 = 
»q
->
þ—r_ž
;

5031 
	`CIRC_CNT
(
»q
->
£tup_h—d
, 
æow_idx
,

5032 
MAX_FLOWS
);

5033 
æow_idx
 = 
	`CIRC_NEXT
(æow_idx, 
MAX_FLOWS
)) {

5034 
u32
 
Í¢
;

5035 
u32
 
Ãxt
;

5037 
æow
 = &
»q
->
æows
[
æow_idx
];

5038 
Í¢
 = 
	`fuÎ_æow_p¢
(
æow
,

5039 
æow
->
æow_¡©e
.
Í¢
);

5040 
Ãxt
 = 
æow
->
æow_¡©e
.
r_Ãxt_p¢
;

5041 
æow
->
Åkts
 = 
	`d–_p¢
(
Í¢
, 
Ãxt
 - 1);

5042 
æow
->
æow_¡©e
.
g’”©iÚ
 = 
fs
->generation;

5043 
æow
->
æow_¡©e
.
¥¢
 = 
fs
->
p¢
;

5044 
æow
->
æow_¡©e
.
Í¢
 =

5045 
æow
->
æow_¡©e
.
¥¢
 + flow->
Åkts
 - 1;

5046 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

5047 
	`fuÎ_æow_p¢
(
æow
,

5048 
æow
->
æow_¡©e
.
¥¢
);

5049 
fs
->
p¢
 +ð
æow
->
Åkts
;

5050 
	`Œaû_hfi1_tid_æow_rcv_»sync
(
qp
, 
æow_idx
,

5051 
æow
);

5054 ià(
idx
 =ð
qp
->
s_ž_ack_queue
)

5058 
	`¥š_uÆock
(&
rcd
->
exp_lock
);

5059 
q´iv
->
»sync
 = 
Œue
;

5061 
q´iv
->
s_Çk_¡©e
 = 0;

5062 
	`tid_rdma_Œigg”_ack
(
qp
);

5063 
baž
:

5064 ià(
ãú
)

5065 
qp
->
s_æags
 |ð
RVT_S_ECN
;

5066 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

5067 
	}
}

5073 
	$upd©e_tid_ž
(
rvt_qp
 *
qp
)

5074 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

5076 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5077 
u32
 
i
;

5078 
rvt_swqe
 *
wqe
;

5080 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

5082 ià(
´iv
->
s_tid_ž
 =ð´iv->
s_tid_cur
)

5084 
i
 = 
´iv
->
s_tid_ž
 + 1; ; i++) {

5085 ià(
i
 =ð
qp
->
s_size
)

5086 
i
 = 0;

5088 ià(
i
 =ð
´iv
->
s_tid_cur
)

5090 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
i
);

5091 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_TID_RDMA_WRITE
)

5094 
´iv
->
s_tid_ž
 = 
i
;

5095 
´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_RESP
);

5096 
	}
}

5098 
	$hfi1_make_tid_rdma_pkt
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
)

5099 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

5101 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5102 
rvt_swqe
 *
wqe
;

5103 
u32
 
bth1
 = 0, 
bth2
 = 0, 
hwÜds
 = 5, 
Ën
, 
middË
 = 0;

5104 
ib_Ùh”_h—d”s
 *
ohdr
;

5105 
rvt_sge_¡©e
 *
ss
 = &
qp
->
s_sge
;

5106 
rvt_ack_’Œy
 *
e
 = &
qp
->
s_ack_queue
[qp->
s_ž_ack_queue
];

5107 
tid_rdma_»que¡
 *
»q
 = 
	`ack_to_tid_»q
(
e
);

5108 
boÞ
 
Ï¡
 = 
çl£
;

5109 
u8
 
Ýcode
 = 
	`TID_OP
(
WRITE_DATA
);

5111 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

5112 
	`Œaû_hfi1_tid_wr™e_£nd”_make_tid_pkt
(
qp
, 0);

5117 ià(((
	`©omic_»ad
(&
´iv
->
n_tid_»que¡s
è< 
HFI1_TID_RDMA_WRITE_CNT
) &&

5118 
	`©omic_»ad
(&
´iv
->
n_»que¡s
) &&

5119 !(
qp
->
s_æags
 & (
RVT_S_BUSY
 | 
RVT_S_WAIT_ACK
 |

5120 
HFI1_S_ANY_WAIT_IO
))) ||

5121 (
e
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
è&& 
»q
->
cur_£g
 <„eq->
®loc_£g
 &&

5122 !(
qp
->
s_æags
 & (
RVT_S_BUSY
 | 
HFI1_S_ANY_WAIT_IO
)))) {

5123 
iowa™_wÜk
 *
iowÜk
;

5125 
iowÜk
 = 
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
);

5126 
ps
->
s_tx»q
 = 
	`g‘_wa™šg_v”bs_tx»q
(
iowÜk
);

5127 ià(
ps
->
s_tx»q
 || 
	`hfi1_make_rc_»q
(
qp
,…s)) {

5128 
´iv
->
s_æags
 |ð
HFI1_S_TID_BUSY_SET
;

5133 
ps
->
s_tx»q
 = 
	`g‘_tx»q
Õs->
dev
, 
qp
);

5134 ià(!
ps
->
s_tx»q
)

5135 
baž_no_tx
;

5137 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
Ùh
;

5139 ià((
´iv
->
s_æags
 & 
RVT_S_ACK_PENDING
) &&

5140 
	`make_tid_rdma_ack
(
qp
, 
ohdr
, 
ps
))

5149 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_SEND_OK
))

5150 
baž
;

5152 ià(
´iv
->
s_æags
 & 
RVT_S_WAIT_ACK
)

5153 
baž
;

5156 ià(
´iv
->
s_tid_ž
 =ð
HFI1_QP_WQE_INVALID
)

5157 
baž
;

5158 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
´iv
->
s_tid_ž
);

5159 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

5160 
	`Œaû_hfi1_tid_»q_make_tid_pkt
(
qp
, 0, 
wqe
->
wr
.
Ýcode
, wqe->
p¢
,

5161 
wqe
->
Í¢
, 
»q
);

5162 
´iv
->
s_¡©e
) {

5163 
	`TID_OP
(
WRITE_REQ
):

5164 
	`TID_OP
(
WRITE_RESP
):

5165 
´iv
->
tid_ss
.
sge
 = 
wqe
->
sg_li¡
[0];

5166 
´iv
->
tid_ss
.
sg_li¡
 = 
wqe
->sg_list + 1;

5167 
´iv
->
tid_ss
.
num_sge
 = 
wqe
->
wr
.num_sge;

5168 
´iv
->
tid_ss
.
tÙ®_Ën
 = 
wqe
->
Ëngth
;

5170 ià(
´iv
->
s_¡©e
 =ð
	`TID_OP
(
WRITE_REQ
))

5171 
	`hfi1_tid_rdma_»¡¬t_»q
(
qp
, 
wqe
, &
bth2
);

5172 
´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_DATA
);

5175 
	`TID_OP
(
WRITE_DATA
):

5189 
	`Œaû_hfi1_£nd”_make_tid_pkt
(
qp
);

5190 
	`Œaû_hfi1_tid_wr™e_£nd”_make_tid_pkt
(
qp
, 0);

5191 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
´iv
->
s_tid_ž
);

5192 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

5193 
Ën
 = 
wqe
->
Ëngth
;

5195 ià(!
»q
->
comp_£g
 ||„eq->
cur_£g
 ==„eq->comp_seg)

5196 
baž
;

5198 
	`Œaû_hfi1_tid_»q_make_tid_pkt
(
qp
, 0, 
wqe
->
wr
.
Ýcode
,

5199 
wqe
->
p¢
, wqe->
Í¢
, 
»q
);

5200 
Ï¡
 = 
	`hfi1_bužd_tid_rdma_·ck‘
(
wqe
, 
ohdr
, &
bth1
, &
bth2
,

5201 &
Ën
);

5203 ià(
Ï¡
) {

5205 
»q
->
þ—r_ž
 = 
	`CIRC_NEXT
(req->clear_tail,

5206 
MAX_FLOWS
);

5207 ià(++
»q
->
cur_£g
 <„eq->
tÙ®_£gs
) {

5208 ià(!
	`CIRC_CNT
(
»q
->
£tup_h—d
,„eq->
þ—r_ž
,

5209 
MAX_FLOWS
))

5210 
qp
->
s_æags
 |ð
HFI1_S_WAIT_TID_RESP
;

5212 
´iv
->
s_¡©e
 = 
	`TID_OP
(
WRITE_DATA_LAST
);

5213 
Ýcode
 = 
	`TID_OP
(
WRITE_DATA_LAST
);

5216 
	`upd©e_tid_ž
(
qp
);

5219 
hwÜds
 +ð(
ohdr
->
u
.
tid_rdma
.
w_d©a
è/ (
u32
);

5220 
ss
 = &
´iv
->
tid_ss
;

5223 
	`TID_OP
(
RESYNC
):

5224 
	`Œaû_hfi1_£nd”_make_tid_pkt
(
qp
);

5226 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, 
´iv
->
s_tid_cur
);

5227 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

5229 ià(!
»q
->
comp_£g
) {

5230 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
,

5231 (!
´iv
->
s_tid_cur
 ? 
qp
->
s_size
 :

5232 
´iv
->
s_tid_cur
) - 1);

5233 
»q
 = 
	`wqe_to_tid_»q
(
wqe
);

5235 
hwÜds
 +ð
	`hfi1_bužd_tid_rdma_»sync
(
qp
, 
wqe
, 
ohdr
, &
bth1
,

5236 &
bth2
,

5237 
	`CIRC_PREV
(
»q
->
£tup_h—d
,

5238 
MAX_FLOWS
));

5239 
ss
 = 
NULL
;

5240 
Ën
 = 0;

5241 
Ýcode
 = 
	`TID_OP
(
RESYNC
);

5245 
baž
;

5247 ià(
´iv
->
s_æags
 & 
RVT_S_SEND_ONE
) {

5248 
´iv
->
s_æags
 &ð~
RVT_S_SEND_ONE
;

5249 
´iv
->
s_æags
 |ð
RVT_S_WAIT_ACK
;

5250 
bth2
 |ð
IB_BTH_REQ_ACK
;

5252 
qp
->
s_Ën
 -ð
Ën
;

5253 
ps
->
s_tx»q
->
hdr_dwÜds
 = 
hwÜds
;

5254 
ps
->
s_tx»q
->
sde
 = 
´iv
->
s_sde
;

5255 
ps
->
s_tx»q
->
ss
 = ss;

5256 
ps
->
s_tx»q
->
s_cur_size
 = 
Ën
;

5257 
	`hfi1_make_ruc_h—d”
(
qp
, 
ohdr
, (
Ýcode
 << 24), 
bth1
, 
bth2
,

5258 
middË
, 
ps
);

5260 
baž
:

5261 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

5262 
baž_no_tx
:

5263 
ps
->
s_tx»q
 = 
NULL
;

5264 
´iv
->
s_æags
 &ð~
RVT_S_BUSY
;

5272 
	`iowa™_£t_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
);

5274 
	}
}

5276 
	$make_tid_rdma_ack
(
rvt_qp
 *
qp
,

5277 
ib_Ùh”_h—d”s
 *
ohdr
,

5278 
hfi1_pkt_¡©e
 *
ps
)

5280 
rvt_ack_’Œy
 *
e
;

5281 
hfi1_qp_´iv
 *
q´iv
 = 
qp
->
´iv
;

5282 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

5283 
u32
 
hwÜds
, 
Ãxt
;

5284 
u32
 
Ën
 = 0;

5285 
u32
 
bth1
 = 0, 
bth2
 = 0;

5286 
middË
 = 0;

5287 
u16
 
æow
;

5288 
tid_rdma_»que¡
 *
»q
, *
Äeq
;

5290 
	`Œaû_hfi1_tid_wr™e_r¥_make_tid_ack
(
qp
);

5292 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
))

5293 
baž
;

5296 
hwÜds
 = 5;

5298 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ack
];

5299 
»q
 = 
	`ack_to_tid_»q
(
e
);

5312 ià(
q´iv
->
»sync
) {

5313 ià(!
»q
->
ack_£g
 ||„eq->ack_£g =ð»q->
tÙ®_£gs
)

5314 
q´iv
->
r_tid_ack
 = !qpriv->r_tid_ack ?

5315 
	`rvt_size_©omic
(&
dev
->
rdi
) :

5316 
q´iv
->
r_tid_ack
 - 1;

5317 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ack
];

5318 
»q
 = 
	`ack_to_tid_»q
(
e
);

5321 
	`Œaû_hfi1_r¥_make_tid_ack
(
qp
, 
e
->
p¢
);

5322 
	`Œaû_hfi1_tid_»q_make_tid_ack
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

5323 
»q
);

5328 ià(!
q´iv
->
s_Çk_¡©e
 && !q´iv->
»sync
 &&

5329 
»q
->
ack_£g
 =ð»q->
comp_£g
)

5330 
baž
;

5339 
»q
->
ack_£g
 +=

5341 
	`CIRC_CNT
(
»q
->
þ—r_ž
,„eq->
acked_ž
,

5342 
MAX_FLOWS
);

5344 
»q
->
acked_ž
 =„eq->
þ—r_ž
;

5351 
æow
 = 
	`CIRC_PREV
(
»q
->
acked_ž
, 
MAX_FLOWS
);

5352 ià(
»q
->
ack_£g
 !ð»q->
tÙ®_£gs
)

5354 
»q
->
¡©e
 = 
TID_REQUEST_COMPLETE
;

5356 
Ãxt
 = 
q´iv
->
r_tid_ack
 + 1;

5357 ià(
Ãxt
 > 
	`rvt_size_©omic
(&
dev
->
rdi
))

5358 
Ãxt
 = 0;

5359 
q´iv
->
r_tid_ack
 = 
Ãxt
;

5360 ià(
qp
->
s_ack_queue
[
Ãxt
].
Ýcode
 !ð
	`TID_OP
(
WRITE_REQ
))

5362 
Äeq
 = 
	`ack_to_tid_»q
(&
qp
->
s_ack_queue
[
Ãxt
]);

5363 ià(!
Äeq
->
comp_£g
 ||‚»q->
ack_£g
 ==‚req->comp_seg)

5367 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ack
];

5368 
»q
 = 
	`ack_to_tid_»q
(
e
);

5375 ià(
q´iv
->
s_Çk_¡©e
 ||

5376 (
q´iv
->
»sync
 &&

5377 !
	`hfi1_tid_rdma_is_»sync_p¢
(
q´iv
->
r_Ãxt_p¢_kd‘h
 - 1) &&

5378 (
	`cmp_p¢
(
q´iv
->
r_Ãxt_p¢_kd‘h
 - 1,

5379 
	`fuÎ_æow_p¢
(&
»q
->
æows
[
æow
],

5380 
»q
->
æows
[
æow
].
æow_¡©e
.
Í¢
)) > 0))) {

5388 
e
 = &
qp
->
s_ack_queue
[
q´iv
->
r_tid_ack
];

5389 
»q
 = 
	`ack_to_tid_»q
(
e
);

5390 
æow
 = 
»q
->
acked_ž
;

5391 } ià(
»q
->
ack_£g
 =ð»q->
tÙ®_£gs
 &&

5392 
q´iv
->
s_æags
 & 
HFI1_R_TID_WAIT_INTERLCK
)

5393 
q´iv
->
s_æags
 &ð~
HFI1_R_TID_WAIT_INTERLCK
;

5395 
	`Œaû_hfi1_tid_wr™e_r¥_make_tid_ack
(
qp
);

5396 
	`Œaû_hfi1_tid_»q_make_tid_ack
(
qp
, 0, 
e
->
Ýcode
,ƒ->
p¢
,ƒ->
Í¢
,

5397 
»q
);

5398 
hwÜds
 +ð
	`hfi1_bužd_tid_rdma_wr™e_ack
(
qp
, 
e
, 
ohdr
, 
æow
, &
bth1
,

5399 &
bth2
);

5400 
Ën
 = 0;

5401 
q´iv
->
s_æags
 &ð~
RVT_S_ACK_PENDING
;

5402 
ps
->
s_tx»q
->
hdr_dwÜds
 = 
hwÜds
;

5403 
ps
->
s_tx»q
->
sde
 = 
q´iv
->
s_sde
;

5404 
ps
->
s_tx»q
->
s_cur_size
 = 
Ën
;

5405 
ps
->
s_tx»q
->
ss
 = 
NULL
;

5406 
	`hfi1_make_ruc_h—d”
(
qp
, 
ohdr
, (
	`TID_OP
(
ACK
è<< 24), 
bth1
, 
bth2
, 
middË
,

5407 
ps
);

5408 
ps
->
s_tx»q
->
tx»q
.
æags
 |ð
SDMA_TXREQ_F_VIP
;

5410 
baž
:

5415 
	`smp_wmb
();

5416 
q´iv
->
s_æags
 &ð~
RVT_S_ACK_PENDING
;

5418 
	}
}

5420 
	$hfi1_£nd_tid_ok
(
rvt_qp
 *
qp
)

5422 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5424  !(
´iv
->
s_æags
 & 
RVT_S_BUSY
 ||

5425 
qp
->
s_æags
 & 
HFI1_S_ANY_WAIT_IO
) &&

5426 (
	`v”bs_tx»q_queued
(
	`iowa™_g‘_tid_wÜk
(&
´iv
->
s_iowa™
)) ||

5427 (
´iv
->
s_æags
 & 
RVT_S_RESP_PENDING
) ||

5428 !(
qp
->
s_æags
 & 
HFI1_S_ANY_TID_WAIT_SEND
));

5429 
	}
}

5431 
	$_hfi1_do_tid_£nd
(
wÜk_¡ruù
 *
wÜk
)

5433 
iowa™_wÜk
 *
w
 = 
	`cÚš”_of
(
wÜk
, iowa™_wÜk, 
iowÜk
);

5434 
rvt_qp
 *
qp
 = 
	`iowa™_to_qp
(
w
->
iow
);

5436 
	`hfi1_do_tid_£nd
(
qp
);

5437 
	}
}

5439 
	$hfi1_do_tid_£nd
(
rvt_qp
 *
qp
)

5441 
hfi1_pkt_¡©e
 
ps
;

5442 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5444 
ps
.
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

5445 
ps
.
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

5446 
ps
.
µd
 = 
	`µd_äom_ibp
Õs.
ibp
);

5447 
ps
.
wa™
 = 
	`iowa™_g‘_tid_wÜk
(&
´iv
->
s_iowa™
);

5448 
ps
.
š_th»ad
 = 
çl£
;

5449 
ps
.
timeout_št
 = 
qp
->
timeout_jiff›s
 / 8;

5451 
	`Œaû_hfi1_rc_do_tid_£nd
(
qp
, 
çl£
);

5452 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
.
æags
);

5455 ià(!
	`hfi1_£nd_tid_ok
(
qp
)) {

5456 ià(
qp
->
s_æags
 & 
HFI1_S_ANY_WAIT_IO
)

5457 
	`iowa™_£t_æag
(&
´iv
->
s_iowa™
, 
IOWAIT_PENDING_TID
);

5458 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

5462 
´iv
->
s_æags
 |ð
RVT_S_BUSY
;

5464 
ps
.
timeout
 = 
jiff›s
 +…s.
timeout_št
;

5465 
ps
.
ýu
 = 
´iv
->
s_sde
 ?…riv->s_sde->cpu :

5466 
	`ýumask_fœ¡
(
	`ýumask_of_node
(
ps
.
µd
->
dd
->
node
));

5467 
ps
.
pkts_£Á
 = 
çl£
;

5470 
ps
.
s_tx»q
 = 
	`g‘_wa™šg_v”bs_tx»q
Õs.
wa™
);

5473 ià(
ps
.
s_tx»q
) {

5474 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_BUSY_SET
) {

5475 
qp
->
s_æags
 |ð
RVT_S_BUSY
;

5476 
ps
.
wa™
 = 
	`iowa™_g‘_ib_wÜk
(&
´iv
->
s_iowa™
);

5478 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

5484 ià(
	`hfi1_v”bs_£nd
(
qp
, &
ps
))

5488 ià(
	`hfi1_scheduË_£nd_y›ld
(
qp
, &
ps
, 
Œue
))

5491 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
ps
.
æags
);

5492 ià(
´iv
->
s_æags
 & 
HFI1_S_TID_BUSY_SET
) {

5493 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

5494 
´iv
->
s_æags
 &ð~
HFI1_S_TID_BUSY_SET
;

5495 
ps
.
wa™
 = 
	`iowa™_g‘_tid_wÜk
(&
´iv
->
s_iowa™
);

5496 ià(
	`iowa™_æag_£t
(&
´iv
->
s_iowa™
,

5497 
IOWAIT_PENDING_IB
))

5498 
	`hfi1_scheduË_£nd
(
qp
);

5501 } 
	`hfi1_make_tid_rdma_pkt
(
qp
, &
ps
));

5502 
	`iowa™_¡¬ve_þ—r
(
ps
.
pkts_£Á
, &
´iv
->
s_iowa™
);

5503 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
ps
.
æags
);

5504 
	}
}

5506 
boÞ
 
	$_hfi1_scheduË_tid_£nd
(
rvt_qp
 *
qp
)

5508 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5509 
hfi1_ibpÜt
 *
ibp
 =

5510 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

5511 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

5512 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

5514 ià((
dd
->
æags
 & 
HFI1_SHUTDOWN
))

5515  
Œue
;

5517  
	`iowa™_tid_scheduË
(&
´iv
->
s_iowa™
, 
µd
->
hfi1_wq
,

5518 
´iv
->
s_sde
 ?

5519 
´iv
->
s_sde
->
ýu
 :

5520 
	`ýumask_fœ¡
(
	`ýumask_of_node
(
dd
->
node
)));

5521 
	}
}

5536 
boÞ
 
	$hfi1_scheduË_tid_£nd
(
rvt_qp
 *
qp
)

5538 
	`lockd•_as£¹_h–d
(&
qp
->
s_lock
);

5539 ià(
	`hfi1_£nd_tid_ok
(
qp
)) {

5546 
	`_hfi1_scheduË_tid_£nd
(
qp
);

5547  
Œue
;

5549 ià(
qp
->
s_æags
 & 
HFI1_S_ANY_WAIT_IO
)

5550 
	`iowa™_£t_æag
(&((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_iowa™
,

5551 
IOWAIT_PENDING_TID
);

5552  
çl£
;

5553 
	}
}

5555 
boÞ
 
	$hfi1_tid_rdma_ack_š‹¾ock
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
)

5557 
rvt_ack_’Œy
 *
´ev
;

5558 
tid_rdma_»que¡
 *
»q
;

5559 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

5560 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

5561 
u32
 
s_´ev
;

5563 
s_´ev
 = 
qp
->
s_ž_ack_queue
 =ð0 ? 
	`rvt_size_©omic
(&
dev
->
rdi
) :

5564 (
qp
->
s_ž_ack_queue
 - 1);

5565 
´ev
 = &
qp
->
s_ack_queue
[
s_´ev
];

5567 ià((
e
->
Ýcode
 =ð
	`TID_OP
(
READ_REQ
) ||

5568 
e
->
Ýcode
 =ð
	`OP
(
RDMA_READ_REQUEST
)) &&

5569 
´ev
->
Ýcode
 =ð
	`TID_OP
(
WRITE_REQ
)) {

5570 
»q
 = 
	`ack_to_tid_»q
(
´ev
);

5571 ià(
»q
->
ack_£g
 !ð»q->
tÙ®_£gs
) {

5572 
´iv
->
s_æags
 |ð
HFI1_R_TID_WAIT_INTERLCK
;

5573  
Œue
;

5576  
çl£
;

5577 
	}
}

5579 
u32
 
	$»ad_r_Ãxt_p¢
(
hfi1_devd©a
 *
dd
, 
u8
 
ùxt
, u8 
fidx
)

5581 
u64
 
»g
;

5587 
»g
 = 
	`»ad_uùxt_c¤
(
dd
, 
ùxt
, 
RCV_TID_FLOW_TABLE
 + (8 * 
fidx
));

5588  
	`mask_p¢
(
»g
);

5589 
	}
}

5591 
	$tid_rdma_rcv_”r
(
hfi1_·ck‘
 *
·ck‘
,

5592 
ib_Ùh”_h—d”s
 *
ohdr
,

5593 
rvt_qp
 *
qp
, 
u32
 
p¢
, 
diff
, 
boÞ
 
ãú
)

5595 
æags
;

5597 
	`tid_rdma_rcv_”rÜ
(
·ck‘
, 
ohdr
, 
qp
, 
p¢
, 
diff
);

5598 ià(
ãú
) {

5599 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

5600 
qp
->
s_æags
 |ð
RVT_S_ECN
;

5601 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

5603 
	}
}

5605 
	$upd©e_r_Ãxt_p¢_ãú
(
hfi1_·ck‘
 *
·ck‘
,

5606 
hfi1_qp_´iv
 *
´iv
,

5607 
hfi1_ùxtd©a
 *
rcd
,

5608 
tid_rdma_æow
 *
æow
,

5609 
boÞ
 
ãú
)

5615 ià(
ãú
 && 
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_EAGER
 &&

5616 !(
´iv
->
s_æags
 & 
HFI1_R_TID_SW_PSN
)) {

5617 
hfi1_devd©a
 *
dd
 = 
rcd
->dd;

5619 
æow
->
æow_¡©e
.
r_Ãxt_p¢
 =

5620 
	`»ad_r_Ãxt_p¢
(
dd
, 
rcd
->
ùxt
, 
æow
->
idx
);

5622 
	}
}

	@tid_rdma.h

47 #iâdeà
HFI1_TID_RDMA_H


48 
	#HFI1_TID_RDMA_H


	)

50 
	~<lšux/cœc_buf.h
>

51 
	~"commÚ.h
"

54 
	#CIRC_ADD
(
v®
, 
add
, 
size
è(((v®è+ (add)è& ((sizeè- 1))

	)

55 
	#CIRC_NEXT
(
v®
, 
size
è
	`CIRC_ADD
(v®, 1, size)

	)

56 
	#CIRC_PREV
(
v®
, 
size
è
	`CIRC_ADD
(v®, -1, size)

	)

58 
	#TID_RDMA_MIN_SEGMENT_SIZE
 
	`BIT
(18è

	)

59 
	#TID_RDMA_MAX_SEGMENT_SIZE
 
	`BIT
(18è

	)

60 
	#TID_RDMA_MAX_PAGES
 (
	`BIT
(18è>> 
PAGE_SHIFT
)

	)

61 
	#TID_RDMA_SEGMENT_SHIFT
 18

	)

72 
	#HFI1_S_TID_BUSY_SET
 
	`BIT
(0)

	)

74 
	#HFI1_R_TID_RSC_TIMER
 
	`BIT
(2)

	)

77 
	#HFI1_S_TID_WAIT_INTERLCK
 
	`BIT
(5)

	)

78 
	#HFI1_R_TID_WAIT_INTERLCK
 
	`BIT
(6)

	)

81 
	#HFI1_S_TID_RETRY_TIMER
 
	`BIT
(17)

	)

83 
	#HFI1_R_TID_SW_PSN
 
	`BIT
(19)

	)

97 
	#HFI1_TID_RDMA_WRITE_CNT
 8

	)

99 
	stid_rdma_·¿ms
 {

100 
rcu_h—d
 
	mrcu_h—d
;

101 
u32
 
	mqp
;

102 
u32
 
	mmax_Ën
;

103 
u16
 
	mjkey
;

104 
u8
 
	mmax_»ad
;

105 
u8
 
	mmax_wr™e
;

106 
u8
 
	mtimeout
;

107 
u8
 
	murg
;

108 
u8
 
	mv”siÚ
;

111 
	stid_rdma_qp_·¿ms
 {

112 
wÜk_¡ruù
 
	mŒigg”_wÜk
;

113 
tid_rdma_·¿ms
 
	mloÿl
;

114 
tid_rdma_·¿ms
 
__rcu
 *
	m»mÙe
;

118 
	stid_æow_¡©e
 {

119 
u32
 
	mg’”©iÚ
;

120 
u32
 
	mp¢
;

121 
u8
 
	mšdex
;

122 
u8
 
	mÏ¡_šdex
;

125 
	etid_rdma_»q_¡©e
 {

126 
	mTID_REQUEST_INACTIVE
 = 0,

127 
	mTID_REQUEST_INIT
,

128 
	mTID_REQUEST_INIT_RESEND
,

129 
	mTID_REQUEST_ACTIVE
,

130 
	mTID_REQUEST_RESEND
,

131 
	mTID_REQUEST_RESEND_ACTIVE
,

132 
	mTID_REQUEST_QUEUED
,

133 
	mTID_REQUEST_SYNC
,

134 
	mTID_REQUEST_RNR_NAK
,

135 
	mTID_REQUEST_COMPLETE
,

138 
	stid_rdma_»que¡
 {

139 
rvt_qp
 *
	mqp
;

140 
hfi1_ùxtd©a
 *
	mrcd
;

142 
rvt_swqe
 *
	mswqe
;

143 
rvt_ack_’Œy
 *
	mack
;

144 } 
	me
;

146 
tid_rdma_æow
 *
	mæows
;

147 
rvt_sge_¡©e
 
	mss
;

148 
u16
 
	mn_æows
;

149 
u16
 
	m£tup_h—d
;

150 
u16
 
	mþ—r_ž
;

151 
u16
 
	mæow_idx
;

152 
u16
 
	macked_ž
;

154 
u32
 
	m£g_Ën
;

155 
u32
 
	mtÙ®_Ën
;

156 
u32
 
	mr_ack_p¢
;

157 
u32
 
	mr_æow_p¢
;

158 
u32
 
	mr_Ï¡_acked
;

159 
u32
 
	ms_Ãxt_p¢
;

161 
u32
 
	mtÙ®_£gs
;

162 
u32
 
	mcur_£g
;

163 
u32
 
	mcomp_£g
;

164 
u32
 
	mack_£g
;

165 
u32
 
	m®loc_£g
;

166 
u32
 
	misge
;

167 
u32
 
	mack_³ndšg
;

169 
tid_rdma_»q_¡©e
 
	m¡©e
;

178 
	sæow_¡©e
 {

179 
u32
 
	mæags
;

180 
u32
 
	m»¥_ib_p¢
;

181 
u32
 
	mg’”©iÚ
;

182 
u32
 
	m¥¢
;

183 
u32
 
	mÍ¢
;

184 
u32
 
	mr_Ãxt_p¢
;

187 
u32
 
	mib_¥¢
;

188 
u32
 
	mib_Í¢
;

191 
	stid_rdma_·ge£t
 {

192 
dma_addr_t
 
	maddr
 : 48;

193 
u8
 
	midx
: 8;

194 
u8
 
	mcouÁ
 : 7;

195 
u8
 
	mm­³d
: 1;

205 
	sk”n_tid_node
 {

206 
tid_group
 *
	mg½
;

207 
u8
 
	mm­
;

208 
u8
 
	mút
;

212 
	stid_rdma_æow
 {

219 
æow_¡©e
 
	mæow_¡©e
;

220 
tid_rdma_»que¡
 *
	m»q
;

221 
u32
 
	mtid_q²
;

222 
u32
 
	mtid_off£t
;

223 
u32
 
	mËngth
;

224 
u32
 
	m£Á
;

225 
u8
 
	mŠode_út
;

226 
u8
 
	mtidút
;

227 
u8
 
	mtid_idx
;

228 
u8
 
	midx
;

229 
u8
 
	mÅage£ts
;

230 
u8
 
	mÅkts
;

231 
u8
 
	mpkt
;

232 
u8
 
	m»sync_Åkts
;

233 
k”n_tid_node
 
	mŠode
[
TID_RDMA_MAX_PAGES
];

234 
tid_rdma_·ge£t
 
	m·ge£ts
[
TID_RDMA_MAX_PAGES
];

235 
u32
 
	mtid_’Œy
[
TID_RDMA_MAX_PAGES
];

238 
	etid_ºr_Çk_¡©e
 {

239 
	mTID_RNR_NAK_INIT
 = 0,

240 
	mTID_RNR_NAK_SEND
,

241 
	mTID_RNR_NAK_SENT
,

244 
boÞ
 
tid_rdma_cÚn_»q
(
rvt_qp
 *
qp
, 
u64
 *
d©a
);

245 
boÞ
 
tid_rdma_cÚn_»¶y
(
rvt_qp
 *
qp
, 
u64
 
d©a
);

246 
boÞ
 
tid_rdma_cÚn_»¥
(
rvt_qp
 *
qp
, 
u64
 *
d©a
);

247 
tid_rdma_cÚn_”rÜ
(
rvt_qp
 *
qp
);

248 
tid_rdma_Ýâ_š™
(
rvt_qp
 *
qp
, 
tid_rdma_·¿ms
 *
p
);

250 
hfi1_k”n_exp_rcv_š™
(
hfi1_ùxtd©a
 *
rcd
, 
»š™
);

251 
hfi1_k”n_exp_rcv_£tup
(
tid_rdma_»que¡
 *
»q
,

252 
rvt_sge_¡©e
 *
ss
, 
boÞ
 *
Ï¡
);

253 
hfi1_k”n_exp_rcv_þ—r
(
tid_rdma_»que¡
 *
»q
);

254 
hfi1_k”n_exp_rcv_þ—r_®l
(
tid_rdma_»que¡
 *
»q
);

255 
__Œdma_þ—n_swqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
);

262 
šlše
 
	$Œdma_þ—n_swqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
)

264 ià(!
wqe
->
´iv
)

266 
	`__Œdma_þ—n_swqe
(
qp
, 
wqe
);

267 
	}
}

269 
hfi1_k”n_»ad_tid_æow_ä“
(
rvt_qp
 *
qp
);

271 
hfi1_qp_´iv_š™
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
,

272 
ib_qp_š™_©Œ
 *
š™_©Œ
);

273 
hfi1_qp_´iv_tid_ä“
(
rvt_dev_šfo
 *
rdi
, 
rvt_qp
 *
qp
);

275 
hfi1_tid_rdma_æush_wa™
(
rvt_qp
 *
qp
);

277 
hfi1_k”n_£tup_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
rvt_qp
 *
qp
);

278 
hfi1_k”n_þ—r_hw_æow
(
hfi1_ùxtd©a
 *
rcd
, 
rvt_qp
 *
qp
);

279 
hfi1_k”n_š™_ùxt_g’”©iÚs
(
hfi1_ùxtd©a
 *
rcd
);

281 
	gúŒ_’Œy
;

282 
u64
 
hfi1_acûss_sw_tid_wa™
(cÚ¡ 
úŒ_’Œy
 *
’Œy
,

283 *
cÚ‹xt
, 
vl
, 
mode
, 
u64
 
d©a
);

285 
u32
 
hfi1_bužd_tid_rdma_»ad_·ck‘
(
rvt_swqe
 *
wqe
,

286 
ib_Ùh”_h—d”s
 *
ohdr
,

287 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
);

288 
u32
 
hfi1_bužd_tid_rdma_»ad_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

289 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

290 
u32
 *
bth2
, u32 *
Ën
);

291 
hfi1_rc_rcv_tid_rdma_»ad_»q
(
hfi1_·ck‘
 *
·ck‘
);

292 
u32
 
hfi1_bužd_tid_rdma_»ad_»¥
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

293 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth0
,

294 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
, 
boÞ
 *
Ï¡
);

295 
hfi1_rc_rcv_tid_rdma_»ad_»¥
(
hfi1_·ck‘
 *
·ck‘
);

296 
boÞ
 
hfi1_hªdË_kd‘h_eæags
(
hfi1_ùxtd©a
 *
rcd
,

297 
hfi1_µÜtd©a
 *
µd
,

298 
hfi1_·ck‘
 *
·ck‘
);

299 
hfi1_tid_rdma_»¡¬t_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

300 
u32
 *
bth2
);

301 
hfi1_qp_k”n_exp_rcv_þ—r_®l
(
rvt_qp
 *
qp
);

302 
boÞ
 
hfi1_tid_rdma_wqe_š‹¾ock
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
);

304 
£tup_tid_rdma_wqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
);

305 
šlše
 
	$hfi1_£tup_tid_rdma_wqe
(
rvt_qp
 *
qp
,

306 
rvt_swqe
 *
wqe
)

308 ià(
wqe
->
´iv
 &&

309 (
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_READ
 ||

310 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) &&

311 
wqe
->
Ëngth
 >ð
TID_RDMA_MIN_SEGMENT_SIZE
)

312 
	`£tup_tid_rdma_wqe
(
qp
, 
wqe
);

313 
	}
}

315 
u32
 
hfi1_bužd_tid_rdma_wr™e_»q
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

316 
ib_Ùh”_h—d”s
 *
ohdr
,

317 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
);

319 
hfi1_rc_rcv_tid_rdma_wr™e_»q
(
hfi1_·ck‘
 *
·ck‘
);

321 
u32
 
hfi1_bužd_tid_rdma_wr™e_»¥
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

322 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

323 
u32
 
bth2
, u32 *
Ën
,

324 
rvt_sge_¡©e
 **
ss
);

326 
hfi1_d–_tid_»­_tim”
(
rvt_qp
 *
qp
);

328 
hfi1_rc_rcv_tid_rdma_wr™e_»¥
(
hfi1_·ck‘
 *
·ck‘
);

330 
boÞ
 
hfi1_bužd_tid_rdma_·ck‘
(
rvt_swqe
 *
wqe
,

331 
ib_Ùh”_h—d”s
 *
ohdr
,

332 
u32
 *
bth1
, u32 *
bth2
, u32 *
Ën
);

334 
hfi1_rc_rcv_tid_rdma_wr™e_d©a
(
hfi1_·ck‘
 *
·ck‘
);

336 
u32
 
hfi1_bužd_tid_rdma_wr™e_ack
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
,

337 
ib_Ùh”_h—d”s
 *
ohdr
, 
u16
 
iæow
,

338 
u32
 *
bth1
, u32 *
bth2
);

340 
hfi1_rc_rcv_tid_rdma_ack
(
hfi1_·ck‘
 *
·ck‘
);

342 
hfi1_add_tid_»Œy_tim”
(
rvt_qp
 *
qp
);

343 
hfi1_d–_tid_»Œy_tim”
(
rvt_qp
 *
qp
);

345 
u32
 
hfi1_bužd_tid_rdma_»sync
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

346 
ib_Ùh”_h—d”s
 *
ohdr
, 
u32
 *
bth1
,

347 
u32
 *
bth2
, 
u16
 
fidx
);

349 
hfi1_rc_rcv_tid_rdma_»sync
(
hfi1_·ck‘
 *
·ck‘
);

351 
	ghfi1_pkt_¡©e
;

352 
hfi1_make_tid_rdma_pkt
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

354 
_hfi1_do_tid_£nd
(
wÜk_¡ruù
 *
wÜk
);

356 
boÞ
 
hfi1_scheduË_tid_£nd
(
rvt_qp
 *
qp
);

358 
boÞ
 
hfi1_tid_rdma_ack_š‹¾ock
(
rvt_qp
 *
qp
, 
rvt_ack_’Œy
 *
e
);

360 
hfi1_qp_tid_´št
(
£q_fže
 *
s
, 
rvt_qp
 *
qp
);

	@trace.c

47 
	#CREATE_TRACE_POINTS


	)

48 
	~"Œaû.h
"

49 
	~"u£r_sdma.h
"

50 
	~"com·t_commÚ.h
"

52 
u8
 
	$__g‘_ib_hdr_Ën
(
ib_h—d”
 *
hdr
)

54 
ib_Ùh”_h—d”s
 *
ohdr
;

55 
u8
 
Ýcode
;

57 ià(
	`ib_g‘_Êh
(
hdr
è=ð
HFI1_LRH_BTH
)

58 
ohdr
 = &
hdr
->
u
.
Ùh
;

60 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

61 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

62  
hdr_Ën_by_Ýcode
[
Ýcode
] == 0 ?

63 0 : 
hdr_Ën_by_Ýcode
[
Ýcode
] - (12 + 8);

64 
	}
}

66 
u8
 
	$__g‘_16b_hdr_Ën
(
hfi1_16b_h—d”
 *
hdr
)

68 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

69 
u8
 
Ýcode
;

70 
u8
 
l4
 = 
	`hfi1_16B_g‘_l4
(
hdr
);

72 ià(
l4
 =ð
OPA_16B_L4_FM
) {

73 
Ýcode
 = 
IB_OPCODE_UD_SEND_ONLY
;

77 ià(
l4
 =ð
OPA_16B_L4_IB_LOCAL
)

78 
ohdr
 = &
hdr
->
u
.
Ùh
;

80 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

82 
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

83  
hdr_Ën_by_Ýcode
[
Ýcode
] == 0 ?

84 0 : 
hdr_Ën_by_Ýcode
[
Ýcode
] - (12 + 8 + 8);

85 
	}
}

87 
u8
 
	$hfi1_Œaû_·ck‘_hdr_Ën
(
hfi1_·ck‘
 *
·ck‘
)

89 ià(
·ck‘
->
‘y³
 !ð
RHF_RCV_TYPE_BYPASS
)

90  
	`__g‘_ib_hdr_Ën
(
·ck‘
->
hdr
);

92  
	`__g‘_16b_hdr_Ën
(
·ck‘
->
hdr
);

93 
	}
}

95 
u8
 
	$hfi1_Œaû_Ýa_hdr_Ën
(
hfi1_Ýa_h—d”
 *
Ýa_hdr
)

97 ià(!
Ýa_hdr
->
hdr_ty³
)

98  
	`__g‘_ib_hdr_Ën
(&
Ýa_hdr
->
ibh
);

100  
	`__g‘_16b_hdr_Ën
(&
Ýa_hdr
->
Ýah
);

101 
	}
}

103 cÚ¡ *
	$hfi1_Œaû_g‘_·ck‘_l4_¡r
(
u8
 
l4
)

105 ià(
l4
)

109 
	}
}

111 cÚ¡ *
	$hfi1_Œaû_g‘_·ck‘_l2_¡r
(
u8
 
l2
)

113 
l2
) {

124 
	}
}

126 
	#IMM_PRN
 "imm:%d"

	)

127 
	#RETH_PRN
 "»th vaddr:0x%.16Îx„key:0x%.8x dËn:0x%.8x"

	)

128 
	#AETH_PRN
 "«th syn:0x%.2x % m¢:0x%.8x"

	)

129 
	#DETH_PRN
 "d‘h qkey:0x%.8x sq²:0x%.6x"

	)

130 
	#DETH_ENTROPY_PRN
 "d‘h qkey:0x%.8x sq²:0x%.6xƒÁrÝy:0x%.2x"

	)

131 
	#IETH_PRN
 "›th„key:0x%.8x"

	)

132 
	#ATOMICACKETH_PRN
 "Üigd©a:%Îx"

	)

133 
	#ATOMICETH_PRN
 "vaddr:0x%Îx„key:0x%.8x sd©a:%Îx cd©a:%Îx"

	)

134 
	#TID_RDMA_KDETH
 "kd‘h0 0x%x kd‘h1 0x%x"

	)

135 
	#TID_RDMA_KDETH_DATA
 "kd‘h0 0x%x: kv” %u sh %u iÁ¸%uidù¾ %uid %x off£ˆ%x kd‘h1 0x%x: jkey %x"

	)

136 
	#TID_WRITE_REQ_PRN
 "Üigš®_q°0x%x"

	)

137 
	#TID_WRITE_RSP_PRN
 "tid_æow_p¢ 0x%xid_æow_q°0x%x v”bs_q°0x%x"

	)

138 
	#TID_WRITE_DATA_PRN
 "v”bs_q°0x%x"

	)

139 
	#TID_READ_REQ_PRN
 "tid_æow_p¢ 0x%xid_æow_q°0x%x v”bs_q°0x%x"

	)

140 
	#TID_READ_RSP_PRN
 "v”bs_q°0x%x"

	)

141 
	#TID_ACK_PRN
 "tid_æow_p¢ 0x%x v”bs_p¢ 0x%xid_æow_q°0x%x v”bs_q°0x%x"

	)

142 
	#TID_RESYNC_PRN
 "v”bs_q°0x%x"

	)

144 
	#OP
(
Œª¥Üt
, 
Ý
è
IB_OPCODE_
##¿n¥Üˆ## 
_
 ## 
	)
op

146 cÚ¡ *
	$·r£_syndrome
(
u8
 
syndrome
)

148 
syndrome
 >> 5) {

157 
	}
}

159 
	$hfi1_Œaû_·r£_9b_bth
(
ib_Ùh”_h—d”s
 *
ohdr
,

160 
u8
 *
ack
, 
boÞ
 *
beú
, boÞ *
ãú
, u8 *
mig
,

161 
u8
 *
£
, u8 *
·d
, u8 *
Ýcode
, u8 *
tv”
,

162 
u16
 *
pkey
, 
u32
 *
p¢
, u32 *
q²
)

164 *
ack
 = 
	`ib_bth_g‘_ack»q
(
ohdr
);

165 *
beú
 = 
	`ib_bth_g‘_beú
(
ohdr
);

166 *
ãú
 = 
	`ib_bth_g‘_ãú
(
ohdr
);

167 *
mig
 = 
	`ib_bth_g‘_mig»q
(
ohdr
);

168 *
£
 = 
	`ib_bth_g‘_£
(
ohdr
);

169 *
·d
 = 
	`ib_bth_g‘_·d
(
ohdr
);

170 *
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

171 *
tv”
 = 
	`ib_bth_g‘_tv”
(
ohdr
);

172 *
pkey
 = 
	`ib_bth_g‘_pkey
(
ohdr
);

173 *
p¢
 = 
	`mask_p¢
(
	`ib_bth_g‘_p¢
(
ohdr
));

174 *
q²
 = 
	`ib_bth_g‘_q²
(
ohdr
);

175 
	}
}

177 
	$hfi1_Œaû_·r£_16b_bth
(
ib_Ùh”_h—d”s
 *
ohdr
,

178 
u8
 *
ack
, u8 *
mig
, u8 *
Ýcode
,

179 
u8
 *
·d
, u8 *
£
, u8 *
tv”
,

180 
u32
 *
p¢
, u32 *
q²
)

182 *
ack
 = 
	`ib_bth_g‘_ack»q
(
ohdr
);

183 *
mig
 = 
	`ib_bth_g‘_mig»q
(
ohdr
);

184 *
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

185 *
·d
 = 
	`ib_bth_g‘_·d
(
ohdr
);

186 *
£
 = 
	`ib_bth_g‘_£
(
ohdr
);

187 *
tv”
 = 
	`ib_bth_g‘_tv”
(
ohdr
);

188 *
p¢
 = 
	`mask_p¢
(
	`ib_bth_g‘_p¢
(
ohdr
));

189 *
q²
 = 
	`ib_bth_g‘_q²
(
ohdr
);

190 
	}
}

192 
	$hfi1_Œaû_·r£_9b_hdr
(
ib_h—d”
 *
hdr
, 
boÞ
 
sc5
,

193 
u8
 *
Êh
, u8 *
lv”
, u8 *
¦
, u8 *
sc
,

194 
u16
 *
Ën
, 
u32
 *
dlid
, u32 *
¦id
)

196 *
Êh
 = 
	`ib_g‘_Êh
(
hdr
);

197 *
lv”
 = 
	`ib_g‘_lv”
(
hdr
);

198 *
¦
 = 
	`ib_g‘_¦
(
hdr
);

199 *
sc
 = 
	`ib_g‘_sc
(
hdr
è| (
sc5
 << 4);

200 *
Ën
 = 
	`ib_g‘_Ën
(
hdr
);

201 *
dlid
 = 
	`ib_g‘_dlid
(
hdr
);

202 *
¦id
 = 
	`ib_g‘_¦id
(
hdr
);

203 
	}
}

205 
	$hfi1_Œaû_·r£_16b_hdr
(
hfi1_16b_h—d”
 *
hdr
,

206 
u8
 *
age
, 
boÞ
 *
beú
, boÞ *
ãú
,

207 
u8
 *
l4
, u8 *
rc
, u8 *
sc
,

208 
u16
 *
’ŒÝy
, u16 *
Ën
, u16 *
pkey
,

209 
u32
 *
dlid
, u32 *
¦id
)

211 *
age
 = 
	`hfi1_16B_g‘_age
(
hdr
);

212 *
beú
 = 
	`hfi1_16B_g‘_beú
(
hdr
);

213 *
ãú
 = 
	`hfi1_16B_g‘_ãú
(
hdr
);

214 *
l4
 = 
	`hfi1_16B_g‘_l4
(
hdr
);

215 *
rc
 = 
	`hfi1_16B_g‘_rc
(
hdr
);

216 *
sc
 = 
	`hfi1_16B_g‘_sc
(
hdr
);

217 *
’ŒÝy
 = 
	`hfi1_16B_g‘_’ŒÝy
(
hdr
);

218 *
Ën
 = 
	`hfi1_16B_g‘_Ën
(
hdr
);

219 *
pkey
 = 
	`hfi1_16B_g‘_pkey
(
hdr
);

220 *
dlid
 = 
	`hfi1_16B_g‘_dlid
(
hdr
);

221 *
¦id
 = 
	`hfi1_16B_g‘_¦id
(
hdr
);

222 
	}
}

224 
	#LRH_PRN
 "Ën:%d sc:%d dlid:0x%.4x slid:0x%.4x "

	)

225 
	#LRH_9B_PRN
 "Êh:%d,% lv”:%d sl:%d"

	)

226 
	#LRH_16B_PRN
 "age:%d becn:%d fecn:%d†4:%d " \

227 "rc:%d sc:%d…key:0x%.4xƒÁrÝy:0x%.4x"

	)

228 cÚ¡ *
	$hfi1_Œaû_fmt_Ìh
(
Œaû_£q
 *
p
, 
boÞ
 
by·ss
,

229 
u8
 
age
, 
boÞ
 
beú
, boÞ 
ãú
, u8 
l4
,

230 
u8
 
Êh
, cÚ¡ *
Êh_Çme
, u8 
lv”
,

231 
u8
 
rc
, u8 
sc
, u8 
¦
, 
u16
 
’ŒÝy
,

232 
u16
 
Ën
, u16 
pkey
, 
u32
 
dlid
, u32 
¦id
)

234 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

236 
	`Œaû_£q_´štf
(
p
, 
LRH_PRN
, 
Ën
, 
sc
, 
dlid
, 
¦id
);

238 ià(
by·ss
)

239 
	`Œaû_£q_´štf
(
p
, 
LRH_16B_PRN
,

240 
age
, 
beú
, 
ãú
, 
l4
, 
rc
, 
sc
, 
pkey
, 
’ŒÝy
);

243 
	`Œaû_£q_´štf
(
p
, 
LRH_9B_PRN
,

244 
Êh
, 
Êh_Çme
, 
lv”
, 
¦
);

245 
	`Œaû_£q_putc
(
p
, 0);

247  
»t
;

248 
	}
}

250 
	#BTH_9B_PRN
 \

252 "f:%d b:%d q²:0x%.6x‡:%d…¢:0x%.8x"

	)

253 
	#BTH_16B_PRN
 \

255 "q²:0x%.6x‡:%d…¢:0x%.8x"

	)

256 
	#L4_FM_16B_PRN
 \

257 "Ý:0x%.2x,% de¡_q²:0x%.6x src_q²:0x%.6x"

	)

258 cÚ¡ *
	$hfi1_Œaû_fmt_»¡
(
Œaû_£q
 *
p
, 
boÞ
 
by·ss
, 
u8
 
l4
,

259 
u8
 
ack
, 
boÞ
 
beú
, boÞ 
ãú
, u8 
mig
,

260 
u8
 
£
, u8 
·d
, u8 
Ýcode
, cÚ¡ *
ÝÇme
,

261 
u8
 
tv”
, 
u16
 
pkey
, 
u32
 
p¢
, u32 
q²
,

262 
u32
 
de¡_q²
, u32 
¤c_q²
)

264 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

266 ià(
by·ss
)

267 ià(
l4
 =ð
OPA_16B_L4_FM
)

268 
	`Œaû_£q_´štf
(
p
, 
L4_FM_16B_PRN
,

269 
Ýcode
, 
ÝÇme
, 
de¡_q²
, 
¤c_q²
);

271 
	`Œaû_£q_´štf
(
p
, 
BTH_16B_PRN
,

272 
Ýcode
, 
ÝÇme
,

273 
£
, 
mig
, 
·d
, 
tv”
, 
q²
, 
ack
, 
p¢
);

276 
	`Œaû_£q_´štf
(
p
, 
BTH_9B_PRN
,

277 
Ýcode
, 
ÝÇme
,

278 
£
, 
mig
, 
·d
, 
tv”
, 
pkey
, 
ãú
, 
beú
,

279 
q²
, 
ack
, 
p¢
);

280 
	`Œaû_£q_putc
(
p
, 0);

282  
»t
;

283 
	}
}

285 cÚ¡ *
	$·r£_ev”bs_hdrs
(

286 
Œaû_£q
 *
p
,

287 
u8
 
Ýcode
, u8 
l4
, 
u32
 
de¡_q²
, u32 
¤c_q²
,

288 *
ehdrs
)

290 
ib_ehdrs
 *
eh
 = 
ehdrs
;

291 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

293 ià(
l4
 =ð
OPA_16B_L4_FM
) {

294 
	`Œaû_£q_´štf
(
p
, "mgmt…kt");

295 
out
;

298 
Ýcode
) {

300 
	`OP
(
RC
, 
SEND_LAST_WITH_IMMEDIATE
):

301 
	`OP
(
UC
, 
SEND_LAST_WITH_IMMEDIATE
):

302 
	`OP
(
RC
, 
SEND_ONLY_WITH_IMMEDIATE
):

303 
	`OP
(
UC
, 
SEND_ONLY_WITH_IMMEDIATE
):

304 
	`OP
(
RC
, 
RDMA_WRITE_LAST_WITH_IMMEDIATE
):

305 
	`OP
(
UC
, 
RDMA_WRITE_LAST_WITH_IMMEDIATE
):

306 
	`Œaû_£q_´štf
(
p
, 
IMM_PRN
,

307 
	`be32_to_ýu
(
eh
->
imm_d©a
));

310 
	`OP
(
RC
, 
RDMA_WRITE_ONLY_WITH_IMMEDIATE
):

311 
	`OP
(
UC
, 
RDMA_WRITE_ONLY_WITH_IMMEDIATE
):

312 
	`Œaû_£q_´štf
(
p
, 
RETH_PRN
 " " 
IMM_PRN
,

313 
	`g‘_ib_»th_vaddr
(&
eh
->
rc
.
»th
),

314 
	`be32_to_ýu
(
eh
->
rc
.
»th
.
rkey
),

315 
	`be32_to_ýu
(
eh
->
rc
.
»th
.
Ëngth
),

316 
	`be32_to_ýu
(
eh
->
rc
.
imm_d©a
));

319 
	`OP
(
RC
, 
RDMA_READ_REQUEST
):

320 
	`OP
(
RC
, 
RDMA_WRITE_FIRST
):

321 
	`OP
(
UC
, 
RDMA_WRITE_FIRST
):

322 
	`OP
(
RC
, 
RDMA_WRITE_ONLY
):

323 
	`OP
(
UC
, 
RDMA_WRITE_ONLY
):

324 
	`Œaû_£q_´štf
(
p
, 
RETH_PRN
,

325 
	`g‘_ib_»th_vaddr
(&
eh
->
rc
.
»th
),

326 
	`be32_to_ýu
(
eh
->
rc
.
»th
.
rkey
),

327 
	`be32_to_ýu
(
eh
->
rc
.
»th
.
Ëngth
));

329 
	`OP
(
RC
, 
RDMA_READ_RESPONSE_FIRST
):

330 
	`OP
(
RC
, 
RDMA_READ_RESPONSE_LAST
):

331 
	`OP
(
RC
, 
RDMA_READ_RESPONSE_ONLY
):

332 
	`OP
(
RC
, 
ACKNOWLEDGE
):

333 
	`Œaû_£q_´štf
(
p
, 
AETH_PRN
, 
	`be32_to_ýu
(
eh
->
«th
) >> 24,

334 
	`·r£_syndrome
(
	`be32_to_ýu
(
eh
->
«th
) >> 24),

335 
	`be32_to_ýu
(
eh
->
«th
è& 
IB_MSN_MASK
);

337 
	`OP
(
TID_RDMA
, 
WRITE_REQ
):

338 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH
 " " 
RETH_PRN
 " "

339 
TID_WRITE_REQ_PRN
,

340 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_»q
.
kd‘h0
),

341 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_»q
.
kd‘h1
),

342 
	`ib_u64_g‘
(&
eh
->
tid_rdma
.
w_»q
.
»th
.
vaddr
),

343 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_»q
.
»th
.
rkey
),

344 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_»q
.
»th
.
Ëngth
),

345 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_»q
.
v”bs_qp
));

347 
	`OP
(
TID_RDMA
, 
WRITE_RESP
):

348 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH
 " " 
AETH_PRN
 " "

349 
TID_WRITE_RSP_PRN
,

350 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
kd‘h0
),

351 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
kd‘h1
),

352 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
«th
) >> 24,

353 
	`·r£_syndrome
(

354 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
«th
)

356 (
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
«th
) &

357 
IB_MSN_MASK
),

358 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
tid_æow_p¢
),

359 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
tid_æow_qp
),

360 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_r¥
.
v”bs_qp
));

362 
	`OP
(
TID_RDMA
, 
WRITE_DATA_LAST
):

363 
	`OP
(
TID_RDMA
, 
WRITE_DATA
):

364 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH_DATA
 " " 
TID_WRITE_DATA_PRN
,

365 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
),

366 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
KVER
),

367 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
SH
),

368 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
INTR
),

369 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
TIDCTRL
),

370 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
TID
),

371 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h0
, 
OFFSET
),

372 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h1
),

373 
	`KDETH_GET
(
eh
->
tid_rdma
.
w_d©a
.
kd‘h1
, 
JKEY
),

374 
	`be32_to_ýu
(
eh
->
tid_rdma
.
w_d©a
.
v”bs_qp
));

376 
	`OP
(
TID_RDMA
, 
READ_REQ
):

377 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH
 " " 
RETH_PRN
 " "

378 
TID_READ_REQ_PRN
,

379 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
kd‘h0
),

380 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
kd‘h1
),

381 
	`ib_u64_g‘
(&
eh
->
tid_rdma
.
r_»q
.
»th
.
vaddr
),

382 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
»th
.
rkey
),

383 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
»th
.
Ëngth
),

384 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
tid_æow_p¢
),

385 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
tid_æow_qp
),

386 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_»q
.
v”bs_qp
));

388 
	`OP
(
TID_RDMA
, 
READ_RESP
):

389 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH_DATA
 " " 
AETH_PRN
 " "

390 
TID_READ_RSP_PRN
,

391 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
),

392 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
KVER
),

393 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
SH
),

394 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
INTR
),

395 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
TIDCTRL
),

396 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
TID
),

397 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h0
, 
OFFSET
),

398 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h1
),

399 
	`KDETH_GET
(
eh
->
tid_rdma
.
r_r¥
.
kd‘h1
, 
JKEY
),

400 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
«th
) >> 24,

401 
	`·r£_syndrome
(

402 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
«th
)

404 (
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
«th
) &

405 
IB_MSN_MASK
),

406 
	`be32_to_ýu
(
eh
->
tid_rdma
.
r_r¥
.
v”bs_qp
));

408 
	`OP
(
TID_RDMA
, 
ACK
):

409 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH
 " " 
AETH_PRN
 " "

410 
TID_ACK_PRN
,

411 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
ack
.
kd‘h0
),

412 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
ack
.
kd‘h1
),

413 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
«th
) >> 24,

414 
	`·r£_syndrome
(

415 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
«th
)

417 (
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
«th
) &

418 
IB_MSN_MASK
),

419 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
tid_æow_p¢
),

420 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
v”bs_p¢
),

421 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
tid_æow_qp
),

422 
	`be32_to_ýu
(
eh
->
tid_rdma
.
ack
.
v”bs_qp
));

424 
	`OP
(
TID_RDMA
, 
RESYNC
):

425 
	`Œaû_£q_´štf
(
p
, 
TID_RDMA_KDETH
 " " 
TID_RESYNC_PRN
,

426 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
»sync
.
kd‘h0
),

427 
	`Ë32_to_ýu
(
eh
->
tid_rdma
.
»sync
.
kd‘h1
),

428 
	`be32_to_ýu
(
eh
->
tid_rdma
.
»sync
.
v”bs_qp
));

431 
	`OP
(
RC
, 
ATOMIC_ACKNOWLEDGE
):

432 
	`Œaû_£q_´štf
(
p
, 
AETH_PRN
 " " 
ATOMICACKETH_PRN
,

433 
	`be32_to_ýu
(
eh
->
©
.
«th
) >> 24,

434 
	`·r£_syndrome
(
	`be32_to_ýu
(
eh
->
©
.
«th
) >> 24),

435 
	`be32_to_ýu
(
eh
->
©
.
«th
è& 
IB_MSN_MASK
,

436 
	`ib_u64_g‘
(&
eh
->
©
.
©omic_ack_‘h
));

439 
	`OP
(
RC
, 
COMPARE_SWAP
):

440 
	`OP
(
RC
, 
FETCH_ADD
):

441 
	`Œaû_£q_´štf
(
p
, 
ATOMICETH_PRN
,

442 
	`g‘_ib_©‘h_vaddr
(&
eh
->
©omic_‘h
),

443 
eh
->
©omic_‘h
.
rkey
,

444 
	`g‘_ib_©‘h_sw­
(&
eh
->
©omic_‘h
),

445 
	`g‘_ib_©‘h_com·»
(&
eh
->
©omic_‘h
));

448 
	`OP
(
UD
, 
SEND_ONLY
):

449 
	`Œaû_£q_´štf
(
p
, 
DETH_ENTROPY_PRN
,

450 
	`be32_to_ýu
(
eh
->
ud
.
d‘h
[0]),

451 
	`be32_to_ýu
(
eh
->
ud
.
d‘h
[1]è& 
RVT_QPN_MASK
,

452 
	`be32_to_ýu
(
eh
->
ud
.
d‘h
[1]) >>

453 
RVT_AIP_ENTROPY_SHIFT
);

455 
	`OP
(
UD
, 
SEND_ONLY_WITH_IMMEDIATE
):

456 
	`Œaû_£q_´štf
(
p
, 
DETH_PRN
,

457 
	`be32_to_ýu
(
eh
->
ud
.
d‘h
[0]),

458 
	`be32_to_ýu
(
eh
->
ud
.
d‘h
[1]è& 
RVT_QPN_MASK
);

461 
	`OP
(
RC
, 
SEND_LAST_WITH_INVALIDATE
):

462 
	`OP
(
RC
, 
SEND_ONLY_WITH_INVALIDATE
):

463 
	`Œaû_£q_´štf
(
p
, 
IETH_PRN
,

464 
	`be32_to_ýu
(
eh
->
›th
));

467 
out
:

468 
	`Œaû_£q_putc
(
p
, 0);

469  
»t
;

470 
	}
}

472 cÚ¡ *
	$·r£_sdma_æags
(

473 
Œaû_£q
 *
p
,

474 
u64
 
desc0
, u64 
desc1
)

476 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

477 
æags
[5] = { 'x', 'x', 'x', 'x', 0 };

479 
æags
[0] = (
desc1
 & 
SDMA_DESC1_INT_REQ_FLAG
) ? 'I' : '-';

480 
æags
[1] = (
desc1
 & 
SDMA_DESC1_HEAD_TO_HOST_FLAG
) ? 'H' : '-';

481 
æags
[2] = (
desc0
 & 
SDMA_DESC0_FIRST_DESC_FLAG
) ? 'F' : '-';

482 
æags
[3] = (
desc0
 & 
SDMA_DESC0_LAST_DESC_FLAG
) ? 'L' : '-';

483 
	`Œaû_£q_´štf
(
p
, "%s", 
æags
);

484 ià(
desc0
 & 
SDMA_DESC0_FIRST_DESC_FLAG
)

485 
	`Œaû_£q_´štf
(
p
, "‡mode:%u‡idx:%u‡len:%u",

486 (
u8
)((
desc1
 >> 
SDMA_DESC1_HEADER_MODE_SHIFT
) &

487 
SDMA_DESC1_HEADER_MODE_MASK
),

488 (
u8
)((
desc1
 >> 
SDMA_DESC1_HEADER_INDEX_SHIFT
) &

489 
SDMA_DESC1_HEADER_INDEX_MASK
),

490 (
u8
)((
desc1
 >> 
SDMA_DESC1_HEADER_DWS_SHIFT
) &

491 
SDMA_DESC1_HEADER_DWS_MASK
));

492  
»t
;

493 
	}
}

495 cÚ¡ *
	$´št_u32_¬¿y
(

496 
Œaû_£q
 *
p
,

497 
u32
 *
¬r
, 
Ën
)

499 
i
;

500 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

502 
i
 = 0; i < 
Ën
 ; i++)

503 
	`Œaû_£q_´štf
(
p
, "%s%#x", 
i
 =ð0 ? "" : " ", 
¬r
[i]);

504 
	`Œaû_£q_putc
(
p
, 0);

505  
»t
;

506 
	}
}

508 
u8
 
	$hfi1_Œaû_g‘_tid_ù¾
(
u32
 
’t
)

510  
	`EXP_TID_GET
(
’t
, 
CTRL
);

511 
	}
}

513 
u16
 
	$hfi1_Œaû_g‘_tid_Ën
(
u32
 
’t
)

515  
	`EXP_TID_GET
(
’t
, 
LEN
);

516 
	}
}

518 
u16
 
	$hfi1_Œaû_g‘_tid_idx
(
u32
 
’t
)

520  
	`EXP_TID_GET
(
’t
, 
IDX
);

521 
	}
}

523 
	shfi1_ùxt_hi¡
 {

524 
©omic_t
 
	mcouÁ
;

525 
©omic_t
 
	md©a
[255];

528 
hfi1_ùxt_hi¡
 
	ghi¡
 = {

529 .
couÁ
 = 
ATOMIC_INIT
(0)

532 #ifdeà
AIP


533 cÚ¡ *
	$hfi1_Œaû_´št_rsm_hi¡
(
Œaû_£q
 *
p
, 
ùxt
)

535 
i
, 
Ën
 = 
	`ARRAY_SIZE
(
hi¡
.
d©a
);

536 cÚ¡ *
»t
 = 
	`Œaû_£q_bufãr_±r
(
p
);

537 #ifdeà
©omic_ãtch_šc


538 
·ck‘_couÁ
 = 
	`©omic_ãtch_šc
(&
hi¡
.
couÁ
);

540 
·ck‘_couÁ
 = 
	`©omic_šc_»tuº
(&
hi¡
.
couÁ
) - 1;

542 
	`Œaû_£q_´štf
(
p
, "·ck‘[%lu]", 
·ck‘_couÁ
);

543 
i
 = 0; i < 
Ën
; ++i) {

544 
v®
;

545 
©omic_t
 *
couÁ
 = &
hi¡
.
d©a
[
i
];

547 ià(
ùxt
 =ð
i
)

548 #ifdeà
©omic_ãtch_šc


549 
v®
 = 
	`©omic_ãtch_šc
(
couÁ
);

551 
v®
 = 
	`©omic_šc_»tuº
(
couÁ
) - 1;

554 
v®
 = 
	`©omic_»ad
(
couÁ
);

556 ià(
v®
)

557 
	`Œaû_£q_´štf
(
p
, "(%d:%lu)", 
i
, 
v®
);

559 
	`Œaû_£q_putc
(
p
, 0);

560  
»t
;

561 
	}
}

564 
__hfi1_Œaû_â
(
AFFINITY
);

565 
__hfi1_Œaû_â
(
PKT
);

566 
__hfi1_Œaû_â
(
PROC
);

567 
__hfi1_Œaû_â
(
SDMA
);

568 
__hfi1_Œaû_â
(
LINKVERB
);

569 
__hfi1_Œaû_â
(
DEBUG
);

570 
__hfi1_Œaû_â
(
SNOOP
);

571 
__hfi1_Œaû_â
(
CNTR
);

572 
__hfi1_Œaû_â
(
PIO
);

573 
__hfi1_Œaû_â
(
DC8051
);

574 
__hfi1_Œaû_â
(
FIRMWARE
);

575 
__hfi1_Œaû_â
(
RCVCTRL
);

576 
__hfi1_Œaû_â
(
TID
);

577 
__hfi1_Œaû_â
(
MMU
);

578 
__hfi1_Œaû_â
(
IOCTL
);

579 
__hfi1_Œaû_â
(
OPFN
);

580 
__hfi1_Œaû_â
(
TIDRDMA
);

581 
__hfi1_Œaû_â
(
SEL
);

	@trace.h

48 
	#·ck‘ty³_Çme
(
‘y³
è{ 
RHF_RCV_TYPE_
##‘y³, #‘y³ }

	)

49 
	#show_·ck‘ty³
(
‘y³
) \

50 
	`__´št_symbÞic
(
‘y³
, \

51 
	`·ck‘ty³_Çme
(
EXPECTED
), \

52 
	`·ck‘ty³_Çme
(
EAGER
), \

53 
	`·ck‘ty³_Çme
(
IB
), \

54 
	`·ck‘ty³_Çme
(
ERROR
), \

55 
	`·ck‘ty³_Çme
(
BYPASS
))

	)

57 
	~"Œaû_dbg.h
"

58 
	~"Œaû_misc.h
"

59 
	~"Œaû_ùxts.h
"

60 
	~"Œaû_ibhdrs.h
"

61 
	~"Œaû_rc.h
"

62 
	~"Œaû_rx.h
"

63 
	~"Œaû_tx.h
"

64 
	~"Œaû_mmu.h
"

65 #ifdeà
NVIDIA_GPU_DIRECT


66 
	~"Œaû_gpu.h
"

68 
	~"Œaû_iowa™.h
"

69 
	~"Œaû_tid.h
"

	@trace_ctxts.h

47 #ià!
defšed
(
__HFI1_TRACE_CTXTS_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_CTXTS_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_ùxts


	)

58 
	#UCTXT_FMT
 \

60 "rcvba£:0x%Îx,„cvegrc:%u,„cvegrb:0x%Îx, subùxt_út:%u"

	)

61 
TRACE_EVENT
(
hfi1_uùxtd©a
,

62 
TP_PROTO
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
uùxt
,

63 
subùxt
),

64 
TP_ARGS
(
dd
, 
uùxt
, 
subùxt
),

65 
TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

66 
	$__f›ld
(, 
ùxt
)

67 
	$__f›ld
(, 
subùxt
)

68 
	$__f›ld
(
u32
, 
üed™s
)

69 
	$__f›ld
(
u64
, 
hw_ä“
)

70 
	$__f›ld
(
__iomem
 *, 
pioba£
)

71 
	$__f›ld
(
u16
, 
rcvhdrq_út
)

72 
	$__f›ld
(
u64
, 
rcvhdrq_dma
)

73 
	$__f›ld
(
u32
, 
—g”_út
)

74 
	$__f›ld
(
u64
, 
rcvegr_dma
)

75 
	`__f›ld
(, 
subùxt_út
)

77 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

78 
__’Œy
->
ùxt
 = 
uùxt
->ctxt;

79 
__’Œy
->
subùxt
 = subctxt;

80 
__’Œy
->
üed™s
 = 
uùxt
->
sc
->credits;

81 
__’Œy
->
hw_ä“
 = 
	`Ë64_to_ýu
(*
uùxt
->
sc
->hw_free);

82 
__’Œy
->
pioba£
 = 
uùxt
->
sc
->
ba£_addr
;

83 
__’Œy
->
rcvhdrq_út
 = 
	`g‘_hdrq_út
(
uùxt
);

84 
__’Œy
->
rcvhdrq_dma
 = 
uùxt
->rcvhdrq_dma;

85 
__’Œy
->
—g”_út
 = 
uùxt
->
egrbufs
.
®loûd
;

86 
__’Œy
->
rcvegr_dma
 = 
uùxt
->
egrbufs
.
rcvtids
[0].
dma
;

87 
__’Œy
->
subùxt_út
 = 
uùxt
->subctxt_cnt;

89 
	`TP_´štk
("[%s] ctxˆ%u:%u " 
UCTXT_FMT
,

90 
	`__g‘_¡r
(
dev
),

91 
__’Œy
->
ùxt
,

92 
__’Œy
->
subùxt
,

93 
__’Œy
->
üed™s
,

94 
__’Œy
->
hw_ä“
,

95 
__’Œy
->
pioba£
,

96 
__’Œy
->
rcvhdrq_út
,

97 
__’Œy
->
rcvhdrq_dma
,

98 
__’Œy
->
—g”_út
,

99 
__’Œy
->
rcvegr_dma
,

100 
__’Œy
->
subùxt_út


104 
	#CINFO_FMT
 \

105 "eg¹ids:%u,ƒgr_size:%u, hdrq_út:%u, hdrq_size:%u, sdma_ršg_size:%u"

	)

106 
	`TRACE_EVENT
(
hfi1_ùxt_šfo
,

107 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
ùxt
,

108 
subùxt
,

109 
hfi1_ùxt_šfo
 *
cšfo
),

110 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
cšfo
),

111 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

112 
	$__f›ld
(, 
ùxt
)

113 
	$__f›ld
(, 
subùxt
)

114 
	$__f›ld
(
u16
, 
eg¹ids
)

115 
	$__f›ld
(
u16
, 
rcvhdrq_út
)

116 
	$__f›ld
(
u16
, 
rcvhdrq_size
)

117 
	$__f›ld
(
u16
, 
sdma_ršg_size
)

118 
	`__f›ld
(
u32
, 
rcvegr_size
)

120 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

121 
__’Œy
->
ùxt
 = ctxt;

122 
__’Œy
->
subùxt
 = subctxt;

123 
__’Œy
->
eg¹ids
 = 
cšfo
->egrtids;

124 
__’Œy
->
rcvhdrq_út
 = 
cšfo
->rcvhdrq_cnt;

125 
__’Œy
->
rcvhdrq_size
 = 
cšfo
->
rcvhdrq_’tsize
;

126 
__’Œy
->
sdma_ršg_size
 = 
cšfo
->sdma_ring_size;

127 
__’Œy
->
rcvegr_size
 = 
cšfo
->rcvegr_size;

129 
	`TP_´štk
("[%s] ctxˆ%u:%u " 
CINFO_FMT
,

130 
	`__g‘_¡r
(
dev
),

131 
__’Œy
->
ùxt
,

132 
__’Œy
->
subùxt
,

133 
__’Œy
->
eg¹ids
,

134 
__’Œy
->
rcvegr_size
,

135 
__’Œy
->
rcvhdrq_út
,

136 
__’Œy
->
rcvhdrq_size
,

137 
__’Œy
->
sdma_ršg_size


141 #ifdeà
AIP


142 cÚ¡ *
	`hfi1_Œaû_´št_rsm_hi¡
(
Œaû_£q
 *
p
, 
ùxt
);

143 
	`TRACE_EVENT
(
ùxt_rsm_hi¡
,

144 
	`TP_PROTO
(
ùxt
),

145 
	`TP_ARGS
(
ùxt
),

146 
	`TP_STRUCT__’Œy
(
	`__f›ld
(, 
ùxt
)),

147 
	`TP_ç¡_assign
(
__’Œy
->
ùxt
 = ctxt;),

148 
	`TP_´štk
("%s", 
	`hfi1_Œaû_´št_rsm_hi¡
(
p
, 
__’Œy
->
ùxt
))

154 #undeà
TRACE_INCLUDE_PATH


155 #undeà
TRACE_INCLUDE_FILE


156 
	#TRACE_INCLUDE_PATH
 .

	)

157 
	#TRACE_INCLUDE_FILE
 
Œaû_ùxts


	)

158 
	~<Œaû/defše_Œaû.h
>

	@trace_dbg.h

47 #ià!
defšed
(
__HFI1_TRACE_EXTRA_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_EXTRA_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

61 #undeà
TRACE_SYSTEM


62 
	#TRACE_SYSTEM
 
hfi1_dbg


	)

64 
	#MAX_MSG_LEN
 512

	)

66 
DECLARE_EVENT_CLASS
(
hfi1_Œaû_‹m¶©e
,

67 
TP_PROTO
(cÚ¡ *
funùiÚ
, 
va_fÜm©
 *
vaf
),

68 
TP_ARGS
(
funùiÚ
, 
vaf
),

69 
TP_STRUCT__’Œy
(
	$__¡ršg
(
funùiÚ
, function)

70 
	`__dyÇmic_¬¿y
(, 
msg
, 
MAX_MSG_LEN
)

72 
	`TP_ç¡_assign
(
	`__assign_¡r
(
funùiÚ
, function);

73 
	`WARN_ON_ONCE
(
v¢´štf


74 (
	`__g‘_dyÇmic_¬¿y
(
msg
),

75 
MAX_MSG_LEN
, 
vaf
->
fmt
,

76 *
vaf
->
va
) >=

77 
MAX_MSG_LEN
);

79 
	`TP_´štk
("(%s) %s",

80 
	`__g‘_¡r
(
funùiÚ
),

81 
	`__g‘_¡r
(
msg
))

88 
	#__hfi1_Œaû_def
(
lvl
) \

89 
	`__´štf
(2, 3è
__hfi1_Œaû_
##
	`lvl
(cÚ¡ *
funù
, *
fmt
, ...); \

91 
	`DEFINE_EVENT
(
hfi1_Œaû_‹m¶©e
, 
hfi1_
 ##
lvl
, \

92 
	`TP_PROTO
(cÚ¡ *
funùiÚ
, 
va_fÜm©
 *
vaf
), \

93 
	`TP_ARGS
(
funùiÚ
, 
vaf
))

	)

95 
	#__hfi1_Œaû_â
(
lvl
) \

96 
	`__´štf
(2, 3è
__hfi1_Œaû_
##
	`lvl
(cÚ¡ *
func
, *
fmt
, ...)\

98 
va_fÜm©
 
vaf
 = { \

99 .
fmt
 = fmt, \

101 
va_li¡
 
¬gs
; \

103 
	`va_¡¬t
(
¬gs
, 
fmt
); \

104 
vaf
.
va
 = &
¬gs
; \

105 
Œaû_hfi1_
 ##
	`lvl
(
func
, &
vaf
); \

106 
	`va_’d
(
¬gs
); \

108 
	}

	)
}

116 
__hfi1_Œaû_def
(
AFFINITY
);

117 
__hfi1_Œaû_def
(
PKT
);

118 
__hfi1_Œaû_def
(
PROC
);

119 
__hfi1_Œaû_def
(
SDMA
);

120 
__hfi1_Œaû_def
(
LINKVERB
);

121 
__hfi1_Œaû_def
(
DEBUG
);

122 
__hfi1_Œaû_def
(
SNOOP
);

123 
__hfi1_Œaû_def
(
CNTR
);

124 
__hfi1_Œaû_def
(
PIO
);

125 
__hfi1_Œaû_def
(
DC8051
);

126 
__hfi1_Œaû_def
(
FIRMWARE
);

127 
__hfi1_Œaû_def
(
RCVCTRL
);

128 
__hfi1_Œaû_def
(
TID
);

129 
__hfi1_Œaû_def
(
MMU
);

130 
__hfi1_Œaû_def
(
IOCTL
);

131 
__hfi1_Œaû_def
(
OPFN
);

132 
__hfi1_Œaû_def
(
TIDRDMA
);

133 
__hfi1_Œaû_def
(
SEL
);

135 
	#hfi1_cdbg
(
which
, 
fmt
, ...) \

136 
__hfi1_Œaû_
##
	`which
(
__func__
, 
fmt
, ##
__VA_ARGS__
)

	)

138 
	#hfi1_dbg
(
fmt
, ...) \

139 
	`hfi1_cdbg
(
DEBUG
, 
fmt
, ##
__VA_ARGS__
)

	)

146 #ifdeà
HFI1_EARLY_DBG


147 
	#hfi1_dbg_—¾y
(
fmt
, ...) \

148 
	`Œaû_´štk
(
fmt
, ##
__VA_ARGS__
)

	)

150 
	#hfi1_dbg_—¾y
(
fmt
, ...)

	)

155 #undeà
TRACE_INCLUDE_PATH


156 #undeà
TRACE_INCLUDE_FILE


157 
	#TRACE_INCLUDE_PATH
 .

	)

158 
	#TRACE_INCLUDE_FILE
 
Œaû_dbg


	)

159 
	~<Œaû/defše_Œaû.h
>

	@trace_gpu.h

47 #ià!
defšed
(
__HFI1_TRACE_GPU_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_GPU_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 #undeà
TRACE_SYSTEM


54 
	#TRACE_SYSTEM
 
hfi1_gpu


	)

56 
DECLARE_EVENT_CLASS
(
pš_gpu_·ges
,

57 
TP_PROTO
(
ba£
, 
addr
,

58 
Ën
, 
size
,

59 
Åages
),

60 
TP_ARGS
(
ba£
, 
addr
, 
Ën
, 
size
, 
Åages
),

61 
TP_STRUCT__’Œy
(
	$__f›ld
(, 
ba£
)

62 
	$__f›ld
(, 
addr
)

63 
	$__f›ld
(, 
Ën
)

64 
	$__f›ld
(, 
size
)

65 
	`__f›ld
(, 
Åages
)

67 
	`TP_ç¡_assign
(
__’Œy
->
ba£
 = base;

68 
__’Œy
->
addr
 =‡ddr;

69 
__’Œy
->
Ën
 =†en;

70 
__’Œy
->
size
 = size;

71 
__’Œy
->
Åages
 =‚pages;

73 
	`TP_´štk
("NV: base: 0x%lx,‡ddr: 0x%lx,†en: %lu,…in size: %lu,‚um…ages: %u",

74 
__’Œy
->
ba£
,

75 
__’Œy
->
addr
,

76 
__’Œy
->
Ën
,

77 
__’Œy
->
size
,

78 
__’Œy
->
Åages


82 
	`DECLARE_EVENT_CLASS
(
ä“_gpu_·ges
,

83 
	`TP_PROTO
(
addr
),

84 
	`TP_ARGS
(
addr
),

85 
	`TP_STRUCT__’Œy
(
	`__f›ld
(, 
addr
)

87 
	`TP_ç¡_assign
(
__’Œy
->
addr
 =‡ddr;

89 
	`TP_´štk
("NV: Unpinninghe buffer‡t‡ddress: 0x%lx",

90 
__’Œy
->
addr


94 
	`DECLARE_EVENT_CLASS
(
šv®id©e_gpu_·ges
,

95 
	`TP_PROTO
(
addr
, 
size
),

96 
	`TP_ARGS
(
addr
, 
size
),

97 
	`TP_STRUCT__’Œy
(
	$__f›ld
(, 
addr
)

98 
	`__f›ld
(, 
size
)

100 
	`TP_ç¡_assign
(
__’Œy
->
addr
 =‡ddr;

101 
__’Œy
->
size
 = size;

103 
	`TP_´štk
("NV: Invalidating‡ddress„ange: start 0x%lx,†en %lu",

104 
__’Œy
->
addr
,

105 
__’Œy
->
size


109 
	`DECLARE_EVENT_CLASS
(
gpu_·ge_bË_šfo
,

110 
	`TP_PROTO
(
’Œ›s
, 
·ge_size
),

111 
	`TP_ARGS
(
’Œ›s
, 
·ge_size
),

112 
	`TP_STRUCT__’Œy
(
	$__f›ld
(, 
’Œ›s
)

113 
	`__f›ld
(, 
·ge_size
)

115 
	`TP_ç¡_assign
(
__’Œy
->
’Œ›s
 =ƒntries;

116 
__’Œy
->
·ge_size
 =…age_size;

118 
	`TP_´štk
("NV:‚vidia_p2p_get_pages:‚umƒntries: %u,…age size: %u",

119 
__’Œy
->
’Œ›s
,

120 
__’Œy
->
·ge_size


124 
	`DECLARE_EVENT_CLASS
(
pš_gpu_·ges_çž
,

125 
	`TP_PROTO
(
»t
, 
addr
, 
size
),

126 
	`TP_ARGS
(
»t
, 
addr
, 
size
),

127 
	`TP_STRUCT__’Œy
(
	$__f›ld
(, 
»t
)

128 
	$__f›ld
(, 
addr
)

129 
	`__f›ld
(, 
size
)

131 
	`TP_ç¡_assign
(
__’Œy
->
»t
 =„et;

132 
__’Œy
->
addr
 =‡ddr;

133 
__’Œy
->
size
 = size;

135 
	`TP_´štk
("NV: Failedo…in GPU mem…ages.„et %d,‡ddr 0x%lx, size %lu",

136 
__’Œy
->
»t
,

137 
__’Œy
->
addr
,

138 
__’Œy
->
size


142 
	`TRACE_EVENT
(
gpu_·ge_size_check
,

143 
	`TP_PROTO
(
size_ty³
),

144 
	`TP_ARGS
(
size_ty³
),

145 
	`TP_STRUCT__’Œy
(
	`__f›ld
(, 
size_ty³
)),

146 
	`TP_ç¡_assign
(
__’Œy
->
size_ty³
 = size_type;),

147 
	`TP_´štk
("NV: GPU memory…age size is‚ot 64KB. Sizeype: %u",

148 
__’Œy
->
size_ty³
)

151 
	`TRACE_EVENT
(
gpu_·ge_tbl_check
,

152 
	`TP_PROTO
(
comp
, 
š¡
),

153 
	`TP_ARGS
(
comp
, 
š¡
),

154 
	`TP_STRUCT__’Œy
(
	$__f›ld
(, 
comp
)

155 
	`__f›ld
(, 
š¡
)

157 
	`TP_ç¡_assign
(
__’Œy
->
comp
 = comp;

158 
__’Œy
->
š¡
 = inst;

160 
	`TP_´štk
("NV:…ageable version incompatible. Compiled: 0x%x, Installed: 0x%x",

161 
__’Œy
->
comp
,

162 
__’Œy
->
š¡
)

165 
	`DEFINE_EVENT
(
pš_gpu_·ges
, 
pš_rcv_·ges_gpu
,

166 
	`TP_PROTO
(
ba£
, 
addr
,

167 
Ën
, 
size
, 
Åages
),

168 
	`TP_ARGS
(
ba£
, 
addr
, 
Ën
, 
size
, 
Åages
));

170 
	`DEFINE_EVENT
(
pš_gpu_·ges
, 
pš_sdma_·ges_gpu
,

171 
	`TP_PROTO
(
ba£
, 
addr
,

172 
Ën
, 
size
, 
Åages
),

173 
	`TP_ARGS
(
ba£
, 
addr
, 
Ën
, 
size
, 
Åages
));

175 
	`DEFINE_EVENT
(
šv®id©e_gpu_·ges
, 
uÅš_rcv_gpu_·ges_ÿÎback
,

176 
	`TP_PROTO
(
addr
, 
Ën
),

177 
	`TP_ARGS
(
addr
, 
Ën
));

179 
	`DEFINE_EVENT
(
šv®id©e_gpu_·ges
, 
uÅš_gpu_·ges_ÿÎback
,

180 
	`TP_PROTO
(
addr
, 
Ën
),

181 
	`TP_ARGS
(
addr
, 
Ën
));

183 
	`DEFINE_EVENT
(
gpu_·ge_bË_šfo
, 
»cv_gpu_·ge_bË_šfo
,

184 
	`TP_PROTO
(
’Œ›s
, 
·ge_size
),

185 
	`TP_ARGS
(
’Œ›s
, 
·ge_size
));

187 
	`DEFINE_EVENT
(
gpu_·ge_bË_šfo
, 
sdma_gpu_·ge_bË_šfo
,

188 
	`TP_PROTO
(
’Œ›s
, 
·ge_size
),

189 
	`TP_ARGS
(
’Œ›s
, 
·ge_size
));

191 
	`DEFINE_EVENT
(
pš_gpu_·ges_çž
, 
»cv_pš_gpu_·ges_çž
,

192 
	`TP_PROTO
(
»t
, 
addr
, 
size
),

193 
	`TP_ARGS
(
»t
, 
addr
, 
size
));

195 
	`DEFINE_EVENT
(
pš_gpu_·ges_çž
, 
sdma_pš_gpu_·ges_çž
,

196 
	`TP_PROTO
(
»t
, 
addr
, 
size
),

197 
	`TP_ARGS
(
»t
, 
addr
, 
size
));

199 
	`DEFINE_EVENT
(
ä“_gpu_·ges
, 
ä“_»cv_gpu_·ges
,

200 
	`TP_PROTO
(
addr
),

201 
	`TP_ARGS
(
addr
));

203 
	`DEFINE_EVENT
(
ä“_gpu_·ges
, 
ä“_sdma_gpu_·ges
,

204 
	`TP_PROTO
(
addr
),

205 
	`TP_ARGS
(
addr
));

209 #undeà
TRACE_INCLUDE_PATH


210 #undeà
TRACE_INCLUDE_FILE


211 
	#TRACE_INCLUDE_PATH
 .

	)

212 
	#TRACE_INCLUDE_FILE
 
Œaû_gpu


	)

213 
	~<Œaû/defše_Œaû.h
>

	@trace_ibhdrs.h

47 #ià!
defšed
(
__HFI1_TRACE_IBHDRS_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_IBHDRS_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_ibhdrs


	)

58 
	#ib_Ýcode_Çme
(
Ýcode
è{ 
IB_OPCODE_
##Ýcode, #Ýcod}

	)

59 
	#show_ib_Ýcode
(
Ýcode
) \

60 
	`__´št_symbÞic
(
Ýcode
, \

61 
	`ib_Ýcode_Çme
(
RC_SEND_FIRST
), \

62 
	`ib_Ýcode_Çme
(
RC_SEND_MIDDLE
), \

63 
	`ib_Ýcode_Çme
(
RC_SEND_LAST
), \

64 
	`ib_Ýcode_Çme
(
RC_SEND_LAST_WITH_IMMEDIATE
), \

65 
	`ib_Ýcode_Çme
(
RC_SEND_ONLY
), \

66 
	`ib_Ýcode_Çme
(
RC_SEND_ONLY_WITH_IMMEDIATE
), \

67 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_FIRST
), \

68 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_MIDDLE
), \

69 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_LAST
), \

70 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_LAST_WITH_IMMEDIATE
), \

71 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_ONLY
), \

72 
	`ib_Ýcode_Çme
(
RC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
), \

73 
	`ib_Ýcode_Çme
(
RC_RDMA_READ_REQUEST
), \

74 
	`ib_Ýcode_Çme
(
RC_RDMA_READ_RESPONSE_FIRST
), \

75 
	`ib_Ýcode_Çme
(
RC_RDMA_READ_RESPONSE_MIDDLE
), \

76 
	`ib_Ýcode_Çme
(
RC_RDMA_READ_RESPONSE_LAST
), \

77 
	`ib_Ýcode_Çme
(
RC_RDMA_READ_RESPONSE_ONLY
), \

78 
	`ib_Ýcode_Çme
(
RC_ACKNOWLEDGE
), \

79 
	`ib_Ýcode_Çme
(
RC_ATOMIC_ACKNOWLEDGE
), \

80 
	`ib_Ýcode_Çme
(
RC_COMPARE_SWAP
), \

81 
	`ib_Ýcode_Çme
(
RC_FETCH_ADD
), \

82 
	`ib_Ýcode_Çme
(
RC_SEND_LAST_WITH_INVALIDATE
), \

83 
	`ib_Ýcode_Çme
(
RC_SEND_ONLY_WITH_INVALIDATE
), \

84 
	`ib_Ýcode_Çme
(
TID_RDMA_WRITE_REQ
), \

85 
	`ib_Ýcode_Çme
(
TID_RDMA_WRITE_RESP
), \

86 
	`ib_Ýcode_Çme
(
TID_RDMA_WRITE_DATA
), \

87 
	`ib_Ýcode_Çme
(
TID_RDMA_WRITE_DATA_LAST
), \

88 
	`ib_Ýcode_Çme
(
TID_RDMA_READ_REQ
), \

89 
	`ib_Ýcode_Çme
(
TID_RDMA_READ_RESP
), \

90 
	`ib_Ýcode_Çme
(
TID_RDMA_RESYNC
), \

91 
	`ib_Ýcode_Çme
(
TID_RDMA_ACK
), \

92 
	`ib_Ýcode_Çme
(
UC_SEND_FIRST
), \

93 
	`ib_Ýcode_Çme
(
UC_SEND_MIDDLE
), \

94 
	`ib_Ýcode_Çme
(
UC_SEND_LAST
), \

95 
	`ib_Ýcode_Çme
(
UC_SEND_LAST_WITH_IMMEDIATE
), \

96 
	`ib_Ýcode_Çme
(
UC_SEND_ONLY
), \

97 
	`ib_Ýcode_Çme
(
UC_SEND_ONLY_WITH_IMMEDIATE
), \

98 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_FIRST
), \

99 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_MIDDLE
), \

100 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_LAST
), \

101 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_LAST_WITH_IMMEDIATE
), \

102 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_ONLY
), \

103 
	`ib_Ýcode_Çme
(
UC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
), \

104 
	`ib_Ýcode_Çme
(
UD_SEND_ONLY
), \

105 
	`ib_Ýcode_Çme
(
UD_SEND_ONLY_WITH_IMMEDIATE
), \

106 
	`ib_Ýcode_Çme
(
CNP
))

	)

108 
u8
 
ibhdr_exhdr_Ën
(
ib_h—d”
 *
hdr
);

109 cÚ¡ *
·r£_ev”bs_hdrs
(
Œaû_£q
 *
p
, 
u8
 
Ýcode
,

110 
u8
 
l4
, 
u32
 
de¡_q²
, u32 
¤c_q²
,

111 *
ehdrs
);

112 
u8
 
hfi1_Œaû_Ýa_hdr_Ën
(
hfi1_Ýa_h—d”
 *
Ýah
);

113 
u8
 
hfi1_Œaû_·ck‘_hdr_Ën
(
hfi1_·ck‘
 *
·ck‘
);

114 cÚ¡ *
hfi1_Œaû_g‘_·ck‘_l4_¡r
(
u8
 
l4
);

115 
hfi1_Œaû_·r£_9b_bth
(
ib_Ùh”_h—d”s
 *
ohdr
,

116 
u8
 *
ack
, 
boÞ
 *
beú
, boÞ *
ãú
, u8 *
mig
,

117 
u8
 *
£
, u8 *
·d
, u8 *
Ýcode
, u8 *
tv”
,

118 
u16
 *
pkey
, 
u32
 *
p¢
, u32 *
q²
);

119 
hfi1_Œaû_·r£_9b_hdr
(
ib_h—d”
 *
hdr
, 
boÞ
 
sc5
,

120 
u8
 *
Êh
, u8 *
lv”
, u8 *
¦
, u8 *
sc
,

121 
u16
 *
Ën
, 
u32
 *
dlid
, u32 *
¦id
);

122 
hfi1_Œaû_·r£_16b_bth
(
ib_Ùh”_h—d”s
 *
ohdr
,

123 
u8
 *
ack
, u8 *
mig
, u8 *
Ýcode
,

124 
u8
 *
·d
, u8 *
£
, u8 *
tv”
,

125 
u32
 *
p¢
, u32 *
q²
);

126 
hfi1_Œaû_·r£_16b_hdr
(
hfi1_16b_h—d”
 *
hdr
,

127 
u8
 *
age
, 
boÞ
 *
beú
, boÞ *
ãú
,

128 
u8
 *
l4
, u8 *
rc
, u8 *
sc
,

129 
u16
 *
’ŒÝy
, u16 *
Ën
, u16 *
pkey
,

130 
u32
 *
dlid
, u32 *
¦id
);

132 cÚ¡ *
hfi1_Œaû_fmt_Ìh
(
Œaû_£q
 *
p
, 
boÞ
 
by·ss
,

133 
u8
 
age
, 
boÞ
 
beú
, boÞ 
ãú
, u8 
l4
,

134 
u8
 
Êh
, cÚ¡ *
Êh_Çme
, u8 
lv”
,

135 
u8
 
rc
, u8 
sc
, u8 
¦
, 
u16
 
’ŒÝy
,

136 
u16
 
Ën
, u16 
pkey
, 
u32
 
dlid
, u32 
¦id
);

138 cÚ¡ *
hfi1_Œaû_fmt_»¡
(
Œaû_£q
 *
p
, 
boÞ
 
by·ss
, 
u8
 
l4
,

139 
u8
 
ack
, 
boÞ
 
beú
, boÞ 
ãú
, u8 
mig
,

140 
u8
 
£
, u8 
·d
, u8 
Ýcode
, cÚ¡ *
ÝÇme
,

141 
u8
 
tv”
, 
u16
 
pkey
, 
u32
 
p¢
, u32 
q²
,

142 
u32
 
de¡_q²
, u32 
¤c_q²
);

144 cÚ¡ *
hfi1_Œaû_g‘_·ck‘_l2_¡r
(
u8
 
l2
);

146 
	#__·r£_ib_ehdrs
(
Ý
, 
l4
, 
de¡_q²
, 
¤c_q²
, 
ehdrs
) \

147 
	`·r£_ev”bs_hdrs
(
p
, 
Ý
, 
l4
, 
de¡_q²
, 
¤c_q²
, 
ehdrs
)

	)

149 
	#Ìh_Çme
(
Ìh
è{ 
HFI1_
##Ìh, #Ìh }

	)

150 
	#show_Êh
(
Ìh
) \

151 
	`__´št_symbÞic
(
Ìh
, \

152 
	`Ìh_Çme
(
LRH_BTH
), \

153 
	`Ìh_Çme
(
LRH_GRH
))

	)

155 
DECLARE_EVENT_CLASS
(
hfi1_šput_ibhdr_‹m¶©e
,

156 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

157 
hfi1_·ck‘
 *
·ck‘
,

158 
boÞ
 
sc5
),

159 
TP_ARGS
(
dd
, 
·ck‘
, 
sc5
),

160 
TP_STRUCT__’Œy
(

161 
	$DD_DEV_ENTRY
(
dd
)

162 
	$__f›ld
(
u8
, 
‘y³
)

163 
	$__f›ld
(
u8
, 
ack
)

164 
	$__f›ld
(
u8
, 
age
)

165 
	$__f›ld
(
boÞ
, 
beú
)

166 
	$__f›ld
(
boÞ
, 
ãú
)

167 
	$__f›ld
(
u8
, 
l2
)

168 
	$__f›ld
(
u8
, 
l4
)

169 
	$__f›ld
(
u8
, 
Êh
)

170 
	$__f›ld
(
u8
, 
lv”
)

171 
	$__f›ld
(
u8
, 
mig
)

172 
	$__f›ld
(
u8
, 
Ýcode
)

173 
	$__f›ld
(
u8
, 
·d
)

174 
	$__f›ld
(
u8
, 
rc
)

175 
	$__f›ld
(
u8
, 
sc
)

176 
	$__f›ld
(
u8
, 
£
)

177 
	$__f›ld
(
u8
, 
¦
)

178 
	$__f›ld
(
u8
, 
tv”
)

179 
	$__f›ld
(
u16
, 
’ŒÝy
)

180 
	$__f›ld
(
u16
, 
Ën
)

181 
	$__f›ld
(
u16
, 
pkey
)

182 
	$__f›ld
(
u32
, 
dlid
)

183 
	$__f›ld
(
u32
, 
p¢
)

184 
	$__f›ld
(
u32
, 
q²
)

185 
	$__f›ld
(
u32
, 
¦id
)

186 
	$__f›ld
(
u32
, 
de¡_q²
)

187 
	$__f›ld
(
u32
, 
¤c_q²
)

189 
	`__dyÇmic_¬¿y
(
u8
, 
ehdrs
,

190 
	`hfi1_Œaû_·ck‘_hdr_Ën
(
·ck‘
))

192 
	`TP_ç¡_assign
(

193 
	`DD_DEV_ASSIGN
(
dd
);

195 
__’Œy
->
‘y³
 = 
·ck‘
->etype;

196 
__’Œy
->
l2
 = 
	`hfi1_16B_g‘_l2
(
·ck‘
->
hdr
);

197 
__’Œy
->
de¡_q²
 = 0;

198 
__’Œy
->
¤c_q²
 = 0;

199 ià(
__’Œy
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

200 
	`hfi1_Œaû_·r£_16b_hdr
(
·ck‘
->
hdr
,

201 &
__’Œy
->
age
,

202 &
__’Œy
->
beú
,

203 &
__’Œy
->
ãú
,

204 &
__’Œy
->
l4
,

205 &
__’Œy
->
rc
,

206 &
__’Œy
->
sc
,

207 &
__’Œy
->
’ŒÝy
,

208 &
__’Œy
->
Ën
,

209 &
__’Œy
->
pkey
,

210 &
__’Œy
->
dlid
,

211 &
__’Œy
->
¦id
);

213 ià(
__’Œy
->
l4
 =ð
OPA_16B_L4_FM
) {

214 
__’Œy
->
Ýcode
 = 
IB_OPCODE_UD_SEND_ONLY
;

215 
__’Œy
->
de¡_q²
 = 
	`hfi1_16B_g‘_de¡_q²
(
·ck‘
->
mgmt
);

216 
__’Œy
->
¤c_q²
 = 
	`hfi1_16B_g‘_¤c_q²
(
·ck‘
->
mgmt
);

218 
	`hfi1_Œaû_·r£_16b_bth
(
·ck‘
->
ohdr
,

219 &
__’Œy
->
ack
,

220 &
__’Œy
->
mig
,

221 &
__’Œy
->
Ýcode
,

222 &
__’Œy
->
·d
,

223 &
__’Œy
->
£
,

224 &
__’Œy
->
tv”
,

225 &
__’Œy
->
p¢
,

226 &
__’Œy
->
q²
);

228 
	}
} {

229 
__’Œy
->
l4
 = 
OPA_16B_L4_9B
;

230 
hfi1_Œaû_·r£_9b_hdr
(
·ck‘
->
hdr
, 
sc5
,

231 &
__’Œy
->
Êh
,

232 &
__’Œy
->
lv”
,

233 &
__’Œy
->
¦
,

234 &
__’Œy
->
sc
,

235 &
__’Œy
->
Ën
,

236 &
__’Œy
->
dlid
,

237 &
__’Œy
->
¦id
);

239 
hfi1_Œaû_·r£_9b_bth
(
·ck‘
->
ohdr
,

240 &
__’Œy
->
ack
,

241 &
__’Œy
->
beú
,

242 &
__’Œy
->
ãú
,

243 &
__’Œy
->
mig
,

244 &
__’Œy
->
£
,

245 &
__’Œy
->
·d
,

246 &
__’Œy
->
Ýcode
,

247 &
__’Œy
->
tv”
,

248 &
__’Œy
->
pkey
,

249 &
__’Œy
->
p¢
,

250 &
__’Œy
->
q²
);

253 ià(
__’Œy
->
l4
 !ð
OPA_16B_L4_FM
)

254 
memýy
(
__g‘_dyÇmic_¬¿y
(
ehdrs
),

255 &
·ck‘
->
ohdr
->
u
,

256 
__g‘_dyÇmic_¬¿y_Ën
(
ehdrs
));

258 
TP_´štk
("[%s] (%s) %s %s hlen:%d %s",

259 
__g‘_¡r
(
dev
),

260 
__’Œy
->
‘y³
 !ð
RHF_RCV_TYPE_BYPASS
 ?

261 
show_·ck‘ty³
(
__’Œy
->
‘y³
) :

262 
hfi1_Œaû_g‘_·ck‘_l2_¡r
(

263 
__’Œy
->
l2
),

264 
hfi1_Œaû_fmt_Ìh
(
p
,

265 
__’Œy
->
‘y³
 ==

266 
RHF_RCV_TYPE_BYPASS
,

267 
__’Œy
->
age
,

268 
__’Œy
->
beú
,

269 
__’Œy
->
ãú
,

270 
__’Œy
->
l4
,

271 
__’Œy
->
Êh
,

272 
show_Êh
(
__’Œy
->
Êh
),

273 
__’Œy
->
lv”
,

274 
__’Œy
->
rc
,

275 
__’Œy
->
sc
,

276 
__’Œy
->
¦
,

277 
__’Œy
->
’ŒÝy
,

278 
__’Œy
->
Ën
,

279 
__’Œy
->
pkey
,

280 
__’Œy
->
dlid
,

281 
__’Œy
->
¦id
),

282 
hfi1_Œaû_fmt_»¡
(
p
,

283 
__’Œy
->
‘y³
 ==

284 
RHF_RCV_TYPE_BYPASS
,

285 
__’Œy
->
l4
,

286 
__’Œy
->
ack
,

287 
__’Œy
->
beú
,

288 
__’Œy
->
ãú
,

289 
__’Œy
->
mig
,

290 
__’Œy
->
£
,

291 
__’Œy
->
·d
,

292 
__’Œy
->
Ýcode
,

293 
show_ib_Ýcode
(
__’Œy
->
Ýcode
),

294 
__’Œy
->
tv”
,

295 
__’Œy
->
pkey
,

296 
__’Œy
->
p¢
,

297 
__’Œy
->
q²
,

298 
__’Œy
->
de¡_q²
,

299 
__’Œy
->
¤c_q²
),

301 
__g‘_dyÇmic_¬¿y_Ën
(
ehdrs
),

302 
__·r£_ib_ehdrs
(

303 
__’Œy
->
Ýcode
,

304 
__’Œy
->
l4
,

305 
__’Œy
->
de¡_q²
,

306 
__’Œy
->
¤c_q²
,

307 (*)
__g‘_dyÇmic_¬¿y
(
ehdrs
))

311 
DEFINE_EVENT
(
hfi1_šput_ibhdr_‹m¶©e
, 
šput_ibhdr
,

312 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

313 
hfi1_·ck‘
 *
·ck‘
, 
boÞ
 
sc5
),

314 
TP_ARGS
(
dd
, 
·ck‘
, 
sc5
));

316 
DECLARE_EVENT_CLASS
(
hfi1_ouut_ibhdr_‹m¶©e
,

317 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

318 
hfi1_Ýa_h—d”
 *
Ýah
, 
boÞ
 
sc5
),

319 
TP_ARGS
(
dd
, 
Ýah
, 
sc5
),

320 
TP_STRUCT__’Œy
(

321 
	$DD_DEV_ENTRY
(
dd
)

322 
	$__f›ld
(
u8
, 
hdr_ty³
)

323 
	$__f›ld
(
u8
, 
ack
)

324 
	$__f›ld
(
u8
, 
age
)

325 
	$__f›ld
(
boÞ
, 
beú
)

326 
	$__f›ld
(
boÞ
, 
ãú
)

327 
	$__f›ld
(
u8
, 
l4
)

328 
	$__f›ld
(
u8
, 
Êh
)

329 
	$__f›ld
(
u8
, 
lv”
)

330 
	$__f›ld
(
u8
, 
mig
)

331 
	$__f›ld
(
u8
, 
Ýcode
)

332 
	$__f›ld
(
u8
, 
·d
)

333 
	$__f›ld
(
u8
, 
rc
)

334 
	$__f›ld
(
u8
, 
sc
)

335 
	$__f›ld
(
u8
, 
£
)

336 
	$__f›ld
(
u8
, 
¦
)

337 
	$__f›ld
(
u8
, 
tv”
)

338 
	$__f›ld
(
u16
, 
’ŒÝy
)

339 
	$__f›ld
(
u16
, 
Ën
)

340 
	$__f›ld
(
u16
, 
pkey
)

341 
	$__f›ld
(
u32
, 
dlid
)

342 
	$__f›ld
(
u32
, 
p¢
)

343 
	$__f›ld
(
u32
, 
q²
)

344 
	$__f›ld
(
u32
, 
¦id
)

345 
	$__f›ld
(
u32
, 
de¡_q²
)

346 
	$__f›ld
(
u32
, 
¤c_q²
)

348 
	`__dyÇmic_¬¿y
(
u8
, 
ehdrs
,

349 
	`hfi1_Œaû_Ýa_hdr_Ën
(
Ýah
))

351 
	`TP_ç¡_assign
(

352 
ib_Ùh”_h—d”s
 *
ohdr
;

354 
	`DD_DEV_ASSIGN
(
dd
);

356 
__’Œy
->
hdr_ty³
 = 
Ýah
->hdr_type;

357 
__’Œy
->
de¡_q²
 = 0;

358 
__’Œy
->
¤c_q²
 = 0;

359 ià(
__’Œy
->
hdr_ty³
) {

360 
	`hfi1_Œaû_·r£_16b_hdr
(&
Ýah
->opah,

361 &
__’Œy
->
age
,

362 &
__’Œy
->
beú
,

363 &
__’Œy
->
ãú
,

364 &
__’Œy
->
l4
,

365 &
__’Œy
->
rc
,

366 &
__’Œy
->
sc
,

367 &
__’Œy
->
’ŒÝy
,

368 &
__’Œy
->
Ën
,

369 &
__’Œy
->
pkey
,

370 &
__’Œy
->
dlid
,

371 &
__’Œy
->
¦id
);

373 ià(
__’Œy
->
l4
 =ð
OPA_16B_L4_FM
) {

374 
ohdr
 = 
NULL
;

375 
__’Œy
->
Ýcode
 = 
IB_OPCODE_UD_SEND_ONLY
;

376 
__’Œy
->
de¡_q²
 = 
	`hfi1_16B_g‘_de¡_q²
(&
Ýah
->Ýah.
u
.
mgmt
);

377 
__’Œy
->
¤c_q²
 = 
	`hfi1_16B_g‘_¤c_q²
(&
Ýah
->Ýah.
u
.
mgmt
);

379 ià(
__’Œy
->
l4
 =ð
OPA_16B_L4_IB_LOCAL
)

380 
ohdr
 = &
Ýah
->Ýah.
u
.
Ùh
;

382 
ohdr
 = &
Ýah
->Ýah.
u
.
l
.
Ùh
;

383 
	`hfi1_Œaû_·r£_16b_bth
(
ohdr
,

384 &
__’Œy
->
ack
,

385 &
__’Œy
->
mig
,

386 &
__’Œy
->
Ýcode
,

387 &
__’Œy
->
·d
,

388 &
__’Œy
->
£
,

389 &
__’Œy
->
tv”
,

390 &
__’Œy
->
p¢
,

391 &
__’Œy
->
q²
);

393 
	}
} {

394 
__’Œy
->
l4
 = 
OPA_16B_L4_9B
;

395 
hfi1_Œaû_·r£_9b_hdr
(&
Ýah
->
ibh
, 
sc5
,

396 &
__’Œy
->
Êh
,

397 &
__’Œy
->
lv”
,

398 &
__’Œy
->
¦
,

399 &
__’Œy
->
sc
,

400 &
__’Œy
->
Ën
,

401 &
__’Œy
->
dlid
,

402 &
__’Œy
->
¦id
);

403 ià(
__’Œy
->
Êh
 =ð
HFI1_LRH_BTH
)

404 
ohdr
 = &
Ýah
->
ibh
.
u
.
Ùh
;

406 
ohdr
 = &
Ýah
->
ibh
.
u
.
l
.
Ùh
;

407 
hfi1_Œaû_·r£_9b_bth
(
ohdr
,

408 &
__’Œy
->
ack
,

409 &
__’Œy
->
beú
,

410 &
__’Œy
->
ãú
,

411 &
__’Œy
->
mig
,

412 &
__’Œy
->
£
,

413 &
__’Œy
->
·d
,

414 &
__’Œy
->
Ýcode
,

415 &
__’Œy
->
tv”
,

416 &
__’Œy
->
pkey
,

417 &
__’Œy
->
p¢
,

418 &
__’Œy
->
q²
);

422 ià(
__’Œy
->
l4
 !ð
OPA_16B_L4_FM
)

423 
memýy
(
__g‘_dyÇmic_¬¿y
(
ehdrs
),

424 &
ohdr
->
u
, 
__g‘_dyÇmic_¬¿y_Ën
(
ehdrs
));

426 
TP_´štk
("[%s] (%s) %s %s hlen:%d %s",

427 
__g‘_¡r
(
dev
),

428 
hfi1_Œaû_g‘_·ck‘_l4_¡r
(
__’Œy
->
l4
),

429 
hfi1_Œaû_fmt_Ìh
(
p
,

430 !!
__’Œy
->
hdr_ty³
,

431 
__’Œy
->
age
,

432 
__’Œy
->
beú
,

433 
__’Œy
->
ãú
,

434 
__’Œy
->
l4
,

435 
__’Œy
->
Êh
,

436 
show_Êh
(
__’Œy
->
Êh
),

437 
__’Œy
->
lv”
,

438 
__’Œy
->
rc
,

439 
__’Œy
->
sc
,

440 
__’Œy
->
¦
,

441 
__’Œy
->
’ŒÝy
,

442 
__’Œy
->
Ën
,

443 
__’Œy
->
pkey
,

444 
__’Œy
->
dlid
,

445 
__’Œy
->
¦id
),

446 
hfi1_Œaû_fmt_»¡
(
p
,

447 !!
__’Œy
->
hdr_ty³
,

448 
__’Œy
->
l4
,

449 
__’Œy
->
ack
,

450 
__’Œy
->
beú
,

451 
__’Œy
->
ãú
,

452 
__’Œy
->
mig
,

453 
__’Œy
->
£
,

454 
__’Œy
->
·d
,

455 
__’Œy
->
Ýcode
,

456 
show_ib_Ýcode
(
__’Œy
->
Ýcode
),

457 
__’Œy
->
tv”
,

458 
__’Œy
->
pkey
,

459 
__’Œy
->
p¢
,

460 
__’Œy
->
q²
,

461 
__’Œy
->
de¡_q²
,

462 
__’Œy
->
¤c_q²
),

464 
__g‘_dyÇmic_¬¿y_Ën
(
ehdrs
),

465 
__·r£_ib_ehdrs
(

466 
__’Œy
->
Ýcode
,

467 
__’Œy
->
l4
,

468 
__’Œy
->
de¡_q²
,

469 
__’Œy
->
¤c_q²
,

470 (*)
__g‘_dyÇmic_¬¿y
(
ehdrs
))

474 
DEFINE_EVENT
(
hfi1_ouut_ibhdr_‹m¶©e
, 
pio_ouut_ibhdr
,

475 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

476 
hfi1_Ýa_h—d”
 *
Ýah
, 
boÞ
 
sc5
),

477 
TP_ARGS
(
dd
, 
Ýah
, 
sc5
));

479 
DEFINE_EVENT
(
hfi1_ouut_ibhdr_‹m¶©e
, 
ack_ouut_ibhdr
,

480 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

481 
hfi1_Ýa_h—d”
 *
Ýah
, 
boÞ
 
sc5
),

482 
TP_ARGS
(
dd
, 
Ýah
, 
sc5
));

484 
DEFINE_EVENT
(
hfi1_ouut_ibhdr_‹m¶©e
, 
sdma_ouut_ibhdr
,

485 
TP_PROTO
(
hfi1_devd©a
 *
dd
,

486 
hfi1_Ýa_h—d”
 *
Ýah
, 
boÞ
 
sc5
),

487 
TP_ARGS
(
dd
, 
Ýah
, 
sc5
));

492 #undeà
TRACE_INCLUDE_PATH


493 #undeà
TRACE_INCLUDE_FILE


494 
	#TRACE_INCLUDE_PATH
 .

	)

495 
	#TRACE_INCLUDE_FILE
 
Œaû_ibhdrs


	)

496 
	~<Œaû/defše_Œaû.h
>

	@trace_iowait.h

47 #ià!
defšed
(
__HFI1_TRACE_IOWAIT_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_IOWAIT_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~"iowa™.h
"

52 
	~"v”bs.h
"

54 #undeà
TRACE_SYSTEM


55 
	#TRACE_SYSTEM
 
hfi1_iowa™


	)

57 
DECLARE_EVENT_CLASS
(
hfi1_iowa™_‹m¶©e
,

58 
TP_PROTO
(
iowa™
 *
wa™
, 
u32
 
æag
),

59 
TP_ARGS
(
wa™
, 
æag
),

60 
TP_STRUCT__’Œy
(

61 
	$__f›ld
(, 
addr
)

62 
	$__f›ld
(, 
æags
)

63 
	$__f›ld
(
u32
, 
æag
)

64 
	`__f›ld
(
u32
, 
q²
)

66 
	`TP_ç¡_assign
(

67 
__’Œy
->
addr
 = ()
wa™
;

68 
__’Œy
->
æags
 = 
wa™
->flags;

69 
__’Œy
->
æag
 = (1 << flag);

70 
__’Œy
->
q²
 = 
	`iowa™_to_qp
(
wa™
)->
ibqp
.
qp_num
;

72 
	`TP_´štk
(

74 
__’Œy
->
addr
,

75 
__’Œy
->
q²
,

76 
__’Œy
->
æags
,

77 
__’Œy
->
æag


81 
	`DEFINE_EVENT
(
hfi1_iowa™_‹m¶©e
, 
hfi1_iowa™_£t
,

82 
	`TP_PROTO
(
iowa™
 *
wa™
, 
u32
 
æag
),

83 
	`TP_ARGS
(
wa™
, 
æag
));

85 
	`DEFINE_EVENT
(
hfi1_iowa™_‹m¶©e
, 
hfi1_iowa™_þ—r
,

86 
	`TP_PROTO
(
iowa™
 *
wa™
, 
u32
 
æag
),

87 
	`TP_ARGS
(
wa™
, 
æag
));

91 #undeà
TRACE_INCLUDE_PATH


92 #undeà
TRACE_INCLUDE_FILE


93 
	#TRACE_INCLUDE_PATH
 .

	)

94 
	#TRACE_INCLUDE_FILE
 
Œaû_iowa™


	)

95 
	~<Œaû/defše_Œaû.h
>

	@trace_misc.h

47 #ià!
defšed
(
__HFI1_TRACE_MISC_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_MISC_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_misc


	)

58 
TRACE_EVENT
(
hfi1_š‹¼u±
,

59 
TP_PROTO
(
hfi1_devd©a
 *
dd
, cÚ¡ 
is_bË
 *
is_’Œy
,

60 
¤c
),

61 
TP_ARGS
(
dd
, 
is_’Œy
, 
¤c
),

62 
TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

63 
	$__¬¿y
(, 
buf
, 64)

64 
	`__f›ld
(, 
¤c
)

66 
	`TP_ç¡_assign
(
	$DD_DEV_ASSIGN
(
dd
)

67 
is_’Œy
->
	`is_Çme
(
__’Œy
->
buf
, 64,

68 
¤c
 - 
is_’Œy
->
¡¬t
);

69 
__’Œy
->
¤c
 = src;

71 
	`TP_´štk
("[%s] sourû: % [%d]", 
	`__g‘_¡r
(
dev
), 
__’Œy
->
buf
,

72 
__’Œy
->
¤c
)

75 
	`DECLARE_EVENT_CLASS
(

76 
hfi1_c¤_‹m¶©e
,

77 
	`TP_PROTO
(
__iomem
 *
addr
, 
u64
 
v®ue
),

78 
	`TP_ARGS
(
addr
, 
v®ue
),

79 
	`TP_STRUCT__’Œy
(

80 
	$__f›ld
(
__iomem
 *, 
addr
)

81 
	`__f›ld
(
u64
, 
v®ue
)

83 
	`TP_ç¡_assign
(

84 
__’Œy
->
addr
 =‡ddr;

85 
__’Œy
->
v®ue
 = value;

87 
	`TP_´štk
("add¸%°v®u%Îx", 
__’Œy
->
addr
, __’Œy->
v®ue
)

90 
	`DEFINE_EVENT
(

91 
hfi1_c¤_‹m¶©e
, 
hfi1_wr™e_rcv¬¿y
,

92 
	`TP_PROTO
(
__iomem
 *
addr
, 
u64
 
v®ue
),

93 
	`TP_ARGS
(
addr
, 
v®ue
));

95 #ifdeà
CONFIG_FAULT_INJECTION


96 
	`TRACE_EVENT
(
hfi1_çuÉ_Ýcode
,

97 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
Ýcode
),

98 
	`TP_ARGS
(
qp
, 
Ýcode
),

99 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

100 
	$__f›ld
(
u32
, 
q²
)

101 
	`__f›ld
(
u8
, 
Ýcode
)

103 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

104 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

105 
__’Œy
->
Ýcode
 = opcode;

107 
	`TP_´štk
("[%s] qpn 0x%x opcode 0x%x",

108 
	`__g‘_¡r
(
dev
), 
__’Œy
->
q²
, __’Œy->
Ýcode
)

111 
	`TRACE_EVENT
(
hfi1_çuÉ_·ck‘
,

112 
	`TP_PROTO
(
hfi1_·ck‘
 *
·ck‘
),

113 
	`TP_ARGS
(
·ck‘
),

114 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
·ck‘
->
rcd
->
µd
->
dd
)

115 
	$__f›ld
(
u64
, 
eæags
)

116 
	$__f›ld
(
u32
, 
ùxt
)

117 
	$__f›ld
(
u32
, 
hËn
)

118 
	$__f›ld
(
u32
, 
Ž’
)

119 
	$__f›ld
(
u32
, 
updegr
)

120 
	`__f›ld
(
u32
, 
‘až
)

122 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
·ck‘
->
rcd
->
µd
->
dd
);

123 
__’Œy
->
eæags
 = 
	`rhf_”r_æags
(
·ck‘
->
rhf
);

124 
__’Œy
->
ùxt
 = 
·ck‘
->
rcd
->ctxt;

125 
__’Œy
->
hËn
 = 
·ck‘
->hlen;

126 
__’Œy
->
Ž’
 = 
·ck‘
->tlen;

127 
__’Œy
->
updegr
 = 
·ck‘
->updegr;

128 
__’Œy
->
‘až
 = 
	`rhf_egr_šdex
(
·ck‘
->
rhf
);

130 
	`TP_´štk
(

132 
	`__g‘_¡r
(
dev
),

133 
__’Œy
->
ùxt
,

134 
__’Œy
->
eæags
,

135 
__’Œy
->
hËn
,

136 
__’Œy
->
Ž’
,

137 
__’Œy
->
updegr
,

138 
__’Œy
->
‘až


145 #undeà
TRACE_INCLUDE_PATH


146 #undeà
TRACE_INCLUDE_FILE


147 
	#TRACE_INCLUDE_PATH
 .

	)

148 
	#TRACE_INCLUDE_FILE
 
Œaû_misc


	)

149 
	~<Œaû/defše_Œaû.h
>

	@trace_mmu.h

47 #ià!
defšed
(
__HFI1_TRACE_MMU_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_MMU_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_mmu


	)

58 
DECLARE_EVENT_CLASS
(
hfi1_mmu_rb_‹m¶©e
,

59 
TP_PROTO
(
addr
, 
Ën
),

60 
TP_ARGS
(
addr
, 
Ën
),

61 
TP_STRUCT__’Œy
(
	$__f›ld
(, 
addr
)

62 
	`__f›ld
(, 
Ën
)

64 
	`TP_ç¡_assign
(
__’Œy
->
addr
 =‡ddr;

65 
__’Œy
->
Ën
 =†en;

67 
	`TP_´štk
("MMU‚ode‡ddr 0x%lx,†en %lu",

68 
__’Œy
->
addr
,

69 
__’Œy
->
Ën


73 
	`DEFINE_EVENT
(
hfi1_mmu_rb_‹m¶©e
, 
hfi1_mmu_rb_š£¹
,

74 
	`TP_PROTO
(
addr
, 
Ën
),

75 
	`TP_ARGS
(
addr
, 
Ën
));

77 
	`DEFINE_EVENT
(
hfi1_mmu_rb_‹m¶©e
, 
hfi1_mmu_rb_£¬ch
,

78 
	`TP_PROTO
(
addr
, 
Ën
),

79 
	`TP_ARGS
(
addr
, 
Ën
));

81 
	`DEFINE_EVENT
(
hfi1_mmu_rb_‹m¶©e
, 
hfi1_mmu_rb_»move
,

82 
	`TP_PROTO
(
addr
, 
Ën
),

83 
	`TP_ARGS
(
addr
, 
Ën
));

85 
	`DEFINE_EVENT
(
hfi1_mmu_rb_‹m¶©e
, 
hfi1_mmu_mem_šv®id©e
,

86 
	`TP_PROTO
(
addr
, 
Ën
),

87 
	`TP_ARGS
(
addr
, 
Ën
));

91 #undeà
TRACE_INCLUDE_PATH


92 #undeà
TRACE_INCLUDE_FILE


93 
	#TRACE_INCLUDE_PATH
 .

	)

94 
	#TRACE_INCLUDE_FILE
 
Œaû_mmu


	)

95 
	~<Œaû/defše_Œaû.h
>

	@trace_rc.h

47 #ià!
defšed
(
__HFI1_TRACE_RC_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_RC_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_rc


	)

58 
DECLARE_EVENT_CLASS
(
hfi1_rc_‹m¶©e
,

59 
TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

60 
TP_ARGS
(
qp
, 
p¢
),

61 
TP_STRUCT__’Œy
(

62 
DD_DEV_ENTRY
(
dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

63 
	$__f›ld
(
u32
, 
q²
)

64 
	$__f›ld
(
u32
, 
s_æags
)

65 
	$__f›ld
(
u32
, 
p¢
)

66 
	$__f›ld
(
u32
, 
s_p¢
)

67 
	$__f›ld
(
u32
, 
s_Ãxt_p¢
)

68 
	$__f›ld
(
u32
, 
s_£ndšg_p¢
)

69 
	$__f›ld
(
u32
, 
s_£ndšg_hp¢
)

70 
	`__f›ld
(
u32
, 
r_p¢
)

72 
	`TP_ç¡_assign
(

73 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

74 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

75 
__’Œy
->
s_æags
 = 
qp
->s_flags;

76 
__’Œy
->
p¢
 =…sn;

77 
__’Œy
->
s_p¢
 = 
qp
->s_psn;

78 
__’Œy
->
s_Ãxt_p¢
 = 
qp
->s_next_psn;

79 
__’Œy
->
s_£ndšg_p¢
 = 
qp
->s_sending_psn;

80 
__’Œy
->
s_£ndšg_hp¢
 = 
qp
->s_sending_hpsn;

81 
__’Œy
->
r_p¢
 = 
qp
->r_psn;

83 
	`TP_´štk
(

85 
	`__g‘_¡r
(
dev
),

86 
__’Œy
->
q²
,

87 
__’Œy
->
s_æags
,

88 
__’Œy
->
p¢
,

89 
__’Œy
->
s_p¢
,

90 
__’Œy
->
s_Ãxt_p¢
,

91 
__’Œy
->
s_£ndšg_p¢
,

92 
__’Œy
->
s_£ndšg_hp¢
,

93 
__’Œy
->
r_p¢


97 
	`DEFINE_EVENT
(
hfi1_rc_‹m¶©e
, 
hfi1_£ndcom¶‘e
,

98 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

99 
	`TP_ARGS
(
qp
, 
p¢
)

102 
	`DEFINE_EVENT
(
hfi1_rc_‹m¶©e
, 
hfi1_ack
,

103 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

104 
	`TP_ARGS
(
qp
, 
p¢
)

107 
	`DEFINE_EVENT
(
hfi1_rc_‹m¶©e
, 
hfi1_rcv_”rÜ
,

108 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

109 
	`TP_ARGS
(
qp
, 
p¢
)

112 
	`DEFINE_EVENT
(

113 
hfi1_rc_‹m¶©e
, 
hfi1_rc_com¶‘iÚ
,

114 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

115 
	`TP_ARGS
(
qp
, 
p¢
)

118 
	`DECLARE_EVENT_CLASS
(

119 
hfi1_rc_ack_‹m¶©e
,

120 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
,

121 
rvt_swqe
 *
wqe
),

122 
	`TP_ARGS
(
qp
, 
«th
, 
p¢
, 
wqe
),

123 
	`TP_STRUCT__’Œy
(

124 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

125 
	$__f›ld
(
u32
, 
q²
)

126 
	$__f›ld
(
u32
, 
«th
)

127 
	$__f›ld
(
u32
, 
p¢
)

128 
	$__f›ld
(
u8
, 
Ýcode
)

129 
	$__f›ld
(
u32
, 
¥¢
)

130 
	`__f›ld
(
u32
, 
Í¢
)

132 
	`TP_ç¡_assign
(

133 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

134 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

135 
__’Œy
->
«th
 =‡eth;

136 
__’Œy
->
p¢
 =…sn;

137 
__’Œy
->
Ýcode
 = 
wqe
->
wr
.opcode;

138 
__’Œy
->
¥¢
 = 
wqe
->
p¢
;

139 
__’Œy
->
Í¢
 = 
wqe
->lpsn;

141 
	`TP_´štk
(

143 
	`__g‘_¡r
(
dev
),

144 
__’Œy
->
q²
,

145 
__’Œy
->
«th
,

146 
__’Œy
->
p¢
,

147 
__’Œy
->
Ýcode
,

148 
__’Œy
->
¥¢
,

149 
__’Œy
->
Í¢


153 
	`DEFINE_EVENT
(

154 
hfi1_rc_ack_‹m¶©e
, 
hfi1_rc_ack_do
,

155 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
,

156 
rvt_swqe
 *
wqe
),

157 
	`TP_ARGS
(
qp
, 
«th
, 
p¢
, 
wqe
)

162 #undeà
TRACE_INCLUDE_PATH


163 #undeà
TRACE_INCLUDE_FILE


164 
	#TRACE_INCLUDE_PATH
 .

	)

165 
	#TRACE_INCLUDE_FILE
 
Œaû_rc


	)

166 
	~<Œaû/defše_Œaû.h
>

	@trace_rx.h

47 #ià!
defšed
(
__HFI1_TRACE_RX_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_RX_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 #undeà
TRACE_SYSTEM


56 
	#TRACE_SYSTEM
 
hfi1_rx


	)

58 
TRACE_EVENT
(
hfi1_rcvhdr
,

59 
TP_PROTO
(
hfi1_·ck‘
 *
·ck‘
),

60 
TP_ARGS
(
·ck‘
),

61 
TP_STRUCT__’Œy
(
DD_DEV_ENTRY
(
·ck‘
->
rcd
->
dd
)

62 
	$__f›ld
(
u64
, 
eæags
)

63 
	$__f›ld
(
u32
, 
ùxt
)

64 
	$__f›ld
(
u32
, 
‘y³
)

65 
	$__f›ld
(
u32
, 
hËn
)

66 
	$__f›ld
(
u32
, 
Ž’
)

67 
	$__f›ld
(
u32
, 
updegr
)

68 
	`__f›ld
(
u32
, 
‘až
)

70 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
·ck‘
->
rcd
->
dd
);

71 
__’Œy
->
eæags
 = 
	`rhf_”r_æags
(
·ck‘
->
rhf
);

72 
__’Œy
->
ùxt
 = 
·ck‘
->
rcd
->ctxt;

73 
__’Œy
->
‘y³
 = 
·ck‘
->etype;

74 
__’Œy
->
hËn
 = 
·ck‘
->hlen;

75 
__’Œy
->
Ž’
 = 
·ck‘
->tlen;

76 
__’Œy
->
updegr
 = 
·ck‘
->updegr;

77 
__’Œy
->
‘až
 = 
	`rhf_egr_šdex
(
·ck‘
->
rhf
);

79 
	`TP_´štk
(

81 
	`__g‘_¡r
(
dev
),

82 
__’Œy
->
ùxt
,

83 
__’Œy
->
eæags
,

84 
__’Œy
->
‘y³
, 
	`show_·ck‘ty³
(__entry->etype),

85 
__’Œy
->
hËn
,

86 
__’Œy
->
Ž’
,

87 
__’Œy
->
updegr
,

88 
__’Œy
->
‘až


92 
	`TRACE_EVENT
(
hfi1_»ûive_š‹¼u±
,

93 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
hfi1_ùxtd©a
 *
rcd
),

94 
	`TP_ARGS
(
dd
, 
rcd
),

95 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

96 
	$__f›ld
(
u32
, 
ùxt
)

97 
	$__f›ld
(
boÞ
, 
¦ow_·th
)

98 
	`__f›ld
(
boÞ
, 
dma_¹až
)

100 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

101 
__’Œy
->
ùxt
 = 
rcd
->ctxt;

102 
__’Œy
->
¦ow_·th
 = 
	`hfi1_is_¦ow·th
(
rcd
);

103 
__’Œy
->
dma_¹až
 = 
	`g‘_dma_¹až_£‰šg
(
rcd
);

105 
	`TP_´štk
("[%s] ctxt %d SlowPath: %d DmaRtail: %d",

106 
	`__g‘_¡r
(
dev
),

107 
__’Œy
->
ùxt
,

108 
__’Œy
->
¦ow_·th
,

109 
__’Œy
->
dma_¹až


113 
	`TRACE_EVENT
(
hfi1_mmu_šv®id©e
,

114 
	`TP_PROTO
(
ùxt
, 
u16
 
subùxt
, cÚ¡ *
ty³
,

115 
¡¬t
, 
’d
),

116 
	`TP_ARGS
(
ùxt
, 
subùxt
, 
ty³
, 
¡¬t
, 
’d
),

117 
	`TP_STRUCT__’Œy
(

118 
	$__f›ld
(, 
ùxt
)

119 
	$__f›ld
(
u16
, 
subùxt
)

120 
	$__¡ršg
(
ty³
,ype)

121 
	$__f›ld
(, 
¡¬t
)

122 
	`__f›ld
(, 
’d
)

124 
	`TP_ç¡_assign
(

125 
__’Œy
->
ùxt
 = ctxt;

126 
__’Œy
->
subùxt
 = subctxt;

127 
	`__assign_¡r
(
ty³
,ype);

128 
__’Œy
->
¡¬t
 = start;

129 
__’Œy
->
’d
 =ƒnd;

131 
	`TP_´štk
("[%3u:%02u] MMU Invalidate (%s) 0x%lx - 0x%lx",

132 
__’Œy
->
ùxt
,

133 
__’Œy
->
subùxt
,

134 
	`__g‘_¡r
(
ty³
),

135 
__’Œy
->
¡¬t
,

136 
__’Œy
->
’d


140 
	#SNOOP_PRN
 \

142 "svølvÈ%d…key 0x%.4x [h—d” = %d by‹s] [d©¨ð%d by‹s]"

	)

144 
	`TRACE_EVENT
(
¢oÝ_ÿ±u»
,

145 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
,

146 
hdr_Ën
,

147 
ib_h—d”
 *
hdr
,

148 
d©a_Ën
,

149 *
d©a
),

150 
	`TP_ARGS
(
dd
, 
hdr_Ën
, 
hdr
, 
d©a_Ën
, 
d©a
),

151 
	`TP_STRUCT__’Œy
(

152 
	$DD_DEV_ENTRY
(
dd
)

153 
	$__f›ld
(
u16
, 
¦id
)

154 
	$__f›ld
(
u16
, 
dlid
)

155 
	$__f›ld
(
u32
, 
q²
)

156 
	$__f›ld
(
u8
, 
Ýcode
)

157 
	$__f›ld
(
u8
, 
¦
)

158 
	$__f›ld
(
u16
, 
pkey
)

159 
	$__f›ld
(
u32
, 
hdr_Ën
)

160 
	$__f›ld
(
u32
, 
d©a_Ën
)

161 
	$__f›ld
(
u8
, 
Êh
)

162 
	$__dyÇmic_¬¿y
(
u8
, 
¿w_hdr
, 
hdr_Ën
)

163 
	`__dyÇmic_¬¿y
(
u8
, 
¿w_pkt
, 
d©a_Ën
)

165 
	`TP_ç¡_assign
(

166 
ib_Ùh”_h—d”s
 *
ohdr
;

168 
__’Œy
->
Êh
 = (
u8
)(
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3);

169 ià(
__’Œy
->
Êh
 =ð
HFI1_LRH_BTH
)

170 
ohdr
 = &
hdr
->
u
.
Ùh
;

172 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

173 
	`DD_DEV_ASSIGN
(
dd
);

174 
__’Œy
->
¦id
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[3]);

175 
__’Œy
->
dlid
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[1]);

176 
__’Œy
->
q²
 = 
	`be32_to_ýu
(
ohdr
->
bth
[1]è& 
RVT_QPN_MASK
;

177 
__’Œy
->
Ýcode
 = (
	`be32_to_ýu
(
ohdr
->
bth
[0]) >> 24) & 0xff;

178 
__’Œy
->
¦
 = (
u8
)(
	`be16_to_ýu
(
hdr
->
Ìh
[0]) >> 4) & 0xf;

179 
__’Œy
->
pkey
 = 
	`be32_to_ýu
(
ohdr
->
bth
[0]) & 0xffff;

180 
__’Œy
->
hdr_Ën
 = hdr_len;

181 
__’Œy
->
d©a_Ën
 = data_len;

182 
	`memýy
(
	`__g‘_dyÇmic_¬¿y
(
¿w_hdr
), 
hdr
, 
hdr_Ën
);

183 
	`memýy
(
	`__g‘_dyÇmic_¬¿y
(
¿w_pkt
), 
d©a
, 
d©a_Ën
);

185 
	`TP_´štk
(

186 "[%s] " 
SNOOP_PRN
,

187 
	`__g‘_¡r
(
dev
),

188 
__’Œy
->
¦id
,

189 
__’Œy
->
dlid
,

190 
__’Œy
->
q²
,

191 
__’Œy
->
Ýcode
,

192 
	`show_ib_Ýcode
(
__’Œy
->
Ýcode
),

193 
__’Œy
->
¦
,

194 
__’Œy
->
pkey
,

195 
__’Œy
->
hdr_Ën
,

196 
__’Œy
->
d©a_Ën


202 #undeà
TRACE_INCLUDE_PATH


203 #undeà
TRACE_INCLUDE_FILE


204 
	#TRACE_INCLUDE_PATH
 .

	)

205 
	#TRACE_INCLUDE_FILE
 
Œaû_rx


	)

206 
	~<Œaû/defše_Œaû.h
>

	@trace_tid.h

47 #ià!
defšed
(
__HFI1_TRACE_TID_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_TID_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

55 
	#tidty³_Çme
(
ty³
è{ 
PT_
##ty³, #ty³ }

	)

56 
	#show_tidty³
(
ty³
) \

57 
	`__´št_symbÞic
(
ty³
, \

58 
	`tidty³_Çme
(
EXPECTED
), \

59 
	`tidty³_Çme
(
EAGER
), \

60 
	`tidty³_Çme
(
INVALID
)) \

61 

	)

62 #undeà
TRACE_SYSTEM


63 
	#TRACE_SYSTEM
 
hfi1_tid


	)

65 
u8
 
hfi1_Œaû_g‘_tid_ù¾
(
u32
 
’t
);

66 
u16
 
hfi1_Œaû_g‘_tid_Ën
(
u32
 
’t
);

67 
u16
 
hfi1_Œaû_g‘_tid_idx
(
u32
 
’t
);

69 
	#OPFN_PARAM_PRN
 "[%s] qpn 0x%x %s OPFN: qp 0x%x, max„ead %u, " \

71 "urg %u"

	)

73 
	#TID_FLOW_PRN
 "[%s] qpn 0x%x flow %d: idx %d„esp_ib_psn 0x%x " \

76 "tidúˆ%uid_idx %uid_off£ˆ%u†’gth %u s’ˆ%u"

	)

78 
	#TID_NODE_PRN
 "[%s] qpn 0x%x %s idx %u grp base 0x%x map 0x%x " \

79 "u£d %u cÁ %u"

	)

81 
	#RSP_INFO_PRN
 "[%s] qpn 0x%x state 0x%x s_state 0x%x…sn 0x%x " \

86 "iow_æag 0x%lx"

	)

88 
	#SENDER_INFO_PRN
 "[%s] qpn 0x%x state 0x%x s_cur %u s_tail %u " \

91 "iow_æag 0x%lx s_¡©0x%x s_num_rd %u s_»Œy %u"

	)

93 
	#TID_READ_SENDER_PRN
 "[%s] qpn 0x%x‚ewreq %uid_r_reqs %u " \

97 "å¢ 0x%x"

	)

99 
	#TID_REQ_PRN
 "[%s] qpn 0x%x‚ewreq %u opcode 0x%x…sn 0x%x†psn 0x%x " \

103 "r_Ï¡_ackd 0x%x s_Ãxt_p¢ 0x%x"

	)

105 
	#RCV_ERR_PRN
 "[%s] qpn 0x%x s_flags 0x%x state 0x%x " \

108 " difà%d"

	)

110 
	#TID_WRITE_RSPDR_PRN
 "[%s] qpn 0x%x„_tid_head %u„_tid_tail %u " \

116 "r_Ãxt_p¢_kd‘h 0x%x"

	)

118 
	#TID_WRITE_SENDER_PRN
 "[%s] qpn 0x%x‚ewreq %u s_tid_cur %u " \

122 "iow_æag 0x%lx s_¡©0x%x s_»Œy %u"

	)

124 
	#KDETH_EFLAGS_ERR_PRN
 "[%s] qpn 0x%x TID ERR: RcvType 0x%x " \

125 "RcvTy³E¼Ü 0x%x PSN 0x%x"

	)

127 
DECLARE_EVENT_CLASS
(

128 
hfi1_exp_tid_»g_uÄeg
,

129 
TP_PROTO
(
ùxt
, 
u16
 
subùxt
, 
u32
 
¿¼
, u32 
Åages
,

130 
va
, 
·
, 
dma_addr_t
 
dma
),

131 
TP_ARGS
(
ùxt
, 
subùxt
, 
¿¼
, 
Åages
, 
va
, 
·
, 
dma
),

132 
TP_STRUCT__’Œy
(

133 
	$__f›ld
(, 
ùxt
)

134 
	$__f›ld
(
u16
, 
subùxt
)

135 
	$__f›ld
(
u32
, 
¿¼
)

136 
	$__f›ld
(
u32
, 
Åages
)

137 
	$__f›ld
(, 
va
)

138 
	$__f›ld
(, 
·
)

139 
	`__f›ld
(
dma_addr_t
, 
dma
)

141 
	`TP_ç¡_assign
(

142 
__’Œy
->
ùxt
 = ctxt;

143 
__’Œy
->
subùxt
 = subctxt;

144 
__’Œy
->
¿¼
 =„arr;

145 
__’Œy
->
Åages
 =‚pages;

146 
__’Œy
->
va
 = va;

147 
__’Œy
->
·
 =…a;

148 
__’Œy
->
dma
 = dma;

150 
	`TP_´štk
("[%u:%u]ƒntry:%u, %u…ages @ 0x%lx, va:0x%lx dma:0x%llx",

151 
__’Œy
->
ùxt
,

152 
__’Œy
->
subùxt
,

153 
__’Œy
->
¿¼
,

154 
__’Œy
->
Åages
,

155 
__’Œy
->
·
,

156 
__’Œy
->
va
,

157 
__’Œy
->
dma


161 
	`DEFINE_EVENT
(

162 
hfi1_exp_tid_»g_uÄeg
, 
hfi1_exp_tid_uÄeg
,

163 
	`TP_PROTO
(
ùxt
, 
u16
 
subùxt
, 
u32
 
¿¼
, u32 
Åages
,

164 
va
, 
·
, 
dma_addr_t
 
dma
),

165 
	`TP_ARGS
(
ùxt
, 
subùxt
, 
¿¼
, 
Åages
, 
va
, 
·
, 
dma
)

168 
	`DEFINE_EVENT
(

169 
hfi1_exp_tid_»g_uÄeg
, 
hfi1_exp_tid_»g
,

170 
	`TP_PROTO
(
ùxt
, 
u16
 
subùxt
, 
u32
 
¿¼
, u32 
Åages
,

171 
va
, 
·
, 
dma_addr_t
 
dma
),

172 
	`TP_ARGS
(
ùxt
, 
subùxt
, 
¿¼
, 
Åages
, 
va
, 
·
, 
dma
)

175 
	`TRACE_EVENT
(

176 
hfi1_put_tid
,

177 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
,

178 
u32
 
šdex
, u32 
ty³
, 
·
, 
u16
 
Üd”
),

179 
	`TP_ARGS
(
dd
, 
šdex
, 
ty³
, 
·
, 
Üd”
),

180 
	`TP_STRUCT__’Œy
(

181 
	$DD_DEV_ENTRY
(
dd
)

182 
	`__f›ld
(, 
·
);

183 
	`__f›ld
(
u32
, 
šdex
);

184 
	`__f›ld
(
u32
, 
ty³
);

185 
	`__f›ld
(
u16
, 
Üd”
);

187 
	`TP_ç¡_assign
(

188 
	`DD_DEV_ASSIGN
(
dd
);

189 
__’Œy
->
·
 =…a;

190 
__’Œy
->
šdex
 = index;

191 
__’Œy
->
ty³
 =ype;

192 
__’Œy
->
Üd”
 = order;

194 
	`TP_´štk
("[%s]ype %s…a %lx index %u order %u",

195 
	`__g‘_¡r
(
dev
),

196 
	`show_tidty³
(
__’Œy
->
ty³
),

197 
__’Œy
->
·
,

198 
__’Œy
->
šdex
,

199 
__’Œy
->
Üd”


203 
	`TRACE_EVENT
(

204 
hfi1_exp_tid_šv®
,

205 
	`TP_PROTO
(
ùxt
, 
u16
 
subùxt
, 
va
, 
u32
 
¿¼
,

206 
u32
 
Åages
, 
dma_addr_t
 
dma
),

207 
	`TP_ARGS
(
ùxt
, 
subùxt
, 
va
, 
¿¼
, 
Åages
, 
dma
),

208 
	`TP_STRUCT__’Œy
(

209 
	$__f›ld
(, 
ùxt
)

210 
	$__f›ld
(
u16
, 
subùxt
)

211 
	$__f›ld
(, 
va
)

212 
	$__f›ld
(
u32
, 
¿¼
)

213 
	$__f›ld
(
u32
, 
Åages
)

214 
	`__f›ld
(
dma_addr_t
, 
dma
)

216 
	`TP_ç¡_assign
(

217 
__’Œy
->
ùxt
 = ctxt;

218 
__’Œy
->
subùxt
 = subctxt;

219 
__’Œy
->
va
 = va;

220 
__’Œy
->
¿¼
 =„arr;

221 
__’Œy
->
Åages
 =‚pages;

222 
__’Œy
->
dma
 = dma;

224 
	`TP_´štk
("[%u:%u]ƒntry:%u, %u…ages @ 0x%lx dma: 0x%llx",

225 
__’Œy
->
ùxt
,

226 
__’Œy
->
subùxt
,

227 
__’Œy
->
¿¼
,

228 
__’Œy
->
Åages
,

229 
__’Œy
->
va
,

230 
__’Œy
->
dma


234 
	`DECLARE_EVENT_CLASS
(

235 
hfi1_Ýâ_¡©e_‹m¶©e
,

236 
	`TP_PROTO
(
rvt_qp
 *
qp
),

237 
	`TP_ARGS
(
qp
),

238 
	`TP_STRUCT__’Œy
(

239 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

240 
	$__f›ld
(
u32
, 
q²
)

241 
	$__f›ld
(
u16
, 
»que¡ed
)

242 
	$__f›ld
(
u16
, 
com¶‘ed
)

243 
	`__f›ld
(
u8
, 
cu¼
)

245 
	`TP_ç¡_assign
(

246 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

248 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

249 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

250 
__’Œy
->
»que¡ed
 = 
´iv
->
Ýâ
.requested;

251 
__’Œy
->
com¶‘ed
 = 
´iv
->
Ýâ
.completed;

252 
__’Œy
->
cu¼
 = 
´iv
->
Ýâ
.curr;

254 
	`TP_´štk
(

256 
	`__g‘_¡r
(
dev
),

257 
__’Œy
->
q²
,

258 
__’Œy
->
»que¡ed
,

259 
__’Œy
->
com¶‘ed
,

260 
__’Œy
->
cu¼


264 
	`DEFINE_EVENT
(

265 
hfi1_Ýâ_¡©e_‹m¶©e
, 
hfi1_Ýâ_¡©e_cÚn_»que¡
,

266 
	`TP_PROTO
(
rvt_qp
 *
qp
),

267 
	`TP_ARGS
(
qp
)

270 
	`DEFINE_EVENT
(

271 
hfi1_Ýâ_¡©e_‹m¶©e
, 
hfi1_Ýâ_¡©e_sched_cÚn_»que¡
,

272 
	`TP_PROTO
(
rvt_qp
 *
qp
),

273 
	`TP_ARGS
(
qp
)

276 
	`DEFINE_EVENT
(

277 
hfi1_Ýâ_¡©e_‹m¶©e
, 
hfi1_Ýâ_¡©e_cÚn_»¥Ú£
,

278 
	`TP_PROTO
(
rvt_qp
 *
qp
),

279 
	`TP_ARGS
(
qp
)

282 
	`DEFINE_EVENT
(

283 
hfi1_Ýâ_¡©e_‹m¶©e
, 
hfi1_Ýâ_¡©e_cÚn_»¶y
,

284 
	`TP_PROTO
(
rvt_qp
 *
qp
),

285 
	`TP_ARGS
(
qp
)

288 
	`DEFINE_EVENT
(

289 
hfi1_Ýâ_¡©e_‹m¶©e
, 
hfi1_Ýâ_¡©e_cÚn_”rÜ
,

290 
	`TP_PROTO
(
rvt_qp
 *
qp
),

291 
	`TP_ARGS
(
qp
)

294 
	`DECLARE_EVENT_CLASS
(

295 
hfi1_Ýâ_d©a_‹m¶©e
,

296 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
ÿpcode
, 
u64
 
d©a
),

297 
	`TP_ARGS
(
qp
, 
ÿpcode
, 
d©a
),

298 
	`TP_STRUCT__’Œy
(

299 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

300 
	$__f›ld
(
u32
, 
q²
)

301 
	$__f›ld
(
u32
, 
¡©e
)

302 
	$__f›ld
(
u8
, 
ÿpcode
)

303 
	`__f›ld
(
u64
, 
d©a
)

305 
	`TP_ç¡_assign
(

306 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

307 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

308 
__’Œy
->
¡©e
 = 
qp
->state;

309 
__’Œy
->
ÿpcode
 = capcode;

310 
__’Œy
->
d©a
 = data;

312 
	`TP_´štk
(

314 
	`__g‘_¡r
(
dev
),

315 
__’Œy
->
q²
,

316 
__’Œy
->
¡©e
,

317 
__’Œy
->
ÿpcode
,

318 
__’Œy
->
d©a


322 
	`DEFINE_EVENT
(

323 
hfi1_Ýâ_d©a_‹m¶©e
, 
hfi1_Ýâ_d©a_cÚn_»que¡
,

324 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
ÿpcode
, 
u64
 
d©a
),

325 
	`TP_ARGS
(
qp
, 
ÿpcode
, 
d©a
)

328 
	`DEFINE_EVENT
(

329 
hfi1_Ýâ_d©a_‹m¶©e
, 
hfi1_Ýâ_d©a_cÚn_»¥Ú£
,

330 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
ÿpcode
, 
u64
 
d©a
),

331 
	`TP_ARGS
(
qp
, 
ÿpcode
, 
d©a
)

334 
	`DEFINE_EVENT
(

335 
hfi1_Ýâ_d©a_‹m¶©e
, 
hfi1_Ýâ_d©a_cÚn_»¶y
,

336 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
ÿpcode
, 
u64
 
d©a
),

337 
	`TP_ARGS
(
qp
, 
ÿpcode
, 
d©a
)

340 
	`DECLARE_EVENT_CLASS
(

341 
hfi1_Ýâ_·¿m_‹m¶©e
,

342 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
»mÙe
,

343 
tid_rdma_·¿ms
 *
·¿m
),

344 
	`TP_ARGS
(
qp
, 
»mÙe
, 
·¿m
),

345 
	`TP_STRUCT__’Œy
(

346 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

347 
	$__f›ld
(
u32
, 
q²
)

348 
	$__f›ld
(, 
»mÙe
)

349 
	$__f›ld
(
u32
, 
·¿m_qp
)

350 
	$__f›ld
(
u32
, 
max_Ën
)

351 
	$__f›ld
(
u16
, 
jkey
)

352 
	$__f›ld
(
u8
, 
max_»ad
)

353 
	$__f›ld
(
u8
, 
max_wr™e
)

354 
	$__f›ld
(
u8
, 
timeout
)

355 
	`__f›ld
(
u8
, 
urg
)

357 
	`TP_ç¡_assign
(

358 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

359 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

360 
__’Œy
->
»mÙe
 =„emote;

361 
__’Œy
->
·¿m_qp
 = 
·¿m
->
qp
;

362 
__’Œy
->
max_Ën
 = 
·¿m
->max_len;

363 
__’Œy
->
jkey
 = 
·¿m
->jkey;

364 
__’Œy
->
max_»ad
 = 
·¿m
->max_read;

365 
__’Œy
->
max_wr™e
 = 
·¿m
->max_write;

366 
__’Œy
->
timeout
 = 
·¿m
->timeout;

367 
__’Œy
->
urg
 = 
·¿m
->urg;

369 
	`TP_´štk
(

370 
OPFN_PARAM_PRN
,

371 
	`__g‘_¡r
(
dev
),

372 
__’Œy
->
q²
,

373 
__’Œy
->
»mÙe
 ? "remote" : "local",

374 
__’Œy
->
·¿m_qp
,

375 
__’Œy
->
max_»ad
,

376 
__’Œy
->
max_wr™e
,

377 
__’Œy
->
max_Ën
,

378 
__’Œy
->
jkey
,

379 
__’Œy
->
timeout
,

380 
__’Œy
->
urg


384 
	`DEFINE_EVENT
(

385 
hfi1_Ýâ_·¿m_‹m¶©e
, 
hfi1_Ýâ_·¿m
,

386 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
»mÙe
,

387 
tid_rdma_·¿ms
 *
·¿m
),

388 
	`TP_ARGS
(
qp
, 
»mÙe
, 
·¿m
)

391 
	`DECLARE_EVENT_CLASS
(

392 
hfi1_msg_‹m¶©e
,

393 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

394 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
),

395 
	`TP_STRUCT__’Œy
(

396 
	$__f›ld
(
u32
, 
q²
)

397 
	$__¡ršg
(
msg
, msg)

398 
	`__f›ld
(
u64
, 
mÜe
)

400 
	`TP_ç¡_assign
(

401 
__’Œy
->
q²
 = 
qp
 ? qp->
ibqp
.
qp_num
 : 0;

402 
	`__assign_¡r
(
msg
, msg);

403 
__’Œy
->
mÜe
 = more;

405 
	`TP_´štk
(

407 
__’Œy
->
q²
,

408 
	`__g‘_¡r
(
msg
),

409 
__’Œy
->
mÜe


413 
	`DEFINE_EVENT
(

414 
hfi1_msg_‹m¶©e
, 
hfi1_msg_Ýâ_cÚn_»que¡
,

415 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

416 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

419 
	`DEFINE_EVENT
(

420 
hfi1_msg_‹m¶©e
, 
hfi1_msg_Ýâ_cÚn_”rÜ
,

421 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

422 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

425 
	`DEFINE_EVENT
(

426 
hfi1_msg_‹m¶©e
, 
hfi1_msg_®loc_tids
,

427 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

428 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

431 
	`DEFINE_EVENT
(

432 
hfi1_msg_‹m¶©e
, 
hfi1_msg_tid_»¡¬t_»q
,

433 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

434 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

437 
	`DEFINE_EVENT
(

438 
hfi1_msg_‹m¶©e
, 
hfi1_msg_hªdË_kd‘h_eæags
,

439 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

440 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

443 
	`DEFINE_EVENT
(

444 
hfi1_msg_‹m¶©e
, 
hfi1_msg_tid_timeout
,

445 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

446 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

449 
	`DEFINE_EVENT
(

450 
hfi1_msg_‹m¶©e
, 
hfi1_msg_tid_»Œy_timeout
,

451 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u64
 
mÜe
),

452 
	`TP_ARGS
(
qp
, 
msg
, 
mÜe
)

455 
	`DECLARE_EVENT_CLASS
(

456 
hfi1_tid_æow_·ge_‹m¶©e
,

457 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
tid_rdma_æow
 *
æow
, 
u32
 
šdex
,

458 
mtu8k
, 
v1
, *
vaddr
),

459 
	`TP_ARGS
(
qp
, 
æow
, 
šdex
, 
mtu8k
, 
v1
, 
vaddr
),

460 
	`TP_STRUCT__’Œy
(

461 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

462 
	$__f›ld
(
u32
, 
q²
)

463 
	$__f›ld
(, 
mtu8k
)

464 
	$__f›ld
(, 
v1
)

465 
	$__f›ld
(
u32
, 
šdex
)

466 
	$__f›ld
(
u64
, 
·ge
)

467 
	`__f›ld
(
u64
, 
vaddr
)

469 
	`TP_ç¡_assign
(

470 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

471 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

472 
__’Œy
->
mtu8k
 = mtu8k;

473 
__’Œy
->
v1
 = v1;

474 
__’Œy
->
šdex
 = index;

475 
__’Œy
->
·ge
 = 
vaddr
 ? (
u64
)
	$vœt_to_·ge
(
vaddr
) : 0ULL;

476 
__’Œy
->
vaddr
 = (
u64
)vaddr;

478 
	`TP_´štk
(

480 
	`__g‘_¡r
(
dev
),

481 
__’Œy
->
q²
,

482 
__’Œy
->
šdex
,

483 
__’Œy
->
·ge
,

484 
__’Œy
->
mtu8k
 ? (__’Œy->
v1
 ? "v1" : "v0") : "vaddr",

485 
__’Œy
->
vaddr


489 
	`DEFINE_EVENT
(

490 
hfi1_tid_æow_·ge_‹m¶©e
, 
hfi1_tid_æow_·ge
,

491 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
tid_rdma_æow
 *
æow
, 
u32
 
šdex
,

492 
mtu8k
, 
v1
, *
vaddr
),

493 
	`TP_ARGS
(
qp
, 
æow
, 
šdex
, 
mtu8k
, 
v1
, 
vaddr
)

496 
	`DECLARE_EVENT_CLASS
(

497 
hfi1_tid_·ge£t_‹m¶©e
,

498 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
šdex
, 
u16
 
idx
, u16 
couÁ
),

499 
	`TP_ARGS
(
qp
, 
šdex
, 
idx
, 
couÁ
),

500 
	`TP_STRUCT__’Œy
(

501 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

502 
	$__f›ld
(
u32
, 
q²
)

503 
	$__f›ld
(
u32
, 
šdex
)

504 
	$__f›ld
(
u16
, 
idx
)

505 
	`__f›ld
(
u16
, 
couÁ
)

507 
	`TP_ç¡_assign
(

508 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

509 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

510 
__’Œy
->
šdex
 = index;

511 
__’Œy
->
idx
 = idx;

512 
__’Œy
->
couÁ
 = count;

514 
	`TP_´štk
(

516 
	`__g‘_¡r
(
dev
),

517 
__’Œy
->
q²
,

518 
__’Œy
->
šdex
,

519 
__’Œy
->
idx
,

520 
__’Œy
->
couÁ


524 
	`DEFINE_EVENT
(

525 
hfi1_tid_·ge£t_‹m¶©e
, 
hfi1_tid_·ge£t
,

526 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
šdex
, 
u16
 
idx
, u16 
couÁ
),

527 
	`TP_ARGS
(
qp
, 
šdex
, 
idx
, 
couÁ
)

530 
	`DECLARE_EVENT_CLASS
(

531 
hfi1_tid_æow_‹m¶©e
,

532 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

533 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
),

534 
	`TP_STRUCT__’Œy
(

535 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

536 
	$__f›ld
(
u32
, 
q²
)

537 
	$__f›ld
(, 
šdex
)

538 
	$__f›ld
(, 
idx
)

539 
	$__f›ld
(
u32
, 
»¥_ib_p¢
)

540 
	$__f›ld
(
u32
, 
g’”©iÚ
)

541 
	$__f›ld
(
u32
, 
f¥¢
)

542 
	$__f›ld
(
u32
, 
æp¢
)

543 
	$__f›ld
(
u32
, 
r_Ãxt_p¢
)

544 
	$__f›ld
(
u32
, 
ib_¥¢
)

545 
	$__f›ld
(
u32
, 
ib_Í¢
)

546 
	$__f›ld
(
u32
, 
Åage£ts
)

547 
	$__f›ld
(
u32
, 
Šode_út
)

548 
	$__f›ld
(
u32
, 
tidút
)

549 
	$__f›ld
(
u32
, 
tid_idx
)

550 
	$__f›ld
(
u32
, 
tid_off£t
)

551 
	$__f›ld
(
u32
, 
Ëngth
)

552 
	`__f›ld
(
u32
, 
£Á
)

554 
	`TP_ç¡_assign
(

555 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

556 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

557 
__’Œy
->
šdex
 = index;

558 
__’Œy
->
idx
 = 
æow
->idx;

559 
__’Œy
->
»¥_ib_p¢
 = 
æow
->
æow_¡©e
.resp_ib_psn;

560 
__’Œy
->
g’”©iÚ
 = 
æow
->
æow_¡©e
.generation;

561 
__’Œy
->
f¥¢
 = 
	`fuÎ_æow_p¢
(
æow
,

562 
æow
->
æow_¡©e
.
¥¢
);

563 
__’Œy
->
æp¢
 = 
	`fuÎ_æow_p¢
(
æow
,

564 
æow
->
æow_¡©e
.
Í¢
);

565 
__’Œy
->
r_Ãxt_p¢
 = 
æow
->
æow_¡©e
.r_next_psn;

566 
__’Œy
->
ib_¥¢
 = 
æow
->
æow_¡©e
.ib_spsn;

567 
__’Œy
->
ib_Í¢
 = 
æow
->
æow_¡©e
.ib_lpsn;

568 
__’Œy
->
Åage£ts
 = 
æow
->npagesets;

569 
__’Œy
->
Šode_út
 = 
æow
->tnode_cnt;

570 
__’Œy
->
tidút
 = 
æow
->tidcnt;

571 
__’Œy
->
tid_idx
 = 
æow
->tid_idx;

572 
__’Œy
->
tid_off£t
 = 
æow
->tid_offset;

573 
__’Œy
->
Ëngth
 = 
æow
->length;

574 
__’Œy
->
£Á
 = 
æow
->sent;

576 
	`TP_´štk
(

577 
TID_FLOW_PRN
,

578 
	`__g‘_¡r
(
dev
),

579 
__’Œy
->
q²
,

580 
__’Œy
->
šdex
,

581 
__’Œy
->
idx
,

582 
__’Œy
->
»¥_ib_p¢
,

583 
__’Œy
->
g’”©iÚ
,

584 
__’Œy
->
f¥¢
,

585 
__’Œy
->
æp¢
,

586 
__’Œy
->
r_Ãxt_p¢
,

587 
__’Œy
->
ib_¥¢
,

588 
__’Œy
->
ib_Í¢
,

589 
__’Œy
->
Åage£ts
,

590 
__’Œy
->
Šode_út
,

591 
__’Œy
->
tidút
,

592 
__’Œy
->
tid_idx
,

593 
__’Œy
->
tid_off£t
,

594 
__’Œy
->
Ëngth
,

595 
__’Œy
->
£Á


599 
	`DEFINE_EVENT
(

600 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_®loc
,

601 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

602 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

605 
	`DEFINE_EVENT
(

606 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_bužd_»ad_pkt
,

607 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

608 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

611 
	`DEFINE_EVENT
(

612 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_bužd_»ad_»¥
,

613 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

614 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

617 
	`DEFINE_EVENT
(

618 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_rcv_»ad_»q
,

619 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

620 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

623 
	`DEFINE_EVENT
(

624 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_rcv_»ad_»¥
,

625 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

626 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

629 
	`DEFINE_EVENT
(

630 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_»¡¬t_»q
,

631 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

632 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

635 
	`DEFINE_EVENT
(

636 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_bužd_wr™e_»¥
,

637 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

638 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

641 
	`DEFINE_EVENT
(

642 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_rcv_wr™e_»¥
,

643 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

644 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

647 
	`DEFINE_EVENT
(

648 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_bužd_wr™e_d©a
,

649 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

650 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

653 
	`DEFINE_EVENT
(

654 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_rcv_tid_ack
,

655 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

656 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

659 
	`DEFINE_EVENT
(

660 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_rcv_»sync
,

661 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

662 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

665 
	`DEFINE_EVENT
(

666 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_hªdË_kd‘h_eæags
,

667 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

668 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

671 
	`DEFINE_EVENT
(

672 
hfi1_tid_æow_‹m¶©e
, 
hfi1_tid_æow_»ad_kd‘h_eæags
,

673 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
tid_rdma_æow
 *
æow
),

674 
	`TP_ARGS
(
qp
, 
šdex
, 
æow
)

677 
	`DECLARE_EVENT_CLASS
(

678 
hfi1_tid_node_‹m¶©e
,

679 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u32
 
šdex
, u32 
ba£
,

680 
u8
 
m­
, u8 
u£d
, u8 
út
),

681 
	`TP_ARGS
(
qp
, 
msg
, 
šdex
, 
ba£
, 
m­
, 
u£d
, 
út
),

682 
	`TP_STRUCT__’Œy
(

683 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

684 
	$__f›ld
(
u32
, 
q²
)

685 
	$__¡ršg
(
msg
, msg)

686 
	$__f›ld
(
u32
, 
šdex
)

687 
	$__f›ld
(
u32
, 
ba£
)

688 
	$__f›ld
(
u8
, 
m­
)

689 
	$__f›ld
(
u8
, 
u£d
)

690 
	`__f›ld
(
u8
, 
út
)

692 
	`TP_ç¡_assign
(

693 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

694 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

695 
	`__assign_¡r
(
msg
, msg);

696 
__’Œy
->
šdex
 = index;

697 
__’Œy
->
ba£
 = base;

698 
__’Œy
->
m­
 = map;

699 
__’Œy
->
u£d
 = used;

700 
__’Œy
->
út
 = cnt;

702 
	`TP_´štk
(

703 
TID_NODE_PRN
,

704 
	`__g‘_¡r
(
dev
),

705 
__’Œy
->
q²
,

706 
	`__g‘_¡r
(
msg
),

707 
__’Œy
->
šdex
,

708 
__’Œy
->
ba£
,

709 
__’Œy
->
m­
,

710 
__’Œy
->
u£d
,

711 
__’Œy
->
út


715 
	`DEFINE_EVENT
(

716 
hfi1_tid_node_‹m¶©e
, 
hfi1_tid_node_add
,

717 
	`TP_PROTO
(
rvt_qp
 *
qp
, cÚ¡ *
msg
, 
u32
 
šdex
, u32 
ba£
,

718 
u8
 
m­
, u8 
u£d
, u8 
út
),

719 
	`TP_ARGS
(
qp
, 
msg
, 
šdex
, 
ba£
, 
m­
, 
u£d
, 
út
)

722 
	`DECLARE_EVENT_CLASS
(

723 
hfi1_tid_’Œy_‹m¶©e
,

724 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’t
),

725 
	`TP_ARGS
(
qp
, 
šdex
, 
’t
),

726 
	`TP_STRUCT__’Œy
(

727 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

728 
	$__f›ld
(
u32
, 
q²
)

729 
	$__f›ld
(, 
šdex
)

730 
	$__f›ld
(
u8
, 
ù¾
)

731 
	$__f›ld
(
u16
, 
idx
)

732 
	`__f›ld
(
u16
, 
Ën
)

734 
	`TP_ç¡_assign
(

735 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

736 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

737 
__’Œy
->
šdex
 = index;

738 
__’Œy
->
ù¾
 = 
	`hfi1_Œaû_g‘_tid_ù¾
(
’t
);

739 
__’Œy
->
idx
 = 
	`hfi1_Œaû_g‘_tid_idx
(
’t
);

740 
__’Œy
->
Ën
 = 
	`hfi1_Œaû_g‘_tid_Ën
(
’t
);

742 
	`TP_´štk
(

744 
	`__g‘_¡r
(
dev
),

745 
__’Œy
->
q²
,

746 
__’Œy
->
šdex
,

747 
__’Œy
->
idx
,

748 
__’Œy
->
Ën
,

749 
__’Œy
->
ù¾


753 
	`DEFINE_EVENT
(

754 
hfi1_tid_’Œy_‹m¶©e
, 
hfi1_tid_’Œy_®loc
,

755 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’Œy
),

756 
	`TP_ARGS
(
qp
, 
šdex
, 
’Œy
)

759 
	`DEFINE_EVENT
(

760 
hfi1_tid_’Œy_‹m¶©e
, 
hfi1_tid_’Œy_bužd_»ad_»¥
,

761 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’t
),

762 
	`TP_ARGS
(
qp
, 
šdex
, 
’t
)

765 
	`DEFINE_EVENT
(

766 
hfi1_tid_’Œy_‹m¶©e
, 
hfi1_tid_’Œy_rcv_»ad_»q
,

767 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’t
),

768 
	`TP_ARGS
(
qp
, 
šdex
, 
’t
)

771 
	`DEFINE_EVENT
(

772 
hfi1_tid_’Œy_‹m¶©e
, 
hfi1_tid_’Œy_rcv_wr™e_»¥
,

773 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’Œy
),

774 
	`TP_ARGS
(
qp
, 
šdex
, 
’Œy
)

777 
	`DEFINE_EVENT
(

778 
hfi1_tid_’Œy_‹m¶©e
, 
hfi1_tid_’Œy_bužd_wr™e_d©a
,

779 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
u32
 
’Œy
),

780 
	`TP_ARGS
(
qp
, 
šdex
, 
’Œy
)

783 
	`DECLARE_EVENT_CLASS
(

784 
hfi1_»¥Úd”_šfo_‹m¶©e
,

785 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

786 
	`TP_ARGS
(
qp
, 
p¢
),

787 
	`TP_STRUCT__’Œy
(

788 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

789 
	$__f›ld
(
u32
, 
q²
)

790 
	$__f›ld
(
u8
, 
¡©e
)

791 
	$__f›ld
(
u8
, 
s_¡©e
)

792 
	$__f›ld
(
u32
, 
p¢
)

793 
	$__f›ld
(
u32
, 
r_p¢
)

794 
	$__f›ld
(
u8
, 
r_¡©e
)

795 
	$__f›ld
(
u8
, 
r_æags
)

796 
	$__f›ld
(
u8
, 
r_h—d_ack_queue
)

797 
	$__f›ld
(
u8
, 
s_ž_ack_queue
)

798 
	$__f›ld
(
u8
, 
s_acked_ack_queue
)

799 
	$__f›ld
(
u8
, 
s_ack_¡©e
)

800 
	$__f›ld
(
u8
, 
s_Çk_¡©e
)

801 
	$__f›ld
(
u8
, 
r_Çk_¡©e
)

802 
	$__f›ld
(
u32
, 
s_æags
)

803 
	$__f›ld
(
u32
, 
ps_æags
)

804 
	`__f›ld
(, 
iow_æags
)

806 
	`TP_ç¡_assign
(

807 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

809 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

810 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

811 
__’Œy
->
¡©e
 = 
qp
->state;

812 
__’Œy
->
s_¡©e
 = 
qp
->s_state;

813 
__’Œy
->
p¢
 =…sn;

814 
__’Œy
->
r_p¢
 = 
qp
->r_psn;

815 
__’Œy
->
r_¡©e
 = 
qp
->r_state;

816 
__’Œy
->
r_æags
 = 
qp
->r_flags;

817 
__’Œy
->
r_h—d_ack_queue
 = 
qp
->r_head_ack_queue;

818 
__’Œy
->
s_ž_ack_queue
 = 
qp
->s_tail_ack_queue;

819 
__’Œy
->
s_acked_ack_queue
 = 
qp
->s_acked_ack_queue;

820 
__’Œy
->
s_ack_¡©e
 = 
qp
->s_ack_state;

821 
__’Œy
->
s_Çk_¡©e
 = 
qp
->s_nak_state;

822 
__’Œy
->
s_æags
 = 
qp
->s_flags;

823 
__’Œy
->
ps_æags
 = 
´iv
->
s_æags
;

824 
__’Œy
->
iow_æags
 = 
´iv
->
s_iowa™
.
æags
;

826 
	`TP_´štk
(

827 
RSP_INFO_PRN
,

828 
	`__g‘_¡r
(
dev
),

829 
__’Œy
->
q²
,

830 
__’Œy
->
¡©e
,

831 
__’Œy
->
s_¡©e
,

832 
__’Œy
->
p¢
,

833 
__’Œy
->
r_p¢
,

834 
__’Œy
->
r_¡©e
,

835 
__’Œy
->
r_æags
,

836 
__’Œy
->
r_h—d_ack_queue
,

837 
__’Œy
->
s_ž_ack_queue
,

838 
__’Œy
->
s_acked_ack_queue
,

839 
__’Œy
->
s_ack_¡©e
,

840 
__’Œy
->
s_Çk_¡©e
,

841 
__’Œy
->
s_æags
,

842 
__’Œy
->
ps_æags
,

843 
__’Œy
->
iow_æags


847 
	`DEFINE_EVENT
(

848 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_make_rc_ack
,

849 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

850 
	`TP_ARGS
(
qp
, 
p¢
)

853 
	`DEFINE_EVENT
(

854 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_rcv_tid_»ad_»q
,

855 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

856 
	`TP_ARGS
(
qp
, 
p¢
)

859 
	`DEFINE_EVENT
(

860 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_tid_rcv_”rÜ
,

861 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

862 
	`TP_ARGS
(
qp
, 
p¢
)

865 
	`DEFINE_EVENT
(

866 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_tid_wr™e_®loc_»s
,

867 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

868 
	`TP_ARGS
(
qp
, 
p¢
)

871 
	`DEFINE_EVENT
(

872 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_rcv_tid_wr™e_»q
,

873 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

874 
	`TP_ARGS
(
qp
, 
p¢
)

877 
	`DEFINE_EVENT
(

878 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_bužd_tid_wr™e_»¥
,

879 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

880 
	`TP_ARGS
(
qp
, 
p¢
)

883 
	`DEFINE_EVENT
(

884 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_rcv_tid_wr™e_d©a
,

885 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

886 
	`TP_ARGS
(
qp
, 
p¢
)

889 
	`DEFINE_EVENT
(

890 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_make_tid_ack
,

891 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

892 
	`TP_ARGS
(
qp
, 
p¢
)

895 
	`DEFINE_EVENT
(

896 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_hªdË_kd‘h_eæags
,

897 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

898 
	`TP_ARGS
(
qp
, 
p¢
)

901 
	`DEFINE_EVENT
(

902 
hfi1_»¥Úd”_šfo_‹m¶©e
, 
hfi1_r¥_»ad_kd‘h_eæags
,

903 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
p¢
),

904 
	`TP_ARGS
(
qp
, 
p¢
)

907 
	`DECLARE_EVENT_CLASS
(

908 
hfi1_£nd”_šfo_‹m¶©e
,

909 
	`TP_PROTO
(
rvt_qp
 *
qp
),

910 
	`TP_ARGS
(
qp
),

911 
	`TP_STRUCT__’Œy
(

912 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

913 
	$__f›ld
(
u32
, 
q²
)

914 
	$__f›ld
(
u8
, 
¡©e
)

915 
	$__f›ld
(
u32
, 
s_cur
)

916 
	$__f›ld
(
u32
, 
s_ž
)

917 
	$__f›ld
(
u32
, 
s_h—d
)

918 
	$__f›ld
(
u32
, 
s_acked
)

919 
	$__f›ld
(
u32
, 
s_Ï¡
)

920 
	$__f›ld
(
u32
, 
s_p¢
)

921 
	$__f›ld
(
u32
, 
s_Ï¡_p¢
)

922 
	$__f›ld
(
u32
, 
s_æags
)

923 
	$__f›ld
(
u32
, 
ps_æags
)

924 
	$__f›ld
(, 
iow_æags
)

925 
	$__f›ld
(
u8
, 
s_¡©e
)

926 
	$__f›ld
(
u8
, 
s_num_rd
)

927 
	`__f›ld
(
u8
, 
s_»Œy
)

929 
	`TP_ç¡_assign
(

930 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

931 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

932 
__’Œy
->
¡©e
 = 
qp
->state;

933 
__’Œy
->
s_cur
 = 
qp
->s_cur;

934 
__’Œy
->
s_ž
 = 
qp
->s_tail;

935 
__’Œy
->
s_h—d
 = 
qp
->s_head;

936 
__’Œy
->
s_acked
 = 
qp
->s_acked;

937 
__’Œy
->
s_Ï¡
 = 
qp
->s_last;

938 
__’Œy
->
s_p¢
 = 
qp
->s_psn;

939 
__’Œy
->
s_Ï¡_p¢
 = 
qp
->s_last_psn;

940 
__’Œy
->
s_æags
 = 
qp
->s_flags;

941 
__’Œy
->
ps_æags
 = ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_æags
;

942 
__’Œy
->
iow_æags
 =

943 ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_iowa™
.
æags
;

944 
__’Œy
->
s_¡©e
 = 
qp
->s_state;

945 
__’Œy
->
s_num_rd
 = 
qp
->
s_num_rd_©omic
;

946 
__’Œy
->
s_»Œy
 = 
qp
->s_retry;

948 
	`TP_´štk
(

949 
SENDER_INFO_PRN
,

950 
	`__g‘_¡r
(
dev
),

951 
__’Œy
->
q²
,

952 
__’Œy
->
¡©e
,

953 
__’Œy
->
s_cur
,

954 
__’Œy
->
s_ž
,

955 
__’Œy
->
s_h—d
,

956 
__’Œy
->
s_acked
,

957 
__’Œy
->
s_Ï¡
,

958 
__’Œy
->
s_p¢
,

959 
__’Œy
->
s_Ï¡_p¢
,

960 
__’Œy
->
s_æags
,

961 
__’Œy
->
ps_æags
,

962 
__’Œy
->
iow_æags
,

963 
__’Œy
->
s_¡©e
,

964 
__’Œy
->
s_num_rd
,

965 
__’Œy
->
s_»Œy


969 
	`DEFINE_EVENT
(

970 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_make_rc_»q
,

971 
	`TP_PROTO
(
rvt_qp
 *
qp
),

972 
	`TP_ARGS
(
qp
)

975 
	`DEFINE_EVENT
(

976 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_»£t_p¢
,

977 
	`TP_PROTO
(
rvt_qp
 *
qp
),

978 
	`TP_ARGS
(
qp
)

981 
	`DEFINE_EVENT
(

982 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_»¡¬t_rc
,

983 
	`TP_PROTO
(
rvt_qp
 *
qp
),

984 
	`TP_ARGS
(
qp
)

987 
	`DEFINE_EVENT
(

988 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_do_rc_ack
,

989 
	`TP_PROTO
(
rvt_qp
 *
qp
),

990 
	`TP_ARGS
(
qp
)

993 
	`DEFINE_EVENT
(

994 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_rcv_tid_»ad_»¥
,

995 
	`TP_PROTO
(
rvt_qp
 *
qp
),

996 
	`TP_ARGS
(
qp
)

999 
	`DEFINE_EVENT
(

1000 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_rcv_tid_ack
,

1001 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1002 
	`TP_ARGS
(
qp
)

1005 
	`DEFINE_EVENT
(

1006 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_make_tid_pkt
,

1007 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1008 
	`TP_ARGS
(
qp
)

1011 
	`DEFINE_EVENT
(

1012 
hfi1_£nd”_šfo_‹m¶©e
, 
hfi1_£nd”_»ad_kd‘h_eæags
,

1013 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1014 
	`TP_ARGS
(
qp
)

1017 
	`DECLARE_EVENT_CLASS
(

1018 
hfi1_tid_»ad_£nd”_‹m¶©e
,

1019 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1020 
	`TP_ARGS
(
qp
, 
Ãw»q
),

1021 
	`TP_STRUCT__’Œy
(

1022 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1023 
	$__f›ld
(
u32
, 
q²
)

1024 
	$__f›ld
(, 
Ãw»q
)

1025 
	$__f›ld
(
u32
, 
tid_r_»qs
)

1026 
	$__f›ld
(
u32
, 
tid_r_comp
)

1027 
	$__f›ld
(
u32
, 
³ndšg_tid_r_£gs
)

1028 
	$__f›ld
(
u32
, 
s_æags
)

1029 
	$__f›ld
(
u32
, 
ps_æags
)

1030 
	$__f›ld
(, 
iow_æags
)

1031 
	$__f›ld
(
u8
, 
s_¡©e
)

1032 
	$__f›ld
(
u32
, 
hw_æow_šdex
)

1033 
	$__f›ld
(
u32
, 
g’”©iÚ
)

1034 
	`__f›ld
(
u32
, 
å¢
)

1036 
	`TP_ç¡_assign
(

1037 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1039 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1040 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1041 
__’Œy
->
Ãw»q
 =‚ewreq;

1042 
__’Œy
->
tid_r_»qs
 = 
´iv
->tid_r_reqs;

1043 
__’Œy
->
tid_r_comp
 = 
´iv
->tid_r_comp;

1044 
__’Œy
->
³ndšg_tid_r_£gs
 = 
´iv
->pending_tid_r_segs;

1045 
__’Œy
->
s_æags
 = 
qp
->s_flags;

1046 
__’Œy
->
ps_æags
 = 
´iv
->
s_æags
;

1047 
__’Œy
->
iow_æags
 = 
´iv
->
s_iowa™
.
æags
;

1048 
__’Œy
->
s_¡©e
 = 
´iv
->s_state;

1049 
__’Œy
->
hw_æow_šdex
 = 
´iv
->
æow_¡©e
.
šdex
;

1050 
__’Œy
->
g’”©iÚ
 = 
´iv
->
æow_¡©e
.generation;

1051 
__’Œy
->
å¢
 = 
´iv
->
æow_¡©e
.
p¢
;

1053 
	`TP_´štk
(

1054 
TID_READ_SENDER_PRN
,

1055 
	`__g‘_¡r
(
dev
),

1056 
__’Œy
->
q²
,

1057 
__’Œy
->
Ãw»q
,

1058 
__’Œy
->
tid_r_»qs
,

1059 
__’Œy
->
tid_r_comp
,

1060 
__’Œy
->
³ndšg_tid_r_£gs
,

1061 
__’Œy
->
s_æags
,

1062 
__’Œy
->
ps_æags
,

1063 
__’Œy
->
iow_æags
,

1064 
__’Œy
->
s_¡©e
,

1065 
__’Œy
->
hw_æow_šdex
,

1066 
__’Œy
->
g’”©iÚ
,

1067 
__’Œy
->
å¢


1071 
	`DEFINE_EVENT
(

1072 
hfi1_tid_»ad_£nd”_‹m¶©e
, 
hfi1_tid_»ad_£nd”_make_»q
,

1073 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1074 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1077 
	`DEFINE_EVENT
(

1078 
hfi1_tid_»ad_£nd”_‹m¶©e
, 
hfi1_tid_»ad_£nd”_kd‘h_eæags
,

1079 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1080 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1083 
	`DECLARE_EVENT_CLASS
(

1084 
hfi1_tid_rdma_»que¡_‹m¶©e
,

1085 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1086 
tid_rdma_»que¡
 *
»q
),

1087 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
),

1088 
	`TP_STRUCT__’Œy
(

1089 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1090 
	$__f›ld
(
u32
, 
q²
)

1091 
	$__f›ld
(, 
Ãw»q
)

1092 
	$__f›ld
(
u8
, 
Ýcode
)

1093 
	$__f›ld
(
u32
, 
p¢
)

1094 
	$__f›ld
(
u32
, 
Í¢
)

1095 
	$__f›ld
(
u32
, 
cur_£g
)

1096 
	$__f›ld
(
u32
, 
comp_£g
)

1097 
	$__f›ld
(
u32
, 
ack_£g
)

1098 
	$__f›ld
(
u32
, 
®loc_£g
)

1099 
	$__f›ld
(
u32
, 
tÙ®_£gs
)

1100 
	$__f›ld
(
u16
, 
£tup_h—d
)

1101 
	$__f›ld
(
u16
, 
þ—r_ž
)

1102 
	$__f›ld
(
u16
, 
æow_idx
)

1103 
	$__f›ld
(
u16
, 
acked_ž
)

1104 
	$__f›ld
(
u32
, 
¡©e
)

1105 
	$__f›ld
(
u32
, 
r_ack_p¢
)

1106 
	$__f›ld
(
u32
, 
r_æow_p¢
)

1107 
	$__f›ld
(
u32
, 
r_Ï¡_acked
)

1108 
	`__f›ld
(
u32
, 
s_Ãxt_p¢
)

1110 
	`TP_ç¡_assign
(

1111 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1112 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1113 
__’Œy
->
Ãw»q
 =‚ewreq;

1114 
__’Œy
->
Ýcode
 = opcode;

1115 
__’Œy
->
p¢
 =…sn;

1116 
__’Œy
->
Í¢
 =†psn;

1117 
__’Œy
->
cur_£g
 = 
»q
->cur_seg;

1118 
__’Œy
->
comp_£g
 = 
»q
->comp_seg;

1119 
__’Œy
->
ack_£g
 = 
»q
->ack_seg;

1120 
__’Œy
->
®loc_£g
 = 
»q
->alloc_seg;

1121 
__’Œy
->
tÙ®_£gs
 = 
»q
->total_segs;

1122 
__’Œy
->
£tup_h—d
 = 
»q
->setup_head;

1123 
__’Œy
->
þ—r_ž
 = 
»q
->clear_tail;

1124 
__’Œy
->
æow_idx
 = 
»q
->flow_idx;

1125 
__’Œy
->
acked_ž
 = 
»q
->acked_tail;

1126 
__’Œy
->
¡©e
 = 
»q
->state;

1127 
__’Œy
->
r_ack_p¢
 = 
»q
->r_ack_psn;

1128 
__’Œy
->
r_æow_p¢
 = 
»q
->r_flow_psn;

1129 
__’Œy
->
r_Ï¡_acked
 = 
»q
->r_last_acked;

1130 
__’Œy
->
s_Ãxt_p¢
 = 
»q
->s_next_psn;

1132 
	`TP_´štk
(

1133 
TID_REQ_PRN
,

1134 
	`__g‘_¡r
(
dev
),

1135 
__’Œy
->
q²
,

1136 
__’Œy
->
Ãw»q
,

1137 
__’Œy
->
Ýcode
,

1138 
__’Œy
->
p¢
,

1139 
__’Œy
->
Í¢
,

1140 
__’Œy
->
cur_£g
,

1141 
__’Œy
->
comp_£g
,

1142 
__’Œy
->
ack_£g
,

1143 
__’Œy
->
®loc_£g
,

1144 
__’Œy
->
tÙ®_£gs
,

1145 
__’Œy
->
£tup_h—d
,

1146 
__’Œy
->
þ—r_ž
,

1147 
__’Œy
->
æow_idx
,

1148 
__’Œy
->
acked_ž
,

1149 
__’Œy
->
¡©e
,

1150 
__’Œy
->
r_ack_p¢
,

1151 
__’Œy
->
r_æow_p¢
,

1152 
__’Œy
->
r_Ï¡_acked
,

1153 
__’Œy
->
s_Ãxt_p¢


1157 
	`DEFINE_EVENT
(

1158 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_make_»q_»ad
,

1159 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1160 
tid_rdma_»que¡
 *
»q
),

1161 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1164 
	`DEFINE_EVENT
(

1165 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_bužd_»ad_»q
,

1166 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1167 
tid_rdma_»que¡
 *
»q
),

1168 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1171 
	`DEFINE_EVENT
(

1172 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_»ad_»q
,

1173 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1174 
tid_rdma_»que¡
 *
»q
),

1175 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1178 
	`DEFINE_EVENT
(

1179 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_»ad_»¥
,

1180 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1181 
tid_rdma_»que¡
 *
»q
),

1182 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1185 
	`DEFINE_EVENT
(

1186 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_”r
,

1187 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1188 
tid_rdma_»que¡
 *
»q
),

1189 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1192 
	`DEFINE_EVENT
(

1193 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_»¡¬t_»q
,

1194 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1195 
tid_rdma_»que¡
 *
»q
),

1196 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1199 
	`DEFINE_EVENT
(

1200 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_£tup_tid_wqe
,

1201 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1202 
tid_rdma_»que¡
 *
»q
),

1203 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1206 
	`DEFINE_EVENT
(

1207 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_wr™e_®loc_»s
,

1208 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1209 
tid_rdma_»que¡
 *
»q
),

1210 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1213 
	`DEFINE_EVENT
(

1214 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_wr™e_»q
,

1215 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1216 
tid_rdma_»que¡
 *
»q
),

1217 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1220 
	`DEFINE_EVENT
(

1221 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_bužd_wr™e_»¥
,

1222 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1223 
tid_rdma_»que¡
 *
»q
),

1224 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1227 
	`DEFINE_EVENT
(

1228 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_wr™e_»¥
,

1229 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1230 
tid_rdma_»que¡
 *
»q
),

1231 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1234 
	`DEFINE_EVENT
(

1235 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_wr™e_d©a
,

1236 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1237 
tid_rdma_»que¡
 *
»q
),

1238 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1241 
	`DEFINE_EVENT
(

1242 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_tid_ack
,

1243 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1244 
tid_rdma_»que¡
 *
»q
),

1245 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1248 
	`DEFINE_EVENT
(

1249 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_tid_»Œy_timeout
,

1250 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1251 
tid_rdma_»que¡
 *
»q
),

1252 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1255 
	`DEFINE_EVENT
(

1256 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_rcv_»sync
,

1257 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1258 
tid_rdma_»que¡
 *
»q
),

1259 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1262 
	`DEFINE_EVENT
(

1263 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_make_tid_pkt
,

1264 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1265 
tid_rdma_»que¡
 *
»q
),

1266 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1269 
	`DEFINE_EVENT
(

1270 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_make_tid_ack
,

1271 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1272 
tid_rdma_»que¡
 *
»q
),

1273 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1276 
	`DEFINE_EVENT
(

1277 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_hªdË_kd‘h_eæags
,

1278 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1279 
tid_rdma_»que¡
 *
»q
),

1280 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1283 
	`DEFINE_EVENT
(

1284 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_»ad_kd‘h_eæags
,

1285 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1286 
tid_rdma_»que¡
 *
»q
),

1287 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1290 
	`DEFINE_EVENT
(

1291 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_make_rc_ack_wr™e
,

1292 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1293 
tid_rdma_»que¡
 *
»q
),

1294 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1297 
	`DEFINE_EVENT
(

1298 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_make_»q_wr™e
,

1299 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1300 
tid_rdma_»que¡
 *
»q
),

1301 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1304 
	`DEFINE_EVENT
(

1305 
hfi1_tid_rdma_»que¡_‹m¶©e
, 
hfi1_tid_»q_upd©e_num_rd_©omic
,

1306 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
, 
u8
 
Ýcode
, 
u32
 
p¢
, u32 
Í¢
,

1307 
tid_rdma_»que¡
 *
»q
),

1308 
	`TP_ARGS
(
qp
, 
Ãw»q
, 
Ýcode
, 
p¢
, 
Í¢
, 
»q
)

1311 
	`DECLARE_EVENT_CLASS
(

1312 
hfi1_rc_rcv_”r_‹m¶©e
,

1313 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
Ýcode
, u32 
p¢
, 
diff
),

1314 
	`TP_ARGS
(
qp
, 
Ýcode
, 
p¢
, 
diff
),

1315 
	`TP_STRUCT__’Œy
(

1316 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1317 
	$__f›ld
(
u32
, 
q²
)

1318 
	$__f›ld
(
u32
, 
s_æags
)

1319 
	$__f›ld
(
u8
, 
¡©e
)

1320 
	$__f›ld
(
u8
, 
s_acked_ack_queue
)

1321 
	$__f›ld
(
u8
, 
s_ž_ack_queue
)

1322 
	$__f›ld
(
u8
, 
r_h—d_ack_queue
)

1323 
	$__f›ld
(
u32
, 
Ýcode
)

1324 
	$__f›ld
(
u32
, 
p¢
)

1325 
	$__f›ld
(
u32
, 
r_p¢
)

1326 
	`__f›ld
(, 
diff
)

1328 
	`TP_ç¡_assign
(

1329 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1330 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1331 
__’Œy
->
s_æags
 = 
qp
->s_flags;

1332 
__’Œy
->
¡©e
 = 
qp
->state;

1333 
__’Œy
->
s_acked_ack_queue
 = 
qp
->s_acked_ack_queue;

1334 
__’Œy
->
s_ž_ack_queue
 = 
qp
->s_tail_ack_queue;

1335 
__’Œy
->
r_h—d_ack_queue
 = 
qp
->r_head_ack_queue;

1336 
__’Œy
->
Ýcode
 = opcode;

1337 
__’Œy
->
p¢
 =…sn;

1338 
__’Œy
->
r_p¢
 = 
qp
->r_psn;

1339 
__’Œy
->
diff
 = diff;

1341 
	`TP_´štk
(

1342 
RCV_ERR_PRN
,

1343 
	`__g‘_¡r
(
dev
),

1344 
__’Œy
->
q²
,

1345 
__’Œy
->
s_æags
,

1346 
__’Œy
->
¡©e
,

1347 
__’Œy
->
s_acked_ack_queue
,

1348 
__’Œy
->
s_ž_ack_queue
,

1349 
__’Œy
->
r_h—d_ack_queue
,

1350 
__’Œy
->
Ýcode
,

1351 
__’Œy
->
p¢
,

1352 
__’Œy
->
r_p¢
,

1353 
__’Œy
->
diff


1357 
	`DEFINE_EVENT
(

1358 
hfi1_rc_rcv_”r_‹m¶©e
, 
hfi1_tid_rdma_rcv_”r
,

1359 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
Ýcode
, u32 
p¢
, 
diff
),

1360 
	`TP_ARGS
(
qp
, 
Ýcode
, 
p¢
, 
diff
)

1363 
	`DECLARE_EVENT_CLASS
(

1364 
hfi1_sge_‹m¶©e
,

1365 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
rvt_sge
 *
sge
),

1366 
	`TP_ARGS
(
qp
, 
šdex
, 
sge
),

1367 
	`TP_STRUCT__’Œy
(

1368 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1369 
	$__f›ld
(
u32
, 
q²
)

1370 
	$__f›ld
(, 
šdex
)

1371 
	$__f›ld
(
u64
, 
vaddr
)

1372 
	`__f›ld
(
u32
, 
sge_Ëngth
)

1374 
	`TP_ç¡_assign
(

1375 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1376 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1377 
__’Œy
->
šdex
 = index;

1378 
__’Œy
->
vaddr
 = (
u64
)
sge
->vaddr;

1379 
__’Œy
->
sge_Ëngth
 = 
sge
->sge_length;

1381 
	`TP_´štk
(

1383 
	`__g‘_¡r
(
dev
),

1384 
__’Œy
->
q²
,

1385 
__’Œy
->
šdex
,

1386 
__’Œy
->
vaddr
,

1387 
__’Œy
->
sge_Ëngth


1391 
	`DEFINE_EVENT
(

1392 
hfi1_sge_‹m¶©e
, 
hfi1_sge_check_®ign
,

1393 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
šdex
, 
rvt_sge
 *
sge
),

1394 
	`TP_ARGS
(
qp
, 
šdex
, 
sge
)

1397 
	`DECLARE_EVENT_CLASS
(

1398 
hfi1_tid_wr™e_r¥_‹m¶©e
,

1399 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1400 
	`TP_ARGS
(
qp
),

1401 
	`TP_STRUCT__’Œy
(

1402 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1403 
	$__f›ld
(
u32
, 
q²
)

1404 
	$__f›ld
(
u32
, 
r_tid_h—d
)

1405 
	$__f›ld
(
u32
, 
r_tid_ž
)

1406 
	$__f›ld
(
u32
, 
r_tid_ack
)

1407 
	$__f›ld
(
u32
, 
r_tid_®loc
)

1408 
	$__f›ld
(
u32
, 
®loc_w_£gs
)

1409 
	$__f›ld
(
u32
, 
³ndšg_tid_w_£gs
)

1410 
	$__f›ld
(
boÞ
, 
sync_±
)

1411 
	$__f›ld
(
u32
, 
ps_Çk_p¢
)

1412 
	$__f›ld
(
u8
, 
ps_Çk_¡©e
)

1413 
	$__f›ld
(
u8
, 
´Ä_Çk_¡©e
)

1414 
	$__f›ld
(
u32
, 
hw_æow_šdex
)

1415 
	$__f›ld
(
u32
, 
g’”©iÚ
)

1416 
	$__f›ld
(
u32
, 
å¢
)

1417 
	$__f›ld
(
boÞ
, 
»sync
)

1418 
	`__f›ld
(
u32
, 
r_Ãxt_p¢_kd‘h
)

1420 
	`TP_ç¡_assign
(

1421 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1423 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1424 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1425 
__’Œy
->
r_tid_h—d
 = 
´iv
->r_tid_head;

1426 
__’Œy
->
r_tid_ž
 = 
´iv
->r_tid_tail;

1427 
__’Œy
->
r_tid_ack
 = 
´iv
->r_tid_ack;

1428 
__’Œy
->
r_tid_®loc
 = 
´iv
->r_tid_alloc;

1429 
__’Œy
->
®loc_w_£gs
 = 
´iv
->alloc_w_segs;

1430 
__’Œy
->
³ndšg_tid_w_£gs
 = 
´iv
->pending_tid_w_segs;

1431 
__’Œy
->
sync_±
 = 
´iv
->sync_pt;

1432 
__’Œy
->
ps_Çk_p¢
 = 
´iv
->
s_Çk_p¢
;

1433 
__’Œy
->
ps_Çk_¡©e
 = 
´iv
->
s_Çk_¡©e
;

1434 
__’Œy
->
´Ä_Çk_¡©e
 = 
´iv
->
ºr_Çk_¡©e
;

1435 
__’Œy
->
hw_æow_šdex
 = 
´iv
->
æow_¡©e
.
šdex
;

1436 
__’Œy
->
g’”©iÚ
 = 
´iv
->
æow_¡©e
.generation;

1437 
__’Œy
->
å¢
 = 
´iv
->
æow_¡©e
.
p¢
;

1438 
__’Œy
->
»sync
 = 
´iv
->resync;

1439 
__’Œy
->
r_Ãxt_p¢_kd‘h
 = 
´iv
->r_next_psn_kdeth;

1441 
	`TP_´štk
(

1442 
TID_WRITE_RSPDR_PRN
,

1443 
	`__g‘_¡r
(
dev
),

1444 
__’Œy
->
q²
,

1445 
__’Œy
->
r_tid_h—d
,

1446 
__’Œy
->
r_tid_ž
,

1447 
__’Œy
->
r_tid_ack
,

1448 
__’Œy
->
r_tid_®loc
,

1449 
__’Œy
->
®loc_w_£gs
,

1450 
__’Œy
->
³ndšg_tid_w_£gs
,

1451 
__’Œy
->
sync_±
 ? "yes" : "no",

1452 
__’Œy
->
ps_Çk_p¢
,

1453 
__’Œy
->
ps_Çk_¡©e
,

1454 
__’Œy
->
´Ä_Çk_¡©e
,

1455 
__’Œy
->
hw_æow_šdex
,

1456 
__’Œy
->
g’”©iÚ
,

1457 
__’Œy
->
å¢
,

1458 
__’Œy
->
»sync
 ? "yes" : "no",

1459 
__’Œy
->
r_Ãxt_p¢_kd‘h


1463 
	`DEFINE_EVENT
(

1464 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_®loc_»s
,

1465 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1466 
	`TP_ARGS
(
qp
)

1469 
	`DEFINE_EVENT
(

1470 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_rcv_»q
,

1471 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1472 
	`TP_ARGS
(
qp
)

1475 
	`DEFINE_EVENT
(

1476 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_bužd_»¥
,

1477 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1478 
	`TP_ARGS
(
qp
)

1481 
	`DEFINE_EVENT
(

1482 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_rcv_d©a
,

1483 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1484 
	`TP_ARGS
(
qp
)

1487 
	`DEFINE_EVENT
(

1488 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_rcv_»sync
,

1489 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1490 
	`TP_ARGS
(
qp
)

1493 
	`DEFINE_EVENT
(

1494 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_make_tid_ack
,

1495 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1496 
	`TP_ARGS
(
qp
)

1499 
	`DEFINE_EVENT
(

1500 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_hªdË_kd‘h_eæags
,

1501 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1502 
	`TP_ARGS
(
qp
)

1505 
	`DEFINE_EVENT
(

1506 
hfi1_tid_wr™e_r¥_‹m¶©e
, 
hfi1_tid_wr™e_r¥_make_rc_ack
,

1507 
	`TP_PROTO
(
rvt_qp
 *
qp
),

1508 
	`TP_ARGS
(
qp
)

1511 
	`DECLARE_EVENT_CLASS
(

1512 
hfi1_tid_wr™e_£nd”_‹m¶©e
,

1513 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1514 
	`TP_ARGS
(
qp
, 
Ãw»q
),

1515 
	`TP_STRUCT__’Œy
(

1516 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1517 
	$__f›ld
(
u32
, 
q²
)

1518 
	$__f›ld
(, 
Ãw»q
)

1519 
	$__f›ld
(
u32
, 
s_tid_cur
)

1520 
	$__f›ld
(
u32
, 
s_tid_ž
)

1521 
	$__f›ld
(
u32
, 
s_tid_h—d
)

1522 
	$__f›ld
(
u32
, 
³ndšg_tid_w_»¥
)

1523 
	$__f›ld
(
u32
, 
n_»que¡s
)

1524 
	$__f›ld
(
u32
, 
n_tid_»que¡s
)

1525 
	$__f›ld
(
u32
, 
s_æags
)

1526 
	$__f›ld
(
u32
, 
ps_æags
)

1527 
	$__f›ld
(, 
iow_æags
)

1528 
	$__f›ld
(
u8
, 
s_¡©e
)

1529 
	`__f›ld
(
u8
, 
s_»Œy
)

1531 
	`TP_ç¡_assign
(

1532 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1534 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1535 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1536 
__’Œy
->
Ãw»q
 =‚ewreq;

1537 
__’Œy
->
s_tid_cur
 = 
´iv
->s_tid_cur;

1538 
__’Œy
->
s_tid_ž
 = 
´iv
->s_tid_tail;

1539 
__’Œy
->
s_tid_h—d
 = 
´iv
->s_tid_head;

1540 
__’Œy
->
³ndšg_tid_w_»¥
 = 
´iv
->pending_tid_w_resp;

1541 
__’Œy
->
n_»que¡s
 = 
	`©omic_»ad
(&
´iv
->n_requests);

1542 
__’Œy
->
n_tid_»que¡s
 = 
	`©omic_»ad
(&
´iv
->n_tid_requests);

1543 
__’Œy
->
s_æags
 = 
qp
->s_flags;

1544 
__’Œy
->
ps_æags
 = 
´iv
->
s_æags
;

1545 
__’Œy
->
iow_æags
 = 
´iv
->
s_iowa™
.
æags
;

1546 
__’Œy
->
s_¡©e
 = 
´iv
->s_state;

1547 
__’Œy
->
s_»Œy
 = 
´iv
->s_retry;

1549 
	`TP_´štk
(

1550 
TID_WRITE_SENDER_PRN
,

1551 
	`__g‘_¡r
(
dev
),

1552 
__’Œy
->
q²
,

1553 
__’Œy
->
Ãw»q
,

1554 
__’Œy
->
s_tid_cur
,

1555 
__’Œy
->
s_tid_ž
,

1556 
__’Œy
->
s_tid_h—d
,

1557 
__’Œy
->
³ndšg_tid_w_»¥
,

1558 
__’Œy
->
n_»que¡s
,

1559 
__’Œy
->
n_tid_»que¡s
,

1560 
__’Œy
->
s_æags
,

1561 
__’Œy
->
ps_æags
,

1562 
__’Œy
->
iow_æags
,

1563 
__’Œy
->
s_¡©e
,

1564 
__’Œy
->
s_»Œy


1568 
	`DEFINE_EVENT
(

1569 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_rcv_»¥
,

1570 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1571 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1574 
	`DEFINE_EVENT
(

1575 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_rcv_tid_ack
,

1576 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1577 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1580 
	`DEFINE_EVENT
(

1581 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_»Œy_timeout
,

1582 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1583 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1586 
	`DEFINE_EVENT
(

1587 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_make_tid_pkt
,

1588 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1589 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1592 
	`DEFINE_EVENT
(

1593 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_make_»q
,

1594 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1595 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1598 
	`DEFINE_EVENT
(

1599 
hfi1_tid_wr™e_£nd”_‹m¶©e
, 
hfi1_tid_wr™e_£nd”_»¡¬t_rc
,

1600 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
Ãw»q
),

1601 
	`TP_ARGS
(
qp
, 
Ãw»q
)

1604 
	`DECLARE_EVENT_CLASS
(

1605 
hfi1_tid_ack_‹m¶©e
,

1606 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
,

1607 
u32
 
»q_p¢
, u32 
»sync_p¢
),

1608 
	`TP_ARGS
(
qp
, 
«th
, 
p¢
, 
»q_p¢
, 
»sync_p¢
),

1609 
	`TP_STRUCT__’Œy
(

1610 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1611 
	$__f›ld
(
u32
, 
q²
)

1612 
	$__f›ld
(
u32
, 
«th
)

1613 
	$__f›ld
(
u32
, 
p¢
)

1614 
	$__f›ld
(
u32
, 
»q_p¢
)

1615 
	`__f›ld
(
u32
, 
»sync_p¢
)

1617 
	`TP_ç¡_assign
(

1618 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1619 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1620 
__’Œy
->
«th
 =‡eth;

1621 
__’Œy
->
p¢
 =…sn;

1622 
__’Œy
->
»q_p¢
 =„eq_psn;

1623 
__’Œy
->
»sync_p¢
 =„esync_psn;

1625 
	`TP_´štk
(

1627 
	`__g‘_¡r
(
dev
),

1628 
__’Œy
->
q²
,

1629 
__’Œy
->
«th
,

1630 
__’Œy
->
p¢
,

1631 
__’Œy
->
»q_p¢
,

1632 
__’Œy
->
»sync_p¢


1636 
	`DEFINE_EVENT
(

1637 
hfi1_tid_ack_‹m¶©e
, 
hfi1_rcv_tid_ack
,

1638 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
«th
, u32 
p¢
,

1639 
u32
 
»q_p¢
, u32 
»sync_p¢
),

1640 
	`TP_ARGS
(
qp
, 
«th
, 
p¢
, 
»q_p¢
, 
»sync_p¢
)

1643 
	`DECLARE_EVENT_CLASS
(

1644 
hfi1_kd‘h_eæags_”rÜ_‹m¶©e
,

1645 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
rcv_ty³
, u8 
¹e
, 
u32
 
p¢
),

1646 
	`TP_ARGS
(
qp
, 
rcv_ty³
, 
¹e
, 
p¢
),

1647 
	`TP_STRUCT__’Œy
(

1648 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

1649 
	$__f›ld
(
u32
, 
q²
)

1650 
	$__f›ld
(
u8
, 
rcv_ty³
)

1651 
	$__f›ld
(
u8
, 
¹e
)

1652 
	`__f›ld
(
u32
, 
p¢
)

1654 
	`TP_ç¡_assign
(

1655 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
));

1656 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

1657 
__’Œy
->
rcv_ty³
 =„cv_type;

1658 
__’Œy
->
¹e
 =„te;

1659 
__’Œy
->
p¢
 =…sn;

1661 
	`TP_´štk
(

1662 
KDETH_EFLAGS_ERR_PRN
,

1663 
	`__g‘_¡r
(
dev
),

1664 
__’Œy
->
q²
,

1665 
__’Œy
->
rcv_ty³
,

1666 
__’Œy
->
¹e
,

1667 
__’Œy
->
p¢


1671 
	`DEFINE_EVENT
(

1672 
hfi1_kd‘h_eæags_”rÜ_‹m¶©e
, 
hfi1_eæags_”r_wr™e
,

1673 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u8
 
rcv_ty³
, u8 
¹e
, 
u32
 
p¢
),

1674 
	`TP_ARGS
(
qp
, 
rcv_ty³
, 
¹e
, 
p¢
)

1679 #undeà
TRACE_INCLUDE_PATH


1680 #undeà
TRACE_INCLUDE_FILE


1681 
	#TRACE_INCLUDE_PATH
 .

	)

1682 
	#TRACE_INCLUDE_FILE
 
Œaû_tid


	)

1683 
	~<Œaû/defše_Œaû.h
>

	@trace_tx.h

47 #ià!
defšed
(
__HFI1_TRACE_TX_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

48 
	#__HFI1_TRACE_TX_H


	)

50 
	~<lšux/Œaûpošt.h
>

51 
	~<lšux/Œaû_£q.h
>

53 
	~"hfi.h
"

54 
	~"mad.h
"

55 
	~"sdma.h
"

56 
	~"oib.h
"

58 cÚ¡ *
·r£_sdma_æags
(
Œaû_£q
 *
p
, 
u64
 
desc0
, u64 
desc1
);

60 
	#__·r£_sdma_æags
(
desc0
, 
desc1
è
	`·r£_sdma_æags
(
p
, desc0, desc1)

	)

62 #undeà
TRACE_SYSTEM


63 
	#TRACE_SYSTEM
 
hfi1_tx


	)

65 
TRACE_EVENT
(
hfi1_pioä“
,

66 
TP_PROTO
(
£nd_cÚ‹xt
 *
sc
, 
exŒa
),

67 
TP_ARGS
(
sc
, 
exŒa
),

68 
TP_STRUCT__’Œy
(
DD_DEV_ENTRY
(
sc
->
dd
)

69 
	$__f›ld
(
u32
, 
sw_šdex
)

70 
	$__f›ld
(
u32
, 
hw_cÚ‹xt
)

71 
	`__f›ld
(, 
exŒa
)

73 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sc
->
dd
);

74 
__’Œy
->
sw_šdex
 = 
sc
->sw_index;

75 
__’Œy
->
hw_cÚ‹xt
 = 
sc
->hw_context;

76 
__’Œy
->
exŒa
 =ƒxtra;

78 
	`TP_´štk
("[%s] ctxt %u(%u)ƒxtra %d",

79 
	`__g‘_¡r
(
dev
),

80 
__’Œy
->
sw_šdex
,

81 
__’Œy
->
hw_cÚ‹xt
,

82 
__’Œy
->
exŒa


86 
	`TRACE_EVENT
(
hfi1_wªiošŒ
,

87 
	`TP_PROTO
(
£nd_cÚ‹xt
 *
sc
, 
u32
 
Ãedšt
, 
u64
 
üed™_ù¾
),

88 
	`TP_ARGS
(
sc
, 
Ãedšt
, 
üed™_ù¾
),

89 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sc
->
dd
)

90 
	$__f›ld
(
u32
, 
sw_šdex
)

91 
	$__f›ld
(
u32
, 
hw_cÚ‹xt
)

92 
	$__f›ld
(
u32
, 
Ãedšt
)

93 
	`__f›ld
(
u64
, 
üed™_ù¾
)

95 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sc
->
dd
);

96 
__’Œy
->
sw_šdex
 = 
sc
->sw_index;

97 
__’Œy
->
hw_cÚ‹xt
 = 
sc
->hw_context;

98 
__’Œy
->
Ãedšt
 =‚eedint;

99 
__’Œy
->
üed™_ù¾
 = credit_ctrl;

101 
	`TP_´štk
("[%s] ctxt %u(%u) on %d credit_ctrl 0x%llx",

102 
	`__g‘_¡r
(
dev
),

103 
__’Œy
->
sw_šdex
,

104 
__’Œy
->
hw_cÚ‹xt
,

105 
__’Œy
->
Ãedšt
,

106 ()
__’Œy
->
üed™_ù¾


110 
	`DECLARE_EVENT_CLASS
(
hfi1_qp¦“pwakeup_‹m¶©e
,

111 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
æags
),

112 
	`TP_ARGS
(
qp
, 
æags
),

113 
	`TP_STRUCT__’Œy
(

114 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

115 
	$__f›ld
(, 
iow_æags
)

116 
	$__f›ld
(
u32
, 
q²
)

117 
	$__f›ld
(
u32
, 
æags
)

118 
	$__f›ld
(
u32
, 
s_æags
)

119 
	`__f›ld
(
u32
, 
ps_æags
)

121 
	`TP_ç¡_assign
(

122 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

123 
__’Œy
->
æags
 = flags;

124 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

125 
__’Œy
->
s_æags
 = 
qp
->s_flags;

126 
__’Œy
->
ps_æags
 =

127 ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_æags
;

128 
__’Œy
->
iow_æags
 =

129 ((
hfi1_qp_´iv
 *)
qp
->
´iv
)->
s_iowa™
.
æags
;

131 
	`TP_´štk
(

133 
	`__g‘_¡r
(
dev
),

134 
__’Œy
->
q²
,

135 
__’Œy
->
æags
,

136 
__’Œy
->
s_æags
,

137 
__’Œy
->
ps_æags
,

138 
__’Œy
->
iow_æags


142 
	`DEFINE_EVENT
(
hfi1_qp¦“pwakeup_‹m¶©e
, 
hfi1_qpwakeup
,

143 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
æags
),

144 
	`TP_ARGS
(
qp
, 
æags
));

146 
	`DEFINE_EVENT
(
hfi1_qp¦“pwakeup_‹m¶©e
, 
hfi1_qp¦“p
,

147 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
u32
 
æags
),

148 
	`TP_ARGS
(
qp
, 
æags
));

150 
	`TRACE_EVENT
(
hfi1_sdma_desütÜ
,

151 
	`TP_PROTO
(
sdma_’gše
 *
sde
,

152 
u64
 
desc0
,

153 
u64
 
desc1
,

154 
u16
 
e
,

155 *
desý
),

156 
	`TP_ARGS
(
sde
, 
desc0
, 
desc1
, 
e
, 
desý
),

157 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

158 
	$__f›ld
(*, 
desý
)

159 
	$__f›ld
(
u64
, 
desc0
)

160 
	$__f›ld
(
u64
, 
desc1
)

161 
	$__f›ld
(
u16
, 
e
)

162 
	`__f›ld
(
u8
, 
idx
)

164 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

165 
__’Œy
->
desc0
 = desc0;

166 
__’Œy
->
desc1
 = desc1;

167 
__’Œy
->
idx
 = 
sde
->
this_idx
;

168 
__’Œy
->
desý
 = descp;

169 
__’Œy
->
e
 =ƒ;

171 
	`TP_´štk
(

173 
	`__g‘_¡r
(
dev
),

174 
__’Œy
->
idx
,

175 
	`__·r£_sdma_æags
(
__’Œy
->
desc0
, __’Œy->
desc1
),

176 (
__’Œy
->
desc0
 >> 
SDMA_DESC0_PHY_ADDR_SHIFT
) &

177 
SDMA_DESC0_PHY_ADDR_MASK
,

178 (
u8
)((
__’Œy
->
desc1
 >> 
SDMA_DESC1_GENERATION_SHIFT
) &

179 
SDMA_DESC1_GENERATION_MASK
),

180 (
u16
)((
__’Œy
->
desc0
 >> 
SDMA_DESC0_BYTE_COUNT_SHIFT
) &

181 
SDMA_DESC0_BYTE_COUNT_MASK
),

182 
__’Œy
->
desc0
,

183 
__’Œy
->
desc1
,

184 
__’Œy
->
desý
,

185 
__’Œy
->
e


189 
	`TRACE_EVENT
(
hfi1_sdma_’gše_£Ëù
,

190 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u32
 
£l
, 
u8
 
vl
, u8 
idx
),

191 
	`TP_ARGS
(
dd
, 
£l
, 
vl
, 
idx
),

192 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

193 
	$__f›ld
(
u32
, 
£l
)

194 
	$__f›ld
(
u8
, 
vl
)

195 
	`__f›ld
(
u8
, 
idx
)

197 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

198 
__’Œy
->
£l
 = sel;

199 
__’Œy
->
vl
 = vl;

200 
__’Œy
->
idx
 = idx;

202 
	`TP_´štk
("[%s] selecting SDE %u sel 0x%x vl %u",

203 
	`__g‘_¡r
(
dev
),

204 
__’Œy
->
idx
,

205 
__’Œy
->
£l
,

206 
__’Œy
->
vl


210 
	`TRACE_EVENT
(
hfi1_sdma_u£r_ä“_queues
,

211 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
),

212 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
),

213 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

214 
	$__f›ld
(
u16
, 
ùxt
)

215 
	`__f›ld
(
u16
, 
subùxt
)

217 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

218 
__’Œy
->
ùxt
 = ctxt;

219 
__’Œy
->
subùxt
 = subctxt;

221 
	`TP_´štk
("[%s] SDMA [%u:%u] Freeing user SDMA queues",

222 
	`__g‘_¡r
(
dev
),

223 
__’Œy
->
ùxt
,

224 
__’Œy
->
subùxt


228 
	`TRACE_EVENT
(
hfi1_sdma_u£r_´oûss_»que¡
,

229 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

230 
u16
 
comp_idx
),

231 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
),

232 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

233 
	$__f›ld
(
u16
, 
ùxt
)

234 
	$__f›ld
(
u16
, 
subùxt
)

235 
	`__f›ld
(
u16
, 
comp_idx
)

237 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

238 
__’Œy
->
ùxt
 = ctxt;

239 
__’Œy
->
subùxt
 = subctxt;

240 
__’Œy
->
comp_idx
 = comp_idx;

242 
	`TP_´štk
("[%s] SDMA [%u:%u] Using„eq/compƒntry: %u",

243 
	`__g‘_¡r
(
dev
),

244 
__’Œy
->
ùxt
,

245 
__’Œy
->
subùxt
,

246 
__’Œy
->
comp_idx


250 
	`DECLARE_EVENT_CLASS
(

251 
hfi1_sdma_v®ue_‹m¶©e
,

252 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
, u16 
comp_idx
,

253 
u32
 
v®ue
),

254 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
, 
v®ue
),

255 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

256 
	$__f›ld
(
u16
, 
ùxt
)

257 
	$__f›ld
(
u16
, 
subùxt
)

258 
	$__f›ld
(
u16
, 
comp_idx
)

259 
	`__f›ld
(
u32
, 
v®ue
)

261 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

262 
__’Œy
->
ùxt
 = ctxt;

263 
__’Œy
->
subùxt
 = subctxt;

264 
__’Œy
->
comp_idx
 = comp_idx;

265 
__’Œy
->
v®ue
 = value;

267 
	`TP_´štk
("[%s] SDMA [%u:%u:%u] value: %u",

268 
	`__g‘_¡r
(
dev
),

269 
__’Œy
->
ùxt
,

270 
__’Œy
->
subùxt
,

271 
__’Œy
->
comp_idx
,

272 
__’Œy
->
v®ue


276 
	`DEFINE_EVENT
(
hfi1_sdma_v®ue_‹m¶©e
, 
hfi1_sdma_u£r_š™Ÿl_tidoff£t
,

277 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

278 
u16
 
comp_idx
, 
u32
 
tidoff£t
),

279 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
, 
tidoff£t
));

281 
	`DEFINE_EVENT
(
hfi1_sdma_v®ue_‹m¶©e
, 
hfi1_sdma_u£r_d©a_Ëngth
,

282 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

283 
u16
 
comp_idx
, 
u32
 
d©a_Ën
),

284 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
, 
d©a_Ën
));

286 
	`DEFINE_EVENT
(
hfi1_sdma_v®ue_‹m¶©e
, 
hfi1_sdma_u£r_compu‹_Ëngth
,

287 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

288 
u16
 
comp_idx
, 
u32
 
d©a_Ën
),

289 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
, 
d©a_Ën
));

291 
	`TRACE_EVENT
(
hfi1_sdma_u£r_tid_šfo
,

292 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

293 
u16
 
comp_idx
, 
u32
 
tidoff£t
, u32 
un™s
, 
u8
 
shiá
),

294 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
comp_idx
, 
tidoff£t
, 
un™s
, 
shiá
),

295 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

296 
	$__f›ld
(
u16
, 
ùxt
)

297 
	$__f›ld
(
u16
, 
subùxt
)

298 
	$__f›ld
(
u16
, 
comp_idx
)

299 
	$__f›ld
(
u32
, 
tidoff£t
)

300 
	$__f›ld
(
u32
, 
un™s
)

301 
	`__f›ld
(
u8
, 
shiá
)

303 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

304 
__’Œy
->
ùxt
 = ctxt;

305 
__’Œy
->
subùxt
 = subctxt;

306 
__’Œy
->
comp_idx
 = comp_idx;

307 
__’Œy
->
tidoff£t
 =idoffset;

308 
__’Œy
->
un™s
 = units;

309 
__’Œy
->
shiá
 = shift;

311 
	`TP_´štk
("[%s] SDMA [%u:%u:%u] TID offset %ubytes %uunits om %u",

312 
	`__g‘_¡r
(
dev
),

313 
__’Œy
->
ùxt
,

314 
__’Œy
->
subùxt
,

315 
__’Œy
->
comp_idx
,

316 
__’Œy
->
tidoff£t
,

317 
__’Œy
->
un™s
,

318 
__’Œy
->
shiá


322 
	`TRACE_EVENT
(
hfi1_sdma_»que¡
,

323 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, u16 
subùxt
,

324 
dim
),

325 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
dim
),

326 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

327 
	$__f›ld
(
u16
, 
ùxt
)

328 
	$__f›ld
(
u16
, 
subùxt
)

329 
	`__f›ld
(, 
dim
)

331 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

332 
__’Œy
->
ùxt
 = ctxt;

333 
__’Œy
->
subùxt
 = subctxt;

334 
__’Œy
->
dim
 = dim;

336 
	`TP_´štk
("[%s] SDMA from %u:%u (%lu)",

337 
	`__g‘_¡r
(
dev
),

338 
__’Œy
->
ùxt
,

339 
__’Œy
->
subùxt
,

340 
__’Œy
->
dim


344 
	`DECLARE_EVENT_CLASS
(
hfi1_sdma_’gše_þass
,

345 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
),

346 
	`TP_ARGS
(
sde
, 
¡©us
),

347 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

348 
	$__f›ld
(
u64
, 
¡©us
)

349 
	`__f›ld
(
u8
, 
idx
)

351 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

352 
__’Œy
->
¡©us
 = status;

353 
__’Œy
->
idx
 = 
sde
->
this_idx
;

355 
	`TP_´štk
("[%s] SDE(%u) status %llx",

356 
	`__g‘_¡r
(
dev
),

357 
__’Œy
->
idx
,

358 ()
__’Œy
->
¡©us


362 
	`DEFINE_EVENT
(
hfi1_sdma_’gše_þass
, 
hfi1_sdma_’gše_š‹¼u±
,

363 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
),

364 
	`TP_ARGS
(
sde
, 
¡©us
)

367 
	`DEFINE_EVENT
(
hfi1_sdma_’gše_þass
, 
hfi1_sdma_’gše_´og»ss
,

368 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
u64
 
¡©us
),

369 
	`TP_ARGS
(
sde
, 
¡©us
)

372 
	`DECLARE_EVENT_CLASS
(
hfi1_sdma_ahg_ad
,

373 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
aidx
),

374 
	`TP_ARGS
(
sde
, 
aidx
),

375 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

376 
	$__f›ld
(, 
aidx
)

377 
	`__f›ld
(
u8
, 
idx
)

379 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

380 
__’Œy
->
idx
 = 
sde
->
this_idx
;

381 
__’Œy
->
aidx
 =‡idx;

383 
	`TP_´štk
("[%s] SDE(%u)‡idx %d",

384 
	`__g‘_¡r
(
dev
),

385 
__’Œy
->
idx
,

386 
__’Œy
->
aidx


390 
	`DEFINE_EVENT
(
hfi1_sdma_ahg_ad
, 
hfi1_ahg_®loÿ‹
,

391 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
aidx
),

392 
	`TP_ARGS
(
sde
, 
aidx
));

394 
	`DEFINE_EVENT
(
hfi1_sdma_ahg_ad
, 
hfi1_ahg_d—Îoÿ‹
,

395 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
aidx
),

396 
	`TP_ARGS
(
sde
, 
aidx
));

398 #ifdeà
CONFIG_HFI1_DEBUG_SDMA_ORDER


399 
	`TRACE_EVENT
(
hfi1_sdma_´og»ss
,

400 
	`TP_PROTO
(
sdma_’gše
 *
sde
,

401 
u16
 
hwh—d
,

402 
u16
 
swh—d
,

403 
sdma_tx»q
 *
txp


405 
	`TP_ARGS
(
sde
, 
hwh—d
, 
swh—d
, 
txp
),

406 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

407 
	$__f›ld
(
u64
, 
¢
)

408 
	$__f›ld
(
u16
, 
hwh—d
)

409 
	$__f›ld
(
u16
, 
swh—d
)

410 
	$__f›ld
(
u16
, 
txÃxt
)

411 
	$__f›ld
(
u16
, 
tx_ž
)

412 
	$__f›ld
(
u16
, 
tx_h—d
)

413 
	`__f›ld
(
u8
, 
idx
)

415 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

416 
__’Œy
->
hwh—d
 = hwhead;

417 
__’Œy
->
swh—d
 = swhead;

418 
__’Œy
->
tx_ž
 = 
sde
->tx_tail;

419 
__’Œy
->
tx_h—d
 = 
sde
->tx_head;

420 
__’Œy
->
txÃxt
 = 
txp
 ?xp->
Ãxt_descq_idx
 : ~0;

421 
__’Œy
->
idx
 = 
sde
->
this_idx
;

422 
__’Œy
->
¢
 = 
txp
 ?xp->sn : ~0;

424 
	`TP_´štk
(

426 
	`__g‘_¡r
(
dev
),

427 
__’Œy
->
idx
,

428 
__’Œy
->
¢
,

429 
__’Œy
->
hwh—d
,

430 
__’Œy
->
swh—d
,

431 
__’Œy
->
txÃxt
,

432 
__’Œy
->
tx_h—d
,

433 
__’Œy
->
tx_ž


437 
	`TRACE_EVENT
(
hfi1_sdma_´og»ss
,

438 
	`TP_PROTO
(
sdma_’gše
 *
sde
,

439 
u16
 
hwh—d
, u16 
swh—d
,

440 
sdma_tx»q
 *
txp


442 
	`TP_ARGS
(
sde
, 
hwh—d
, 
swh—d
, 
txp
),

443 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

444 
	$__f›ld
(
u16
, 
hwh—d
)

445 
	$__f›ld
(
u16
, 
swh—d
)

446 
	$__f›ld
(
u16
, 
txÃxt
)

447 
	$__f›ld
(
u16
, 
tx_ž
)

448 
	$__f›ld
(
u16
, 
tx_h—d
)

449 
	`__f›ld
(
u8
, 
idx
)

451 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

452 
__’Œy
->
hwh—d
 = hwhead;

453 
__’Œy
->
swh—d
 = swhead;

454 
__’Œy
->
tx_ž
 = 
sde
->tx_tail;

455 
__’Œy
->
tx_h—d
 = 
sde
->tx_head;

456 
__’Œy
->
txÃxt
 = 
txp
 ?xp->
Ãxt_descq_idx
 : ~0;

457 
__’Œy
->
idx
 = 
sde
->
this_idx
;

459 
	`TP_´štk
(

461 
	`__g‘_¡r
(
dev
),

462 
__’Œy
->
idx
,

463 
__’Œy
->
hwh—d
,

464 
__’Œy
->
swh—d
,

465 
__’Œy
->
txÃxt
,

466 
__’Œy
->
tx_h—d
,

467 
__’Œy
->
tx_ž


472 
	`DECLARE_EVENT_CLASS
(
hfi1_sdma_¢
,

473 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
u64
 
¢
),

474 
	`TP_ARGS
(
sde
, 
¢
),

475 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

476 
	$__f›ld
(
u64
, 
¢
)

477 
	`__f›ld
(
u8
, 
idx
)

479 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

480 
__’Œy
->
¢
 = sn;

481 
__’Œy
->
idx
 = 
sde
->
this_idx
;

483 
	`TP_´štk
("[%s] SDE(%u) sn %llu",

484 
	`__g‘_¡r
(
dev
),

485 
__’Œy
->
idx
,

486 
__’Œy
->
¢


490 
	`DEFINE_EVENT
(
hfi1_sdma_¢
, 
hfi1_sdma_out_¢
,

491 
	`TP_PROTO
(

492 
sdma_’gše
 *
sde
,

493 
u64
 
¢


495 
	`TP_ARGS
(
sde
, 
¢
)

498 
	`DEFINE_EVENT
(
hfi1_sdma_¢
, 
hfi1_sdma_š_¢
,

499 
	`TP_PROTO
(
sdma_’gše
 *
sde
, 
u64
 
¢
),

500 
	`TP_ARGS
(
sde
, 
¢
)

503 
	#USDMA_HDR_FORMAT
 \

504 "[%s:%u:%u:%u] PBC=(0x%x 0x%xèLRH=(0x%x 0x%xèBTH=(0x%x 0x%x 0x%xèKDETH=(0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%xèTIDV®=0x%x"

	)

506 
	`TRACE_EVENT
(
hfi1_sdma_u£r_h—d”
,

507 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, 
u8
 
subùxt
, u16 
»q
,

508 
hfi1_pkt_h—d”
 *
hdr
, 
u32
 
tidv®
),

509 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
»q
, 
hdr
, 
tidv®
),

510 
	`TP_STRUCT__’Œy
(

511 
	$DD_DEV_ENTRY
(
dd
)

512 
	$__f›ld
(
u16
, 
ùxt
)

513 
	$__f›ld
(
u8
, 
subùxt
)

514 
	$__f›ld
(
u16
, 
»q
)

515 
	$__f›ld
(
u32
, 
pbc0
)

516 
	$__f›ld
(
u32
, 
pbc1
)

517 
	$__f›ld
(
u32
, 
Ìh0
)

518 
	$__f›ld
(
u32
, 
Ìh1
)

519 
	$__f›ld
(
u32
, 
bth0
)

520 
	$__f›ld
(
u32
, 
bth1
)

521 
	$__f›ld
(
u32
, 
bth2
)

522 
	$__f›ld
(
u32
, 
kd‘h0
)

523 
	$__f›ld
(
u32
, 
kd‘h1
)

524 
	$__f›ld
(
u32
, 
kd‘h2
)

525 
	$__f›ld
(
u32
, 
kd‘h3
)

526 
	$__f›ld
(
u32
, 
kd‘h4
)

527 
	$__f›ld
(
u32
, 
kd‘h5
)

528 
	$__f›ld
(
u32
, 
kd‘h6
)

529 
	$__f›ld
(
u32
, 
kd‘h7
)

530 
	$__f›ld
(
u32
, 
kd‘h8
)

531 
	`__f›ld
(
u32
, 
tidv®
)

533 
	`TP_ç¡_assign
(

534 
__Ë32
 *
pbc
 = (__Ë32 *)
hdr
->pbc;

535 
__be32
 *
Ìh
 = (__be32 *)
hdr
->lrh;

536 
__be32
 *
bth
 = (__be32 *)
hdr
->bth;

537 
__Ë32
 *
kd‘h
 = (__Ë32 *)&
hdr
->kdeth;

539 
	`DD_DEV_ASSIGN
(
dd
);

540 
__’Œy
->
ùxt
 = ctxt;

541 
__’Œy
->
subùxt
 = subctxt;

542 
__’Œy
->
»q
 =„eq;

543 
__’Œy
->
pbc0
 = 
	`Ë32_to_ýu
(
pbc
[0]);

544 
__’Œy
->
pbc1
 = 
	`Ë32_to_ýu
(
pbc
[1]);

545 
__’Œy
->
Ìh0
 = 
	`be32_to_ýu
(
Ìh
[0]);

546 
__’Œy
->
Ìh1
 = 
	`be32_to_ýu
(
Ìh
[1]);

547 
__’Œy
->
bth0
 = 
	`be32_to_ýu
(
bth
[0]);

548 
__’Œy
->
bth1
 = 
	`be32_to_ýu
(
bth
[1]);

549 
__’Œy
->
bth2
 = 
	`be32_to_ýu
(
bth
[2]);

550 
__’Œy
->
kd‘h0
 = 
	`Ë32_to_ýu
(
kd‘h
[0]);

551 
__’Œy
->
kd‘h1
 = 
	`Ë32_to_ýu
(
kd‘h
[1]);

552 
__’Œy
->
kd‘h2
 = 
	`Ë32_to_ýu
(
kd‘h
[2]);

553 
__’Œy
->
kd‘h3
 = 
	`Ë32_to_ýu
(
kd‘h
[3]);

554 
__’Œy
->
kd‘h4
 = 
	`Ë32_to_ýu
(
kd‘h
[4]);

555 
__’Œy
->
kd‘h5
 = 
	`Ë32_to_ýu
(
kd‘h
[5]);

556 
__’Œy
->
kd‘h6
 = 
	`Ë32_to_ýu
(
kd‘h
[6]);

557 
__’Œy
->
kd‘h7
 = 
	`Ë32_to_ýu
(
kd‘h
[7]);

558 
__’Œy
->
kd‘h8
 = 
	`Ë32_to_ýu
(
kd‘h
[8]);

559 
__’Œy
->
tidv®
 =idval;

561 
	`TP_´štk
(
USDMA_HDR_FORMAT
,

562 
	`__g‘_¡r
(
dev
),

563 
__’Œy
->
ùxt
,

564 
__’Œy
->
subùxt
,

565 
__’Œy
->
»q
,

566 
__’Œy
->
pbc1
,

567 
__’Œy
->
pbc0
,

568 
__’Œy
->
Ìh0
,

569 
__’Œy
->
Ìh1
,

570 
__’Œy
->
bth0
,

571 
__’Œy
->
bth1
,

572 
__’Œy
->
bth2
,

573 
__’Œy
->
kd‘h0
,

574 
__’Œy
->
kd‘h1
,

575 
__’Œy
->
kd‘h2
,

576 
__’Œy
->
kd‘h3
,

577 
__’Œy
->
kd‘h4
,

578 
__’Œy
->
kd‘h5
,

579 
__’Œy
->
kd‘h6
,

580 
__’Œy
->
kd‘h7
,

581 
__’Œy
->
kd‘h8
,

582 
__’Œy
->
tidv®


586 
	#SDMA_UREQ_FMT
 \

587 "[%s:%u:%u] v”/Ý=0x%x, iovút=%u,‚pkts=%u, f¿g=%u, idx=%u"

	)

588 
	`TRACE_EVENT
(
hfi1_sdma_u£r_»qšfo
,

589 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, 
u8
 
subùxt
, u16 *
i
),

590 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
i
),

591 
	`TP_STRUCT__’Œy
(

592 
	`DD_DEV_ENTRY
(
dd
);

593 
	$__f›ld
(
u16
, 
ùxt
)

594 
	$__f›ld
(
u8
, 
subùxt
)

595 
	$__f›ld
(
u8
, 
v”_Ýcode
)

596 
	$__f›ld
(
u8
, 
iovút
)

597 
	$__f›ld
(
u16
, 
Åkts
)

598 
	$__f›ld
(
u16
, 
äagsize
)

599 
	`__f›ld
(
u16
, 
comp_idx
)

601 
	`TP_ç¡_assign
(

602 
	`DD_DEV_ASSIGN
(
dd
);

603 
__’Œy
->
ùxt
 = ctxt;

604 
__’Œy
->
subùxt
 = subctxt;

605 
__’Œy
->
v”_Ýcode
 = 
i
[0] & 0xff;

606 
__’Œy
->
iovút
 = (
i
[0] >> 8) & 0xff;

607 
__’Œy
->
Åkts
 = 
i
[1];

608 
__’Œy
->
äagsize
 = 
i
[2];

609 
__’Œy
->
comp_idx
 = 
i
[3];

611 
	`TP_´štk
(
SDMA_UREQ_FMT
,

612 
	`__g‘_¡r
(
dev
),

613 
__’Œy
->
ùxt
,

614 
__’Œy
->
subùxt
,

615 
__’Œy
->
v”_Ýcode
,

616 
__’Œy
->
iovút
,

617 
__’Œy
->
Åkts
,

618 
__’Œy
->
äagsize
,

619 
__’Œy
->
comp_idx


623 
	#usdma_com¶‘e_Çme
(
¡
è{ st, #¡ 
	}

	)
}

624 
	#show_usdma_com¶‘e_¡©e
(
¡
) \

625 
	`__´št_symbÞic
(
¡
, \

626 
	`usdma_com¶‘e_Çme
(
FREE
), \

627 
	`usdma_com¶‘e_Çme
(
QUEUED
), \

628 
	`usdma_com¶‘e_Çme
(
COMPLETE
), \

629 
	`usdma_com¶‘e_Çme
(
ERROR
))

	)

631 
TRACE_EVENT
(
hfi1_sdma_u£r_com¶‘iÚ
,

632 
TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, 
u8
 
subùxt
, u16 
idx
,

633 
u8
 
¡©e
, 
code
),

634 
TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
idx
, 
¡©e
, 
code
),

635 
TP_STRUCT__’Œy
(

636 
	$DD_DEV_ENTRY
(
dd
)

637 
	$__f›ld
(
u16
, 
ùxt
)

638 
	$__f›ld
(
u8
, 
subùxt
)

639 
	$__f›ld
(
u16
, 
idx
)

640 
	$__f›ld
(
u8
, 
¡©e
)

641 
	`__f›ld
(, 
code
)

643 
	`TP_ç¡_assign
(

644 
	`DD_DEV_ASSIGN
(
dd
);

645 
__’Œy
->
ùxt
 = ctxt;

646 
__’Œy
->
subùxt
 = subctxt;

647 
__’Œy
->
idx
 = idx;

648 
__’Œy
->
¡©e
 = state;

649 
__’Œy
->
code
 = code;

651 
	`TP_´štk
("[%s:%u:%u:%u] SDMA completion state %s (%d)",

652 
	`__g‘_¡r
(
dev
), 
__’Œy
->
ùxt
, __’Œy->
subùxt
,

653 
__’Œy
->
idx
, 
	`show_usdma_com¶‘e_¡©e
(__’Œy->
¡©e
),

654 
__’Œy
->
code
)

657 cÚ¡ *
	`´št_u32_¬¿y
(
Œaû_£q
 *, 
u32
 *, );

658 
	#__´št_u32_hex
(
¬r
, 
Ën
è
	`´št_u32_¬¿y
(
p
,‡¼,†’)

	)

660 
	`TRACE_EVENT
(
hfi1_sdma_u£r_h—d”_ahg
,

661 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
u16
 
ùxt
, 
u8
 
subùxt
, u16 
»q
,

662 
u8
 
sde
, u8 
ahgidx
, 
u32
 *
ahg
, 
Ën
, u32 
tidv®
),

663 
	`TP_ARGS
(
dd
, 
ùxt
, 
subùxt
, 
»q
, 
sde
, 
ahgidx
, 
ahg
, 
Ën
, 
tidv®
),

664 
	`TP_STRUCT__’Œy
(

665 
	$DD_DEV_ENTRY
(
dd
)

666 
	$__f›ld
(
u16
, 
ùxt
)

667 
	$__f›ld
(
u8
, 
subùxt
)

668 
	$__f›ld
(
u16
, 
»q
)

669 
	$__f›ld
(
u8
, 
sde
)

670 
	$__f›ld
(
u8
, 
idx
)

671 
	$__f›ld
(, 
Ën
)

672 
	$__f›ld
(
u32
, 
tidv®
)

673 
	`__¬¿y
(
u32
, 
ahg
, 10)

675 
	`TP_ç¡_assign
(

676 
	`DD_DEV_ASSIGN
(
dd
);

677 
__’Œy
->
ùxt
 = ctxt;

678 
__’Œy
->
subùxt
 = subctxt;

679 
__’Œy
->
»q
 =„eq;

680 
__’Œy
->
sde
 = sde;

681 
__’Œy
->
idx
 = 
ahgidx
;

682 
__’Œy
->
Ën
 =†en;

683 
__’Œy
->
tidv®
 =idval;

684 
	`memýy
(
__’Œy
->
ahg
,‡hg, 
Ën
 * (
u32
));

686 
	`TP_´štk
("[%s:%u:%u:%u] (SDE%u/AHG%u)‡hg[0-%d]=(%s) TIDVal=0x%x",

687 
	`__g‘_¡r
(
dev
),

688 
__’Œy
->
ùxt
,

689 
__’Œy
->
subùxt
,

690 
__’Œy
->
»q
,

691 
__’Œy
->
sde
,

692 
__’Œy
->
idx
,

693 
__’Œy
->
Ën
 - 1,

694 
	`__´št_u32_hex
(
__’Œy
->
ahg
, __’Œy->
Ën
),

695 
__’Œy
->
tidv®


699 
	`TRACE_EVENT
(
hfi1_sdma_¡©e
,

700 
	`TP_PROTO
(
sdma_’gše
 *
sde
,

701 cÚ¡ *
c¡©e
,

702 cÚ¡ *
n¡©e


704 
	`TP_ARGS
(
sde
, 
c¡©e
, 
n¡©e
),

705 
	`TP_STRUCT__’Œy
(
	`DD_DEV_ENTRY
(
sde
->
dd
)

706 
	$__¡ršg
(
cur¡©e
, 
c¡©e
)

707 
	`__¡ršg
(
Ãw¡©e
, 
n¡©e
)

709 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
sde
->
dd
);

710 
	`__assign_¡r
(
cur¡©e
, 
c¡©e
);

711 
	`__assign_¡r
(
Ãw¡©e
, 
n¡©e
);

713 
	`TP_´štk
("[%s] current state %s‚ew state %s",

714 
	`__g‘_¡r
(
dev
),

715 
	`__g‘_¡r
(
cur¡©e
),

716 
	`__g‘_¡r
(
Ãw¡©e
)

720 
	#BCT_FORMAT
 \

721 "sh¬ed_lim™ %x vl 0-7 [%x,%x][%x,%x][%x,%x][%x,%x][%x,%x][%x,%x][%x,%x][%x,%x] 15 [%x,%x]"

	)

723 
	#BCT
(
f›ld
) \

724 
	`be16_to_ýu
( \

725 ((
bufãr_cÚŒÞ
 *)
	`__g‘_dyÇmic_¬¿y
(
bù
))->
f›ld
 \

726 )

	)

728 
	`DECLARE_EVENT_CLASS
(
hfi1_bù_‹m¶©e
,

729 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
,

730 
bufãr_cÚŒÞ
 *
bc
),

731 
	`TP_ARGS
(
dd
, 
bc
),

732 
	`TP_STRUCT__’Œy
(
	$DD_DEV_ENTRY
(
dd
)

733 
	`__dyÇmic_¬¿y
(
u8
, 
bù
, (*
bc
))

735 
	`TP_ç¡_assign
(
	`DD_DEV_ASSIGN
(
dd
);

736 
	`memýy
(
	`__g‘_dyÇmic_¬¿y
(
bù
), 
bc
,

737 (*
bc
));

739 
	`TP_´štk
(
BCT_FORMAT
,

740 
	`BCT
(
ov”®l_sh¬ed_lim™
),

742 
	`BCT
(
vl
[0].
dediÿ‹d
),

743 
	`BCT
(
vl
[0].
sh¬ed
),

745 
	`BCT
(
vl
[1].
dediÿ‹d
),

746 
	`BCT
(
vl
[1].
sh¬ed
),

748 
	`BCT
(
vl
[2].
dediÿ‹d
),

749 
	`BCT
(
vl
[2].
sh¬ed
),

751 
	`BCT
(
vl
[3].
dediÿ‹d
),

752 
	`BCT
(
vl
[3].
sh¬ed
),

754 
	`BCT
(
vl
[4].
dediÿ‹d
),

755 
	`BCT
(
vl
[4].
sh¬ed
),

757 
	`BCT
(
vl
[5].
dediÿ‹d
),

758 
	`BCT
(
vl
[5].
sh¬ed
),

760 
	`BCT
(
vl
[6].
dediÿ‹d
),

761 
	`BCT
(
vl
[6].
sh¬ed
),

763 
	`BCT
(
vl
[7].
dediÿ‹d
),

764 
	`BCT
(
vl
[7].
sh¬ed
),

766 
	`BCT
(
vl
[15].
dediÿ‹d
),

767 
	`BCT
(
vl
[15].
sh¬ed
)

771 
	`DEFINE_EVENT
(
hfi1_bù_‹m¶©e
, 
bù_£t
,

772 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
bufãr_cÚŒÞ
 *
bc
),

773 
	`TP_ARGS
(
dd
, 
bc
));

775 
	`DEFINE_EVENT
(
hfi1_bù_‹m¶©e
, 
bù_g‘
,

776 
	`TP_PROTO
(
hfi1_devd©a
 *
dd
, 
bufãr_cÚŒÞ
 *
bc
),

777 
	`TP_ARGS
(
dd
, 
bc
));

779 
	`TRACE_EVENT
(

780 
hfi1_qp_£nd_com¶‘iÚ
,

781 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
, 
u32
 
idx
),

782 
	`TP_ARGS
(
qp
, 
wqe
, 
idx
),

783 
	`TP_STRUCT__’Œy
(

784 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

785 
	$__f›ld
(
rvt_swqe
 *, 
wqe
)

786 
	$__f›ld
(
u64
, 
wr_id
)

787 
	$__f›ld
(
u32
, 
q²
)

788 
	$__f›ld
(
u32
, 
q±
)

789 
	$__f›ld
(
u32
, 
Ëngth
)

790 
	$__f›ld
(
u32
, 
idx
)

791 
	$__f›ld
(
u32
, 
s¢
)

792 
	$__f›ld
(
ib_wr_Ýcode
, 
Ýcode
)

793 
	`__f›ld
(, 
£nd_æags
)

795 
	`TP_ç¡_assign
(

796 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

797 
__’Œy
->
wqe
 = wqe;

798 
__’Œy
->
wr_id
 = 
wqe
->
wr
.wr_id;

799 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

800 
__’Œy
->
q±
 = 
qp
->
ibqp
.
qp_ty³
;

801 
__’Œy
->
Ëngth
 = 
wqe
->length;

802 
__’Œy
->
idx
 = idx;

803 
__’Œy
->
s¢
 = 
wqe
->ssn;

804 
__’Œy
->
Ýcode
 = 
wqe
->
wr
.opcode;

805 
__’Œy
->
£nd_æags
 = 
wqe
->
wr
.send_flags;

807 
	`TP_´štk
(

809 
	`__g‘_¡r
(
dev
),

810 
__’Œy
->
q²
,

811 
__’Œy
->
q±
,

812 
__’Œy
->
wqe
,

813 
__’Œy
->
idx
,

814 
__’Œy
->
wr_id
,

815 
__’Œy
->
Ëngth
,

816 
__’Œy
->
s¢
,

817 
__’Œy
->
Ýcode
,

818 
__’Œy
->
£nd_æags


822 
	`DECLARE_EVENT_CLASS
(

823 
hfi1_do_£nd_‹m¶©e
,

824 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
boÞ
 
æag
),

825 
	`TP_ARGS
(
qp
, 
æag
),

826 
	`TP_STRUCT__’Œy
(

827 
	`DD_DEV_ENTRY
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

828 
	$__f›ld
(
u32
, 
q²
)

829 
	`__f›ld
(
boÞ
, 
æag
)

831 
	`TP_ç¡_assign
(

832 
	`DD_DEV_ASSIGN
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
))

833 
__’Œy
->
q²
 = 
qp
->
ibqp
.
qp_num
;

834 
__’Œy
->
æag
 = flag;

836 
	`TP_´štk
(

838 
	`__g‘_¡r
(
dev
),

839 
__’Œy
->
q²
,

840 
__’Œy
->
æag


844 
	`DEFINE_EVENT
(

845 
hfi1_do_£nd_‹m¶©e
, 
hfi1_rc_do_£nd
,

846 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
boÞ
 
æag
),

847 
	`TP_ARGS
(
qp
, 
æag
)

850 
	`DEFINE_EVENT
(

851 
hfi1_do_£nd_‹m¶©e
, 
hfi1_rc_do_tid_£nd
,

852 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
boÞ
 
æag
),

853 
	`TP_ARGS
(
qp
, 
æag
)

856 
	`DEFINE_EVENT
(

857 
hfi1_do_£nd_‹m¶©e
, 
hfi1_rc_expœed_time_¦iû
,

858 
	`TP_PROTO
(
rvt_qp
 *
qp
, 
boÞ
 
æag
),

859 
	`TP_ARGS
(
qp
, 
æag
)

862 
	`DECLARE_EVENT_CLASS
(

863 
hfi1_oib_txq_‹m¶©e
,

864 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

865 
	`TP_ARGS
(
txq
),

866 
	`TP_STRUCT__’Œy
(

867 
	`DD_DEV_ENTRY
(
txq
->
´iv
->
dd
)

868 
	$__f›ld
(
hfi1_oib_txq
 *, 
txq
)

869 
	$__f›ld
(
sdma_’gše
 *, 
sde
)

870 
	$__f›ld
(
ulÚg
, 
h—d
)

871 
	$__f›ld
(
ulÚg
, 
ž
)

872 
	$__f›ld
(
ušt
, 
u£d
)

873 
	$__f›ld
(
ušt
, 
æow
)

874 
	$__f›ld
(, 
¡Ýs
)

875 
	$__f›ld
(, 
no_desc
)

876 
	$__f›ld
(
u8
, 
idx
)

877 
	`__f›ld
(
u8
, 
¡Ý³d
)

879 
	`TP_ç¡_assign
(

880 
	`DD_DEV_ASSIGN
(
txq
->
´iv
->
dd
)

881 
__’Œy
->
txq
 =xq;

882 
__’Œy
->
sde
 = 
txq
->sde;

883 
__’Œy
->
h—d
 = 
txq
->
tx_ršg
.head;

884 
__’Œy
->
ž
 = 
txq
->
tx_ršg
.tail;

885 
__’Œy
->
idx
 = 
txq
->
q_idx
;

886 
__’Œy
->
u£d
 =

887 
txq
->
£Á_tx»qs
 -

888 
	`©omic64_»ad
(&
txq
->
com¶‘e_tx»qs
);

889 
__’Œy
->
æow
 = 
txq
->æow.
as_št
;

890 
__’Œy
->
¡Ýs
 = 
	`©omic_»ad
(&
txq
->stops);

891 
__’Œy
->
no_desc
 = 
	`©omic_»ad
(&
txq
->no_desc);

892 
__’Œy
->
¡Ý³d
 =

893 
	`__Ãtif_subqueue_¡Ý³d
(
txq
->
´iv
->
Ãtdev
,xq->
q_idx
);

895 
	`TP_´štk
(

897 
	`__g‘_¡r
(
dev
),

898 ()
__’Œy
->
txq
,

899 
__’Œy
->
idx
,

900 ()
__’Œy
->
sde
,

901 
__’Œy
->
h—d
,

902 
__’Œy
->
ž
,

903 
__’Œy
->
æow
,

904 
__’Œy
->
u£d
,

905 
__’Œy
->
¡Ýs
,

906 
__’Œy
->
no_desc
,

907 
__’Œy
->
¡Ý³d


911 
	`DEFINE_EVENT
(

912 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_¡Ý
,

913 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

914 
	`TP_ARGS
(
txq
)

917 
	`DEFINE_EVENT
(

918 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_wake
,

919 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

920 
	`TP_ARGS
(
txq
)

923 
	`DEFINE_EVENT
(

924 
hfi1_oib_txq_‹m¶©e
, 
hfi1_æow_æush
,

925 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

926 
	`TP_ARGS
(
txq
)

929 
	`DEFINE_EVENT
(

930 
hfi1_oib_txq_‹m¶©e
, 
hfi1_æow_sw™ch
,

931 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

932 
	`TP_ARGS
(
txq
)

935 
	`DEFINE_EVENT
(

936 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_wakeup
,

937 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

938 
	`TP_ARGS
(
txq
)

941 
	`DEFINE_EVENT
(

942 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_fuÎ
,

943 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

944 
	`TP_ARGS
(
txq
)

947 
	`DEFINE_EVENT
(

948 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_queued
,

949 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

950 
	`TP_ARGS
(
txq
)

953 
	`DEFINE_EVENT
(

954 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_xm™_¡Ý³d
,

955 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

956 
	`TP_ARGS
(
txq
)

959 
	`DEFINE_EVENT
(

960 
hfi1_oib_txq_‹m¶©e
, 
hfi1_txq_xm™_un¡Ý³d
,

961 
	`TP_PROTO
(
hfi1_oib_txq
 *
txq
),

962 
	`TP_ARGS
(
txq
)

967 #undeà
TRACE_INCLUDE_PATH


968 #undeà
TRACE_INCLUDE_FILE


969 
	#TRACE_INCLUDE_PATH
 .

	)

970 
	#TRACE_INCLUDE_FILE
 
Œaû_tx


	)

971 
	~<Œaû/defše_Œaû.h
>

	@uc.c

48 
	~"hfi.h
"

49 
	~"v”bs_tx»q.h
"

50 
	~"qp.h
"

53 
	#OP
(
x
è
	`UC_OP
(x)

	)

63 
	$hfi1_make_uc_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
)

65 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

66 
ib_Ùh”_h—d”s
 *
ohdr
;

67 
rvt_swqe
 *
wqe
;

68 
u32
 
hwÜds
;

69 
u32
 
bth0
 = 0;

70 
u32
 
Ën
;

71 
u32
 
pmtu
 = 
qp
->pmtu;

72 
middË
 = 0;

74 
ps
->
s_tx»q
 = 
	`g‘_tx»q
Õs->
dev
, 
qp
);

75 ià(!
ps
->
s_tx»q
)

76 
baž_no_tx
;

78 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_SEND_OK
)) {

79 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_FLUSH_SEND
))

80 
baž
;

82 ià(
qp
->
s_Ï¡
 =ð
	`READ_ONCE
(qp->
s_h—d
))

83 
baž
;

85 ià(
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
)) {

86 
qp
->
s_æags
 |ð
RVT_S_WAIT_DMA
;

87 
baž
;

89 
	`þ—r_ahg
(
qp
);

90 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_Ï¡
);

91 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_WR_FLUSH_ERR
);

92 
dÚe_ä“_tx
;

95 ià(
´iv
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_9B
) {

97 
hwÜds
 = 5;

98 ià(
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
)

99 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
l
.
Ùh
;

101 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
Ùh
;

104 
hwÜds
 = 7;

105 ià((
	`rdma_ah_g‘_ah_æags
(&
qp
->
»mÙe_ah_©Œ
è& 
IB_AH_GRH
) &&

106 (
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
))))

107 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
l
.
Ùh
;

109 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
Ùh
;

113 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_cur
);

114 
qp
->
s_wqe
 = 
NULL
;

115 
qp
->
s_¡©e
) {

117 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] &

118 
RVT_PROCESS_NEXT_SEND_OK
))

119 
baž
;

121 ià(
qp
->
s_cur
 =ð
	`READ_ONCE
(qp->
s_h—d
)) {

122 
	`þ—r_ahg
(
qp
);

123 
baž
;

129 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_REG_MR
 ||

130 
wqe
->
wr
.
Ýcode
 =ð
IB_WR_LOCAL_INV
) {

131 
loÿl_Ýs
 = 0;

132 
”r
 = 0;

134 ià(
qp
->
s_Ï¡
 !ðqp->
s_cur
)

135 
baž
;

136 ià(++
qp
->
s_cur
 =ðqp->
s_size
)

137 
qp
->
s_cur
 = 0;

138 ià(!(
wqe
->
wr
.
£nd_æags
 & 
RVT_SEND_COMPLETION_ONLY
)) {

139 
”r
 = 
	`rvt_šv®id©e_rkey
(

140 
qp
, 
wqe
->
wr
.
ex
.
šv®id©e_rkey
);

141 
loÿl_Ýs
 = 1;

143 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
”r
 ? 
IB_WC_LOC_PROT_ERR


144 : 
IB_WC_SUCCESS
);

145 ià(
loÿl_Ýs
)

146 
	`©omic_dec
(&
qp
->
loÿl_Ýs_³ndšg
);

147 
dÚe_ä“_tx
;

152 
qp
->
s_p¢
 = 
wqe
->
p¢
;

153 
qp
->
s_sge
.
sge
 = 
wqe
->
sg_li¡
[0];

154 
qp
->
s_sge
.
sg_li¡
 = 
wqe
->sg_list + 1;

155 
qp
->
s_sge
.
num_sge
 = 
wqe
->
wr
.num_sge;

156 
qp
->
s_sge
.
tÙ®_Ën
 = 
wqe
->
Ëngth
;

157 
Ën
 = 
wqe
->
Ëngth
;

158 
qp
->
s_Ën
 = 
Ën
;

159 
wqe
->
wr
.
Ýcode
) {

160 
IB_WR_SEND
:

161 
IB_WR_SEND_WITH_IMM
:

162 ià(
Ën
 > 
pmtu
) {

163 
qp
->
s_¡©e
 = 
	`OP
(
SEND_FIRST
);

164 
Ën
 = 
pmtu
;

167 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND
) {

168 
qp
->
s_¡©e
 = 
	`OP
(
SEND_ONLY
);

170 
qp
->
s_¡©e
 =

171 
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
);

173 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

174 
hwÜds
 += 1;

176 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

177 
bth0
 |ð
IB_BTH_SOLICITED
;

178 
qp
->
s_wqe
 = 
wqe
;

179 ià(++
qp
->
s_cur
 >ðqp->
s_size
)

180 
qp
->
s_cur
 = 0;

183 
IB_WR_RDMA_WRITE
:

184 
IB_WR_RDMA_WRITE_WITH_IMM
:

185 
ohdr
->
u
.
rc
.
»th
.
vaddr
 =

186 
	`ýu_to_be64
(
wqe
->
rdma_wr
.
»mÙe_addr
);

187 
ohdr
->
u
.
rc
.
»th
.
rkey
 =

188 
	`ýu_to_be32
(
wqe
->
rdma_wr
.
rkey
);

189 
ohdr
->
u
.
rc
.
»th
.
Ëngth
 = 
	`ýu_to_be32
(
Ën
);

190 
hwÜds
 +ð(
ib_»th
) / 4;

191 ià(
Ën
 > 
pmtu
) {

192 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_FIRST
);

193 
Ën
 = 
pmtu
;

196 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) {

197 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_ONLY
);

199 
qp
->
s_¡©e
 =

200 
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
);

202 
ohdr
->
u
.
rc
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

203 
hwÜds
 += 1;

204 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

205 
bth0
 |ð
IB_BTH_SOLICITED
;

207 
qp
->
s_wqe
 = 
wqe
;

208 ià(++
qp
->
s_cur
 >ðqp->
s_size
)

209 
qp
->
s_cur
 = 0;

213 
baž
;

217 
	`OP
(
SEND_FIRST
):

218 
qp
->
s_¡©e
 = 
	`OP
(
SEND_MIDDLE
);

220 
	`OP
(
SEND_MIDDLE
):

221 
Ën
 = 
qp
->
s_Ën
;

222 ià(
Ën
 > 
pmtu
) {

223 
Ën
 = 
pmtu
;

224 
middË
 = 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
);

227 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND
) {

228 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST
);

230 
qp
->
s_¡©e
 = 
	`OP
(
SEND_LAST_WITH_IMMEDIATE
);

232 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

233 
hwÜds
 += 1;

235 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

236 
bth0
 |ð
IB_BTH_SOLICITED
;

237 
qp
->
s_wqe
 = 
wqe
;

238 ià(++
qp
->
s_cur
 >ðqp->
s_size
)

239 
qp
->
s_cur
 = 0;

242 
	`OP
(
RDMA_WRITE_FIRST
):

243 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_MIDDLE
);

245 
	`OP
(
RDMA_WRITE_MIDDLE
):

246 
Ën
 = 
qp
->
s_Ën
;

247 ià(
Ën
 > 
pmtu
) {

248 
Ën
 = 
pmtu
;

249 
middË
 = 
	`HFI1_CAP_IS_KSET
(
SDMA_AHG
);

252 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_RDMA_WRITE
) {

253 
qp
->
s_¡©e
 = 
	`OP
(
RDMA_WRITE_LAST
);

255 
qp
->
s_¡©e
 =

256 
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
);

258 
ohdr
->
u
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

259 
hwÜds
 += 1;

260 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

261 
bth0
 |ð
IB_BTH_SOLICITED
;

263 
qp
->
s_wqe
 = 
wqe
;

264 ià(++
qp
->
s_cur
 >ðqp->
s_size
)

265 
qp
->
s_cur
 = 0;

268 
qp
->
s_Ën
 -ð
Ën
;

269 
ps
->
s_tx»q
->
hdr_dwÜds
 = 
hwÜds
;

270 
ps
->
s_tx»q
->
sde
 = 
´iv
->
s_sde
;

271 
ps
->
s_tx»q
->
ss
 = &
qp
->
s_sge
;

272 
ps
->
s_tx»q
->
s_cur_size
 = 
Ën
;

273 
	`hfi1_make_ruc_h—d”
(
qp
, 
ohdr
, 
bth0
 | (qp->
s_¡©e
 << 24),

274 
qp
->
»mÙe_q²
, 
	`mask_p¢
(qp->
s_p¢
++),

275 
middË
, 
ps
);

278 
dÚe_ä“_tx
:

279 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

280 
ps
->
s_tx»q
 = 
NULL
;

283 
baž
:

284 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

286 
baž_no_tx
:

287 
ps
->
s_tx»q
 = 
NULL
;

288 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

290 
	}
}

305 
	$hfi1_uc_rcv
(
hfi1_·ck‘
 *
·ck‘
)

307 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

308 *
d©a
 = 
·ck‘
->
·ylßd
;

309 
u32
 
Ž’
 = 
·ck‘
->tlen;

310 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

311 
ib_Ùh”_h—d”s
 *
ohdr
 = 
·ck‘
->ohdr;

312 
u32
 
Ýcode
 = 
·ck‘
->opcode;

313 
u32
 
hdrsize
 = 
·ck‘
->
hËn
;

314 
u32
 
p¢
;

315 
u32
 
·d
 = 
·ck‘
->pad;

316 
ib_wc
 
wc
;

317 
u32
 
pmtu
 = 
qp
->pmtu;

318 
ib_»th
 *
»th
;

319 
»t
;

320 
u8
 
exŒa_by‹s
 = 
·d
 + 
·ck‘
->
exŒa_by‹
 + (
SIZE_OF_CRC
 << 2);

322 ià(
	`hfi1_ruc_check_hdr
(
ibp
, 
·ck‘
))

325 
	`´oûss_eú
(
qp
, 
·ck‘
);

327 
p¢
 = 
	`ib_bth_g‘_p¢
(
ohdr
);

329 ià(
	`uÆik–y
(
	`cmp_p¢
(
p¢
, 
qp
->
r_p¢
) != 0)) {

334 
qp
->
r_p¢
 = 
p¢
;

335 
šv
:

336 ià(
qp
->
r_¡©e
 =ð
	`OP
(
SEND_FIRST
) ||

337 
qp
->
r_¡©e
 =ð
	`OP
(
SEND_MIDDLE
)) {

338 
	`£t_b™
(
RVT_R_REWIND_SGE
, &
qp
->
r_aæags
);

339 
qp
->
r_sge
.
num_sge
 = 0;

341 
	`rvt_put_ss
(&
qp
->
r_sge
);

343 
qp
->
r_¡©e
 = 
	`OP
(
SEND_LAST
);

344 
Ýcode
) {

345 
	`OP
(
SEND_FIRST
):

346 
	`OP
(
SEND_ONLY
):

347 
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
):

348 
£nd_fœ¡
;

350 
	`OP
(
RDMA_WRITE_FIRST
):

351 
	`OP
(
RDMA_WRITE_ONLY
):

352 
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
):

353 
rdma_fœ¡
;

356 
drÝ
;

361 
qp
->
r_¡©e
) {

362 
	`OP
(
SEND_FIRST
):

363 
	`OP
(
SEND_MIDDLE
):

364 ià(
Ýcode
 =ð
	`OP
(
SEND_MIDDLE
) ||

365 
Ýcode
 =ð
	`OP
(
SEND_LAST
) ||

366 
Ýcode
 =ð
	`OP
(
SEND_LAST_WITH_IMMEDIATE
))

368 
šv
;

370 
	`OP
(
RDMA_WRITE_FIRST
):

371 
	`OP
(
RDMA_WRITE_MIDDLE
):

372 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_MIDDLE
) ||

373 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST
) ||

374 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
))

376 
šv
;

379 ià(
Ýcode
 =ð
	`OP
(
SEND_FIRST
) ||

380 
Ýcode
 =ð
	`OP
(
SEND_ONLY
) ||

381 
Ýcode
 =ð
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
) ||

382 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_FIRST
) ||

383 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY
) ||

384 
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
))

386 
šv
;

389 ià(
qp
->
¡©e
 =ð
IB_QPS_RTR
 && !(qp->
r_æags
 & 
RVT_R_COMM_EST
))

390 
	`rvt_comm_e¡
(
qp
);

393 
Ýcode
) {

394 
	`OP
(
SEND_FIRST
):

395 
	`OP
(
SEND_ONLY
):

396 
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
):

397 
£nd_fœ¡
:

398 ià(
	`‹¡_ªd_þ—r_b™
(
RVT_R_REWIND_SGE
, &
qp
->
r_aæags
)) {

399 
qp
->
r_sge
 = qp->
s_rdma_»ad_sge
;

401 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
çl£
);

402 ià(
»t
 < 0)

403 
Ý_”r
;

404 ià(!
»t
)

405 
drÝ
;

410 
qp
->
s_rdma_»ad_sge
 = qp->
r_sge
;

412 
qp
->
r_rcv_Ën
 = 0;

413 ià(
Ýcode
 =ð
	`OP
(
SEND_ONLY
))

414 
no_immedŸ‹_d©a
;

415 ià(
Ýcode
 =ð
	`OP
(
SEND_ONLY_WITH_IMMEDIATE
))

416 
£nd_Ï¡_imm
;

418 
	`OP
(
SEND_MIDDLE
):

425 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 
exŒa_by‹s
)))

426 
»wšd
;

427 
qp
->
r_rcv_Ën
 +ð
pmtu
;

428 ià(
	`uÆik–y
(
qp
->
r_rcv_Ën
 > qp->
r_Ën
))

429 
»wšd
;

430 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
pmtu
, 
çl£
, false);

433 
	`OP
(
SEND_LAST_WITH_IMMEDIATE
):

434 
£nd_Ï¡_imm
:

435 
wc
.
ex
.
imm_d©a
 = 
ohdr
->
u
.imm_data;

436 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

437 
£nd_Ï¡
;

438 
	`OP
(
SEND_LAST
):

439 
no_immedŸ‹_d©a
:

440 
wc
.
ex
.
imm_d©a
 = 0;

441 
wc
.
wc_æags
 = 0;

442 
£nd_Ï¡
:

445 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
exŒa_by‹s
)))

446 
»wšd
;

448 
Ž’
 -ð(
hdrsize
 + 
exŒa_by‹s
);

449 
wc
.
by‹_Ën
 = 
Ž’
 + 
qp
->
r_rcv_Ën
;

450 ià(
	`uÆik–y
(
wc
.
by‹_Ën
 > 
qp
->
r_Ën
))

451 
»wšd
;

452 
wc
.
Ýcode
 = 
IB_WC_RECV
;

453 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
Ž’
, 
çl£
, false);

454 
	`rvt_put_ss
(&
qp
->
s_rdma_»ad_sge
);

455 
Ï¡_imm
:

456 
wc
.
wr_id
 = 
qp
->
r_wr_id
;

457 
wc
.
¡©us
 = 
IB_WC_SUCCESS
;

458 
wc
.
qp
 = &qp->
ibqp
;

459 
wc
.
¤c_qp
 = 
qp
->
»mÙe_q²
;

460 
wc
.
¦id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
è& 
U16_MAX
;

472 
wc
.
¦
 = 
	`rdma_ah_g‘_¦
(&
qp
->
»mÙe_ah_©Œ
);

474 
wc
.
v’dÜ_”r
 = 0;

475 
wc
.
pkey_šdex
 = 0;

476 
wc
.
dlid_·th_b™s
 = 0;

477 
wc
.
pÜt_num
 = 0;

479 
	`rvt_»cv_cq
(
qp
, &
wc
, 
	`ib_bth_is_sÞic™ed
(
ohdr
));

482 
	`OP
(
RDMA_WRITE_FIRST
):

483 
	`OP
(
RDMA_WRITE_ONLY
):

484 
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
):

485 
rdma_fœ¡
:

486 ià(
	`uÆik–y
(!(
qp
->
qp_acûss_æags
 &

487 
IB_ACCESS_REMOTE_WRITE
))) {

488 
drÝ
;

490 
»th
 = &
ohdr
->
u
.
rc
.reth;

491 
qp
->
r_Ën
 = 
	`be32_to_ýu
(
»th
->
Ëngth
);

492 
qp
->
r_rcv_Ën
 = 0;

493 
qp
->
r_sge
.
sg_li¡
 = 
NULL
;

494 ià(
qp
->
r_Ën
 != 0) {

495 
u32
 
rkey
 = 
	`be32_to_ýu
(
»th
->rkey);

496 
u64
 
vaddr
 = 
	`be64_to_ýu
(
»th
->vaddr);

497 
ok
;

500 
ok
 = 
	`rvt_rkey_ok
(
qp
, &qp->
r_sge
.
sge
, qp->
r_Ën
,

501 
vaddr
, 
rkey
, 
IB_ACCESS_REMOTE_WRITE
);

502 ià(
	`uÆik–y
(!
ok
))

503 
drÝ
;

504 
qp
->
r_sge
.
num_sge
 = 1;

506 
qp
->
r_sge
.
num_sge
 = 0;

507 
qp
->
r_sge
.
sge
.
mr
 = 
NULL
;

508 
qp
->
r_sge
.
sge
.
vaddr
 = 
NULL
;

509 
qp
->
r_sge
.
sge
.
Ëngth
 = 0;

510 
qp
->
r_sge
.
sge
.
sge_Ëngth
 = 0;

512 ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY
)) {

513 
rdma_Ï¡
;

514 } ià(
Ýcode
 =ð
	`OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
)) {

515 
wc
.
ex
.
imm_d©a
 = 
ohdr
->
u
.
rc
.imm_data;

516 
rdma_Ï¡_imm
;

519 
	`OP
(
RDMA_WRITE_MIDDLE
):

521 ià(
	`uÆik–y
(
Ž’
 !ð(
hdrsize
 + 
pmtu
 + 4)))

522 
drÝ
;

523 
qp
->
r_rcv_Ën
 +ð
pmtu
;

524 ià(
	`uÆik–y
(
qp
->
r_rcv_Ën
 > qp->
r_Ën
))

525 
drÝ
;

526 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
pmtu
, 
Œue
, 
çl£
);

529 
	`OP
(
RDMA_WRITE_LAST_WITH_IMMEDIATE
):

530 
wc
.
ex
.
imm_d©a
 = 
ohdr
->
u
.imm_data;

531 
rdma_Ï¡_imm
:

532 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

536 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
·d
 + 4)))

537 
drÝ
;

539 
Ž’
 -ð(
hdrsize
 + 
exŒa_by‹s
);

540 ià(
	`uÆik–y
(
Ž’
 + 
qp
->
r_rcv_Ën
 !ðqp->
r_Ën
))

541 
drÝ
;

542 ià(
	`‹¡_ªd_þ—r_b™
(
RVT_R_REWIND_SGE
, &
qp
->
r_aæags
)) {

543 
	`rvt_put_ss
(&
qp
->
s_rdma_»ad_sge
);

545 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
Œue
);

546 ià(
»t
 < 0)

547 
Ý_”r
;

548 ià(!
»t
)

549 
drÝ
;

551 
wc
.
by‹_Ën
 = 
qp
->
r_Ën
;

552 
wc
.
Ýcode
 = 
IB_WC_RECV_RDMA_WITH_IMM
;

553 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
Ž’
, 
Œue
, 
çl£
);

554 
	`rvt_put_ss
(&
qp
->
r_sge
);

555 
Ï¡_imm
;

557 
	`OP
(
RDMA_WRITE_LAST
):

558 
rdma_Ï¡
:

561 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
·d
 + 4)))

562 
drÝ
;

564 
Ž’
 -ð(
hdrsize
 + 
exŒa_by‹s
);

565 ià(
	`uÆik–y
(
Ž’
 + 
qp
->
r_rcv_Ën
 !ðqp->
r_Ën
))

566 
drÝ
;

567 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
Ž’
, 
Œue
, 
çl£
);

568 
	`rvt_put_ss
(&
qp
->
r_sge
);

573 
drÝ
;

575 
qp
->
r_p¢
++;

576 
qp
->
r_¡©e
 = 
Ýcode
;

579 
»wšd
:

580 
	`£t_b™
(
RVT_R_REWIND_SGE
, &
qp
->
r_aæags
);

581 
qp
->
r_sge
.
num_sge
 = 0;

582 
drÝ
:

583 
ibp
->
rvp
.
n_pkt_drÝs
++;

586 
Ý_”r
:

587 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

588 
	}
}

	@ud.c

48 
	~<lšux/Ãt.h
>

49 
	~<rdma/ib_smi.h
>

51 
	~"hfi.h
"

52 
	~"mad.h
"

53 
	~"v”bs_tx»q.h
"

54 
	~"Œaû_ibhdrs.h
"

55 
	~"qp.h
"

58 cÚ¡ 
hfi1_make_»q
 
	ghfi1_make_ud_»q_tbl
[2] = {

59 [
HFI1_PKT_TYPE_9B
] = &
hfi1_make_ud_»q_9B
,

60 [
HFI1_PKT_TYPE_16B
] = &
hfi1_make_ud_»q_16B


73 
	$ud_loÝback
(
rvt_qp
 *
sqp
, 
rvt_swqe
 *
swqe
)

75 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
sqp
->
ibqp
.
deviû
, sqp->
pÜt_num
);

76 
hfi1_µÜtd©a
 *
µd
;

77 
hfi1_qp_´iv
 *
´iv
 = 
sqp
->priv;

78 
rvt_qp
 *
qp
;

79 
rdma_ah_©Œ
 *
ah_©Œ
;

80 
æags
;

81 
rvt_sge_¡©e
 
ssge
;

82 
rvt_sge
 *
sge
;

83 
ib_wc
 
wc
;

84 
u32
 
Ëngth
;

85 
ib_qp_ty³
 
sq±y³
, 
dq±y³
;

87 
	`rcu_»ad_lock
();

89 
qp
 = 
	`rvt_lookup_q²
(
	`ib_to_rvt
(
sqp
->
ibqp
.
deviû
), &
ibp
->
rvp
,

90 
	`rvt_g‘_swqe_»mÙe_q²
(
swqe
));

91 ià(!
qp
) {

92 
ibp
->
rvp
.
n_pkt_drÝs
++;

93 
	`rcu_»ad_uÆock
();

97 
sq±y³
 = 
sqp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 ?

98 
IB_QPT_UD
 : 
sqp
->
ibqp
.
qp_ty³
;

99 
dq±y³
 = 
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 ?

100 
IB_QPT_UD
 : 
qp
->
ibqp
.
qp_ty³
;

102 ià(
dq±y³
 !ð
sq±y³
 ||

103 !(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
)) {

104 
ibp
->
rvp
.
n_pkt_drÝs
++;

105 
drÝ
;

108 
ah_©Œ
 = 
	`rvt_g‘_swqe_ah_©Œ
(
swqe
);

109 
µd
 = 
	`µd_äom_ibp
(
ibp
);

111 ià(
qp
->
ibqp
.
qp_num
 > 1) {

112 
u16
 
pkey
;

113 
u32
 
¦id
;

114 
u8
 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(
ah_©Œ
)];

116 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
sqp
->
s_pkey_šdex
);

117 
¦id
 = 
µd
->
lid
 | (
	`rdma_ah_g‘_·th_b™s
(
ah_©Œ
) &

118 ((1 << 
µd
->
lmc
) - 1));

119 ià(
	`uÆik–y
(
	`šg»ss_pkey_check
(
µd
, 
pkey
, 
sc5
,

120 
qp
->
s_pkey_šdex
,

121 
¦id
, 
çl£
))) {

122 
	`hfi1_bad_pkey
(
ibp
, 
pkey
,

123 
	`rdma_ah_g‘_¦
(
ah_©Œ
),

124 
sqp
->
ibqp
.
qp_num
, 
qp
->ibqp.qp_num,

125 
¦id
, 
	`rdma_ah_g‘_dlid
(
ah_©Œ
));

126 
drÝ
;

135 ià(
qp
->
ibqp
.
qp_num
) {

136 
u32
 
qkey
;

138 
qkey
 = ()
	`rvt_g‘_swqe_»mÙe_qkey
(
swqe
) < 0 ?

139 
sqp
->
qkey
 : 
	`rvt_g‘_swqe_»mÙe_qkey
(
swqe
);

140 ià(
	`uÆik–y
(
qkey
 !ð
qp
->qkey))

141 
drÝ
;

148 
Ëngth
 = 
swqe
->length;

149 
	`mem£t
(&
wc
, 0, (wc));

150 
wc
.
by‹_Ën
 = 
Ëngth
 + (
ib_grh
);

152 ià(
swqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
) {

153 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

154 
wc
.
ex
.
imm_d©a
 = 
swqe
->
wr
.ex.imm_data;

157 
	`¥š_lock_œq§ve
(&
qp
->
r_lock
, 
æags
);

162 ià(
qp
->
r_æags
 & 
RVT_R_REUSE_SGE
) {

163 
qp
->
r_æags
 &ð~
RVT_R_REUSE_SGE
;

165 
»t
;

167 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
çl£
);

168 ià(
»t
 < 0) {

169 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

170 
baž_uÆock
;

172 ià(!
»t
) {

173 ià(
qp
->
ibqp
.
qp_num
 == 0)

174 
ibp
->
rvp
.
n_vl15_drÝ³d
++;

175 
baž_uÆock
;

179 ià(
	`uÆik–y
(
wc
.
by‹_Ën
 > 
qp
->
r_Ën
)) {

180 
qp
->
r_æags
 |ð
RVT_R_REUSE_SGE
;

181 
ibp
->
rvp
.
n_pkt_drÝs
++;

182 
baž_uÆock
;

185 ià(
	`rdma_ah_g‘_ah_æags
(
ah_©Œ
è& 
IB_AH_GRH
) {

186 
ib_grh
 
grh
;

187 
ib_glob®_rou‹
 
grd
 = *(
	`rdma_ah_»ad_grh
(
ah_©Œ
));

204 ià(
´iv
->
hdr_ty³
 =ð
HFI1_PKT_TYPE_16B
) {

205 ià(
grd
.
sgid_šdex
 == 0)

206 
grd
.
sgid_šdex
 = 
OPA_GID_INDEX
;

208 ià(
	`ib_is_Ýa_gid
(&
grd
.
dgid
))

209 
grd
.
dgid
.
glob®
.
š‹rçû_id
 =

210 
	`ýu_to_be64
(
µd
->
guids
[
HFI1_PORT_GUID_INDEX
]);

213 
	`hfi1_make_grh
(
ibp
, &
grh
, &
grd
, 0, 0);

214 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, &
grh
,

215 (
grh
), 
Œue
, 
çl£
);

216 
wc
.
wc_æags
 |ð
IB_WC_GRH
;

218 
	`rvt_sk_sge
(&
qp
->
r_sge
, (
ib_grh
), 
Œue
);

220 
ssge
.
sg_li¡
 = 
swqe
->sg_list + 1;

221 
ssge
.
sge
 = *
swqe
->
sg_li¡
;

222 
ssge
.
num_sge
 = 
swqe
->
wr
.num_sge;

223 
sge
 = &
ssge
.sge;

224 
Ëngth
) {

225 
u32
 
Ën
 = 
	`rvt_g‘_sge_Ëngth
(
sge
, 
Ëngth
);

227 
	`WARN_ON_ONCE
(
Ën
 == 0);

228 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
sge
->
vaddr
, 
Ën
, 
Œue
, 
çl£
);

229 
	`rvt_upd©e_sge
(&
ssge
, 
Ën
, 
çl£
);

230 
Ëngth
 -ð
Ën
;

232 
	`rvt_put_ss
(&
qp
->
r_sge
);

233 ià(!
	`‹¡_ªd_þ—r_b™
(
RVT_R_WRID_VALID
, &
qp
->
r_aæags
))

234 
baž_uÆock
;

235 
wc
.
wr_id
 = 
qp
->
r_wr_id
;

236 
wc
.
¡©us
 = 
IB_WC_SUCCESS
;

237 
wc
.
Ýcode
 = 
IB_WC_RECV
;

238 
wc
.
qp
 = &qp->
ibqp
;

239 
wc
.
¤c_qp
 = 
sqp
->
ibqp
.
qp_num
;

240 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 || qp->ibqp.qp_ty³ =ð
IB_QPT_SMI
) {

241 ià(
sqp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 ||

242 
sqp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_SMI
)

243 
wc
.
pkey_šdex
 = 
	`rvt_g‘_swqe_pkey_šdex
(
swqe
);

245 
wc
.
pkey_šdex
 = 
sqp
->
s_pkey_šdex
;

247 
wc
.
pkey_šdex
 = 0;

249 
wc
.
¦id
 = (
µd
->
lid
 | (
	`rdma_ah_g‘_·th_b™s
(
ah_©Œ
) &

250 ((1 << 
µd
->
lmc
è- 1))è& 
U16_MAX
;

252 ià(
wc
.
¦id
 =ð0 && 
sqp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
)

253 
wc
.
¦id
 = 
	`be16_to_ýu
(
IB_LID_PERMISSIVE
);

254 
wc
.
¦
 = 
	`rdma_ah_g‘_¦
(
ah_©Œ
);

255 
wc
.
dlid_·th_b™s
 = 
	`rdma_ah_g‘_dlid
(
ah_©Œ
è& ((1 << 
µd
->
lmc
) - 1);

256 
wc
.
pÜt_num
 = 
qp
->port_num;

258 
	`rvt_»cv_cq
(
qp
, &
wc
, 
swqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
);

259 
ibp
->
rvp
.
n_loÝ_pkts
++;

260 
baž_uÆock
:

261 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
r_lock
, 
æags
);

262 
drÝ
:

263 
	`rcu_»ad_uÆock
();

264 
	}
}

266 
	$hfi1_make_bth_d‘h
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

267 
ib_Ùh”_h—d”s
 *
ohdr
,

268 
u16
 *
pkey
, 
u32
 
exŒa_by‹s
, 
boÞ
 
by·ss
)

270 
u32
 
bth0
;

271 
hfi1_ibpÜt
 *
ibp
;

273 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

274 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
) {

275 
ohdr
->
u
.
ud
.
imm_d©a
 = 
wqe
->
wr
.
ex
.imm_data;

276 
bth0
 = 
IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
 << 24;

278 
bth0
 = 
IB_OPCODE_UD_SEND_ONLY
 << 24;

281 ià(
wqe
->
wr
.
£nd_æags
 & 
IB_SEND_SOLICITED
)

282 
bth0
 |ð
IB_BTH_SOLICITED
;

283 
bth0
 |ð
exŒa_by‹s
 << 20;

284 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 || qp->ibqp.qp_ty³ =ð
IB_QPT_SMI
)

285 *
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
	`rvt_g‘_swqe_pkey_šdex
(
wqe
));

287 *
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
qp
->
s_pkey_šdex
);

288 ià(!
by·ss
)

289 
bth0
 |ð*
pkey
;

290 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

291 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
	`rvt_g‘_swqe_»mÙe_q²
(
wqe
));

292 
ohdr
->
bth
[2] = 
	`ýu_to_be32
(
	`mask_p¢
(
wqe
->
p¢
));

297 
ohdr
->
u
.
ud
.
d‘h
[0] =

298 
	`ýu_to_be32
(()
	`rvt_g‘_swqe_»mÙe_qkey
(
wqe
è< 0 ? 
qp
->
qkey
 :

299 
	`rvt_g‘_swqe_»mÙe_qkey
(
wqe
));

300 
ohdr
->
u
.
ud
.
d‘h
[1] = 
	`ýu_to_be32
(
qp
->
ibqp
.
qp_num
);

301 
	}
}

303 
	$hfi1_make_ud_»q_9B
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

304 
rvt_swqe
 *
wqe
)

306 
u32
 
nwÜds
, 
exŒa_by‹s
;

307 
u16
 
Ën
, 
¦id
, 
dlid
, 
pkey
;

308 
u16
 
Ìh0
 = 0;

309 
u8
 
sc5
;

310 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

311 
ib_Ùh”_h—d”s
 *
ohdr
;

312 
rdma_ah_©Œ
 *
ah_©Œ
;

313 
hfi1_µÜtd©a
 *
µd
;

314 
hfi1_ibpÜt
 *
ibp
;

315 
ib_grh
 *
grh
;

317 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

318 
µd
 = 
	`µd_äom_ibp
(
ibp
);

319 
ah_©Œ
 = 
	`rvt_g‘_swqe_ah_©Œ
(
wqe
);

321 
exŒa_by‹s
 = -
wqe
->
Ëngth
 & 3;

322 
nwÜds
 = ((
wqe
->
Ëngth
 + 
exŒa_by‹s
è>> 2è+ 
SIZE_OF_CRC
;

324 
ps
->
s_tx»q
->
hdr_dwÜds
 = 7;

325 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
)

326 
ps
->
s_tx»q
->
hdr_dwÜds
++;

328 ià(
	`rdma_ah_g‘_ah_æags
(
ah_©Œ
è& 
IB_AH_GRH
) {

329 
grh
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
l
.grh;

330 
ps
->
s_tx»q
->
hdr_dwÜds
 +=

331 
	`hfi1_make_grh
(
ibp
, 
grh
, 
	`rdma_ah_»ad_grh
(
ah_©Œ
),

332 
ps
->
s_tx»q
->
hdr_dwÜds
 - 
LRH_9B_DWORDS
,

333 
nwÜds
);

334 
Ìh0
 = 
HFI1_LRH_GRH
;

335 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
l
.
Ùh
;

337 
Ìh0
 = 
HFI1_LRH_BTH
;

338 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
.
u
.
Ùh
;

341 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(
ah_©Œ
)];

342 
Ìh0
 |ð(
	`rdma_ah_g‘_¦
(
ah_©Œ
) & 0xf) << 4;

343 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_SMI
) {

344 
Ìh0
 |= 0xF000;

345 
´iv
->
s_sc
 = 0xf;

347 
Ìh0
 |ð(
sc5
 & 0xf) << 12;

348 
´iv
->
s_sc
 = 
sc5
;

351 
dlid
 = 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
), 9B);

352 ià(
dlid
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
)) {

353 
¦id
 = 
	`be16_to_ýu
(
IB_LID_PERMISSIVE
);

355 
u16
 
lid
 = (u16)
µd
->lid;

357 ià(
lid
) {

358 
lid
 |ð
	`rdma_ah_g‘_·th_b™s
(
ah_©Œ
) &

359 ((1 << 
µd
->
lmc
) - 1);

360 
¦id
 = 
lid
;

362 
¦id
 = 
	`be16_to_ýu
(
IB_LID_PERMISSIVE
);

365 
	`hfi1_make_bth_d‘h
(
qp
, 
wqe
, 
ohdr
, &
pkey
, 
exŒa_by‹s
, 
çl£
);

366 
Ën
 = 
ps
->
s_tx»q
->
hdr_dwÜds
 + 
nwÜds
;

369 
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
 = 
HFI1_PKT_TYPE_9B
;

370 
	`hfi1_make_ib_hdr
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
ibh
,

371 
Ìh0
, 
Ën
, 
dlid
, 
¦id
);

372 
	}
}

374 
	$hfi1_make_ud_»q_16B
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

375 
rvt_swqe
 *
wqe
)

377 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

378 
ib_Ùh”_h—d”s
 *
ohdr
;

379 
rdma_ah_©Œ
 *
ah_©Œ
;

380 
hfi1_µÜtd©a
 *
µd
;

381 
hfi1_ibpÜt
 *
ibp
;

382 
u32
 
dlid
, 
¦id
, 
nwÜds
, 
exŒa_by‹s
;

383 
u32
 
de¡_qp
 = 
	`rvt_g‘_swqe_»mÙe_q²
(
wqe
);

384 
u32
 
¤c_qp
 = 
qp
->
ibqp
.
qp_num
;

385 
u16
 
Ën
, 
pkey
;

386 
u8
 
l4
, 
sc5
;

387 
boÞ
 
is_mgmt
 = 
çl£
;

389 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

390 
µd
 = 
	`µd_äom_ibp
(
ibp
);

391 
ah_©Œ
 = 
	`rvt_g‘_swqe_ah_©Œ
(
wqe
);

397 ià(
de¡_qp
 =ð0 || 
¤c_qp
 == 0 || dest_qp == 1 || src_qp == 1) {

399 
ps
->
s_tx»q
->
hdr_dwÜds
 = 6;

400 
is_mgmt
 = 
Œue
;

403 
ps
->
s_tx»q
->
hdr_dwÜds
 = 9;

404 ià(
wqe
->
wr
.
Ýcode
 =ð
IB_WR_SEND_WITH_IMM
)

405 
ps
->
s_tx»q
->
hdr_dwÜds
++;

409 
exŒa_by‹s
 = 
	`hfi1_g‘_16b_·ddšg
((
ps
->
s_tx»q
->
hdr_dwÜds
 << 2),

410 
wqe
->
Ëngth
);

411 
nwÜds
 = ((
wqe
->
Ëngth
 + 
exŒa_by‹s
 + 
SIZE_OF_LT
è>> 2è+ 
SIZE_OF_CRC
;

413 ià((
	`rdma_ah_g‘_ah_æags
(
ah_©Œ
è& 
IB_AH_GRH
) &&

414 
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
))) {

415 
ib_grh
 *
grh
;

416 
ib_glob®_rou‹
 *
grd
 = 
	`rdma_ah_»Œ›ve_grh
(
ah_©Œ
);

421 ià(
grd
->
sgid_šdex
 =ð
OPA_GID_INDEX
) {

422 
	`dd_dev_w¬n
(
µd
->
dd
, "Bad sgid_index. sgid_index: %d\n",

423 
grd
->
sgid_šdex
);

424 
grd
->
sgid_šdex
 = 0;

426 
grh
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
l
.grh;

427 
ps
->
s_tx»q
->
hdr_dwÜds
 +ð
	`hfi1_make_grh
(

428 
ibp
, 
grh
, 
grd
,

429 
ps
->
s_tx»q
->
hdr_dwÜds
 - 
LRH_16B_DWORDS
,

430 
nwÜds
);

431 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
l
.
Ùh
;

432 
l4
 = 
OPA_16B_L4_IB_GLOBAL
;

434 
ohdr
 = &
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
Ùh
;

435 
l4
 = 
OPA_16B_L4_IB_LOCAL
;

438 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(
ah_©Œ
)];

439 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_SMI
)

440 
´iv
->
s_sc
 = 0xf;

442 
´iv
->
s_sc
 = 
sc5
;

444 
dlid
 = 
	`Ýa_g‘_lid
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
), 16B);

445 ià(!
µd
->
lid
)

446 
¦id
 = 
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
);

448 
¦id
 = 
µd
->
lid
 | (
	`rdma_ah_g‘_·th_b™s
(
ah_©Œ
) &

449 ((1 << 
µd
->
lmc
) - 1));

451 ià(
is_mgmt
) {

452 
l4
 = 
OPA_16B_L4_FM
;

453 
pkey
 = 
	`hfi1_g‘_pkey
(
ibp
, 
	`rvt_g‘_swqe_pkey_šdex
(
wqe
));

454 
	`hfi1_16B_£t_q²
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
.
u
.
mgmt
,

455 
de¡_qp
, 
¤c_qp
);

457 
	`hfi1_make_bth_d‘h
(
qp
, 
wqe
, 
ohdr
, &
pkey
, 
exŒa_by‹s
, 
Œue
);

460 
Ën
 = (
ps
->
s_tx»q
->
hdr_dwÜds
 + 
nwÜds
) >> 1;

463 
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
 = 
HFI1_PKT_TYPE_16B
;

464 
	`hfi1_make_16b_hdr
(&
ps
->
s_tx»q
->
phdr
.
hdr
.
Ýah
,

465 
¦id
, 
dlid
, 
Ën
, 
pkey
, 0, 0, 
l4
, 
´iv
->
s_sc
);

466 
	}
}

476 
	$hfi1_make_ud_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
)

478 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

479 
rdma_ah_©Œ
 *
ah_©Œ
;

480 
hfi1_µÜtd©a
 *
µd
;

481 
hfi1_ibpÜt
 *
ibp
;

482 
rvt_swqe
 *
wqe
;

483 
Ãxt_cur
;

484 
u32
 
lid
;

486 
ps
->
s_tx»q
 = 
	`g‘_tx»q
Õs->
dev
, 
qp
);

487 ià(!
ps
->
s_tx»q
)

488 
baž_no_tx
;

490 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_NEXT_SEND_OK
)) {

491 ià(!(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_FLUSH_SEND
))

492 
baž
;

494 ià(
qp
->
s_Ï¡
 =ð
	`READ_ONCE
(qp->
s_h—d
))

495 
baž
;

497 ià(
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
)) {

498 
qp
->
s_æags
 |ð
RVT_S_WAIT_DMA
;

499 
baž
;

501 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_Ï¡
);

502 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_WR_FLUSH_ERR
);

503 
dÚe_ä“_tx
;

507 ià(
qp
->
s_cur
 =ð
	`READ_ONCE
(qp->
s_h—d
))

508 
baž
;

510 
wqe
 = 
	`rvt_g‘_swqe_±r
(
qp
, qp->
s_cur
);

511 
Ãxt_cur
 = 
qp
->
s_cur
 + 1;

512 ià(
Ãxt_cur
 >ð
qp
->
s_size
)

513 
Ãxt_cur
 = 0;

516 
ibp
 = 
	`to_Üt
(
qp
->
ibqp
.
deviû
, qp->
pÜt_num
);

517 
µd
 = 
	`µd_äom_ibp
(
ibp
);

518 
ah_©Œ
 = 
	`rvt_g‘_swqe_ah_©Œ
(
wqe
);

519 
´iv
->
hdr_ty³
 = 
	`hfi1_g‘_hdr_ty³
(
µd
->
lid
, 
ah_©Œ
);

520 ià((!
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
))) ||

521 (
	`rdma_ah_g‘_dlid
(
ah_©Œ
è=ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
))) {

522 
lid
 = 
	`rdma_ah_g‘_dlid
(
ah_©Œ
è& ~((1 << 
µd
->
lmc
) - 1);

523 ià(
	`uÆik–y
(!
loÝback
 &&

524 ((
lid
 =ð
µd
->lid) ||

525 ((
lid
 =ð
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
)) &&

526 (
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
))))) {

527 
tæags
 = 
ps
->
æags
;

535 ià(
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
)) {

536 
qp
->
s_æags
 |ð
RVT_S_WAIT_DMA
;

537 
baž
;

539 
qp
->
s_cur
 = 
Ãxt_cur
;

540 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
tæags
);

541 
	`ud_loÝback
(
qp
, 
wqe
);

542 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
tæags
);

543 
ps
->
æags
 = 
tæags
;

544 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
IB_WC_SUCCESS
);

545 
dÚe_ä“_tx
;

549 
qp
->
s_cur
 = 
Ãxt_cur
;

550 
ps
->
s_tx»q
->
s_cur_size
 = 
wqe
->
Ëngth
;

551 
ps
->
s_tx»q
->
ss
 = &
qp
->
s_sge
;

552 
qp
->
s_¤©e
 = 
	`rdma_ah_g‘_¡©ic_¿‹
(
ah_©Œ
);

553 
qp
->
¤©e_mbps
 = 
	`ib_¿‹_to_mbps
(qp->
s_¤©e
);

554 
qp
->
s_wqe
 = 
wqe
;

555 
qp
->
s_sge
.
sge
 = 
wqe
->
sg_li¡
[0];

556 
qp
->
s_sge
.
sg_li¡
 = 
wqe
->sg_list + 1;

557 
qp
->
s_sge
.
num_sge
 = 
wqe
->
wr
.num_sge;

558 
qp
->
s_sge
.
tÙ®_Ën
 = 
wqe
->
Ëngth
;

561 
hfi1_make_ud_»q_tbl
[
´iv
->
hdr_ty³
](
qp
, 
ps
, qp->
s_wqe
);

562 
´iv
->
s_sde
 = 
	`qp_to_sdma_’gše
(
qp
,…riv->
s_sc
);

563 
ps
->
s_tx»q
->
sde
 = 
´iv
->
s_sde
;

564 
´iv
->
s_£ndcÚ‹xt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
,…riv->
s_sc
);

565 
ps
->
s_tx»q
->
psc
 = 
´iv
->
s_£ndcÚ‹xt
;

567 
´iv
->
s_ahg
->
ahgcouÁ
 = 0;

568 
´iv
->
s_ahg
->
ahgidx
 = 0;

569 
´iv
->
s_ahg
->
tx_æags
 = 0;

573 
dÚe_ä“_tx
:

574 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

575 
ps
->
s_tx»q
 = 
NULL
;

578 
baž
:

579 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

581 
baž_no_tx
:

582 
ps
->
s_tx»q
 = 
NULL
;

583 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

585 
	}
}

596 
	$hfi1_lookup_pkey_idx
(
hfi1_ibpÜt
 *
ibp
, 
u16
 
pkey
)

598 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

599 
i
;

601 ià(
pkey
 =ð
FULL_MGMT_P_KEY
 ||…key =ð
LIM_MGMT_P_KEY
) {

602 
lim_idx
 = -1;

604 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); ++i) {

606 ià(
µd
->
pkeys
[
i
] =ð
pkey
)

607  
i
;

608 ià(
µd
->
pkeys
[
i
] =ð
LIM_MGMT_P_KEY
)

609 
lim_idx
 = 
i
;

613 ià(
pkey
 =ð
FULL_MGMT_P_KEY
)

614  
lim_idx
;

620 
pkey
 &= 0x7fff;

622 
i
 = 0; i < 
	`ARRAY_SIZE
(
µd
->
pkeys
); ++i)

623 ià((
µd
->
pkeys
[
i
] & 0x7fffè=ð
pkey
)

624  
i
;

630 
	}
}

632 
	$»tuº_úp_16B
(
hfi1_ibpÜt
 *
ibp
, 
rvt_qp
 *
qp
,

633 
u32
 
»mÙe_q²
, 
u16
 
pkey
, u32 
¦id
, u32 
dlid
,

634 
u8
 
sc5
, cÚ¡ 
ib_grh
 *
Þd_grh
)

636 
u64
 
pbc
, 
pbc_æags
 = 0;

637 
u32
 
bth0
, 
¶’
, 
vl
, 
hwÜds
 = 7;

638 
u16
 
Ën
;

639 
u8
 
l4
;

640 
hfi1_Ýa_h—d”
 
hdr
;

641 
ib_Ùh”_h—d”s
 *
ohdr
;

642 
pio_buf
 *
pbuf
;

643 
£nd_cÚ‹xt
 *
ùxt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
, 
sc5
);

644 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

645 
u32
 
nwÜds
;

647 
hdr
.
hdr_ty³
 = 
HFI1_PKT_TYPE_16B
;

649 
nwÜds
 = ((
	`hfi1_g‘_16b_·ddšg
(
hwÜds
 << 2, 0) +

650 
SIZE_OF_LT
è>> 2è+ 
SIZE_OF_CRC
;

651 ià(
Þd_grh
) {

652 
ib_grh
 *
grh
 = &
hdr
.
Ýah
.
u
.
l
.grh;

654 
grh
->
v”siÚ_tþass_æow
 = 
Þd_grh
->version_tclass_flow;

655 
grh
->
·yËn
 = 
	`ýu_to_be16
(

656 (
hwÜds
 - 
LRH_16B_DWORDS
 + 
nwÜds
) << 2);

657 
grh
->
hÝ_lim™
 = 0xff;

658 
grh
->
sgid
 = 
Þd_grh
->
dgid
;

659 
grh
->
dgid
 = 
Þd_grh
->
sgid
;

660 
ohdr
 = &
hdr
.
Ýah
.
u
.
l
.
Ùh
;

661 
l4
 = 
OPA_16B_L4_IB_GLOBAL
;

662 
hwÜds
 +ð(
ib_grh
è/ (
u32
);

664 
ohdr
 = &
hdr
.
Ýah
.
u
.
Ùh
;

665 
l4
 = 
OPA_16B_L4_IB_LOCAL
;

669 
bth0
 = (
IB_OPCODE_CNP
 << 24) | (1 << 16) |

670 (
	`hfi1_g‘_16b_·ddšg
(
hwÜds
 << 2, 0) << 20);

671 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

673 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
»mÙe_q²
);

674 
ohdr
->
bth
[2] = 0;

677 
Ën
 = (
hwÜds
 + 
nwÜds
) >> 1;

678 
	`hfi1_make_16b_hdr
(&
hdr
.
Ýah
, 
¦id
, 
dlid
, 
Ën
, 
pkey
, 1, 0, 
l4
, 
sc5
);

680 
¶’
 = 2 + 
hwÜds
 + 
nwÜds
;

681 
pbc_æags
 |ð
PBC_PACKET_BYPASS
 | 
PBC_INSERT_BYPASS_ICRC
;

682 
vl
 = 
	`sc_to_vÉ
(
µd
->
dd
, 
sc5
);

683 
pbc
 = 
	`ü—‹_pbc
(
µd
, 
pbc_æags
, 
qp
->
¤©e_mbps
, 
vl
, 
¶’
);

684 ià(
ùxt
) {

685 
pbuf
 = 
	`sc_bufãr_®loc
(
ùxt
, 
¶’
, 
NULL
, NULL);

686 ià(!
	`IS_ERR_OR_NULL
(
pbuf
)) {

687 
	`Œaû_pio_ouut_ibhdr
(
µd
->
dd
, &
hdr
, 
sc5
);

688 
µd
->
dd
->
	`pio_šlše_£nd
Õpd->dd, 
pbuf
, 
pbc
,

689 &
hdr
, 
hwÜds
);

692 
	}
}

694 
	$»tuº_úp
(
hfi1_ibpÜt
 *
ibp
, 
rvt_qp
 *
qp
, 
u32
 
»mÙe_q²
,

695 
u16
 
pkey
, 
u32
 
¦id
, u32 
dlid
, 
u8
 
sc5
,

696 cÚ¡ 
ib_grh
 *
Þd_grh
)

698 
u64
 
pbc
, 
pbc_æags
 = 0;

699 
u32
 
bth0
, 
¶’
, 
vl
, 
hwÜds
 = 5;

700 
u16
 
Ìh0
;

701 
u8
 
¦
 = 
ibp
->
sc_to_¦
[
sc5
];

702 
hfi1_Ýa_h—d”
 
hdr
;

703 
ib_Ùh”_h—d”s
 *
ohdr
;

704 
pio_buf
 *
pbuf
;

705 
£nd_cÚ‹xt
 *
ùxt
 = 
	`qp_to_£nd_cÚ‹xt
(
qp
, 
sc5
);

706 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

708 
hdr
.
hdr_ty³
 = 
HFI1_PKT_TYPE_9B
;

709 ià(
Þd_grh
) {

710 
ib_grh
 *
grh
 = &
hdr
.
ibh
.
u
.
l
.grh;

712 
grh
->
v”siÚ_tþass_æow
 = 
Þd_grh
->version_tclass_flow;

713 
grh
->
·yËn
 = 
	`ýu_to_be16
(

714 (
hwÜds
 - 
LRH_9B_DWORDS
 + 
SIZE_OF_CRC
) << 2);

715 
grh
->
hÝ_lim™
 = 0xff;

716 
grh
->
sgid
 = 
Þd_grh
->
dgid
;

717 
grh
->
dgid
 = 
Þd_grh
->
sgid
;

718 
ohdr
 = &
hdr
.
ibh
.
u
.
l
.
Ùh
;

719 
Ìh0
 = 
HFI1_LRH_GRH
;

720 
hwÜds
 +ð(
ib_grh
è/ (
u32
);

722 
ohdr
 = &
hdr
.
ibh
.
u
.
Ùh
;

723 
Ìh0
 = 
HFI1_LRH_BTH
;

726 
Ìh0
 |ð(
sc5
 & 0xfè<< 12 | 
¦
 << 4;

728 
bth0
 = (
u32
)
pkey
 | (
IB_OPCODE_CNP
 << 24);

729 
ohdr
->
bth
[0] = 
	`ýu_to_be32
(
bth0
);

731 
ohdr
->
bth
[1] = 
	`ýu_to_be32
(
»mÙe_q²
 | (1 << 
IB_BECN_SHIFT
));

732 
ohdr
->
bth
[2] = 0;

734 
	`hfi1_make_ib_hdr
(&
hdr
.
ibh
, 
Ìh0
, 
hwÜds
 + 
SIZE_OF_CRC
, 
dlid
, 
¦id
);

735 
¶’
 = 2 + 
hwÜds
;

736 
pbc_æags
 |ð(
	`ib_is_sc5
(
sc5
è<< 
PBC_DC_INFO_SHIFT
);

737 
vl
 = 
	`sc_to_vÉ
(
µd
->
dd
, 
sc5
);

738 
pbc
 = 
	`ü—‹_pbc
(
µd
, 
pbc_æags
, 
qp
->
¤©e_mbps
, 
vl
, 
¶’
);

739 ià(
ùxt
) {

740 
pbuf
 = 
	`sc_bufãr_®loc
(
ùxt
, 
¶’
, 
NULL
, NULL);

741 ià(!
	`IS_ERR_OR_NULL
(
pbuf
)) {

742 
	`Œaû_pio_ouut_ibhdr
(
µd
->
dd
, &
hdr
, 
sc5
);

743 
µd
->
dd
->
	`pio_šlše_£nd
Õpd->dd, 
pbuf
, 
pbc
,

744 &
hdr
, 
hwÜds
);

747 
	}
}

767 
	$Ýa_smp_check
(
hfi1_ibpÜt
 *
ibp
, 
u16
 
pkey
, 
u8
 
sc5
,

768 
rvt_qp
 *
qp
, 
u16
 
¦id
, 
Ýa_smp
 *
smp
)

770 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

776 ià(
sc5
 != 0xf)

779 ià(
	`rcv_pkey_check
(
µd
, 
pkey
, 
sc5
, 
¦id
))

787 ià(
smp
->
mgmt_þass
 !ð
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
 &&

788 
smp
->
mgmt_þass
 !ð
IB_MGMT_CLASS_SUBN_LID_ROUTED
) {

789 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
¦id
);

813 
smp
->
m‘hod
) {

814 
IB_MGMT_METHOD_GET_RESP
:

815 
IB_MGMT_METHOD_REPORT_RESP
:

817 
IB_MGMT_METHOD_GET
:

818 
IB_MGMT_METHOD_SET
:

819 
IB_MGMT_METHOD_REPORT
:

820 
IB_MGMT_METHOD_TRAP_REPRESS
:

821 ià(
pkey
 !ð
FULL_MGMT_P_KEY
) {

822 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
¦id
);

827 ià(
ibp
->
rvp
.
pÜt_ÿp_æags
 & 
IB_PORT_SM
)

829 ià(
smp
->
m‘hod
 =ð
IB_MGMT_METHOD_TRAP
)

831 ià(
pkey
 =ð
FULL_MGMT_P_KEY
) {

832 
smp
->
¡©us
 |ð
IB_SMP_UNSUP_METHOD
;

835 
	`šg»ss_pkey_bË_çž
(
µd
, 
pkey
, 
¦id
);

839 
	}
}

854 
	$hfi1_ud_rcv
(
hfi1_·ck‘
 *
·ck‘
)

856 
u32
 
hdrsize
 = 
·ck‘
->
hËn
;

857 
ib_wc
 
wc
;

858 
u32
 
¤c_qp
;

859 
u16
 
pkey
;

860 
mgmt_pkey_idx
 = -1;

861 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

862 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

863 *
d©a
 = 
·ck‘
->
·ylßd
;

864 
u32
 
Ž’
 = 
·ck‘
->tlen;

865 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

866 
u8
 
sc5
 = 
·ck‘
->
sc
;

867 
u8
 
¦_äom_sc
;

868 
u8
 
Ýcode
 = 
·ck‘
->opcode;

869 
u8
 
¦
 = 
·ck‘
->sl;

870 
u32
 
dlid
 = 
·ck‘
->dlid;

871 
u32
 
¦id
 = 
·ck‘
->slid;

872 
u8
 
exŒa_by‹s
;

873 
u8
 
l4
 = 0;

874 
boÞ
 
dlid_is_³rmissive
;

875 
boÞ
 
¦id_is_³rmissive
;

876 
boÞ
 
sÞic™ed
 = 
çl£
;

878 
exŒa_by‹s
 = 
·ck‘
->
·d
 +…ack‘->
exŒa_by‹
 + (
SIZE_OF_CRC
 << 2);

880 ià(
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

881 
u32
 
³rmissive_lid
 =

882 
	`Ýa_g‘_lid
(
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
), 16B);

884 
l4
 = 
	`hfi1_16B_g‘_l4
(
·ck‘
->
hdr
);

885 
pkey
 = 
	`hfi1_16B_g‘_pkey
(
·ck‘
->
hdr
);

886 
dlid_is_³rmissive
 = (
dlid
 =ð
³rmissive_lid
);

887 
¦id_is_³rmissive
 = (
¦id
 =ð
³rmissive_lid
);

889 
pkey
 = 
	`ib_bth_g‘_pkey
(
·ck‘
->
ohdr
);

890 
dlid_is_³rmissive
 = (
dlid
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
));

891 
¦id_is_³rmissive
 = (
¦id
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
));

893 
¦_äom_sc
 = 
ibp
->
sc_to_¦
[
sc5
];

895 ià(
	`lik–y
(
l4
 !ð
OPA_16B_L4_FM
)) {

896 
¤c_qp
 = 
	`ib_g‘_sq²
(
·ck‘
->
ohdr
);

897 
sÞic™ed
 = 
	`ib_bth_is_sÞic™ed
(
·ck‘
->
ohdr
);

899 
¤c_qp
 = 
	`hfi1_16B_g‘_¤c_q²
(
·ck‘
->
mgmt
);

902 
	`´oûss_eú
(
qp
, 
·ck‘
);

907 ià(
	`uÆik–y
(
Ž’
 < (
hdrsize
 + 
exŒa_by‹s
)))

908 
drÝ
;

910 
Ž’
 -ð
hdrsize
 + 
exŒa_by‹s
;

916 ià(
qp
->
ibqp
.
qp_num
) {

917 ià(
	`uÆik–y
(
dlid_is_³rmissive
 || 
¦id_is_³rmissive
))

918 
drÝ
;

919 ià(
qp
->
ibqp
.
qp_num
 > 1) {

920 ià(
	`uÆik–y
(
	`rcv_pkey_check
(
µd
, 
pkey
, 
sc5
, 
¦id
))) {

927 
	`hfi1_bad_pkey
(
ibp
,

928 
pkey
, 
¦
,

929 
¤c_qp
, 
qp
->
ibqp
.
qp_num
,

930 
¦id
, 
dlid
);

935 
mgmt_pkey_idx
 = 
	`hfi1_lookup_pkey_idx
(
ibp
, 
pkey
);

936 ià(
mgmt_pkey_idx
 < 0)

937 
drÝ
;

939 ià(
	`uÆik–y
(
l4
 !ð
OPA_16B_L4_FM
 &&

940 
	`ib_g‘_qkey
(
·ck‘
->
ohdr
è!ð
qp
->
qkey
))

944 ià(
	`uÆik–y
(
qp
->
ibqp
.
qp_num
 == 1 &&

945 (
Ž’
 > 2048 || (
sc5
 == 0xF))))

946 
drÝ
;

949 
Ýa_smp
 *
smp
 = (Ýa_sm°*)
d©a
;

951 ià(
	`Ýa_smp_check
(
ibp
, 
pkey
, 
sc5
, 
qp
, 
¦id
, 
smp
))

952 
drÝ
;

954 ià(
Ž’
 > 2048)

955 
drÝ
;

956 ià((
dlid_is_³rmissive
 || 
¦id_is_³rmissive
) &&

957 
smp
->
mgmt_þass
 !ð
IB_MGMT_CLASS_SUBN_DIRECTED_ROUTE
)

958 
drÝ
;

961 
mgmt_pkey_idx
 = 
	`hfi1_lookup_pkey_idx
(
ibp
, 
pkey
);

962 ià(
mgmt_pkey_idx
 < 0)

963 
drÝ
;

966 ià(
qp
->
ibqp
.
qp_num
 > 1 &&

967 
Ýcode
 =ð
IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
) {

968 
wc
.
ex
.
imm_d©a
 = 
·ck‘
->
ohdr
->
u
.
ud
.imm_data;

969 
wc
.
wc_æags
 = 
IB_WC_WITH_IMM
;

970 
Ž’
 -ð(
u32
);

971 } ià(
Ýcode
 =ð
IB_OPCODE_UD_SEND_ONLY
) {

972 
wc
.
ex
.
imm_d©a
 = 0;

973 
wc
.
wc_æags
 = 0;

975 
drÝ
;

982 
wc
.
by‹_Ën
 = 
Ž’
 + (
ib_grh
);

987 ià(
qp
->
r_æags
 & 
RVT_R_REUSE_SGE
) {

988 
qp
->
r_æags
 &ð~
RVT_R_REUSE_SGE
;

990 
»t
;

992 
»t
 = 
	`rvt_g‘_rwqe
(
qp
, 
çl£
);

993 ià(
»t
 < 0) {

994 
	`rvt_rc_”rÜ
(
qp
, 
IB_WC_LOC_QP_OP_ERR
);

997 ià(!
»t
) {

998 ià(
qp
->
ibqp
.
qp_num
 == 0)

999 
ibp
->
rvp
.
n_vl15_drÝ³d
++;

1004 ià(
	`uÆik–y
(
wc
.
by‹_Ën
 > 
qp
->
r_Ën
)) {

1005 
qp
->
r_æags
 |ð
RVT_R_REUSE_SGE
;

1006 
drÝ
;

1008 ià(
·ck‘
->
grh
) {

1009 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
·ck‘
->
grh
,

1010 (
ib_grh
), 
Œue
, 
çl£
);

1011 
wc
.
wc_æags
 |ð
IB_WC_GRH
;

1012 } ià(
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
) {

1013 
ib_grh
 
grh
;

1019 
	`hfi1_make_ext_grh
(
·ck‘
, &
grh
, 
¦id
, 
dlid
);

1020 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, &
grh
,

1021 (
ib_grh
), 
Œue
, 
çl£
);

1022 
wc
.
wc_æags
 |ð
IB_WC_GRH
;

1024 
	`rvt_sk_sge
(&
qp
->
r_sge
, (
ib_grh
), 
Œue
);

1026 
	`rvt_cÝy_sge
(
qp
, &qp->
r_sge
, 
d©a
, 
wc
.
by‹_Ën
 - (
ib_grh
),

1027 
Œue
, 
çl£
);

1028 
	`rvt_put_ss
(&
qp
->
r_sge
);

1029 ià(!
	`‹¡_ªd_þ—r_b™
(
RVT_R_WRID_VALID
, &
qp
->
r_aæags
))

1031 
wc
.
wr_id
 = 
qp
->
r_wr_id
;

1032 
wc
.
¡©us
 = 
IB_WC_SUCCESS
;

1033 
wc
.
Ýcode
 = 
IB_WC_RECV
;

1034 
wc
.
v’dÜ_”r
 = 0;

1035 
wc
.
qp
 = &qp->
ibqp
;

1036 
wc
.
¤c_qp
 = src_qp;

1038 ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_GSI
 ||

1039 
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_SMI
) {

1040 ià(
mgmt_pkey_idx
 < 0) {

1041 ià(
	`Ãt_¿‹lim™
()) {

1042 
hfi1_devd©a
 *
dd
 = 
µd
->dd;

1044 
	`dd_dev_”r
(
dd
, "QPype %d mgmt_pkey_idx < 0‡nd…acket‚ot dropped???\n",

1045 
qp
->
ibqp
.
qp_ty³
);

1046 
mgmt_pkey_idx
 = 0;

1049 
wc
.
pkey_šdex
 = ()
mgmt_pkey_idx
;

1051 
wc
.
pkey_šdex
 = 0;

1053 ià(
¦id_is_³rmissive
)

1054 
¦id
 = 
	`be32_to_ýu
(
OPA_LID_PERMISSIVE
);

1055 
wc
.
¦id
 = slid & 
U16_MAX
;

1056 
wc
.
¦
 = 
¦_äom_sc
;

1061 
wc
.
dlid_·th_b™s
 = 
	`hfi1_check_mÿ¡
(
dlid
) ? 0 :

1062 
dlid
 & ((1 << 
	`µd_äom_ibp
(
ibp
)->
lmc
) - 1);

1063 
wc
.
pÜt_num
 = 
qp
->port_num;

1065 
	`rvt_»cv_cq
(
qp
, &
wc
, 
sÞic™ed
);

1068 
drÝ
:

1069 
ibp
->
rvp
.
n_pkt_drÝs
++;

1070 
	}
}

	@user_exp_rcv.c

47 
	~<asm/·ge.h
>

48 
	~<lšux/¡ršg.h
>

50 
	~"u£r_exp_rcv.h
"

51 #ifdeà
NVIDIA_GPU_DIRECT


52 
	~"u£r_exp_rcv_gpu.h
"

54 
	~"Œaû.h
"

55 
	~"hfi.h
"

57 
uÆock_exp_tids
(
hfi1_ùxtd©a
 *
uùxt
,

58 
exp_tid_£t
 *
£t
,

59 
hfi1_fžed©a
 *
fd
);

60 
£t_rcv¬¿y_’Œy
(
hfi1_fžed©a
 *
fd
,

61 
tid_u£r_buf
 *
tbuf
,

62 
u32
 
rcv’Œy
, 
tid_group
 *
g½
,

63 
u16
 
·geidx
, 
Åages
);

64 
ÿch–ess_tid_rb_»move
(
hfi1_fžed©a
 *
fd©a
,

65 
tid_rb_node
 *
Šode
);

66 
tid_rb_»move
(*
¬g
, 
mmu_rb_node
 *
node
);

67 
tid_rb_šv®id©e
(*
¬g
, 
mmu_rb_node
 *
mnode
);

68 
´og¿m_rcv¬¿y
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *,

69 
tid_group
 *
g½
,

70 
¡¬t
, 
u16
 
couÁ
,

71 
u32
 *
tidli¡
, *
tididx
,

72 *
pm­³d
);

73 
uÅrog¿m_rcv¬¿y
(
hfi1_fžed©a
 *
fd
, 
u32
 
tidšfo
,

74 
tid_group
 **
g½
);

75 
þ—r_tid_node
(
hfi1_fžed©a
 *
fd
, 
tid_rb_node
 *
node
);

76 
u32
 
fšd_phys_blocks
(
·ge
 **
·ges
, 
Åages
,

77 
tid_·ge£t
 *
li¡
);

79 
mmu_rb_Ýs
 
	gtid_rb_Ýs
 = {

80 .
š£¹
 = 
tid_rb_š£¹
,

81 .
	g»move
 = 
tid_rb_»move
,

82 .
	gšv®id©e
 = 
tid_rb_šv®id©e


90 
	$hfi1_u£r_exp_rcv_š™
(
hfi1_fžed©a
 *
fd
,

91 
hfi1_ùxtd©a
 *
uùxt
)

93 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

94 
»t
 = 0;

96 
fd
->
’Œy_to_rb
 = 
	`kÿÎoc
(
uùxt
->
ex³ùed_couÁ
,

97 (
rb_node
 *),

98 
GFP_KERNEL
);

99 ià(!
fd
->
’Œy_to_rb
)

100  -
ENOMEM
;

102 ià(!
	`HFI1_CAP_UGET_MASK
(
uùxt
->
æags
, 
TID_UNMAP
)) {

103 
fd
->
šv®id_tid_idx
 = 0;

104 
fd
->
šv®id_tids
 = 
	`kÿÎoc
(
uùxt
->
ex³ùed_couÁ
,

105 (*
fd
->
šv®id_tids
),

106 
GFP_KERNEL
);

107 ià(!
fd
->
šv®id_tids
) {

108 
	`kä“
(
fd
->
’Œy_to_rb
);

109 
fd
->
’Œy_to_rb
 = 
NULL
;

110  -
ENOMEM
;

113 #ifdeà
NVIDIA_GPU_DIRECT


114 
»t
 = 
	`hfi1_mmu_rb_»gi¡”
(
fd
, 
NULL
, &
tid_rb_Ýs
,

115 
dd
->
µÜt
->
hfi1_wq
,

116 &
fd
->
hªdËr_gpu
);

117 ià(
»t
) {

118 
	`dd_dev_šfo
(
dd
,

120 
»t
);

121  
»t
;

128 
»t
 = 
	`hfi1_mmu_rb_»gi¡”
(
fd
, fd->
mm
, &
tid_rb_Ýs
,

129 
dd
->
µÜt
->
hfi1_wq
,

130 &
fd
->
hªdËr
);

131 ià(
»t
) {

132 
	`dd_dev_šfo
(
dd
,

134 
»t
);

135 
»t
 = 0;

136 #ifdeà
NVIDIA_GPU_DIRECT


137 
	`hfi1_mmu_rb_uÄegi¡”
(
fd
->
hªdËr_gpu
);

138 
fd
->
hªdËr_gpu
 = 
NULL
;

156 
	`¥š_lock
(&
fd
->
tid_lock
);

157 ià(
uùxt
->
subùxt_út
 && 
fd
->
hªdËr
) {

158 
u16
 
»mašd”
;

160 
fd
->
tid_lim™
 = 
uùxt
->
ex³ùed_couÁ
 / uùxt->
subùxt_út
;

161 
»mašd”
 = 
uùxt
->
ex³ùed_couÁ
 % uùxt->
subùxt_út
;

162 ià(
»mašd”
 && 
fd
->
subùxt
 <„emainder)

163 
fd
->
tid_lim™
++;

165 
fd
->
tid_lim™
 = 
uùxt
->
ex³ùed_couÁ
;

167 
	`¥š_uÆock
(&
fd
->
tid_lock
);

169  
»t
;

170 
	}
}

172 
	$hfi1_u£r_exp_rcv_ä“
(
hfi1_fžed©a
 *
fd
)

174 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

176 
	`mu‹x_lock
(&
uùxt
->
exp_mu‹x
);

181 ià(
fd
->
hªdËr
) {

182 
	`hfi1_mmu_rb_uÄegi¡”
(
fd
->
hªdËr
);

183 #ifdeà
NVIDIA_GPU_DIRECT


184 
	`hfi1_mmu_rb_uÄegi¡”
(
fd
->
hªdËr_gpu
);

187 ià(!
	`EXP_TID_SET_EMPTY
(
uùxt
->
tid_fuÎ_li¡
))

188 
	`uÆock_exp_tids
(
uùxt
, &uùxt->
tid_fuÎ_li¡
, 
fd
);

189 ià(!
	`EXP_TID_SET_EMPTY
(
uùxt
->
tid_u£d_li¡
))

190 
	`uÆock_exp_tids
(
uùxt
, &uùxt->
tid_u£d_li¡
, 
fd
);

192 
	`mu‹x_uÆock
(&
uùxt
->
exp_mu‹x
);

194 
	`kä“
(
fd
->
šv®id_tids
);

195 
fd
->
šv®id_tids
 = 
NULL
;

197 
	`kä“
(
fd
->
’Œy_to_rb
);

198 
fd
->
’Œy_to_rb
 = 
NULL
;

199 
	}
}

212 
	$uÅš_rcv_·ges
(
hfi1_fžed©a
 *
fd
,

213 
tid_u£r_buf
 *
tidbuf
,

214 
tid_rb_node
 *
node
,

215 
idx
,

216 
Åages
,

217 
boÞ
 
m­³d
)

219 
·ge
 **
·ges
;

220 
hfi1_devd©a
 *
dd
 = 
fd
->
uùxt
->dd;

222 ià(
m­³d
) {

223 
	`pci_unm­_sšgË
(
dd
->
pcidev
, 
node
->
dma_addr
,

224 
node
->
mmu
.
Ën
, 
PCI_DMA_FROMDEVICE
);

225 
·ges
 = &
node
->·ges[
idx
];

227 #ifdeà
NVIDIA_GPU_DIRECT


228 
·ges
 = &
tidbuf
->·ges.
ho¡
[
idx
];

230 
·ges
 = &
tidbuf
->·ges[
idx
];

233 
	`hfi1_»Ëa£_u£r_·ges
(
fd
->
mm
, 
·ges
, 
Åages
, 
m­³d
);

234 
fd
->
tid_n_pšÃd
 -ð
Åages
;

235 
	}
}

240 
	$pš_rcv_·ges
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tidbuf
)

242 
pšÃd
;

243 
Åages
;

244 
vaddr
 = 
tidbuf
->vaddr;

245 
·ge
 **
·ges
 = 
NULL
;

246 
hfi1_devd©a
 *
dd
 = 
fd
->
uùxt
->dd;

249 
Åages
 = 
	`num_u£r_·ges
(
vaddr
, 
tidbuf
->
Ëngth
);

250 ià(!
Åages
)

251  -
EINVAL
;

253 ià(
Åages
 > 
fd
->
uùxt
->
ex³ùed_couÁ
) {

254 
	`dd_dev_”r
(
dd
, "Expected bufferoo big\n");

255  -
EINVAL
;

259 ià(!
	`acûss_ok
((
__u£r
 *)
vaddr
,

260 
Åages
 * 
PAGE_SIZE
)) {

261 
	`dd_dev_”r
(
dd
, "Fail vaddr %p, %u…ages, !access_ok\n",

262 (*)
vaddr
, 
Åages
);

263  -
EFAULT
;

266 
·ges
 = 
	`kÿÎoc
(
Åages
, (*·ges), 
GFP_KERNEL
);

267 ià(!
·ges
)

268  -
ENOMEM
;

275 ià(!
	`hfi1_ÿn_pš_·ges
(
dd
, 
fd
->
mm
, fd->
tid_n_pšÃd
, 
Åages
)) {

276 
	`kä“
(
·ges
);

277  -
ENOMEM
;

280 
pšÃd
 = 
	`hfi1_acquœe_u£r_·ges
(
fd
->
mm
, 
vaddr
, 
Åages
, 
Œue
, 
·ges
);

281 ià(
pšÃd
 <= 0) {

282 
	`kä“
(
·ges
);

283  
pšÃd
;

285 #ifdeà
NVIDIA_GPU_DIRECT


286 
tidbuf
->
·ges
.
ho¡
 =…ages;

288 
tidbuf
->
·ges
 =…ages;

290 
tidbuf
->
Åages
 =‚pages;

291 
fd
->
tid_n_pšÃd
 +ð
pšÃd
;

292  
pšÃd
;

293 
	}
}

344 
hfi1_u£r_exp_rcv_£tup
(
hfi1_fžed©a
 *
fd
,

345 #iâdeà
NVIDIA_GPU_DIRECT


346 
hfi1_tid_šfo
 *
tšfo
)

348 
hfi1_tid_šfo_v2
 *
	gtšfo
)

351 
	g»t
 = 0, 
	gÃed_group
 = 0, 
	gpšÃd
;

352 
hfi1_ùxtd©a
 *
	guùxt
 = 
fd
->
uùxt
;

353 
hfi1_devd©a
 *
	gdd
 = 
uùxt
->
dd
;

354 
	gngroups
, 
	g·geidx
 = 0, 
	g·ge£t_couÁ
,

355 
	gtididx
 = 0, 
	gm­³d
, 
	gm­³d_·ges
 = 0;

356 
u32
 *
	gtidli¡
 = 
NULL
;

357 
tid_u£r_buf
 *
	gtidbuf
;

359 ià(!
PAGE_ALIGNED
(
tšfo
->
vaddr
))

360  -
	gEINVAL
;

362 
	gtidbuf
 = 
kz®loc
((*
tidbuf
), 
GFP_KERNEL
);

363 ià(!
	gtidbuf
)

364  -
	gENOMEM
;

366 
	gtidbuf
->
	gvaddr
 = 
tšfo
->
vaddr
;

367 
	gtidbuf
->
	gËngth
 = 
tšfo
->
Ëngth
;

368 
	gtidbuf
->
	gp£ts
 = 
kÿÎoc
(
uùxt
->
ex³ùed_couÁ
, (*
tidbuf
->
p£ts
),

369 
GFP_KERNEL
);

370 ià(!
	gtidbuf
->
	gp£ts
) {

371 
kä“
(
tidbuf
);

372  -
	gENOMEM
;

375 #ifdeà
NVIDIA_GPU_DIRECT


376 
	gtidbuf
->
	gÚgpu
 = (
boÞ
)(
tšfo
->
æags
 & 
HFI1_BUF_GPU_MEM
);

377 ià(
	gtidbuf
->
	gÚgpu
)

378 
	gtidbuf
->
	ghªdËr
 = 
fd
->
hªdËr_gpu
;

380 
	gtidbuf
->
	ghªdËr
 = 
fd
->
hªdËr
;

382 ià(
	gtidbuf
->
	gÚgpu
)

383 
	gpšÃd
 = 
pš_rcv_·ges_gpu
(
fd
, 
tidbuf
);

386 
	gpšÃd
 = 
pš_rcv_·ges
(
fd
, 
tidbuf
);

387 ià(
	gpšÃd
 <= 0) {

388 
kä“
(
tidbuf
->
p£ts
);

389 
kä“
(
tidbuf
);

390  
	gpšÃd
;

394 #ifdeà
NVIDIA_GPU_DIRECT


395 ià(
	gtidbuf
->
	gÚgpu
)

396 
	gtidbuf
->
	gn_p£ts
 = 
fšd_phys_blocks_gpu
(
tidbuf
);

398 
	gtidbuf
->
	gn_p£ts
 = 
fšd_phys_blocks
(
tidbuf
->
·ges
.
ho¡
, 
pšÃd
,

399 
tidbuf
->
p£ts
);

401 
	gtidbuf
->
	gn_p£ts
 = 
fšd_phys_blocks
(
tidbuf
->
·ges
, 
pšÃd
,

402 
tidbuf
->
p£ts
);

410 
¥š_lock
(&
fd
->
tid_lock
);

411 ià(
	gfd
->
	gtid_u£d
 + 
	gtidbuf
->
	gn_p£ts
 > fd->
	gtid_lim™
)

412 
	g·ge£t_couÁ
 = 
fd
->
tid_lim™
 - fd->
tid_u£d
;

414 
	g·ge£t_couÁ
 = 
tidbuf
->
n_p£ts
;

415 
¥š_uÆock
(&
fd
->
tid_lock
);

417 ià(!
	g·ge£t_couÁ
)

418 
	gbaž
;

420 
	gngroups
 = 
·ge£t_couÁ
 / 
dd
->
rcv_’Œ›s
.
group_size
;

421 
	gtidli¡
 = 
kÿÎoc
(
·ge£t_couÁ
, (*
tidli¡
), 
GFP_KERNEL
);

422 ià(!
	gtidli¡
) {

423 
	g»t
 = -
ENOMEM
;

424 
	gnomem
;

427 
	gtididx
 = 0;

433 
mu‹x_lock
(&
uùxt
->
exp_mu‹x
);

438 
	gngroups
 && 
	guùxt
->
	gtid_group_li¡
.
	gcouÁ
) {

439 
tid_group
 *
	gg½
 =

440 
tid_group_pÝ
(&
uùxt
->
tid_group_li¡
);

442 
	g»t
 = 
´og¿m_rcv¬¿y
(
fd
, 
tidbuf
, 
g½
,

443 
·geidx
, 
dd
->
rcv_’Œ›s
.
group_size
,

444 
tidli¡
, &
tididx
, &
m­³d
);

450 ià(
	g»t
 <= 0) {

451 
tid_group_add_ž
(
g½
, &
uùxt
->
tid_group_li¡
);

452 
hfi1_cdbg
(
TID
,

453 "FažedØ´og¿m RcvA¼ay grou°%d", 
»t
);

454 
	guÆock
;

457 
tid_group_add_ž
(
g½
, &
uùxt
->
tid_fuÎ_li¡
);

458 
	gngroups
--;

459 
	g·geidx
 +ð
»t
;

460 
	gm­³d_·ges
 +ð
m­³d
;

463 
	g·geidx
 < 
	g·ge£t_couÁ
) {

464 
tid_group
 *
	gg½
, *
	g±r
;

470 ià(!
	guùxt
->
	gtid_u£d_li¡
.
	gcouÁ
 || 
	gÃed_group
) {

471 ià(!
	guùxt
->
	gtid_group_li¡
.
	gcouÁ
)

472 
	guÆock
;

474 
	gg½
 = 
tid_group_pÝ
(&
uùxt
->
tid_group_li¡
);

475 
tid_group_add_ž
(
g½
, &
uùxt
->
tid_u£d_li¡
);

476 
	gÃed_group
 = 0;

483 
li¡_fÜ_—ch_’Œy_§ã
(
g½
, 
±r
, &
uùxt
->
tid_u£d_li¡
.
li¡
,

484 
li¡
) {

485 
	gu£
 = 
mš_t
(, 
·ge£t_couÁ
 - 
·geidx
,

486 
g½
->
size
 - g½->
u£d
);

488 
	g»t
 = 
´og¿m_rcv¬¿y
(
fd
, 
tidbuf
, 
g½
,

489 
·geidx
, 
u£
, 
tidli¡
,

490 &
tididx
, &
m­³d
);

491 ià(
	g»t
 < 0) {

492 
hfi1_cdbg
(
TID
,

494 
»t
);

495 
	guÆock
;

496 } ià(
	g»t
 > 0) {

497 ià(
	gg½
->
	gu£d
 =ð
g½
->
size
)

498 
tid_group_move
(
g½
,

499 &
uùxt
->
tid_u£d_li¡
,

500 &
uùxt
->
tid_fuÎ_li¡
);

501 
	g·geidx
 +ð
»t
;

502 
	gm­³d_·ges
 +ð
m­³d
;

503 
	gÃed_group
 = 0;

505 ià(
	g·geidx
 >ð
·ge£t_couÁ
)

507 } ià(
WARN_ON
(
»t
 == 0)) {

514 
Ãed_group
 = 1;

518 
	guÆock
:

519 
mu‹x_uÆock
(&
uùxt
->
exp_mu‹x
);

520 
	gnomem
:

521 
hfi1_cdbg
(
TID
, "tÙ® m­³d:id·œs:%u…ages:%u (%d)", 
tididx
,

522 
m­³d_·ges
, 
»t
);

523 ià(
	gtididx
) {

524 
¥š_lock
(&
fd
->
tid_lock
);

525 
	gfd
->
	gtid_u£d
 +ð
tididx
;

526 
¥š_uÆock
(&
fd
->
tid_lock
);

527 
	gtšfo
->
	gtidút
 = 
tididx
;

528 #ifdeà
NVIDIA_GPU_DIRECT


529 ià(
	gtidbuf
->
	gÚgpu
)

530 
	gtšfo
->
	gËngth
 = 
m­³d_·ges
 * 
NV_GPU_PAGE_SIZE
;

533 
	gtšfo
->
	gËngth
 = 
m­³d_·ges
 * 
PAGE_SIZE
;

535 ià(
cÝy_to_u£r
(
u64_to_u£r_±r
(
tšfo
->
tidli¡
),

536 
tidli¡
, Ñidli¡[0]è* 
tididx
)) {

541 
	gtšfo
->
	gtidli¡
 = ()&
tidli¡
;

542 
hfi1_u£r_exp_rcv_þ—r
(
fd
,

543 (
hfi1_tid_šfo
 *)
tšfo
);

544 
	gtšfo
->
	gtidli¡
 = 0;

545 
	g»t
 = -
EFAULT
;

546 
	gbaž
;

556 #ifdeà
NVIDIA_GPU_DIRECT


557 ià(
	gm­³d_·ges
 !ð
pšÃd
 && !
tidbuf
->
Úgpu
)

559 ià(
m­³d_·ges
 !ð
pšÃd
)

561 
uÅš_rcv_·ges
(
fd
, 
tidbuf
, 
NULL
, 
m­³d_·ges
,

562 (
pšÃd
 - 
m­³d_·ges
), 
çl£
);

563 
	gbaž
:

564 
kä“
(
tidbuf
->
p£ts
);

565 
kä“
(
tidli¡
);

566 #iâdeà
NVIDIA_GPU_DIRECT


567 
kä“
(
tidbuf
->
·ges
);

568 
kä“
(
tidbuf
);

570 ià(!
	gtidbuf
->
	gÚgpu
) {

571 
kä“
(
tidbuf
->
·ges
.
ho¡
);

572 } ià((
	g»t
 < 0è&& 
	gtidbuf
->
	g·ges
.
	ggpu
) {

573 
Œaû_ä“_»cv_gpu_·ges
(
tidbuf
->
vaddr
);

574 
put_gpu_·ges
(
tidbuf
->
vaddr
,idbuf->
·ges
.
gpu
);

575 
	gfd
->
	gtid_n_gpu_pšÃd
 -ð
tidbuf
->
·ges
.
gpu
->
’Œ›s
;

581 ià(!
	gtidbuf
->
	gÚgpu
 || 
	g»t
 < 0)

582 
kä“
(
tidbuf
);

584  
	g»t
 > 0 ? 0 : 
»t
;

587 
	$hfi1_u£r_exp_rcv_þ—r
(
hfi1_fžed©a
 *
fd
,

588 
hfi1_tid_šfo
 *
tšfo
)

590 
»t
 = 0;

591 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

592 
u32
 *
tidšfo
;

593 
tididx
;

595 ià(
	`uÆik–y
(
tšfo
->
tidút
 > 
fd
->
tid_u£d
))

596  -
EINVAL
;

598 
tidšfo
 = 
	`memdup_u£r
(
	`u64_to_u£r_±r
(
tšfo
->
tidli¡
),

599 (
tidšfo
[0]è* 
tšfo
->
tidút
);

600 ià(
	`IS_ERR
(
tidšfo
))

601  
	`PTR_ERR
(
tidšfo
);

603 
	`mu‹x_lock
(&
uùxt
->
exp_mu‹x
);

604 
tididx
 = 0;ididx < 
tšfo
->
tidút
;ididx++) {

605 
»t
 = 
	`uÅrog¿m_rcv¬¿y
(
fd
, 
tidšfo
[
tididx
], 
NULL
);

606 ià(
»t
) {

607 
	`hfi1_cdbg
(
TID
, "Failedo unprogram„cv‡rray %d",

608 
»t
);

612 
	`¥š_lock
(&
fd
->
tid_lock
);

613 
fd
->
tid_u£d
 -ð
tididx
;

614 
	`¥š_uÆock
(&
fd
->
tid_lock
);

615 
tšfo
->
tidút
 = 
tididx
;

616 
	`mu‹x_uÆock
(&
uùxt
->
exp_mu‹x
);

618 
	`kä“
(
tidšfo
);

619  
»t
;

620 
	}
}

622 
	$hfi1_u£r_exp_rcv_šv®id
(
hfi1_fžed©a
 *
fd
,

623 
hfi1_tid_šfo
 *
tšfo
)

625 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

626 *
ev
 = 
uùxt
->
dd
->
ev’ts
 +

627 (
	`uùxt_off£t
(
uùxt
è+ 
fd
->
subùxt
);

628 
u32
 *
¬¿y
;

629 
»t
 = 0;

637 
¬¿y
 = 
	`kÿÎoc
(
uùxt
->
ex³ùed_couÁ
, (*¬¿y), 
GFP_KERNEL
);

638 ià(!
¬¿y
)

639  -
EFAULT
;

641 
	`¥š_lock
(&
fd
->
šv®id_lock
);

642 ià(
fd
->
šv®id_tid_idx
) {

643 
	`memýy
(
¬¿y
, 
fd
->
šv®id_tids
, (*array) *

644 
fd
->
šv®id_tid_idx
);

645 
	`mem£t
(
fd
->
šv®id_tids
, 0, (*fd->invalid_tids) *

646 
fd
->
šv®id_tid_idx
);

647 
tšfo
->
tidút
 = 
fd
->
šv®id_tid_idx
;

648 
fd
->
šv®id_tid_idx
 = 0;

653 
	`þ—r_b™
(
_HFI1_EVENT_TID_MMU_NOTIFY_BIT
, 
ev
);

655 
tšfo
->
tidút
 = 0;

657 
	`¥š_uÆock
(&
fd
->
šv®id_lock
);

659 ià(
tšfo
->
tidút
) {

660 ià(
	`cÝy_to_u£r
((
__u£r
 *)
tšfo
->
tidli¡
,

661 
¬¿y
, (*¬¿yè* 
tšfo
->
tidút
))

662 
»t
 = -
EFAULT
;

664 
	`kä“
(
¬¿y
);

666  
»t
;

667 
	}
}

669 
u32
 
	$fšd_phys_blocks
(
·ge
 **
·ges
, 
Åages
,

670 
tid_·ge£t
 *
li¡
)

672 
·gecouÁ
, 
·geidx
, 
£tcouÁ
 = 0, 
i
;

673 
pâ
, 
this_pâ
;

675 ià(!
Åages
)

683 
pâ
 = 
	`·ge_to_pâ
(
·ges
[0]);

684 
·geidx
 = 0, 
·gecouÁ
 = 1, 
i
 = 1; i <ð
Åages
; i++) {

685 
this_pâ
 = 
i
 < 
Åages
 ? 
	`·ge_to_pâ
(
·ges
[i]) : 0;

691 ià(
this_pâ
 !ð++
pâ
) {

704 
·gecouÁ
) {

705 
max·ges
 = 
·gecouÁ
;

706 
u32
 
bufsize
 = 
·gecouÁ
 * 
PAGE_SIZE
;

708 ià(
bufsize
 > 
MAX_EXPECTED_BUFFER
)

709 
max·ges
 =

710 
MAX_EXPECTED_BUFFER
 >>

711 
PAGE_SHIFT
;

712 ià(!
	`is_pow”_of_2
(
bufsize
))

713 
max·ges
 =

714 
	`rounddown_pow_of_two
(
bufsize
) >>

715 
PAGE_SHIFT
;

717 
li¡
[
£tcouÁ
].
idx
 = 
·geidx
;

718 
li¡
[
£tcouÁ
].
couÁ
 = 
max·ges
;

719 
·gecouÁ
 -ð
max·ges
;

720 
·geidx
 +ð
max·ges
;

721 
£tcouÁ
++;

723 
·geidx
 = 
i
;

724 
·gecouÁ
 = 1;

725 
pâ
 = 
this_pâ
;

727 
·gecouÁ
++;

730  
£tcouÁ
;

731 
	}
}

760 
	$´og¿m_rcv¬¿y
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tbuf
,

761 
tid_group
 *
g½
,

762 
¡¬t
, 
u16
 
couÁ
,

763 
u32
 *
tidli¡
, *
tididx
,

764 *
pm­³d
)

766 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

767 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

768 
u16
 
idx
;

769 
u32
 
tidšfo
 = 0, 
rcv’Œy
, 
u£idx
 = 0;

770 
m­³d
 = 0;

773 ià(
couÁ
 > 
g½
->
size
)

774  -
EINVAL
;

777 
idx
 = 0; idx < 
g½
->
size
; idx++) {

778 ià(!(
g½
->
m­
 & (1 << 
idx
))) {

779 
u£idx
 = 
idx
;

782 
	`rcv_¬¿y_wc_fžl
(
dd
, 
g½
->
ba£
 + 
idx
);

785 
idx
 = 0;

786 
idx
 < 
couÁ
) {

787 
u16
 
Åages
, 
·geidx
, 
£tidx
 = 
¡¬t
 + 
idx
;

788 
»t
 = 0;

794 ià(
u£idx
 >ð
g½
->
size
) {

796 } ià(
g½
->
m­
 & (1 << 
u£idx
)) {

797 
	`rcv_¬¿y_wc_fžl
(
dd
, 
g½
->
ba£
 + 
u£idx
);

798 
u£idx
++;

802 
rcv’Œy
 = 
g½
->
ba£
 + 
u£idx
;

803 
Åages
 = 
tbuf
->
p£ts
[
£tidx
].
couÁ
;

804 
·geidx
 = 
tbuf
->
p£ts
[
£tidx
].
idx
;

806 #ifdeà
NVIDIA_GPU_DIRECT


807 ià(
tbuf
->
Úgpu
)

808 
»t
 = 
	`£t_rcv¬¿y_’Œy_gpu
(
fd
, 
tbuf
,

809 
rcv’Œy
, 
g½
, 
·geidx
,

810 
Åages
);

813 
»t
 = 
	`£t_rcv¬¿y_’Œy
(
fd
, 
tbuf
,

814 
rcv’Œy
, 
g½
, 
·geidx
,

815 
Åages
);

816 ià(
»t
)

817  
»t
;

818 
m­³d
 +ð
Åages
;

820 #ifdeà
NVIDIA_GPU_DIRECT


825 ià(
tbuf
->
Úgpu
)

826 
tidšfo
 = 
	`rcv’Œy2tidšfo
(
rcv’Œy
 - 
uùxt
->
ex³ùed_ba£
) |

827 
	`EXP_TID_SET
(
LEN
, 
Åages
 * (
NV_GPU_PAGE_SIZE
 / 
PAGE_SIZE
));

830 
tidšfo
 = 
	`rcv’Œy2tidšfo
(
rcv’Œy
 - 
uùxt
->
ex³ùed_ba£
) |

831 
	`EXP_TID_SET
(
LEN
, 
Åages
);

832 
tidli¡
[(*
tididx
)++] = 
tidšfo
;

833 
g½
->
u£d
++;

834 
g½
->
m­
 |ð1 << 
u£idx
++;

835 
idx
++;

839 ; 
u£idx
 < 
g½
->
size
; useidx++)

840 
	`rcv_¬¿y_wc_fžl
(
dd
, 
g½
->
ba£
 + 
u£idx
);

841 *
pm­³d
 = 
m­³d
;

842  
idx
;

843 
	}
}

845 
	$£t_rcv¬¿y_’Œy
(
hfi1_fžed©a
 *
fd
,

846 
tid_u£r_buf
 *
tbuf
,

847 
u32
 
rcv’Œy
, 
tid_group
 *
g½
,

848 
u16
 
·geidx
, 
Åages
)

850 
»t
;

851 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

852 
tid_rb_node
 *
node
;

853 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

854 
dma_addr_t
 
phys
;

855 #ifdeà
NVIDIA_GPU_DIRECT


856 
·ge
 **
·ges
 = 
tbuf
->·ges.
ho¡
 + 
·geidx
;

858 
·ge
 **
·ges
 = 
tbuf
->·ge + 
·geidx
;

865 
node
 = 
	`kz®loc
((*nodeè+ ((
·ge
 *è* 
Åages
),

866 
GFP_KERNEL
);

867 ià(!
node
)

868  -
ENOMEM
;

870 
phys
 = 
	`pci_m­_sšgË
(
dd
->
pcidev
,

871 
	`__va
(
	`·ge_to_phys
(
·ges
[0])),

872 
Åages
 * 
PAGE_SIZE
, 
PCI_DMA_FROMDEVICE
);

873 ià(
	`dma_m­pšg_”rÜ
(&
dd
->
pcidev
->
dev
, 
phys
)) {

874 
	`dd_dev_”r
(
dd
, "Failedo DMA map Exp Rcv…ages 0x%llx\n",

875 
phys
);

876 
	`kä“
(
node
);

877  -
EFAULT
;

880 
node
->
mmu
.
addr
 = 
tbuf
->
vaddr
 + (
·geidx
 * 
PAGE_SIZE
);

881 
node
->
mmu
.
Ën
 = 
Åages
 * 
PAGE_SIZE
;

882 
node
->
phys
 = 
	`·ge_to_phys
(
·ges
[0]);

883 
node
->
Åages
 =‚pages;

884 
node
->
rcv’Œy
 =„cventry;

885 
node
->
dma_addr
 = 
phys
;

886 
node
->
g½
 = grp;

887 
node
->
ä“d
 = 
çl£
;

888 
	`memýy
(
node
->
·ges
,…ages, (
·ge
 *è* 
Åages
);

889 #ifdeà
NVIDIA_GPU_DIRECT


890 
node
->
Úgpu
 = 
tbuf
->ongpu;

893 ià(!
fd
->
hªdËr
)

894 
»t
 = 
	`tid_rb_š£¹
(
fd
, &
node
->
mmu
);

896 
»t
 = 
	`hfi1_mmu_rb_š£¹
(
fd
->
hªdËr
, &
node
->
mmu
);

898 ià(
»t
) {

899 
	`hfi1_cdbg
(
TID
, "Failedo insert RB‚ode %u 0x%lx, 0x%lx %d",

900 
node
->
rcv’Œy
,‚ode->
mmu
.
addr
,‚ode->
phys
, 
»t
);

901 
	`pci_unm­_sšgË
(
dd
->
pcidev
, 
phys
, 
Åages
 * 
PAGE_SIZE
,

902 
PCI_DMA_FROMDEVICE
);

903 
	`kä“
(
node
);

904  -
EFAULT
;

906 
	`hfi1_put_tid
(
dd
, 
rcv’Œy
, 
PT_EXPECTED
, 
phys
, 
	`žog2
(
Åages
) + 1);

907 
	`Œaû_hfi1_exp_tid_»g
(
uùxt
->
ùxt
, 
fd
->
subùxt
, 
rcv’Œy
, 
Åages
,

908 
node
->
mmu
.
addr
,‚ode->
phys
,…hys);

910 
	}
}

912 
	$uÅrog¿m_rcv¬¿y
(
hfi1_fžed©a
 *
fd
, 
u32
 
tidšfo
,

913 
tid_group
 **
g½
)

915 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

916 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

917 
tid_rb_node
 *
node
;

918 
u8
 
tidù¾
 = 
	`EXP_TID_GET
(
tidšfo
, 
CTRL
);

919 
u32
 
tididx
 = 
	`EXP_TID_GET
(
tidšfo
, 
IDX
è<< 1, 
rcv’Œy
;

921 ià(
tididx
 >ð
uùxt
->
ex³ùed_couÁ
) {

922 
	`dd_dev_”r
(
dd
, "Invalid RcvArrayƒntry (%u) index for ctxt %u\n",

923 
tididx
, 
uùxt
->
ùxt
);

924  -
EINVAL
;

927 ià(
tidù¾
 == 0x3)

928  -
EINVAL
;

930 
rcv’Œy
 = 
tididx
 + (
tidù¾
 - 1);

932 
node
 = 
fd
->
’Œy_to_rb
[
rcv’Œy
];

933 ià(!
node
 ||‚ode->
rcv’Œy
 !ð(
uùxt
->
ex³ùed_ba£
 +„cventry))

934  -
EBADF
;

936 ià(
g½
)

937 *
g½
 = 
node
->grp;

939 ià(!
fd
->
hªdËr
)

940 
	`ÿch–ess_tid_rb_»move
(
fd
, 
node
);

942 #ifdeà
NVIDIA_GPU_DIRECT


943 ià(
node
->
Úgpu
)

944 
	`hfi1_mmu_rb_»move
(
fd
->
hªdËr_gpu
, &
node
->
mmu
);

947 
	`hfi1_mmu_rb_»move
(
fd
->
hªdËr
, &
node
->
mmu
);

949 
	}
}

951 
	$þ—r_tid_node
(
hfi1_fžed©a
 *
fd
, 
tid_rb_node
 *
node
)

953 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

954 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

956 
	`Œaû_hfi1_exp_tid_uÄeg
(
uùxt
->
ùxt
, 
fd
->
subùxt
, 
node
->
rcv’Œy
,

957 
node
->
Åages
,‚ode->
mmu
.
addr
,‚ode->
phys
,

958 
node
->
dma_addr
);

964 
	`hfi1_put_tid
(
dd
, 
node
->
rcv’Œy
, 
PT_INVALID_FLUSH
, 0, 0);

966 #ifdeà
NVIDIA_GPU_DIRECT


967 ià(
node
->
Úgpu
)

968 
	`uÅš_rcv_·ges_gpu
(
fd
, 
node
);

971 
	`uÅš_rcv_·ges
(
fd
, 
NULL
, 
node
, 0,‚ode->
Åages
, 
Œue
);

973 
node
->
g½
->
u£d
--;

974 
node
->
g½
->
m­
 &ð~(1 << (node->
rcv’Œy
 -‚ode->g½->
ba£
));

976 ià(
node
->
g½
->
u£d
 =ðnode->g½->
size
 - 1)

977 
	`tid_group_move
(
node
->
g½
, &
uùxt
->
tid_fuÎ_li¡
,

978 &
uùxt
->
tid_u£d_li¡
);

979 ià(!
node
->
g½
->
u£d
)

980 
	`tid_group_move
(
node
->
g½
, &
uùxt
->
tid_u£d_li¡
,

981 &
uùxt
->
tid_group_li¡
);

982 
	`kä“
(
node
);

983 
	}
}

989 
	$uÆock_exp_tids
(
hfi1_ùxtd©a
 *
uùxt
,

990 
exp_tid_£t
 *
£t
,

991 
hfi1_fžed©a
 *
fd
)

993 
tid_group
 *
g½
, *
±r
;

994 
i
;

996 
	`li¡_fÜ_—ch_’Œy_§ã
(
g½
, 
±r
, &
£t
->
li¡
,†ist) {

997 
	`li¡_d–_š™
(&
g½
->
li¡
);

999 
i
 = 0; i < 
g½
->
size
; i++) {

1000 ià(
g½
->
m­
 & (1 << 
i
)) {

1001 
u16
 
rcv’Œy
 = 
g½
->
ba£
 + 
i
;

1002 
tid_rb_node
 *
node
;

1004 
node
 = 
fd
->
’Œy_to_rb
[
rcv’Œy
 -

1005 
uùxt
->
ex³ùed_ba£
];

1006 ià(!
node
 ||‚ode->
rcv’Œy
 !=„cventry)

1009 
	`ÿch–ess_tid_rb_»move
(
fd
, 
node
);

1013 
	}
}

1022 
	$tid_rb_šv®id©e
(*
¬g
, 
mmu_rb_node
 *
mnode
)

1024 
hfi1_fžed©a
 *
fd©a
 = 
¬g
;

1025 
hfi1_ùxtd©a
 *
uùxt
 = 
fd©a
->uctxt;

1026 
tid_rb_node
 *
node
 =

1027 
	`cÚš”_of
(
mnode
, 
tid_rb_node
, 
mmu
);

1029 ià(
node
->
ä“d
)

1032 
	`Œaû_hfi1_exp_tid_šv®
(
uùxt
->
ùxt
, 
fd©a
->
subùxt
, 
node
->
mmu
.
addr
,

1033 
node
->
rcv’Œy
,‚ode->
Åages
,‚ode->
dma_addr
);

1034 
node
->
ä“d
 = 
Œue
;

1036 
	`¥š_lock
(&
fd©a
->
šv®id_lock
);

1037 ià(
fd©a
->
šv®id_tid_idx
 < 
uùxt
->
ex³ùed_couÁ
) {

1038 
fd©a
->
šv®id_tids
[fd©a->
šv®id_tid_idx
] =

1039 
	`rcv’Œy2tidšfo
(
node
->
rcv’Œy
 - 
uùxt
->
ex³ùed_ba£
);

1040 
fd©a
->
šv®id_tids
[fd©a->
šv®id_tid_idx
] |=

1041 
	`EXP_TID_SET
(
LEN
, 
node
->
Åages
);

1042 ià(!
fd©a
->
šv®id_tid_idx
) {

1043 *
ev
;

1054 
ev
 = 
uùxt
->
dd
->
ev’ts
 +

1055 (
	`uùxt_off£t
(
uùxt
è+ 
fd©a
->
subùxt
);

1056 
	`£t_b™
(
_HFI1_EVENT_TID_MMU_NOTIFY_BIT
, 
ev
);

1058 
fd©a
->
šv®id_tid_idx
++;

1060 
	`¥š_uÆock
(&
fd©a
->
šv®id_lock
);

1062 
	}
}

1064 
	$tid_rb_š£¹
(*
¬g
, 
mmu_rb_node
 *
node
)

1066 
hfi1_fžed©a
 *
fd©a
 = 
¬g
;

1067 
tid_rb_node
 *
Šode
 =

1068 
	`cÚš”_of
(
node
, 
tid_rb_node
, 
mmu
);

1069 
u32
 
ba£
 = 
fd©a
->
uùxt
->
ex³ùed_ba£
;

1071 
fd©a
->
’Œy_to_rb
[
Šode
->
rcv’Œy
 - 
ba£
] =node;

1073 
	}
}

1075 
	$ÿch–ess_tid_rb_»move
(
hfi1_fžed©a
 *
fd©a
,

1076 
tid_rb_node
 *
Šode
)

1078 
u32
 
ba£
 = 
fd©a
->
uùxt
->
ex³ùed_ba£
;

1080 
fd©a
->
’Œy_to_rb
[
Šode
->
rcv’Œy
 - 
ba£
] = 
NULL
;

1081 
	`þ—r_tid_node
(
fd©a
, 
Šode
);

1082 
	}
}

1084 
	$tid_rb_»move
(*
¬g
, 
mmu_rb_node
 *
node
)

1086 
hfi1_fžed©a
 *
fd©a
 = 
¬g
;

1087 
tid_rb_node
 *
Šode
 =

1088 
	`cÚš”_of
(
node
, 
tid_rb_node
, 
mmu
);

1090 
	`ÿch–ess_tid_rb_»move
(
fd©a
, 
Šode
);

1091 
	}
}

	@user_exp_rcv.h

1 #iâdeà
_HFI1_USER_EXP_RCV_H


2 
	#_HFI1_USER_EXP_RCV_H


	)

50 
	~"hfi.h
"

52 
	~"mmu_rb.h
"

53 
	~"exp_rcv.h
"

55 
	stid_·ge£t
 {

56 
u16
 
	midx
;

57 
u16
 
	mcouÁ
;

60 
	stid_u£r_buf
 {

61 
	mvaddr
;

62 
	mËngth
;

63 
	mÅages
;

64 #iâdeà
NVIDIA_GPU_DIRECT


65 
·ge
 **
	m·ges
;

68 
·ge
 **
	mho¡
;

69 
nvidŸ_p2p_·ge_bË
 *
	mgpu
;

70 } 
	m·ges
;

71 
mmu_rb_hªdËr
 *
	mhªdËr
;

72 
boÞ
 
	mÚgpu
;

73 
©omic_t
 
	m»fcouÁ
;

75 
tid_·ge£t
 *
	mp£ts
;

76 
	mn_p£ts
;

79 
	stid_rb_node
 {

80 
mmu_rb_node
 
	mmmu
;

81 
	mphys
;

82 
tid_group
 *
	mg½
;

83 
u32
 
	mrcv’Œy
;

84 
dma_addr_t
 
	mdma_addr
;

85 
boÞ
 
	mä“d
;

86 
	mÅages
;

87 #ifdeà
NVIDIA_GPU_DIRECT


88 
boÞ
 
	mÚgpu
;

89 
tid_u£r_buf
 *
	mtidbuf
;

91 
·ge
 *
	m·ges
[0];

94 
šlše
 
	$num_u£r_·ges
(
addr
,

95 
Ën
)

97 cÚ¡ 
¥age
 = 
addr
 & 
PAGE_MASK
;

98 cÚ¡ 
•age
 = (
addr
 + 
Ën
 - 1è& 
PAGE_MASK
;

100  1 + ((
•age
 - 
¥age
è>> 
PAGE_SHIFT
);

101 
	}
}

103 
hfi1_u£r_exp_rcv_š™
(
hfi1_fžed©a
 *
fd
,

104 
hfi1_ùxtd©a
 *
uùxt
);

105 
hfi1_u£r_exp_rcv_ä“
(
hfi1_fžed©a
 *
fd
);

106 
hfi1_u£r_exp_rcv_£tup
(
hfi1_fžed©a
 *
fd
,

107 #iâdeà
NVIDIA_GPU_DIRECT


108 
hfi1_tid_šfo
 *
tšfo
);

110 
hfi1_tid_šfo_v2
 *
	gtšfo
);

112 
hfi1_u£r_exp_rcv_þ—r
(
hfi1_fžed©a
 *
fd
,

113 
hfi1_tid_šfo
 *
tšfo
);

114 
hfi1_u£r_exp_rcv_šv®id
(
hfi1_fžed©a
 *
fd
,

115 
hfi1_tid_šfo
 *
tšfo
);

116 
tid_rb_š£¹
(*
¬g
, 
mmu_rb_node
 *
node
);

	@user_exp_rcv_gpu.c

48 
	~"Œaû.h
"

49 
	~"mmu_rb.h
"

50 
	~"u£r_exp_rcv.h
"

51 
	~"u£r_exp_rcv_gpu.h
"

53 
	$uÅš_rcv_gpu_·ges_ÿÎback
(*
d©a
)

55 
tid_u£r_buf
 *
tidbuf
 = (tid_u£r_buà*)
d©a
;

57 ià(
tidbuf
->
·ges
.
gpu
) {

58 
	`ä“_gpu_·ge_bË
(
tidbuf
->
·ges
.
gpu
);

59 
tidbuf
->
·ges
.
gpu
 = 
NULL
;

60 ià(
tidbuf
->
hªdËr
) {

61 
	`Œaû_uÅš_rcv_gpu_·ges_ÿÎback
(
tidbuf
->
vaddr
,

62 
tidbuf
->
Ëngth
);

63 
	`hfi1_gpu_ÿche_šv®id©e
(
tidbuf
->
hªdËr
,

64 
tidbuf
->
vaddr
,

65 (
tidbuf
->
vaddr
 +idbuf->
Ëngth
));

68 
	}
}

73 
	$uÅš_rcv_·ges_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_rb_node
 *
node
)

75 ià(
	`©omic_dec_ªd_‹¡
(&
node
->
tidbuf
->
»fcouÁ
)) {

82 ià(
node
->
tidbuf
->
·ges
.
gpu
) {

83 
	`Œaû_ä“_»cv_gpu_·ges
(
node
->
tidbuf
->
vaddr
);

84 
	`put_gpu_·ges
(
node
->
tidbuf
->
vaddr
,

85 
node
->
tidbuf
->
·ges
.
gpu
);

87 
fd
->
tid_n_gpu_pšÃd
 -ð
node
->
tidbuf
->
Åages
;

88 
	`kä“
(
node
->
tidbuf
);

90 
	}
}

95 
	$pš_rcv_·ges_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tidbuf
)

97 
»t
, 
pšÃd
;

98 
max_ÿche_·ges
;

99 
size
, 
uÇligÃd_vaddr
;

100 
hfi1_devd©a
 *
dd
 = 
fd
->
uùxt
->dd;

103 
tidbuf
->
Åages
 = 
	`num_u£r_·ges_gpu
Ñidbuf->
vaddr
,idbuf->
Ëngth
);

104 ià(!
tidbuf
->
Åages
)

105  -
EINVAL
;

107 ià(
tidbuf
->
Åages
 > 
fd
->
uùxt
->
ex³ùed_couÁ
) {

108 
	`dd_dev_”r
(
dd
, "Expected bufferoo big\n");

109  -
EINVAL
;

120 
max_ÿche_·ges
 = ((
gpu_ÿche_size
 << 20è>> 
NV_GPU_PAGE_SHIFT
);

121 ià(
fd
->
tid_n_gpu_pšÃd
 + 
tidbuf
->
Åages
 > 
max_ÿche_·ges
)

122  -
ENOMEM
;

133 
	`©omic_£t
(&
tidbuf
->
»fcouÁ
, 0);

135 
uÇligÃd_vaddr
 = 
tidbuf
->
vaddr
;

136 
tidbuf
->
vaddr
 = 
uÇligÃd_vaddr
 & 
NV_GPU_PAGE_MASK
;

137 
size
 = 
uÇligÃd_vaddr
 + 
tidbuf
->
Ëngth
 -idbuf->
vaddr
;

139 
	`Œaû_pš_rcv_·ges_gpu
(
uÇligÃd_vaddr
, 
tidbuf
->
vaddr
,idbuf->
Ëngth
,

140 
size
, 
tidbuf
->
Åages
);

141 
»t
 = 
	`pš_gpu_·ges
(
tidbuf
->
vaddr
, 
size
, &tidbuf->
·ges
.
gpu
,

142 
uÅš_rcv_gpu_·ges_ÿÎback
, 
tidbuf
);

143 ià(
»t
 != 0) {

144 
	`Œaû_»cv_pš_gpu_·ges_çž
(
»t
, 
tidbuf
->
vaddr
, 
size
);

145  
»t
;

147 
tidbuf
->
Ëngth
 = 
size
;

148 
pšÃd
 = 
tidbuf
->
·ges
.
gpu
->
’Œ›s
;

149 
fd
->
tid_n_gpu_pšÃd
 +ð
pšÃd
;

150 
	`Œaû_»cv_gpu_·ge_bË_šfo
(
pšÃd
, 
tidbuf
->
·ges
.
gpu
->
·ge_size
);

151  
pšÃd
;

152 
	}
}

154 
u32
 
	$fšd_phys_blocks_gpu
(
tid_u£r_buf
 *
tidbuf
)

156 
tid_·ge£t
 *
li¡
 = 
tidbuf
->
p£ts
;

157 
nvidŸ_p2p_·ge_bË
 *
·ge_bË
 = 
tidbuf
->
·ges
.
gpu
;

158 
·gecouÁ
, 
·geidx
, 
£tcouÁ
 = 0, 
i
;

159 
pâ
, 
this_pâ
;

160 
Åages
 = 
·ge_bË
->
’Œ›s
;

162 ià(!
Åages
)

170 
pâ
 = 
	`GPU_PAGE_TO_PFN
(
·ge_bË
->
·ges
[0]);

171 
·geidx
 = 0, 
·gecouÁ
 = 1, 
i
 = 1; i <ð
Åages
; i++) {

172 
this_pâ
 = 
i
 < 
Åages
 ?

173 
	`GPU_PAGE_TO_PFN
(
·ge_bË
->
·ges
[
i
]) : 0;

179 ià(
this_pâ
 !ð++
pâ
) {

192 
·gecouÁ
) {

193 
max·ges
 = 
·gecouÁ
;

194 
u32
 
bufsize
 = 
·gecouÁ
 * 
NV_GPU_PAGE_SIZE
;

196 ià(
bufsize
 > 
MAX_EXPECTED_BUFFER
)

197 
max·ges
 =

198 
MAX_EXPECTED_BUFFER
 >>

199 
NV_GPU_PAGE_SHIFT
;

200 ià(!
	`is_pow”_of_2
(
bufsize
))

201 
max·ges
 =

202 
	`rounddown_pow_of_two
(
bufsize
) >>

203 
NV_GPU_PAGE_SHIFT
;

205 
li¡
[
£tcouÁ
].
idx
 = 
·geidx
;

206 
li¡
[
£tcouÁ
].
couÁ
 = 
max·ges
;

207 
·gecouÁ
 -ð
max·ges
;

208 
·geidx
 +ð
max·ges
;

209 
£tcouÁ
++;

211 
·geidx
 = 
i
;

212 
·gecouÁ
 = 1;

213 
pâ
 = 
this_pâ
;

215 
·gecouÁ
++;

218  
£tcouÁ
;

219 
	}
}

221 
	$£t_rcv¬¿y_’Œy_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tbuf
,

222 
u32
 
rcv’Œy
, 
tid_group
 *
g½
,

223 
u16
 
·geidx
, 
Åages
)

225 
»t
;

226 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

227 
tid_rb_node
 *
node
;

228 
hfi1_devd©a
 *
dd
 = 
uùxt
->dd;

229 
dma_addr_t
 
phys
;

235 
node
 = 
	`kz®loc
((*node), 
GFP_KERNEL
);

236 ià(!
node
)

237  -
ENOMEM
;

239 
node
->
mmu
.
Ën
 = 
Åages
 * 
NV_GPU_PAGE_SIZE
;

240 
node
->
mmu
.
addr
 = 
tbuf
->
vaddr
 + (
·geidx
 * 
NV_GPU_PAGE_SIZE
);

241 
phys
 = 
tbuf
->
·ges
.
gpu
->·ges[
·geidx
]->
physiÿl_add»ss
;

242 
node
->
phys
 =…hys;

243 
node
->
tidbuf
 = 
tbuf
;

244 
node
->
Åages
 =‚pages;

245 
node
->
rcv’Œy
 =„cventry;

251 
node
->
dma_addr
 = 
phys
;

252 
node
->
g½
 = grp;

253 
node
->
ä“d
 = 
çl£
;

254 
node
->
Úgpu
 = 
tbuf
->ongpu;

256 ià(!
fd
->
hªdËr_gpu
)

257 
»t
 = 
	`tid_rb_š£¹
(
fd
, &
node
->
mmu
);

259 
»t
 = 
	`hfi1_mmu_rb_š£¹
(
fd
->
hªdËr_gpu
, &
node
->
mmu
);

261 ià(
»t
) {

262 
	`hfi1_cdbg
(
TID
, "Failedo insert RB‚ode %u 0x%lx, 0x%lx %d",

263 
node
->
rcv’Œy
,‚ode->
mmu
.
addr
,‚ode->
phys
, 
»t
);

264 
	`kä“
(
node
);

265  -
EFAULT
;

271 
	`hfi1_put_tid
(
dd
, 
rcv’Œy
, 
PT_EXPECTED
, 
phys
, 
	`žog2
(
Åages
) + 5);

272 
	`©omic_šc
(&
node
->
tidbuf
->
»fcouÁ
);

273 
	`Œaû_hfi1_exp_tid_»g
(
uùxt
->
ùxt
, 
fd
->
subùxt
, 
rcv’Œy
, 
Åages
,

274 
node
->
mmu
.
addr
,‚ode->
phys
,…hys);

276 
	}
}

	@user_exp_rcv_gpu.h

1 #iâdeà
_HFI1_USER_EXP_RCV_GPU_H


2 
	#_HFI1_USER_EXP_RCV_GPU_H


	)

49 
	~"gpu.h
"

51 
uÅš_rcv_·ges_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_rb_node
 *
node
);

52 
pš_rcv_·ges_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tidbuf
);

53 
u32
 
fšd_phys_blocks_gpu
(
tid_u£r_buf
 *
tidbuf
);

54 
£t_rcv¬¿y_’Œy_gpu
(
hfi1_fžed©a
 *
fd
, 
tid_u£r_buf
 *
tbuf
,

55 
u32
 
rcv’Œy
, 
tid_group
 *
g½
,

56 
u16
 
·geidx
, 
Åages
);

	@user_pages.c

47 
	~"com·t.h
"

48 
	~<lšux/mm.h
>

50 #ifdeà
NEED_SCHED_H


51 
	~<lšux/sched.h
>

53 
	~<lšux/sched/sigÇl.h
>

57 
	~<lšux/deviû.h
>

58 
	~<lšux/moduË.h
>

60 
	~"hfi.h
"

62 
	gÿche_size
 = 256;

63 
moduË_·¿m
(
ÿche_size
, 
ulÚg
, 
S_IRUGO
 | 
S_IWUSR
);

64 
MODULE_PARM_DESC
(
ÿche_size
, "Send‡nd„eceive side cache size†imit (in MB)");

78 
boÞ
 
	$hfi1_ÿn_pš_·ges
(
hfi1_devd©a
 *
dd
, 
mm_¡ruù
 *
mm
,

79 
u32
 
Æocked
, u32 
Åages
)

81 
ulim™
 = 
	`¾im™
(
RLIMIT_MEMLOCK
), 
pšÃd
, 
ÿche_lim™
,

82 
size
 = (
ÿche_size
 * (1UL << 20));

83 
u¤_ùxts
 =

84 
dd
->
num_rcv_cÚ‹xts
 - dd->
fœ¡_dyn_®loc_ùxt
;

85 
boÞ
 
ÿn_lock
 = 
	`ÿ·bË
(
CAP_IPC_LOCK
);

92 
ÿche_lim™
 = (
ulim™
 / 
u¤_ùxts
) / 4;

95 ià(
ulim™
 !ð(-1ULè&& 
size
 > 
ÿche_lim™
)

96 
size
 = 
ÿche_lim™
;

99 
size
 = 
	`DIV_ROUND_UP
(size, 
PAGE_SIZE
);

101 #iâdeà
HAVE_ATOMIC64_PINNED_VM


102 
	`down_»ad
(&
mm
->
mm­_£m
);

103 
pšÃd
 = 
mm
->
pšÃd_vm
;

104 
	`up_»ad
(&
mm
->
mm­_£m
);

106 
pšÃd
 = 
	`©omic64_»ad
(&
mm
->
pšÃd_vm
);

110 ià(
pšÃd
 + 
Åages
 >ð
ulim™
 && !
ÿn_lock
)

111  
çl£
;

113  ((
Æocked
 + 
Åages
è<ð
size
è|| 
ÿn_lock
;

114 
	}
}

116 
	$hfi1_acquœe_u£r_·ges
(
mm_¡ruù
 *
mm
, 
vaddr
, 
size_t
 
Åages
,

117 
boÞ
 
wr™abË
, 
·ge
 **
·ges
)

119 
»t
;

121 
»t
 = 
	`g‘_u£r_·ges_ç¡
(
vaddr
, 
Åages
, 
wr™abË
, 
·ges
);

122 ià(
»t
 < 0)

123  
»t
;

125 #iâdeà
HAVE_ATOMIC64_PINNED_VM


126 
	`down_wr™e
(&
mm
->
mm­_£m
);

127 
mm
->
pšÃd_vm
 +ð
»t
;

128 
	`up_wr™e
(&
mm
->
mm­_£m
);

130 
	`©omic64_add
(
»t
, &
mm
->
pšÃd_vm
);

133  
»t
;

134 
	}
}

136 
	$hfi1_»Ëa£_u£r_·ges
(
mm_¡ruù
 *
mm
, 
·ge
 **
p
,

137 
size_t
 
Åages
, 
boÞ
 
dœty
)

139 
	`put_u£r_·ges_dœty_lock
(
p
, 
Åages
, 
dœty
);

141 ià(
mm
) {

142 #iâdeà
HAVE_ATOMIC64_PINNED_VM


143 
	`down_wr™e
(&
mm
->
mm­_£m
);

144 
mm
->
pšÃd_vm
 -ð
Åages
;

145 
	`up_wr™e
(&
mm
->
mm­_£m
);

147 
	`©omic64_sub
(
Åages
, &
mm
->
pšÃd_vm
);

150 
	}
}

	@user_sdma.c

47 
	~<lšux/mm.h
>

48 
	~<lšux/ty³s.h
>

49 
	~<lšux/deviû.h
>

50 
	~<lšux/dm­oÞ.h
>

51 
	~<lšux/¦ab.h
>

52 
	~<lšux/li¡.h
>

53 
	~<lšux/highmem.h
>

54 
	~<lšux/io.h
>

55 
	~<lšux/uio.h
>

56 
	~<lšux/rbŒ“.h
>

57 
	~<lšux/¥šlock.h
>

58 
	~<lšux/d–ay.h
>

59 
	~<lšux/kth»ad.h
>

60 
	~<lšux/mmu_cÚ‹xt.h
>

61 
	~<lšux/moduË.h
>

62 
	~<lšux/vm®loc.h
>

63 
	~<lšux/¡ršg.h
>

65 
	~"hfi.h
"

66 
	~"sdma.h
"

67 
	~"u£r_sdma.h
"

68 
	~"v”bs.h
"

69 
	~"commÚ.h
"

70 
	~"Œaû.h
"

71 #ifdeà
NVIDIA_GPU_DIRECT


72 
	~"u£r_sdma_gpu.h
"

75 
ušt
 
	ghfi1_sdma_comp_ršg_size
 = 128;

76 
moduË_·¿m_Çmed
(
sdma_comp_size
, 
hfi1_sdma_comp_ršg_size
, 
ušt
, 
S_IRUGO
);

77 
MODULE_PARM_DESC
(
sdma_comp_size
, "Size of User SDMA completion„ing. Default: 128");

79 
	gš™Ÿl_pkt_couÁ
 = 8;

81 
u£r_sdma_£nd_pkts
(
u£r_sdma_»que¡
 *
»q
, 
u16
 
maxpkts
);

82 
u£r_sdma_tx»q_cb
(
sdma_tx»q
 *
tx»q
, 
¡©us
);

83 
šlše
 
pq_upd©e
(
hfi1_u£r_sdma_pkt_q
 *
pq
);

84 
u£r_sdma_ä“_»que¡
(
u£r_sdma_»que¡
 *
»q
, 
boÞ
 
uÅš
);

85 
pš_veùÜ_·ges
(
u£r_sdma_»que¡
 *
»q
,

86 
u£r_sdma_iovec
 *
iovec
);

87 
uÅš_veùÜ_·ges
(
mm_¡ruù
 *
mm
, 
·ge
 **
·ges
,

88 
¡¬t
, 
Åages
);

89 
check_h—d”_‹m¶©e
(
u£r_sdma_»que¡
 *
»q
,

90 
hfi1_pkt_h—d”
 *
hdr
, 
u32
 
ÌhËn
,

91 
u32
 
d©®’
);

92 
£t_tx»q_h—d”
(
u£r_sdma_»que¡
 *
»q
,

93 
u£r_sdma_tx»q
 *
tx
, 
u32
 
d©®’
);

94 
£t_tx»q_h—d”_ahg
(
u£r_sdma_»que¡
 *
»q
,

95 
u£r_sdma_tx»q
 *
tx
, 
u32
 
Ën
);

96 
šlše
 
£t_comp_¡©e
(
hfi1_u£r_sdma_pkt_q
 *
pq
,

97 
hfi1_u£r_sdma_comp_q
 *
cq
,

98 
u16
 
idx
, 
hfi1_sdma_comp_¡©e
 
¡©e
,

99 
»t
);

100 
šlše
 
u32
 
£t_pkt_bth_p¢
(
__be32
 
bthp¢
, 
u8
 
expù
, u32 
äags
);

101 
šlše
 
u32
 
g‘_Ìh_Ën
(
hfi1_pkt_h—d”
, u32 
Ën
);

103 
deãr_·ck‘_queue
(

104 
sdma_’gše
 *
sde
,

105 
iowa™_wÜk
 *
wa™
,

106 
sdma_tx»q
 *
tx»q
,

107 
ušt
 
£q
,

108 
boÞ
 
pkts_£Á
);

109 
aùiv©e_·ck‘_queue
(
iowa™
 *
wa™
, 
»asÚ
);

110 
boÞ
 
sdma_rb_fž‹r
(
mmu_rb_node
 *
node
, 
addr
,

111 
Ën
);

112 
sdma_rb_š£¹
(*
¬g
, 
mmu_rb_node
 *
mnode
);

113 
sdma_rb_eviù
(*
¬g
, 
mmu_rb_node
 *
mnode
,

114 *
¬g2
, 
boÞ
 *
¡Ý
);

115 
sdma_rb_»move
(*
¬g
, 
mmu_rb_node
 *
mnode
);

116 
sdma_rb_šv®id©e
(*
¬g
, 
mmu_rb_node
 *
mnode
);

118 
mmu_rb_Ýs
 
	gsdma_rb_Ýs
 = {

119 .
fž‹r
 = 
sdma_rb_fž‹r
,

120 .
	gš£¹
 = 
sdma_rb_š£¹
,

121 .
	geviù
 = 
sdma_rb_eviù
,

122 .
	g»move
 = 
sdma_rb_»move
,

123 .
	gšv®id©e
 = 
sdma_rb_šv®id©e


126 
	$deãr_·ck‘_queue
(

127 
sdma_’gše
 *
sde
,

128 
iowa™_wÜk
 *
wa™
,

129 
sdma_tx»q
 *
tx»q
,

130 
ušt
 
£q
,

131 
boÞ
 
pkts_£Á
)

133 
hfi1_u£r_sdma_pkt_q
 *
pq
 =

134 
	`cÚš”_of
(
wa™
->
iow
, 
hfi1_u£r_sdma_pkt_q
, 
busy
);

136 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

137 ià(
	`sdma_´og»ss
(
sde
, 
£q
, 
tx»q
))

138 
—gaš
;

144 
	`xchg
(&
pq
->
¡©e
, 
SDMA_PKT_Q_DEFERRED
);

145 ià(
	`li¡_em±y
(&
pq
->
busy
.
li¡
)) {

146 
pq
->
busy
.
lock
 = &
sde
->
wa™lock
;

147 
	`iowa™_g‘_´iÜ™y
(&
pq
->
busy
);

148 
	`iowa™_queue
(
pkts_£Á
, &
pq
->
busy
, &
sde
->
dmawa™
);

150 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

151  -
EBUSY
;

152 
—gaš
:

153 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

154  -
EAGAIN
;

155 
	}
}

157 
	$aùiv©e_·ck‘_queue
(
iowa™
 *
wa™
, 
»asÚ
)

159 
hfi1_u£r_sdma_pkt_q
 *
pq
 =

160 
	`cÚš”_of
(
wa™
, 
hfi1_u£r_sdma_pkt_q
, 
busy
);

161 
pq
->
busy
.
lock
 = 
NULL
;

162 
	`xchg
(&
pq
->
¡©e
, 
SDMA_PKT_Q_ACTIVE
);

163 
	`wake_up
(&
wa™
->
wa™_dma
);

164 
	}
};

166 
	$hfi1_u£r_sdma_®loc_queues
(
hfi1_ùxtd©a
 *
uùxt
,

167 
hfi1_fžed©a
 *
fd
)

169 
»t
 = -
ENOMEM
;

170 
buf
[64];

171 
hfi1_devd©a
 *
dd
;

172 
hfi1_u£r_sdma_comp_q
 *
cq
;

173 
hfi1_u£r_sdma_pkt_q
 *
pq
;

175 ià(!
uùxt
 || !
fd
)

176  -
EBADF
;

178 ià(!
hfi1_sdma_comp_ršg_size
)

179  -
EINVAL
;

181 
dd
 = 
uùxt
->dd;

183 
pq
 = 
	`kz®loc
((*pq), 
GFP_KERNEL
);

184 ià(!
pq
)

185  -
ENOMEM
;

186 
pq
->
dd
 = dd;

187 
pq
->
ùxt
 = 
uùxt
->ctxt;

188 
pq
->
subùxt
 = 
fd
->subctxt;

189 
pq
->
n_max_»qs
 = 
hfi1_sdma_comp_ršg_size
;

190 
	`©omic_£t
(&
pq
->
n_»qs
, 0);

191 
	`š™_wa™queue_h—d
(&
pq
->
wa™
);

192 
	`©omic_£t
(&
pq
->
n_locked
, 0);

193 #ifdeà
NVIDIA_GPU_DIRECT


194 
	`©omic_£t
(&
pq
->
n_gpu_locked
, 0);

196 
pq
->
mm
 = 
fd
->mm;

198 
	`iowa™_š™
(&
pq
->
busy
, 0, 
NULL
, NULL, 
deãr_·ck‘_queue
,

199 
aùiv©e_·ck‘_queue
, 
NULL
, NULL);

200 
pq
->
»qidx
 = 0;

202 
pq
->
»qs
 = 
	`kÿÎoc
(
hfi1_sdma_comp_ršg_size
,

203 (*
pq
->
»qs
),

204 
GFP_KERNEL
);

205 ià(!
pq
->
»qs
)

206 
pq_»qs_nomem
;

208 
pq
->
»q_š_u£
 = 
	`kÿÎoc
(
	`BITS_TO_LONGS
(
hfi1_sdma_comp_ršg_size
),

209 (*
pq
->
»q_š_u£
),

210 
GFP_KERNEL
);

211 ià(!
pq
->
»q_š_u£
)

212 
pq_»qs_no_š_u£
;

214 
	`¢´štf
(
buf
, 64, "tx»q-kmem-ÿche-%u-%u-%u", 
dd
->
un™
, 
uùxt
->
ùxt
,

215 
fd
->
subùxt
);

216 
pq
->
tx»q_ÿche
 = 
	`kmem_ÿche_ü—‹
(
buf
,

217 (
u£r_sdma_tx»q
),

218 
L1_CACHE_BYTES
,

219 
SLAB_HWCACHE_ALIGN
,

220 
NULL
);

221 ià(!
pq
->
tx»q_ÿche
) {

222 
	`dd_dev_”r
(
dd
, "[%u] Failedo‡llocate TxReq cache\n",

223 
uùxt
->
ùxt
);

224 
pq_tx»q_nomem
;

227 
cq
 = 
	`kz®loc
((*cq), 
GFP_KERNEL
);

228 ià(!
cq
)

229 
cq_nomem
;

231 
cq
->
comps
 = 
	`vm®loc_u£r
(
	`PAGE_ALIGN
((*cq->comps)

232 * 
hfi1_sdma_comp_ršg_size
));

233 ià(!
cq
->
comps
)

234 
cq_comps_nomem
;

236 
cq
->
ÃÁr›s
 = 
hfi1_sdma_comp_ršg_size
;

237 #ifdeà
NVIDIA_GPU_DIRECT


238 
»t
 = 
	`hfi1_mmu_rb_»gi¡”
(
pq
, 
NULL
, &
sdma_rb_Ýs
, 
dd
->
µÜt
->
hfi1_wq
,

239 &
pq
->
hªdËr_gpu
);

240 ià(
»t
) {

241 
	`dd_dev_”r
(
dd
, "Failedo‡llocate SDMA GPU buffer cache %d",

242 
»t
);

243 
pq_mmu_çž
;

247 
»t
 = 
	`hfi1_mmu_rb_»gi¡”
(
pq
,…q->
mm
, &
sdma_rb_Ýs
, 
dd
->
µÜt
->
hfi1_wq
,

248 &
pq
->
hªdËr
);

249 ià(
»t
) {

250 
	`dd_dev_”r
(
dd
, "FažedØ»gi¡” w™h MMU %d", 
»t
);

251 #ifdeà
NVIDIA_GPU_DIRECT


252 
	`hfi1_mmu_rb_uÄegi¡”
(
pq
->
hªdËr_gpu
);

254 
pq_mmu_çž
;

257 
	`rcu_assign_poš‹r
(
fd
->
pq
,…q);

258 
fd
->
cq
 = cq;

262 
pq_mmu_çž
:

263 
	`vä“
(
cq
->
comps
);

264 
cq_comps_nomem
:

265 
	`kä“
(
cq
);

266 
cq_nomem
:

267 
	`kmem_ÿche_de¡roy
(
pq
->
tx»q_ÿche
);

268 
pq_tx»q_nomem
:

269 
	`kä“
(
pq
->
»q_š_u£
);

270 
pq_»qs_no_š_u£
:

271 
	`kä“
(
pq
->
»qs
);

272 
pq_»qs_nomem
:

273 
	`kä“
(
pq
);

275  
»t
;

276 
	}
}

278 
	$æush_pq_iowa™
(
hfi1_u£r_sdma_pkt_q
 *
pq
)

280 
æags
;

281 
£qlock_t
 *
lock
 = 
pq
->
busy
.lock;

283 ià(!
lock
)

285 
	`wr™e_£qlock_œq§ve
(
lock
, 
æags
);

286 ià(!
	`li¡_em±y
(&
pq
->
busy
.
li¡
)) {

287 
	`li¡_d–_š™
(&
pq
->
busy
.
li¡
);

288 
pq
->
busy
.
lock
 = 
NULL
;

290 
	`wr™e_£quÆock_œq»¡Üe
(
lock
, 
æags
);

291 
	}
}

293 
	$hfi1_u£r_sdma_ä“_queues
(
hfi1_fžed©a
 *
fd
,

294 
hfi1_ùxtd©a
 *
uùxt
)

296 
hfi1_u£r_sdma_pkt_q
 *
pq
;

298 
	`Œaû_hfi1_sdma_u£r_ä“_queues
(
uùxt
->
dd
, uùxt->
ùxt
, 
fd
->
subùxt
);

300 
	`¥š_lock
(&
fd
->
pq_rcu_lock
);

301 
pq
 = 
	`¤cu_d”eã»nû_check
(
fd
->pq, &fd->
pq_¤cu
,

302 
	`lockd•_is_h–d
(&
fd
->
pq_rcu_lock
));

303 ià(
pq
) {

304 
	`rcu_assign_poš‹r
(
fd
->
pq
, 
NULL
);

305 
	`¥š_uÆock
(&
fd
->
pq_rcu_lock
);

306 
	`synchrÚize_¤cu
(&
fd
->
pq_¤cu
);

308 ià(
pq
->
hªdËr
)

309 
	`hfi1_mmu_rb_uÄegi¡”
(
pq
->
hªdËr
);

310 #ifdeà
NVIDIA_GPU_DIRECT


311 ià(
pq
->
hªdËr_gpu
)

312 
	`hfi1_mmu_rb_uÄegi¡”
(
pq
->
hªdËr_gpu
);

314 
	`iowa™_sdma_d¿š
(&
pq
->
busy
);

316 
	`wa™_ev’t_š‹¼u±ibË
(

317 
pq
->
wa™
,

318 !
	`©omic_»ad
(&
pq
->
n_»qs
));

319 
	`kä“
(
pq
->
»qs
);

320 
	`kä“
(
pq
->
»q_š_u£
);

321 
	`kmem_ÿche_de¡roy
(
pq
->
tx»q_ÿche
);

322 
	`æush_pq_iowa™
(
pq
);

323 
	`kä“
(
pq
);

325 
	`¥š_uÆock
(&
fd
->
pq_rcu_lock
);

327 ià(
fd
->
cq
) {

328 
	`vä“
(
fd
->
cq
->
comps
);

329 
	`kä“
(
fd
->
cq
);

330 
fd
->
cq
 = 
NULL
;

333 
	}
}

335 
u8
 
	$dlid_to_£ËùÜ
(
u16
 
dlid
)

337 
u8
 
m­pšg
[256];

338 
š™Ÿlized
;

339 
u8
 
Ãxt
;

340 
hash
;

342 ià(!
š™Ÿlized
) {

343 
	`mem£t
(
m­pšg
, 0xFF, 256);

344 
š™Ÿlized
 = 1;

347 
hash
 = ((
dlid
 >> 8) ^ dlid) & 0xFF;

348 ià(
m­pšg
[
hash
] == 0xFF) {

349 
m­pšg
[
hash
] = 
Ãxt
;

350 
Ãxt
 = (next + 1) & 0x7F;

353  
m­pšg
[
hash
];

354 
	}
}

363 
	$hfi1_u£r_sdma_´oûss_»que¡
(
hfi1_fžed©a
 *
fd
,

364 
iovec
 *iovec, 
dim
,

365 *
couÁ
)

367 
»t
 = 0, 
i
;

368 
hfi1_ùxtd©a
 *
uùxt
 = 
fd
->uctxt;

369 
hfi1_u£r_sdma_pkt_q
 *
pq
 =

370 
	`¤cu_d”eã»nû
(
fd
->
pq
, &fd->
pq_¤cu
);

371 
hfi1_u£r_sdma_comp_q
 *
cq
 = 
fd
->cq;

372 
hfi1_devd©a
 *
dd
 = 
pq
->dd;

373 
idx
 = 0;

374 
u8
 
pcouÁ
 = 
š™Ÿl_pkt_couÁ
;

375 
sdma_»q_šfo
 
šfo
;

376 
u£r_sdma_»que¡
 *
»q
;

377 
u8
 
Ýcode
, 
sc
, 
vl
;

378 
u16
 
pkey
;

379 
u32
 
¦id
;

380 
u16
 
dlid
;

381 
u32
 
£ËùÜ
;

382 
size_šfo
 = (
šfo
);

383 
u8
 
£c_idx
;

384 
u64
 
subÃt_´efix
;

386 #ifdeà
NVIDIA_GPU_DIRECT


387 
»t
 = 
	`cÝy_äom_u£r
(&
šfo
.
ù¾
, 
iovec
[
idx
].
iov_ba£
,

388 (
šfo
.
ù¾
));

389 ià(
»t
) {

390 
	`hfi1_cdbg
(
SDMA
, "[%u:%u:%u] Failedo copy info ctrl (%d)",

391 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
»t
);

392  -
EFAULT
;

397 ià(
	`»q_v”siÚ
(
šfo
.
ù¾
) == 2)

398 
size_šfo
 = (
sdma_»q_šfo
);

400 
size_šfo
 = 
	`off£tof
(
sdma_»q_šfo
, 
æags
);

403 ià(
iovec
[
idx
].
iov_Ën
 < 
size_šfo
 + (
»q
->
hdr
)) {

404 
	`hfi1_cdbg
(

405 
SDMA
,

407 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

408 
iovec
[
idx
].
iov_Ën
, 
size_šfo
 + (
»q
->
hdr
));

409  -
EINVAL
;

411 
»t
 = 
	`cÝy_äom_u£r
(&
šfo
, 
iovec
[
idx
].
iov_ba£
, 
size_šfo
);

412 ià(
»t
) {

413 
	`hfi1_cdbg
(
SDMA
, "[%u:%u:%u] Failedo copy info QW (%d)",

414 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
»t
);

415  -
EFAULT
;

418 
	`Œaû_hfi1_sdma_u£r_»qšfo
(
dd
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

419 (
u16
 *)&
šfo
);

420 ià(
šfo
.
comp_idx
 >ð
hfi1_sdma_comp_ršg_size
) {

421 
	`hfi1_cdbg
(
SDMA
,

423 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
šfo
.
comp_idx
);

424  -
EINVAL
;

431 ià(
	`»q_iovút
(
šfo
.
ù¾
è< 1 ||„eq_iovút(šfo.ù¾è> 
dim
) {

432 
	`hfi1_cdbg
(
SDMA
,

434 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
šfo
.
comp_idx
,

435 
	`»q_iovút
(
šfo
.
ù¾
), 
dim
);

436  -
EINVAL
;

439 ià(!
šfo
.
äagsize
) {

440 
	`hfi1_cdbg
(
SDMA
,

442 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
, 
šfo
.
comp_idx
);

443  -
EINVAL
;

447 ià(
	`‹¡_ªd_£t_b™
(
šfo
.
comp_idx
, 
pq
->
»q_š_u£
)) {

448 
	`hfi1_cdbg
(
SDMA
, "[%u:%u:%u] Entry %u is in use",

449 
dd
->
un™
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

450 
šfo
.
comp_idx
);

451  -
EBADSLT
;

456 
	`Œaû_hfi1_sdma_u£r_´oûss_»que¡
(
dd
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

457 
šfo
.
comp_idx
);

458 
»q
 = 
pq
->
»qs
 + 
šfo
.
comp_idx
;

459 
»q
->
d©a_iovs
 = 
	`»q_iovút
(
šfo
.
ù¾
) - 1;

460 
»q
->
d©a_Ën
 = 0;

461 
»q
->
pq
 =…q;

462 
»q
->
cq
 = cq;

463 
»q
->
ahg_idx
 = -1;

464 
»q
->
iov_idx
 = 0;

465 
»q
->
£Á
 = 0;

466 
»q
->
£qnum
 = 0;

467 
»q
->
£qcomp
 = 0;

468 
»q
->
£qsubm™‹d
 = 0;

469 
»q
->
tids
 = 
NULL
;

470 
»q
->
has_”rÜ
 = 0;

471 
	`INIT_LIST_HEAD
(&
»q
->
txps
);

473 #ifdeà
NVIDIA_GPU_DIRECT


474 
»q
->
šfo
.
æags
 = 0;

477 
	`memýy
(&
»q
->
šfo
, &šfo, 
size_šfo
);

480 
	`©omic_šc
(&
pq
->
n_»qs
);

482 ià(
	`»q_Ýcode
(
šfo
.
ù¾
è=ð
EXPECTED
) {

484 ià(
»q
->
d©a_iovs
 < 2) {

485 
	`SDMA_DBG
(
»q
,

487 
»t
 = -
EINVAL
;

488 
ä“_»q
;

490 
»q
->
d©a_iovs
--;

493 ià(!
šfo
.
Åkts
 || 
»q
->
d©a_iovs
 > 
MAX_VECTORS_PER_REQ
) {

494 
	`SDMA_DBG
(
»q
, "ToØmªy veùÜ (%u/%u)",„eq->
d©a_iovs
,

495 
MAX_VECTORS_PER_REQ
);

496 
»t
 = -
EINVAL
;

497 
ä“_»q
;

500 
»t
 = 
	`cÝy_äom_u£r
(&
»q
->
hdr
, 
iovec
[
idx
].
iov_ba£
 + 
size_šfo
,

501 (
»q
->
hdr
));

502 ià(
»t
) {

503 
	`SDMA_DBG
(
»q
, "FažedØcÝy h—d”em¶©(%d)", 
»t
);

504 
»t
 = -
EFAULT
;

505 
ä“_»q
;

509 ià(!
	`HFI1_CAP_IS_USET
(
STATIC_RATE_CTRL
))

510 
»q
->
hdr
.
pbc
[2] = 0;

513 
Ýcode
 = (
	`be32_to_ýu
(
»q
->
hdr
.
bth
[0]) >> 24) & 0xff;

514 ià((
Ýcode
 & 
USER_OPCODE_CHECK_MASK
) !=

515 
USER_OPCODE_CHECK_VAL
) {

516 
	`SDMA_DBG
(
»q
, "Inv®id opcod(%d)", 
Ýcode
);

517 
»t
 = -
EINVAL
;

518 
ä“_»q
;

525 
vl
 = (
	`Ë16_to_ýu
(
»q
->
hdr
.
pbc
[0]) >> 12) & 0xF;

526 
sc
 = (((
	`be16_to_ýu
(
»q
->
hdr
.
Ìh
[0]) >> 12) & 0xF) |

527 (((
	`Ë16_to_ýu
(
»q
->
hdr
.
pbc
[1]) >> 14) & 0x1) << 4));

528 ià(
vl
 >ð
dd
->
µÜt
->
vls_Ý”©iÚ®
 ||

529 
vl
 !ð
	`sc_to_vÉ
(
dd
, 
sc
)) {

530 
	`SDMA_DBG
(
»q
, "Inv®id SC(%u)/VL(%u)", 
sc
, 
vl
);

531 
»t
 = -
EINVAL
;

532 
ä“_»q
;

536 
pkey
 = (
u16
)
	`be32_to_ýu
(
»q
->
hdr
.
bth
[0]);

537 
¦id
 = 
	`be16_to_ýu
(
»q
->
hdr
.
Ìh
[3]);

538 ià(
	`eg»ss_pkey_check
(
dd
->
µÜt
, 
¦id
, 
pkey
, 
sc
, 
PKEY_CHECK_INVALID
)) {

539 
»t
 = -
EINVAL
;

540 
ä“_»q
;

543 ià(
uùxt
->
£cur™y
) {

544 ià(
	`hfi1_g‘_v”bs_subÃt_´efix
(
dd
, 1, &
subÃt_´efix
)) {

545 
»t
 = -
EINVAL
;

546 
ä“_»q
;

550 
£c_idx
 = 
	`Ë16_to_ýu
(
»q
->
hdr
.
kd‘h
.
jkey
è>> 
JKEY_SEC_SPLIT
;

556 ià(
	`£cur™y_ib_pkey_acûss
(
uùxt
->
£cur™y
, 
subÃt_´efix
,

557 
pkey
)) {

558 
»t
 = -
EPERM
;

559 
	`hfi1_cdbg
(
SEL
, "User does‚ot have‡ccess!");

560 
ä“_»q
;

567 
	`hfi1_cdbg
(
SEL
, "JKey=0x%x PKey=0x%x SecIdx=0x%x",

568 
»q
->
hdr
.
kd‘h
.
jkey
,

569 
pkey
, 
£c_idx
);

571 ià(
£c_idx
 >ð
MAX_PKEY_VALUES
) {

572 
»t
 = -
EINVAL
;

573 
	`hfi1_cdbg
(
SEL
, "idx in jkey isoo†arge!");

574 
ä“_»q
;

577 ià(
pkey
 !ð
dd
->
µÜt
->
pkeys
[
£c_idx
]) {

578 
»t
 = -
EPERM
;

579 
	`hfi1_cdbg
(
SEL
, "PKey does‚ot match idx in jkey");

580 
ä“_»q
;

588 ià(
uùxt
->
jkey
 !ð
»q
->
hdr
.
kd‘h
.jkey) {

589 
»t
 = -
EINVAL
;

590 
	`hfi1_cdbg
(
SEL
, "JKey in…acket does‚ot match context");

591 
ä“_»q
;

600 ià((
	`be16_to_ýu
(
»q
->
hdr
.
Ìh
[0]è& 0x3è=ð
HFI1_LRH_GRH
) {

601 
	`SDMA_DBG
(
»q
, "Userriedo…ass in‡ GRH");

602 
»t
 = -
EINVAL
;

603 
ä“_»q
;

606 
»q
->
koff£t
 = 
	`Ë32_to_ýu
Ôeq->
hdr
.
kd‘h
.
swd©a
[6]);

611 
»q
->
tidoff£t
 = 
	`KDETH_GET
Ôeq->
hdr
.
kd‘h
.
v”_tid_off£t
, 
OFFSET
) *

612 (
	`KDETH_GET
(
»q
->
hdr
.
kd‘h
.
v”_tid_off£t
, 
OM
) ?

613 
KDETH_OM_LARGE
 : 
KDETH_OM_SMALL
);

614 
	`Œaû_hfi1_sdma_u£r_š™Ÿl_tidoff£t
(
dd
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

615 
šfo
.
comp_idx
, 
»q
->
tidoff£t
);

616 
idx
++;

619 
i
 = 0; i < 
»q
->
d©a_iovs
; i++) {

620 
»q
->
iovs
[
i
].
off£t
 = 0;

621 
	`INIT_LIST_HEAD
(&
»q
->
iovs
[
i
].
li¡
);

622 
	`memýy
(&
»q
->
iovs
[
i
].
iov
,

623 
iovec
 + 
idx
++,

624 (
»q
->
iovs
[
i
].
iov
));

625 
»t
 = 
	`pš_veùÜ_·ges
(
»q
, &»q->
iovs
[
i
]);

626 ià(
»t
) {

627 
»q
->
d©a_iovs
 = 
i
;

628 
ä“_»q
;

630 
»q
->
d©a_Ën
 +ð»q->
iovs
[
i
].
iov
.
iov_Ën
;

632 
	`Œaû_hfi1_sdma_u£r_d©a_Ëngth
(
dd
, 
uùxt
->
ùxt
, 
fd
->
subùxt
,

633 
šfo
.
comp_idx
, 
»q
->
d©a_Ën
);

634 ià(
pcouÁ
 > 
»q
->
šfo
.
Åkts
)

635 
pcouÁ
 = 
»q
->
šfo
.
Åkts
;

644 ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
) {

645 
u16
 
Áids
 = 
iovec
[
idx
].
iov_Ën
 / (*
»q
->
tids
);

646 
u32
 *
tmp
;

648 ià(!
Áids
 ||‚tid > 
MAX_TID_PAIR_ENTRIES
) {

649 
»t
 = -
EINVAL
;

650 
ä“_»q
;

659 
tmp
 = 
	`memdup_u£r
(
iovec
[
idx
].
iov_ba£
,

660 
Áids
 * (*
»q
->
tids
));

661 ià(
	`IS_ERR
(
tmp
)) {

662 
»t
 = 
	`PTR_ERR
(
tmp
);

663 
	`SDMA_DBG
(
»q
, "Failedo copy %d TIDs (%d)",

664 
Áids
, 
»t
);

665 
ä“_»q
;

667 
»q
->
tids
 = 
tmp
;

668 
»q
->
n_tids
 = 
Áids
;

669 
»q
->
tididx
 = 0;

670 
idx
++;

673 
dlid
 = 
	`be16_to_ýu
(
»q
->
hdr
.
Ìh
[1]);

674 
£ËùÜ
 = 
	`dlid_to_£ËùÜ
(
dlid
);

675 
£ËùÜ
 +ð
uùxt
->
ùxt
 + 
fd
->
subùxt
;

676 
»q
->
sde
 = 
	`sdma_£Ëù_u£r_’gše
(
dd
, 
£ËùÜ
, 
vl
);

678 ià(!
»q
->
sde
 || !
	`sdma_ruÂšg
(req->sde)) {

679 
»t
 = -
ECOMM
;

680 
ä“_»q
;

684 ià(
»q
->
šfo
.
Åkts
 > 1 && 
	`HFI1_CAP_IS_USET
(
SDMA_AHG
))

685 
»q
->
ahg_idx
 = 
	`sdma_ahg_®loc
Ôeq->
sde
);

687 
	`£t_comp_¡©e
(
pq
, 
cq
, 
šfo
.
comp_idx
, 
QUEUED
, 0);

688 
pq
->
¡©e
 = 
SDMA_PKT_Q_ACTIVE
;

696 
»q
->
£qsubm™‹d
 !ð»q->
šfo
.
Åkts
) {

697 
»t
 = 
	`u£r_sdma_£nd_pkts
(
»q
, 
pcouÁ
);

698 ià(
»t
 < 0) {

699 ià(
»t
 !ð-
EBUSY
)

700 
ä“_»q
;

701 ià(
	`wa™_ev’t_š‹¼u±ibË_timeout
(

702 
pq
->
busy
.
wa™_dma
,

703 
pq
->
¡©e
 =ð
SDMA_PKT_Q_ACTIVE
,

704 
	`m£cs_to_jiff›s
(

705 
SDMA_IOWAIT_TIMEOUT
)) <= 0)

706 
	`æush_pq_iowa™
(
pq
);

709 *
couÁ
 +ð
idx
;

711 
ä“_»q
:

717 ià(
»q
->
£qsubm™‹d
 <„eq->
šfo
.
Åkts
) {

718 ià(
»q
->
£qsubm™‹d
)

719 
	`wa™_ev’t
(
pq
->
busy
.
wa™_dma
,

720 (
»q
->
£qcomp
 =ð»q->
£qsubm™‹d
 - 1));

721 
	`u£r_sdma_ä“_»que¡
(
»q
, 
Œue
);

722 
	`pq_upd©e
(
pq
);

723 
	`£t_comp_¡©e
(
pq
, 
cq
, 
šfo
.
comp_idx
, 
ERROR
, 
»t
);

725  
»t
;

726 
	}
}

728 
šlše
 
u32
 
	$compu‹_d©a_Ëngth
(
u£r_sdma_»que¡
 *
»q
,

729 
u£r_sdma_tx»q
 *
tx
)

743 
u32
 
Ën
;

745 ià(!
»q
->
£qnum
) {

746 ià(
»q
->
d©a_Ën
 < (
u32
))

747 
Ën
 = 
»q
->
d©a_Ën
;

749 
Ën
 = ((
	`be16_to_ýu
(
»q
->
hdr
.
Ìh
[2]) << 2) -

750 ((
tx
->
hdr
) - 4));

751 } ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
) {

752 
u32
 
tidËn
 = 
	`EXP_TID_GET
(
»q
->
tids
[»q->
tididx
], 
LEN
) *

753 
PAGE_SIZE
;

758 
Ën
 = 
	`mš
(
tidËn
 - 
»q
->
tidoff£t
, (
u32
ìeq->
šfo
.
äagsize
);

760 ià(
	`uÆik–y
(!
Ën
è&& ++
»q
->
tididx
 <„eq->
n_tids
 &&

761 
»q
->
tids
[»q->
tididx
]) {

762 
tidËn
 = 
	`EXP_TID_GET
(
»q
->
tids
[»q->
tididx
],

763 
LEN
è* 
PAGE_SIZE
;

764 
»q
->
tidoff£t
 = 0;

765 
Ën
 = 
	`mš_t
(
u32
, 
tidËn
, 
»q
->
šfo
.
äagsize
);

772 
Ën
 = 
	`mš
Ö’, 
»q
->
d©a_Ën
 -„eq->
£Á
);

774 
Ën
 = 
	`mš
(
»q
->
d©a_Ën
 -„eq->
£Á
, (
u32
ìeq->
šfo
.
äagsize
);

776 
	`Œaû_hfi1_sdma_u£r_compu‹_Ëngth
(
»q
->
pq
->
dd
,

777 
»q
->
pq
->
ùxt
,

778 
»q
->
pq
->
subùxt
,

779 
»q
->
šfo
.
comp_idx
,

780 
Ën
);

781  
Ën
;

782 
	}
}

784 
šlše
 
u32
 
	$·d_Ën
(
u32
 
Ën
)

786 ià(
Ën
 & ((
u32
) - 1))

787 
Ën
 +ð(
u32
) - (len & ((u32) - 1));

788  
Ën
;

789 
	}
}

791 
šlše
 
u32
 
	$g‘_Ìh_Ën
(
hfi1_pkt_h—d”
 
hdr
, 
u32
 
Ën
)

794  (((
hdr
è- (hdr.
pbc
)è+ 4 + 
Ën
);

795 
	}
}

797 
	$u£r_sdma_txadd_ahg
(
u£r_sdma_»que¡
 *
»q
,

798 
u£r_sdma_tx»q
 *
tx
,

799 
u32
 
d©®’
)

801 
»t
;

802 
u16
 
pbþ’
 = 
	`Ë16_to_ýu
(
»q
->
hdr
.
pbc
[0]);

803 
u32
 
ÌhËn
 = 
	`g‘_Ìh_Ën
(
»q
->
hdr
, 
	`·d_Ën
(
d©®’
));

804 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

814 
	`memýy
(&
tx
->
hdr
, &
»q
->hdr, (tx->hdr));

815 ià(
	`PBC2LRH
(
pbþ’
è!ð
ÌhËn
) {

816 
pbþ’
 = (pbþ’ & 0xf000è| 
	`LRH2PBC
(
ÌhËn
);

817 
tx
->
hdr
.
pbc
[0] = 
	`ýu_to_Ë16
(
pbþ’
);

819 
»t
 = 
	`check_h—d”_‹m¶©e
(
»q
, &
tx
->
hdr
, 
ÌhËn
, 
d©®’
);

820 ià(
»t
)

821  
»t
;

822 
»t
 = 
	`sdma_txš™_ahg
(&
tx
->
tx»q
, 
SDMA_TXREQ_F_AHG_COPY
,

823 (
tx
->
hdr
è+ 
d©®’
, 
»q
->
ahg_idx
,

824 0, 
NULL
, 0, 
u£r_sdma_tx»q_cb
);

825 ià(
»t
)

826  
»t
;

827 
»t
 = 
	`sdma_txadd_kvaddr
(
pq
->
dd
, &
tx
->
tx»q
, &tx->
hdr
, (tx->hdr));

828 ià(
»t
)

829 
	`sdma_txþ—n
(
pq
->
dd
, &
tx
->
tx»q
);

830  
»t
;

831 
	}
}

833 
	$u£r_sdma_txadd
(
u£r_sdma_»que¡
 *
»q
,

834 
u£r_sdma_tx»q
 *
tx
,

835 
u£r_sdma_iovec
 *
iovec
, 
u32
 
d©®’
,

836 
u32
 *
queued_±r
, u32 *
d©a_£Á_±r
,

837 
u64
 *
iov_off£t_±r
)

839 
»t
;

840 
·geidx
, 
Ën
;

841 
ba£
, 
off£t
;

842 
u64
 
iov_off£t
 = *
iov_off£t_±r
;

843 
u32
 
queued
 = *
queued_±r
, 
d©a_£Á
 = *
d©a_£Á_±r
;

844 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

846 
ba£
 = ()
iovec
->
iov
.
iov_ba£
;

847 
off£t
 = 
	`off£t_š_·ge
(
ba£
 + 
iovec
->off£ˆ+ 
iov_off£t
);

848 
·geidx
 = (((
iovec
->
off£t
 + 
iov_off£t
 + 
ba£
è- (ba£ & 
PAGE_MASK
)) >>

849 
PAGE_SHIFT
);

850 
Ën
 = 
off£t
 + 
»q
->
šfo
.
äagsize
 > 
PAGE_SIZE
 ?

851 
PAGE_SIZE
 - 
off£t
 : 
»q
->
šfo
.
äagsize
;

852 
Ën
 = 
	`mš
((
d©®’
 - 
queued
),†en);

853 #ifdeà
NVIDIA_GPU_DIRECT


854 
»t
 = 
	`sdma_txadd_·ge
(
pq
->
dd
, &
tx
->
tx»q
, 
iovec
->
·ges
.
ho¡
[
·geidx
],

856 
»t
 = 
	`sdma_txadd_·ge
(
pq
->
dd
, &
tx
->
tx»q
, 
iovec
->
·ges
[
·geidx
],

858 
off£t
, 
Ën
);

859 ià(
»t
) {

860 
	`SDMA_DBG
(
»q
, "SDMAx»q‡dd…agçžed %d\n", 
»t
);

861  
»t
;

863 
iov_off£t
 +ð
Ën
;

864 
queued
 +ð
Ën
;

865 
d©a_£Á
 +ð
Ën
;

866 ià(
	`uÆik–y
(
queued
 < 
d©®’
 && 
·geidx
 =ð
iovec
->
Åages
 &&

867 
»q
->
iov_idx
 <„eq->
d©a_iovs
 - 1)) {

868 
iovec
->
off£t
 +ð
iov_off£t
;

869 
iovec
 = &
»q
->
iovs
[++»q->
iov_idx
];

870 
iov_off£t
 = 0;

873 *
queued_±r
 = 
queued
;

874 *
d©a_£Á_±r
 = 
d©a_£Á
;

875 *
iov_off£t_±r
 = 
iov_off£t
;

876  
»t
;

877 
	}
}

879 
	$u£r_sdma_£nd_pkts
(
u£r_sdma_»que¡
 *
»q
, 
u16
 
maxpkts
)

881 
»t
 = 0;

882 
u16
 
couÁ
;

883 
Åkts
 = 0;

884 
u£r_sdma_tx»q
 *
tx
 = 
NULL
;

885 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
NULL
;

886 
u£r_sdma_iovec
 *
iovec
 = 
NULL
;

888 ià(!
»q
->
pq
)

889  -
EINVAL
;

891 
pq
 = 
»q
->pq;

894 ià(
	`READ_ONCE
(
»q
->
has_”rÜ
))

895  -
EFAULT
;

900 ià(
	`uÆik–y
(
»q
->
£qnum
 =ð»q->
šfo
.
Åkts
)) {

901 ià(!
	`li¡_em±y
(&
»q
->
txps
))

902 
do£nd
;

903  
»t
;

906 ià(!
maxpkts
 || maxpkt > 
»q
->
šfo
.
Åkts
 -„eq->
£qnum
)

907 
maxpkts
 = 
»q
->
šfo
.
Åkts
 -„eq->
£qnum
;

909 
Åkts
 < 
maxpkts
) {

910 
u32
 
d©®’
 = 0, 
queued
 = 0, 
d©a_£Á
 = 0;

911 
u64
 
iov_off£t
 = 0;

918 ià(
	`READ_ONCE
(
»q
->
has_”rÜ
))

919  -
EFAULT
;

921 
tx
 = 
	`kmem_ÿche_®loc
(
pq
->
tx»q_ÿche
, 
GFP_KERNEL
);

922 ià(!
tx
)

923  -
ENOMEM
;

925 
tx
->
æags
 = 0;

926 
tx
->
»q
 =„eq;

927 
	`INIT_LIST_HEAD
(&
tx
->
li¡
);

933 ià(
»q
->
£qnum
 =ð»q->
šfo
.
Åkts
 - 1)

934 
tx
->
æags
 |ð(
TXREQ_FLAGS_REQ_ACK
 |

935 
TXREQ_FLAGS_REQ_DISABLE_SH
);

942 ià(
»q
->
d©a_Ën
) {

943 
iovec
 = &
»q
->
iovs
[»q->
iov_idx
];

944 ià(
	`READ_ONCE
(
iovec
->
off£t
è=ðiovec->
iov
.
iov_Ën
) {

945 ià(++
»q
->
iov_idx
 =ð»q->
d©a_iovs
) {

946 
»t
 = -
EFAULT
;

947 
ä“_tx
;

949 
iovec
 = &
»q
->
iovs
[»q->
iov_idx
];

950 
	`WARN_ON
(
iovec
->
off£t
);

953 
d©®’
 = 
	`compu‹_d©a_Ëngth
(
»q
, 
tx
);

963 ià(!
d©®’
) {

964 
	`SDMA_DBG
(
»q
,

966 
»t
 = -
EFAULT
;

967 
ä“_tx
;

968 } ià(
d©®’
 <= 32) {

969 
tx
->
æags
 |ð
TXREQ_FLAGS_REQ_DISABLE_SH
;

973 ià(
»q
->
ahg_idx
 >= 0) {

974 ià(!
»q
->
£qnum
) {

975 
»t
 = 
	`u£r_sdma_txadd_ahg
(
»q
, 
tx
, 
d©®’
);

976 ià(
»t
)

977 
ä“_tx
;

979 
chªges
;

981 
chªges
 = 
	`£t_tx»q_h—d”_ahg
(
»q
, 
tx
,

982 
d©®’
);

983 ià(
chªges
 < 0) {

984 
»t
 = 
chªges
;

985 
ä“_tx
;

989 
»t
 = 
	`sdma_txš™
(&
tx
->
tx»q
, 0, (
»q
->
hdr
) +

990 
d©®’
, 
u£r_sdma_tx»q_cb
);

991 ià(
»t
)

992 
ä“_tx
;

999 
»t
 = 
	`£t_tx»q_h—d”
(
»q
, 
tx
, 
d©®’
);

1000 ià(
»t
)

1001 
ä“_tx»q
;

1008 
queued
 < 
d©®’
 &&

1009 (
»q
->
£Á
 + 
d©a_£Á
è<„eq->
d©a_Ën
) {

1010 #ifdeà
NVIDIA_GPU_DIRECT


1011 ià(
»q
->
šfo
.
æags
 & 
HFI1_BUF_GPU_MEM
)

1012 
»t
 = 
	`u£r_sdma_txadd_gpu
(
»q
, 
tx
, 
iovec
,

1013 
d©®’
, &
queued
,

1014 &
d©a_£Á
,

1015 &
iov_off£t
);

1018 
»t
 = 
	`u£r_sdma_txadd
(
»q
, 
tx
, 
iovec
, 
d©®’
,

1019 &
queued
, &
d©a_£Á
,

1020 &
iov_off£t
);

1021 ià(
»t
)

1022 
ä“_tx»q
;

1028 
»q
->
koff£t
 +ð
d©®’
;

1029 ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
)

1030 
»q
->
tidoff£t
 +ð
d©®’
;

1031 
»q
->
£Á
 +ð
d©a_£Á
;

1032 ià(
»q
->
d©a_Ën
)

1033 
iovec
->
off£t
 +ð
iov_off£t
;

1034 
	`li¡_add_ž
(&
tx
->
tx»q
.
li¡
, &
»q
->
txps
);

1040 
tx
->
£qnum
 = 
»q
->seqnum++;

1041 
Åkts
++;

1043 
do£nd
:

1044 
»t
 = 
	`sdma_£nd_txli¡
(
»q
->
sde
,

1045 
	`iowa™_g‘_ib_wÜk
(&
pq
->
busy
),

1046 &
»q
->
txps
, &
couÁ
);

1047 
»q
->
£qsubm™‹d
 +ð
couÁ
;

1048 ià(
»q
->
£qsubm™‹d
 =ð»q->
šfo
.
Åkts
) {

1055 ià(
»q
->
ahg_idx
 >= 0)

1056 
	`sdma_ahg_ä“
(
»q
->
sde
,„eq->
ahg_idx
);

1058  
»t
;

1060 
ä“_tx»q
:

1061 
	`sdma_txþ—n
(
pq
->
dd
, &
tx
->
tx»q
);

1062 
ä“_tx
:

1063 
	`kmem_ÿche_ä“
(
pq
->
tx»q_ÿche
, 
tx
);

1064  
»t
;

1065 
	}
}

1067 
u32
 
	$sdma_ÿche_eviù
(
hfi1_u£r_sdma_pkt_q
 *
pq
, 
u32
 
Åages
)

1069 
eviù_d©a
ƒvict_data;

1071 
eviù_d©a
.
þ—»d
 = 0;

1072 
eviù_d©a
.
rg‘
 = 
Åages
;

1073 
	`hfi1_mmu_rb_eviù
(
pq
->
hªdËr
, &
eviù_d©a
);

1074  
eviù_d©a
.
þ—»d
;

1075 
	}
}

1077 
	$pš_sdma_·ges
(
u£r_sdma_»que¡
 *
»q
,

1078 
u£r_sdma_iovec
 *
iovec
,

1079 
sdma_mmu_node
 *
node
,

1080 
Åages
)

1082 
pšÃd
, 
þ—»d
;

1083 
·ge
 **
·ges
;

1084 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

1086 
·ges
 = 
	`kÿÎoc
(
Åages
, (*·ges), 
GFP_KERNEL
);

1087 ià(!
·ges
)

1088  -
ENOMEM
;

1089 #ifdeà
NVIDIA_GPU_DIRECT


1090 
	`memýy
(
·ges
, 
node
->·ges.
ho¡
,‚ode->
Åages
 * (*pages));

1092 
	`memýy
(
·ges
, 
node
->·ges,‚ode->
Åages
 * (*pages));

1095 
Åages
 -ð
node
->npages;

1096 
»Œy
:

1097 ià(!
	`hfi1_ÿn_pš_·ges
(
pq
->
dd
,…q->
mm
,

1098 
	`©omic_»ad
(&
pq
->
n_locked
), 
Åages
)) {

1099 
þ—»d
 = 
	`sdma_ÿche_eviù
(
pq
, 
Åages
);

1100 ià(
þ—»d
 >ð
Åages
)

1101 
»Œy
;

1103 
pšÃd
 = 
	`hfi1_acquœe_u£r_·ges
(
pq
->
mm
,

1104 (()
iovec
->
iov
.
iov_ba£
 +

1105 (
node
->
Åages
 * 
PAGE_SIZE
)),‚pages, 0,

1106 
·ges
 + 
node
->
Åages
);

1107 ià(
pšÃd
 < 0) {

1108 
	`kä“
(
·ges
);

1109  
pšÃd
;

1111 ià(
pšÃd
 !ð
Åages
) {

1112 
	`uÅš_veùÜ_·ges
(
pq
->
mm
, 
·ges
, 
node
->
Åages
, 
pšÃd
);

1113  -
EFAULT
;

1115 #ifdeà
NVIDIA_GPU_DIRECT


1116 
	`kä“
(
node
->
·ges
.
ho¡
);

1117 
node
->
·ges
.
ho¡
 =…ages;

1119 
	`kä“
(
node
->
·ges
);

1120 
node
->
·ges
 =…ages;

1122 
node
->
rb
.
Ën
 = 
iovec
->
iov
.
iov_Ën
;

1123 
	`©omic_add
(
pšÃd
, &
pq
->
n_locked
);

1124  
pšÃd
;

1125 
	}
}

1127 
	$uÅš_sdma_·ges
(
sdma_mmu_node
 *
node
)

1129 ià(
node
->
Åages
) {

1130 #ifdeà
NVIDIA_GPU_DIRECT


1131 
	`uÅš_veùÜ_·ges
(
node
->
pq
->
mm
,‚ode->
·ges
.
ho¡
, 0,‚ode->
Åages
);

1133 
	`uÅš_veùÜ_·ges
(
node
->
pq
->
mm
,‚ode->
·ges
, 0,‚ode->
Åages
);

1135 
	`©omic_sub
(
node
->
Åages
, &node->
pq
->
n_locked
);

1137 
	}
}

1139 
	$pš_veùÜ_·ges
(
u£r_sdma_»que¡
 *
»q
,

1140 
u£r_sdma_iovec
 *
iovec
)

1142 
»t
 = 0, 
pšÃd
, 
Åages
;

1143 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

1144 
sdma_mmu_node
 *
node
 = 
NULL
;

1145 
mmu_rb_node
 *
rb_node
;

1146 
iovec
 *
iov
 = &iovec->iov;

1147 
boÞ
 
exŒaùed
, 
Úgpu
;

1148 
addr
, 
size
;

1149 
mmu_rb_hªdËr
 *
hªdËr
;

1151 #ifdeà
NVIDIA_GPU_DIRECT


1152 ià(
»q
->
šfo
.
æags
 & 
HFI1_BUF_GPU_MEM
) {

1161 
size
 = 
iov
->
iov_Ën
 +

1162 (()
iov
->
iov_ba£
 & ~
NV_GPU_PAGE_MASK
);

1163 
addr
 = ()
iov
->
iov_ba£
 & 
NV_GPU_PAGE_MASK
;

1164 
Úgpu
 = 
Œue
;

1165 
hªdËr
 = 
pq
->
hªdËr_gpu
;

1169 
size
 = 
iovec
->
iov
.
iov_Ën
;

1170 
addr
 = ()
iovec
->
iov
.
iov_ba£
;

1171 
Úgpu
 = 
çl£
;

1172 
hªdËr
 = 
pq
->handler;

1174 
exŒaùed
 = 
	`hfi1_mmu_rb_»move_uÆess_exaù
(
hªdËr
, 
addr
,

1175 
size
, &
rb_node
);

1176 ià(
rb_node
) {

1177 
node
 = 
	`cÚš”_of
(
rb_node
, 
sdma_mmu_node
, 
rb
);

1178 ià(!
exŒaùed
) {

1179 
	`©omic_šc
(&
node
->
»fcouÁ
);

1180 #ifdeà
NVIDIA_GPU_DIRECT


1181 ià(
Úgpu
)

1182 
iovec
->
·ges
.
gpu
 = 
node
->pages.gpu;

1184 
iovec
->
·ges
.
ho¡
 = 
node
->pages.host;

1186 
iovec
->
·ges
 = 
node
->pages;

1188 
iovec
->
Åages
 = 
node
->npages;

1189 
iovec
->
node
 =‚ode;

1194 ià(!
node
) {

1195 
node
 = 
	`kz®loc
((*node), 
GFP_KERNEL
);

1196 ià(!
node
)

1197  -
ENOMEM
;

1199 
node
->
rb
.
addr
 =‡ddr;

1200 
node
->
pq
 =…q;

1201 
	`©omic_£t
(&
node
->
»fcouÁ
, 0);

1204 #ifdeà
NVIDIA_GPU_DIRECT


1205 ià(
Úgpu
)

1206 
Åages
 = 
	`num_u£r_·ges_gpu
(()
iov
->
iov_ba£
,

1207 
iov
->
iov_Ën
);

1210 
Åages
 = 
	`num_u£r_·ges
(()
iov
->
iov_ba£
,

1211 
iov
->
iov_Ën
);

1212 ià(
node
->
Åages
 <‚pages) {

1213 #ifdeà
NVIDIA_GPU_DIRECT


1214 
node
->
Úgpu
 = ongpu;

1215 ià(
Úgpu
)

1216 
pšÃd
 = 
	`pš_sdma_·ges_gpu
(
iovec
, 
node
, 
»q
, 
Åages
,

1217 
size
, 
addr
);

1220 
pšÃd
 = 
	`pš_sdma_·ges
(
»q
, 
iovec
, 
node
, 
Åages
);

1221 ià(
pšÃd
 < 0) {

1222 
»t
 = 
pšÃd
;

1223 
baž
;

1225 
node
->
Åages
 +ð
pšÃd
;

1226 
Åages
 = 
node
->npages;

1228 #ifdeà
NVIDIA_GPU_DIRECT


1229 ià(
Úgpu
)

1230 
iovec
->
·ges
.
gpu
 = 
node
->pages.gpu;

1232 
iovec
->
·ges
.
ho¡
 = 
node
->pages.host;

1234 
iovec
->
·ges
 = 
node
->pages;

1236 
iovec
->
Åages
 =‚pages;

1237 
iovec
->
node
 =‚ode;

1239 
»t
 = 
	`hfi1_mmu_rb_š£¹
(
hªdËr
, &
node
->
rb
);

1240 ià(
»t
) {

1241 
iovec
->
node
 = 
NULL
;

1242 
baž
;

1245 
baž
:

1246 #ifdeà
NVIDIA_GPU_DIRECT


1247 ià(
Úgpu
)

1248 
	`uÅš_sdma_·ges_gpu
(
node
);

1251 
	`uÅš_sdma_·ges
(
node
);

1252 
	`kä“
(
node
);

1253  
»t
;

1254 
	}
}

1256 
	$uÅš_veùÜ_·ges
(
mm_¡ruù
 *
mm
, 
·ge
 **
·ges
,

1257 
¡¬t
, 
Åages
)

1259 
	`hfi1_»Ëa£_u£r_·ges
(
mm
, 
·ges
 + 
¡¬t
, 
Åages
, 
çl£
);

1260 
	`kä“
(
·ges
);

1261 
	}
}

1263 
	$check_h—d”_‹m¶©e
(
u£r_sdma_»que¡
 *
»q
,

1264 
hfi1_pkt_h—d”
 *
hdr
, 
u32
 
ÌhËn
,

1265 
u32
 
d©®’
)

1277 ià(
»q
->
šfo
.
äagsize
 % 
PIO_BLOCK_SIZE
 || 
ÌhËn
 & 0x3 ||

1278 
ÌhËn
 > 
	`g‘_Ìh_Ën
(*
hdr
, 
»q
->
šfo
.
äagsize
))

1279  -
EINVAL
;

1281 ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
) {

1288 
u32
 
tidv®
 = 
»q
->
tids
[»q->
tididx
],

1289 
tidËn
 = 
	`EXP_TID_GET
(
tidv®
, 
LEN
è* 
PAGE_SIZE
,

1290 
tididx
 = 
	`EXP_TID_GET
(
tidv®
, 
IDX
),

1291 
tidù¾
 = 
	`EXP_TID_GET
(
tidv®
, 
CTRL
),

1292 
tidoff
;

1293 
__Ë32
 
kv®
 = 
hdr
->
kd‘h
.
v”_tid_off£t
;

1295 
tidoff
 = 
	`KDETH_GET
(
kv®
, 
OFFSET
) *

1296 (
	`KDETH_GET
(
»q
->
hdr
.
kd‘h
.
v”_tid_off£t
, 
OM
) ?

1297 
KDETH_OM_LARGE
 : 
KDETH_OM_SMALL
);

1305 ià((
tidoff
 + 
d©®’
 > 
tidËn
) ||

1306 
	`KDETH_GET
(
kv®
, 
TIDCTRL
è!ð
tidù¾
 ||

1307 
	`KDETH_GET
(
kv®
, 
TID
è!ð
tididx
)

1308  -
EINVAL
;

1311 
	}
}

1319 
šlše
 
u32
 
	$£t_pkt_bth_p¢
(
__be32
 
bthp¢
, 
u8
 
expù
, 
u32
 
äags
)

1321 
u32
 
v®
 = 
	`be32_to_ýu
(
bthp¢
),

1322 
mask
 = (
	`HFI1_CAP_IS_KSET
(
EXTENDED_PSN
) ? 0x7fffffffull :

1324 
p¢
 = 
v®
 & 
mask
;

1325 ià(
expù
)

1326 
p¢
 = (p¢ & ~
HFI1_KDETH_BTH_SEQ_MASK
) |

1327 ((
p¢
 + 
äags
è& 
HFI1_KDETH_BTH_SEQ_MASK
);

1329 
p¢
 =…¢ + 
äags
;

1330  
p¢
 & 
mask
;

1331 
	}
}

1333 
	$£t_tx»q_h—d”
(
u£r_sdma_»que¡
 *
»q
,

1334 
u£r_sdma_tx»q
 *
tx
, 
u32
 
d©®’
)

1336 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

1337 
hfi1_pkt_h—d”
 *
hdr
 = &
tx
->hdr;

1338 
u8
 
omçùÜ
;

1339 
u16
 
pbþ’
;

1340 
»t
;

1341 
u32
 
tidv®
 = 0, 
ÌhËn
 = 
	`g‘_Ìh_Ën
(*
hdr
, 
	`·d_Ën
(
d©®’
));

1344 
	`memýy
(
hdr
, &
»q
->hdr, (*hdr));

1350 
pbþ’
 = 
	`Ë16_to_ýu
(
hdr
->
pbc
[0]);

1351 ià(
	`PBC2LRH
(
pbþ’
è!ð
ÌhËn
) {

1352 
pbþ’
 = (pbþ’ & 0xf000è| 
	`LRH2PBC
(
ÌhËn
);

1353 
hdr
->
pbc
[0] = 
	`ýu_to_Ë16
(
pbþ’
);

1354 
hdr
->
Ìh
[2] = 
	`ýu_to_be16
(
ÌhËn
 >> 2);

1361 ià(
	`uÆik–y
(
»q
->
£qnum
 == 2)) {

1369 
»q
->
hdr
.
pbc
[0] = hdr->pbc[0];

1370 
»q
->
hdr
.
Ìh
[2] = hdr->lrh[2];

1378 ià(
	`uÆik–y
(!
»q
->
£qnum
)) {

1379 
»t
 = 
	`check_h—d”_‹m¶©e
(
»q
, 
hdr
, 
ÌhËn
, 
d©®’
);

1380 ià(
»t
)

1381  
»t
;

1382 
dÚe
;

1385 
hdr
->
bth
[2] = 
	`ýu_to_be32
(

1386 
	`£t_pkt_bth_p¢
(
hdr
->
bth
[2],

1387 (
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
),

1388 
»q
->
£qnum
));

1391 ià(
	`uÆik–y
(
tx
->
æags
 & 
TXREQ_FLAGS_REQ_ACK
))

1392 
hdr
->
bth
[2] |ð
	`ýu_to_be32
(1UL << 31);

1395 
hdr
->
kd‘h
.
swd©a
[6] = 
	`ýu_to_Ë32
(
»q
->
koff£t
);

1397 ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
) {

1398 
tidv®
 = 
»q
->
tids
[»q->
tididx
];

1403 ià((
»q
->
tidoff£t
è=ð(
	`EXP_TID_GET
(
tidv®
, 
LEN
) *

1404 
PAGE_SIZE
)) {

1405 
»q
->
tidoff£t
 = 0;

1410 ià(++
»q
->
tididx
 >„eq->
n_tids
 - 1 ||

1411 !
»q
->
tids
[»q->
tididx
]) {

1412  -
EINVAL
;

1414 
tidv®
 = 
»q
->
tids
[»q->
tididx
];

1416 
omçùÜ
 = 
	`EXP_TID_GET
(
tidv®
, 
LEN
è* 
PAGE_SIZE
 >=

1417 
KDETH_OM_MAX_SIZE
 ? 
KDETH_OM_LARGE_SHIFT
 :

1418 
KDETH_OM_SMALL_SHIFT
;

1420 
	`KDETH_SET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
TIDCTRL
,

1421 
	`EXP_TID_GET
(
tidv®
, 
CTRL
));

1423 
	`KDETH_SET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
TID
,

1424 
	`EXP_TID_GET
(
tidv®
, 
IDX
));

1426 ià(
	`uÆik–y
(
tx
->
æags
 & 
TXREQ_FLAGS_REQ_DISABLE_SH
))

1427 
	`KDETH_SET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
SH
, 0);

1432 
	`Œaû_hfi1_sdma_u£r_tid_šfo
(

1433 
pq
->
dd
,…q->
ùxt
,…q->
subùxt
, 
»q
->
šfo
.
comp_idx
,

1434 
»q
->
tidoff£t
,„eq->tidoff£ˆ>> 
omçùÜ
,

1435 
omçùÜ
 !ð
KDETH_OM_SMALL_SHIFT
);

1436 
	`KDETH_SET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
OFFSET
,

1437 
»q
->
tidoff£t
 >> 
omçùÜ
);

1438 
	`KDETH_SET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
OM
,

1439 
omçùÜ
 !ð
KDETH_OM_SMALL_SHIFT
);

1441 
dÚe
:

1442 
	`Œaû_hfi1_sdma_u£r_h—d”
(
pq
->
dd
,…q->
ùxt
,…q->
subùxt
,

1443 
»q
->
šfo
.
comp_idx
, 
hdr
, 
tidv®
);

1444  
	`sdma_txadd_kvaddr
(
pq
->
dd
, &
tx
->
tx»q
, 
hdr
, (*hdr));

1445 
	}
}

1447 
	$£t_tx»q_h—d”_ahg
(
u£r_sdma_»que¡
 *
»q
,

1448 
u£r_sdma_tx»q
 *
tx
, 
u32
 
d©®’
)

1450 
u32
 
ahg
[
AHG_KDETH_ARRAY_SIZE
];

1451 
idx
 = 0;

1452 
u8
 
omçùÜ
;

1453 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

1454 
hfi1_pkt_h—d”
 *
hdr
 = &
»q
->hdr;

1455 
u16
 
pbþ’
 = 
	`Ë16_to_ýu
(
hdr
->
pbc
[0]);

1456 
u32
 
v®32
, 
tidv®
 = 0, 
ÌhËn
 = 
	`g‘_Ìh_Ën
(*
hdr
, 
	`·d_Ën
(
d©®’
));

1457 
size_t
 
¬¿y_size
 = 
	`ARRAY_SIZE
(
ahg
);

1459 ià(
	`PBC2LRH
(
pbþ’
è!ð
ÌhËn
) {

1461 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 0, 0, 12,

1462 (
__fÜû
 
u16
)
	`ýu_to_Ë16
(
	`LRH2PBC
(
ÌhËn
)));

1463 ià(
idx
 < 0)

1464  
idx
;

1466 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 3, 0, 16,

1467 (
__fÜû
 
u16
)
	`ýu_to_be16
(
ÌhËn
 >> 2));

1468 ià(
idx
 < 0)

1469  
idx
;

1476 
v®32
 = (
	`be32_to_ýu
(
hdr
->
bth
[2]è+ 
»q
->
£qnum
) &

1477 (
	`HFI1_CAP_IS_KSET
(
EXTENDED_PSN
) ? 0x7fffffff : 0xffffff);

1478 ià(
	`uÆik–y
(
tx
->
æags
 & 
TXREQ_FLAGS_REQ_ACK
))

1479 
v®32
 |= 1UL << 31;

1480 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 6, 0, 16,

1481 (
__fÜû
 
u16
)
	`ýu_to_be16
(
v®32
 >> 16));

1482 ià(
idx
 < 0)

1483  
idx
;

1484 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 6, 16, 16,

1485 (
__fÜû
 
u16
)
	`ýu_to_be16
(
v®32
 & 0xffff));

1486 ià(
idx
 < 0)

1487  
idx
;

1489 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 15, 0, 16,

1490 (
__fÜû
 
u16
)
	`ýu_to_Ë16
(
»q
->
koff£t
 & 0xffff));

1491 ià(
idx
 < 0)

1492  
idx
;

1493 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
, 15, 16, 16,

1494 (
__fÜû
 
u16
)
	`ýu_to_Ë16
(
»q
->
koff£t
 >> 16));

1495 ià(
idx
 < 0)

1496  
idx
;

1497 ià(
	`»q_Ýcode
(
»q
->
šfo
.
ù¾
è=ð
EXPECTED
) {

1498 
__Ë16
 
v®
;

1500 
tidv®
 = 
»q
->
tids
[»q->
tididx
];

1506 ià((
»q
->
tidoff£t
è=ð(
	`EXP_TID_GET
(
tidv®
, 
LEN
) *

1507 
PAGE_SIZE
)) {

1508 
»q
->
tidoff£t
 = 0;

1513 ià(++
»q
->
tididx
 >„eq->
n_tids
 - 1 ||

1514 !
»q
->
tids
[»q->
tididx
])

1515  -
EINVAL
;

1516 
tidv®
 = 
»q
->
tids
[»q->
tididx
];

1518 
omçùÜ
 = ((
	`EXP_TID_GET
(
tidv®
, 
LEN
) *

1519 
PAGE_SIZE
) >=

1520 
KDETH_OM_MAX_SIZE
è? 
KDETH_OM_LARGE_SHIFT
 :

1521 
KDETH_OM_SMALL_SHIFT
;

1523 
idx
 = 
	`ahg_h—d”_£t
(

1524 
ahg
, 
idx
, 
¬¿y_size
, 7, 0, 16,

1525 ((!!(
omçùÜ
 - 
KDETH_OM_SMALL_SHIFT
)) << 15 |

1526 ((
»q
->
tidoff£t
 >> 
omçùÜ
)

1528 ià(
idx
 < 0)

1529  
idx
;

1531 
v®
 = 
	`ýu_to_Ë16
(((
	`EXP_TID_GET
(
tidv®
, 
CTRL
) & 0x3) << 10) |

1532 (
	`EXP_TID_GET
(
tidv®
, 
IDX
) & 0x3ff));

1534 ià(
	`uÆik–y
(
tx
->
æags
 & 
TXREQ_FLAGS_REQ_DISABLE_SH
)) {

1535 
v®
 |ð
	`ýu_to_Ë16
((
	`KDETH_GET
(
hdr
->
kd‘h
.
v”_tid_off£t
,

1536 
INTR
) <<

1537 
AHG_KDETH_INTR_SHIFT
));

1539 
v®
 |ð
	`KDETH_GET
(
hdr
->
kd‘h
.
v”_tid_off£t
, 
SH
) ?

1540 
	`ýu_to_Ë16
(0x1 << 
AHG_KDETH_SH_SHIFT
) :

1541 
	`ýu_to_Ë16
((
	`KDETH_GET
(
hdr
->
kd‘h
.
v”_tid_off£t
,

1542 
INTR
) <<

1543 
AHG_KDETH_INTR_SHIFT
));

1546 
idx
 = 
	`ahg_h—d”_£t
(
ahg
, idx, 
¬¿y_size
,

1547 7, 16, 14, (
__fÜû
 
u16
)
v®
);

1548 ià(
idx
 < 0)

1549  
idx
;

1552 
	`Œaû_hfi1_sdma_u£r_h—d”_ahg
(
pq
->
dd
,…q->
ùxt
,…q->
subùxt
,

1553 
»q
->
šfo
.
comp_idx
,„eq->
sde
->
this_idx
,

1554 
»q
->
ahg_idx
, 
ahg
, 
idx
, 
tidv®
);

1555 
	`sdma_txš™_ahg
(&
tx
->
tx»q
,

1556 
SDMA_TXREQ_F_USE_AHG
,

1557 
d©®’
, 
»q
->
ahg_idx
, 
idx
,

1558 
ahg
, (
»q
->
hdr
),

1559 
u£r_sdma_tx»q_cb
);

1561  
idx
;

1562 
	}
}

1574 
	$u£r_sdma_tx»q_cb
(
sdma_tx»q
 *
tx»q
, 
¡©us
)

1576 
u£r_sdma_tx»q
 *
tx
 =

1577 
	`cÚš”_of
(
tx»q
, 
u£r_sdma_tx»q
,xreq);

1578 
u£r_sdma_»que¡
 *
»q
;

1579 
hfi1_u£r_sdma_pkt_q
 *
pq
;

1580 
hfi1_u£r_sdma_comp_q
 *
cq
;

1581 
hfi1_sdma_comp_¡©e
 
¡©e
 = 
COMPLETE
;

1583 ià(!
tx
->
»q
)

1586 
»q
 = 
tx
->req;

1587 
pq
 = 
»q
->pq;

1588 
cq
 = 
»q
->cq;

1590 ià(
¡©us
 !ð
SDMA_TXREQ_S_OK
) {

1591 
	`SDMA_DBG
(
»q
, "SDMA completion withƒrror %d",

1592 
¡©us
);

1593 
	`WRITE_ONCE
(
»q
->
has_”rÜ
, 1);

1594 
¡©e
 = 
ERROR
;

1597 
»q
->
£qcomp
 = 
tx
->
£qnum
;

1598 
	`kmem_ÿche_ä“
(
pq
->
tx»q_ÿche
, 
tx
);

1601 ià(
»q
->
£qcomp
 !ð»q->
šfo
.
Åkts
 - 1)

1604 
	`u£r_sdma_ä“_»que¡
(
»q
, 
çl£
);

1605 
	`£t_comp_¡©e
(
pq
, 
cq
, 
»q
->
šfo
.
comp_idx
, 
¡©e
, 
¡©us
);

1606 
	`pq_upd©e
(
pq
);

1607 
	}
}

1609 
šlše
 
	$pq_upd©e
(
hfi1_u£r_sdma_pkt_q
 *
pq
)

1611 ià(
	`©omic_dec_ªd_‹¡
(&
pq
->
n_»qs
))

1612 
	`wake_up
(&
pq
->
wa™
);

1613 
	}
}

1615 
	$u£r_sdma_ä“_»que¡
(
u£r_sdma_»que¡
 *
»q
, 
boÞ
 
uÅš
)

1617 
i
;

1619 ià(!
	`li¡_em±y
(&
»q
->
txps
)) {

1620 
sdma_tx»q
 *
t
, *
p
;

1622 
	`li¡_fÜ_—ch_’Œy_§ã
(
t
, 
p
, &
»q
->
txps
, 
li¡
) {

1623 
u£r_sdma_tx»q
 *
tx
 =

1624 
	`cÚš”_of
(
t
, 
u£r_sdma_tx»q
, 
tx»q
);

1625 
	`li¡_d–_š™
(&
t
->
li¡
);

1626 
	`sdma_txþ—n
(
»q
->
pq
->
dd
, 
t
);

1627 
	`kmem_ÿche_ä“
(
»q
->
pq
->
tx»q_ÿche
, 
tx
);

1630 
i
 = 0; i < 
»q
->
d©a_iovs
; i++) {

1631 
sdma_mmu_node
 *
node
 = 
»q
->
iovs
[
i
].node;

1633 ià(!
node
)

1636 
»q
->
iovs
[
i
].
node
 = 
NULL
;

1638 ià(
uÅš
)

1639 #ifdeà
NVIDIA_GPU_DIRECT


1640 ià(
node
->
Úgpu
)

1641 
	`hfi1_mmu_rb_»move
(
»q
->
pq
->
hªdËr_gpu
,

1642 &
node
->
rb
);

1645 
	`hfi1_mmu_rb_»move
(
»q
->
pq
->
hªdËr
,

1646 &
node
->
rb
);

1648 
	`©omic_dec
(&
node
->
»fcouÁ
);

1651 
	`kä“
(
»q
->
tids
);

1652 
	`þ—r_b™
(
»q
->
šfo
.
comp_idx
,„eq->
pq
->
»q_š_u£
);

1653 
	}
}

1655 
šlše
 
	$£t_comp_¡©e
(
hfi1_u£r_sdma_pkt_q
 *
pq
,

1656 
hfi1_u£r_sdma_comp_q
 *
cq
,

1657 
u16
 
idx
, 
hfi1_sdma_comp_¡©e
 
¡©e
,

1658 
»t
)

1660 ià(
¡©e
 =ð
ERROR
)

1661 
cq
->
comps
[
idx
].
”rcode
 = -
»t
;

1662 
	`smp_wmb
();

1663 
cq
->
comps
[
idx
].
¡©us
 = 
¡©e
;

1664 
	`Œaû_hfi1_sdma_u£r_com¶‘iÚ
(
pq
->
dd
,…q->
ùxt
,…q->
subùxt
,

1665 
idx
, 
¡©e
, 
»t
);

1666 
	}
}

1668 
boÞ
 
	$sdma_rb_fž‹r
(
mmu_rb_node
 *
node
, 
addr
,

1669 
Ën
)

1671  (
boÞ
)(
node
->
addr
 ==‡ddr);

1672 
	}
}

1674 
	$sdma_rb_š£¹
(*
¬g
, 
mmu_rb_node
 *
mnode
)

1676 
sdma_mmu_node
 *
node
 =

1677 
	`cÚš”_of
(
mnode
, 
sdma_mmu_node
, 
rb
);

1679 
	`©omic_šc
(&
node
->
»fcouÁ
);

1681 
	}
}

1688 
	$sdma_rb_eviù
(*
¬g
, 
mmu_rb_node
 *
mnode
,

1689 *
eviù_¬g
, 
boÞ
 *
¡Ý
)

1691 
sdma_mmu_node
 *
node
 =

1692 
	`cÚš”_of
(
mnode
, 
sdma_mmu_node
, 
rb
);

1693 
eviù_d©a
 *eviù_d©¨ð
eviù_¬g
;

1696 ià(
	`©omic_»ad
(&
node
->
»fcouÁ
))

1700 
eviù_d©a
->
þ—»d
 +ð
node
->
Åages
;

1703 ià(
eviù_d©a
->
þ—»d
 >ðeviù_d©a->
rg‘
)

1704 *
¡Ý
 = 
Œue
;

1707 
	}
}

1709 
	$sdma_rb_»move
(*
¬g
, 
mmu_rb_node
 *
mnode
)

1711 
sdma_mmu_node
 *
node
 =

1712 
	`cÚš”_of
(
mnode
, 
sdma_mmu_node
, 
rb
);

1714 #ifdeà
NVIDIA_GPU_DIRECT


1715 ià(
node
->
Úgpu
)

1716 
	`uÅš_sdma_·ges_gpu
(
node
);

1719 
	`uÅš_sdma_·ges
(
node
);

1720 
	`kä“
(
node
);

1721 
	}
}

1723 
	$sdma_rb_šv®id©e
(*
¬g
, 
mmu_rb_node
 *
mnode
)

1725 
sdma_mmu_node
 *
node
 =

1726 
	`cÚš”_of
(
mnode
, 
sdma_mmu_node
, 
rb
);

1728 ià(!
	`©omic_»ad
(&
node
->
»fcouÁ
))

1731 
	}
}

	@user_sdma.h

1 #iâdeà
_HFI1_USER_SDMA_H


2 
	#_HFI1_USER_SDMA_H


	)

49 
	~<lšux/deviû.h
>

50 
	~<lšux/wa™.h
>

52 
	~"commÚ.h
"

53 
	~"iowa™.h
"

54 
	~"u£r_exp_rcv.h
"

57 
	#MAX_VECTORS_PER_REQ
 8

	)

62 
	#MAX_PKTS_PER_QUEUE
 16

	)

64 
	#num_·ges
(
x
è(1 + ((((xè- 1è& 
PAGE_MASK
è>> 
PAGE_SHIFT
))

	)

66 
	#»q_Ýcode
(
x
) \

67 (((
x
è>> 
HFI1_SDMA_REQ_OPCODE_SHIFT
è& 
HFI1_SDMA_REQ_OPCODE_MASK
)

	)

68 
	#»q_v”siÚ
(
x
) \

69 (((
x
è>> 
HFI1_SDMA_REQ_VERSION_SHIFT
è& 
HFI1_SDMA_REQ_OPCODE_MASK
)

	)

70 
	#»q_iovút
(
x
) \

71 (((
x
è>> 
HFI1_SDMA_REQ_IOVCNT_SHIFT
è& 
HFI1_SDMA_REQ_IOVCNT_MASK
)

	)

74 
	#BTH_SEQ_MASK
 0x7ffuÎ

	)

76 
	#AHG_KDETH_INTR_SHIFT
 12

	)

77 
	#AHG_KDETH_SH_SHIFT
 13

	)

78 
	#AHG_KDETH_ARRAY_SIZE
 9

	)

80 
	#PBC2LRH
(
x
è((((xè& 0xfffè<< 2è- 4)

	)

81 
	#LRH2PBC
(
x
è((((xè>> 2è+ 1è& 0xfff)

	)

95 
šlše
 
	$ahg_h—d”_£t
(
u32
 *
¬r
, 
idx
, 
size_t
 
¬¿y_size
,

96 
u8
 
dw
, u8 
b™
, u8 
width
, 
u16
 
v®ue
)

98 ià((
size_t
)
idx
 >ð
¬¿y_size
)

99  -
ERANGE
;

100 
¬r
[
idx
++] = 
	`sdma_bužd_ahg_desütÜ
(
v®ue
, 
dw
, 
b™
, 
width
);

101  
idx
;

102 
	}
}

105 
	#TXREQ_FLAGS_REQ_ACK
 
	`BIT
(0è

	)

106 
	#TXREQ_FLAGS_REQ_DISABLE_SH
 
	`BIT
(1è

	)

108 
	epkt_q_sdma_¡©e
 {

109 
	mSDMA_PKT_Q_ACTIVE
,

110 
	mSDMA_PKT_Q_DEFERRED
,

113 
	#SDMA_IOWAIT_TIMEOUT
 1000

	)

115 
	#SDMA_DBG
(
»q
, 
fmt
, ...) \

116 
	`hfi1_cdbg
(
SDMA
, "[%u:%u:%u:%u] " 
fmt
, (
»q
)->
pq
->
dd
->
un™
, \

117 (
»q
)->
pq
->
ùxt
, (»q)->pq->
subùxt
, (»q)->
šfo
.
comp_idx
, \

118 ##
__VA_ARGS__
)

	)

120 
	shfi1_u£r_sdma_pkt_q
 {

121 
u16
 
	mùxt
;

122 
u16
 
	msubùxt
;

123 
u16
 
	mn_max_»qs
;

124 
©omic_t
 
	mn_»qs
;

125 
u16
 
	m»qidx
;

126 
hfi1_devd©a
 *
	mdd
;

127 
kmem_ÿche
 *
	mtx»q_ÿche
;

128 
u£r_sdma_»que¡
 *
	m»qs
;

129 *
	m»q_š_u£
;

130 
iowa™
 
	mbusy
;

131 
pkt_q_sdma_¡©e
 
	m¡©e
;

132 
wa™_queue_h—d_t
 
	mwa™
;

133 
	muÅšÃd
;

134 
mmu_rb_hªdËr
 *
	mhªdËr
;

135 #ifdeà
NVIDIA_GPU_DIRECT


136 
mmu_rb_hªdËr
 *
	mhªdËr_gpu
;

137 
©omic_t
 
	mn_gpu_locked
;

139 
©omic_t
 
	mn_locked
;

140 
mm_¡ruù
 *
	mmm
;

143 
	shfi1_u£r_sdma_comp_q
 {

144 
u16
 
	mÃÁr›s
;

145 
hfi1_sdma_comp_’Œy
 *
	mcomps
;

148 
	ssdma_mmu_node
 {

149 
mmu_rb_node
 
	mrb
;

150 
hfi1_u£r_sdma_pkt_q
 *
	mpq
;

151 
©omic_t
 
	m»fcouÁ
;

152 #iâdeà
NVIDIA_GPU_DIRECT


153 
·ge
 **
	m·ges
;

156 
nvidŸ_p2p_·ge_bË
 *
	mgpu
;

157 
·ge
 **
	mho¡
;

158 } 
	m·ges
;

159 
boÞ
 
	mÚgpu
;

161 
	mÅages
;

164 
	su£r_sdma_iovec
 {

165 
li¡_h—d
 
	mli¡
;

166 
iovec
 
	miov
;

168 
	mÅages
;

170 #iâdeà
NVIDIA_GPU_DIRECT


171 
·ge
 **
	m·ges
;

174 
nvidŸ_p2p_·ge_bË
 *
	mgpu
;

175 
·ge
 **
	mho¡
;

176 } 
	m·ges
;

182 
u64
 
	moff£t
;

183 
sdma_mmu_node
 *
	mnode
;

187 
	seviù_d©a
 {

188 
u32
 
	mþ—»d
;

189 
u32
 
	mrg‘
;

192 
	su£r_sdma_»que¡
 {

194 
hfi1_pkt_h—d”
 
	mhdr
;

197 
hfi1_u£r_sdma_pkt_q
 *
pq
 
	m____ÿch–še_®igÃd_š_smp
;

198 
hfi1_u£r_sdma_comp_q
 *
	mcq
;

204 
sdma_’gše
 *
	msde
;

205 
sdma_»q_šfo
 
	mšfo
;

207 
u32
 *
	mtids
;

209 
u32
 
	md©a_Ën
;

211 
u16
 
	mn_tids
;

216 
u8
 
	md©a_iovs
;

217 
s8
 
	mahg_idx
;

220 
u16
 
£qcomp
 
	m____ÿch–še_®igÃd_š_smp
;

221 
u16
 
	m£qsubm™‹d
;

224 
li¡_h—d
 
txps
 
	m____ÿch–še_®igÃd_š_smp
;

225 
u16
 
	m£qnum
;

231 
u32
 
	mtidoff£t
;

237 
u32
 
	mkoff£t
;

238 
u32
 
	m£Á
;

240 
u16
 
	mtididx
;

242 
u8
 
	miov_idx
;

243 
u8
 
	mhas_”rÜ
;

245 
u£r_sdma_iovec
 
	miovs
[
MAX_VECTORS_PER_REQ
];

246 } 
	g____ÿch–še_®igÃd_š_smp
;

254 
	su£r_sdma_tx»q
 {

256 
hfi1_pkt_h—d”
 
	mhdr
;

257 
sdma_tx»q
 
	mtx»q
;

258 
li¡_h—d
 
	mli¡
;

259 
u£r_sdma_»que¡
 *
	m»q
;

260 
u16
 
	mæags
;

261 
u16
 
	m£qnum
;

264 
hfi1_u£r_sdma_®loc_queues
(
hfi1_ùxtd©a
 *
uùxt
,

265 
hfi1_fžed©a
 *
fd
);

266 
hfi1_u£r_sdma_ä“_queues
(
hfi1_fžed©a
 *
fd
,

267 
hfi1_ùxtd©a
 *
uùxt
);

268 
hfi1_u£r_sdma_´oûss_»que¡
(
hfi1_fžed©a
 *
fd
,

269 
iovec
 *iovec, 
dim
,

270 *
couÁ
);

	@user_sdma_gpu.c

48 
	~"sdma.h
"

49 
	~"Œaû.h
"

50 
	~"mmu_rb.h
"

51 
	~"u£r_sdma.h
"

52 
	~"u£r_sdma_gpu.h
"

54 
	$u£r_sdma_txadd_gpu
(
u£r_sdma_»que¡
 *
»q
,

55 
u£r_sdma_tx»q
 *
tx
,

56 
u£r_sdma_iovec
 *
iovec
, 
u32
 
d©®’
,

57 
u32
 *
queued_±r
, u32 *
d©a_£Á_±r
,

58 
u64
 *
iov_off£t_±r
)

60 
»t
;

61 
·geidx
, 
Ën
;

62 
ba£
, 
off£t
;

63 
u64
 
iov_off£t
 = *
iov_off£t_±r
;

64 
u32
 
queued
 = *
queued_±r
, 
d©a_£Á
 = *
d©a_£Á_±r
;

65 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

66 
nvidŸ_p2p_·ge_bË
 *
gpu
;

68 
ba£
 = ()
iovec
->
iov
.
iov_ba£
;

69 
off£t
 = ((
ba£
 + 
iovec
->off£ˆ+ 
iov_off£t
è& ~
NV_GPU_PAGE_MASK
);

70 
·geidx
 = (((
iovec
->
off£t
 + 
iov_off£t
 + 
ba£
) -

71 (
ba£
 & 
NV_GPU_PAGE_MASK
)è>> 
NV_GPU_PAGE_SHIFT
);

72 
Ën
 = 
off£t
 + 
»q
->
šfo
.
äagsize
 > 
NV_GPU_PAGE_SIZE
 ?

73 
NV_GPU_PAGE_SIZE
 - 
off£t
 : 
»q
->
šfo
.
äagsize
;

74 
Ën
 = 
	`mš
((
d©®’
 - 
queued
),†en);

75 
gpu
 = 
iovec
->
·ges
.gpu;

76 
»t
 = 
	`sdma_txadd_daddr
(
pq
->
dd
, &
tx
->
tx»q
,

77 
gpu
->
·ges
[
·geidx
]->
physiÿl_add»ss
 + 
off£t
,

78 
Ën
);

79 ià(
»t
) {

80 
	`SDMA_DBG
(
»q
, "NV: base 0x%lx, offset: 0x%lx, idx: %u,†en: %u",

81 
ba£
, 
off£t
, 
·geidx
, 
Ën
);

82 
	`SDMA_DBG
(
»q
, "SDMAx»q‡dd…agçžed %d\n", 
»t
);

83  
»t
;

85 
iov_off£t
 +ð
Ën
;

86 
queued
 +ð
Ën
;

87 
d©a_£Á
 +ð
Ën
;

88 ià(
	`uÆik–y
(
queued
 < 
d©®’
 && 
·geidx
 =ð
iovec
->
Åages
 &&

89 
»q
->
iov_idx
 <„eq->
d©a_iovs
 - 1)) {

90 
iovec
->
off£t
 +ð
iov_off£t
;

91 
iovec
 = &
»q
->
iovs
[++»q->
iov_idx
];

92 
iov_off£t
 = 0;

95 *
queued_±r
 = 
queued
;

96 *
d©a_£Á_±r
 = 
d©a_£Á
;

97 *
iov_off£t_±r
 = 
iov_off£t
;

98  
»t
;

99 
	}
}

101 
u32
 
	$sdma_ÿche_eviù_gpu
(
hfi1_u£r_sdma_pkt_q
 *
pq
, 
u32
 
Åages
)

103 
eviù_d©a
ƒvict_data;

105 
eviù_d©a
.
þ—»d
 = 0;

106 
eviù_d©a
.
rg‘
 = 
Åages
;

107 
	`hfi1_mmu_rb_eviù
(
pq
->
hªdËr_gpu
, &
eviù_d©a
);

108  
eviù_d©a
.
þ—»d
;

109 
	}
}

111 
	$uÅš_gpu_·ges_ÿÎback
(*
d©a
)

113 
sdma_mmu_node
 *
node
 = (sdma_mmu_nod*)
d©a
;

115 ià(
node
->
·ges
.
gpu
) {

120 
	`WARN_ON
(
	`©omic_»ad
(&
node
->
»fcouÁ
));

121 
	`ä“_gpu_·ge_bË
(
node
->
·ges
.
gpu
);

122 
node
->
·ges
.
gpu
 = 
NULL
;

123 
	`Œaû_uÅš_gpu_·ges_ÿÎback
(
node
->
rb
.
addr
,‚ode->rb.
Ën
);

124 
	`hfi1_gpu_ÿche_šv®id©e
(
node
->
pq
->
hªdËr_gpu
,

125 
node
->
rb
.
addr
,

126 (
node
->
rb
.
addr
 +‚ode->rb.
Ën
));

128 
	}
}

130 
šlše
 
	$»Ëa£_gpu_mem_·ges
(
addr
,

131 
nvidŸ_p2p_·ge_bË_t
 *
·ge_bË
)

133 
	`Œaû_ä“_sdma_gpu_·ges
(
addr
);

134 
	`put_gpu_·ges
(
addr
, 
·ge_bË
);

135 
	}
}

137 
	$uÅš_veùÜ_gpu_mem_·ges
(
u£r_sdma_»que¡
 *
»q
,

138 
u£r_sdma_iovec
 *
iovec
)

140 
addr
 = ()
iovec
->
iov
.
iov_ba£
 &

141 
NV_GPU_PAGE_MASK
;

142 
	`»Ëa£_gpu_mem_·ges
(
addr
, 
iovec
->
·ges
.
gpu
);

143 
iovec
->
·ges
.
gpu
 = 
NULL
;

144 
iovec
->
Åages
 = 0;

145 
iovec
->
off£t
 = 0;

146 
	}
}

148 
	$pš_sdma_·ges_gpu
(
u£r_sdma_iovec
 *
iovec
,

149 
sdma_mmu_node
 *
node
,

150 
u£r_sdma_»que¡
 *
»q
,

151 
Åages
, 
size
,

152 
addr
)

154 
»t
, 
pšÃd
, 
locked
;

155 
þ—»d
, 
rg‘
;

156 
max_ÿche_·ges
;

157 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
»q
->pq;

165 
	`Œaû_pš_sdma_·ges_gpu
(()
iovec
->
iov
.
iov_ba£
, 
addr
,

166 
iovec
->
iov
.
iov_Ën
, 
size
, 
Åages
);

167 
locked
 = 
	`©omic_»ad
(&
pq
->
n_gpu_locked
);

173 
max_ÿche_·ges
 = ((
gpu_ÿche_size
 << 20è>> 
NV_GPU_PAGE_SHIFT
);

174 ià(
locked
 + 
Åages
 > 
max_ÿche_·ges
) {

175 ià(
Åages
 > 
max_ÿche_·ges
)

176  -
EINVAL
;

178 
rg‘
 = 
Åages
 - (
max_ÿche_·ges
 - 
locked
);

179 
þ—»d
 = 
	`sdma_ÿche_eviù_gpu
(
pq
, 
rg‘
);

180 
locked
 = 
	`©omic_»ad
(&
pq
->
n_gpu_locked
);

181 } 
þ—»d
 < 
rg‘
);

184 
»Œy_pš
:

185 
»t
 = 
	`pš_gpu_·ges
(
addr
, 
size
, &
node
->
·ges
.
gpu
,

186 
uÅš_gpu_·ges_ÿÎback
, 
node
);

187 ià(
»t
) {

205 ià((
»t
 =ð-
ENOMEM
è|| (»ˆ=ð-
EINVAL
)) {

206 
rg‘
 = 
Åages
;

207 
þ—»d
 = 
	`sdma_ÿche_eviù_gpu
(
pq
, 
rg‘
);

223 ià(
þ—»d
 =ð0 && (
	`©omic_»ad
(&
pq
->
n_gpu_locked
) == 0))

224 
»t
 = -
ENOMEM
;

226 
»Œy_pš
;

228 
	`Œaû_sdma_pš_gpu_·ges_çž
(
»t
, 
addr
, 
size
);

229  
»t
;

231 
	`Œaû_sdma_gpu_·ge_bË_šfo
(
node
->
·ges
.
gpu
->
’Œ›s
,

232 
node
->
·ges
.
gpu
->
·ge_size
);

233 
pšÃd
 = 
node
->
·ges
.
gpu
->
’Œ›s
;

235 ià(
pšÃd
 !ð
Åages
) {

236 
	`Œaû_sdma_pš_gpu_·ges_çž
(
»t
, 
addr
, 
size
);

237 
	`uÅš_veùÜ_gpu_mem_·ges
(
»q
, 
iovec
);

238  -
EFAULT
;

240 
node
->
rb
.
Ën
 = 
size
;

241 
	`©omic_add
(
pšÃd
, &
pq
->
n_gpu_locked
);

242  
pšÃd
;

243 
	}
}

245 
	$uÅš_sdma_·ges_gpu
(
sdma_mmu_node
 *
node
)

247 ià(
node
->
Åages
) {

256 ià(
node
->
·ges
.
gpu
) {

257 
	`»Ëa£_gpu_mem_·ges
(
node
->
rb
.
addr
,‚ode->
·ges
.
gpu
);

258 
node
->
·ges
.
gpu
 = 
NULL
;

260 
	`©omic_sub
(
node
->
Åages
, &node->
pq
->
n_gpu_locked
);

262 
	}
}

264 
	$u£r_sdma_gpu_ÿche_eviù
(
hfi1_fžed©a
 *
fd
,

265 
¬g
, 
u32
 
Ën
)

267 
þ—»d
 = 0, 
rg‘
;

268 
hfi1_u£r_sdma_pkt_q
 *
pq
 = 
fd
->pq;

269 
hfi1_sdma_gpu_ÿche_eviù_·¿ms
 
eviù_·¿ms
;

271 ià((
eviù_·¿ms
è!ð
Ën
)

272  -
EINVAL
;

274 ià(
	`cÝy_äom_u£r
(&
eviù_·¿ms
,

275 (
hfi1_sdma_gpu_ÿche_eviù_·¿ms
 
__u£r
 *)
¬g
,

276 (
eviù_·¿ms
)))

277  -
EFAULT
;

279 ià(
eviù_·¿ms
.
eviù_·¿ms_š
.
v”siÚ
 !ð
HFI1_GDR_VERSION
)

280  -
ENODEV
;

282 
rg‘
 = 
eviù_·¿ms
.
eviù_·¿ms_š
.
·ges_to_eviù
;

284 ià(
rg‘
 > 0)

285 
þ—»d
 = 
	`sdma_ÿche_eviù_gpu
(
pq
, 
rg‘
);

286 
eviù_·¿ms
.
eviù_·¿ms_out
.
·ges_eviùed
 = 
þ—»d
;

287 
eviù_·¿ms
.
eviù_·¿ms_out
.
·ges_š_ÿche
 = 
	`©omic_»ad
(&
pq
->
n_gpu_locked
);

289 ià(
	`cÝy_to_u£r
((
hfi1_sdma_gpu_ÿche_eviù_·¿ms
 
__u£r
 *)
¬g
,

290 &
eviù_·¿ms
,

291 (
eviù_·¿ms
)))

292  -
EFAULT
;

294 
	}
}

	@user_sdma_gpu.h

1 #iâdeà
_HFI1_USER_SDMA_GPU_H


2 
	#_HFI1_USER_SDMA_GPU_H


	)

50 
	~"gpu.h
"

52 
u£r_sdma_txadd_gpu
(
u£r_sdma_»que¡
 *
»q
,

53 
u£r_sdma_tx»q
 *
tx
,

54 
u£r_sdma_iovec
 *
iovec
, 
u32
 
d©®’
,

55 
u32
 *
queued_±r
, u32 *
d©a_£Á_±r
,

56 
u64
 *
iov_off£t_±r
);

57 
uÅš_sdma_·ges_gpu
(
sdma_mmu_node
 *
node
);

58 
pš_sdma_·ges_gpu
(
u£r_sdma_iovec
 *
iovec
,

59 
sdma_mmu_node
 *
node
,

60 
u£r_sdma_»que¡
 *
»q
,

61 
Åages
, 
size
,

62 
addr
);

63 
u£r_sdma_gpu_ÿche_eviù
(
hfi1_fžed©a
 *
fd
,

64 
¬g
, 
u32
 
Ën
);

	@verbs.c

48 
	~<rdma/ib_mad.h
>

49 
	~<rdma/ib_u£r_v”bs.h
>

50 
	~<rdma/ib_hdrs.h
>

51 
	~<lšux/io.h
>

52 
	~<lšux/moduË.h
>

53 
	~<lšux/ut¢ame.h
>

54 
	~<lšux/rculi¡.h
>

55 
	~<lšux/mm.h
>

56 
	~<lšux/vm®loc.h
>

57 
	~<rdma/Ýa_addr.h
>

58 
	~<rdma/ib_ÿche.h
>

59 #ifdeà
HAVE_NOSPEC_H


60 
	~<lšux/no¥ec.h
>

63 
	~"hfi.h
"

64 
	~"commÚ.h
"

65 
	~"deviû.h
"

66 
	~"Œaû.h
"

67 
	~"qp.h
"

68 
	~"v”bs_tx»q.h
"

69 
	~"debugfs.h
"

70 
	~"vnic.h
"

71 
	~"tid_rdma.h
"

72 
	~"çuÉ.h
"

73 
	~"affš™y.h
"

74 
	~"oib.h
"

76 
£lšux_mode
;

78 
	ghfi1_lkey_bË_size
 = 16;

79 
moduË_·¿m_Çmed
(
lkey_bË_size
, 
hfi1_lkey_bË_size
, 
ušt
,

80 
S_IRUGO
);

81 
MODULE_PARM_DESC
(
lkey_bË_size
,

84 
	ghfi1_max_pds
 = 0xFFFF;

85 
moduË_·¿m_Çmed
(
max_pds
, 
hfi1_max_pds
, 
ušt
, 
S_IRUGO
);

86 
MODULE_PARM_DESC
(
max_pds
,

89 
	ghfi1_max_ahs
 = 0xFFFF;

90 
moduË_·¿m_Çmed
(
max_ahs
, 
hfi1_max_ahs
, 
ušt
, 
S_IRUGO
);

91 
MODULE_PARM_DESC
(
max_ahs
, "Maximum‚umber of‡ddress handleso support");

93 
	ghfi1_max_cqes
 = 0x2FFFFF;

94 
moduË_·¿m_Çmed
(
max_cqes
, 
hfi1_max_cqes
, 
ušt
, 
S_IRUGO
);

95 
MODULE_PARM_DESC
(
max_cqes
,

98 
	ghfi1_max_cqs
 = 0x1FFFF;

99 
moduË_·¿m_Çmed
(
max_cqs
, 
hfi1_max_cqs
, 
ušt
, 
S_IRUGO
);

100 
MODULE_PARM_DESC
(
max_cqs
, "Maximum‚umber of completion queueso support");

102 
	ghfi1_max_qp_wrs
 = 0x3FFF;

103 
moduË_·¿m_Çmed
(
max_qp_wrs
, 
hfi1_max_qp_wrs
, 
ušt
, 
S_IRUGO
);

104 
MODULE_PARM_DESC
(
max_qp_wrs
, "Maximum‚umber of QP WRso support");

106 
	ghfi1_max_qps
 = 32768;

107 
moduË_·¿m_Çmed
(
max_qps
, 
hfi1_max_qps
, 
ušt
, 
S_IRUGO
);

108 
MODULE_PARM_DESC
(
max_qps
, "Maximum‚umber of QPso support");

110 
	ghfi1_max_sges
 = 0x60;

111 
moduË_·¿m_Çmed
(
max_sges
, 
hfi1_max_sges
, 
ušt
, 
S_IRUGO
);

112 
MODULE_PARM_DESC
(
max_sges
, "Maximum‚umber of SGEso support");

114 
	ghfi1_max_mÿ¡_g½s
 = 16384;

115 
moduË_·¿m_Çmed
(
max_mÿ¡_g½s
, 
hfi1_max_mÿ¡_g½s
, 
ušt
, 
S_IRUGO
);

116 
MODULE_PARM_DESC
(
max_mÿ¡_g½s
,

119 
	ghfi1_max_mÿ¡_qp_©ched
 = 16;

120 
moduË_·¿m_Çmed
(
max_mÿ¡_qp_©ched
, 
hfi1_max_mÿ¡_qp_©ched
,

121 
ušt
, 
S_IRUGO
);

122 
MODULE_PARM_DESC
(
max_mÿ¡_qp_©ched
,

125 
	ghfi1_max_¤qs
 = 1024;

126 
moduË_·¿m_Çmed
(
max_¤qs
, 
hfi1_max_¤qs
, 
ušt
, 
S_IRUGO
);

127 
MODULE_PARM_DESC
(
max_¤qs
, "Maximum‚umber of SRQso support");

129 
	ghfi1_max_¤q_sges
 = 128;

130 
moduË_·¿m_Çmed
(
max_¤q_sges
, 
hfi1_max_¤q_sges
, 
ušt
, 
S_IRUGO
);

131 
MODULE_PARM_DESC
(
max_¤q_sges
, "Maximum‚umber of SRQ SGEso support");

133 
	ghfi1_max_¤q_wrs
 = 0x1FFFF;

134 
moduË_·¿m_Çmed
(
max_¤q_wrs
, 
hfi1_max_¤q_wrs
, 
ušt
, 
S_IRUGO
);

135 
MODULE_PARM_DESC
(
max_¤q_wrs
, "Maximum‚umber of SRQ WRs support");

137 
	gpiÙh»shÞd
 = 256;

138 
moduË_·¿m
(
piÙh»shÞd
, 
ushÜt
, 
S_IRUGO
);

139 
MODULE_PARM_DESC
(
piÙh»shÞd
, "size usedo determine sdma vs.…io");

141 
	gsge_cÝy_mode
;

142 
moduË_·¿m
(
sge_cÝy_mode
, 
ušt
, 
S_IRUGO
);

143 
MODULE_PARM_DESC
(
sge_cÝy_mode
,

146 
v”bs_sdma_com¶‘e
(

147 
sdma_tx»q
 *
cook›
,

148 
¡©us
);

150 
pio_wa™
(
rvt_qp
 *
qp
,

151 
£nd_cÚ‹xt
 *
sc
,

152 
hfi1_pkt_¡©e
 *
ps
,

153 
u32
 
æag
);

156 
	#TXREQ_NAME_LEN
 24

	)

158 
ušt
 
	gwss_th»shÞd
 = 80;

159 
moduË_·¿m
(
wss_th»shÞd
, 
ušt
, 
S_IRUGO
);

160 
MODULE_PARM_DESC
(
wss_th»shÞd
, "Percentage (1-100) of LLCo use‡s‡hreshold for‡ cacheless copy");

161 
ušt
 
	gwss_þ—n_³riod
 = 256;

162 
moduË_·¿m
(
wss_þ—n_³riod
, 
ušt
, 
S_IRUGO
);

163 
MODULE_PARM_DESC
(
wss_þ—n_³riod
, "Count of verbs copies before‡nƒntry inhe…age copyable is cleaned");

168 cÚ¡ 
ib_wc_Ýcode
 
	gib_hfi1_wc_Ýcode
[] = {

169 [
IB_WR_RDMA_WRITE
] = 
IB_WC_RDMA_WRITE
,

170 [
IB_WR_TID_RDMA_WRITE
] = 
IB_WC_RDMA_WRITE
,

171 [
IB_WR_RDMA_WRITE_WITH_IMM
] = 
IB_WC_RDMA_WRITE
,

172 [
IB_WR_SEND
] = 
IB_WC_SEND
,

173 [
IB_WR_SEND_WITH_IMM
] = 
IB_WC_SEND
,

174 [
IB_WR_RDMA_READ
] = 
IB_WC_RDMA_READ
,

175 [
IB_WR_TID_RDMA_READ
] = 
IB_WC_RDMA_READ
,

176 [
IB_WR_ATOMIC_CMP_AND_SWP
] = 
IB_WC_COMP_SWAP
,

177 [
IB_WR_ATOMIC_FETCH_AND_ADD
] = 
IB_WC_FETCH_ADD
,

178 [
IB_WR_SEND_WITH_INV
] = 
IB_WC_SEND
,

179 [
IB_WR_LOCAL_INV
] = 
IB_WC_LOCAL_INV
,

180 [
IB_WR_REG_MR
] = 
IB_WC_REG_MR


186 cÚ¡ 
u8
 
	ghdr_Ën_by_Ýcode
[256] = {

188 [
IB_OPCODE_RC_SEND_FIRST
] = 12 + 8,

189 [
IB_OPCODE_RC_SEND_MIDDLE
] = 12 + 8,

190 [
IB_OPCODE_RC_SEND_LAST
] = 12 + 8,

191 [
IB_OPCODE_RC_SEND_LAST_WITH_IMMEDIATE
] = 12 + 8 + 4,

192 [
IB_OPCODE_RC_SEND_ONLY
] = 12 + 8,

193 [
IB_OPCODE_RC_SEND_ONLY_WITH_IMMEDIATE
] = 12 + 8 + 4,

194 [
IB_OPCODE_RC_RDMA_WRITE_FIRST
] = 12 + 8 + 16,

195 [
IB_OPCODE_RC_RDMA_WRITE_MIDDLE
] = 12 + 8,

196 [
IB_OPCODE_RC_RDMA_WRITE_LAST
] = 12 + 8,

197 [
IB_OPCODE_RC_RDMA_WRITE_LAST_WITH_IMMEDIATE
] = 12 + 8 + 4,

198 [
IB_OPCODE_RC_RDMA_WRITE_ONLY
] = 12 + 8 + 16,

199 [
IB_OPCODE_RC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
] = 12 + 8 + 20,

200 [
IB_OPCODE_RC_RDMA_READ_REQUEST
] = 12 + 8 + 16,

201 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_FIRST
] = 12 + 8 + 4,

202 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_MIDDLE
] = 12 + 8,

203 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_LAST
] = 12 + 8 + 4,

204 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_ONLY
] = 12 + 8 + 4,

205 [
IB_OPCODE_RC_ACKNOWLEDGE
] = 12 + 8 + 4,

206 [
IB_OPCODE_RC_ATOMIC_ACKNOWLEDGE
] = 12 + 8 + 4 + 8,

207 [
IB_OPCODE_RC_COMPARE_SWAP
] = 12 + 8 + 28,

208 [
IB_OPCODE_RC_FETCH_ADD
] = 12 + 8 + 28,

209 [
IB_OPCODE_RC_SEND_LAST_WITH_INVALIDATE
] = 12 + 8 + 4,

210 [
IB_OPCODE_RC_SEND_ONLY_WITH_INVALIDATE
] = 12 + 8 + 4,

211 [
IB_OPCODE_TID_RDMA_WRITE_REQ
] = 12 + 8 + 36,

212 [
IB_OPCODE_TID_RDMA_WRITE_RESP
] = 12 + 8 + 36,

213 [
IB_OPCODE_TID_RDMA_WRITE_DATA
] = 12 + 8 + 36,

214 [
IB_OPCODE_TID_RDMA_WRITE_DATA_LAST
] = 12 + 8 + 36,

215 [
IB_OPCODE_TID_RDMA_READ_REQ
] = 12 + 8 + 36,

216 [
IB_OPCODE_TID_RDMA_READ_RESP
] = 12 + 8 + 36,

217 [
IB_OPCODE_TID_RDMA_ACK
] = 12 + 8 + 36,

218 [
IB_OPCODE_TID_RDMA_RESYNC
] = 12 + 8 + 36,

220 [
IB_OPCODE_UC_SEND_FIRST
] = 12 + 8,

221 [
IB_OPCODE_UC_SEND_MIDDLE
] = 12 + 8,

222 [
IB_OPCODE_UC_SEND_LAST
] = 12 + 8,

223 [
IB_OPCODE_UC_SEND_LAST_WITH_IMMEDIATE
] = 12 + 8 + 4,

224 [
IB_OPCODE_UC_SEND_ONLY
] = 12 + 8,

225 [
IB_OPCODE_UC_SEND_ONLY_WITH_IMMEDIATE
] = 12 + 8 + 4,

226 [
IB_OPCODE_UC_RDMA_WRITE_FIRST
] = 12 + 8 + 16,

227 [
IB_OPCODE_UC_RDMA_WRITE_MIDDLE
] = 12 + 8,

228 [
IB_OPCODE_UC_RDMA_WRITE_LAST
] = 12 + 8,

229 [
IB_OPCODE_UC_RDMA_WRITE_LAST_WITH_IMMEDIATE
] = 12 + 8 + 4,

230 [
IB_OPCODE_UC_RDMA_WRITE_ONLY
] = 12 + 8 + 16,

231 [
IB_OPCODE_UC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
] = 12 + 8 + 20,

233 [
IB_OPCODE_UD_SEND_ONLY
] = 12 + 8 + 8,

234 [
IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
] = 12 + 8 + 12

237 cÚ¡ 
Ýcode_hªdËr
 
	gÝcode_hªdËr_tbl
[256] = {

239 [
IB_OPCODE_RC_SEND_FIRST
] = &
hfi1_rc_rcv
,

240 [
IB_OPCODE_RC_SEND_MIDDLE
] = &
hfi1_rc_rcv
,

241 [
IB_OPCODE_RC_SEND_LAST
] = &
hfi1_rc_rcv
,

242 [
IB_OPCODE_RC_SEND_LAST_WITH_IMMEDIATE
] = &
hfi1_rc_rcv
,

243 [
IB_OPCODE_RC_SEND_ONLY
] = &
hfi1_rc_rcv
,

244 [
IB_OPCODE_RC_SEND_ONLY_WITH_IMMEDIATE
] = &
hfi1_rc_rcv
,

245 [
IB_OPCODE_RC_RDMA_WRITE_FIRST
] = &
hfi1_rc_rcv
,

246 [
IB_OPCODE_RC_RDMA_WRITE_MIDDLE
] = &
hfi1_rc_rcv
,

247 [
IB_OPCODE_RC_RDMA_WRITE_LAST
] = &
hfi1_rc_rcv
,

248 [
IB_OPCODE_RC_RDMA_WRITE_LAST_WITH_IMMEDIATE
] = &
hfi1_rc_rcv
,

249 [
IB_OPCODE_RC_RDMA_WRITE_ONLY
] = &
hfi1_rc_rcv
,

250 [
IB_OPCODE_RC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
] = &
hfi1_rc_rcv
,

251 [
IB_OPCODE_RC_RDMA_READ_REQUEST
] = &
hfi1_rc_rcv
,

252 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_FIRST
] = &
hfi1_rc_rcv
,

253 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_MIDDLE
] = &
hfi1_rc_rcv
,

254 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_LAST
] = &
hfi1_rc_rcv
,

255 [
IB_OPCODE_RC_RDMA_READ_RESPONSE_ONLY
] = &
hfi1_rc_rcv
,

256 [
IB_OPCODE_RC_ACKNOWLEDGE
] = &
hfi1_rc_rcv
,

257 [
IB_OPCODE_RC_ATOMIC_ACKNOWLEDGE
] = &
hfi1_rc_rcv
,

258 [
IB_OPCODE_RC_COMPARE_SWAP
] = &
hfi1_rc_rcv
,

259 [
IB_OPCODE_RC_FETCH_ADD
] = &
hfi1_rc_rcv
,

260 [
IB_OPCODE_RC_SEND_LAST_WITH_INVALIDATE
] = &
hfi1_rc_rcv
,

261 [
IB_OPCODE_RC_SEND_ONLY_WITH_INVALIDATE
] = &
hfi1_rc_rcv
,

268 [
IB_OPCODE_TID_RDMA_WRITE_REQ
] = &
hfi1_rc_rcv_tid_rdma_wr™e_»q
,

269 [
IB_OPCODE_TID_RDMA_WRITE_RESP
] = &
hfi1_rc_rcv_tid_rdma_wr™e_»¥
,

270 [
IB_OPCODE_TID_RDMA_WRITE_DATA
] = &
hfi1_rc_rcv_tid_rdma_wr™e_d©a
,

271 [
IB_OPCODE_TID_RDMA_WRITE_DATA_LAST
] = &
hfi1_rc_rcv_tid_rdma_wr™e_d©a
,

272 [
IB_OPCODE_TID_RDMA_READ_REQ
] = &
hfi1_rc_rcv_tid_rdma_»ad_»q
,

273 [
IB_OPCODE_TID_RDMA_READ_RESP
] = &
hfi1_rc_rcv_tid_rdma_»ad_»¥
,

274 [
IB_OPCODE_TID_RDMA_RESYNC
] = &
hfi1_rc_rcv_tid_rdma_»sync
,

275 [
IB_OPCODE_TID_RDMA_ACK
] = &
hfi1_rc_rcv_tid_rdma_ack
,

278 [
IB_OPCODE_UC_SEND_FIRST
] = &
hfi1_uc_rcv
,

279 [
IB_OPCODE_UC_SEND_MIDDLE
] = &
hfi1_uc_rcv
,

280 [
IB_OPCODE_UC_SEND_LAST
] = &
hfi1_uc_rcv
,

281 [
IB_OPCODE_UC_SEND_LAST_WITH_IMMEDIATE
] = &
hfi1_uc_rcv
,

282 [
IB_OPCODE_UC_SEND_ONLY
] = &
hfi1_uc_rcv
,

283 [
IB_OPCODE_UC_SEND_ONLY_WITH_IMMEDIATE
] = &
hfi1_uc_rcv
,

284 [
IB_OPCODE_UC_RDMA_WRITE_FIRST
] = &
hfi1_uc_rcv
,

285 [
IB_OPCODE_UC_RDMA_WRITE_MIDDLE
] = &
hfi1_uc_rcv
,

286 [
IB_OPCODE_UC_RDMA_WRITE_LAST
] = &
hfi1_uc_rcv
,

287 [
IB_OPCODE_UC_RDMA_WRITE_LAST_WITH_IMMEDIATE
] = &
hfi1_uc_rcv
,

288 [
IB_OPCODE_UC_RDMA_WRITE_ONLY
] = &
hfi1_uc_rcv
,

289 [
IB_OPCODE_UC_RDMA_WRITE_ONLY_WITH_IMMEDIATE
] = &
hfi1_uc_rcv
,

291 [
IB_OPCODE_UD_SEND_ONLY
] = &
hfi1_ud_rcv
,

292 [
IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE
] = &
hfi1_ud_rcv
,

294 [
IB_OPCODE_CNP
] = &
hfi1_úp_rcv


297 
	#OPMASK
 0x1f

	)

299 cÚ¡ 
u32
 
	gpio_Ýmask
[
BIT
(3)] = {

301 [
IB_OPCODE_RC
 >> 5] =

302 
BIT
(
RC_OP
(
SEND_ONLY
è& 
OPMASK
) |

303 
BIT
(
RC_OP
(
SEND_ONLY_WITH_IMMEDIATE
è& 
OPMASK
) |

304 
BIT
(
RC_OP
(
RDMA_WRITE_ONLY
è& 
OPMASK
) |

305 
BIT
(
RC_OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
è& 
OPMASK
) |

306 
BIT
(
RC_OP
(
RDMA_READ_REQUEST
è& 
OPMASK
) |

307 
BIT
(
RC_OP
(
ACKNOWLEDGE
è& 
OPMASK
) |

308 
BIT
(
RC_OP
(
ATOMIC_ACKNOWLEDGE
è& 
OPMASK
) |

309 
BIT
(
RC_OP
(
COMPARE_SWAP
è& 
OPMASK
) |

310 
BIT
(
RC_OP
(
FETCH_ADD
è& 
OPMASK
),

312 [
IB_OPCODE_UC
 >> 5] =

313 
BIT
(
UC_OP
(
SEND_ONLY
è& 
OPMASK
) |

314 
BIT
(
UC_OP
(
SEND_ONLY_WITH_IMMEDIATE
è& 
OPMASK
) |

315 
BIT
(
UC_OP
(
RDMA_WRITE_ONLY
è& 
OPMASK
) |

316 
BIT
(
UC_OP
(
RDMA_WRITE_ONLY_WITH_IMMEDIATE
è& 
OPMASK
),

322 
__be64
 
	gib_hfi1_sys_image_guid
;

327 
šlše
 
Ýcode_hªdËr
 
	$qp_ok
(
hfi1_·ck‘
 *
·ck‘
)

329 ià(!(
ib_rvt_¡©e_Ýs
[
·ck‘
->
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
))

330  
NULL
;

331 ià(((
·ck‘
->
Ýcode
 & 
RVT_OPCODE_QP_MASK
) ==

332 
·ck‘
->
qp
->
®lowed_Ýs
) ||

333 (
·ck‘
->
Ýcode
 =ð
IB_OPCODE_CNP
))

334  
Ýcode_hªdËr_tbl
[
·ck‘
->
Ýcode
];

336  
NULL
;

337 
	}
}

339 
u64
 
	$hfi1_çuÉ_tx
(
rvt_qp
 *
qp
, 
u8
 
Ýcode
, 
u64
 
pbc
)

341 #ifdeà
CONFIG_FAULT_INJECTION


342 ià((
Ýcode
 & 
IB_OPCODE_MSP
) == IB_OPCODE_MSP) {

353 
pbc
 &ð~
PBC_INSERT_HCRC_SMASK
;

354 
pbc
 |ð(
u64
)
PBC_IHCRC_NONE
 << 
PBC_INSERT_HCRC_SHIFT
;

364 
pbc
 |ð
PBC_TEST_EBP
;

367  
pbc
;

368 
	}
}

370 
Ýcode_hªdËr
 
	$tid_qp_ok
(
Ýcode
, 
hfi1_·ck‘
 *
·ck‘
)

372 ià(
·ck‘
->
qp
->
ibqp
.
qp_ty³
 !ð
IB_QPT_RC
 ||

373 !(
ib_rvt_¡©e_Ýs
[
·ck‘
->
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
))

374  
NULL
;

375 ià((
Ýcode
 & 
RVT_OPCODE_QP_MASK
è=ð
IB_OPCODE_TID_RDMA
)

376  
Ýcode_hªdËr_tbl
[
Ýcode
];

377  
NULL
;

378 
	}
}

380 
	$hfi1_kd‘h_—g”_rcv
(
hfi1_·ck‘
 *
·ck‘
)

382 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

383 
ib_h—d”
 *
hdr
 = 
·ck‘
->hdr;

384 
u32
 
Ž’
 = 
·ck‘
->tlen;

385 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

386 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

387 
rvt_dev_šfo
 *
rdi
 = &
µd
->
dd
->
v”bs_dev
.rdi;

388 
Ýcode_hªdËr
 opcode_handler;

389 
æags
;

390 
u32
 
qp_num
;

391 
Êh
;

392 
u8
 
Ýcode
;

395 ià(
	`uÆik–y
(
Ž’
 < 15 * (
u32
)))

396 
drÝ
;

398 
Êh
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3;

399 ià(
Êh
 !ð
HFI1_LRH_BTH
)

400 
drÝ
;

402 
·ck‘
->
ohdr
 = &
hdr
->
u
.
Ùh
;

403 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, !!(
	`rhf_dc_šfo
Õack‘->
rhf
)));

405 
Ýcode
 = (
	`be32_to_ýu
(
·ck‘
->
ohdr
->
bth
[0]) >> 24);

406 
	`šc_Ý¡©s
(
Ž’
, &
rcd
->
Ý¡©s
->
¡©s
[
Ýcode
]);

409 
qp_num
 = 
	`be32_to_ýu
(
·ck‘
->
ohdr
->
u
.
tid_rdma
.
w_d©a
.
v”bs_qp
) &

410 
RVT_QPN_MASK
;

412 
	`rcu_»ad_lock
();

413 
·ck‘
->
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
qp_num
);

414 ià(!
·ck‘
->
qp
)

415 
drÝ_rcu
;

416 
	`¥š_lock_œq§ve
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

417 
Ýcode_hªdËr
 = 
	`tid_qp_ok
(
Ýcode
, 
·ck‘
);

418 ià(
	`lik–y
(
Ýcode_hªdËr
))

419 
	`Ýcode_hªdËr
(
·ck‘
);

421 
drÝ_uÆock
;

422 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

423 
	`rcu_»ad_uÆock
();

426 
drÝ_uÆock
:

427 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

428 
drÝ_rcu
:

429 
	`rcu_»ad_uÆock
();

430 
drÝ
:

431 
ibp
->
rvp
.
n_pkt_drÝs
++;

432 
	}
}

434 
	$hfi1_kd‘h_ex³ùed_rcv
(
hfi1_·ck‘
 *
·ck‘
)

436 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

437 
ib_h—d”
 *
hdr
 = 
·ck‘
->hdr;

438 
u32
 
Ž’
 = 
·ck‘
->tlen;

439 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

440 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

441 
rvt_dev_šfo
 *
rdi
 = &
µd
->
dd
->
v”bs_dev
.rdi;

442 
Ýcode_hªdËr
 opcode_handler;

443 
æags
;

444 
u32
 
qp_num
;

445 
Êh
;

446 
u8
 
Ýcode
;

449 ià(
	`uÆik–y
(
Ž’
 < 15 * (
u32
)))

450 
drÝ
;

452 
Êh
 = 
	`be16_to_ýu
(
hdr
->
Ìh
[0]) & 3;

453 ià(
Êh
 !ð
HFI1_LRH_BTH
)

454 
drÝ
;

456 
·ck‘
->
ohdr
 = &
hdr
->
u
.
Ùh
;

457 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, !!(
	`rhf_dc_šfo
Õack‘->
rhf
)));

459 
Ýcode
 = (
	`be32_to_ýu
(
·ck‘
->
ohdr
->
bth
[0]) >> 24);

460 
	`šc_Ý¡©s
(
Ž’
, &
rcd
->
Ý¡©s
->
¡©s
[
Ýcode
]);

463 
qp_num
 = 
	`be32_to_ýu
(
·ck‘
->
ohdr
->
u
.
tid_rdma
.
w_d©a
.
v”bs_qp
) &

464 
RVT_QPN_MASK
;

466 
	`rcu_»ad_lock
();

467 
·ck‘
->
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
qp_num
);

468 ià(!
·ck‘
->
qp
)

469 
drÝ_rcu
;

470 
	`¥š_lock_œq§ve
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

471 
Ýcode_hªdËr
 = 
	`tid_qp_ok
(
Ýcode
, 
·ck‘
);

472 ià(
	`lik–y
(
Ýcode_hªdËr
))

473 
	`Ýcode_hªdËr
(
·ck‘
);

475 
drÝ_uÆock
;

476 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

477 
	`rcu_»ad_uÆock
();

480 
drÝ_uÆock
:

481 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

482 
drÝ_rcu
:

483 
	`rcu_»ad_uÆock
();

484 
drÝ
:

485 
ibp
->
rvp
.
n_pkt_drÝs
++;

486 
	}
}

488 
	$hfi1_do_pkey_check
(
hfi1_·ck‘
 *
·ck‘
)

490 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

491 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

492 
hfi1_16b_h—d”
 *
hdr
 = 
·ck‘
->hdr;

493 
u16
 
pkey
;

496 ià(
·ck‘
->
‘y³
 !ð
RHF_RCV_TYPE_BYPASS
)

500 
pkey
 = 
	`hfi1_16B_g‘_pkey
(
hdr
);

501  
	`šg»ss_pkey_check
(
µd
, 
pkey
, 
·ck‘
->
sc
,

502 
·ck‘
->
qp
->
s_pkey_šdex
,

503 
·ck‘
->
¦id
, 
Œue
);

504 
	}
}

506 
šlše
 
	$hfi1_hªdË_·ck‘
(
hfi1_·ck‘
 *
·ck‘
,

507 
boÞ
 
is_mÿ¡
)

509 
u32
 
qp_num
;

510 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

511 
hfi1_µÜtd©a
 *
µd
 = 
rcd
->ppd;

512 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
rcd
);

513 
rvt_dev_šfo
 *
rdi
 = &
µd
->
dd
->
v”bs_dev
.rdi;

514 
Ýcode_hªdËr
 
·ck‘_hªdËr
;

515 
æags
;

517 
	`šc_Ý¡©s
(
·ck‘
->
Ž’
, &
rcd
->
Ý¡©s
->
¡©s
[·ck‘->
Ýcode
]);

519 ià(
	`uÆik–y
(
is_mÿ¡
)) {

520 
rvt_mÿ¡
 *
mÿ¡
;

521 
rvt_mÿ¡_qp
 *
p
;

523 ià(!
·ck‘
->
grh
)

524 
drÝ
;

525 
mÿ¡
 = 
	`rvt_mÿ¡_fšd
(&
ibp
->
rvp
,

526 &
·ck‘
->
grh
->
dgid
,

527 
	`Ýa_g‘_lid
(
·ck‘
->
dlid
, 9B));

528 ià(!
mÿ¡
)

529 
drÝ
;

530 
	`rcu_»ad_lock
();

531 
	`li¡_fÜ_—ch_’Œy_rcu
(
p
, &
mÿ¡
->
qp_li¡
, 
li¡
) {

532 
·ck‘
->
qp
 = 
p
->qp;

533 ià(
	`hfi1_do_pkey_check
(
·ck‘
))

534 
uÆock_drÝ
;

535 
	`¥š_lock_œq§ve
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

536 
·ck‘_hªdËr
 = 
	`qp_ok
(
·ck‘
);

537 ià(
	`lik–y
(
·ck‘_hªdËr
))

538 
	`·ck‘_hªdËr
(
·ck‘
);

540 
ibp
->
rvp
.
n_pkt_drÝs
++;

541 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

543 
	`rcu_»ad_uÆock
();

548 ià(
	`©omic_dec_»tuº
(&
mÿ¡
->
»fcouÁ
) <= 1)

549 
	`wake_up
(&
mÿ¡
->
wa™
);

552 ià(
·ck‘
->
‘y³
 =ð
RHF_RCV_TYPE_BYPASS
 &&

553 
	`hfi1_16B_g‘_l4
(
·ck‘
->
hdr
è=ð
OPA_16B_L4_FM
)

554 
qp_num
 = 
	`hfi1_16B_g‘_de¡_q²
(
·ck‘
->
mgmt
);

556 
qp_num
 = 
	`ib_bth_g‘_q²
(
·ck‘
->
ohdr
);

558 
	`rcu_»ad_lock
();

559 
·ck‘
->
qp
 = 
	`rvt_lookup_q²
(
rdi
, &
ibp
->
rvp
, 
qp_num
);

560 ià(!
·ck‘
->
qp
)

561 
uÆock_drÝ
;

563 ià(
	`hfi1_do_pkey_check
(
·ck‘
))

564 
uÆock_drÝ
;

566 
	`¥š_lock_œq§ve
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

567 
·ck‘_hªdËr
 = 
	`qp_ok
(
·ck‘
);

568 ià(
	`lik–y
(
·ck‘_hªdËr
))

569 
	`·ck‘_hªdËr
(
·ck‘
);

571 
ibp
->
rvp
.
n_pkt_drÝs
++;

572 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
qp
->
r_lock
, 
æags
);

573 
	`rcu_»ad_uÆock
();

576 
uÆock_drÝ
:

577 
	`rcu_»ad_uÆock
();

578 
drÝ
:

579 
ibp
->
rvp
.
n_pkt_drÝs
++;

580 
	}
}

588 
	$hfi1_ib_rcv
(
hfi1_·ck‘
 *
·ck‘
)

590 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

592 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, !!(
	`rhf_dc_šfo
Õack‘->
rhf
)));

593 
	`hfi1_hªdË_·ck‘
(
·ck‘
, 
	`hfi1_check_mÿ¡
Õack‘->
dlid
));

594 
	}
}

596 
	$hfi1_16B_rcv
(
hfi1_·ck‘
 *
·ck‘
)

598 
hfi1_ùxtd©a
 *
rcd
 = 
·ck‘
->rcd;

600 
	`Œaû_šput_ibhdr
(
rcd
->
dd
, 
·ck‘
, 
çl£
);

601 
	`hfi1_hªdË_·ck‘
(
·ck‘
, 
	`hfi1_check_mÿ¡
Õack‘->
dlid
));

602 
	}
}

608 
	$mem_tim”
(
tim”_li¡
 *
t
)

610 
hfi1_ibdev
 *
dev
 = 
	`äom_tim”
(dev, 
t
, 
mem_tim”
);

611 
li¡_h—d
 *
li¡
 = &
dev
->
memwa™
;

612 
rvt_qp
 *
qp
 = 
NULL
;

613 
iowa™
 *
wa™
;

614 
æags
;

615 
hfi1_qp_´iv
 *
´iv
;

617 
	`wr™e_£qlock_œq§ve
(&
dev
->
iowa™_lock
, 
æags
);

618 ià(!
	`li¡_em±y
(
li¡
)) {

619 
wa™
 = 
	`li¡_fœ¡_’Œy
(
li¡
, 
iowa™
,†ist);

620 
qp
 = 
	`iowa™_to_qp
(
wa™
);

621 
´iv
 = 
qp
->priv;

622 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

623 
´iv
->
s_iowa™
.
lock
 = 
NULL
;

625 ià(!
	`li¡_em±y
(
li¡
))

626 
	`mod_tim”
(&
dev
->
mem_tim”
, 
jiff›s
 + 1);

628 
	`wr™e_£quÆock_œq»¡Üe
(&
dev
->
iowa™_lock
, 
æags
);

630 ià(
qp
)

631 
	`hfi1_qp_wakeup
(
qp
, 
RVT_S_WAIT_KMEM
);

632 
	}
}

638 
	$v”bs_sdma_com¶‘e
(

639 
sdma_tx»q
 *
cook›
,

640 
¡©us
)

642 
v”bs_tx»q
 *
tx
 =

643 
	`cÚš”_of
(
cook›
, 
v”bs_tx»q
, 
tx»q
);

644 
rvt_qp
 *
qp
 = 
tx
->qp;

646 
	`¥š_lock
(&
qp
->
s_lock
);

647 ià(
tx
->
wqe
) {

648 
	`rvt_£nd_com¶‘e
(
qp
, 
tx
->
wqe
, 
IB_WC_SUCCESS
);

649 } ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
) {

650 
hfi1_Ýa_h—d”
 *
hdr
;

652 
hdr
 = &
tx
->
phdr
.hdr;

653 ià(
	`uÆik–y
(
¡©us
 =ð
SDMA_TXREQ_S_ABORTED
))

654 
	`hfi1_rc_v”bs_abÜ‹d
(
qp
, 
hdr
);

655 
	`hfi1_rc_£nd_com¶‘e
(
qp
, 
hdr
);

657 
	`¥š_uÆock
(&
qp
->
s_lock
);

659 
	`hfi1_put_tx»q
(
tx
);

660 
	}
}

662 
	$hfi1_wa™_kmem
(
rvt_qp
 *
qp
)

664 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

665 
ib_qp
 *
ibqp
 = &
qp
->ibqp;

666 
ib_deviû
 *
ibdev
 = 
ibqp
->
deviû
;

667 
hfi1_ibdev
 *
dev
 = 
	`to_idev
(
ibdev
);

669 ià(
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
)) {

670 ià(
	`li¡_em±y
(&
dev
->
memwa™
))

671 
	`mod_tim”
(&
dev
->
mem_tim”
, 
jiff›s
 + 1);

672 
qp
->
s_æags
 |ð
RVT_S_WAIT_KMEM
;

673 
	`li¡_add_ž
(&
´iv
->
s_iowa™
.
li¡
, &
dev
->
memwa™
);

674 
´iv
->
s_iowa™
.
lock
 = &
dev
->
iowa™_lock
;

675 
	`Œaû_hfi1_qp¦“p
(
qp
, 
RVT_S_WAIT_KMEM
);

676 
	`rvt_g‘_qp
(
qp
);

678 
	}
}

680 
	$wa™_kmem
(
hfi1_ibdev
 *
dev
,

681 
rvt_qp
 *
qp
,

682 
hfi1_pkt_¡©e
 *
ps
)

684 
æags
;

685 
»t
 = 0;

687 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

688 ià(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
) {

689 
	`wr™e_£qlock
(&
dev
->
iowa™_lock
);

690 
	`li¡_add_ž
(&
ps
->
s_tx»q
->
tx»q
.
li¡
,

691 &
ps
->
wa™
->
tx_h—d
);

692 
	`hfi1_wa™_kmem
(
qp
);

693 
	`wr™e_£quÆock
(&
dev
->
iowa™_lock
);

694 
	`hfi1_qp_unbusy
(
qp
, 
ps
->
wa™
);

695 
»t
 = -
EBUSY
;

697 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

699  
»t
;

700 
	}
}

702 
nošlše
 
	$hªdË_cÜru±ed_sge
(
sdma_’gše
 *
sde
,

703 
v”bs_tx»q
 *
tx
)

705 
tx
->
tx»q
.
æags
 |ð
SDMA_TXREQ_F_SGE_CORRUPT
;

706  -
EINVAL
;

707 
	}
}

714 
nošlše
 
	$bužd_v”bs_uÍ_·ylßd
(
sdma_’gše
 *
sde
,

715 
u32
 
Ëngth
,

716 
v”bs_tx»q
 *
tx
)

718 
rvt_sge
 *
sg_li¡
 = 
tx
->
ss
->sg_list;

719 
rvt_sge
 
sge
 = 
tx
->
ss
->sge;

720 
u8
 
num_sge
 = 
tx
->
ss
->num_sge;

721 
u32
 
Ën
;

722 
»t
 = 0;

724 
Ëngth
) {

725 
Ën
 = 
tx
->
ss
->
sge
.
Ëngth
;

726 ià(
Ën
 > 
Ëngth
)

727 
Ën
 = 
Ëngth
;

728 ià(
Ën
 > 
tx
->
ss
->
sge
.
sge_Ëngth
)

729 
Ën
 = 
tx
->
ss
->
sge
.
sge_Ëngth
;

730 ià(
	`WARN_ON_ONCE
(
Ën
 == 0)) {

731 
»t
 = 
	`hªdË_cÜru±ed_sge
(
sde
, 
tx
);

732 
baž_txadd
;

734 
»t
 = 
	`sdma_txadd_kvaddr
(

735 
sde
->
dd
,

736 &
tx
->
tx»q
,

737 
tx
->
ss
->
sge
.
vaddr
,

738 
Ën
);

739 ià(
»t
)

740 
baž_txadd
;

741 
	`rvt_upd©e_sge
(
tx
->
ss
, 
Ën
, 
çl£
);

742 
Ëngth
 -ð
Ën
;

744  
»t
;

745 
baž_txadd
:

747 
tx
->
ss
->
sge
 = sge;

748 
tx
->
ss
->
num_sge
 =‚um_sge;

749 
tx
->
ss
->
sg_li¡
 = sg_list;

750  
»t
;

751 
	}
}

762 
	$upd©e_tx_Ý¡©s
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

763 
u32
 
¶’
)

765 #ifdeà
CONFIG_DEBUG_FS


766 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

767 
hfi1_Ýcode_¡©s_³rùx
 *
s
 = 
	`g‘_ýu_±r
(
dd
->
tx_Ý¡©s
);

769 
	`šc_Ý¡©s
(
¶’
 * 4, &
s
->
¡©s
[
ps
->
Ýcode
]);

770 
	`put_ýu_±r
(
s
);

772 
	}
}

783 
	$bužd_v”bs_tx_desc
(

784 
sdma_’gše
 *
sde
,

785 
u32
 
Ëngth
,

786 
v”bs_tx»q
 *
tx
,

787 
hfi1_ahg_šfo
 *
ahg_šfo
,

788 
u64
 
pbc
)

790 
»t
 = 0;

791 
hfi1_sdma_h—d”
 *
phdr
 = &
tx
->phdr;

792 
u16
 
hdrby‹s
 = (
tx
->
hdr_dwÜds
 + (
pbc
) / 4) << 2;

793 
u8
 
exŒa_by‹s
 = 0;

795 ià(
tx
->
phdr
.
hdr
.
hdr_ty³
) {

800 
exŒa_by‹s
 = 
	`hfi1_g‘_16b_·ddšg
(
hdrby‹s
 - 8, 
Ëngth
) +

801 (
SIZE_OF_CRC
 << 2è+ 
SIZE_OF_LT
;

803 ià(!
ahg_šfo
->
ahgcouÁ
) {

804 
»t
 = 
	`sdma_txš™_ahg
(

805 &
tx
->
tx»q
,

806 
ahg_šfo
->
tx_æags
,

807 
hdrby‹s
 + 
Ëngth
 +

808 
exŒa_by‹s
,

809 
ahg_šfo
->
ahgidx
,

811 
NULL
,

813 
v”bs_sdma_com¶‘e
);

814 ià(
»t
)

815 
baž_txadd
;

816 
phdr
->
pbc
 = 
	`ýu_to_Ë64
(pbc);

817 
»t
 = 
	`sdma_txadd_kvaddr
(

818 
sde
->
dd
,

819 &
tx
->
tx»q
,

820 
phdr
,

821 
hdrby‹s
);

822 ià(
»t
)

823 
baž_txadd
;

825 
»t
 = 
	`sdma_txš™_ahg
(

826 &
tx
->
tx»q
,

827 
ahg_šfo
->
tx_æags
,

828 
Ëngth
,

829 
ahg_šfo
->
ahgidx
,

830 
ahg_šfo
->
ahgcouÁ
,

831 
ahg_šfo
->
ahgdesc
,

832 
hdrby‹s
,

833 
v”bs_sdma_com¶‘e
);

834 ià(
»t
)

835 
baž_txadd
;

838 ià(
tx
->
ss
) {

839 
»t
 = 
	`bužd_v”bs_uÍ_·ylßd
(
sde
, 
Ëngth
, 
tx
);

840 ià(
»t
)

841 
baž_txadd
;

845 ià(
exŒa_by‹s
)

846 
»t
 = 
	`sdma_txadd_daddr
(
sde
->
dd
, &
tx
->
tx»q
,

847 
sde
->
dd
->
sdma_·d_phys
, 
exŒa_by‹s
);

849 
baž_txadd
:

850  
»t
;

851 
	}
}

853 
u64
 
	$upd©e_hüc
(
u8
 
Ýcode
, 
u64
 
pbc
)

855 ià((
Ýcode
 & 
IB_OPCODE_TID_RDMA
) == IB_OPCODE_TID_RDMA) {

856 
pbc
 &ð~
PBC_INSERT_HCRC_SMASK
;

857 
pbc
 |ð(
u64
)
PBC_IHCRC_LKDETH
 << 
PBC_INSERT_HCRC_SHIFT
;

859  
pbc
;

860 
	}
}

862 
	$hfi1_v”bs_£nd_dma
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

863 
u64
 
pbc
)

865 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

866 
hfi1_ahg_šfo
 *
ahg_šfo
 = 
´iv
->
s_ahg
;

867 
u32
 
hdrwÜds
 = 
ps
->
s_tx»q
->
hdr_dwÜds
;

868 
u32
 
Ën
 = 
ps
->
s_tx»q
->
s_cur_size
;

869 
u32
 
¶’
;

870 
hfi1_ibdev
 *
dev
 = 
ps
->dev;

871 
hfi1_µÜtd©a
 *
µd
 = 
ps
->ppd;

872 
v”bs_tx»q
 *
tx
;

873 
u8
 
sc5
 = 
´iv
->
s_sc
;

874 
»t
;

875 
u32
 
dwÜds
;

877 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
) {

878 
u8
 
exŒa_by‹s
 = 
	`hfi1_g‘_16b_·ddšg
((
hdrwÜds
 << 2), 
Ën
);

880 
dwÜds
 = (
Ën
 + 
exŒa_by‹s
 + (
SIZE_OF_CRC
 << 2) +

881 
SIZE_OF_LT
) >> 2;

883 
dwÜds
 = (
Ën
 + 3) >> 2;

885 
¶’
 = 
hdrwÜds
 + 
dwÜds
 + (
pbc
) / 4;

887 
tx
 = 
ps
->
s_tx»q
;

888 ià(!
	`sdma_tx»q_bužt
(&
tx
->
tx»q
)) {

889 ià(
	`lik–y
(
pbc
 == 0)) {

890 
u32
 
vl
 = 
	`sc_to_vÉ
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
), 
sc5
);

894 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
)

895 
pbc
 |ð
PBC_PACKET_BYPASS
 |

896 
PBC_INSERT_BYPASS_ICRC
;

898 
pbc
 |ð(
	`ib_is_sc5
(
sc5
è<< 
PBC_DC_INFO_SHIFT
);

900 
pbc
 = 
	`ü—‹_pbc
(
µd
,

901 
pbc
,

902 
qp
->
¤©e_mbps
,

903 
vl
,

904 
¶’
);

906 ià(
	`uÆik–y
(
	`hfi1_dbg_should_çuÉ_tx
(
qp
, 
ps
->
Ýcode
)))

907 
pbc
 = 
	`hfi1_çuÉ_tx
(
qp
, 
ps
->
Ýcode
,…bc);

910 
pbc
 = 
	`upd©e_hüc
(
ps
->
Ýcode
,…bc);

912 
tx
->
wqe
 = 
qp
->
s_wqe
;

913 
»t
 = 
	`bužd_v”bs_tx_desc
(
tx
->
sde
, 
Ën
,x, 
ahg_šfo
, 
pbc
);

914 ià(
	`uÆik–y
(
»t
))

915 
baž_bužd
;

917 
»t
 = 
	`sdma_£nd_tx»q
(
tx
->
sde
, 
ps
->
wa™
, &tx->
tx»q
,…s->
pkts_£Á
);

918 ià(
	`uÆik–y
(
»t
 < 0)) {

919 ià(
»t
 =ð-
ECOMM
)

920 
baž_ecomm
;

921  
»t
;

924 
	`upd©e_tx_Ý¡©s
(
qp
, 
ps
, 
¶’
);

925 
	`Œaû_sdma_ouut_ibhdr
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
),

926 &
ps
->
s_tx»q
->
phdr
.
hdr
, 
	`ib_is_sc5
(
sc5
));

927  
»t
;

929 
baž_ecomm
:

932 
baž_bužd
:

933 ià(
	`uÆik–y
(
tx
->
tx»q
.
æags
 & 
SDMA_TXREQ_F_SGE_CORRUPT
))

934 
put_tx»q
;

935 
»t
 = 
	`wa™_kmem
(
dev
, 
qp
, 
ps
);

936 ià(!
»t
) {

937 
put_tx»q
:

939 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

940 
ps
->
s_tx»q
 = 
NULL
;

942  
»t
;

943 
	}
}

949 
	$pio_wa™
(
rvt_qp
 *
qp
,

950 
£nd_cÚ‹xt
 *
sc
,

951 
hfi1_pkt_¡©e
 *
ps
,

952 
u32
 
æag
)

954 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

955 
hfi1_devd©a
 *
dd
 = 
sc
->dd;

956 
æags
;

957 
»t
 = 0;

965 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

966 ià(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
) {

967 
	`wr™e_£qlock
(&
sc
->
wa™lock
);

968 
	`li¡_add_ž
(&
ps
->
s_tx»q
->
tx»q
.
li¡
,

969 &
ps
->
wa™
->
tx_h—d
);

970 ià(
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
)) {

971 
hfi1_ibdev
 *
dev
 = &
dd
->
v”bs_dev
;

972 
was_em±y
;

974 
dev
->
n_piowa™
 +ð!!(
æag
 & 
RVT_S_WAIT_PIO
);

975 
dev
->
n_piod¿š
 +ð!!(
æag
 & 
HFI1_S_WAIT_PIO_DRAIN
);

976 
qp
->
s_æags
 |ð
æag
;

977 
was_em±y
 = 
	`li¡_em±y
(&
sc
->
piowa™
);

978 
	`iowa™_g‘_´iÜ™y
(&
´iv
->
s_iowa™
);

979 
	`iowa™_queue
(
ps
->
pkts_£Á
, &
´iv
->
s_iowa™
,

980 &
sc
->
piowa™
);

981 
´iv
->
s_iowa™
.
lock
 = &
sc
->
wa™lock
;

982 
	`Œaû_hfi1_qp¦“p
(
qp
, 
RVT_S_WAIT_PIO
);

983 
	`rvt_g‘_qp
(
qp
);

985 ià(
was_em±y
)

986 
	`hfi1_sc_wªiobuf_šŒ
(
sc
, 1);

988 
	`wr™e_£quÆock
(&
sc
->
wa™lock
);

989 
	`hfi1_qp_unbusy
(
qp
, 
ps
->
wa™
);

990 
»t
 = -
EBUSY
;

992 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

993  
»t
;

994 
	}
}

996 
	$v”bs_pio_com¶‘e
(*
¬g
, 
code
)

998 
rvt_qp
 *
qp
 = (rvt_q°*)
¬g
;

999 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1001 ià(
	`iowa™_pio_dec
(&
´iv
->
s_iowa™
))

1002 
	`iowa™_d¿š_wakeup
(&
´iv
->
s_iowa™
);

1003 
	}
}

1005 
	$hfi1_v”bs_£nd_pio
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

1006 
u64
 
pbc
)

1008 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1009 
u32
 
hdrwÜds
 = 
ps
->
s_tx»q
->
hdr_dwÜds
;

1010 
u32
 
Ën
 = 
ps
->
s_tx»q
->
s_cur_size
;

1011 
u32
 
dwÜds
;

1012 
u32
 
¶’
;

1013 
hfi1_µÜtd©a
 *
µd
 = 
ps
->ppd;

1014 
u32
 *
hdr
;

1015 
u8
 
sc5
;

1016 
æags
 = 0;

1017 
£nd_cÚ‹xt
 *
sc
;

1018 
pio_buf
 *
pbuf
;

1019 
wc_¡©us
 = 
IB_WC_SUCCESS
;

1020 
»t
 = 0;

1021 
pio_»Ëa£_cb
 
cb
 = 
NULL
;

1022 
u8
 
exŒa_by‹s
 = 0;

1024 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
) {

1025 
u8
 
·d_size
 = 
	`hfi1_g‘_16b_·ddšg
((
hdrwÜds
 << 2), 
Ën
);

1027 
exŒa_by‹s
 = 
·d_size
 + (
SIZE_OF_CRC
 << 2è+ 
SIZE_OF_LT
;

1028 
dwÜds
 = (
Ën
 + 
exŒa_by‹s
) >> 2;

1029 
hdr
 = (
u32
 *)&
ps
->
s_tx»q
->
phdr
.hdr.
Ýah
;

1031 
dwÜds
 = (
Ën
 + 3) >> 2;

1032 
hdr
 = (
u32
 *)&
ps
->
s_tx»q
->
phdr
.hdr.
ibh
;

1034 
¶’
 = 
hdrwÜds
 + 
dwÜds
 + (
pbc
) / 4;

1037 
qp
->
ibqp
.
qp_ty³
) {

1038 
IB_QPT_RC
:

1039 
IB_QPT_UC
:

1040 
cb
 = 
v”bs_pio_com¶‘e
;

1047 
sc5
 = 
´iv
->
s_sc
;

1048 
sc
 = 
ps
->
s_tx»q
->
psc
;

1050 ià(
	`lik–y
(
pbc
 == 0)) {

1051 
u8
 
vl
 = 
	`sc_to_vÉ
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
), 
sc5
);

1054 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
)

1055 
pbc
 |ð
PBC_PACKET_BYPASS
 | 
PBC_INSERT_BYPASS_ICRC
;

1057 
pbc
 |ð(
	`ib_is_sc5
(
sc5
è<< 
PBC_DC_INFO_SHIFT
);

1059 
pbc
 = 
	`ü—‹_pbc
(
µd
,…bc, 
qp
->
¤©e_mbps
, 
vl
, 
¶’
);

1060 ià(
	`uÆik–y
(
	`hfi1_dbg_should_çuÉ_tx
(
qp
, 
ps
->
Ýcode
)))

1061 
pbc
 = 
	`hfi1_çuÉ_tx
(
qp
, 
ps
->
Ýcode
,…bc);

1064 
pbc
 = 
	`upd©e_hüc
(
ps
->
Ýcode
,…bc);

1066 ià(
cb
)

1067 
	`iowa™_pio_šc
(&
´iv
->
s_iowa™
);

1068 
pbuf
 = 
	`sc_bufãr_®loc
(
sc
, 
¶’
, 
cb
, 
qp
);

1069 ià(
	`IS_ERR_OR_NULL
(
pbuf
)) {

1070 ià(
cb
)

1071 
	`v”bs_pio_com¶‘e
(
qp
, 0);

1072 ià(
	`IS_ERR
(
pbuf
)) {

1079 
	`hfi1_cdbg
(

1080 
PIO
,

1082 
wc_¡©us
 = 
IB_WC_GENERAL_ERR
;

1083 
pio_baž
;

1090 
	`hfi1_cdbg
(
PIO
, "alloc failed. state‡ctive, queuing");

1091 
»t
 = 
	`pio_wa™
(
qp
, 
sc
, 
ps
, 
RVT_S_WAIT_PIO
);

1092 ià(!
»t
)

1094 
baž
;

1096  
»t
;

1100 ià(
dwÜds
 == 0) {

1101 
	`pio_cÝy
(
µd
->
dd
, 
pbuf
, 
pbc
, 
hdr
, 
hdrwÜds
);

1103 
	`£g_pio_cÝy_¡¬t
(
pbuf
, 
pbc
,

1104 
hdr
, 
hdrwÜds
 * 4);

1105 ià(
ps
->
s_tx»q
->
ss
) {

1106 
Ën
) {

1107 *
addr
 = 
ps
->
s_tx»q
->
ss
->
sge
.
vaddr
;

1108 
u32
 
¦’
 = 
ps
->
s_tx»q
->
ss
->
sge
.
Ëngth
;

1110 ià(
¦’
 > 
Ën
)

1111 
¦’
 = 
Ën
;

1112 ià(
¦’
 > 
ps
->
s_tx»q
->
ss
->
sge
.
sge_Ëngth
)

1113 
¦’
 = 
ps
->
s_tx»q
->
ss
->
sge
.
sge_Ëngth
;

1114 
	`rvt_upd©e_sge
(
ps
->
s_tx»q
->
ss
, 
¦’
, 
çl£
);

1115 
	`£g_pio_cÝy_mid
(
pbuf
, 
addr
, 
¦’
);

1116 
Ën
 -ð
¦’
;

1120 ià(
exŒa_by‹s
)

1121 
	`£g_pio_cÝy_mid
(
pbuf
, 
µd
->
dd
->
sdma_·d_dma
,

1122 
exŒa_by‹s
);

1124 
	`£g_pio_cÝy_’d
(
pbuf
);

1127 
	`upd©e_tx_Ý¡©s
(
qp
, 
ps
, 
¶’
);

1128 
	`Œaû_pio_ouut_ibhdr
(
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
),

1129 &
ps
->
s_tx»q
->
phdr
.
hdr
, 
	`ib_is_sc5
(
sc5
));

1131 
pio_baž
:

1132 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

1133 ià(
qp
->
s_wqe
) {

1134 
	`rvt_£nd_com¶‘e
(
qp
, qp->
s_wqe
, 
wc_¡©us
);

1135 } ià(
qp
->
ibqp
.
qp_ty³
 =ð
IB_QPT_RC
) {

1136 ià(
	`uÆik–y
(
wc_¡©us
 =ð
IB_WC_GENERAL_ERR
))

1137 
	`hfi1_rc_v”bs_abÜ‹d
(
qp
, &
ps
->
s_tx»q
->
phdr
.
hdr
);

1138 
	`hfi1_rc_£nd_com¶‘e
(
qp
, &
ps
->
s_tx»q
->
phdr
.
hdr
);

1140 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

1142 
»t
 = 0;

1144 
baž
:

1145 
	`hfi1_put_tx»q
(
ps
->
s_tx»q
);

1146  
»t
;

1147 
	}
}

1155 
šlše
 
	$eg»ss_pkey_m©ches_’Œy
(
u16
 
pkey
, u16 
’t
)

1157 
u16
 
mkey
 = 
pkey
 & 
PKEY_LOW_15_MASK
;

1158 
u16
 
m’Œy
 = 
’t
 & 
PKEY_LOW_15_MASK
;

1160 ià(
mkey
 =ð
m’Œy
) {

1166 ià(
pkey
 & 
PKEY_MEMBER_MASK
)

1167  !!(
’t
 & 
PKEY_MEMBER_MASK
);

1171 
	}
}

1187 
	$eg»ss_pkey_check
(
hfi1_µÜtd©a
 *
µd
, 
u32
 
¦id
, 
u16
 
pkey
,

1188 
u8
 
sc5
, 
št8_t
 
s_pkey_šdex
)

1190 
hfi1_devd©a
 *
dd
;

1191 
i
;

1192 
is_u£r_ùxt_mechªism
 = (
s_pkey_šdex
 < 0);

1199 ià(!(
µd
->
·¹_’fÜû
 & 
HFI1_PART_ENFORCE_OUT
)) {

1200 ià(!
is_u£r_ùxt_mechªism
)

1202 ià(!
£lšux_mode
)

1206 ià((
sc5
 =ð0xfè&& ((
pkey
 & 
PKEY_LOW_15_MASK
) != PKEY_LOW_15_MASK))

1207 
bad
;

1210 ià((
pkey
 & 
PKEY_LOW_15_MASK
) == 0)

1211 
bad
;

1217 ià(!
is_u£r_ùxt_mechªism
 &&

1218 
	`eg»ss_pkey_m©ches_’Œy
(
pkey
, 
µd
->
pkeys
[
s_pkey_šdex
])) {

1222 
i
 = 0; i < 
MAX_PKEY_VALUES
; i++) {

1223 ià(
	`eg»ss_pkey_m©ches_’Œy
(
pkey
, 
µd
->
pkeys
[
i
]))

1226 
bad
:

1232 ià(!
is_u£r_ùxt_mechªism
) {

1233 
	`šü_úŒ64
(&
µd
->
pÜt_xm™_cÚ¡¿št_”rÜs
);

1234 
dd
 = 
µd
->dd;

1235 ià(!(
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¡©us
 &

1236 
OPA_EI_STATUS_SMASK
)) {

1237 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¡©us
 |=

1238 
OPA_EI_STATUS_SMASK
;

1239 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
¦id
 = slid;

1240 
dd
->
”r_šfo_xm™_cÚ¡¿št
.
pkey
 =…key;

1244 
	}
}

1252 
šlše
 
£nd_routše
 
	$g‘_£nd_routše
(
rvt_qp
 *
qp
,

1253 
hfi1_pkt_¡©e
 *
ps
)

1255 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

1256 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1257 
v”bs_tx»q
 *
tx
 = 
ps
->
s_tx»q
;

1259 ià(
	`uÆik–y
(!(
dd
->
æags
 & 
HFI1_HAS_SEND_DMA
)))

1260  
dd
->
´oûss_pio_£nd
;

1261 
qp
->
ibqp
.
qp_ty³
) {

1262 
IB_QPT_SMI
:

1263  
dd
->
´oûss_pio_£nd
;

1264 
IB_QPT_GSI
:

1265 
IB_QPT_UD
:

1267 
IB_QPT_UC
:

1268 
IB_QPT_RC
:

1269 
´iv
->
s_ruÂšg_pkt_size
 =

1270 (
tx
->
s_cur_size
 + 
´iv
->
s_ruÂšg_pkt_size
) / 2;

1271 ià(
piÙh»shÞd
 &&

1272 
´iv
->
s_ruÂšg_pkt_size
 <ð
	`mš
(
piÙh»shÞd
, 
qp
->
pmtu
) &&

1273 (
	`BIT
(
ps
->
Ýcode
 & 
OPMASK
è& 
pio_Ýmask
[ps->opcode >> 5]) &&

1274 
	`iowa™_sdma_³ndšg
(&
´iv
->
s_iowa™
) == 0 &&

1275 !
	`sdma_tx»q_bužt
(&
tx
->
tx»q
))

1276  
dd
->
´oûss_pio_£nd
;

1281  
dd
->
´oûss_dma_£nd
;

1282 
	}
}

1292 
	$hfi1_v”bs_£nd
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
)

1294 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
qp
->
ibqp
.
deviû
);

1295 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

1296 
ib_Ùh”_h—d”s
 *
ohdr
 = 
NULL
;

1297 
£nd_routše
 
¤
;

1298 
»t
;

1299 
u16
 
pkey
;

1300 
u32
 
¦id
;

1301 
u8
 
l4
 = 0;

1304 ià(
ps
->
s_tx»q
->
phdr
.
hdr
.
hdr_ty³
) {

1305 
hfi1_16b_h—d”
 *
hdr
 = &
ps
->
s_tx»q
->
phdr
.hdr.
Ýah
;

1307 
l4
 = 
	`hfi1_16B_g‘_l4
(
hdr
);

1308 ià(
l4
 =ð
OPA_16B_L4_IB_LOCAL
)

1309 
ohdr
 = &
hdr
->
u
.
Ùh
;

1310 ià(
l4
 =ð
OPA_16B_L4_IB_GLOBAL
)

1311 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1313 
¦id
 = 
	`hfi1_16B_g‘_¦id
(
hdr
);

1314 
pkey
 = 
	`hfi1_16B_g‘_pkey
(
hdr
);

1316 
ib_h—d”
 *
hdr
 = &
ps
->
s_tx»q
->
phdr
.hdr.
ibh
;

1317 
u8
 
Êh
 = 
	`ib_g‘_Êh
(
hdr
);

1319 ià(
Êh
 =ð
HFI1_LRH_GRH
)

1320 
ohdr
 = &
hdr
->
u
.
l
.
Ùh
;

1322 
ohdr
 = &
hdr
->
u
.
Ùh
;

1323 
¦id
 = 
	`ib_g‘_¦id
(
hdr
);

1324 
pkey
 = 
	`ib_bth_g‘_pkey
(
ohdr
);

1327 ià(
	`lik–y
(
l4
 !ð
OPA_16B_L4_FM
))

1328 
ps
->
Ýcode
 = 
	`ib_bth_g‘_Ýcode
(
ohdr
);

1330 
ps
->
Ýcode
 = 
IB_OPCODE_UD_SEND_ONLY
;

1332 
¤
 = 
	`g‘_£nd_routše
(
qp
, 
ps
);

1333 
»t
 = 
	`eg»ss_pkey_check
(
dd
->
µÜt
, 
¦id
, 
pkey
,

1334 
´iv
->
s_sc
, 
qp
->
s_pkey_šdex
);

1335 ià(
	`uÆik–y
(
»t
)) {

1344 ià(
¤
 =ð
dd
->
´oûss_pio_£nd
) {

1345 
æags
;

1347 
	`hfi1_cdbg
(
PIO
, "%s() Failed. Completing withƒrr",

1348 
__func__
);

1349 
	`¥š_lock_œq§ve
(&
qp
->
s_lock
, 
æags
);

1350 
	`rvt_£nd_com¶‘e
(
qp
, qp->
s_wqe
, 
IB_WC_GENERAL_ERR
);

1351 
	`¥š_uÆock_œq»¡Üe
(&
qp
->
s_lock
, 
æags
);

1353  -
EINVAL
;

1355 ià(
¤
 =ð
dd
->
´oûss_dma_£nd
 && 
	`iowa™_pio_³ndšg
(&
´iv
->
s_iowa™
))

1356  
	`pio_wa™
(
qp
,

1357 
ps
->
s_tx»q
->
psc
,

1358 
ps
,

1359 
HFI1_S_WAIT_PIO_DRAIN
);

1360  
	`¤
(
qp
, 
ps
, 0);

1361 
	}
}

1367 
	$hfi1_fžl_deviû_©Œ
(
hfi1_devd©a
 *
dd
)

1369 
rvt_dev_šfo
 *
rdi
 = &
dd
->
v”bs_dev
.rdi;

1370 
u32
 
v”
 = 
dd
->
dc8051_v”
;

1372 
	`mem£t
(&
rdi
->
d·rms
.
´Ýs
, 0, (rdi->dparms.props));

1374 
rdi
->
d·rms
.
´Ýs
.
fw_v”
 = ((
u64
)(
	`dc8051_v”_maj
(
v”
)) << 32) |

1375 ((
u64
)(
	`dc8051_v”_mš
(
v”
)) << 16) |

1376 (
u64
)
	`dc8051_v”_·tch
(
v”
);

1378 
rdi
->
d·rms
.
´Ýs
.
deviû_ÿp_æags
 = 
IB_DEVICE_BAD_PKEY_CNTR
 |

1379 
IB_DEVICE_BAD_QKEY_CNTR
 | 
IB_DEVICE_SHUTDOWN_PORT
 |

1380 
IB_DEVICE_SYS_IMAGE_GUID
 | 
IB_DEVICE_RC_RNR_NAK_GEN
 |

1381 
IB_DEVICE_PORT_ACTIVE_EVENT
 | 
IB_DEVICE_SRQ_RESIZE
 |

1382 
IB_DEVICE_MEM_MGT_EXTENSIONS
 |

1383 
IB_DEVICE_RDMA_NETDEV
;

1384 
rdi
->
d·rms
.
´Ýs
.
·ge_size_ÿp
 = 
PAGE_SIZE
;

1385 
rdi
->
d·rms
.
´Ýs
.
v’dÜ_id
 = 
dd
->
oui1
 << 16 | dd->
oui2
 << 8 | dd->
oui3
;

1386 
rdi
->
d·rms
.
´Ýs
.
v’dÜ_·¹_id
 = 
dd
->
pcidev
->
deviû
;

1387 
rdi
->
d·rms
.
´Ýs
.
hw_v”
 = 
dd
->
mš»v
;

1388 
rdi
->
d·rms
.
´Ýs
.
sys_image_guid
 = 
ib_hfi1_sys_image_guid
;

1389 
rdi
->
d·rms
.
´Ýs
.
max_mr_size
 = 
U64_MAX
;

1390 
rdi
->
d·rms
.
´Ýs
.
max_ç¡_»g_·ge_li¡_Ën
 = 
UINT_MAX
;

1391 
rdi
->
d·rms
.
´Ýs
.
max_qp
 = 
hfi1_max_qps
;

1392 
rdi
->
d·rms
.
´Ýs
.
max_qp_wr
 =

1393 (
hfi1_max_qp_wrs
 >ð
HFI1_QP_WQE_INVALID
 ?

1394 
HFI1_QP_WQE_INVALID
 - 1 : 
hfi1_max_qp_wrs
);

1395 #ifdeà
HAVE_MAX_SEND_SGE


1396 
rdi
->
d·rms
.
´Ýs
.
max_£nd_sge
 = 
hfi1_max_sges
;

1397 
rdi
->
d·rms
.
´Ýs
.
max_»cv_sge
 = 
hfi1_max_sges
;

1399 
rdi
->
d·rms
.
´Ýs
.
max_sge
 = 
hfi1_max_sges
;

1401 
rdi
->
d·rms
.
´Ýs
.
max_sge_rd
 = 
hfi1_max_sges
;

1402 
rdi
->
d·rms
.
´Ýs
.
max_cq
 = 
hfi1_max_cqs
;

1403 
rdi
->
d·rms
.
´Ýs
.
max_ah
 = 
hfi1_max_ahs
;

1404 
rdi
->
d·rms
.
´Ýs
.
max_cqe
 = 
hfi1_max_cqes
;

1405 
rdi
->
d·rms
.
´Ýs
.
max_m­_³r_fmr
 = 32767;

1406 
rdi
->
d·rms
.
´Ýs
.
max_pd
 = 
hfi1_max_pds
;

1407 
rdi
->
d·rms
.
´Ýs
.
max_qp_rd_©om
 = 
HFI1_MAX_RDMA_ATOMIC
;

1408 
rdi
->
d·rms
.
´Ýs
.
max_qp_š™_rd_©om
 = 255;

1409 
rdi
->
d·rms
.
´Ýs
.
max_¤q
 = 
hfi1_max_¤qs
;

1410 
rdi
->
d·rms
.
´Ýs
.
max_¤q_wr
 = 
hfi1_max_¤q_wrs
;

1411 
rdi
->
d·rms
.
´Ýs
.
max_¤q_sge
 = 
hfi1_max_¤q_sges
;

1412 
rdi
->
d·rms
.
´Ýs
.
©omic_ÿp
 = 
IB_ATOMIC_GLOB
;

1413 
rdi
->
d·rms
.
´Ýs
.
max_pkeys
 = 
	`hfi1_g‘_Åkeys
(
dd
);

1414 
rdi
->
d·rms
.
´Ýs
.
max_mÿ¡_g½
 = 
hfi1_max_mÿ¡_g½s
;

1415 
rdi
->
d·rms
.
´Ýs
.
max_mÿ¡_qp_©ch
 = 
hfi1_max_mÿ¡_qp_©ched
;

1416 
rdi
->
d·rms
.
´Ýs
.
max_tÙ®_mÿ¡_qp_©ch
 =

1417 
rdi
->
d·rms
.
´Ýs
.
max_mÿ¡_qp_©ch
 *

1418 
rdi
->
d·rms
.
´Ýs
.
max_mÿ¡_g½
;

1419 
	}
}

1421 
šlše
 
u16
 
	$Ýa_¥“d_to_ib
(
u16
 
š
)

1423 
u16
 
out
 = 0;

1425 ià(
š
 & 
OPA_LINK_SPEED_25G
)

1426 
out
 |ð
IB_SPEED_EDR
;

1427 ià(
š
 & 
OPA_LINK_SPEED_12_5G
)

1428 
out
 |ð
IB_SPEED_FDR
;

1430  
out
;

1431 
	}
}

1438 
šlše
 
u16
 
	$Ýa_width_to_ib
(
u16
 
š
)

1440 
š
) {

1441 
OPA_LINK_WIDTH_1X
:

1443 
OPA_LINK_WIDTH_2X
:

1444 
OPA_LINK_WIDTH_3X
:

1445  
IB_WIDTH_1X
;

1447 
OPA_LINK_WIDTH_4X
:

1448  
IB_WIDTH_4X
;

1450 
	}
}

1452 
	$qu”y_pÜt
(
rvt_dev_šfo
 *
rdi
, 
u8
 
pÜt_num
,

1453 
ib_pÜt_©Œ
 *
´Ýs
)

1455 
hfi1_ibdev
 *
v”bs_dev
 = 
	`dev_äom_rdi
(
rdi
);

1456 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
v”bs_dev
);

1457 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[
pÜt_num
 - 1];

1458 
u32
 
lid
 = 
µd
->lid;

1461 
´Ýs
->
lid
 =†id ?†id : 0;

1462 
´Ýs
->
lmc
 = 
µd
->lmc;

1464 
´Ýs
->
¡©e
 = 
	`driv”_l¡©e
(
µd
);

1465 
´Ýs
->
phys_¡©e
 = 
	`driv”_p¡©e
(
µd
);

1466 
´Ýs
->
gid_tbl_Ën
 = 
HFI1_GUIDS_PER_PORT
;

1467 
´Ýs
->
aùive_width
 = (
u8
)
	`Ýa_width_to_ib
(
µd
->
lšk_width_aùive
);

1469 
´Ýs
->
aùive_¥“d
 = (
u8
)
	`Ýa_¥“d_to_ib
(
µd
->
lšk_¥“d_aùive
);

1470 
´Ýs
->
max_vl_num
 = 
µd
->
vls_suµÜ‹d
;

1480 
´Ýs
->
max_mtu
 = 
	`mtu_to_’um
((!
	`v®id_ib_mtu
(
hfi1_max_mtu
) ?

1481 4096 : 
hfi1_max_mtu
), 
IB_MTU_4096
);

1482 
´Ýs
->
aùive_mtu
 = !
	`v®id_ib_mtu
(
µd
->
ibmtu
è?…rÝs->
max_mtu
 :

1483 
	`mtu_to_’um
(
µd
->
ibmtu
, 
IB_MTU_4096
);

1485 #ifdeà
IB_PORT_ATTR_HAS_GRH_REQUIRED


1492 ià(
´Ýs
->
sm_lid
 =ð
	`be16_to_ýu
(
IB_LID_PERMISSIVE
))

1493 
´Ýs
->
grh_»quœed
 = 
Œue
;

1496 
	}
}

1498 
	$modify_deviû
(
ib_deviû
 *
deviû
,

1499 
deviû_modify_mask
,

1500 
ib_deviû_modify
 *
deviû_modify
)

1502 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
deviû
);

1503 
i
;

1504 
»t
;

1506 ià(
deviû_modify_mask
 & ~(
IB_DEVICE_MODIFY_SYS_IMAGE_GUID
 |

1507 
IB_DEVICE_MODIFY_NODE_DESC
)) {

1508 
»t
 = -
EOPNOTSUPP
;

1509 
baž
;

1512 ià(
deviû_modify_mask
 & 
IB_DEVICE_MODIFY_NODE_DESC
) {

1513 
	`memýy
(
deviû
->
node_desc
, 
deviû_modify
->node_desc,

1514 
IB_DEVICE_NODE_DESC_MAX
);

1515 
i
 = 0; i < 
dd
->
num_µÜts
; i++) {

1516 
hfi1_ibpÜt
 *
ibp
 = &
dd
->
µÜt
[
i
].
ibpÜt_d©a
;

1518 
	`hfi1_node_desc_chg
(
ibp
);

1522 ià(
deviû_modify_mask
 & 
IB_DEVICE_MODIFY_SYS_IMAGE_GUID
) {

1523 
ib_hfi1_sys_image_guid
 =

1524 
	`ýu_to_be64
(
deviû_modify
->
sys_image_guid
);

1525 
i
 = 0; i < 
dd
->
num_µÜts
; i++) {

1526 
hfi1_ibpÜt
 *
ibp
 = &
dd
->
µÜt
[
i
].
ibpÜt_d©a
;

1528 
	`hfi1_sys_guid_chg
(
ibp
);

1532 
»t
 = 0;

1534 
baž
:

1535  
»t
;

1536 
	}
}

1538 
	$shut_down_pÜt
(
rvt_dev_šfo
 *
rdi
, 
u8
 
pÜt_num
)

1540 
hfi1_ibdev
 *
v”bs_dev
 = 
	`dev_äom_rdi
(
rdi
);

1541 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
v”bs_dev
);

1542 
hfi1_µÜtd©a
 *
µd
 = &
dd
->
µÜt
[
pÜt_num
 - 1];

1543 
»t
;

1545 
	`£t_lšk_down_»asÚ
(
µd
, 
OPA_LINKDOWN_REASON_UNKNOWN
, 0,

1546 
OPA_LINKDOWN_REASON_UNKNOWN
);

1547 
»t
 = 
	`£t_lšk_¡©e
(
µd
, 
HLS_DN_DOWNDEF
);

1548  
»t
;

1549 
	}
}

1551 
	$hfi1_g‘_guid_be
(
rvt_dev_šfo
 *
rdi
, 
rvt_ibpÜt
 *
rvp
,

1552 
guid_šdex
, 
__be64
 *
guid
)

1554 
hfi1_ibpÜt
 *
ibp
 = 
	`cÚš”_of
(
rvp
, hfi1_ibport,„vp);

1556 ià(
guid_šdex
 >ð
HFI1_GUIDS_PER_PORT
)

1557  -
EINVAL
;

1559 *
guid
 = 
	`g‘_sguid
(
ibp
, 
guid_šdex
);

1561 
	}
}

1566 
u8
 
	$ah_to_sc
(
ib_deviû
 *
ibdev
, 
rdma_ah_©Œ
 *
ah
)

1568 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
	`rdma_ah_g‘_pÜt_num
(
ah
));

1570  
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(
ah
)];

1571 
	}
}

1573 
	$hfi1_check_ah
(
ib_deviû
 *
ibdev
, 
rdma_ah_©Œ
 *
ah_©Œ
)

1575 
hfi1_ibpÜt
 *
ibp
;

1576 
hfi1_µÜtd©a
 *
µd
;

1577 
hfi1_devd©a
 *
dd
;

1578 
u8
 
sc5
;

1579 
u8
 
¦
;

1581 ià(
	`hfi1_check_mÿ¡
(
	`rdma_ah_g‘_dlid
(
ah_©Œ
)) &&

1582 !(
	`rdma_ah_g‘_ah_æags
(
ah_©Œ
è& 
IB_AH_GRH
))

1583  -
EINVAL
;

1586 
ibp
 = 
	`to_Üt
(
ibdev
, 
	`rdma_ah_g‘_pÜt_num
(
ah_©Œ
));

1587 
µd
 = 
	`µd_äom_ibp
(
ibp
);

1588 
dd
 = 
	`dd_äom_µd
(
µd
);

1590 
¦
 = 
	`rdma_ah_g‘_¦
(
ah_©Œ
);

1591 ià(
¦
 >ð
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
))

1592  -
EINVAL
;

1593 
¦
 = 
	`¬¿y_šdex_no¥ec
(¦, 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
));

1595 
sc5
 = 
ibp
->
¦_to_sc
[
¦
];

1596 ià(
	`sc_to_vÉ
(
dd
, 
sc5
è> 
num_vls
 && sc_to_vlt(dd, sc5) != 0xf)

1597  -
EINVAL
;

1599 
	}
}

1601 
	$hfi1_nÙify_Ãw_ah
(
ib_deviû
 *
ibdev
,

1602 
rdma_ah_©Œ
 *
ah_©Œ
,

1603 
rvt_ah
 *
ah
)

1605 
hfi1_ibpÜt
 *
ibp
;

1606 
hfi1_µÜtd©a
 *
µd
;

1607 
hfi1_devd©a
 *
dd
;

1608 
u8
 
sc5
;

1609 
rdma_ah_©Œ
 *
©Œ
 = &
ah
->attr;

1616 
ibp
 = 
	`to_Üt
(
ibdev
, 
	`rdma_ah_g‘_pÜt_num
(
ah_©Œ
));

1617 
µd
 = 
	`µd_äom_ibp
(
ibp
);

1618 
sc5
 = 
ibp
->
¦_to_sc
[
	`rdma_ah_g‘_¦
(&
ah
->
©Œ
)];

1619 
	`hfi1_upd©e_ah_©Œ
(
ibdev
, 
©Œ
);

1620 
	`hfi1_make_Ýa_lid
(
©Œ
);

1621 
dd
 = 
	`dd_äom_µd
(
µd
);

1622 
ah
->
vl
 = 
	`sc_to_vÉ
(
dd
, 
sc5
);

1623 ià(
ah
->
vl
 < 
num_vls
 ||‡h->vl == 15)

1624 
ah
->
log_pmtu
 = 
	`žog2
(
dd
->
vld
[ah->
vl
].
mtu
);

1625 
	}
}

1631 
	$hfi1_g‘_Åkeys
(
hfi1_devd©a
 *
dd
)

1633  
	`ARRAY_SIZE
(
dd
->
µÜt
[0].
pkeys
);

1634 
	}
}

1636 
	$š™_ibpÜt
(
hfi1_µÜtd©a
 *
µd
)

1638 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

1639 
size_t
 
sz
 = 
	`ARRAY_SIZE
(
ibp
->
¦_to_sc
);

1640 
i
;

1642 
i
 = 0; i < 
sz
; i++) {

1643 
ibp
->
¦_to_sc
[
i
] = i;

1644 
ibp
->
sc_to_¦
[
i
] = i;

1647 
i
 = 0; i < 
RVT_MAX_TRAP_LISTS
 ; i++)

1648 
	`INIT_LIST_HEAD
(&
ibp
->
rvp
.
Œ­_li¡s
[
i
].
li¡
);

1649 
	`tim”_£tup
(&
ibp
->
rvp
.
Œ­_tim”
, 
hfi1_hªdË_Œ­_tim”
, 0);

1651 
	`¥š_lock_š™
(&
ibp
->
rvp
.
lock
);

1653 
ibp
->
rvp
.
gid_´efix
 = 
IB_DEFAULT_GID_PREFIX
;

1654 
ibp
->
rvp
.
sm_lid
 = 0;

1659 
ibp
->
rvp
.
pÜt_ÿp_æags
 = 
IB_PORT_AUTO_MIGR_SUP
 |

1660 
IB_PORT_CAP_MASK_NOTICE_SUP
;

1661 
ibp
->
rvp
.
pÜt_ÿp3_æags
 = 
OPA_CAP_MASK3_IsSh¬edS·ûSuµÜ‹d
;

1662 
ibp
->
rvp
.
pma_couÁ”_£Ëù
[0] = 
IB_PMA_PORT_XMIT_DATA
;

1663 
ibp
->
rvp
.
pma_couÁ”_£Ëù
[1] = 
IB_PMA_PORT_RCV_DATA
;

1664 
ibp
->
rvp
.
pma_couÁ”_£Ëù
[2] = 
IB_PMA_PORT_XMIT_PKTS
;

1665 
ibp
->
rvp
.
pma_couÁ”_£Ëù
[3] = 
IB_PMA_PORT_RCV_PKTS
;

1666 
ibp
->
rvp
.
pma_couÁ”_£Ëù
[4] = 
IB_PMA_PORT_XMIT_WAIT
;

1668 
	`RCU_INIT_POINTER
(
ibp
->
rvp
.
qp
[0], 
NULL
);

1669 
	`RCU_INIT_POINTER
(
ibp
->
rvp
.
qp
[1], 
NULL
);

1670 
	}
}

1671 #iâdeà
GET_DEV_FW_STR_HAS_LEN


1672 
	$hfi1_g‘_dev_fw_¡r
(
ib_deviû
 *
ibdev
, *
¡r
)

1674 
rvt_dev_šfo
 *
rdi
 = 
	`ib_to_rvt
(
ibdev
);

1675 
hfi1_ibdev
 *
dev
 = 
	`dev_äom_rdi
(
rdi
);

1676 
u32
 
v”
 = 
	`dd_äom_dev
(
dev
)->
dc8051_v”
;

1678 
	`¢´štf
(
¡r
, 
IB_FW_VERSION_NAME_MAX
, "%u.%u.%u", 
	`dc8051_v”_maj
(
v”
),

1679 
	`dc8051_v”_mš
(
v”
), 
	`dc8051_v”_·tch
(ver));

1680 
	}
}

1682 
	$hfi1_g‘_dev_fw_¡r
(
ib_deviû
 *
ibdev
, *
¡r
,

1683 
size_t
 
¡r_Ën
)

1685 
rvt_dev_šfo
 *
rdi
 = 
	`ib_to_rvt
(
ibdev
);

1686 
hfi1_ibdev
 *
dev
 = 
	`dev_äom_rdi
(
rdi
);

1687 
u32
 
v”
 = 
	`dd_äom_dev
(
dev
)->
dc8051_v”
;

1689 
	`¢´štf
(
¡r
, 
¡r_Ën
, "%u.%u.%u", 
	`dc8051_v”_maj
(
v”
),

1690 
	`dc8051_v”_mš
(
v”
), 
	`dc8051_v”_·tch
(ver));

1691 
	}
}

1694 cÚ¡ * cÚ¡ 
	gdriv”_úŒ_Çmes
[] = {

1708 
DEFINE_MUTEX
(
úŒ_Çmes_lock
);

1709 cÚ¡ **
	gdev_úŒ_Çmes
;

1710 cÚ¡ **
	gpÜt_úŒ_Çmes
;

1711 
	gnum_driv”_úŒs
 = 
ARRAY_SIZE
(
driv”_úŒ_Çmes
);

1712 
	gnum_dev_úŒs
;

1713 
	gnum_pÜt_úŒs
;

1714 
	gúŒ_Çmes_š™Ÿlized
;

1721 
	$š™_úŒ_Çmes
(cÚ¡ *
Çmes_š
,

1722 cÚ¡ 
size_t
 
Çmes_Ën
,

1723 
num_exŒa_Çmes
,

1724 *
num_úŒs
,

1725 cÚ¡ ***
úŒ_Çmes
)

1727 *
Çmes_out
, *
p
, **
q
;

1728 
i
, 
n
;

1730 
n
 = 0;

1731 
i
 = 0; i < 
Çmes_Ën
; i++)

1732 ià(
Çmes_š
[
i
] == '\n')

1733 
n
++;

1735 
Çmes_out
 = 
	`km®loc
((
n
 + 
num_exŒa_Çmes
è* (*è+ 
Çmes_Ën
,

1736 
GFP_KERNEL
);

1737 ià(!
Çmes_out
) {

1738 *
num_úŒs
 = 0;

1739 *
úŒ_Çmes
 = 
NULL
;

1740  -
ENOMEM
;

1743 
p
 = 
Çmes_out
 + (
n
 + 
num_exŒa_Çmes
) * (*);

1744 
	`memýy
(
p
, 
Çmes_š
, 
Çmes_Ën
);

1746 
q
 = (**)
Çmes_out
;

1747 
i
 = 0; i < 
n
; i++) {

1748 
q
[
i
] = 
p
;

1749 
p
 = 
	`¡rchr
(p, '\n');

1750 ià(!
p
) {

1751 *
num_úŒs
 = 0;

1752 *
úŒ_Çmes
 = 
NULL
;

1753 
	`kä“
(
Çmes_out
);

1754  -
EINVAL
;

1756 *
p
++ = '\0';

1759 *
num_úŒs
 = 
n
;

1760 *
úŒ_Çmes
 = (cÚ¡ **)
Çmes_out
;

1762 
	}
}

1764 
rdma_hw_¡©s
 *
	$®loc_hw_¡©s
(
ib_deviû
 *
ibdev
,

1765 
u8
 
pÜt_num
)

1767 
i
, 
”r
;

1769 
	`mu‹x_lock
(&
úŒ_Çmes_lock
);

1770 ià(!
úŒ_Çmes_š™Ÿlized
) {

1771 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
ibdev
);

1773 
”r
 = 
	`š™_úŒ_Çmes
(
dd
->
úŒÇmes
,

1774 
dd
->
úŒÇme¦’
,

1775 
num_driv”_úŒs
,

1776 &
num_dev_úŒs
,

1777 &
dev_úŒ_Çmes
);

1778 ià(
”r
) {

1779 
	`mu‹x_uÆock
(&
úŒ_Çmes_lock
);

1780  
NULL
;

1783 
i
 = 0; i < 
num_driv”_úŒs
; i++)

1784 
dev_úŒ_Çmes
[
num_dev_úŒs
 + 
i
] =

1785 
driv”_úŒ_Çmes
[
i
];

1787 
”r
 = 
	`š™_úŒ_Çmes
(
dd
->
pÜtúŒÇmes
,

1788 
dd
->
pÜtúŒÇme¦’
,

1790 &
num_pÜt_úŒs
,

1791 &
pÜt_úŒ_Çmes
);

1792 ià(
”r
) {

1793 
	`kä“
(
dev_úŒ_Çmes
);

1794 
dev_úŒ_Çmes
 = 
NULL
;

1795 
	`mu‹x_uÆock
(&
úŒ_Çmes_lock
);

1796  
NULL
;

1798 
úŒ_Çmes_š™Ÿlized
 = 1;

1800 
	`mu‹x_uÆock
(&
úŒ_Çmes_lock
);

1802 ià(!
pÜt_num
)

1803  
	`rdma_®loc_hw_¡©s_¡ruù
(

1804 
dev_úŒ_Çmes
,

1805 
num_dev_úŒs
 + 
num_driv”_úŒs
,

1806 
RDMA_HW_STATS_DEFAULT_LIFESPAN
);

1808  
	`rdma_®loc_hw_¡©s_¡ruù
(

1809 
pÜt_úŒ_Çmes
,

1810 
num_pÜt_úŒs
,

1811 
RDMA_HW_STATS_DEFAULT_LIFESPAN
);

1812 
	}
}

1813 
u64
 
	$hfi1_¥s_šts
()

1815 
æags
;

1816 
hfi1_devd©a
 *
dd
;

1817 
u64
 
¥s_šts
 = 0;

1819 
	`¥š_lock_œq§ve
(&
hfi1_devs_lock
, 
æags
);

1820 
	`li¡_fÜ_—ch_’Œy
(
dd
, &
hfi1_dev_li¡
, 
li¡
) {

1821 
¥s_šts
 +ð
	`g‘_®l_ýu_tÙ®
(
dd
->
št_couÁ”
);

1823 
	`¥š_uÆock_œq»¡Üe
(&
hfi1_devs_lock
, 
æags
);

1824  
¥s_šts
;

1825 
	}
}

1827 
	$g‘_hw_¡©s
(
ib_deviû
 *
ibdev
, 
rdma_hw_¡©s
 *
¡©s
,

1828 
u8
 
pÜt
, 
šdex
)

1830 
u64
 *
v®ues
;

1831 
couÁ
;

1833 ià(!
pÜt
) {

1834 
u64
 *
¡©s
 = (u64 *)&
hfi1_¡©s
;

1835 
i
;

1837 
	`hfi1_»ad_úŒs
(
	`dd_äom_ibdev
(
ibdev
), 
NULL
, &
v®ues
);

1838 
v®ues
[
num_dev_úŒs
] = 
	`hfi1_¥s_šts
();

1839 
i
 = 1; i < 
num_driv”_úŒs
; i++)

1840 
v®ues
[
num_dev_úŒs
 + 
i
] = 
¡©s
[i];

1841 
couÁ
 = 
num_dev_úŒs
 + 
num_driv”_úŒs
;

1843 
hfi1_ibpÜt
 *
ibp
 = 
	`to_Üt
(
ibdev
, 
pÜt
);

1845 
	`hfi1_»ad_pÜtúŒs
(
	`µd_äom_ibp
(
ibp
), 
NULL
, &
v®ues
);

1846 
couÁ
 = 
num_pÜt_úŒs
;

1849 
	`memýy
(
¡©s
->
v®ue
, 
v®ues
, 
couÁ
 * (
u64
));

1850  
couÁ
;

1851 
	}
}

1853 #ifdeà
HAVE_ALLOC_RDMA_NETDEV


1854 
Ãt_deviû
 *
hfi1_®loc_º
(
ib_deviû
 *
deviû
,

1855 
u8
 
pÜt_num
,

1856 
rdma_Ãtdev_t
 
ty³
,

1857 cÚ¡ *
Çme
,

1858 
Çme_assign_ty³
,

1859 (*
£tup
)(
Ãt_deviû
 *))

1861 
Ãt_deviû
 *
dev
;

1863 
ty³
) {

1865 #ifdef 
CONFIG_INFINIBAND_OPA_VNIC


1866 
RDMA_NETDEV_OPA_VNIC
:

1867 
dev
 = 
	`hfi1_vnic_®loc_º
(
deviû
,

1868 
pÜt_num
,

1869 
ty³
,

1870 
Çme
,

1871 
Çme_assign_ty³
,

1872 
£tup
);

1876 
RDMA_NETDEV_IPOIB
:

1877 
dev
 = 
	`hfi1_oib_®loc_º
(
deviû
,

1878 
pÜt_num
,

1879 
ty³
,

1880 
Çme
,

1881 
Çme_assign_ty³
,

1882 
£tup
);

1886 
dev
 = 
	`ERR_PTR
(-
EOPNOTSUPP
);

1890  
dev
;

1891 
	}
}

1894 cÚ¡ 
ib_deviû_Ýs
 
	ghfi1_dev_Ýs
 = {

1895 #ifdeà
IB_DEVICE_OPS_DRIVER_ID


1896 .
driv”_id
 = 
RDMA_DRIVER_HFI1
,

1898 #ifdeà
IB_DEVICE_OPS_OWNER


1899 .
	gowÃr
 = 
THIS_MODULE
,

1901 .
	g®loc_hw_¡©s
 = 
®loc_hw_¡©s
,

1902 #ifdeà
HAVE_ALLOC_RDMA_NETDEV


1903 .
	g®loc_rdma_Ãtdev
 = 
hfi1_®loc_º
,

1905 .
	gg‘_dev_fw_¡r
 = 
hfi1_g‘_dev_fw_¡r
,

1906 .
	gg‘_hw_¡©s
 = 
g‘_hw_¡©s
,

1907 #ifdeà
HAVE_IBDEV_INIT_PORT


1908 .
	gš™_pÜt
 = 
hfi1_ü—‹_pÜt_fžes
,

1910 .
	gmodify_deviû
 = 
modify_deviû
,

1912 #iâdeà
HAVE_NEW_PROCESS_MAD_FUNCTION


1913 .
	g´oûss_mad
 = 
com·t_hfi1_´oûss_mad
,

1915 .
	g´oûss_mad
 = 
hfi1_´oûss_mad
,

1917 #ifdeà
HAVE_RDMA_NETDEV_GET_PARAMS


1918 .
	grdma_Ãtdev_g‘_·¿ms
 = 
hfi1_oib_º_g‘_·¿ms
,

1927 
	$hfi1_»gi¡”_ib_deviû
(
hfi1_devd©a
 *
dd
)

1929 
hfi1_ibdev
 *
dev
 = &
dd
->
v”bs_dev
;

1930 
ib_deviû
 *
ibdev
 = &
dev
->
rdi
.ibdev;

1931 
hfi1_µÜtd©a
 *
µd
 = 
dd
->
µÜt
;

1932 
hfi1_ibpÜt
 *
ibp
 = &
µd
->
ibpÜt_d©a
;

1933 
i
;

1934 
»t
;

1936 
i
 = 0; i < 
dd
->
num_µÜts
; i++)

1937 
	`š™_ibpÜt
(
µd
 + 
i
);

1941 
	`tim”_£tup
(&
dev
->
mem_tim”
, mem_timer, 0);

1943 
	`£qlock_š™
(&
dev
->
iowa™_lock
);

1944 
	`£qlock_š™
(&
dev
->
txwa™_lock
);

1945 
	`INIT_LIST_HEAD
(&
dev
->
txwa™
);

1946 
	`INIT_LIST_HEAD
(&
dev
->
memwa™
);

1948 
»t
 = 
	`v”bs_tx»q_š™
(
dev
);

1949 ià(
»t
)

1950 
”r_v”bs_tx»q
;

1953 
ibdev
->
node_guid
 = 
	`g‘_sguid
(
ibp
, 
HFI1_PORT_GUID_INDEX
);

1960 ià(!
ib_hfi1_sys_image_guid
)

1961 
ib_hfi1_sys_image_guid
 = 
ibdev
->
node_guid
;

1962 #iâdeà
IB_DEVICE_OPS_OWNER


1963 
ibdev
->
owÃr
 = 
THIS_MODULE
;

1965 
ibdev
->
phys_pÜt_út
 = 
dd
->
num_µÜts
;

1966 #ifdeà
NEED_EMBEDDED_DEV


1967 
ibdev
->
dma_deviû
 = &
dd
->
pcidev
->
dev
;

1969 
ibdev
->
dev
.
·»Á
 = &
dd
->
pcidev
->dev;

1971 
	`ib_£t_deviû_Ýs
(
ibdev
, &
hfi1_dev_Ýs
);

1973 
	`¡¾ýy
(
ibdev
->
node_desc
, 
	`š™_ut¢ame
()->
nod’ame
,

1974 (
ibdev
->
node_desc
));

1979 #iâdeà
HAVE_IBDEV_INIT_PORT


1980 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
pÜt_ÿÎback
 = 
hfi1_ü—‹_pÜt_fžes
;

1982 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
g‘_pci_dev
 = get_pci_dev;

1983 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
check_ah
 = 
hfi1_check_ah
;

1984 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
nÙify_Ãw_ah
 = 
hfi1_nÙify_Ãw_ah
;

1985 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
g‘_guid_be
 = 
hfi1_g‘_guid_be
;

1986 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
qu”y_pÜt_¡©e
 = 
qu”y_pÜt
;

1987 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
shut_down_pÜt
 = shut_down_port;

1988 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
ÿp_mask_chg
 = 
hfi1_ÿp_mask_chg
;

1992 
	`hfi1_fžl_deviû_©Œ
(
dd
);

1995 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
qp_bË_size
 = 
hfi1_qp_bË_size
;

1996 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
q²_¡¬t
 = 0;

1997 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
q²_šc
 = 1;

1998 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
qos_shiá
 = dd->qos_shift;

1999 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
q²_»s_¡¬t
 = 
RVT_KDETH_QP_BASE
;

2000 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
q²_»s_’d
 = 
RVT_AIP_QP_MAX
;

2001 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
max_rdma_©omic
 = 
HFI1_MAX_RDMA_ATOMIC
;

2002 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
p¢_mask
 = 
PSN_MASK
;

2003 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
p¢_shiá
 = 
PSN_SHIFT
;

2004 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
p¢_modify_mask
 = 
PSN_MODIFY_MASK
;

2005 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
cÜe_ÿp_æags
 = 
RDMA_CORE_PORT_INTEL_OPA
 |

2006 
RDMA_CORE_CAP_OPA_AH
;

2007 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
max_mad_size
 = 
OPA_MGMT_MAD_SIZE
;

2009 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
qp_´iv_®loc
 = qp_priv_alloc;

2010 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
qp_´iv_š™
 = 
hfi1_qp_´iv_š™
;

2011 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
qp_´iv_ä“
 = qp_priv_free;

2012 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
ä“_®l_qps
 = free_all_qps;

2013 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
nÙify_qp_»£t
 =‚otify_qp_reset;

2014 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
do_£nd
 = 
hfi1_do_£nd_äom_rvt
;

2015 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
scheduË_£nd
 = 
hfi1_scheduË_£nd
;

2016 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
scheduË_£nd_no_lock
 = 
_hfi1_scheduË_£nd
;

2017 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
g‘_pmtu_äom_©Œ
 = get_pmtu_from_attr;

2018 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
nÙify_”rÜ_qp
 =‚otify_error_qp;

2019 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
æush_qp_wa™”s
 = flush_qp_waiters;

2020 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
¡Ý_£nd_queue
 = stop_send_queue;

2021 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
qu›sû_qp
 = quiesce_qp;

2022 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
nÙify_”rÜ_qp
 =‚otify_error_qp;

2023 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
mtu_äom_qp
 = mtu_from_qp;

2024 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
mtu_to_·th_mtu
 = mtu_to_path_mtu;

2025 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
check_modify_qp
 = 
hfi1_check_modify_qp
;

2026 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
modify_qp
 = 
hfi1_modify_qp
;

2027 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
nÙify_»¡¬t_rc
 = 
hfi1_»¡¬t_rc
;

2028 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
£tup_wqe
 = 
hfi1_£tup_wqe
;

2029 
dd
->
v”bs_dev
.
rdi
.
driv”_f
.
comp_veù_ýu_lookup
 =

2030 
hfi1_comp_veù_m­pšgs_lookup
;

2033 
dd
->
v”bs_dev
.
rdi
.
ibdev
.
num_comp_veùÜs
 = dd->
comp_veù_possibË_ýus
;

2034 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
node
 = dd->node;

2037 
dd
->
v”bs_dev
.
rdi
.
æags
 = 0;

2038 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
lkey_bË_size
 = 
hfi1_lkey_bË_size
;

2039 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
ÅÜts
 = dd->
num_µÜts
;

2040 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
Åkeys
 = 
	`hfi1_g‘_Åkeys
(dd);

2041 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
sge_cÝy_mode
 = sge_copy_mode;

2042 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
wss_th»shÞd
 = wss_threshold;

2043 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
wss_þ—n_³riod
 = wss_clean_period;

2044 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
»£rved_Ý”©iÚs
 = 1;

2045 
dd
->
v”bs_dev
.
rdi
.
d·rms
.
exŒa_rdma_©omic
 = 
HFI1_TID_RDMA_WRITE_CNT
;

2048 
dd
->
v”bs_dev
.
rdi
.
po¡_·rms
 = 
hfi1_po¡_·rms
;

2051 
dd
->
v”bs_dev
.
rdi
.
wc_Ýcode
 = 
ib_hfi1_wc_Ýcode
;

2053 
µd
 = 
dd
->
µÜt
;

2054 
i
 = 0; i < 
dd
->
num_µÜts
; i++, 
µd
++)

2055 
	`rvt_š™_pÜt
(&
dd
->
v”bs_dev
.
rdi
,

2056 &
µd
->
ibpÜt_d©a
.
rvp
,

2057 
i
,

2058 
µd
->
pkeys
);

2060 
	`rdma_£t_deviû_sysfs_group
(&
dd
->
v”bs_dev
.
rdi
.
ibdev
,

2061 &
ib_hfi1_©Œ_group
);

2063 
»t
 = 
	`rvt_»gi¡”_deviû
(&
dd
->
v”bs_dev
.
rdi
);

2064 ià(
»t
)

2065 
”r_v”bs_tx»q
;

2067 
»t
 = 
	`hfi1_v”bs_»gi¡”_sysfs
(
dd
);

2068 ià(
»t
)

2069 
”r_þass
;

2071  
»t
;

2073 
”r_þass
:

2074 
	`rvt_uÄegi¡”_deviû
(&
dd
->
v”bs_dev
.
rdi
);

2075 
”r_v”bs_tx»q
:

2076 
	`v”bs_tx»q_ex™
(
dev
);

2077 
	`dd_dev_”r
(
dd
, "ÿÂÙ„egi¡” v”bs: %d!\n", -
»t
);

2078  
»t
;

2079 
	}
}

2081 
	$hfi1_uÄegi¡”_ib_deviû
(
hfi1_devd©a
 *
dd
)

2083 
hfi1_ibdev
 *
dev
 = &
dd
->
v”bs_dev
;

2085 
	`hfi1_v”bs_uÄegi¡”_sysfs
(
dd
);

2087 
	`rvt_uÄegi¡”_deviû
(&
dd
->
v”bs_dev
.
rdi
);

2089 ià(!
	`li¡_em±y
(&
dev
->
txwa™
))

2090 
	`dd_dev_”r
(
dd
, "txwait†ist‚otƒmpty!\n");

2091 ià(!
	`li¡_em±y
(&
dev
->
memwa™
))

2092 
	`dd_dev_”r
(
dd
, "memwait†ist‚otƒmpty!\n");

2094 
	`d–_tim”_sync
(&
dev
->
mem_tim”
);

2095 
	`v”bs_tx»q_ex™
(
dev
);

2096 
	`mu‹x_lock
(&
úŒ_Çmes_lock
);

2097 
	`kä“
(
dev_úŒ_Çmes
);

2098 
	`kä“
(
pÜt_úŒ_Çmes
);

2099 
dev_úŒ_Çmes
 = 
NULL
;

2100 
pÜt_úŒ_Çmes
 = 
NULL
;

2101 
úŒ_Çmes_š™Ÿlized
 = 0;

2102 
	`mu‹x_uÆock
(&
úŒ_Çmes_lock
);

2103 
	}
}

2105 
	$hfi1_úp_rcv
(
hfi1_·ck‘
 *
·ck‘
)

2107 
hfi1_ibpÜt
 *
ibp
 = 
	`rcd_to_Üt
(
·ck‘
->
rcd
);

2108 
hfi1_µÜtd©a
 *
µd
 = 
	`µd_äom_ibp
(
ibp
);

2109 
ib_h—d”
 *
hdr
 = 
·ck‘
->hdr;

2110 
rvt_qp
 *
qp
 = 
·ck‘
->qp;

2111 
u32
 
lq²
, 
rq²
 = 0;

2112 
u16
 
¾id
 = 0;

2113 
u8
 
¦
, 
sc5
, 
svc_ty³
;

2115 
·ck‘
->
qp
->
ibqp
.
qp_ty³
) {

2116 
IB_QPT_UC
:

2117 
¾id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
);

2118 
rq²
 = 
qp
->
»mÙe_q²
;

2119 
svc_ty³
 = 
IB_CC_SVCTYPE_UC
;

2121 
IB_QPT_RC
:

2122 
¾id
 = 
	`rdma_ah_g‘_dlid
(&
qp
->
»mÙe_ah_©Œ
);

2123 
rq²
 = 
qp
->
»mÙe_q²
;

2124 
svc_ty³
 = 
IB_CC_SVCTYPE_RC
;

2126 
IB_QPT_SMI
:

2127 
IB_QPT_GSI
:

2128 
IB_QPT_UD
:

2129 
svc_ty³
 = 
IB_CC_SVCTYPE_UD
;

2132 
ibp
->
rvp
.
n_pkt_drÝs
++;

2136 
sc5
 = 
	`hfi1_9B_g‘_sc5
(
hdr
, 
·ck‘
->
rhf
);

2137 
¦
 = 
ibp
->
sc_to_¦
[
sc5
];

2138 
lq²
 = 
qp
->
ibqp
.
qp_num
;

2140 
	`´oûss_beú
(
µd
, 
¦
, 
¾id
, 
lq²
, 
rq²
, 
svc_ty³
);

2141 
	}
}

2143 
	$hfi1_g‘_v”bs_subÃt_´efix
(
hfi1_devd©a
 *
dd
, 
pÜt
, 
u64
 *
subn
)

2145  
	`ib_g‘_ÿched_subÃt_´efix
(&
dd
->
v”bs_dev
.
rdi
.
ibdev
, 1, 
subn
);

2146 
	}
}

	@verbs.h

48 #iâdeà
HFI1_VERBS_H


49 
	#HFI1_VERBS_H


	)

51 
	~<lšux/ty³s.h
>

52 
	~<lšux/£qlock.h
>

53 
	~<lšux/k”Ãl.h
>

54 
	~<lšux/š‹¼u±.h
>

55 
	~<lšux/k»f.h
>

56 
	~<lšux/wÜkqueue.h
>

57 
	~<lšux/kth»ad.h
>

58 
	~<lšux/com¶‘iÚ.h
>

59 
	~<lšux/¦ab.h
>

60 
	~<rdma/ib_·ck.h
>

61 
	~<rdma/ib_u£r_v”bs.h
>

62 
	~<rdma/ib_mad.h
>

63 
	~<rdma/ib_hdrs.h
>

64 
	~<rdma/rdma_vt.h
>

65 
	~<rdma/rdmavt_qp.h
>

66 
	~<rdma/rdmavt_cq.h
>

68 
	ghfi1_ùxtd©a
;

69 
	ghfi1_µÜtd©a
;

70 
	ghfi1_devd©a
;

71 
	ghfi1_·ck‘
;

73 
	~"iowa™.h
"

74 
	~"tid_rdma.h
"

75 
	~"Ýâ.h
"

76 
	~"commÚ.h
"

78 
	#HFI1_MAX_RDMA_ATOMIC
 16

	)

84 
	#HFI1_UVERBS_ABI_VERSION
 2

	)

87 
	#IB_PMA_SAMPLE_STATUS_DONE
 0x00

	)

88 
	#IB_PMA_SAMPLE_STATUS_STARTED
 0x01

	)

89 
	#IB_PMA_SAMPLE_STATUS_RUNNING
 0x02

	)

92 
	#IB_PMA_PORT_XMIT_DATA
 
	`ýu_to_be16
(0x0001)

	)

93 
	#IB_PMA_PORT_RCV_DATA
 
	`ýu_to_be16
(0x0002)

	)

94 
	#IB_PMA_PORT_XMIT_PKTS
 
	`ýu_to_be16
(0x0003)

	)

95 
	#IB_PMA_PORT_RCV_PKTS
 
	`ýu_to_be16
(0x0004)

	)

96 
	#IB_PMA_PORT_XMIT_WAIT
 
	`ýu_to_be16
(0x0005)

	)

98 
	#HFI1_VENDOR_IPG
 
	`ýu_to_be16
(0xFFA0)

	)

100 
	#IB_DEFAULT_GID_PREFIX
 
	`ýu_to_be64
(0xã80000000000000ULL)

	)

101 
	#OPA_BTH_MIG_REQ
 
	`BIT
(31)

	)

103 
	#RC_OP
(
x
è
IB_OPCODE_RC_
##
	)
x

104 
	#UC_OP
(
x
è
IB_OPCODE_UC_
##
	)
x

108 
	mHFI1_HAS_GRH
 = (1 << 0),

111 
	#LRH_16B_BYTES
 (
	`FIELD_SIZEOF
(
hfi1_16b_h—d”
, 
Ìh
))

	)

112 
	#LRH_16B_DWORDS
 (
LRH_16B_BYTES
 / (
u32
))

	)

113 
	#LRH_9B_BYTES
 (
	`FIELD_SIZEOF
(
ib_h—d”
, 
Ìh
))

	)

114 
	#LRH_9B_DWORDS
 (
LRH_9B_BYTES
 / (
u32
))

	)

117 
	sÝa_16b_mgmt
 {

118 
__be32
 
	mde¡_q²
;

119 
__be32
 
	m¤c_q²
;

122 
	shfi1_16b_h—d”
 {

123 
u32
 
	mÌh
[4];

126 
ib_grh
 
	mgrh
;

127 
ib_Ùh”_h—d”s
 
	mÙh
;

128 } 
	ml
;

129 
ib_Ùh”_h—d”s
 
	mÙh
;

130 
Ýa_16b_mgmt
 
	mmgmt
;

131 } 
	mu
;

132 } 
	g__·cked
;

134 
	shfi1_Ýa_h—d”
 {

136 
ib_h—d”
 
	mibh
;

137 
hfi1_16b_h—d”
 
	mÝah
;

139 
u8
 
	mhdr_ty³
;

140 } 
	g__·cked
;

142 
	shfi1_ahg_šfo
 {

143 
u32
 
	mahgdesc
[2];

144 
u16
 
	mtx_æags
;

145 
u8
 
	mahgcouÁ
;

146 
u8
 
	mahgidx
;

149 
	shfi1_sdma_h—d”
 {

150 
__Ë64
 
	mpbc
;

151 
hfi1_Ýa_h—d”
 
	mhdr
;

152 } 
	g__·cked
;

158 
	shfi1_qp_´iv
 {

159 
hfi1_ahg_šfo
 *
	ms_ahg
;

160 
sdma_’gše
 *
	ms_sde
;

161 
£nd_cÚ‹xt
 *
	ms_£ndcÚ‹xt
;

162 
hfi1_ùxtd©a
 *
	mrcd
;

163 
·ge
 **
	m·ges
;

164 
u32
 
	mtid_’queue
;

165 
u8
 
	ms_sc
;

166 
iowa™
 
	ms_iowa™
;

167 
tim”_li¡
 
	ms_tid_tim”
;

168 
tim”_li¡
 
	ms_tid_»Œy_tim”
;

169 
li¡_h—d
 
	mtid_wa™
;

170 
hfi1_Ýâ_d©a
 
	mÝâ
;

171 
tid_æow_¡©e
 
	mæow_¡©e
;

172 
tid_rdma_qp_·¿ms
 
	mtid_rdma
;

173 
rvt_qp
 *
	mowÃr
;

174 
u16
 
	ms_ruÂšg_pkt_size
;

175 
u8
 
	mhdr_ty³
;

176 
rvt_sge_¡©e
 
	mtid_ss
;

177 
©omic_t
 
	mn_»que¡s
;

179 
©omic_t
 
	mn_tid_»que¡s
;

180 
	mtid_tim”_timeout_jiff›s
;

181 
	mtid_»Œy_timeout_jiff›s
;

183 
u8
 
	ms_¡©e
;

184 
u8
 
	ms_Çk_¡©e
;

185 
u8
 
	ms_»Œy
;

186 
u32
 
	ms_Çk_p¢
;

187 
u32
 
	ms_æags
;

188 
u32
 
	ms_tid_cur
;

189 
u32
 
	ms_tid_h—d
;

190 
u32
 
	ms_tid_ž
;

191 
u32
 
	mr_tid_h—d
;

192 
u32
 
	mr_tid_ž
;

193 
u32
 
	mr_tid_ack
;

194 
u32
 
	mr_tid_®loc
;

195 
u32
 
	m³ndšg_tid_w_£gs
;

196 
u32
 
	m³ndšg_tid_w_»¥
;

197 
u32
 
	m®loc_w_£gs
;

200 
u32
 
	mtid_r_»qs
;

201 
u32
 
	mtid_r_comp
;

202 
u32
 
	m³ndšg_tid_r_£gs
;

203 
u16
 
	mpkts_ps
;

204 
u8
 
	mtimeout_shiá
;

205 
u8
 
	mºr_Çk_¡©e
;

206 
u32
 
	mr_Ãxt_p¢_ib
;

207 
u32
 
	mr_Ãxt_p¢_kd‘h
;

208 
boÞ
 
	msync_±
;

209 
u32
 
	mr_Ãxt_p¢_kd‘h_§ve
;

210 
u32
 
	ms_»sync_p¢
;

211 
boÞ
 
	m»sync
;

214 
	#HFI1_QP_WQE_INVALID
 ((
u32
)-1)

	)

216 
	shfi1_swqe_´iv
 {

217 
tid_rdma_»que¡
 
	mtid_»q
;

218 
u32
 
	mæags
;

219 
rvt_sge_¡©e
 
	mss
;

222 
	shfi1_ack_´iv
 {

223 
rvt_sge_¡©e
 
	mss
;

224 
rvt_sge
 
	msge
;

225 
tid_rdma_»que¡
 
	mtid_»q
;

232 
	giowa™_wÜk
;

233 
	shfi1_pkt_¡©e
 {

234 
hfi1_ibdev
 *
	mdev
;

235 
hfi1_ibpÜt
 *
	mibp
;

236 
hfi1_µÜtd©a
 *
	mµd
;

237 
v”bs_tx»q
 *
	ms_tx»q
;

238 
iowa™_wÜk
 *
	mwa™
;

239 
	mæags
;

240 
	mtimeout
;

241 
	mtimeout_št
;

242 
	mýu
;

243 
u8
 
	mÝcode
;

244 
boÞ
 
	mš_th»ad
;

245 
boÞ
 
	mpkts_£Á
;

248 
	#HFI1_PSN_CREDIT
 16

	)

250 
	shfi1_Ýcode_¡©s
 {

251 
u64
 
	mn_·ck‘s
;

252 
u64
 
	mn_by‹s
;

255 
	shfi1_Ýcode_¡©s_³rùx
 {

256 
hfi1_Ýcode_¡©s
 
	m¡©s
[256];

259 
šlše
 
	$šc_Ý¡©s
(

260 
u32
 
Ž’
,

261 
hfi1_Ýcode_¡©s
 *
¡©s
)

263 #ifdeà
CONFIG_DEBUG_FS


264 
¡©s
->
n_by‹s
 +ð
Ž’
;

265 
¡©s
->
n_·ck‘s
++;

267 
	}
}

269 
	shfi1_ibpÜt
 {

270 
rvt_qp
 
__rcu
 *
	mqp
[2];

271 
rvt_ibpÜt
 
	mrvp
;

274 
u8
 
	m¦_to_sc
[32];

275 
u8
 
	msc_to_¦
[32];

278 
	shfi1_ibdev
 {

279 
rvt_dev_šfo
 
	mrdi
;

283 
£qlock_t
 
txwa™_lock
 
	m____ÿch–še_®igÃd_š_smp
;

284 
li¡_h—d
 
	mtxwa™
;

285 
li¡_h—d
 
	mmemwa™
;

286 
kmem_ÿche
 *
	mv”bs_tx»q_ÿche
;

287 
u64
 
	mn_txwa™
;

288 
u64
 
	mn_kmem_wa™
;

289 
u64
 
	mn_tidwa™
;

292 
£qlock_t
 
iowa™_lock
 
	m____ÿch–še_®igÃd_š_smp
;

293 
u64
 
	mn_piowa™
;

294 
u64
 
	mn_piod¿š
;

295 
tim”_li¡
 
	mmem_tim”
;

297 #ifdeà
CONFIG_DEBUG_FS


299 
d’Œy
 *
	mhfi1_ibdev_dbg
;

301 
d’Œy
 *
	mhfi1_ibdev_lšk
;

302 #ifdeà
CONFIG_FAULT_INJECTION


303 
çuÉ
 *
	mçuÉ
;

308 
šlše
 
hfi1_ibdev
 *
	$to_idev
(
ib_deviû
 *
ibdev
)

310 
rvt_dev_šfo
 *
rdi
;

312 
rdi
 = 
	`cÚš”_of
(
ibdev
, 
rvt_dev_šfo
, ibdev);

313  
	`cÚš”_of
(
rdi
, 
hfi1_ibdev
,„di);

314 
	}
}

316 
šlše
 
rvt_qp
 *
	$iowa™_to_qp
(
iowa™
 *
s_iowa™
)

318 
hfi1_qp_´iv
 *
´iv
;

320 
´iv
 = 
	`cÚš”_of
(
s_iowa™
, 
hfi1_qp_´iv
, s_iowait);

321  
´iv
->
owÃr
;

322 
	}
}

327 
hfi1_bad_pkey
(
hfi1_ibpÜt
 *
ibp
, 
u32
 
key
, u32 
¦
,

328 
u32
 
qp1
, u32 
qp2
, u32 
lid1
, u32 
lid2
);

329 
hfi1_ÿp_mask_chg
(
rvt_dev_šfo
 *
rdi
, 
u8
 
pÜt_num
);

330 
hfi1_sys_guid_chg
(
hfi1_ibpÜt
 *
ibp
);

331 
hfi1_node_desc_chg
(
hfi1_ibpÜt
 *
ibp
);

332 #iâdeà
HAVE_NEW_PROCESS_MAD_FUNCTION


333 
com·t_hfi1_´oûss_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
, 
u8
 
pÜt
,

334 cÚ¡ 
ib_wc
 *
š_wc
,

335 cÚ¡ 
ib_grh
 *
š_grh
,

336 cÚ¡ 
ib_mad_hdr
 *
š_mad
,

337 
size_t
 
š_mad_size
, 
ib_mad_hdr
 *
out_mad
,

338 
size_t
 *
out_mad_size
, 
u16
 *
out_mad_pkey_šdex
);

340 
hfi1_´oûss_mad
(
ib_deviû
 *
ibdev
, 
mad_æags
, 
u8
 
pÜt
,

341 cÚ¡ 
ib_wc
 *
š_wc
, cÚ¡ 
ib_grh
 *
š_grh
,

342 cÚ¡ 
ib_mad
 *
š_mad
, ib_mad *
out_mad
,

343 
size_t
 *
out_mad_size
, 
u16
 *
out_mad_pkey_šdex
);

356 
	#PSN_MASK
 0x7FFFFFFF

	)

357 
	#PSN_SHIFT
 1

	)

358 
	#PSN_MODIFY_MASK
 0xFFFFFF

	)

364 
šlše
 
	$cmp_p¢
(
u32
 
a
, u32 
b
)

366  ((()
a
è- (()
b
)è<< 
PSN_SHIFT
;

367 
	}
}

372 
šlše
 
u32
 
	$mask_p¢
(
u32
 
a
)

374  
a
 & 
PSN_MASK
;

375 
	}
}

380 
šlše
 
u32
 
	$d–_p¢
(
u32
 
a
, u32 
b
)

382  ((()
a
 - ()
b
è<< 
PSN_SHIFT
) >> PSN_SHIFT;

383 
	}
}

385 
šlše
 
tid_rdma_»que¡
 *
	$wqe_to_tid_»q
(
rvt_swqe
 *
wqe
)

387  &((
hfi1_swqe_´iv
 *)
wqe
->
´iv
)->
tid_»q
;

388 
	}
}

390 
šlše
 
tid_rdma_»que¡
 *
	$ack_to_tid_»q
(
rvt_ack_’Œy
 *
e
)

392  &((
hfi1_ack_´iv
 *)
e
->
´iv
)->
tid_»q
;

393 
	}
}

399 
šlše
 
u32
 
	$__fuÎ_æow_p¢
(
æow_¡©e
 *
¡©e
, 
u32
 
p¢
)

401  
	`mask_p¢
((
¡©e
->
g’”©iÚ
 << 
HFI1_KDETH_BTH_SEQ_SHIFT
) |

402 (
p¢
 & 
HFI1_KDETH_BTH_SEQ_MASK
));

403 
	}
}

405 
šlše
 
u32
 
	$fuÎ_æow_p¢
(
tid_rdma_æow
 *
æow
, 
u32
 
p¢
)

407  
	`__fuÎ_æow_p¢
(&
æow
->
æow_¡©e
, 
p¢
);

408 
	}
}

410 
	gv”bs_tx»q
;

411 
hfi1_put_tx»q
(
v”bs_tx»q
 *
tx
);

413 
hfi1_v”bs_£nd
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

415 
hfi1_úp_rcv
(
hfi1_·ck‘
 *
·ck‘
);

417 
hfi1_uc_rcv
(
hfi1_·ck‘
 *
·ck‘
);

419 
hfi1_rc_rcv
(
hfi1_·ck‘
 *
·ck‘
);

421 
hfi1_rc_hd»¼
(

422 
hfi1_ùxtd©a
 *
rcd
,

423 
hfi1_·ck‘
 *
·ck‘
,

424 
rvt_qp
 *
qp
);

426 
u8
 
ah_to_sc
(
ib_deviû
 *
ibdev
, 
rdma_ah_©Œ
 *
ah_©Œ
);

428 
hfi1_rc_v”bs_abÜ‹d
(
rvt_qp
 *
qp
, 
hfi1_Ýa_h—d”
 *
Ýah
);

429 
hfi1_rc_£nd_com¶‘e
(
rvt_qp
 *
qp
, 
hfi1_Ýa_h—d”
 *
Ýah
);

431 
hfi1_ud_rcv
(
hfi1_·ck‘
 *
·ck‘
);

433 
hfi1_lookup_pkey_idx
(
hfi1_ibpÜt
 *
ibp
, 
u16
 
pkey
);

435 
hfi1_mig¿‹_qp
(
rvt_qp
 *
qp
);

437 
hfi1_check_modify_qp
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
,

438 
©Œ_mask
, 
ib_ud©a
 *
ud©a
);

440 
hfi1_modify_qp
(
rvt_qp
 *
qp
, 
ib_qp_©Œ
 *
©Œ
,

441 
©Œ_mask
, 
ib_ud©a
 *
ud©a
);

442 
hfi1_»¡¬t_rc
(
rvt_qp
 *
qp
, 
u32
 
p¢
, 
wa™
);

443 
hfi1_£tup_wqe
(
rvt_qp
 *
qp
, 
rvt_swqe
 *
wqe
,

444 
boÞ
 *
ÿÎ_£nd
);

446 cÚ¡ 
u32
 
rc_Úly_Ýcode
;

447 cÚ¡ 
u32
 
uc_Úly_Ýcode
;

449 
hfi1_ruc_check_hdr
(
hfi1_ibpÜt
 *
ibp
, 
hfi1_·ck‘
 *
·ck‘
);

451 
u32
 
hfi1_make_grh
(
hfi1_ibpÜt
 *
ibp
, 
ib_grh
 *
hdr
,

452 cÚ¡ 
ib_glob®_rou‹
 *
grh
, 
u32
 
hwÜds
, u32 
nwÜds
);

454 
hfi1_make_ruc_h—d”
(
rvt_qp
 *
qp
, 
ib_Ùh”_h—d”s
 *
ohdr
,

455 
u32
 
bth0
, u32 
bth1
, u32 
bth2
, 
middË
,

456 
hfi1_pkt_¡©e
 *
ps
);

458 
boÞ
 
hfi1_scheduË_£nd_y›ld
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

459 
boÞ
 
tid
);

461 
_hfi1_do_£nd
(
wÜk_¡ruù
 *
wÜk
);

463 
hfi1_do_£nd_äom_rvt
(
rvt_qp
 *
qp
);

465 
hfi1_do_£nd
(
rvt_qp
 *
qp
, 
boÞ
 
š_th»ad
);

467 
hfi1_£nd_rc_ack
(
hfi1_·ck‘
 *
·ck‘
, 
boÞ
 
is_ãú
);

469 
hfi1_make_rc_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

471 
hfi1_make_uc_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

473 
hfi1_make_ud_»q
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
);

475 
hfi1_»gi¡”_ib_deviû
(
hfi1_devd©a
 *);

477 
hfi1_uÄegi¡”_ib_deviû
(
hfi1_devd©a
 *);

479 
hfi1_kd‘h_—g”_rcv
(
hfi1_·ck‘
 *
·ck‘
);

481 
hfi1_kd‘h_ex³ùed_rcv
(
hfi1_·ck‘
 *
·ck‘
);

483 
hfi1_ib_rcv
(
hfi1_·ck‘
 *
·ck‘
);

485 
hfi1_16B_rcv
(
hfi1_·ck‘
 *
·ck‘
);

487 
hfi1_g‘_Åkeys
(
hfi1_devd©a
 *);

489 
hfi1_v”bs_£nd_dma
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

490 
u64
 
pbc
);

492 
hfi1_v”bs_£nd_pio
(
rvt_qp
 *
qp
, 
hfi1_pkt_¡©e
 *
ps
,

493 
u64
 
pbc
);

495 
hfi1_wa™_kmem
(
rvt_qp
 *
qp
);

496 
hfi1_g‘_v”bs_subÃt_´efix
(
hfi1_devd©a
 *
dd
, 
pÜt
, 
u64
 *
subn
);

498 
šlše
 
boÞ
 
	$Ýa_bth_is_mig¿tiÚ
(
ib_Ùh”_h—d”s
 *
ohdr
)

500  !!(
ohdr
->
bth
[1] & 
	`ýu_to_be32
(
OPA_BTH_MIG_REQ
));

501 
	}
}

503 
šlše
 
	$hfi1_Œdma_£nd_com¶‘e
(
rvt_qp
 *
qp
,

504 
rvt_swqe
 *
wqe
,

505 
ib_wc_¡©us
 
¡©us
)

507 
	`Œdma_þ—n_swqe
(
qp
, 
wqe
);

508 
	`rvt_£nd_com¶‘e
(
qp
, 
wqe
, 
¡©us
);

509 
	}
}

511 cÚ¡ 
ib_wc_Ýcode
 
ib_hfi1_wc_Ýcode
[];

513 cÚ¡ 
u8
 
hdr_Ën_by_Ýcode
[];

515 cÚ¡ 
ib_rvt_¡©e_Ýs
[];

517 
__be64
 
ib_hfi1_sys_image_guid
;

519 
hfi1_max_cqes
;

521 
hfi1_max_cqs
;

523 
hfi1_max_qp_wrs
;

525 
hfi1_max_qps
;

527 
hfi1_max_sges
;

529 
hfi1_max_mÿ¡_g½s
;

531 
hfi1_max_mÿ¡_qp_©ched
;

533 
hfi1_max_¤qs
;

535 
hfi1_max_¤q_sges
;

537 
hfi1_max_¤q_wrs
;

539 
piÙh»shÞd
;

541 cÚ¡ 
u32
 
ib_hfi1_ºr_bË
[];

	@verbs_txreq.c

48 
	~"hfi.h
"

49 
	~"v”bs_tx»q.h
"

50 
	~"qp.h
"

51 
	~"Œaû.h
"

53 
	#TXREQ_LEN
 24

	)

55 
	$hfi1_put_tx»q
(
v”bs_tx»q
 *
tx
)

57 
hfi1_ibdev
 *
dev
;

58 
rvt_qp
 *
qp
;

59 
æags
;

60 
£q
;

61 
hfi1_qp_´iv
 *
´iv
;

63 
qp
 = 
tx
->qp;

64 
dev
 = 
	`to_idev
(
qp
->
ibqp
.
deviû
);

66 ià(
tx
->
mr
)

67 
	`rvt_put_mr
(
tx
->
mr
);

69 
	`sdma_txþ—n
(
	`dd_äom_dev
(
dev
), &
tx
->
tx»q
);

72 
	`kmem_ÿche_ä“
(
dev
->
v”bs_tx»q_ÿche
, 
tx
);

75 
£q
 = 
	`»ad_£qbegš
(&
dev
->
txwa™_lock
);

76 ià(!
	`li¡_em±y
(&
dev
->
txwa™
)) {

77 
iowa™
 *
wa™
;

79 
	`wr™e_£qlock_œq§ve
(&
dev
->
txwa™_lock
, 
æags
);

80 
wa™
 = 
	`li¡_fœ¡_’Œy
(&
dev
->
txwa™
, 
iowa™
,

81 
li¡
);

82 
qp
 = 
	`iowa™_to_qp
(
wa™
);

83 
´iv
 = 
qp
->priv;

84 
	`li¡_d–_š™
(&
´iv
->
s_iowa™
.
li¡
);

86 
	`wr™e_£quÆock_œq»¡Üe
(&
dev
->
txwa™_lock
, 
æags
);

87 
	`hfi1_qp_wakeup
(
qp
, 
RVT_S_WAIT_TX
);

90 } 
	`»ad_£q»Œy
(&
dev
->
txwa™_lock
, 
£q
));

91 
	}
}

93 
v”bs_tx»q
 *
	$__g‘_tx»q
(
hfi1_ibdev
 *
dev
,

94 
rvt_qp
 *
qp
)

95 
	`__mu¡_hÞd
(&
qp
->
s_lock
)

97 
v”bs_tx»q
 *
tx
 = 
NULL
;

99 
	`wr™e_£qlock
(&
dev
->
txwa™_lock
);

100 ià(
ib_rvt_¡©e_Ýs
[
qp
->
¡©e
] & 
RVT_PROCESS_RECV_OK
) {

101 
hfi1_qp_´iv
 *
´iv
;

103 
tx
 = 
	`kmem_ÿche_®loc
(
dev
->
v”bs_tx»q_ÿche
, 
VERBS_TXREQ_GFP
);

104 ià(
tx
)

105 
out
;

106 
´iv
 = 
qp
->priv;

107 ià(
	`li¡_em±y
(&
´iv
->
s_iowa™
.
li¡
)) {

108 
dev
->
n_txwa™
++;

109 
qp
->
s_æags
 |ð
RVT_S_WAIT_TX
;

110 
	`li¡_add_ž
(&
´iv
->
s_iowa™
.
li¡
, &
dev
->
txwa™
);

111 
´iv
->
s_iowa™
.
lock
 = &
dev
->
txwa™_lock
;

112 
	`Œaû_hfi1_qp¦“p
(
qp
, 
RVT_S_WAIT_TX
);

113 
	`rvt_g‘_qp
(
qp
);

115 
qp
->
s_æags
 &ð~
RVT_S_BUSY
;

117 
out
:

118 
	`wr™e_£quÆock
(&
dev
->
txwa™_lock
);

119  
tx
;

120 
	}
}

122 
	$v”bs_tx»q_š™
(
hfi1_ibdev
 *
dev
)

124 
buf
[
TXREQ_LEN
];

125 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_dev
(
dev
);

127 
	`¢´štf
(
buf
, (buf), "hfi1_%u_vtx»q_ÿche", 
dd
->
un™
);

128 
dev
->
v”bs_tx»q_ÿche
 = 
	`kmem_ÿche_ü—‹
(
buf
,

129 (
v”bs_tx»q
),

130 0, 
SLAB_HWCACHE_ALIGN
,

131 
NULL
);

132 ià(!
dev
->
v”bs_tx»q_ÿche
)

133  -
ENOMEM
;

135 
	}
}

137 
	$v”bs_tx»q_ex™
(
hfi1_ibdev
 *
dev
)

139 
	`kmem_ÿche_de¡roy
(
dev
->
v”bs_tx»q_ÿche
);

140 
dev
->
v”bs_tx»q_ÿche
 = 
NULL
;

141 
	}
}

	@verbs_txreq.h

48 #iâdeà
HFI1_VERBS_TXREQ_H


49 
	#HFI1_VERBS_TXREQ_H


	)

51 
	~<lšux/ty³s.h
>

52 
	~<lšux/¦ab.h
>

54 
	~"v”bs.h
"

55 
	~"sdma_tx»q.h
"

56 
	~"iowa™.h
"

58 
	sv”bs_tx»q
 {

59 
hfi1_sdma_h—d”
 
	mphdr
;

60 
sdma_tx»q
 
	mtx»q
;

61 
rvt_qp
 *
	mqp
;

62 
rvt_swqe
 *
	mwqe
;

63 
rvt_m»giÚ
 *
	mmr
;

64 
rvt_sge_¡©e
 *
	mss
;

65 
sdma_’gše
 *
	msde
;

66 
£nd_cÚ‹xt
 *
	mpsc
;

67 
u16
 
	mhdr_dwÜds
;

68 
u16
 
	ms_cur_size
;

71 
	ghfi1_ibdev
;

72 
v”bs_tx»q
 *
__g‘_tx»q
(
hfi1_ibdev
 *
dev
,

73 
rvt_qp
 *
qp
);

75 
	#VERBS_TXREQ_GFP
 (
GFP_ATOMIC
 | 
__GFP_NOWARN
)

	)

76 
šlše
 
v”bs_tx»q
 *
	$g‘_tx»q
(
hfi1_ibdev
 *
dev
,

77 
rvt_qp
 *
qp
)

78 
	`__mu¡_hÞd
(&
qp
->
¦ock
)

80 
v”bs_tx»q
 *
tx
;

81 
hfi1_qp_´iv
 *
´iv
 = 
qp
->priv;

83 
tx
 = 
	`kmem_ÿche_®loc
(
dev
->
v”bs_tx»q_ÿche
, 
VERBS_TXREQ_GFP
);

84 ià(
	`uÆik–y
(!
tx
)) {

86 
tx
 = 
	`__g‘_tx»q
(
dev
, 
qp
);

87 ià(!
tx
)

88  
tx
;

90 
tx
->
qp
 = qp;

91 
tx
->
mr
 = 
NULL
;

92 
tx
->
sde
 = 
´iv
->
s_sde
;

93 
tx
->
psc
 = 
´iv
->
s_£ndcÚ‹xt
;

95 
tx
->
tx»q
.
num_desc
 = 0;

97 
tx
->
phdr
.
hdr
.
hdr_ty³
 = 
´iv
->hdr_type;

98 
tx
->
tx»q
.
æags
 = 0;

99  
tx
;

100 
	}
}

102 
šlše
 
sdma_tx»q
 *
	$g‘_sdma_tx»q
(
v”bs_tx»q
 *
tx
)

104  &
tx
->
tx»q
;

105 
	}
}

107 
šlše
 
v”bs_tx»q
 *
	$g‘_wa™šg_v”bs_tx»q
(
iowa™_wÜk
 *
w
)

109 
sdma_tx»q
 *
¡x
;

111 
¡x
 = 
	`iowa™_g‘_txh—d
(
w
);

112 ià(
¡x
)

113  
	`cÚš”_of
(
¡x
, 
v”bs_tx»q
, 
tx»q
);

114  
NULL
;

115 
	}
}

117 
šlše
 
boÞ
 
	$v”bs_tx»q_queued
(
iowa™_wÜk
 *
w
)

119  
	`iowa™_·ck‘_queued
(
w
);

120 
	}
}

122 
hfi1_put_tx»q
(
v”bs_tx»q
 *
tx
);

123 
v”bs_tx»q_š™
(
hfi1_ibdev
 *
dev
);

124 
v”bs_tx»q_ex™
(
hfi1_ibdev
 *
dev
);

	@vnic.h

1 #iâdeà
_HFI1_VNIC_H


2 
	#_HFI1_VNIC_H


	)

50 
	~<rdma/Ýa_vnic.h
>

51 
	~"hfi.h
"

52 
	~"sdma.h
"

54 
	#HFI1_VNIC_MAX_TXQ
 16

	)

55 
	#HFI1_VNIC_MAX_PAD
 12

	)

58 
	#HFI1_VNIC_L4_HDR_OFFSET
 
OPA_VNIC_L2_HDR_LEN


	)

60 
	#HFI1_VNIC_GET_L4_HDR
(
d©a
) \

61 (*((
u16
 *)((
u8
 *)(
d©a
è+ 
HFI1_VNIC_L4_HDR_OFFSET
)))

	)

63 
	#HFI1_VNIC_GET_VESWID
(
d©a
) \

64 (
	`HFI1_VNIC_GET_L4_HDR
(
d©a
è& 0xFFF)

	)

67 
	#HFI1_VNIC_SC_OFFSET_LOW
 6

	)

68 
	#HFI1_VNIC_SC_OFFSET_HI
 7

	)

69 
	#HFI1_VNIC_SC_SHIFT
 4

	)

71 
	#HFI1_VNIC_MAX_QUEUE
 16

	)

72 
	#HFI1_NUM_VNIC_CTXT
 8

	)

84 
	shfi1_vnic_sdma
 {

85 
hfi1_devd©a
 *
	mdd
;

86 
sdma_’gše
 *
	msde
;

87 
hfi1_vnic_vpÜt_šfo
 *
	mvšfo
;

88 
iowa™
 
	mwa™
;

89 
sdma_tx»q
 
	m¡x
;

90 
	m¡©e
;

91 
u8
 
	mq_idx
;

92 
boÞ
 
	mpkts_£Á
;

103 
	shfi1_vnic_rx_queue
 {

104 
u8
 
	midx
;

105 
hfi1_vnic_vpÜt_šfo
 *
	mvšfo
;

106 
Ãt_deviû
 *
	mÃtdev
;

107 
Çpi_¡ruù
 
	mÇpi
;

123 
	shfi1_vnic_vpÜt_šfo
 {

124 
hfi1_devd©a
 *
	mdd
;

125 
Ãt_deviû
 *
	mÃtdev
;

126 
	mæags
;

129 
mu‹x
 
	mlock
;

131 
u8
 
	mnum_tx_q
;

132 
u8
 
	mnum_rx_q
;

133 
u16
 
	mvesw_id
;

134 
hfi1_vnic_rx_queue
 
	mrxq
[
HFI1_NUM_VNIC_CTXT
];

136 
Ýa_vnic_¡©s
 
	m¡©s
[
HFI1_VNIC_MAX_QUEUE
];

137 
hfi1_vnic_sdma
 
	msdma
[
HFI1_VNIC_MAX_TXQ
];

140 
	#v_dbg
(
fÜm©
, 
¬g
...) \

141 
	`Ãtdev_dbg
(
všfo
->
Ãtdev
, 
fÜm©
, ## 
¬g
)

	)

142 
	#v_”r
(
fÜm©
, 
¬g
...) \

143 
	`Ãtdev_”r
(
všfo
->
Ãtdev
, 
fÜm©
, ## 
¬g
)

	)

144 
	#v_šfo
(
fÜm©
, 
¬g
...) \

145 
	`Ãtdev_šfo
(
všfo
->
Ãtdev
, 
fÜm©
, ## 
¬g
)

	)

148 
hfi1_vnic_£tup
(
hfi1_devd©a
 *
dd
);

149 
hfi1_vnic_tx»q_š™
(
hfi1_devd©a
 *
dd
);

150 
hfi1_vnic_tx»q_deš™
(
hfi1_devd©a
 *
dd
);

152 
hfi1_vnic_by·ss_rcv
(
hfi1_·ck‘
 *
·ck‘
);

153 
hfi1_vnic_sdma_š™
(
hfi1_vnic_vpÜt_šfo
 *
všfo
);

154 
boÞ
 
hfi1_vnic_sdma_wr™e_avaž
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

155 
u8
 
q_idx
);

158 
Ãt_deviû
 *
hfi1_vnic_®loc_º
(
ib_deviû
 *
deviû
,

159 
u8
 
pÜt_num
,

160 
rdma_Ãtdev_t
 
ty³
,

161 cÚ¡ *
Çme
,

162 
Çme_assign_ty³
,

163 (*
£tup
)(
Ãt_deviû
 *));

164 
	`hfi1_vnic_£nd_dma
(
hfi1_devd©a
 *
dd
, 
u8
 
q_idx
,

165 
hfi1_vnic_vpÜt_šfo
 *
všfo
,

166 
sk_buff
 *
skb
, 
u64
 
pbc
, 
u8
 
¶’
);

	@vnic_main.c

52 
	~<lšux/io.h
>

53 
	~<lšux/if_vÏn.h
>

55 
	~"vnic.h
"

56 
	~"Ãtdev.h
"

58 
	#HFI_TX_TIMEOUT_MS
 1000

	)

60 
	#HFI1_VNIC_RCV_Q_SIZE
 1024

	)

62 
	#HFI1_VNIC_UP
 0

	)

64 
DEFINE_SPINLOCK
(
vpÜt_úŒ_lock
);

66 
	#SUM_GRP_COUNTERS
(
¡©s
, 
q¡©s
, 
x_g½
) do { \

67 
u64
 *
¤c64
, *
d¡64
; \

68 
¤c64
 = &
q¡©s
->
x_g½
.
uniÿ¡
, \

69 
d¡64
 = &
¡©s
->
x_g½
.
uniÿ¡
; \

70 
d¡64
 <ð&
¡©s
->
x_g½
.
s_1519_max
;) { \

71 *
d¡64
++ +ð*
¤c64
++; \

73 } 0)

	)

75 
	#VNIC_MASK
 (0xFF)

	)

76 
	#VNIC_ID
(
v®
è((1uÎ << 24è| ((v®è& 
VNIC_MASK
))

	)

79 
	$hfi1_vnic_upd©e_¡©s
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

80 
Ýa_vnic_¡©s
 *
¡©s
)

82 
Ãt_deviû
 *
Ãtdev
 = 
všfo
->netdev;

83 
u8
 
i
;

86 
i
 = 0; i < 
všfo
->
num_tx_q
; i++) {

87 
Ýa_vnic_¡©s
 *
q¡©s
 = &
všfo
->
¡©s
[
i
];

88 
¹Æ_lšk_¡©s64
 *
qn¡©s
 = &
všfo
->
¡©s
[
i
].
Ãt¡©s
;

90 
¡©s
->
Ãt¡©s
.
tx_fifo_”rÜs
 +ð
qn¡©s
->tx_fifo_errors;

91 
¡©s
->
Ãt¡©s
.
tx_ÿ¼›r_”rÜs
 +ð
qn¡©s
->tx_carrier_errors;

92 
¡©s
->
tx_drÝ_¡©e
 +ð
q¡©s
->tx_drop_state;

93 
¡©s
->
tx_dlid_z”o
 +ð
q¡©s
->tx_dlid_zero;

95 
	`SUM_GRP_COUNTERS
(
¡©s
, 
q¡©s
, 
tx_g½
);

96 
¡©s
->
Ãt¡©s
.
tx_·ck‘s
 +ð
qn¡©s
->tx_packets;

97 
¡©s
->
Ãt¡©s
.
tx_by‹s
 +ð
qn¡©s
->tx_bytes;

101 
i
 = 0; i < 
všfo
->
num_rx_q
; i++) {

102 
Ýa_vnic_¡©s
 *
q¡©s
 = &
všfo
->
¡©s
[
i
];

103 
¹Æ_lšk_¡©s64
 *
qn¡©s
 = &
všfo
->
¡©s
[
i
].
Ãt¡©s
;

105 
¡©s
->
Ãt¡©s
.
rx_fifo_”rÜs
 +ð
qn¡©s
->rx_fifo_errors;

106 
¡©s
->
Ãt¡©s
.
rx_nohªdËr
 +ð
qn¡©s
->rx_nohandler;

107 
¡©s
->
rx_drÝ_¡©e
 +ð
q¡©s
->rx_drop_state;

108 
¡©s
->
rx_ov”size
 +ð
q¡©s
->rx_oversize;

109 
¡©s
->
rx_ruÁ
 +ð
q¡©s
->rx_runt;

111 
	`SUM_GRP_COUNTERS
(
¡©s
, 
q¡©s
, 
rx_g½
);

112 
¡©s
->
Ãt¡©s
.
rx_·ck‘s
 +ð
qn¡©s
->rx_packets;

113 
¡©s
->
Ãt¡©s
.
rx_by‹s
 +ð
qn¡©s
->rx_bytes;

116 
¡©s
->
Ãt¡©s
.
tx_”rÜs
 = sts->Ãt¡©s.
tx_fifo_”rÜs
 +

117 
¡©s
->
Ãt¡©s
.
tx_ÿ¼›r_”rÜs
 +

118 
¡©s
->
tx_drÝ_¡©e
 + sts->
tx_dlid_z”o
;

119 
¡©s
->
Ãt¡©s
.
tx_drÝ³d
 = sts->Ãt¡©s.
tx_”rÜs
;

121 
¡©s
->
Ãt¡©s
.
rx_”rÜs
 = sts->Ãt¡©s.
rx_fifo_”rÜs
 +

122 
¡©s
->
Ãt¡©s
.
rx_nohªdËr
 +

123 
¡©s
->
rx_drÝ_¡©e
 + sts->
rx_ov”size
 +

124 
¡©s
->
rx_ruÁ
;

125 
¡©s
->
Ãt¡©s
.
rx_drÝ³d
 = sts->Ãt¡©s.
rx_”rÜs
;

127 
Ãtdev
->
¡©s
.
tx_·ck‘s
 = sts->
Ãt¡©s
.tx_packets;

128 
Ãtdev
->
¡©s
.
tx_by‹s
 = sts->
Ãt¡©s
.tx_bytes;

129 
Ãtdev
->
¡©s
.
tx_fifo_”rÜs
 = sts->
Ãt¡©s
.tx_fifo_errors;

130 
Ãtdev
->
¡©s
.
tx_ÿ¼›r_”rÜs
 = sts->
Ãt¡©s
.tx_carrier_errors;

131 
Ãtdev
->
¡©s
.
tx_”rÜs
 = sts->
Ãt¡©s
.tx_errors;

132 
Ãtdev
->
¡©s
.
tx_drÝ³d
 = sts->
Ãt¡©s
.tx_dropped;

134 
Ãtdev
->
¡©s
.
rx_·ck‘s
 = sts->
Ãt¡©s
.rx_packets;

135 
Ãtdev
->
¡©s
.
rx_by‹s
 = sts->
Ãt¡©s
.rx_bytes;

136 
Ãtdev
->
¡©s
.
rx_fifo_”rÜs
 = sts->
Ãt¡©s
.rx_fifo_errors;

137 
Ãtdev
->
¡©s
.
muÉiÿ¡
 = sts->
rx_g½
.
mÿ¡bÿ¡
;

138 
Ãtdev
->
¡©s
.
rx_Ëngth_”rÜs
 = sts->
rx_ov”size
 + sts->
rx_ruÁ
;

139 
Ãtdev
->
¡©s
.
rx_”rÜs
 = sts->
Ãt¡©s
.rx_errors;

140 
Ãtdev
->
¡©s
.
rx_drÝ³d
 = sts->
Ãt¡©s
.rx_dropped;

141 
	}
}

144 
šlše
 
	$upd©e_Ën_couÁ”s
(
Ýa_vnic_g½_¡©s
 *
g½
,

145 
Ën
)

148 ià(
Ën
 >= 1515)

149 
g½
->
s_1519_max
++;

150 ià(
Ën
 >= 1020)

151 
g½
->
s_1024_1518
++;

152 ià(
Ën
 >= 508)

153 
g½
->
s_512_1023
++;

154 ià(
Ën
 >= 252)

155 
g½
->
s_256_511
++;

156 ià(
Ën
 >= 124)

157 
g½
->
s_128_255
++;

158 ià(
Ën
 >= 61)

159 
g½
->
s_65_127
++;

161 
g½
->
s_64
++;

162 
	}
}

165 
	$hfi1_vnic_upd©e_tx_couÁ”s
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

166 
u8
 
q_idx
, 
sk_buff
 *
skb
, 
”r
)

168 
‘hhdr
 *
mac_hdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

169 
Ýa_vnic_¡©s
 *
¡©s
 = &
všfo
->¡©s[
q_idx
];

170 
Ýa_vnic_g½_¡©s
 *
tx_g½
 = &
¡©s
->tx_grp;

171 
u16
 
vÏn_tci
;

173 
¡©s
->
Ãt¡©s
.
tx_·ck‘s
++;

174 
¡©s
->
Ãt¡©s
.
tx_by‹s
 +ð
skb
->
Ën
 + 
ETH_FCS_LEN
;

176 
	`upd©e_Ën_couÁ”s
(
tx_g½
, 
skb
->
Ën
);

179 ià(
	`uÆik–y
(
”r
))

182 ià(
	`is_muÉiÿ¡_‘h”_addr
(
mac_hdr
->
h_de¡
))

183 
tx_g½
->
mÿ¡bÿ¡
++;

185 
tx_g½
->
uniÿ¡
++;

187 ià(!
	`__vÏn_g‘_g
(
skb
, &
vÏn_tci
))

188 
tx_g½
->
vÏn
++;

190 
tx_g½
->
uÁagged
++;

191 
	}
}

194 
	$hfi1_vnic_upd©e_rx_couÁ”s
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

195 
u8
 
q_idx
, 
sk_buff
 *
skb
, 
”r
)

197 
‘hhdr
 *
mac_hdr
 = (‘hhd¸*)
skb
->
d©a
;

198 
Ýa_vnic_¡©s
 *
¡©s
 = &
všfo
->¡©s[
q_idx
];

199 
Ýa_vnic_g½_¡©s
 *
rx_g½
 = &
¡©s
->rx_grp;

200 
u16
 
vÏn_tci
;

202 
¡©s
->
Ãt¡©s
.
rx_·ck‘s
++;

203 
¡©s
->
Ãt¡©s
.
rx_by‹s
 +ð
skb
->
Ën
 + 
ETH_FCS_LEN
;

205 
	`upd©e_Ën_couÁ”s
(
rx_g½
, 
skb
->
Ën
);

208 ià(
	`uÆik–y
(
”r
))

211 ià(
	`is_muÉiÿ¡_‘h”_addr
(
mac_hdr
->
h_de¡
))

212 
rx_g½
->
mÿ¡bÿ¡
++;

214 
rx_g½
->
uniÿ¡
++;

216 ià(!
	`__vÏn_g‘_g
(
skb
, &
vÏn_tci
))

217 
rx_g½
->
vÏn
++;

219 
rx_g½
->
uÁagged
++;

220 
	}
}

223 
	$hfi1_vnic_g‘_¡©s64
(
Ãt_deviû
 *
Ãtdev
,

224 
¹Æ_lšk_¡©s64
 *
¡©s
)

226 
Ýa_vnic_¡©s
 *
v¡©s
 = (Ýa_vnic_¡© *)
¡©s
;

227 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

229 
	`hfi1_vnic_upd©e_¡©s
(
všfo
, 
v¡©s
);

230 
	}
}

232 
u64
 
	$ü—‹_by·ss_pbc
(
u32
 
vl
, u32 
dw_Ën
)

234 
u64
 
pbc
;

236 
pbc
 = ((
u64
)
PBC_IHCRC_NONE
 << 
PBC_INSERT_HCRC_SHIFT
)

237 | 
PBC_INSERT_BYPASS_ICRC
 | 
PBC_CREDIT_RETURN


238 | 
PBC_PACKET_BYPASS


239 | ((
vl
 & 
PBC_VL_MASK
è<< 
PBC_VL_SHIFT
)

240 | (
dw_Ën
 & 
PBC_LENGTH_DWS_MASK
è<< 
PBC_LENGTH_DWS_SHIFT
;

242  
pbc
;

243 
	}
}

246 
	$hfi1_vnic_maybe_¡Ý_tx
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

247 
u8
 
q_idx
)

249 
	`Ãtif_¡Ý_subqueue
(
všfo
->
Ãtdev
, 
q_idx
);

250 ià(!
	`hfi1_vnic_sdma_wr™e_avaž
(
všfo
, 
q_idx
))

253 
	`Ãtif_¡¬t_subqueue
(
všfo
->
Ãtdev
, 
q_idx
);

254 
	}
}

256 
Ãtdev_tx_t
 
	$hfi1_Ãtdev_¡¬t_xm™
(
sk_buff
 *
skb
,

257 
Ãt_deviû
 *
Ãtdev
)

259 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

260 
u8
 
·d_Ën
, 
q_idx
 = 
skb
->
queue_m­pšg
;

261 
hfi1_devd©a
 *
dd
 = 
všfo
->dd;

262 
Ýa_vnic_skb_md©a
 *
md©a
;

263 
u32
 
pkt_Ën
, 
tÙ®_Ën
;

264 
”r
 = -
EINVAL
;

265 
u64
 
pbc
;

267 
	`v_dbg
("xm™: queu%d skb†’ %d\n", 
q_idx
, 
skb
->
Ën
);

268 ià(
	`uÆik–y
(!
	`Ãtif_Ý”_up
(
Ãtdev
))) {

269 
všfo
->
¡©s
[
q_idx
].
tx_drÝ_¡©e
++;

270 
tx_fšish
;

274 
md©a
 = (
Ýa_vnic_skb_md©a
 *)
skb
->
d©a
;

275 
	`skb_puÎ
(
skb
, (*
md©a
));

276 ià(
	`uÆik–y
(
md©a
->
æags
 & 
OPA_VNIC_SKB_MDATA_ENCAP_ERR
)) {

277 
všfo
->
¡©s
[
q_idx
].
tx_dlid_z”o
++;

278 
tx_fšish
;

282 
·d_Ën
 = -(
skb
->
Ën
 + 
OPA_VNIC_ICRC_TAIL_LEN
) & 0x7;

283 
·d_Ën
 +ð
OPA_VNIC_ICRC_TAIL_LEN
;

290 
pkt_Ën
 = (
skb
->
Ën
 + 
·d_Ën
) >> 2;

291 
tÙ®_Ën
 = 
pkt_Ën
 + 2;

293 
pbc
 = 
	`ü—‹_by·ss_pbc
(
md©a
->
vl
, 
tÙ®_Ën
);

295 
	`skb_g‘
(
skb
);

296 
	`v_dbg
("pbø0x%016ÎX†’ %d…ad_ËÀ%d\n", 
pbc
, 
skb
->
Ën
, 
·d_Ën
);

297 
”r
 = 
dd
->
	`´oûss_vnic_dma_£nd
(dd, 
q_idx
, 
všfo
, 
skb
, 
pbc
, 
·d_Ën
);

298 ià(
	`uÆik–y
(
”r
)) {

299 ià(
”r
 =ð-
ENOMEM
)

300 
všfo
->
¡©s
[
q_idx
].
Ãt¡©s
.
tx_fifo_”rÜs
++;

301 ià(
”r
 !ð-
EBUSY
)

302 
všfo
->
¡©s
[
q_idx
].
Ãt¡©s
.
tx_ÿ¼›r_”rÜs
++;

305 
	`skb_puÎ
(
skb
, 
OPA_VNIC_HDR_LEN
);

307 ià(
	`uÆik–y
(
”r
 =ð-
EBUSY
)) {

308 
	`hfi1_vnic_maybe_¡Ý_tx
(
všfo
, 
q_idx
);

309 
	`dev_kä“_skb_ªy
(
skb
);

310  
NETDEV_TX_BUSY
;

313 
tx_fšish
:

315 
	`hfi1_vnic_upd©e_tx_couÁ”s
(
všfo
, 
q_idx
, 
skb
, 
”r
);

316 
	`dev_kä“_skb_ªy
(
skb
);

317  
NETDEV_TX_OK
;

318 
	}
}

320 
u16
 
	$hfi1_vnic_£Ëù_queue
(
Ãt_deviû
 *
Ãtdev
,

321 
sk_buff
 *
skb
,

322 
Ãt_deviû
 *
sb_dev
)

324 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

325 
Ýa_vnic_skb_md©a
 *
md©a
;

326 
sdma_’gše
 *
sde
;

328 
md©a
 = (
Ýa_vnic_skb_md©a
 *)
skb
->
d©a
;

329 
sde
 = 
	`sdma_£Ëù_’gše_vl
(
všfo
->
dd
, 
md©a
->
’ŒÝy
, md©a->
vl
);

330  
sde
->
this_idx
;

331 
	}
}

334 
šlše
 
	$hfi1_vnic_deÿp_skb
(
hfi1_vnic_rx_queue
 *
rxq
,

335 
sk_buff
 *
skb
)

337 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
rxq
->vinfo;

338 
max_Ën
 = 
všfo
->
Ãtdev
->
mtu
 + 
VLAN_ETH_HLEN
;

339 
rc
 = -
EFAULT
;

341 
	`skb_puÎ
(
skb
, 
OPA_VNIC_HDR_LEN
);

344 ià(
	`uÆik–y
(
skb
->
Ën
 > 
max_Ën
))

345 
všfo
->
¡©s
[
rxq
->
idx
].
rx_ov”size
++;

346 ià(
	`uÆik–y
(
skb
->
Ën
 < 
ETH_ZLEN
))

347 
všfo
->
¡©s
[
rxq
->
idx
].
rx_ruÁ
++;

349 
rc
 = 0;

350  
rc
;

351 
	}
}

354 
hfi1_vnic_vpÜt_šfo
 *
	$g‘_vnic_pÜt
(
hfi1_devd©a
 *
dd
, 
vesw_id
)

356 
vnic_id
 = 
	`VNIC_ID
(
vesw_id
);

358  
	`hfi1_Ãtdev_g‘_d©a
(
dd
, 
vnic_id
);

359 
	}
}

361 
hfi1_vnic_vpÜt_šfo
 *
	$g‘_fœ¡_vnic_pÜt
(
hfi1_devd©a
 *
dd
)

363 
hfi1_vnic_vpÜt_šfo
 *
všfo
;

364 
Ãxt_id
 = 
	`VNIC_ID
(0);

366 
všfo
 = 
	`hfi1_Ãtdev_g‘_fœ¡_d©a
(
dd
, &
Ãxt_id
);

368 ià(
Ãxt_id
 > 
	`VNIC_ID
(
VNIC_MASK
))

369  
NULL
;

371  
všfo
;

372 
	}
}

374 
	$hfi1_vnic_by·ss_rcv
(
hfi1_·ck‘
 *
·ck‘
)

376 
hfi1_devd©a
 *
dd
 = 
·ck‘
->
rcd
->dd;

377 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
NULL
;

378 
hfi1_vnic_rx_queue
 *
rxq
;

379 
sk_buff
 *
skb
;

380 
l4_ty³
, 
vesw_id
 = -1, 
rc
;

381 
u8
 
q_idx
;

382 *
·d_šfo
;

384 
l4_ty³
 = 
	`hfi1_16B_g‘_l4
(
·ck‘
->
ebuf
);

385 ià(
	`lik–y
(
l4_ty³
 =ð
OPA_16B_L4_ETHR
)) {

386 
vesw_id
 = 
	`HFI1_VNIC_GET_VESWID
(
·ck‘
->
ebuf
);

387 
všfo
 = 
	`g‘_vnic_pÜt
(
dd
, 
vesw_id
);

393 ià(
	`uÆik–y
(!
všfo
)) {

394 
hfi1_vnic_vpÜt_šfo
 *
všfo_tmp
;

396 
všfo_tmp
 = 
	`g‘_fœ¡_vnic_pÜt
(
dd
);

397 ià(
všfo_tmp
) {

398 
	`¥š_lock
(&
vpÜt_úŒ_lock
);

399 
všfo_tmp
->
¡©s
[0].
Ãt¡©s
.
rx_nohªdËr
++;

400 
	`¥š_uÆock
(&
vpÜt_úŒ_lock
);

405 ià(
	`uÆik–y
(!
všfo
)) {

406 
	`dd_dev_w¬n
(
dd
, "vnic„cvƒrr:†4 %d vesw id %d ctx %d\n",

407 
l4_ty³
, 
vesw_id
, 
·ck‘
->
rcd
->
ùxt
);

411 
q_idx
 = 
·ck‘
->
rcd
->
vnic_q_idx
;

412 
rxq
 = &
všfo
->rxq[
q_idx
];

413 ià(
	`uÆik–y
(!
	`Ãtif_Ý”_up
(
všfo
->
Ãtdev
))) {

414 
všfo
->
¡©s
[
q_idx
].
rx_drÝ_¡©e
++;

418 
skb
 = 
	`Ãtdev_®loc_skb
(
všfo
->
Ãtdev
, 
·ck‘
->
Ž’
);

419 ià(
	`uÆik–y
(!
skb
)) {

420 
všfo
->
¡©s
[
q_idx
].
Ãt¡©s
.
rx_fifo_”rÜs
++;

424 
	`memýy
(
skb
->
d©a
, 
·ck‘
->
ebuf
,…ack‘->
Ž’
);

425 
	`skb_put
(
skb
, 
·ck‘
->
Ž’
);

427 
·d_šfo
 = 
skb
->
d©a
 + skb->
Ën
 - 1;

428 
	`skb_Œim
(
skb
, (skb->
Ën
 - 
OPA_VNIC_ICRC_TAIL_LEN
 -

429 ((*
·d_šfo
) & 0x7)));

431 
rc
 = 
	`hfi1_vnic_deÿp_skb
(
rxq
, 
skb
);

434 
	`hfi1_vnic_upd©e_rx_couÁ”s
(
všfo
, 
rxq
->
idx
, 
skb
, 
rc
);

435 ià(
	`uÆik–y
(
rc
)) {

436 
	`dev_kä“_skb_ªy
(
skb
);

440 
	`skb_checksum_nÚe_as£¹
(
skb
);

441 
skb
->
´ÙocÞ
 = 
	`‘h_ty³_Œªs
(skb, 
rxq
->
Ãtdev
);

443 
	`Çpi_gro_»ûive
(&
rxq
->
Çpi
, 
skb
);

444 
	}
}

446 
	$hfi1_vnic_up
(
hfi1_vnic_vpÜt_šfo
 *
všfo
)

448 
hfi1_devd©a
 *
dd
 = 
všfo
->dd;

449 
Ãt_deviû
 *
Ãtdev
 = 
všfo
->netdev;

450 
rc
;

453 ià(!
všfo
->
vesw_id
)

454  -
EINVAL
;

456 
rc
 = 
	`hfi1_Ãtdev_add_d©a
(
dd
, 
	`VNIC_ID
(
všfo
->
vesw_id
), vinfo);

458 ià(
rc
 < 0)

459  
rc
;

461 
	`hfi1_Ãtdev_rx_š™
(
dd
);

463 
	`Ãtif_ÿ¼›r_Ú
(
Ãtdev
);

464 
	`Ãtif_tx_¡¬t_®l_queues
(
Ãtdev
);

465 
	`£t_b™
(
HFI1_VNIC_UP
, &
všfo
->
æags
);

468 
	}
}

470 
	$hfi1_vnic_down
(
hfi1_vnic_vpÜt_šfo
 *
všfo
)

472 
hfi1_devd©a
 *
dd
 = 
všfo
->dd;

474 
	`þ—r_b™
(
HFI1_VNIC_UP
, &
všfo
->
æags
);

475 
	`Ãtif_ÿ¼›r_off
(
všfo
->
Ãtdev
);

476 
	`Ãtif_tx_di§bË
(
všfo
->
Ãtdev
);

477 
	`hfi1_Ãtdev_»move_d©a
(
dd
, 
	`VNIC_ID
(
všfo
->
vesw_id
));

479 
	`hfi1_Ãtdev_rx_de¡roy
(
dd
);

480 
	}
}

482 
	$hfi1_Ãtdev_Ý’
(
Ãt_deviû
 *
Ãtdev
)

484 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

485 
rc
;

487 
	`mu‹x_lock
(&
všfo
->
lock
);

488 
rc
 = 
	`hfi1_vnic_up
(
všfo
);

489 
	`mu‹x_uÆock
(&
všfo
->
lock
);

490  
rc
;

491 
	}
}

493 
	$hfi1_Ãtdev_þo£
(
Ãt_deviû
 *
Ãtdev
)

495 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

497 
	`mu‹x_lock
(&
všfo
->
lock
);

498 ià(
	`‹¡_b™
(
HFI1_VNIC_UP
, &
všfo
->
æags
))

499 
	`hfi1_vnic_down
(
všfo
);

500 
	`mu‹x_uÆock
(&
všfo
->
lock
);

502 
	}
}

504 
	$hfi1_vnic_š™
(
hfi1_vnic_vpÜt_šfo
 *
všfo
)

506 
hfi1_devd©a
 *
dd
 = 
všfo
->dd;

507 
rc
 = 0;

509 
	`mu‹x_lock
(&
hfi1_mu‹x
);

510 ià(!
dd
->
vnic_num_vpÜts
) {

511 
rc
 = 
	`hfi1_vnic_tx»q_š™
(
dd
);

512 ià(
rc
)

513 
tx»q_çž
;

516 ià(
	`hfi1_Ãtdev_rx_š™
(
dd
)) {

517 
	`dd_dev_”r
(
dd
, "Unableo initialize‚etdev contexts\n");

518 
®loc_çž
;

521 
	`hfi1_š™_vnic_rsm
(
dd
);

523 
dd
->
vnic_num_vpÜts
++;

524 
	`hfi1_vnic_sdma_š™
(
všfo
);

526 
®loc_çž
:

527 ià(!
dd
->
vnic_num_vpÜts
)

528 
	`hfi1_vnic_tx»q_deš™
(
dd
);

529 
tx»q_çž
:

530 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

531  
rc
;

532 
	}
}

534 
	$hfi1_vnic_deš™
(
hfi1_vnic_vpÜt_šfo
 *
všfo
)

536 
hfi1_devd©a
 *
dd
 = 
všfo
->dd;

538 
	`mu‹x_lock
(&
hfi1_mu‹x
);

539 ià(--
dd
->
vnic_num_vpÜts
 == 0) {

540 
	`hfi1_deš™_vnic_rsm
(
dd
);

541 
	`hfi1_vnic_tx»q_deš™
(
dd
);

543 
	`mu‹x_uÆock
(&
hfi1_mu‹x
);

544 
	`hfi1_Ãtdev_rx_de¡roy
(
dd
);

545 
	}
}

547 
	$hfi1_vnic_£t_vesw_id
(
Ãt_deviû
 *
Ãtdev
, 
id
)

549 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

550 
boÞ
 
»Ý’
 = 
çl£
;

556 ià(
id
 !ð
všfo
->
vesw_id
) {

557 
	`mu‹x_lock
(&
všfo
->
lock
);

558 ià(
	`‹¡_b™
(
HFI1_VNIC_UP
, &
všfo
->
æags
)) {

559 
	`hfi1_vnic_down
(
všfo
);

560 
»Ý’
 = 
Œue
;

563 
všfo
->
vesw_id
 = 
id
;

564 ià(
»Ý’
)

565 
	`hfi1_vnic_up
(
všfo
);

567 
	`mu‹x_uÆock
(&
všfo
->
lock
);

569 
	}
}

572 cÚ¡ 
Ãt_deviû_Ýs
 
	ghfi1_Ãtdev_Ýs
 = {

573 .
ndo_Ý’
 = 
hfi1_Ãtdev_Ý’
,

574 .
	gndo_¡Ý
 = 
hfi1_Ãtdev_þo£
,

575 .
	gndo_¡¬t_xm™
 = 
hfi1_Ãtdev_¡¬t_xm™
,

576 .
	gndo_£Ëù_queue
 = 
hfi1_vnic_£Ëù_queue
,

577 .
	gndo_g‘_¡©s64
 = 
hfi1_vnic_g‘_¡©s64
,

580 
	$hfi1_vnic_ä“_º
(
Ãt_deviû
 *
Ãtdev
)

582 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

584 
	`hfi1_vnic_deš™
(
všfo
);

585 
	`mu‹x_de¡roy
(&
všfo
->
lock
);

586 
	`ä“_Ãtdev
(
Ãtdev
);

587 
	}
}

589 
Ãt_deviû
 *
hfi1_vnic_®loc_º
(
ib_deviû
 *
deviû
,

590 
u8
 
pÜt_num
,

591 
rdma_Ãtdev_t
 
ty³
,

592 cÚ¡ *
Çme
,

593 
Çme_assign_ty³
,

594 (*
£tup
)(
Ãt_deviû
 *))

596 
hfi1_devd©a
 *
dd
 = 
	`dd_äom_ibdev
(
deviû
);

597 
hfi1_vnic_vpÜt_šfo
 *
všfo
;

598 
Ãt_deviû
 *
Ãtdev
;

599 
rdma_Ãtdev
 *
º
;

600 
i
, 
size
, 
rc
;

602 ià(!
dd
->
num_Ãtdev_cÚ‹xts
)

603  
	`ERR_PTR
(-
ENOMEM
);

605 ià(!
pÜt_num
 || (pÜt_num > 
dd
->
num_µÜts
))

606  
	`ERR_PTR
(-
EINVAL
);

608 ià(
ty³
 !ð
RDMA_NETDEV_OPA_VNIC
)

609  
	`ERR_PTR
(-
EOPNOTSUPP
);

611 
size
 = (
Ýa_vnic_rdma_Ãtdev
è+ (*
všfo
);

612 
Ãtdev
 = 
	`®loc_Ãtdev_mqs
(
size
, 
Çme
, 
Çme_assign_ty³
, 
£tup
,

613 
dd
->
num_sdma
,

614 
dd
->
num_Ãtdev_cÚ‹xts
);

616 ià(!
Ãtdev
)

617  
	`ERR_PTR
(-
ENOMEM
);

619 
º
 = 
	`Ãtdev_´iv
(
Ãtdev
);

620 
všfo
 = 
	`Ýa_vnic_dev_´iv
(
Ãtdev
);

621 
všfo
->
dd
 = dd;

622 
všfo
->
num_tx_q
 = 
dd
->
num_sdma
;

623 
všfo
->
num_rx_q
 = 
dd
->
num_Ãtdev_cÚ‹xts
;

624 
všfo
->
Ãtdev
 =‚etdev;

625 
º
->
ä“_rdma_Ãtdev
 = 
hfi1_vnic_ä“_º
;

626 
º
->
£t_id
 = 
hfi1_vnic_£t_vesw_id
;

628 
Ãtdev
->
ã©u»s
 = 
NETIF_F_HIGHDMA
 | 
NETIF_F_SG
;

629 
Ãtdev
->
hw_ã©u»s
 =‚‘dev->
ã©u»s
;

630 
Ãtdev
->
vÏn_ã©u»s
 =‚‘dev->
ã©u»s
;

631 
Ãtdev
->
w©chdog_timeo
 = 
	`m£cs_to_jiff›s
(
HFI_TX_TIMEOUT_MS
);

632 
Ãtdev
->
Ãtdev_Ýs
 = &
hfi1_Ãtdev_Ýs
;

633 
	`mu‹x_š™
(&
všfo
->
lock
);

635 
i
 = 0; i < 
všfo
->
num_rx_q
; i++) {

636 
hfi1_vnic_rx_queue
 *
rxq
 = &
všfo
->rxq[
i
];

638 
rxq
->
idx
 = 
i
;

639 
rxq
->
všfo
 = vinfo;

640 
rxq
->
Ãtdev
 =‚etdev;

643 
rc
 = 
	`hfi1_vnic_š™
(
všfo
);

644 ià(
rc
)

645 
š™_çž
;

647  
Ãtdev
;

648 
š™_çž
:

649 
	`mu‹x_de¡roy
(&
všfo
->
lock
);

650 
	`ä“_Ãtdev
(
Ãtdev
);

651  
	`ERR_PTR
(
rc
);

652 
	}
}

	@vnic_sdma.c

52 
	~"sdma.h
"

53 
	~"vnic.h
"

55 
	#HFI1_VNIC_SDMA_Q_ACTIVE
 
	`BIT
(0)

	)

56 
	#HFI1_VNIC_SDMA_Q_DEFERRED
 
	`BIT
(1)

	)

58 
	#HFI1_VNIC_TXREQ_NAME_LEN
 32

	)

59 
	#HFI1_VNIC_SDMA_DESC_WTRMRK
 64

	)

70 
	svnic_tx»q
 {

71 
sdma_tx»q
 
	mtx»q
;

72 
hfi1_vnic_sdma
 *
	msdma
;

74 
sk_buff
 *
	mskb
;

75 
	m·d
[
HFI1_VNIC_MAX_PAD
];

76 
u16
 
	m¶’
;

77 
__Ë64
 
	mpbc_v®
;

80 
	$vnic_sdma_com¶‘e
(
sdma_tx»q
 *
tx»q
,

81 
¡©us
)

83 
vnic_tx»q
 *
tx
 = 
	`cÚš”_of
(
tx»q
, vnic_txreq,xreq);

84 
hfi1_vnic_sdma
 *
vnic_sdma
 = 
tx
->
sdma
;

86 
	`sdma_txþ—n
(
vnic_sdma
->
dd
, 
tx»q
);

87 
	`dev_kä“_skb_ªy
(
tx
->
skb
);

88 
	`kmem_ÿche_ä“
(
vnic_sdma
->
dd
->
vnic
.
tx»q_ÿche
, 
tx
);

89 
	}
}

91 
nošlše
 
	$bužd_vnic_uÍ_·ylßd
(
sdma_’gše
 *
sde
,

92 
vnic_tx»q
 *
tx
)

94 
i
, 
»t
 = 0;

96 
»t
 = 
	`sdma_txadd_kvaddr
(

97 
sde
->
dd
,

98 &
tx
->
tx»q
,

99 
tx
->
skb
->
d©a
,

100 
	`skb_h—dËn
(
tx
->
skb
));

101 ià(
	`uÆik–y
(
»t
))

102 
baž_txadd
;

104 
i
 = 0; i < 
	`skb_shšfo
(
tx
->
skb
)->
Ä_äags
; i++) {

105 
skb_äag_t
 *
äag
 = &
	`skb_shšfo
(
tx
->
skb
)->
äags
[
i
];

108 
»t
 = 
	`sdma_txadd_·ge
(
sde
->
dd
,

109 &
tx
->
tx»q
,

110 
	`skb_äag_·ge
(
äag
),

111 
	`skb_äag_off
(
äag
),

112 
	`skb_äag_size
(
äag
));

113 ià(
	`uÆik–y
(
»t
))

114 
baž_txadd
;

117 ià(
tx
->
¶’
)

118 
»t
 = 
	`sdma_txadd_kvaddr
(
sde
->
dd
, &
tx
->
tx»q
,

119 
tx
->
·d
 + 
HFI1_VNIC_MAX_PAD
 -x->
¶’
,

120 
tx
->
¶’
);

122 
baž_txadd
:

123  
»t
;

124 
	}
}

126 
	$bužd_vnic_tx_desc
(
sdma_’gše
 *
sde
,

127 
vnic_tx»q
 *
tx
,

128 
u64
 
pbc
)

130 
»t
 = 0;

131 
u16
 
hdrby‹s
 = 2 << 2;

133 
»t
 = 
	`sdma_txš™_ahg
(

134 &
tx
->
tx»q
,

136 
hdrby‹s
 + 
tx
->
skb
->
Ën
 +x->
¶’
,

139 
NULL
,

141 
vnic_sdma_com¶‘e
);

142 ià(
	`uÆik–y
(
»t
))

143 
baž_txadd
;

146 
tx
->
pbc_v®
 = 
	`ýu_to_Ë64
(
pbc
);

147 
»t
 = 
	`sdma_txadd_kvaddr
(

148 
sde
->
dd
,

149 &
tx
->
tx»q
,

150 &
tx
->
pbc_v®
,

151 
hdrby‹s
);

152 ià(
	`uÆik–y
(
»t
))

153 
baž_txadd
;

156 
»t
 = 
	`bužd_vnic_uÍ_·ylßd
(
sde
, 
tx
);

157 
baž_txadd
:

158  
»t
;

159 
	}
}

162 
šlše
 
	$hfi1_vnic_upd©e_·d
(*
·d
, 
u8
 
¶’
)

164 
·d
[
HFI1_VNIC_MAX_PAD
 - 1] = 
¶’
 - 
OPA_VNIC_ICRC_TAIL_LEN
;

165 
	}
}

167 
	$hfi1_vnic_£nd_dma
(
hfi1_devd©a
 *
dd
, 
u8
 
q_idx
,

168 
hfi1_vnic_vpÜt_šfo
 *
všfo
,

169 
sk_buff
 *
skb
, 
u64
 
pbc
, 
u8
 
¶’
)

171 
hfi1_vnic_sdma
 *
vnic_sdma
 = &
všfo
->
sdma
[
q_idx
];

172 
sdma_’gše
 *
sde
 = 
vnic_sdma
->sde;

173 
vnic_tx»q
 *
tx
;

174 
»t
 = -
ECOMM
;

176 ià(
	`uÆik–y
(
	`READ_ONCE
(
vnic_sdma
->
¡©e
è!ð
HFI1_VNIC_SDMA_Q_ACTIVE
))

177 
tx_”r
;

179 ià(
	`uÆik–y
(!
sde
 || !
	`sdma_ruÂšg
(sde)))

180 
tx_”r
;

182 
tx
 = 
	`kmem_ÿche_®loc
(
dd
->
vnic
.
tx»q_ÿche
, 
GFP_ATOMIC
);

183 ià(
	`uÆik–y
(!
tx
)) {

184 
»t
 = -
ENOMEM
;

185 
tx_”r
;

188 
tx
->
sdma
 = 
vnic_sdma
;

189 
tx
->
skb
 = skb;

190 
	`hfi1_vnic_upd©e_·d
(
tx
->
·d
, 
¶’
);

191 
tx
->
¶’
 =…len;

192 
»t
 = 
	`bužd_vnic_tx_desc
(
sde
, 
tx
, 
pbc
);

193 ià(
	`uÆik–y
(
»t
))

194 
ä“_desc
;

196 
»t
 = 
	`sdma_£nd_tx»q
(
sde
, 
	`iowa™_g‘_ib_wÜk
(&
vnic_sdma
->
wa™
),

197 &
tx
->
tx»q
, 
vnic_sdma
->
pkts_£Á
);

199 ià(
	`uÆik–y
(
»t
 && uÆik–yÔ‘ !ð-
ECOMM
)))

200 
ä“_desc
;

202 ià(!
»t
) {

203 
vnic_sdma
->
pkts_£Á
 = 
Œue
;

204 
	`iowa™_¡¬ve_þ—r
(
vnic_sdma
->
pkts_£Á
, &vnic_sdma->
wa™
);

206  
»t
;

208 
ä“_desc
:

209 
	`sdma_txþ—n
(
dd
, &
tx
->
tx»q
);

210 
	`kmem_ÿche_ä“
(
dd
->
vnic
.
tx»q_ÿche
, 
tx
);

211 
tx_”r
:

212 ià(
»t
 !ð-
EBUSY
)

213 
	`dev_kä“_skb_ªy
(
skb
);

215 
vnic_sdma
->
pkts_£Á
 = 
çl£
;

216  
»t
;

217 
	}
}

227 
	$hfi1_vnic_sdma_¦“p
(
sdma_’gše
 *
sde
,

228 
iowa™_wÜk
 *
wa™
,

229 
sdma_tx»q
 *
tx»q
,

230 
ušt
 
£q
,

231 
boÞ
 
pkts_£Á
)

233 
hfi1_vnic_sdma
 *
vnic_sdma
 =

234 
	`cÚš”_of
(
wa™
->
iow
, 
hfi1_vnic_sdma
, wait);

236 
	`wr™e_£qlock
(&
sde
->
wa™lock
);

237 ià(
	`sdma_´og»ss
(
sde
, 
£q
, 
tx»q
)) {

238 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

239  -
EAGAIN
;

242 
vnic_sdma
->
¡©e
 = 
HFI1_VNIC_SDMA_Q_DEFERRED
;

243 ià(
	`li¡_em±y
(&
vnic_sdma
->
wa™
.
li¡
))

244 
	`iowa™_queue
(
pkts_£Á
, 
wa™
->
iow
, &
sde
->
dmawa™
);

245 
	`wr™e_£quÆock
(&
sde
->
wa™lock
);

246  -
EBUSY
;

247 
	}
}

256 
	$hfi1_vnic_sdma_wakeup
(
iowa™
 *
wa™
, 
»asÚ
)

258 
hfi1_vnic_sdma
 *
vnic_sdma
 =

259 
	`cÚš”_of
(
wa™
, 
hfi1_vnic_sdma
, wait);

260 
hfi1_vnic_vpÜt_šfo
 *
všfo
 = 
vnic_sdma
->vinfo;

262 
vnic_sdma
->
¡©e
 = 
HFI1_VNIC_SDMA_Q_ACTIVE
;

263 ià(
	`__Ãtif_subqueue_¡Ý³d
(
všfo
->
Ãtdev
, 
vnic_sdma
->
q_idx
))

264 
	`Ãtif_wake_subqueue
(
všfo
->
Ãtdev
, 
vnic_sdma
->
q_idx
);

265 
	}
};

267 
šlše
 
boÞ
 
	$hfi1_vnic_sdma_wr™e_avaž
(
hfi1_vnic_vpÜt_šfo
 *
všfo
,

268 
u8
 
q_idx
)

270 
hfi1_vnic_sdma
 *
vnic_sdma
 = &
všfo
->
sdma
[
q_idx
];

272  (
	`READ_ONCE
(
vnic_sdma
->
¡©e
è=ð
HFI1_VNIC_SDMA_Q_ACTIVE
);

273 
	}
}

275 
	$hfi1_vnic_sdma_š™
(
hfi1_vnic_vpÜt_šfo
 *
všfo
)

277 
i
;

279 
i
 = 0; i < 
všfo
->
num_tx_q
; i++) {

280 
hfi1_vnic_sdma
 *
vnic_sdma
 = &
všfo
->
sdma
[
i
];

282 
	`iowa™_š™
(&
vnic_sdma
->
wa™
, 0, 
NULL
, NULL,

283 
hfi1_vnic_sdma_¦“p
,

284 
hfi1_vnic_sdma_wakeup
, 
NULL
, NULL);

285 
vnic_sdma
->
sde
 = &
všfo
->
dd
->
³r_sdma
[
i
];

286 
vnic_sdma
->
dd
 = 
všfo
->dd;

287 
vnic_sdma
->
všfo
 = vinfo;

288 
vnic_sdma
->
q_idx
 = 
i
;

289 
vnic_sdma
->
¡©e
 = 
HFI1_VNIC_SDMA_Q_ACTIVE
;

292 ià(
vnic_sdma
->
sde
->
descq_út
 > 
HFI1_VNIC_SDMA_DESC_WTRMRK
) {

293 
iowa™_wÜk
 *
wÜk
;

295 
	`INIT_LIST_HEAD
(&
vnic_sdma
->
¡x
.
li¡
);

296 
vnic_sdma
->
¡x
.
num_desc
 = 
HFI1_VNIC_SDMA_DESC_WTRMRK
;

297 
wÜk
 = 
	`iowa™_g‘_ib_wÜk
(&
vnic_sdma
->
wa™
);

298 
	`li¡_add_ž
(&
vnic_sdma
->
¡x
.
li¡
, &
wÜk
->
tx_h—d
);

301 
	}
}

303 
	$hfi1_vnic_tx»q_š™
(
hfi1_devd©a
 *
dd
)

305 
buf
[
HFI1_VNIC_TXREQ_NAME_LEN
];

307 
	`¢´štf
(
buf
, (buf), "hfi1_%u_vnic_tx»q_ÿche", 
dd
->
un™
);

308 
dd
->
vnic
.
tx»q_ÿche
 = 
	`kmem_ÿche_ü—‹
(
buf
,

309 (
vnic_tx»q
),

310 0, 
SLAB_HWCACHE_ALIGN
,

311 
NULL
);

312 ià(!
dd
->
vnic
.
tx»q_ÿche
)

313  -
ENOMEM
;

315 
	}
}

317 
	$hfi1_vnic_tx»q_deš™
(
hfi1_devd©a
 *
dd
)

319 
	`kmem_ÿche_de¡roy
(
dd
->
vnic
.
tx»q_ÿche
);

320 
dd
->
vnic
.
tx»q_ÿche
 = 
NULL
;

321 
	}
}

	@
1
.
0
100
966
affinity.c
affinity.h
aspm.c
aspm.h
chip.c
chip.h
chip_registers.h
common.h
debugfs.c
debugfs.h
device.c
device.h
diag.c
driver.c
efivar.c
efivar.h
eprom.c
eprom.h
exp_rcv.c
exp_rcv.h
fault.c
fault.h
file_ops.c
firmware.c
gdr_ops.c
gdr_ops.h
gpu.c
gpu.h
hfi.h
init.c
intr.c
iowait.c
iowait.h
ipoib.h
ipoib_main.c
ipoib_rx.c
ipoib_tx.c
mad.c
mad.h
mmu_rb.c
mmu_rb.h
msix.c
msix.h
netdev.h
netdev_rx.c
opa_compat.h
opfn.c
opfn.h
pcie.c
pio.c
pio.h
pio_copy.c
platform.c
platform.h
qp.c
qp.h
qsfp.c
qsfp.h
rc.c
rc.h
rcva.c
rcva.h
ruc.c
sdma.c
sdma.h
sdma_txreq.h
sysfs.c
tid_rdma.c
tid_rdma.h
trace.c
trace.h
trace_ctxts.h
trace_dbg.h
trace_gpu.h
trace_ibhdrs.h
trace_iowait.h
trace_misc.h
trace_mmu.h
trace_rc.h
trace_rx.h
trace_tid.h
trace_tx.h
uc.c
ud.c
user_exp_rcv.c
user_exp_rcv.h
user_exp_rcv_gpu.c
user_exp_rcv_gpu.h
user_pages.c
user_sdma.c
user_sdma.h
user_sdma_gpu.c
user_sdma_gpu.h
verbs.c
verbs.h
verbs_txreq.c
verbs_txreq.h
vnic.h
vnic_main.c
vnic_sdma.c
